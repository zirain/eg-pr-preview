<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview/v1.2/><link rel=alternate type=application/rss+xml href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview/v1.2/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/eg-pr-preview/5-test-docs-preview/favicons/favicon.ico><link rel=apple-touch-icon href=/eg-pr-preview/5-test-docs-preview/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/eg-pr-preview/5-test-docs-preview/favicons/android-192x192.png sizes=192x192><title>Welcome to Envoy Gateway | Envoy Gateway</title>
<meta name=description content="Envoy Gateway Documents"><meta property="og:url" content="https://zirain.github.io/eg-pr-preview/5-test-docs-preview/v1.2/"><meta property="og:site_name" content="Envoy Gateway"><meta property="og:title" content="Welcome to Envoy Gateway"><meta property="og:description" content="Envoy Gateway Documents"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Welcome to Envoy Gateway"><meta itemprop=description content="Envoy Gateway Documents"><meta itemprop=dateModified content="2025-01-12T21:35:44+08:00"><meta itemprop=wordCount content="36"><meta name=twitter:card content="summary"><meta name=twitter:title content="Welcome to Envoy Gateway"><meta name=twitter:description content="Envoy Gateway Documents"><link rel=preload href=/eg-pr-preview/5-test-docs-preview/scss/main.min.13dd8d11b772c2d11eac755eb5d2d8924f18f01762c20defa026366a1f00937d.css as=style><link href=/eg-pr-preview/5-test-docs-preview/scss/main.min.13dd8d11b772c2d11eac755eb5d2d8924f18f01762c20defa026366a1f00937d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-DXJEH1ZRXX"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DXJEH1ZRXX")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/eg-pr-preview/5-test-docs-preview/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 1200 400"><defs><style>.cls-1{fill:#d04c9b}.cls-2{fill:#4a2365}.cls-3{fill:#b96aab}.cls-4{isolation:isolate}.cls-5{fill:#a53995}</style></defs><g><g id="Layer_1"><g><polygon id="polygon20" class="cls-5" points="191.2 242.29 190.55 213 159.76 193.83 160.4 223.12 191.2 242.29"/><path id="path22" class="cls-5" d="M234.92 315.52l-.65-28.65-26.92-16.8c-.43-.21-.86-.64-1.08-.86l.65 28.86 28 17.45h0z"/><path id="path24" class="cls-5" d="M138.65 354.07l-70.42-43.72-1.73-73.23 34.46-14.86-.65-29.29-55.14 23.69c-4.3 1.94-6.89 5.81-6.67 10.33l2.15 87.87c0 4.53 2.8 9.06 7.11 11.64l84.43 52.33c3.88 2.37 8.61 3.02 12.71 1.94.43-.21.86-.21 1.29-.43l51.9-22.39-28.21-17.45-31.23 13.57h0z"/><path id="path26" class="cls-3" d="M366.29 192.11c-.21-5.17-3.23-10.55-8.39-13.57l-102.52-63.53-3.23 1.29.64 30.8 81.19 50.4 1.94 82.27 31.01 19.17 1.72-.64-2.37-106.18h0z"/><path id="path28" class="cls-3" d="M243.53 336.62l-95.41-59.01-2.37-99.07 43.51-18.74-.86-34.24-67.41 29.07c-4.95 2.16-7.97 6.68-7.75 12.06l2.8 116.3c0 5.38 3.23 10.56 8.4 13.57l111.78 69.35c4.52 2.79 10.12 3.66 14.86 2.15.43-.22.86-.43 1.29-.43l65.9-28.44-32.73-20.25-42 17.67h0z"/><path id="path30" class="cls-1" d="M511.67 110.69 368.45 21.96c-5.38-3.23-11.62-4.1-17-2.37-.44.21-1.08.43-1.51.64L210.16 80.54c-5.6 2.37-9.04 7.54-8.83 13.78l3.44 149.04c.22 6.03 3.88 12.06 9.7 15.51l143.22 88.73c5.17 3.23 11.63 4.09 17.01 2.38.43-.22 1.08-.44 1.51-.65l139.78-60.3c5.59-2.37 9.05-7.75 8.84-13.79l-3.45-149.04c-.21-6.03-3.88-11.85-9.69-15.51M366.08 314.22 241.6 237.11l-3.02-129.44 121.47-52.33 124.49 77.1 3.02 129.45-121.47 52.33h0z"/></g><path id="path10" class="cls-2" d="M607.46 182.14c0 4.62 1.08 9.04 3.23 12.83 2.16 3.78 4.95 7.15 8.18 9.88 3.44 2.74 7.33 4.84 11.84 6.32 4.52 1.47 9.26 2.31 14 2.31 6.46.0 12.27-1.48 17.01-4.41 4.73-2.96 9.26-6.96 13.35-11.79L691 209.07c-11.63 14.71-27.99 22.08-48.88 22.08-8.61.0-16.58-1.47-23.69-4.41-7.11-2.96-13.13-6.95-17.88-12-4.95-5.05-8.61-11.15-11.19-17.88-2.58-6.94-3.88-14.31-3.88-22.51s1.51-15.57 4.31-22.51 6.89-12.83 11.84-17.88 10.98-9.04 18.09-12c6.9-2.94 14.65-4.42 22.83-4.42 9.69.0 18.09 1.69 24.77 5.06 6.67 3.36 12.27 7.77 16.58 13.03 4.31 5.48 7.54 11.37 9.48 18.31 1.94 6.73 3.01 13.67 3.01 20.62v7.37h-88.93v.21h0zM673.78 165.95c-.22-4.63-.86-8.64-2.15-12.42-1.29-3.79-3.23-7.15-6.03-9.89-2.59-2.74-6.02-5.05-9.91-6.53-3.88-1.69-8.61-2.31-13.78-2.31s-9.9 1.05-13.99 2.94c-4.31 1.88-7.97 4.42-10.77 7.36-3.01 2.94-5.17 6.31-6.89 10.1s-2.37 7.37-2.37 10.95h65.89v-.21h0z"/><path id="path12" class="cls-2" d="M714.26 120.71h20.89v16.61h.43c2.58-5.68 7.32-10.52 13.78-13.88 6.46-3.58 14-5.26 22.61-5.26 5.39.0 10.34.84 15.29 2.31 4.95 1.68 9.26 4.01 12.71 7.36 3.66 3.37 6.46 7.57 8.83 12.84 2.16 5.26 3.23 11.36 3.23 18.51v69.44h-20.89v-63.76c0-5.05-.65-9.25-2.15-12.83-1.3-3.58-3.23-6.53-5.6-8.64-2.37-2.1-4.95-3.79-7.97-4.83-3.01-1.06-6.24-1.48-9.47-1.48-4.3.0-8.4.63-12.06 2.1-3.66 1.48-6.89 3.58-9.68 6.53-2.8 2.94-4.96 6.73-6.47 11.35-1.5 4.63-2.37 9.89-2.37 16.21v55.55h-20.88V120.69h-.22v.02z"/><polygon id="polygon14" class="cls-2" points="843.03 120.71 875.98 203.4 907.63 120.71 930.03 120.71 886.74 228.64 863.71 228.64 818.7 120.71 843.03 120.71"/><path id="path16" class="cls-2" d="M931.53 174.77c0-7.78 1.51-15.15 4.53-22.09 3.01-6.73 7.1-12.83 12.49-17.88 5.38-5.06 11.41-9.26 18.73-12.2 7.12-2.95 14.86-4.42 23.04-4.42s15.93 1.47 23.04 4.42c7.1 2.94 13.36 6.93 18.73 12.2 5.17 5.25 9.48 11.15 12.5 17.88 3.01 6.73 4.53 14.1 4.53 22.09s-1.52 15.36-4.53 22.1c-3.02 6.94-7.11 12.83-12.5 17.88-5.37 5.05-11.4 9.04-18.73 12-7.11 2.94-14.85 4.41-23.04 4.41s-15.93-1.47-23.04-4.41c-7.1-2.96-13.35-6.95-18.73-12-5.39-5.05-9.48-11.15-12.49-17.88-3.01-6.94-4.53-14.31-4.53-22.1M953.71 174.77c0 5.47.86 10.52 2.59 15.15 1.71 4.62 4.09 8.62 7.31 11.79 3.02 3.37 6.9 5.89 11.42 7.78 4.52 1.89 9.48 2.94 15.08 2.94s10.55-.84 15.07-2.94c4.51-1.89 8.4-4.41 11.42-7.78 3-3.16 5.59-7.16 7.31-11.79 1.73-4.63 2.59-9.68 2.59-15.15s-.86-10.52-2.59-15.15c-1.71-4.63-4.09-8.63-7.31-11.78-3.02-3.15-6.9-5.89-11.42-7.78-4.52-1.89-9.48-2.94-15.07-2.94s-10.56 1.05-15.08 2.94c-4.52 1.9-8.39 4.42-11.42 7.78-3 3.37-5.59 7.15-7.31 11.78-1.73 4.63-2.59 9.68-2.59 15.15"/><path id="path18" class="cls-2" d="M1050.39 120.71h24.12l32.74 84.15h.42l31.44-84.15h22.4l-52.32 131.07c-1.94 4.63-3.88 9.05-5.82 12.84s-4.31 7.15-7.11 9.88c-2.79 2.73-6.25 4.84-10.12 6.31-3.88 1.48-8.82 2.31-14.43 2.31-3.02.0-6.24-.21-9.48-.62-3.22-.41-6.25-1.26-9.25-2.31l2.58-18.74c4.09 1.69 8.4 2.53 12.49 2.53 3.24.0 6.03-.42 8.18-1.26 2.16-.84 4.09-2.1 5.81-3.58 1.73-1.69 3.03-3.36 4.09-5.46 1.08-2.12 2.15-4.63 3.23-7.37l6.88-17.04-45.86-108.56h0z"/><g class="cls-4"><path class="cls-5" d="M636.86 328.23c0 8.4-2.15 14.77-6.44 19.14-4.3 4.36-10.51 6.54-18.65 6.54-4.53.0-8.61-.66-12.25-1.97s-7.1-3.58-10.38-6.79l5.51-6.3c2.43 2.62 5 4.61 7.72 5.95s5.85 2.02 9.4 2.02 6.25-.51 8.51-1.52c2.26-1.02 4.05-2.4 5.36-4.13 1.31-1.74 2.23-3.72 2.75-5.95.52-2.23.79-4.56.79-6.99v-5.9h-.2c-1.84 2.95-4.23 5.12-7.18 6.49-2.95 1.38-5.97 2.07-9.05 2.07-3.61.0-6.92-.59-9.94-1.77-3.02-1.18-5.61-2.82-7.77-4.92s-3.84-4.59-5.02-7.48c-1.18-2.89-1.77-6.03-1.77-9.45.0-3.74.59-7.12 1.77-10.13 1.18-3.02 2.84-5.56 4.97-7.62 2.13-2.07 4.71-3.66 7.72-4.77 3.02-1.11 6.36-1.67 10.04-1.67 1.57.0 3.15.18 4.72.54s3.1.92 4.58 1.67 2.8 1.71 3.98 2.85c1.18 1.15 2.17 2.48 2.95 3.98h.2v-7.87h7.67v43.98zm-40.34-20.95c0 2.36.43 4.54 1.28 6.54s2.02 3.74 3.49 5.21c1.48 1.48 3.2 2.64 5.17 3.49 1.97.85 4.07 1.28 6.3 1.28 2.62.0 4.95-.46 6.99-1.38 2.03-.92 3.75-2.15 5.17-3.69 1.41-1.54 2.48-3.31 3.2-5.31s1.08-4.12 1.08-6.35c0-2.49-.39-4.77-1.18-6.84s-1.9-3.85-3.34-5.36-3.18-2.67-5.21-3.49c-2.03-.82-4.26-1.23-6.69-1.23s-4.64.44-6.64 1.33c-2 .88-3.71 2.1-5.12 3.64-1.41 1.54-2.51 3.35-3.3 5.41-.79 2.07-1.18 4.31-1.18 6.74z"/><path class="cls-5" d="M650.44 290.16c2.36-2.43 5.17-4.21 8.41-5.36 3.25-1.15 6.54-1.72 9.89-1.72 6.82.0 11.74 1.61 14.76 4.82s4.53 8.1 4.53 14.66v19.78c0 1.31.06 2.67.2 4.08.13 1.41.3 2.71.49 3.89h-7.38c-.26-1.05-.41-2.21-.44-3.49-.03-1.28-.05-2.41-.05-3.39h-.2c-1.51 2.36-3.53 4.3-6.05 5.81-2.53 1.51-5.56 2.26-9.1 2.26-2.36.0-4.58-.29-6.64-.89-2.07-.59-3.87-1.46-5.41-2.61-1.54-1.15-2.77-2.57-3.69-4.28-.92-1.71-1.38-3.67-1.38-5.9.0-3.8.98-6.79 2.95-8.95 1.97-2.16 4.41-3.77 7.33-4.82 2.92-1.05 6.07-1.7 9.45-1.97 3.38-.26 6.48-.39 9.3-.39h2.95v-1.38c0-3.35-1-5.87-3-7.58s-4.81-2.56-8.41-2.56c-2.49.0-4.94.41-7.33 1.23-2.4.82-4.51 2.08-6.35 3.79l-4.82-5.02zM672.67 308.16c-4.92.0-8.82.69-11.71 2.07s-4.33 3.64-4.33 6.79c0 2.89.97 4.94 2.9 6.15s4.34 1.82 7.23 1.82c2.23.0 4.18-.38 5.85-1.13 1.67-.75 3.07-1.75 4.18-3 1.12-1.25 1.97-2.71 2.56-4.38.59-1.67.92-3.46.98-5.36v-2.95h-7.67z"/><path class="cls-5" d="M727.28 290.75H713.7v23.02c0 1.51.03 2.9.1 4.18.06 1.28.33 2.39.79 3.34.46.95 1.15 1.71 2.07 2.26.92.56 2.23.84 3.94.84 1.11.0 2.26-.13 3.44-.39 1.18-.26 2.3-.66 3.35-1.18l.29 6.99c-1.31.59-2.77 1.02-4.38 1.28s-3.13.39-4.58.39c-2.75.0-4.95-.36-6.59-1.08-1.64-.72-2.92-1.74-3.84-3.05-.92-1.31-1.52-2.93-1.82-4.87-.29-1.93-.44-4.08-.44-6.44v-25.29h-10.04v-6.49h10.04v-13.09h7.67v13.09h13.58v6.49z"/><path class="cls-5" d="M777.85 321.94c-2.75 3.54-5.77 6.02-9.05 7.43s-7.08 2.12-11.41 2.12c-3.61.0-6.85-.64-9.74-1.92-2.89-1.28-5.33-3-7.33-5.17s-3.54-4.72-4.62-7.67-1.62-6.1-1.62-9.45c0-3.54.59-6.8 1.77-9.79 1.18-2.98 2.82-5.54 4.92-7.67 2.1-2.13 4.59-3.79 7.48-4.97s6.03-1.77 9.45-1.77c3.21.0 6.17.54 8.86 1.62s5 2.66 6.94 4.72c1.93 2.07 3.43 4.59 4.48 7.58 1.05 2.99 1.57 6.38 1.57 10.18v2.46h-37.19c.13 1.97.61 3.85 1.43 5.66.82 1.81 1.88 3.38 3.2 4.72 1.31 1.35 2.85 2.41 4.62 3.2 1.77.79 3.71 1.18 5.8 1.18 3.35.0 6.17-.59 8.46-1.77 2.29-1.18 4.36-2.92 6.2-5.21l5.8 4.53zM771.26 303.14c-.13-3.94-1.41-7.08-3.84-9.45-2.43-2.36-5.77-3.54-10.04-3.54s-7.71 1.18-10.33 3.54-4.2 5.51-4.72 9.45h28.93z"/><path class="cls-5" d="M840.82 330.3h-7.58l-13.09-35.42h-.2l-11.61 35.42h-7.87l-14.96-46.05h8.46l10.53 35.42h.2l11.91-35.42h8.07l12.1 35.42h.2l10.43-35.42h8.26l-14.86 46.05z"/><path class="cls-5" d="M863.74 290.16c2.36-2.43 5.17-4.21 8.41-5.36 3.25-1.15 6.54-1.72 9.89-1.72 6.82.0 11.74 1.61 14.76 4.82s4.53 8.1 4.53 14.66v19.78c0 1.31.06 2.67.2 4.08.13 1.41.29 2.71.49 3.89h-7.38c-.26-1.05-.41-2.21-.44-3.49-.04-1.28-.05-2.41-.05-3.39h-.2c-1.51 2.36-3.53 4.3-6.05 5.81-2.53 1.51-5.56 2.26-9.1 2.26-2.36.0-4.58-.29-6.64-.89-2.07-.59-3.87-1.46-5.41-2.61-1.54-1.15-2.77-2.57-3.69-4.28-.92-1.71-1.38-3.67-1.38-5.9.0-3.8.98-6.79 2.95-8.95 1.97-2.16 4.41-3.77 7.33-4.82 2.92-1.05 6.07-1.7 9.45-1.97 3.38-.26 6.48-.39 9.3-.39h2.95v-1.38c0-3.35-1-5.87-3-7.58s-4.8-2.56-8.41-2.56c-2.49.0-4.94.41-7.33 1.23-2.4.82-4.51 2.08-6.35 3.79l-4.82-5.02zm22.24 18c-4.92.0-8.82.69-11.71 2.07s-4.33 3.64-4.33 6.79c0 2.89.97 4.94 2.9 6.15s4.34 1.82 7.23 1.82c2.23.0 4.18-.38 5.85-1.13 1.67-.75 3.07-1.75 4.18-3 1.12-1.25 1.97-2.71 2.56-4.38.59-1.67.92-3.46.98-5.36v-2.95h-7.68z"/><path class="cls-5" d="M932.32 340.83c-.79 1.97-1.59 3.75-2.41 5.36-.82 1.61-1.8 2.98-2.95 4.13-1.15 1.15-2.53 2.03-4.13 2.66-1.61.62-3.56.93-5.85.93-1.12.0-2.28-.07-3.49-.2s-2.35-.46-3.39-.98l.98-6.69c.79.33 1.61.54 2.46.64.85.1 1.84.15 2.95.15 2.49.0 4.33-.69 5.51-2.07s2.2-3.21 3.05-5.51l3.15-8.66-19.09-46.34h8.95l14.27 36.11h.2l13.68-36.11h8.36l-22.24 56.57z"/></g></g></g></svg></span><span class=navbar-brand__name>Envoy Gateway</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/eg-pr-preview/5-test-docs-preview/docs><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/5-test-docs-preview/news><span>News</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/5-test-docs-preview/about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/5-test-docs-preview/contributions><span>Contributions</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//latest>latest</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//docs>v1.2</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v1.1>v1.1</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v1.0>v1.0</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v0.6>v0.6</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v0.5>v0.5</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v0.4>v0.4</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v0.3>v0.3</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/5-test-docs-preview//v0.2>v0.2</a></li></ul></div></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/eg-pr-preview/5-test-docs-preview/zh/>中文</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/eg-pr-preview/5-test-docs-preview/offline-search-index.59545f0114544c87ac67cca9eb52ae6d.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/eg-pr-preview/5-test-docs-preview/v1.2/>Return to the regular view of this page</a>.</p></div><h1 class=title>Welcome to Envoy Gateway</h1><div class=lead>Envoy Gateway Documents</div><ul><li>1: <a href=#pg-faeef17b08d4313298d8b604ce9c2b49>Concepts</a></li><ul><li>1.1: <a href=#pg-d0b3b0801202cd4fbefdb84fca65761a>Envoy Gateway Resources</a></li></ul><li>2: <a href=#pg-3ffde8fd181b5d75bbfbf3cbdd18cbf1>Tasks</a></li><ul><li>2.1: <a href=#pg-5370fe5473f599bc419e96ed6506a9a8>Quickstart</a></li><li>2.2: <a href=#pg-9467af916479b6b7ed5f96a4d07cc247>Traffic</a></li><ul><li>2.2.1: <a href=#pg-aee09f06729c162396830301e26b5b26>Backend Routing</a></li><li>2.2.2: <a href=#pg-602f8025312fcdb2be12d470631770b1>Circuit Breakers</a></li><li>2.2.3: <a href=#pg-3361a486d9f8398f11cd834bb1a259a2>Client Traffic Policy</a></li><li>2.2.4: <a href=#pg-7d240adbb4292d26f1ae406cfd47986f>Connection Limit</a></li><li>2.2.5: <a href=#pg-dcead2649e963ab7d4affdb5175f0d48>Direct Response</a></li><li>2.2.6: <a href=#pg-ddae55115bbee5d28e50c55e83b9e888>Failover</a></li><li>2.2.7: <a href=#pg-a34a14b0cd03e9c41ba722ff4dae7c1e>Fault Injection</a></li><li>2.2.8: <a href=#pg-bc8344061348e800302b8356902628cc>Gateway Address</a></li><li>2.2.9: <a href=#pg-87c3a7c5ca00e0b9f15990e2dcb2d40e>Gateway API Support</a></li><li>2.2.10: <a href=#pg-cff1dc64e43a34d8f2fa47f32d967318>Global Rate Limit</a></li><li>2.2.11: <a href=#pg-1cb358ab402c97acf8509aa238b2cc78>GRPC Routing</a></li><li>2.2.12: <a href=#pg-34b32816c724617740a2775493df3deb>HTTP Redirects</a></li><li>2.2.13: <a href=#pg-3a981e85fc5968b87c439e3563318304>HTTP Request Headers</a></li><li>2.2.14: <a href=#pg-cf0a66f5b150ce67bc6a9675b0b56b99>HTTP Response Headers</a></li><li>2.2.15: <a href=#pg-f74c03f1a6d807e593a63a913f34709d>HTTP Routing</a></li><li>2.2.16: <a href=#pg-1242a239aa86bf16ce6c3e1b1d9a5187>HTTP Timeouts</a></li><li>2.2.17: <a href=#pg-0edfa2f57a0c2672fc81040c096c5449>HTTP URL Rewrite</a></li><li>2.2.18: <a href=#pg-dd13d985d642d706310a14491029fff0>HTTP3</a></li><li>2.2.19: <a href=#pg-8bf3bd499d7c9c2d7fdf61033b16a26c>HTTPRoute Request Mirroring</a></li><li>2.2.20: <a href=#pg-7baf3976b4af135a1f53f12ff744ac7a>HTTPRoute Traffic Splitting</a></li><li>2.2.21: <a href=#pg-8af6c76d88394977053b8683bc9f6339>Load Balancing</a></li><li>2.2.22: <a href=#pg-ef7eee201b6632a2e9d9fe9f40d5a924>Local Rate Limit</a></li><li>2.2.23: <a href=#pg-f8c2d0aa7e0ed0a05b09f208cdc895c5>Multicluster Service Routing</a></li><li>2.2.24: <a href=#pg-03c6402a73dc2a6d8823ff917396636c>Response Override</a></li><li>2.2.25: <a href=#pg-cefc6262f45f99a1923e5c0330cde320>Retry</a></li><li>2.2.26: <a href=#pg-5c0f15ca30cbfb44997dd22c518bde34>Routing outside Kubernetes</a></li><li>2.2.27: <a href=#pg-f4586a14dc18bf33770411352a03d927>TCP Routing</a></li><li>2.2.28: <a href=#pg-94e2d1222db4bea8206f12ef22355350>UDP Routing</a></li></ul><li>2.3: <a href=#pg-557726d6cac1218a5aa4d38c303a9b13>Security</a></li><ul><li>2.3.1: <a href=#pg-6c75c7ec45bc972198169dc384cc1ae6>Accelerating TLS Handshakes using Private Key Provider in Envoy</a></li><li>2.3.2: <a href=#pg-92fd54b74e99c0282aa8330875f18755>Backend Mutual TLS: Gateway to Backend</a></li><li>2.3.3: <a href=#pg-ef99cfc94f9074bcc4fa3dacc054242b>Backend TLS: Gateway to Backend</a></li><li>2.3.4: <a href=#pg-8f0c5242518e692a7b89bc444cc01efc>Basic Authentication</a></li><li>2.3.5: <a href=#pg-d19c2b7be3babd02a42b7b6371d31db5>CORS</a></li><li>2.3.6: <a href=#pg-a25edaf594fbc4970e81aeef6618c57c>External Authorization</a></li><li>2.3.7: <a href=#pg-cd1041ef46121984423cd102a9b22675>IP Allowlist/Denylist</a></li><li>2.3.8: <a href=#pg-f6156b593933a8266c87c99e8d13b965>JWT Authentication</a></li><li>2.3.9: <a href=#pg-bfcdc0cd514fecb25c8c98cac81a1cdb>JWT Claim-Based Authorization</a></li><li>2.3.10: <a href=#pg-cd4a6c48858764adcec8ad515c66638b>Mutual TLS: External Clients to the Gateway</a></li><li>2.3.11: <a href=#pg-3b80fcbcb0bf612daa582a6bd570dab9>OIDC Authentication</a></li><li>2.3.12: <a href=#pg-33f26d3ba9bd99b03e6a3c0ee1753a71>Secure Gateways</a></li><li>2.3.13: <a href=#pg-56db013a9f84ee7b68c608b1f725c45f>Threat Model</a></li><li>2.3.14: <a href=#pg-da56a3394272e61b500ffb55e8163aca>TLS Passthrough</a></li><li>2.3.15: <a href=#pg-b88ecf395aa21049a39c81de50ac8c8c>TLS Termination for TCP</a></li><li>2.3.16: <a href=#pg-e1fb1672c85ed0bb1882a3481be7cf46>Using cert-manager For TLS Termination</a></li></ul><li>2.4: <a href=#pg-87c7327640420f735c79ec6ee7edab5a>Extensibility</a></li><ul><li>2.4.1: <a href=#pg-e14cd53e9c5ff38545c40940595efb06>Build a Wasm image</a></li><li>2.4.2: <a href=#pg-74beceb6b4d0483feb4800d938f272df>Envoy Patch Policy</a></li><li>2.4.3: <a href=#pg-fe1c0cb314cfa17d83c75a99474c4908>Envoy Gateway Extension Server</a></li><li>2.4.4: <a href=#pg-60820af16b2050bdafa3cc2e04280f7a>External Processing</a></li><li>2.4.5: <a href=#pg-bd38ea26519dd8dc23463c3617afd710>Wasm Extensions</a></li></ul><li>2.5: <a href=#pg-061f956bbc8d624938772636d479e904>Observability</a></li><ul><li>2.5.1: <a href=#pg-704c3841c948479223509ac1feebb5db>Gateway API Metrics</a></li><li>2.5.2: <a href=#pg-ed9c87dc64e932cbe6528df1f570c86f>Gateway Exported Metrics</a></li><li>2.5.3: <a href=#pg-113076d86d4a3ab51ad9552dd9a07d8b>Gateway Observability</a></li><li>2.5.4: <a href=#pg-db30e764627b7b51199826dfd3da7e39>Proxy Access Logs</a></li><li>2.5.5: <a href=#pg-9ee1b7728efc90d883186a9c14749b3a>Proxy Metrics</a></li><li>2.5.6: <a href=#pg-ae0a51978ef58d2b90521336806d11b6>Proxy Tracing</a></li><li>2.5.7: <a href=#pg-c6dcb48cfc3b362ce93e7442db76b5e6>RateLimit Observability</a></li><li>2.5.8: <a href=#pg-29c806415369bc15142435761b777cbb>Visualising metrics using Grafana</a></li></ul><li>2.6: <a href=#pg-19dc792a3628d6e0951189a0c4254e6d>Operations</a></li><ul><li>2.6.1: <a href=#pg-b4a3f7bee70bc62081f2461463768a1d>Customize EnvoyProxy</a></li><li>2.6.2: <a href=#pg-9d98915f1fd3b77c7409205e64e6124e>Deployment Mode</a></li><li>2.6.3: <a href=#pg-afcad90650762949b935f95348647119>Standalone Deployment Mode</a></li><li>2.6.4: <a href=#pg-2f309c5f4449e3d9b0e3a261f853ad76>Use egctl</a></li></ul></ul><li>3: <a href=#pg-e5b30fe922af4d9819aeddf7a8114f18>Installation</a></li><ul><li>3.1: <a href=#pg-33a8f17a33acfbbbe86011ec5e007097>Install with Helm</a></li><li>3.2: <a href=#pg-71f8f322d1cf1387f45bc1f1eb600ff9>Install with Kubernetes YAML</a></li><li>3.3: <a href=#pg-b4e9976bf99ec9b3a4100438bd9cb738>Install egctl</a></li><li>3.4: <a href=#pg-47cdb8cfca1889b42b1ed5b03bf816eb>Control Plane Authentication using custom certs</a></li><li>3.5: <a href=#pg-e16617c26da42e3d88bd31274052d863>Gateway Addons Helm Chart</a></li><li>3.6: <a href=#pg-5c6ac3b4609685fd4926b3763a0b0787>Gateway Helm Chart</a></li><li>3.7: <a href=#pg-003eafaf9ca04a2c7e2916618060684a>Migrating from Ingress Resources</a></li></ul><li>4: <a href=#pg-e816e595aac1a27dc48b7c13d7b3f2cd>API</a></li><ul><li>4.1: <a href=#pg-ff9bd458db8f40d8bddd9f100b655f05>API Reference</a></li></ul></ul><div class=content><p>Envoy Gateway is an open source project for managing <a href=https://www.envoyproxy.io/>Envoy Proxy</a> as a standalone or Kubernetes-based application
gateway. <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> resources are used to dynamically provision and configure the managed Envoy Proxies.</p><p><img alt=architecture src=/img/traffic.png></p><h2 id=ready-to-get-started>Ready to get started?<a class=td-heading-self-link href=#ready-to-get-started aria-label="Heading self-link"></a></h2></div></div><div class=td-content><h1 id=pg-faeef17b08d4313298d8b604ce9c2b49>1 - Concepts</h1><div class=lead>Learn about key concepts when working with Envoy Gateway</div></div><div class=td-content><h1 id=pg-d0b3b0801202cd4fbefdb84fca65761a>1.1 - Envoy Gateway Resources</h1><p>There are several resources that play a part in enabling you to meet your Kubernetes ingress traffic handling needs. This page provides a brief overview of the resources you’ll be working with.</p><h2 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h2><p><img src=/img/envoy-gateway-resources-overview.png></p><p>There are several resources that play a part in enabling you to meet your Kubernetes ingress traffic handling needs. This page provides a brief overview of the resources you’ll be working with.</p><h3 id=kubernetes-gateway-api-resources>Kubernetes Gateway API Resources<a class=td-heading-self-link href=#kubernetes-gateway-api-resources aria-label="Heading self-link"></a></h3><ul><li><strong>GatewayClass:</strong> Defines a class of Gateways with common configuration.</li><li><strong>Gateway:</strong> Specifies how traffic can enter the cluster.</li><li><strong>Routes:</strong> <strong>HTTPRoute, GRPCRoute, TLSRoute, TCPRoute, UDPRoute:</strong> Define routing rules for different types of traffic.</li></ul><h3 id=envoy-gateway-eg-api-resources>Envoy Gateway (EG) API Resources<a class=td-heading-self-link href=#envoy-gateway-eg-api-resources aria-label="Heading self-link"></a></h3><ul><li><strong>EnvoyProxy:</strong> Represents the deployment and configuration of the Envoy proxy within a Kubernetes cluster, managing its lifecycle and settings.</li><li><strong>EnvoyPatchPolicy, ClientTrafficPolicy, SecurityPolicy, BackendTrafficPolicy, EnvoyExtensionPolicy, BackendTLSPolicy:</strong> Additional policies and configurations specific to Envoy Gateway.</li><li><strong>Backend:</strong> A resource that makes routing to cluster-external backends easier and makes access to external processes via Unix Domain Sockets possible.</li></ul><table><thead><tr><th>Resource</th><th>API</th><th>Required</th><th>Purpose</th><th>References</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a></td><td>Gateway API</td><td>Yes</td><td>Gateway Config</td><td>Core</td><td>Defines a class of Gateways with common configuration.</td></tr><tr><td><a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a></td><td>Gateway API</td><td>Yes</td><td>Gateway Config</td><td>GatewayClass</td><td>Specifies how traffic can enter the cluster.</td></tr><tr><td><a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a> <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a></td><td>Gateway API</td><td>Yes</td><td>Routing</td><td>Gateway</td><td>Define routing rules for different types of traffic. <strong>Note:</strong><em>For simplicity these resources are referenced collectively as Route in the References column</em></td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/backend/>Backend</a></td><td>EG API</td><td>No</td><td>Routing</td><td>N/A</td><td>Used for routing to cluster-external backends using FQDN or IP. Can also be used when you want to extend Envoy with external processes accessed via Unix Domain Sockets.</td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicy>ClientTrafficPolicy</a></td><td>EG API</td><td>No</td><td>Traffic Handling</td><td>Gateway</td><td>Specifies policies for handling client traffic, including rate limiting, retries, and other client-specific configurations.</td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicy>BackendTrafficPolicy</a></td><td>EG API</td><td>No</td><td>Traffic Handling</td><td>Gateway, Route</td><td>Specifies policies for traffic directed towards backend services, including load balancing, health checks, and failover strategies. <strong>Note:</strong><em>Most specific configuration wins</em></td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicy>SecurityPolicy</a></td><td>EG API</td><td>No</td><td>Security</td><td>Gateway, Route</td><td>Defines security-related policies such as authentication, authorization, and encryption settings for traffic handled by Envoy Gateway. <strong>Note:</strong><em>Most specific configuration wins</em></td></tr><tr><td><a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a></td><td>Gateway API</td><td>No</td><td>Security</td><td>Service</td><td>Defines TLS settings for backend connections, including certificate management, TLS version settings, and other security configurations. This policy is applied to Kubernetes Services.</td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a></td><td>EG API</td><td>No</td><td>Customize & Extend</td><td>GatewayClass, Gateway</td><td>The EnvoyProxy resource represents the deployment and configuration of the Envoy proxy itself within a Kubernetes cluster, managing its lifecycle and settings. <strong>Note:</strong><em>Most specific configuration wins</em></td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchpolicy>EnvoyPatchPolicy</a></td><td>EG API</td><td>No</td><td>Customize & Extend</td><td>GatewayClass, Gateway</td><td>This policy defines custom patches to be applied to Envoy Gateway resources, allowing users to tailor the configuration to their specific needs. <strong>Note:</strong><em>Most specific configuration wins</em></td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicy>EnvoyExtensionPolicy</a></td><td>EG API</td><td>No</td><td>Customize & Extend</td><td>Gateway, Route, Backend</td><td>Allows for the configuration of Envoy proxy extensions, enabling custom behavior and functionality. <strong>Note:</strong><em>Most specific configuration wins</em></td></tr><tr><td><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httproutefilter>HTTPRouteFilter</a></td><td>EG API</td><td>No</td><td>Customize & Extend</td><td>HTTPRoute</td><td>Allows for the additional request/response processing.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-3ffde8fd181b5d75bbfbf3cbdd18cbf1>2 - Tasks</h1><div class=lead>Learn Envoy Gateway hands-on through tasks</div></div><div class=td-content><h1 id=pg-5370fe5473f599bc419e96ed6506a9a8>2.1 - Quickstart</h1><div class=lead>Get started with Envoy Gateway in a few simple steps.</div><p>This &ldquo;quick start&rdquo; will help you get started with Envoy Gateway in a few simple steps.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>A Kubernetes cluster.</p><p><strong>Note:</strong> Refer to the <a href=/eg-pr-preview/5-test-docs-preview/news/releases/matrix/>Compatibility Matrix</a> for supported Kubernetes versions.</p><p><strong>Note:</strong> In case your Kubernetes cluster does not have a LoadBalancer implementation, we recommend installing one
so the <code>Gateway</code> resource has an Address associated with it. We recommend using <a href=https://metallb.universe.tf/installation/>MetalLB</a>.</p><p><strong>Note:</strong> For Mac user, you need install and run <a href=https://github.com/chipmk/docker-mac-net-connect>Docker Mac Net Connect</a> to make the Docker network work.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install the Gateway API CRDs and Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Install the GatewayClass, Gateway, HTTPRoute and example app:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/v1.2.4/quickstart.yaml -n default
</span></span></code></pre></div><p><strong>Note</strong>: <a href=https://github.com/envoyproxy/gateway/releases/download/v1.2.4/quickstart.yaml><code>quickstart.yaml</code></a> defines that Envoy Gateway will listen for
traffic on port 80 on its globally-routable IP address, to make it easy to use
browsers to test Envoy Gateway. When Envoy Gateway sees that its Listener is
using a privileged port (&lt;1024), it will map this internally to an
unprivileged port, so that Envoy Gateway doesn&rsquo;t need additional privileges.
It&rsquo;s important to be aware of this mapping, since you may need to take it into
consideration when debugging.</p><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-03-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-03-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><p>You can also test the same functionality by sending traffic to the External IP. To get the external IP of the
Envoy service, run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>In certain environments, the load balancer may be exposed using a hostname, instead of an IP address. If so, replace
<code>ip</code> in the above command with <code>hostname</code>.</p><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:80 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div></div></div><h2 id=what-to-explore-next>What to explore next?<a class=td-heading-self-link href=#what-to-explore-next aria-label="Heading self-link"></a></h2><p>In this quickstart, you have:</p><ul><li>Installed Envoy Gateway</li><li>Deployed a backend service, and a gateway</li><li>Configured the gateway using Kubernetes Gateway API resources <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HttpRoute</a> to direct incoming requests over HTTP to the backend service.</li></ul><p>Here is a suggested list of follow-on tasks to guide you in your exploration of Envoy Gateway:</p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/http-routing/>HTTP Routing</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/http-traffic-splitting/>Traffic Splitting</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/>Secure Gateways</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/global-rate-limit/>Global Rate Limit</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/grpc-routing/>gRPC Routing</a></li></ul><p>Review the <a href=/eg-pr-preview/5-test-docs-preview/>Tasks</a> section for the scenario matching your use case. The Envoy Gateway tasks are organized by category: traffic management, security, extensibility, observability, and operations.</p><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Use the steps in this section to uninstall everything from the quickstart.</p><p>Delete the GatewayClass, Gateway, HTTPRoute and Example App:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f https://github.com/envoyproxy/gateway/releases/download/v1.2.4/quickstart.yaml --ignore-not-found<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p>Delete the Gateway API CRDs and Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm uninstall eg -n envoy-gateway-system
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9467af916479b6b7ed5f96a4d07cc247>2.2 - Traffic</h1><div class=lead>This section includes Traffic Management tasks.</div></div><div class=td-content><h1 id=pg-aee09f06729c162396830301e26b5b26>2.2.1 - Backend Routing</h1><p>Envoy Gateway supports routing to native K8s resources such as <code>Service</code> and <code>ServiceImport</code>. The <code>Backend</code> API is a custom Envoy Gateway <a href=https://gateway-api.sigs.k8s.io/guides/migrating-from-ingress/#approach-to-extensibility>extension resource</a> that can used in Gateway-API <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a>.</p><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>The Backend API was added to support several use cases:</p><ul><li>Allowing users to integrate Envoy with services (Ext Auth, Rate Limit, ALS, &mldr;) using Unix Domain Sockets, which are currently not supported by K8s.</li><li>Simplify <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/routing-outside-kubernetes/>routing to cluster-external backends</a>, which currently requires users to maintain both K8s <code>Service</code> and <code>EndpointSlice</code> resources.</li></ul><h2 id=warning>Warning<a class=td-heading-self-link href=#warning aria-label="Heading self-link"></a></h2><p>Similar to the K8s EndpointSlice API, the Backend API can be misused to allow traffic to be sent to otherwise restricted destinations, as described in <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-25740>CVE-2021-25740</a>.
A Backend resource can be used to:</p><ul><li>Expose a Service or Pod that should not be accessible</li><li>Reference a Service or Pod by a Route without appropriate Reference Grants</li><li>Expose the Envoy Proxy localhost (including the Envoy admin endpoint)</li></ul><p>For these reasons, the Backend API is disabled by default in Envoy Gateway configuration. Envoy Gateway admins are advised to follow <a href=https://github.com/kubernetes/kubernetes/issues/103675>upstream recommendations</a> and restrict access to the Backend API using K8s RBAC.</p><h2 id=restrictions>Restrictions<a class=td-heading-self-link href=#restrictions aria-label="Heading self-link"></a></h2><p>The Backend API is currently supported only in the following BackendReferences:</p><ul><li><a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a>: IP and FQDN endpoints</li><li><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a>: IP and FQDN endpoints</li><li><a href=../../../api/extension_types#envoyextensionpolicy>Envoy Extension Policy</a> (ExtProc): IP, FQDN and unix domain socket endpoints</li><li><a href=../../../api/extension_types#oidcprovider>Security Policy</a>: IP and FQDN endpoints for the OIDC providers</li></ul><p>The Backend API supports attachment the following policies:</p><ul><li><a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>Backend TLS Policy</a></li></ul><p>Certain restrictions apply on the value of hostnames and addresses. For example, the loopback IP address range and the localhost hostname are forbidden.</p><p>Envoy Gateway does not manage the lifecycle of unix domain sockets referenced by the Backend resource. Envoy Gateway admins are responsible for creating and mounting the sockets into the envoy proxy pod. The latter can be achieved by patching the envoy deployment using the <a href=../../../api/extension_types#envoyproxy>EnvoyProxy</a> resource.</p><h2 id=quickstart>Quickstart<a class=td-heading-self-link href=#quickstart aria-label="Heading self-link"></a></h2><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=enable-backend>Enable Backend<a class=td-heading-self-link href=#enable-backend aria-label="Heading self-link"></a></h3><ul><li><p>By default <a href=../../../api/extension_types#backend>Backend</a> is disabled. Lets enable it in the <a href=../../../api/extension_types#envoygateway>EnvoyGateway</a> startup configuration</p></li><li><p>The default installation of Envoy Gateway installs a default <a href=../../../api/extension_types#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In the next step, we will update this resource to enable Backend.</p></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      enableBackend: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      enableBackend: true</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><h3 id=route-to-external-backend>Route to External Backend<a class=td-heading-self-link href=#route-to-external-backend aria-label="Heading self-link"></a></h3><ul><li>In the following example, we will create a <code>Backend</code> resource that routes to httpbin.org:80 and a <code>HTTPRoute</code> that references this backend.</li></ul><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - fqdn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        hostname: httpbin.org
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>fqdn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin.org</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Get the Gateway address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Send a request and view the response:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -I -HHost:www.example.com http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/headers
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-602f8025312fcdb2be12d470631770b1>2.2.2 - Circuit Breakers</h1><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/circuit_breaking>Envoy circuit breakers</a> can be used to fail quickly and apply back-pressure in response to upstream service degradation.</p><p>Envoy Gateway supports the following circuit breaker thresholds:</p><ul><li><strong>Concurrent Connections</strong>: limit the connections that Envoy can establish to the upstream service. When this threshold is met, new connections will not be established, and some requests will be queued until an existing connection becomes available.</li><li><strong>Concurrent Requests</strong>: limit on concurrent requests in-flight from Envoy to the upstream service. When this threshold is met, requests will be queued.</li><li><strong>Pending Requests</strong>: limit the pending request queue size. When this threshold is met, overflowing requests will be terminated with a <code>503</code> status code.</li></ul><p>Envoy&rsquo;s circuit breakers are distributed: counters are not synchronized across different Envoy processes. The default Envoy and Envoy Gateway circuit breaker threshold values (1024) may be too strict for high-throughput systems.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired circuit breaker thresholds.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note</strong>: There are distinct circuit breaker counters for each <code>BackendReference</code> in an <code>xRoute</code> rule. Even if a <code>BackendTrafficPolicy</code> targets a <code>Gateway</code>, each <code>BackendReference</code> in that gateway still has separate circuit breaker counter.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=install-the-hey-load-testing-tool>Install the hey load testing tool<a class=td-heading-self-link href=#install-the-hey-load-testing-tool aria-label="Heading self-link"></a></h3><ul><li>The <code>hey</code> CLI will be used to generate load and measure response times. Follow the installation instruction from the <a href=https://github.com/rakyll/hey>Hey project</a> docs.</li></ul><h2 id=test-and-customize-circuit-breaker-settings>Test and customize circuit breaker settings<a class=td-heading-self-link href=#test-and-customize-circuit-breaker-settings aria-label="Heading self-link"></a></h2><p>This example will simulate a degraded backend that responds within 10 seconds by adding the <code>?delay=10s</code> query parameter to API calls. The hey tool will be used to generate 100 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>10s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	10.3426 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	10.3420 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	10.0664 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	10.2145 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	9.6687
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	36600 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	366 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.066 [1]	|■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.094 [4]	|■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.122 [9]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.149 [10]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.177 [10]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.204 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.232 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.259 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.287 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.314 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.342 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span></code></pre></div><p>The default circuit breaker threshold (1024) is not met. As a result, requests do not overflow: all requests are proxied upstream and both Envoy and clients wait for 10s.</p><p>In order to fail fast, apply a <code>BackendTrafficPolicy</code> that limits concurrent requests to 10 and pending requests to 0.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: circuitbreaker-for-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  circuitBreaker:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    maxPendingRequests: 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    maxParallelRequests: 10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>circuitbreaker-for-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>circuitBreaker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>maxPendingRequests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>maxParallelRequests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Execute the load simulation again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>10s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	10.1230 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	10.1224 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0529 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	1.0677 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	9.8785
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	10940 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	109 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.053 [1]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  1.060 [89]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.067 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  3.074 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  4.081 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  5.088 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  6.095 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  7.102 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  8.109 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  9.115 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.122 [10]	|■■■■
</span></span></span></code></pre></div><p>With the new circuit breaker settings, and due to the slowness of the backend, only the first 10 concurrent requests were proxied, while the other 90 overflowed.</p><ul><li>Overflowing Requests failed fast, reducing proxy resource consumption.</li><li>Upstream traffic was limited, alleviating the pressure on the degraded service.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3361a486d9f8398f11cd834bb1a259a2>2.2.3 - Client Traffic Policy</h1><p>This task explains the usage of the <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> API.</p><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>The <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> API allows system administrators to configure
the behavior for how the Envoy Proxy server behaves with downstream clients.</p><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>This API was added as a new policy attachment resource that can be applied to Gateway resources and it is meant to hold settings for configuring behavior of the connection between the downstream client and Envoy Proxy listener. It is the counterpart to the <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> API resource.</p><h2 id=quickstart>Quickstart<a class=td-heading-self-link href=#quickstart aria-label="Heading self-link"></a></h2><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=support-tcp-keepalive-for-downstream-client>Support TCP keepalive for downstream client<a class=td-heading-self-link href=#support-tcp-keepalive-for-downstream-client aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-tcp-keepalive-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tcpKeepalive:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    idleTime: 20m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    interval: 60s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    probes: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-tcp-keepalive-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tcpKeepalive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>idleTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>20m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>interval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>60s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>probes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify that ClientTrafficPolicy is Accepted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get clienttrafficpolicies.gateway.envoyproxy.io -n default
</span></span></code></pre></div><p>You should see the policy marked as accepted like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          STATUS     AGE
</span></span><span style=display:flex><span>enable-tcp-keepalive-policy   Accepted   5s
</span></span></code></pre></div><p>Curl the example app through Envoy proxy once again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose  --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get --next --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><p>You should see the output like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 172.18.255.202:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.202 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.202<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Fri, <span style=color:#0000cf;font-weight:700>01</span> Dec <span style=color:#0000cf;font-weight:700>2023</span> 10:17:04 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>507</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.1.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;4d0d33e8-d611-41f0-9da0-6458eec20fa5&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-2zwvn&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>* Found bundle <span style=color:#204a87;font-weight:700>for</span> host: 0x7fb9f5204ea0 <span style=color:#ce5c00;font-weight:700>[</span>serially<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>* Can not multiplex, even <span style=color:#204a87;font-weight:700>if</span> we wanted to
</span></span><span style=display:flex><span>* Re-using existing connection <span style=color:#8f5902;font-style:italic>#0 with host 172.18.255.202</span>
</span></span><span style=display:flex><span>&gt; GET /headers HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Fri, <span style=color:#0000cf;font-weight:700>01</span> Dec <span style=color:#0000cf;font-weight:700>2023</span> 10:17:04 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>511</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/headers&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.1.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;9a8874c0-c117-481c-9b04-933571732ca5&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-2zwvn&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see keepalive connection marked by the output in:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span>* Re-using existing connection <span style=color:#8f5902;font-style:italic>#0 with host 172.18.255.202</span>
</span></span></code></pre></div><h3 id=enable-proxy-protocol-for-downstream-client>Enable Proxy Protocol for downstream client<a class=td-heading-self-link href=#enable-proxy-protocol-for-downstream-client aria-label="Heading self-link"></a></h3><p>This example configures Proxy Protocol for downstream clients.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-proxy-protocol-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  enableProxyProtocol: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-proxy-protocol-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enableProxyProtocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify that ClientTrafficPolicy is Accepted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get clienttrafficpolicies.gateway.envoyproxy.io -n default
</span></span></code></pre></div><p>You should see the policy marked as accepted like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          STATUS     AGE
</span></span><span style=display:flex><span>enable-proxy-protocol-policy   Accepted   5s
</span></span></code></pre></div><p>Try the endpoint without using PROXY protocol with curl:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 172.18.255.202:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.202 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.202<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>* Recv failure: Connection reset by peer
</span></span><span style=display:flex><span>* Closing connection <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>curl: <span style=color:#ce5c00;font-weight:700>(</span>56<span style=color:#ce5c00;font-weight:700>)</span> Recv failure: Connection reset by peer
</span></span></code></pre></div><p>Curl the example app through Envoy proxy once again, now sending HAProxy PROXY protocol header at the beginning of the connection with &ndash;haproxy-protocol flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --haproxy-protocol --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><p>You should now expect 200 response status and also see that source IP was preserved in the X-Forwarded-For header.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 172.18.255.202:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.202 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.202<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Mon, <span style=color:#0000cf;font-weight:700>04</span> Dec <span style=color:#0000cf;font-weight:700>2023</span> 21:11:43 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>510</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.1.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;192.168.255.6&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;290e4b61-44b7-4e5c-a39c-0ec76784e897&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-2zwvn&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=configure-client-ip-detection>Configure Client IP Detection<a class=td-heading-self-link href=#configure-client-ip-detection aria-label="Heading self-link"></a></h3><p>This example configures the number of additional ingress proxy hops from the right side of XFF HTTP headers to trust when determining the origin client&rsquo;s IP address and determines whether or not <code>x-forwarded-proto</code> headers will be trusted. Refer to <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for>https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for</a> for details.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-client-ip-detection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clientIPDetection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    xForwardedFor:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      numTrustedHops: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-client-ip-detection</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>clientIPDetection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>xForwardedFor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>numTrustedHops</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify that ClientTrafficPolicy is Accepted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get clienttrafficpolicies.gateway.envoyproxy.io -n default
</span></span></code></pre></div><p>You should see the policy marked as accepted like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          STATUS     AGE
</span></span><span style=display:flex><span>http-client-ip-detection   Accepted   5s
</span></span></code></pre></div><p>Open port-forward to the admin interface port:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward deploy/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_DEPLOYMENT</span><span style=color:#4e9a06>}</span> -n envoy-gateway-system 19000:19000
</span></span></code></pre></div><p>Curl the admin interface port to fetch the configured value for <code>xff_num_trusted_hops</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#39;http://localhost:19000/config_dump?resource=dynamic_listeners&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.configs[0].active_state.listener.default_filter_chain.filters[0].typed_config 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      | with_entries(select(.key | match(&#34;xff|remote_address|original_ip&#34;)))&#39;</span>
</span></span></code></pre></div><p>You should expect to see the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;use_remote_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;xff_num_trusted_hops&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://<span style=color:#000>$GATEWAY_HOST</span>/get <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;X-Forwarded-Proto: https&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;X-Forwarded-For: 1.1.1.1,2.2.2.2&#34;</span>
</span></span></code></pre></div><p>You should expect 200 response status, see that <code>X-Forwarded-Proto</code> was preserved and <code>X-Envoy-External-Address</code> was set to the leftmost address in the <code>X-Forwarded-For</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying <span style=color:#ce5c00;font-weight:700>[</span>::1<span style=color:#ce5c00;font-weight:700>]</span>:8888...
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#ce5c00;font-weight:700>(</span>::1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>8888</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.4.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; X-Forwarded-Proto: https
</span></span><span style=display:flex><span>&gt; X-Forwarded-For: 1.1.1.1,2.2.2.2
</span></span><span style=display:flex><span>&gt; 
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8888</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Tue, <span style=color:#0000cf;font-weight:700>30</span> Jan <span style=color:#0000cf;font-weight:700>2024</span> 15:19:22 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>535</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.4.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-External-Address&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;1.1.1.1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;1.1.1.1,2.2.2.2,10.244.0.9&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;https&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;53ccfad7-1899-40fa-9322-ddb833aa1ac3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-8psnc&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host localhost left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=enable-http-request-received-timeout>Enable HTTP Request Received Timeout<a class=td-heading-self-link href=#enable-http-request-received-timeout aria-label="Heading self-link"></a></h3><p>This feature allows you to limit the time taken by the Envoy Proxy fleet to receive the entire request from the client, which is useful in preventing certain clients from consuming too much memory in Envoy
This example configures the HTTP request timeout for the client, please check out the details <a href=https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/timeouts#stream-timeouts>here</a>.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: client-timeout
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  timeout:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    http:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestReceivedTimeout: 2s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client-timeout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestReceivedTimeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>2s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://<span style=color:#000>$GATEWAY_HOST</span>/get <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Content-Length: 10000&#34;</span>
</span></span></code></pre></div><p>You should expect <code>428</code> response status after 2s:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://<span style=color:#000>$GATEWAY_HOST</span>/get <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Content-Length: 10000&#34;</span>
</span></span><span style=display:flex><span>*   Trying 172.18.255.200:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.200 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.200<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.4.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; Content-Length: <span style=color:#0000cf;font-weight:700>10000</span>
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>408</span> Request Timeout
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>15</span>
</span></span><span style=display:flex><span>&lt; content-type: text/plain
</span></span><span style=display:flex><span>&lt; date: Tue, <span style=color:#0000cf;font-weight:700>27</span> Feb <span style=color:#0000cf;font-weight:700>2024</span> 07:38:27 GMT
</span></span><span style=display:flex><span>&lt; connection: close
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>* Closing connection
</span></span><span style=display:flex><span>request timeout
</span></span></code></pre></div><h3 id=configure-client-http-idle-timeout>Configure Client HTTP Idle Timeout<a class=td-heading-self-link href=#configure-client-http-idle-timeout aria-label="Heading self-link"></a></h3><p>The idle timeout is defined as the period in which there are no active requests. When the idle timeout is reached the connection will be closed.
For more details see <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-httpprotocoloptions-idle-timeout:~:text=...%7D%0A%7D-,idle_timeout,-(Duration)%20The">here</a>.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: client-timeout
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  timeout:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    http:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      idleTimeout: 5s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client-timeout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>idleTimeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>5s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl s_client -crlf -connect <span style=color:#000>$GATEWAY_HOST</span>:443
</span></span></code></pre></div><p>You should expect the connection to be closed after 5s.</p><p>You can also check the number of connections closed due to idle timeout by using the following query:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>envoy_http_downstream_cx_idle_timeout<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>envoy_http_conn_manager_prefix</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&lt;name of connection manager&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>}</span> 
</span></span></code></pre></div><p>The number of connections closed due to idle timeout should be increased by 1.</p><h3 id=configure-downstream-per-connection-buffer-limit>Configure Downstream Per Connection Buffer Limit<a class=td-heading-self-link href=#configure-downstream-per-connection-buffer-limit aria-label="Heading self-link"></a></h3><p>This feature allows you to set a soft limit on size of the listener’s new connection read and write buffers.
The size is configured using the <code>resource.Quantity</code> format, see examples <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory>here</a>.</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-06-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-06-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: client-timeout
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  connection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    bufferLimit: 1024
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client-timeout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>connection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>bufferLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7d240adbb4292d26f1ae406cfd47986f>2.2.4 - Connection Limit</h1><p>The connection limit features allows users to limit the number of concurrently active TCP connections on a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.Gateway>Gateway</a> or a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Listener>Listener</a>.
When the <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/connection_limit_filter>connection limit</a> is reached, new connections are closed immediately by Envoy proxy. It&rsquo;s possible to configure a delay for connection rejection.</p><p>Users may want to limit the number of connections for several reasons:</p><ul><li>Protect resources like CPU and Memory.</li><li>Ensure that different listeners can receive a fair share of global resources.</li><li>Protect from malicious activity like DoS attacks.</li></ul><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#clienttrafficpolicy>Client Traffic Policy</a> that allows the user to describe their desired connection limit settings.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.Gateway>Gateway</a>.</p><p>The Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/connection_limit_filter>connection limit</a> implementation is distributed: counters are not synchronized between different envoy proxies.</p><p>When a <a href=../../../api/extension_types#clienttrafficpolicy>Client Traffic Policy</a> is attached to a gateway, the connection limit will apply differently based on the
<a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Listener>Listener</a> protocol in use:</p><ul><li>HTTP: all HTTP listeners in a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.Gateway>Gateway</a> will share a common connection counter, and a limit defined by the policy.</li><li>HTTPS/TLS: each HTTPS/TLS listener will have a dedicated connection counter, and a limit defined by the policy.</li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=install-the-hey-load-testing-tool>Install the hey load testing tool<a class=td-heading-self-link href=#install-the-hey-load-testing-tool aria-label="Heading self-link"></a></h3><ul><li>The <code>hey</code> CLI will be used to generate load and measure response times. Follow the installation instruction from the <a href=https://github.com/rakyll/hey>Hey project</a> docs.</li></ul><h2 id=test-and-customize-connection-limit-settings>Test and customize connection limit settings<a class=td-heading-self-link href=#test-and-customize-connection-limit-settings aria-label="Heading self-link"></a></h2><p>This example we use <code>hey</code> to open 10 connections and execute 1 RPS per connection for 10 seconds.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -c <span style=color:#0000cf;font-weight:700>10</span> -q <span style=color:#0000cf;font-weight:700>1</span> -z 10s  -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	10.0058 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0275 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0029 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0111 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	9.9942
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>[...]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Status code distribution:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [200]	100 responses
</span></span></span></code></pre></div><p>There are no connection limits, and so all 100 requests succeed.</p><p>Next, we apply a limit of 5 connections.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: connection-limit-ctp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  connection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    connectionLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      value: 5    
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>connection-limit-ctp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>connection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>connectionLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><p>Execute the load simulation again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -c <span style=color:#0000cf;font-weight:700>10</span> -q <span style=color:#0000cf;font-weight:700>1</span> -z 10s  -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	11.0327 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0361 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0013 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0088 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	9.0640
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>[...] 
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Status code distribution:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [200]	50 responses
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error distribution:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [50]	Get &#34;http://localhost:8888/get&#34;: EOF
</span></span></span></code></pre></div><p>With the new connection limit, only 5 of 10 connections are established, and so only 50 requests succeed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-dcead2649e963ab7d4affdb5175f0d48>2.2.5 - Direct Response</h1><p>Direct responses are valuable in cases where you want the gateway itself
to handle certain requests without forwarding them to backend services.
This task shows you how to configure them.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=testing-direct-response>Testing Direct Response<a class=td-heading-self-link href=#testing-direct-response aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: direct-response
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;    
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /inline
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: direct-response-inline
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /value-ref
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: direct-response-value-ref
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: value-ref-response
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  response.body: &#39;{&#34;error&#34;: &#34;Internal Server Error&#34;}&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: direct-response-inline
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  directResponse:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    contentType: text/plain
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    statusCode: 503
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Inline
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      inline: &#34;Oops! Your request is not found.&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: direct-response-value-ref
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  directResponse:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    contentType: application/json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    statusCode: 500
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: ValueRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      valueRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: value-ref-response
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>direct-response</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>direct-response-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/value-ref</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>direct-response-value-ref</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value-ref-response</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>response.body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{&#34;error&#34;: &#34;Internal Server Error&#34;}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>direct-response-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>directResponse</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>contentType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>text/plain</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>statusCode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>503</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>inline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Oops! Your request is not found.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>direct-response-value-ref</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>directResponse</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>contentType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>application/json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>statusCode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValueRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>valueRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value-ref-response</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/inline
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 127.0.0.1 (127.0.0.1) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /inline HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.4.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> 
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>503</span> Service Unavailable
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: text/plain
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 32
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Sat, 02 Nov 2024 00:35:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; 
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 127.0.0.1 left intact
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Oops! Your request is not found.
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/value-ref
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 127.0.0.1 (127.0.0.1) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /value-ref HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.4.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> 
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>500</span> Internal Server Error
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 34
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Sat, 02 Nov 2024 00:35:55 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; 
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 127.0.0.1 left intact
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{&#34;error&#34;: &#34;Internal Server Error&#34;}
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ddae55115bbee5d28e50c55e83b9e888>2.2.6 - Failover</h1><p>Active-passive failover in an API gateway setup is like having a backup plan in place to keep things
running smoothly if something goes wrong. Here’s why it’s valuable:</p><ul><li><p>Staying Online: When the main (or &ldquo;active&rdquo;) backend has issues or goes offline,
the fallback (or &ldquo;passive&rdquo;) backend is ready to step in instantly.
This helps keep your API accessible and your services running, so users don’t even notice any interruptions.</p></li><li><p>Automatic Switch Over: If a problem occurs, the system can automatically switch traffic over to the fallback backend.
This avoids needing someone to jump in and fix things manually, which could take time and might even lead to mistakes.</p></li><li><p>Lower Costs: In an active-passive setup, the fallback backend doesn’t need to work all the time—it’s just on standby.
This can save on costs (like cloud egress costs) compared to setups where both backend are running at full capacity.</p></li><li><p>Peace of Mind with Redundancy: Although the fallback backend isn’t handling traffic daily, it&rsquo;s there as a safety net.
If something happens with the primary backend, the backup can take over immediately, ensuring your service doesn’t skip a beat.</p></li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=test>Test<a class=td-heading-self-link href=#test aria-label="Heading self-link"></a></h2><ul><li>We&rsquo;ll first create two services & deployments, called <code>active</code> and <code>passive</code>, representing an <code>active</code> and <code>passive</code> backend application.</li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: active 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: active 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: passive 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: passive
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: passive
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: passive
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: passive
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: passive
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: passive
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: passive 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li><p>Follow the instructions <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/backend/#enable-backend>here</a> to enable the Backend API</p></li><li><p>Create two Backend resources that are used to represent the <code>active</code> backend and <code>passive</code> backend.
Note, we&rsquo;ve set <code>fallback: true</code> for the <code>passive</code> backend to indicate its a passive backend</p></li></ul><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: passive 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  fallback: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - fqdn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        hostname: passive.default.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - fqdn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      hostname: active.default.svc.cluster.local 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>fallback</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>fqdn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive.default.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>fqdn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active.default.svc.cluster.local </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li>Lets create an HTTPRoute that can route to both these backends</li></ul><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ha-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - www.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: passive 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /test
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ha-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li>Lets configure a <code>BackendTrafficPolicy</code> with a passive health check setting to detect an transient errors.</li></ul><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: passive-health-check
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: ha-example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  healthCheck:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    passive:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      baseEjectionTime: 10s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      interval: 2s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      maxEjectionPercent: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      consecutive5XxErrors: 1 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      consecutiveGatewayErrors: 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      consecutiveLocalOriginFailures: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      splitExternalLocalOriginErrors: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passive-health-check</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ha-example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>healthCheck</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>passive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>baseEjectionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>interval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>2s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>maxEjectionPercent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>consecutive5XxErrors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>consecutiveGatewayErrors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>consecutiveLocalOriginFailures</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>splitExternalLocalOriginErrors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li>Lets send 10 requests. You should see that they all go to the <code>active</code> backend.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..10<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/test 2&gt;/dev/null <span style=color:#000;font-weight:700>|</span> jq .pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;active-5bb896774f-lz8s9&#34;
</span></span></span></code></pre></div><ul><li>Lets simulate a failure in the <code>active</code> backend by changing the server listening port to <code>5000</code></li></ul><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: active
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: active 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: HTTP_PORT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: &#34;5000&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>active </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP_PORT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;5000&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li>Lets send 10 requests again. You should see them all being sent to the <code>passive</code> backend</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..10<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/test 2&gt;/dev/null <span style=color:#000;font-weight:700>|</span> jq .pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>parse error: Invalid numeric literal at line 1, column 9
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#34;passive-7ddbf945c9-wkc4f&#34;
</span></span></span></code></pre></div><p>The first error can be avoided by configuring <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/retry/>retries</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a34a14b0cd03e9c41ba722ff4dae7c1e>2.2.7 - Fault Injection</h1><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/fault_filter.html>Envoy fault injection</a> can be used to inject delays and abort requests to mimic failure scenarios such as service failures and overloads.</p><p>Envoy Gateway supports the following fault scenarios:</p><ul><li><strong>delay fault</strong>: inject a custom fixed delay into the request with a certain probability to simulate delay failures.</li><li><strong>abort fault</strong>: inject a custom response code into the response with a certain probability to simulate abort failures.</li></ul><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired fault scenarios.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>For GRPC - follow the steps from the <a href=../grpc-routing>GRPC Routing</a> example.</p><h3 id=install-the-hey-load-testing-tool>Install the hey load testing tool<a class=td-heading-self-link href=#install-the-hey-load-testing-tool aria-label="Heading self-link"></a></h3><ul><li>The <code>hey</code> CLI will be used to generate load and measure response times. Follow the installation instruction from the <a href=https://github.com/rakyll/hey>Hey project</a> docs.</li></ul><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Allow requests with a valid faultInjection by creating an <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> and attaching it to the example HTTPRoute or GRPCRoute.</p><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: fault-injection-50-percent-abort
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  faultInjection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    abort:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      httpStatus: 501
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      percentage: 50
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: fault-injection-delay
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  faultInjection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    delay:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      fixedDelay: 2s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fault-injection-50-percent-abort</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>faultInjection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>abort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>httpStatus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>501</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>percentage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fault-injection-delay</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>faultInjection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>fixedDelay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>2s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Two HTTPRoute resources were created, one for <code>/foo</code> and another for <code>/bar</code>. <code>fault-injection-abort</code> BackendTrafficPolicy has been created and targeted HTTPRoute foo to abort requests for <code>/foo</code>. <code>fault-injection-delay</code> BackendTrafficPolicy has been created and targeted HTTPRoute foo to delay <code>2s</code> requests for <code>/bar</code>.</p><p>Verify the HTTPRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/foo -o yaml
</span></span><span style=display:flex><span>kubectl get httproute/bar -o yaml
</span></span></code></pre></div><p>Verify the BackendTrafficPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get backendtrafficpolicy/fault-injection-50-percent-abort -o yaml
</span></span><span style=display:flex><span>kubectl get backendtrafficpolicy/fault-injection-delay -o yaml
</span></span></code></pre></div><h3 id=grpcroute>GRPCRoute<a class=td-heading-self-link href=#grpcroute aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: fault-injection-abort
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  faultInjection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    abort:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      grpcStatus: 14
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fault-injection-abort</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRPCRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>faultInjection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>abort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>grpcStatus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRPCRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>example</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-routing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;grpc-example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>A BackendTrafficPolicy has been created and targeted GRPCRoute yages to abort requests for <code>yages</code> service..</p><p>Verify the GRPCRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroute/yages -o yaml
</span></span></code></pre></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get backendtrafficpolicy/fault-injection-abort -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><p>Verify that requests to <code>foo</code> route are aborted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>1000</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Status code distribution:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [200]	501 responses
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [501]	499 responses
</span></span></span></code></pre></div><p>Verify that requests to <code>bar</code> route are delayed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>1000</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/bar
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	20.1493 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	2.1020 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	1.9940 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	2.0123 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	49.6295
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	557000 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	557 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  1.994 [1]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.005 [475]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.016 [419]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.026 [5]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.037 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.048 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.059 [30]	|■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.070 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.080 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.091 [11]	|■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.102 [59]	|■■■■■
</span></span></span></code></pre></div><h3 id=grpcroute-1>GRPCRoute<a class=td-heading-self-link href=#grpcroute-1 aria-label="Heading self-link"></a></h3><p>Verify that requests to <code>yages</code>service are aborted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Error invoking method <span style=color:#4e9a06>&#34;yages.Echo/Ping&#34;</span>: rpc error: <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> Unavailable <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> failed to query <span style=color:#204a87;font-weight:700>for</span> service descriptor <span style=color:#4e9a06>&#34;yages.Echo&#34;</span>: fault filter abort
</span></span></code></pre></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the BackendTrafficPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete BackendTrafficPolicy/fault-injection-abort
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-bc8344061348e800302b8356902628cc>2.2.8 - Gateway Address</h1><p>The Gateway API provides an optional <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GatewayAddress>Addresses</a> field through which Envoy Gateway can set addresses for Envoy Proxy Service.
Depending on the Service Type, the addresses of gateway can be used as:</p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/gateway-address/#external-ips>External IPs</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/gateway-address/#cluster-ip>Cluster IP</a></li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=external-ips>External IPs<a class=td-heading-self-link href=#external-ips aria-label="Heading self-link"></a></h2><p>Using the addresses in <code>Gateway.Spec.Addresses</code> as the <a href=https://kubernetes.io/docs/concepts/services-networking/service/#external-ips>External IPs</a> of Envoy Proxy Service,
this will <strong>require</strong> the address to be of type <code>IPAddress</code> and the <a href=../../../api/extension_types#servicetype>ServiceType</a> to be of <code>LoadBalancer</code> or <code>NodePort</code>.</p><p>The Envoy Gateway deploys Envoy Proxy Service as <code>LoadBalancer</code> by default,
so you can set the address of the Gateway directly (the address settings here are for reference only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>- op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  path: /spec/addresses
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   - type: IPAddress
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>     value: 1.2.3.4
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>NAME   CLASS   ADDRESS   PROGRAMMED   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg     eg      1.2.3.4   True         14m
</span></span></span></code></pre></div><p>Verify the Envoy Proxy Service status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service -n envoy-gateway-system
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>envoy-default-eg-64656661       LoadBalancer   10.96.236.219   1.2.3.4       80:31017/TCP   15m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>envoy-gateway                   ClusterIP      10.96.192.76    &lt;none&gt;        18000/TCP      15m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>envoy-gateway-metrics-service   ClusterIP      10.96.124.73    &lt;none&gt;        8443/TCP       15m
</span></span></span></code></pre></div><p><strong>Note:</strong> If the <code>Gateway.Spec.Addresses</code> is explicitly set, it will be the only addresses that populates the Gateway status.</p><h2 id=cluster-ip>Cluster IP<a class=td-heading-self-link href=#cluster-ip aria-label="Heading self-link"></a></h2><p>Using the addresses in <code>Gateway.Spec.Addresses</code> as the <a href=https://kubernetes.io/docs/concepts/services-networking/service/#type-clusterip>Cluster IP</a> of Envoy Proxy Service,
this will <strong>require</strong> the address to be of type <code>IPAddress</code> and the <a href=../../../api/extension_types#servicetype>ServiceType</a> to be of <code>ClusterIP</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-87c3a7c5ca00e0b9f15990e2dcb2d40e>2.2.9 - Gateway API Support</h1><p>As mentioned in the <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/system-design/>system design</a> document, Envoy Gateway&rsquo;s managed data plane is configured dynamically through
Kubernetes resources, primarily <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> objects. Envoy Gateway supports configuration using the following Gateway API resources.</p><h2 id=gatewayclass>GatewayClass<a class=td-heading-self-link href=#gatewayclass aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GatewayClass>GatewayClass</a> represents a &ldquo;class&rdquo; of gateways, i.e. which Gateways should be managed by Envoy Gateway.
Envoy Gateway supports managing <strong>a single</strong> GatewayClass resource that matches its configured <code>controllerName</code> and
follows Gateway API guidelines for <a href="https://gateway-api.sigs.k8s.io/concepts/guidelines/?h=conflict#conflicts">resolving conflicts</a> when multiple GatewayClasses exist with a matching
<code>controllerName</code>.</p><p><strong>Note:</strong> If specifying GatewayClass <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.ParametersReference>parameters reference</a>, it must refer to an <a href=../../../api/extension_types#envoyproxy>EnvoyProxy</a> resource.</p><h2 id=gateway>Gateway<a class=td-heading-self-link href=#gateway aria-label="Heading self-link"></a></h2><p>When a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Gateway>Gateway</a> resource is created that references the managed GatewayClass, Envoy Gateway will create and manage a
new Envoy Proxy deployment. Gateway API resources that reference this Gateway will configure this managed Envoy Proxy
deployment.</p><h2 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRoute>HTTPRoute</a> configures routing of HTTP traffic through one or more Gateways. The following HTTPRoute filters are
supported by Envoy Gateway:</p><ul><li><code>requestHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>RequestHeaderModifiers</a>
can be used to modify or add request headers before the request is proxied to its destination.</li><li><code>responseHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>ResponseHeaderModifiers</a>
can be used to modify or add response headers before the response is sent back to the client.</li><li><code>requestMirror</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>RequestMirrors</a>
configure destinations where the requests should also be mirrored to. Responses to mirrored requests will be ignored.</li><li><code>requestRedirect</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>RequestRedirects</a>
configure policied for how requests that match the HTTPRoute should be modified and then redirected.</li><li><code>urlRewrite</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>UrlRewrites</a>
allow for modification of the request&rsquo;s hostname and path before it is proxied to its destination.</li><li><code>extensionRef</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilterType>ExtensionRefs</a> are used by Envoy Gateway to implement extended filters. Currently, Envoy Gateway
supports rate limiting and request authentication filters. For more information about these filters, refer to the
<a href=/eg-pr-preview/5-test-docs-preview/contributions/design/rate-limit/>rate limiting</a> and <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/jwt-authentication/>request authentication</a> documentation.</li></ul><p><strong>Notes:</strong></p><ul><li>The only <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>BackendRef</a> kind supported by Envoy Gateway is a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>. Routing traffic to other destinations such
as arbitrary URLs is not possible.</li><li>Only <code>requestHeaderModifier</code> and <code>responseHeaderModifier</code> filters are currently supported within <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPBackendRef>HTTPBackendRef</a>.</li></ul><h2 id=tcproute>TCPRoute<a class=td-heading-self-link href=#tcproute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> configures routing of raw TCP traffic through one or more Gateways. Traffic can be forwarded to the
desired BackendRefs based on a TCP port number.</p><p><strong>Note:</strong> A TCPRoute only supports proxying in non-transparent mode, i.e. the backend will see the source IP and port of
the Envoy Proxy instance instead of the client.</p><h2 id=udproute>UDPRoute<a class=td-heading-self-link href=#udproute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a> configures routing of raw UDP traffic through one or more Gateways. Traffic can be forwarded to the
desired BackendRefs based on a UDP port number.</p><p><strong>Note:</strong> Similar to TCPRoutes, UDPRoutes only support proxying in non-transparent mode i.e. the backend will see the
source IP and port of the Envoy Proxy instance instead of the client.</p><h2 id=grpcroute>GRPCRoute<a class=td-heading-self-link href=#grpcroute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRoute>GRPCRoute</a> configures routing of <a href=https://grpc.io/>gRPC</a> requests through one or more Gateways. They offer request matching by
hostname, gRPC service, gRPC method, or HTTP/2 Header. Envoy Gateway supports the following filters on GRPCRoutes to
provide additional traffic processing:</p><ul><li><code>requestHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>RequestHeaderModifiers</a>
can be used to modify or add request headers before the request is proxied to its destination.</li><li><code>responseHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>ResponseHeaderModifiers</a>
can be used to modify or add response headers before the response is sent back to the client.</li><li><code>requestMirror</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>RequestMirrors</a>
configure destinations where the requests should also be mirrored to. Responses to mirrored requests will be ignored.</li></ul><p><strong>Notes:</strong></p><ul><li>The only <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>BackendRef</a> kind supported by Envoy Gateway is a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>. Routing traffic to other
destinations such as arbitrary URLs is not currently possible.</li><li>Only <code>requestHeaderModifier</code> and <code>responseHeaderModifier</code> filters are currently supported within <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GRPCBackendRef>GRPCBackendRef</a>.</li></ul><h2 id=tlsroute>TLSRoute<a class=td-heading-self-link href=#tlsroute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a> configures routing of TCP traffic through one or more Gateways. However, unlike TCPRoutes, TLSRoutes
can match against TLS-specific metadata.</p><h2 id=referencegrant>ReferenceGrant<a class=td-heading-self-link href=#referencegrant aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.ReferenceGrant>ReferenceGrant</a> is used to allow a resource to reference another resource in a different namespace. Normally an
HTTPRoute created in namespace <code>foo</code> is not allowed to reference a Service in namespace <code>bar</code>. A ReferenceGrant permits
these types of cross-namespace references. Envoy Gateway supports the following ReferenceGrant use-cases:</p><ul><li>Allowing an HTTPRoute, GRPCRoute, TLSRoute, UDPRoute, or TCPRoute to reference a Service in a different namespace.</li><li>Allowing an HTTPRoute&rsquo;s <code>requestMirror</code> filter to include a BackendRef that references a Service in a different
namespace.</li><li>Allowing a Gateway&rsquo;s <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a> to reference a secret in a different namespace.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cff1dc64e43a34d8f2fa47f32d967318>2.2.10 - Global Rate Limit</h1><p>Rate limit is a feature that allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p><p>Here are some reasons why you may want to implement Rate limits</p><ul><li>To prevent malicious activity such as DDoS attacks.</li><li>To prevent applications and its resources (such as a database) from getting overloaded.</li><li>To create API limits based on user entitlements.</li></ul><p>Envoy Gateway supports two types of rate limiting: <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> and <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting>Local rate limiting</a>.</p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> applies a shared rate limit to the traffic flowing through all the instances of Envoy proxies where it is configured.
i.e. if the data plane has 2 replicas of Envoy running, and the rate limit is 10 requests/second, this limit is shared and will be hit
if 5 requests pass through the first replica and 5 requests pass through the second replica within the same second.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their rate limit intent. This instantiated resource
can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note:</strong> Limit is applied per route. Even if a <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> targets a gateway, each route in that gateway
still has a separate rate limit bucket. For example, if a gateway has 2 routes, and the limit is 100r/s, then each route
has its own 100r/s rate limit bucket.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=install-redis>Install Redis<a class=td-heading-self-link href=#install-redis aria-label="Heading self-link"></a></h3><ul><li>The global rate limit feature is based on <a href=https://github.com/envoyproxy/ratelimit>Envoy Ratelimit</a> which requires a Redis instance as its caching layer.
Lets install a Redis deployment in the <code>redis-system</code> namespce.</li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis-system 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: redis-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - image: redis:6.0.6
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cpu: 1500m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cpu: 200m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            memory: 256Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: redis-system 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    targetPort: 6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis-system </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis:6.0.6</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1500m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>512Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>200m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>256Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis-system </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6379</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>6379</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=enable-global-rate-limit-in-envoy-gateway>Enable Global Rate limit in Envoy Gateway<a class=td-heading-self-link href=#enable-global-rate-limit-in-envoy-gateway aria-label="Heading self-link"></a></h3><ul><li>The default installation of Envoy Gateway installs a default <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In the next step, we will update this resource to enable rate limit in Envoy Gateway
as well as configure the URL for the Redis instance used for Global rate limiting.</li></ul><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      backend:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        redis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          url: redis.redis-system.svc.cluster.local:6379</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><h2 id=rate-limit-specific-user>Rate Limit Specific User<a class=td-heading-self-link href=#rate-limit-specific-user aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code>x-user-id</code> header
with a value set to <code>one</code>.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: one
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>one</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-ratelimit -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Let&rsquo;s query <code>ratelimit.example/get</code> 4 times. We should receive a <code>200</code> response from the example Gateway for the first 3 requests
and then receive a <code>429</code> status code for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code>x-user-id</code>
and value <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should be able to send requests with the <code>x-user-id</code> header and a different value and receive successful responses from the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:38 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:39 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h2 id=rate-limit-distinct-users-except-admin>Rate Limit Distinct Users Except Admin<a class=td-heading-self-link href=#rate-limit-distinct-users-except-admin aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the
value in the <code>x-user-id</code> header. Here, user <code>one</code> (recognised from the traffic flow using the header <code>x-user-id</code> and value <code>one</code>) will be rate limited at 3 requests/hour
and so will user <code>two</code> (recognised from the traffic flow using the header <code>x-user-id</code> and value <code>two</code>). But if <code>x-user-id</code> is <code>admin</code>, it will not be rate limited even beyond 3 requests/hour.</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-06-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-06-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: Distinct
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            invert: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Distinct</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-07-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-07-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Lets run the same command again with the header <code>x-user-id</code> and value <code>one</code> set in the request. We should the first 3 requests succeeding and
the 4th request being rate limited.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should see the same behavior when the value for header <code>x-user-id</code> is set to <code>two</code> and 4 requests are sent.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>But when the value for header <code>x-user-id</code> is set to <code>admin</code> and 4 requests are sent, all 4 of them should respond with 200 OK.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: admin&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h2 id=rate-limit-all-requests>Rate Limit All Requests<a class=td-heading-self-link href=#rate-limit-all-requests aria-label="Heading self-link"></a></h2><p>This example shows you how to rate limit all requests matching the HTTPRoute rule at 3 requests/Hour by leaving the <code>clientSelectors</code> field unset.</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-08-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-08-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=httproute-2>HTTPRoute<a class=td-heading-self-link href=#httproute-2 aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-09-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-09-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h2 id=rate-limit-client-ip-addresses>Rate Limit Client IP Addresses<a class=td-heading-self-link href=#rate-limit-client-ip-addresses aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on their
IP address (also reflected in the <code>X-Forwarded-For</code> header).</p><p>Note: EG supports two kinds of rate limit for the IP address: Exact and Distinct.</p><ul><li>Exact means that all IP addresses within the specified Source IP CIDR share the same rate limit bucket.</li><li>Distinct means that each IP address within the specified Source IP CIDR has its own rate limit bucket.</li></ul><ul class="nav nav-tabs" id=tabs-10 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-10-00-tab data-bs-toggle=tab data-bs-target=#tabs-10-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-10-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-10-01-tab data-bs-toggle=tab data-bs-target=#tabs-10-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-10-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-10-content><div class="tab-body tab-pane fade show active" id=tabs-10-00 role=tabpanel aria-labelled-by=tabs-10-00-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - sourceCIDR: 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: 0.0.0.0/0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Distinct
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-01 role=tabpanel aria-labelled-by=tabs-10-01-tab tabindex=10><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>sourceCIDR</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.0.0.0</span><span style=color:#000>/0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Distinct</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:45 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:46 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h2 id=rate-limit-jwt-claims>Rate Limit Jwt Claims<a class=td-heading-self-link href=#rate-limit-jwt-claims aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the value of the Jwt claims carried.</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-11-00-tab data-bs-toggle=tab data-bs-target=#tabs-11-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-11-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-11-01-tab data-bs-toggle=tab data-bs-target=#tabs-11-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-11-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-11-content><div class="tab-body tab-pane fade show active" id=tabs-11-00 role=tabpanel aria-labelled-by=tabs-11-00-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jwt:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    providers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      remoteJWKS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        uri: https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/jwks.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      claimToHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - claim: name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header: x-claim-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-claim-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: John Doe
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-01 role=tabpanel aria-labelled-by=tabs-11-01-tab tabindex=11><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jwt-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwt</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>remoteJWKS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>claimToHeaders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>claim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-claim-name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-claim-name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>John Doe</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/with-different-claim.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN1</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><h3 id=rate-limit-by-carrying-token>Rate limit by carrying <code>TOKEN</code><a class=td-heading-self-link href=#rate-limit-by-carrying-token aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:25 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:26 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:27 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:28 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h3 id=no-rate-limit-by-carrying-token1>No Rate Limit by carrying <code>TOKEN1</code><a class=td-heading-self-link href=#no-rate-limit-by-carrying-token1 aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN1</span><span style=color:#4e9a06>&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:35 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h3 id=optional-editing-kubernetes-resources-settings-for-the-rate-limit-service>(Optional) Editing Kubernetes Resources settings for the Rate Limit Service<a class=td-heading-self-link href=#optional-editing-kubernetes-resources-settings-for-the-rate-limit-service aria-label="Heading self-link"></a></h3><ul><li><p>The default installation of Envoy Gateway installs a default <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a> configuration and provides the initial rate
limit kubernetes resources settings. such as <code>replicas</code> is 1, requests resources cpu is <code>100m</code>, memory is <code>512Mi</code>. the others
like container <code>image</code>, <code>securityContext</code>, <code>env</code> and pod <code>annotations</code> and <code>securityContext</code> can be modified by modifying the <code>ConfigMap</code>.</p></li><li><p><code>tls.certificateRef</code> set the client certificate for redis server TLS connections.</p></li></ul><ul class="nav nav-tabs" id=tabs-12 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-12-00-tab data-bs-toggle=tab data-bs-target=#tabs-12-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-12-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-12-01-tab data-bs-toggle=tab data-bs-target=#tabs-12-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-12-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-12-content><div class="tab-body tab-pane fade show active" id=tabs-12-00 role=tabpanel aria-labelled-by=tabs-12-00-tab tabindex=12><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        rateLimitDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            image: envoyproxy/ratelimit:master
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: CACHE_KEY_PREFIX
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: &#34;eg:rl:&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                cpu: 100m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsUser: 2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              allowPrivilegeEscalation: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              key1: val1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              key2: val2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsUser: 1000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsGroup: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              fsGroup: 2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              fsGroupChangePolicy: &#34;OnRootMismatch&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            certificateRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              name: ratelimit-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-12-01 role=tabpanel aria-labelled-by=tabs-12-01-tab tabindex=12><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        rateLimitDeployment:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          container:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            image: envoyproxy/ratelimit:master
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            env:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            - name: CACHE_KEY_PREFIX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              value: &#34;eg:rl:&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              requests:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                cpu: 100m
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              runAsUser: 2000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              allowPrivilegeEscalation: false
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          pod:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            annotations:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              key1: val1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              key2: val2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              runAsUser: 1000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              runAsGroup: 3000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              fsGroup: 2000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              fsGroupChangePolicy: &#34;OnRootMismatch&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      backend:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        redis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          tls:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            certificateRef:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              name: ratelimit-cert</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-1cb358ab402c97acf8509aa238b2cc78>2.2.11 - GRPC Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource allows users to configure gRPC routing by matching HTTP/2 traffic and forwarding it to backend gRPC servers.
To learn more about gRPC routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install the gRPC routing example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/grpc-routing.yaml
</span></span></code></pre></div><p>The manifest installs a <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, a Deployment, a Service, and a GRPCRoute resource.
The GatewayClass is a cluster-scoped resource that represents a class of Gateways that can be instantiated.</p><p><strong>Note:</strong> Envoy Gateway is configured by default to manage a GatewayClass with
<code>controllerName: gateway.envoyproxy.io/gatewayclass-controller</code>.</p><h2 id=verification>Verification<a class=td-heading-self-link href=#verification aria-label="Heading self-link"></a></h2><p>Check the status of the GatewayClass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gc --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Accepted=True&rdquo;, indicating Envoy Gateway is managing the GatewayClass.</p><p>A Gateway represents configuration of infrastructure. When a Gateway is created, <a href=https://www.envoyproxy.io/>Envoy proxy</a> infrastructure is
provisioned or configured by Envoy Gateway. The <code>gatewayClassName</code> defines the name of a GatewayClass used by this
Gateway. Check the status of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Ready=True&rdquo;, indicating the Envoy proxy infrastructure has been provisioned. The status also
provides the address of the Gateway. This address is used later to test connectivity to proxied backend services.</p><p>Check the status of the GRPCRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>The status for the GRPCRoute should surface &ldquo;Accepted=True&rdquo; and a <code>parentRef</code> that references the example Gateway.
The <code>example-route</code> matches any traffic for &ldquo;grpc-example.com&rdquo; and forwards it to the &ldquo;yages&rdquo; Service.</p><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><p>Before testing GRPC routing to the <code>yages</code> backend, get the Gateway&rsquo;s address.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;text&#34;</span>: <span style=color:#4e9a06>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Envoy Gateway also supports <a href=https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md#protocol-differences-vs-grpc-over-http2>gRPC-Web</a> requests for this configuration. The below <code>curl</code> command can be used to send a grpc-Web request with over HTTP/2. You should receive the same response seen in the previous command.</p><p>The data in the body <code>AAAAAAA=</code> is a base64 encoded representation of an empty message (data length 0) that the Ping RPC accepts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --http2-prior-knowledge -s <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80/yages.Echo/Ping -H <span style=color:#4e9a06>&#39;Host: grpc-example.com&#39;</span>   -H <span style=color:#4e9a06>&#39;Content-Type: application/grpc-web-text&#39;</span>   -H <span style=color:#4e9a06>&#39;Accept: application/grpc-web-text&#39;</span> -XPOST -d<span style=color:#4e9a06>&#39;AAAAAAA=&#39;</span> <span style=color:#000;font-weight:700>|</span> base64 -d
</span></span></code></pre></div><h2 id=grpcroute-match>GRPCRoute Match<a class=td-heading-self-link href=#grpcroute-match aria-label="Heading self-link"></a></h2><p>The <code>matches</code> field can be used to restrict the route to a specific set of requests based on GRPC&rsquo;s service and/or method names.
It supports two match types: <code>Exact</code> and <code>RegularExpression</code>.</p><h3 id=exact>Exact<a class=td-heading-self-link href=#exact aria-label="Heading self-link"></a></h3><p><code>Exact</code> match is the default match type.</p><p>The following example shows how to match a request based on the service and method names for <code>grpc.reflection.v1alpha.ServerReflection/ServerReflectionInfo</code>,
as well as a match for all services with a method name <code>Ping</code> which matches <code>yages.Echo/Ping</code> in our deployment.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: Ping
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRPCRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>example</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-routing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;grpc-example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServerReflectionInfo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc.reflection.v1alpha.ServerReflection</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ping</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the GRPCRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><h3 id=regularexpression>RegularExpression<a class=td-heading-self-link href=#regularexpression aria-label="Heading self-link"></a></h3><p>The following example shows how to match a request based on the service and method names
with match type <code>RegularExpression</code>. It matches all the services and methods with pattern
<code>/.*.Echo/Pin.+</code>, which matches <code>yages.Echo/Ping</code> in our deployment.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: &#34;Pin.+&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: &#34;.*.Echo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RegularExpression
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRPCRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>example</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-routing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;grpc-example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServerReflectionInfo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc.reflection.v1alpha.ServerReflection</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Pin.+&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;.*.Echo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RegularExpression</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yages</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the GRPCRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-34b32816c724617740a2775493df3deb>2.2.12 - HTTP Redirects</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can issue redirects to clients or rewrite paths sent upstream using filters. Note that
HTTPRoute rules cannot use both filter types at once. Currently, Envoy Gateway only supports <strong>core</strong>
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>HTTPRoute filters</a> which consist of <code>RequestRedirect</code> and <code>RequestHeaderModifier</code> at the time of this writing. To
learn more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=redirects>Redirects<a class=td-heading-self-link href=#redirects aria-label="Heading self-link"></a></h2><p>Redirects return HTTP 3XX responses to a client, instructing it to retrieve a different resource. A
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.HTTPRequestRedirectFilter><code>RequestRedirect</code> filter</a> instructs Gateways to emit a redirect response to requests that match the rule.
For example, to issue a permanent redirect (301) from HTTP to HTTPS, configure <code>requestRedirect.statusCode=301</code> and
<code>requestRedirect.scheme="https"</code>:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-to-https-filter-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - redirect.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          scheme: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          statusCode: 301
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: www.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-to-https-filter-redirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>redirect.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestRedirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requestRedirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>statusCode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>301</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p><strong>Note:</strong> <code>301</code> (default) and <code>302</code> are the only supported statusCodes.</p><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-to-https-filter-redirect -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>redirect.example/get</code> should result in a <code>301</code> response from the example Gateway and redirecting to the
configured redirect hostname.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: redirect.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 301 Moved Permanently
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; location: https://www.example.com/get
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>If you followed the steps in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/>Secure Gateways</a> task, you should be able to curl the redirect
location.</p><h2 id=http----https>HTTP &ndash;> HTTPS<a class=td-heading-self-link href=#http----https aria-label="Heading self-link"></a></h2><p>Listeners expose the TLS setting on a per domain or subdomain basis. TLS settings of a listener are applied to all domains that satisfy the hostname criteria.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/CN=example.com&#39;</span> -keyout CA.key -out CA.crt
</span></span><span style=display:flex><span>openssl req -out example.com.csr -newkey rsa:2048 -nodes -keyout tls.key -subj <span style=color:#4e9a06>&#34;/CN=example.com&#34;</span>
</span></span></code></pre></div><p>Generate a self-signed wildcard certificate for <code>example.com</code> with <code>*.example.com</code> extension</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | openssl x509 -req -days 365 -CA CA.crt -CAkey CA.key -set_serial 0 \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>-subj &#34;/CN=example.com&#34; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>-in example.com.csr -out tls.crt -extensions v3_req  -extfile -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[v3_req]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>keyUsage = keyEncipherment, dataEncipherment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>extendedKeyUsage = serverAuth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>subjectAltName = @alt_names
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[alt_names]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>DNS.1   = example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>DNS.2   = *.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Create the kubernetes tls secret</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-com --key<span style=color:#ce5c00;font-weight:700>=</span>tls.key --cert<span style=color:#ce5c00;font-weight:700>=</span>tls.crt
</span></span></code></pre></div><p>Define a https listener on the existing gateway</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # hostname: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # hostname: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: example-com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># hostname: &#34;*.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># hostname: &#34;*.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Terminate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>certificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Check for any TLS certificate issues on the gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n default describe gateway eg
</span></span></code></pre></div><p>Create two HTTPRoutes and attach them to the HTTP and HTTPS listeners using the <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.CommonRouteSpec>sectionName</a> field.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tls-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # - &#34;*.example.com&#34; # catch all hostnames
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            scheme: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls-redirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># - &#34;*.example.com&#34; # catch all hostnames</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestRedirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requestRedirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Curl the example app through http listener:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><p>Curl the example app through https listener:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#39;Host:www.example.com&#39;</span> --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#000>$GATEWAY_HOST</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert CA.crt https://www.example.com:443/get
</span></span></code></pre></div><h2 id=path-redirects>Path Redirects<a class=td-heading-self-link href=#path-redirects aria-label="Heading self-link"></a></h2><p>Path redirects use an HTTP Path Modifier to replace either entire paths or path prefixes. For example, the HTTPRoute
below will issue a 302 redirect to all <code>path.redirect.example</code> requests whose path begins with <code>/get</code> to <code>/status/200</code>.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-path-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.redirect.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: /get
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplaceFullPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replaceFullPath: /status/200
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          statusCode: 302
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-path-redirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>path.redirect.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/get</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestRedirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requestRedirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplaceFullPath</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>replaceFullPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/status/200</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>statusCode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>302</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-path-redirect -o yaml
</span></span></code></pre></div><p>Querying <code>path.redirect.example</code> should result in a <code>302</code> response from the example Gateway and a redirect location
containing the configured redirect path.</p><p>Query the <code>path.redirect.example</code> host:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: path.redirect.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span></code></pre></div><p>You should receive a <code>302</code> with a redirect location of <code>http://path.redirect.example/status/200</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3a981e85fc5968b87c439e3563318304>2.2.13 - HTTP Request Headers</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can modify the headers of a request before forwarding it to the upstream service. HTTPRoute
rules cannot use both filter types at once. Currently, Envoy Gateway only supports <strong>core</strong> <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>HTTPRoute filters</a> which
consist of <code>RequestRedirect</code> and <code>RequestHeaderModifier</code> at the time of this writing. To learn more about HTTP routing,
refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPHeaderFilter><code>RequestHeaderModifier</code> filter</a> instructs Gateways to modify the headers in requests that match the rule
before forwarding the request upstream. Note that the <code>RequestHeaderModifier</code> filter will only modify headers before the
request is sent from Envoy to the upstream service and will not affect response headers returned to the downstream
client.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=adding-request-headers>Adding Request Headers<a class=td-heading-self-link href=#adding-request-headers aria-label="Heading self-link"></a></h2><p>The <code>RequestHeaderModifier</code> filter can add new headers to a request before it is sent to the upstream. If the request
does not have the header configured by the filter, then that header will be added to the request. If the request already
has the header configured by the filter, then the value of the header in the filter will be appended to the value of the
header in the request.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;add-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code> with the value:
<code>something,foo</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;add-header: something&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Add-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;something&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=setting-request-headers>Setting Request Headers<a class=td-heading-self-link href=#setting-request-headers aria-label="Heading self-link"></a></h2><p>Setting headers is similar to adding headers. If the request does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/http-request-headers/#adding-request-headers>adding request headers</a> which will append the value of the header if
the request already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;set-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code> with the original value
<code>something</code> replaced by <code>foo</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;set-header: something&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=removing-request-headers>Removing Request Headers<a class=td-heading-self-link href=#removing-request-headers aria-label="Heading self-link"></a></h2><p>Headers can be removed from a request by simply supplying a list of header names.</p><p>Setting headers is similar to adding headers. If the request does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/http-request-headers/#adding-request-headers>adding request headers</a> which will append the value of the header if
the request already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;remove-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>remove</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;remove-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code>, but the header
<code>remove-header</code> that was sent by curl was removed before the upstream received the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;add-header: something&#34;</span> --header <span style=color:#4e9a06>&#34;remove-header: foo&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Add-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;something&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=combining-filters>Combining Filters<a class=td-heading-self-link href=#combining-filters aria-label="Heading self-link"></a></h2><p>Headers can be added/set/removed in a single filter on the same HTTPRoute and they will all perform as expected</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;bar&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;add-header-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;set-header-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>remove</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;removed-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=early-header-modification>Early Header Modification<a class=td-heading-self-link href=#early-header-modification aria-label="Heading self-link"></a></h2><p>In some cases, it could be necessary to modify headers before the proxy performs any sort of processing, routing or tracing. Envoy Gateway supports this functionality using the <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> API.</p><p>A ClientTrafficPolicy resource can be attached to a Gateway resource to configure early header modifications for all its routes. In the following example we will demonstrate how early header modification can be configured.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: early-added-header
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: late
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: early-set-header
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: late
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: early-removed-header
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: late 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-early-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    earlyRequestHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;early-added-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;early&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;early-set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;early&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;early-removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requestHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>early-added-header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>late</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>early-set-header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>late</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>early-removed-header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>late</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-early-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>earlyRequestHeaders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;early-added-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;early&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;early-set-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;early&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>remove</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;early-removed-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the following headers:</p><ul><li><code>early-added-header</code> contains early (ClientTrafficPolicy) and late (RouteFilter) values</li><li><code>early-set-header</code> contains only early (ClientTrafficPolicy) and late (RouteFilter) values, since the early modification overwritten the client value.</li><li><code>early-removed-header</code> contains only the late (RouteFilter) value, since the early modification deleted the client value.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header  <span style=color:#4e9a06>&#34;early-added-header: client&#34;</span> --header  <span style=color:#4e9a06>&#34;early-set-header: client&#34;</span> --header  <span style=color:#4e9a06>&#34;early-removed-header: client&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Early-Added-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;client&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;early&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;late&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Early-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;early&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;late&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Early-removed-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;late&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cf0a66f5b150ce67bc6a9675b0b56b99>2.2.14 - HTTP Response Headers</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can modify the headers of a response before responding it to the downstream service. To learn
more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPHeaderFilter><code>ResponseHeaderModifier</code> filter</a> instructs Gateways to modify the headers in responses that match the
rule before responding to the downstream. Note that the <code>ResponseHeaderModifier</code> filter will only modify headers before
the response is returned from Envoy to the downstream client and will not affect request headers forwarding to the
upstream service.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=adding-response-headers>Adding Response Headers<a class=td-heading-self-link href=#adding-response-headers aria-label="Heading self-link"></a></h2><p>The <code>ResponseHeaderModifier</code> filter can add new headers to a response before it is sent to the upstream. If the response
does not have the header configured by the filter, then that header will be added to the response. If the response
already has the header configured by the filter, then the value of the header in the filter will be appended to the
value of the header in the response.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResponseHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>responseHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;add-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the downstream client received the header <code>add-header</code> with the value: <code>foo</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: X-Foo: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: X-Foo: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-foo: value1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; add-header: foo
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;X-Foo: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=setting-response-headers>Setting Response Headers<a class=td-heading-self-link href=#setting-response-headers aria-label="Heading self-link"></a></h2><p>Setting headers is similar to adding headers. If the response does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/http-response-headers/#adding-response-headers>adding response headers</a> which will append the value of the header
if the response already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResponseHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>responseHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;set-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the downstream client received the header <code>set-header</code> with the original value <code>value1</code>
replaced by <code>foo</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: set-header: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: set-header: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; set-header: foo
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;set-header&#34;: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=removing-response-headers>Removing Response Headers<a class=td-heading-self-link href=#removing-response-headers aria-label="Heading self-link"></a></h2><p>Headers can be removed from a response by simply supplying a list of header names.</p><p>Setting headers is similar to adding headers. If the response does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/http-response-headers/#adding-response-headers>adding response headers</a> which will append the value of the header
if the response already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;remove-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResponseHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>responseHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>remove</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;remove-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the header <code>remove-header</code> that was sent by curl was removed before the upstream
received the response.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: remove-header: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: remove-header: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;remove-header&#34;: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=combining-filters>Combining Filters<a class=td-heading-self-link href=#combining-filters aria-label="Heading self-link"></a></h2><p>Headers can be added/set/removed in a single filter on the same HTTPRoute and they will all perform as expected</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;bar&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>headers.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResponseHeaderModifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>responseHeaderModifier</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>add</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;add-header-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;set-header-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>remove</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;removed-header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f74c03f1a6d807e593a63a913f34709d>2.2.15 - HTTP Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows users to configure HTTP routing by matching HTTP traffic and forwarding it to
Kubernetes backends. Currently, the only supported backend supported by Envoy Gateway is a Service resource. This task
shows how to route traffic based on host, header, and path fields and forward the traffic to different Kubernetes
Services. To learn more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install the HTTP routing example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/http-routing.yaml
</span></span></code></pre></div><p>The manifest installs a <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, four Deployments, four Services, and three HTTPRoute resources.
The GatewayClass is a cluster-scoped resource that represents a class of Gateways that can be instantiated.</p><p><strong>Note:</strong> Envoy Gateway is configured by default to manage a GatewayClass with
<code>controllerName: gateway.envoyproxy.io/gatewayclass-controller</code>.</p><h2 id=verification>Verification<a class=td-heading-self-link href=#verification aria-label="Heading self-link"></a></h2><p>Check the status of the GatewayClass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gc --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Accepted=True&rdquo;, indicating Envoy Gateway is managing the GatewayClass.</p><p>A Gateway represents configuration of infrastructure. When a Gateway is created, <a href=https://www.envoyproxy.io/>Envoy proxy</a> infrastructure is
provisioned or configured by Envoy Gateway. The <code>gatewayClassName</code> defines the name of a GatewayClass used by this
Gateway. Check the status of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Ready=True&rdquo;, indicating the Envoy proxy infrastructure has been provisioned. The status also
provides the address of the Gateway. This address is used later to test connectivity to proxied backend
services.</p><p>The three HTTPRoute resources create routing rules on the Gateway. In order to receive traffic from a Gateway,
an HTTPRoute must be configured with <code>parentRefs</code> which reference the parent Gateway(s) that it should be attached to.
An HTTPRoute can match against a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteSpec>single set of hostnames</a>. These hostnames are matched before any other matching
within the HTTPRoute takes place. Since <code>example.com</code>, <code>foo.example.com</code>, and <code>bar.example.com</code> are separate hosts with
different routing requirements, each is deployed as its own HTTPRoute - <code>example-route, ``foo-route</code>, and <code>bar-route</code>.</p><p>Check the status of the HTTPRoutes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing -o yaml
</span></span></code></pre></div><p>The status for each HTTPRoute should surface &ldquo;Accepted=True&rdquo; and a <code>parentRef</code> that references the example Gateway.
The <code>example-route</code> matches any traffic for &ldquo;example.com&rdquo; and forwards it to the &ldquo;example-svc&rdquo; Service.</p><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><p>Before testing HTTP routing to the <code>example-svc</code> backend, get the Gateway&rsquo;s address.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Test HTTP routing to the <code>example-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "example-backend-*"</code> indicating the traffic
was routed to the example backend service. If you change the hostname to a hostname not represented in any of the
HTTPRoutes, e.g. &ldquo;<a href=https://www.example.com>www.example.com</a>&rdquo;, the HTTP traffic will not be routed and a <code>404</code> should be returned.</p><p>The <code>foo-route</code> matches any traffic for <code>foo.example.com</code> and applies its routing rules to forward the traffic to the
&ldquo;foo-svc&rdquo; Service. Since there is only one path prefix match for <code>/login</code>, only <code>foo.example.com/login/*</code> traffic will
be forwarded. Test HTTP routing to the <code>foo-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/login&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "foo-backend-*"</code> indicating the traffic
was routed to the foo backend service. Traffic to any other paths that do not begin with <code>/login</code> will not be matched by
this HTTPRoute. Test this by removing <code>/login</code> from the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>The HTTP traffic will not be routed and a <code>404</code> should be returned.</p><p>Similarly, the <code>bar-route</code> HTTPRoute matches traffic for <code>bar.example.com</code>. All traffic for this hostname will be
evaluated against the routing rules. The most specific match will take precedence which means that any traffic with the
<code>env:canary</code> header will be forwarded to <code>bar-svc-canary</code> and if the header is missing or not <code>canary</code> then it&rsquo;ll be
forwarded to <code>bar-svc</code>. Test HTTP routing to the <code>bar-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "bar-backend-*"</code> indicating the traffic
was routed to the foo backend service.</p><p>Test HTTP routing to the <code>bar-canary-svc</code> backend by adding the <code>env: canary</code> header to the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> --header <span style=color:#4e9a06>&#34;env: canary&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "bar-canary-backend-*"</code> indicating the
traffic was routed to the foo backend service.</p><h3 id=jwt-claims-based-routing>JWT Claims Based Routing<a class=td-heading-self-link href=#jwt-claims-based-routing aria-label="Heading self-link"></a></h3><p>Users can route to a specific backend by matching on JWT claims.
This can be achieved, by defining a SecurityPolicy with a jwt configuration that does the following</p><ul><li>Converts jwt claims to headers, which can be used for header based routing</li><li>Sets the recomputeRoute field to <code>true</code>. This is required so that the incoming request matches on a fallback/catch all route where the JWT can be authenticated, the claims from the JWT can be converted to headers, and then the route match can be recomputed to match based on the updated headers.</li></ul><p>For this feature to work please make sure</p><ul><li>you have a fallback route rule defined, the backend for this route rule can be invalid.</li><li>The SecurityPolicy is applied to both the fallback route as well as the route with the claim header matches, to avoid spoofing.</li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: jwt-claim-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jwt:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    providers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        recomputeRoute: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        claimToHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - claim: sub
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            header: x-sub
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - claim: admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            header: x-admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - claim: name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            header: x-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remoteJWKS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          uri: https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/jwks.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-claim-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: foo-svc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: x-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: John Doe
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: bar-svc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: x-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: Tom
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # catch all
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: infra-backend-invalid
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jwt-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jwt-claim-routing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwt</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>recomputeRoute</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>claimToHeaders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>claim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sub</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-sub</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>claim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>claim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>remoteJWKS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jwt-claim-routing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo-svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>John Doe</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar-svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Tom</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># catch all</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>infra-backend-invalid</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><p>Test routing to the <code>foo-svc</code> backend by specifying a JWT Token with a claim <code>name: John Doe</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -H <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/login&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .pod
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;foo-backend-6df8cc6b9f-fmwcg&#34;</span>
</span></span></code></pre></div><p>Get another JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/with-different-claim.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><p>Test HTTP routing to the <code>bar-svc</code> backend by specifying a JWT Token with a claim <code>name: Tom</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -H <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .pod
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;bar-backend-6688b8944c-s8htr&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1242a239aa86bf16ce6c3e1b1d9a5187>2.2.16 - HTTP Timeouts</h1><p>The default request timeout is set to 15 seconds in Envoy Proxy.
The <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteTimeouts>HTTPRouteTimeouts</a> resource allows users to configure request timeouts for an <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteRule>HTTPRouteRule</a>.
This task shows you how to configure timeouts.</p><p>The <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteTimeouts>HTTPRouteTimeouts</a> supports two kinds of timeouts:</p><ul><li><strong>request</strong>: Request specifies the maximum duration for a gateway to respond to an HTTP request.</li><li><strong>backendRequest</strong>: BackendRequest specifies a timeout for an individual request from the gateway to a backend.</li></ul><p><strong>Note:</strong> The Request duration must be >= BackendRequest duration</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=verification>Verification<a class=td-heading-self-link href=#verification aria-label="Heading self-link"></a></h2><p>backend has the ability to delay responses; we use it as the backend to control response time.</p><h3 id=request-timeout>request timeout<a class=td-heading-self-link href=#request-timeout aria-label="Heading self-link"></a></h3><p>We configure the backend to delay responses by 3 seconds, then we set the request timeout to 4 seconds. Envoy Gateway will successfully respond to the request.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - timeout.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    timeouts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      request: &#34;4s&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>timeout.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>timeouts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>request</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: timeout.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>3s  -I
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 04 Mar 2024 02:34:21 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 480
</span></span></span></code></pre></div><p>Then we set the request timeout to 2 seconds. In this case, Envoy Gateway will respond with a timeout.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - timeout.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    timeouts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      request: &#34;2s&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>timeout.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>timeouts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>request</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: timeout.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>3s  -v
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 127.0.0.1 (127.0.0.1) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /?delay<span style=color:#ce5c00;font-weight:700>=</span>3s HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: timeout.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.6.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>504</span> Gateway Timeout
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 24
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: text/plain
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Mon, 04 Mar 2024 02:35:03 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 127.0.0.1 left intact
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>upstream request timeout
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0edfa2f57a0c2672fc81040c096c5449>2.2.17 - HTTP URL Rewrite</h1><p><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPURLRewriteFilter>HTTPURLRewriteFilter</a> defines a filter that modifies a request during forwarding. At most one of these filters may be
used on a Route rule. This MUST NOT be used on the same Route rule as a HTTPRequestRedirect filter.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=rewrite-url-prefix-path>Rewrite URL Prefix Path<a class=td-heading-self-link href=#rewrite-url-prefix-path aria-label="Heading self-link"></a></h2><p>You can configure to rewrite the prefix in the url like below. In this example, any curls to
<code>http://${GATEWAY_HOST}/get/xxx</code> will be rewritten to <code>http://${GATEWAY_HOST}/replace/xxx</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplacePrefixMatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replacePrefixMatch: /replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-url-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>path.rewrite.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/get&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>URLRewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>urlRewrite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplacePrefixMatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>replacePrefixMatch</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/replace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get/origin/path</code> should rewrite to
<code>http://${GATEWAY_HOST}/replace/origin/path</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get/origin/path&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get/origin/path HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:03:28 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 503
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/replace/origin/path&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Original-Path&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;/get/origin/path&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;fd84b842-9937-4fb5-83c7-61470d854b90&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Envoy-Original-Path</code> is <code>/get/origin/path</code>, but the actual path is <code>/replace/origin/path</code>.</p><h2 id=rewrite-url-full-path>Rewrite URL Full Path<a class=td-heading-self-link href=#rewrite-url-full-path aria-label="Heading self-link"></a></h2><p>You can configure to rewrite the fullpath in the url like below. In this example, any request sent to
<code>http://${GATEWAY_HOST}/get/origin/path/xxxx</code> will be rewritten to
<code>http://${GATEWAY_HOST}/force/replace/fullpath</code>.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get/origin/path&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplaceFullPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replaceFullPath: /force/replace/fullpath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-url-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>path.rewrite.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/get/origin/path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>URLRewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>urlRewrite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplaceFullPath</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>replaceFullPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/force/replace/fullpath</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get/origin/path/extra</code> should rewrite the request to
<code>http://${GATEWAY_HOST}/force/replace/fullpath</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get/origin/path/extra&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get/origin/path/extra HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:09:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/force/replace/fullpath&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Original-Path&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;/get/origin/path/extra&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;8ab774d6-9ffa-4faa-abbb-f45b0db00895&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Envoy-Original-Path</code> is <code>/get/origin/path/extra</code>, but the actual path is
<code>/force/replace/fullpath</code>.</p><h2 id=rewrite-url-path-with-regex>Rewrite URL Path with Regex<a class=td-heading-self-link href=#rewrite-url-path-with-regex aria-label="Heading self-link"></a></h2><p>In addition to core Gateway-API rewrite options, Envoy Gateway supports extended rewrite options through the <a href=../../../api/extension_types#httproutefilter>HTTPRouteFilter</a> API.
The <code>HTTPRouteFilter</code> API can be configured to use <a href=https://github.com/google/re2/wiki/Syntax>RE2</a>-compatible regex matchers and substitutions to rewrite a portion of the url.
In the example below, requests sent to <code>http://${GATEWAY_HOST}/service/xxx/yyy</code> (where <code>xxx</code> is a single path portion and <code>yyy</code> is one or more path portions)
are rewritten to <code>http://${GATEWAY_HOST}/yyy/instance/xxx</code>. The entire path is matched and rewritten using capture groups.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-regex-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.regex.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: regex-path-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: regex-path-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: ReplaceRegexMatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      replaceRegexMatch:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        pattern: &#39;^/service/([^/]+)(/.*)$&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        substitution: &#39;\2/instance/\1&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-url-regex-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>path.regex.rewrite.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>regex-path-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>regex-path-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urlRewrite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplaceRegexMatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>replaceRegexMatch</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pattern</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;^/service/([^/]+)(/.*)$&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>substitution</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;\2/instance/\1&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-regex-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/service/foo/v1/api</code> should rewrite the request to
<code>http://${GATEWAY_HOST}/service/foo/v1/api</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.regex.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/service/foo/v1/api&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /service/foo/v1/api HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.regex.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.7.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Request completely sent off
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Mon, 16 Sep 2024 18:49:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 482
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/v1/api/instance/foo&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.regex.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/8.7.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Internal&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;true&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-For&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;10.244.0.37&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;24a5958f-1bfa-4694-a9c1-807d5139a18a&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-765694d47f-lzmpm&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the path is rewritten from <code>/service/foo/v1/api</code>, to <code>/v1/api/instance/foo</code>.</p><h2 id=rewrite-host-name>Rewrite Host Name<a class=td-heading-self-link href=#rewrite-host-name aria-label="Heading self-link"></a></h2><p>You can configure to rewrite the hostname like below. In this example, any requests sent to
<code>http://${GATEWAY_HOST}/get</code> with <code>--header "Host: path.rewrite.example"</code> will rewrite host into <code>envoygateway.io</code>.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: &#34;envoygateway.io&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-url-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>path.rewrite.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/get&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>URLRewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>urlRewrite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;envoygateway.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get</code> with <code>--header "Host: path.rewrite.example"</code> will rewrite host into
<code>envoygateway.io</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:15:15 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 481
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/get&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;envoygateway.io&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Host&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;path.rewrite.example&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;39aa447c-97b9-45a3-a675-9fb266ab1af0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Forwarded-Host</code> is <code>path.rewrite.example</code>, but the actual host is <code>envoygateway.io</code>.</p><h2 id=rewrite-url-host-name-by-header-or-backend>Rewrite URL Host Name by Header or Backend<a class=td-heading-self-link href=#rewrite-url-host-name-by-header-or-backend aria-label="Heading self-link"></a></h2><p>In addition to core Gateway-API rewrite options, Envoy Gateway supports extended rewrite options through the <a href=../../../api/extension_types#httproutefilter>HTTPRouteFilter</a> API.
The <code>HTTPRouteFilter</code> API can be configured to rewrite the Host header value to:</p><ul><li>The value of a different request header</li><li>The DNS name of the backend that the request is routed to</li></ul><p>In the following example, the host header is rewritten to the value of the x-custom-host header.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-hostname-header-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - host.header.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: header-host-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: header-host-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    hostname:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Header
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      header: x-custom-host      
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-hostname-header-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>host.header.rewrite.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/header&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>header-host-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRouteFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>header-host-rewrite</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urlRewrite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-custom-host   </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-header-host-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/header</code> and providing a custom host rewrite header x-custom-host should rewrite the
request host header to the value of the x-custom-host header.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: host.header.rewrite.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-custom-host: foo&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/header&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /header HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: host.header.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.7.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> x-custom-host: foo
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Request completely sent off
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/header&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;foo&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Custom-Host&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Host&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;host.header.rewrite.example&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-765694d47f-5t6f2&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the host is rewritten from <code>host.header.rewrite.example</code>, to the value of the provided
<code>x-custom-host</code> header <code>foo</code>. The original host header is preserved in the <code>X-Forwarded-Host</code> header.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-dd13d985d642d706310a14491029fff0>2.2.18 - HTTP3</h1><p>This task will help you get started using HTTP3 using EG.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the Gateway from the Quickstart to include an HTTPS listener that listens on port <code>443</code> and references the
<code>example-cert</code> Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Apply the following ClientTrafficPolicy to enable HTTP3</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-http3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  http3: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-http3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>http3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-02-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-02-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><p>The below example uses a custom docker image with custom <code>curl</code> binary with built-in http3.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --net<span style=color:#ce5c00;font-weight:700>=</span>host --rm ghcr.io/macbre/curl-http3 curl -kv --http3 -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> https://www.example.com/get
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>It is not possible at the moment to port-forward UDP protocol in kubernetes service
check out <a href=https://github.com/kubernetes/kubernetes/issues/47862>https://github.com/kubernetes/kubernetes/issues/47862</a>.
Hence we need external loadbalancer to test this feature out.</p></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8bf3bd499d7c9c2d7fdf61033b16a26c>2.2.19 - HTTPRoute Request Mirroring</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows one or more <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>backendRefs</a> to be provided. Requests will be routed to these upstreams. It is possible to divide the traffic between these backends using <a href=../http-traffic-splitting/>Traffic Splitting</a>, but it is also possible to mirror requests to another Service instead. Request mirroring is accomplished using Gateway API&rsquo;s <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRequestMirrorFilter>HTTPRequestMirrorFilter</a> on the <code>HTTPRoute</code>.</p><p>When requests are made to a <code>HTTPRoute</code> that uses a <code>HTTPRequestMirrorFilter</code>, the response will never come from the <code>backendRef</code> defined in the filter. Responses from the mirror <code>backendRef</code> are always ignored.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=mirroring-the-traffic>Mirroring the Traffic<a class=td-heading-self-link href=#mirroring-the-traffic aria-label="Heading self-link"></a></h2><p>Next, create a new <code>Deployment</code> and <code>Service</code> to mirror requests to. The following example will use
a second instance of the application deployed in the quickstart.</p><p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div>Then create an <code>HTTPRoute</code> that uses a <code>HTTPRequestMirrorFilter</code> to send requests to the original
service from the quickstart, and mirror request to the service that was just deployed.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-mirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestMirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestMirror</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backendRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-mirror -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-79665566f5-s589f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Check the logs of the pods and you will see that the original deployment and the new deployment each got a request:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl logs deploy/backend <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> kubectl logs deploy/backend-2
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Starting server, listening on port <span style=color:#0000cf;font-weight:700>3000</span> <span style=color:#ce5c00;font-weight:700>(</span>http<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Echoing back request made to /get to client <span style=color:#ce5c00;font-weight:700>(</span>10.42.0.10:41566<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Starting server, listening on port <span style=color:#0000cf;font-weight:700>3000</span> <span style=color:#ce5c00;font-weight:700>(</span>http<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Echoing back request made to /get to client <span style=color:#ce5c00;font-weight:700>(</span>10.42.0.10:45096<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=multiple-backendrefs>Multiple BackendRefs<a class=td-heading-self-link href=#multiple-backendrefs aria-label="Heading self-link"></a></h2><p>When an <code>HTTPRoute</code> has multiple <code>backendRefs</code> and an <code>HTTPRequestMirrorFilter</code>, traffic splitting will still behave the same as it normally would for the main <code>backendRefs</code> while the <code>backendRef</code> of the <code>HTTPRequestMirrorFilter</code> will continue receiving mirrored copies of the incoming requests.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-mirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestMirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestMirror</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backendRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=multiple-httprequestmirrorfilters>Multiple HTTPRequestMirrorFilters<a class=td-heading-self-link href=#multiple-httprequestmirrorfilters aria-label="Heading self-link"></a></h2><p>Multiple <code>HTTPRequestMirrorFilters</code> are not supported on the same <code>HTTPRoute</code> <code>rule</code>. When attempting to do so, the admission webhook will reject the configuration.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-mirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestMirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestMirror</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backendRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestMirror</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requestMirror</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backendRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Error from server: error when creating &#34;STDIN&#34;: admission webhook &#34;validate.gateway.networking.k8s.io&#34; denied the request: spec.rules[0].filters: Invalid value: &#34;RequestMirror&#34;: cannot be used multiple times in the same rule
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7baf3976b4af135a1f53f12ff744ac7a>2.2.20 - HTTPRoute Traffic Splitting</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows one or more <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>backendRefs</a> to be provided. Requests will be routed to these upstreams
if they match the rules of the HTTPRoute. If an invalid backendRef is configured, then HTTP responses will be returned
with status code <code>500</code> for all requests that would have been sent to that backend.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=single-backendref>Single backendRef<a class=td-heading-self-link href=#single-backendref aria-label="Heading self-link"></a></h2><p>When a single backendRef is configured in a HTTPRoute, it will receive 100% of the traffic.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-79665566f5-s589f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=multiple-backendrefs>Multiple backendRefs<a class=td-heading-self-link href=#multiple-backendrefs aria-label="Heading self-link"></a></h2><p>If multiple backendRefs are configured, then traffic will be split between the backendRefs equally unless a weight is
configured.</p><p>First, create a second instance of the example app from the quickstart:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Then create an HTTPRoute that uses both the app from the quickstart and the second instance that was just created</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>backends.example/get</code> should result in <code>200</code> responses from the example Gateway and the output from the
example app that indicates which pod handled the request should switch between the first pod and the second one from the
new deployment on subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-75bcd4c969-lsxpz&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=weighted-backendrefs>Weighted backendRefs<a class=td-heading-self-link href=#weighted-backendrefs aria-label="Heading self-link"></a></h2><p>If multiple backendRefs are configured and an un-even traffic split between the backends is desired, then the <code>weight</code>
field can be used to control the weight of requests to each backend. If weight is not configured for a backendRef it is
assumed to be <code>1</code>.</p><p>The <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>weight field in a backendRef</a> controls the distribution of the traffic split. The proportion of
requests to a single backendRef is calculated by dividing its <code>weight</code> by the sum of all backendRef weights in the
HTTPRoute. The weight is not a percentage and the sum of all weights does not need to add up to 100.</p><p>The HTTPRoute below will configure the gateway to send 80% of the traffic to the backend service, and 20% to the
backend-2 service.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 8
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=invalid-backendrefs>Invalid backendRefs<a class=td-heading-self-link href=#invalid-backendrefs aria-label="Heading self-link"></a></h2><p>backendRefs can be considered invalid for the following reasons:</p><ul><li>The <code>group</code> field is configured to something other than <code>""</code>. Currently, only the core API group (specified by
omitting the group field or setting it to an empty string) is supported</li><li>The <code>kind</code> field is configured to anything other than <code>Service</code>. Envoy Gateway currently only supports Kubernetes
Service backendRefs</li><li>The backendRef configures a service with a <code>namespace</code> not permitted by any existing ReferenceGrants</li><li>The <code>port</code> field is not configured or is configured to a port that does not exist on the Service</li><li>The named Service configured by the backendRef cannot be found</li></ul><p>Modifying the above example to make the backend-2 backendRef invalid by using a port that does not exist on the Service
will result in 80% of the traffic being sent to the backend service, and 20% of the traffic receiving an HTTP response
with status code <code>500</code>.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 8
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-headers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>backends.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Querying <code>backends.example/get</code> should result in <code>200</code> responses 80% of the time, and <code>500</code> responses 20% of the time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 500 Internal Server Error
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8af6c76d88394977053b8683bc9f6339>2.2.21 - Load Balancing</h1><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overview>Envoy load balancing</a> is a way of distributing traffic between multiple hosts within a single upstream cluster
in order to effectively make use of available resources.</p><p>Envoy Gateway supports the following load balancing policies:</p><ul><li><strong>Round Robin</strong>: a simple policy in which each available upstream host is selected in round robin order.</li><li><strong>Random</strong>: load balancer selects a random available host.</li><li><strong>Least Request</strong>: load balancer uses different algorithms depending on whether hosts have the same or different weights.</li><li><strong>Consistent Hash</strong>: load balancer implements consistent hashing to upstream hosts.</li></ul><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired load balancing polices.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource. If <code>loadBalancer</code> is not specified in <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a>, the default load balancing policy is <code>Least Request</code>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>For better testing the load balancer, you can add more hosts in upstream cluster by increasing the replicas of one deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment backend -n default -p <span style=color:#4e9a06>&#39;{&#34;spec&#34;: {&#34;replicas&#34;: 4}}&#39;</span>
</span></span></code></pre></div><h3 id=install-the-hey-load-testing-tool>Install the hey load testing tool<a class=td-heading-self-link href=#install-the-hey-load-testing-tool aria-label="Heading self-link"></a></h3><p>Install the <code>Hey</code> CLI tool, this tool will be used to generate load and measure response times.</p><p>Follow the installation instruction from the <a href=https://github.com/rakyll/hey>Hey project</a> docs.</p><h2 id=round-robin>Round Robin<a class=td-heading-self-link href=#round-robin aria-label="Heading self-link"></a></h2><p>This example will create a Load Balancer with Round Robin policy via <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: round-robin-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: round-robin-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: RoundRobin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: round-robin-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /round
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>round-robin-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>round-robin-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>loadBalancer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RoundRobin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>round-robin-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/round</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The <code>hey</code> tool will be used to generate 100 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/round
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	0.0487 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0440 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0181 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0307 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	2053.1676
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	50500 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	505 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.018 [1]	    |■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.021 [2]  	|■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.023 [10]	|■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.026 [16]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.028 [7]  	|■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.031 [10]	|■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.034 [17]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.036 [18]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.039 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.041 [6] 	|■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.044 [2]	    |■■■■
</span></span></span></code></pre></div><p>As a result, you can see all available upstream hosts receive traffics evenly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>backend --no-headers -o custom-columns<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:metadata.name&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#204a87>read</span> -r pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$pod</span><span style=color:#4e9a06>: received </span><span style=color:#204a87;font-weight:700>$(($(</span>kubectl logs <span style=color:#000>$pod</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>))</span><span style=color:#4e9a06> requests&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-2gfp7: received 26 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-69g8c: received 25 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-bqwpr: received 24 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-kbn8l: received 25 requests
</span></span></span></code></pre></div><p>You should note that this results may vary, the output here is for reference purpose only.</p><h2 id=random>Random<a class=td-heading-self-link href=#random aria-label="Heading self-link"></a></h2><p>This example will create a Load Balancer with Random policy via <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a>.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: random-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: random-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Random
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: random-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /random
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>random-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>random-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>loadBalancer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Random</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>random-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/random</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The <code>hey</code> tool will be used to generate 1000 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>1000</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/random
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	0.2624 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0851 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0007 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0179 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	3811.3020
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	506000 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	506 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.001 [1] 	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.009 [421]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.018 [219]	|■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.026 [118]	|■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.034 [64]	|■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.043 [73]	|■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.051 [41]	|■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.060 [22]	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.068 [19]	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.077 [13]	|■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.085 [9] 	|■
</span></span></span></code></pre></div><p>As a result, you can see all available upstream hosts receive traffics randomly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>backend --no-headers -o custom-columns<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:metadata.name&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#204a87>read</span> -r pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$pod</span><span style=color:#4e9a06>: received </span><span style=color:#204a87;font-weight:700>$(($(</span>kubectl logs <span style=color:#000>$pod</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>))</span><span style=color:#4e9a06> requests&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-bf6lm: received 246 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-gwmqk: received 256 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-mzngr: received 230 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-xghqq: received 268 requests
</span></span></span></code></pre></div><p>You should note that this results may vary, the output here is for reference purpose only.</p><h2 id=least-request>Least Request<a class=td-heading-self-link href=#least-request aria-label="Heading self-link"></a></h2><p>This example will create a Load Balancer with Least Request policy via <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a>.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: least-request-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: least-request-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: LeastRequest
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: least-request-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /least
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>least-request-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>least-request-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>loadBalancer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LeastRequest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>least-request-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/least</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The <code>hey</code> tool will be used to generate 100 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/least
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	0.0489 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0479 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0054 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0297 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	2045.9317
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	50500 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	505 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.005 [1] 	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.010 [1] 	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.014 [8] 	|■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.018 [6] 	|■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.022 [11]	|■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.027 [7] 	|■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.031 [15]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.035 [13]	|■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.039 [22]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.044 [12]	|■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.048 [4] 	|■■■■■■■
</span></span></span></code></pre></div><p>As a result, you can see all available upstream hosts receive traffics randomly,
and host <code>backend-69fcff487f-6l2pw</code> receives fewer requests than others.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>backend --no-headers -o custom-columns<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:metadata.name&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#204a87>read</span> -r pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$pod</span><span style=color:#4e9a06>: received </span><span style=color:#204a87;font-weight:700>$(($(</span>kubectl logs <span style=color:#000>$pod</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>))</span><span style=color:#4e9a06> requests&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-59hvs: received 24 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-6l2pw: received 19 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-ktsx4: received 30 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-nqxc7: received 27 requests
</span></span></span></code></pre></div><p>If you send one more requests to the <code>${GATEWAY_HOST}/least</code>, you can tell that host <code>backend-69fcff487f-6l2pw</code> is very likely
to get the attention of load balancer and receive this request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-59hvs: received 24 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-6l2pw: received 20 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-ktsx4: received 30 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-nqxc7: received 27 requests
</span></span></span></code></pre></div><p>You should note that this results may vary, the output here is for reference purpose only.</p><h2 id=consistent-hash>Consistent Hash<a class=td-heading-self-link href=#consistent-hash aria-label="Heading self-link"></a></h2><p>This example will create a Load Balancer with Consistent Hash policy via <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a>.</p><p>The underlying consistent hash algorithm that Envoy Gateway utilise is <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#maglev>Maglev</a>, and it can derive hash from following aspects:</p><ul><li><strong>SourceIP</strong></li><li><strong>Header</strong></li><li><strong>Cookie</strong></li></ul><p>They are also the supported value as consistent hash type.</p><h3 id=source-ip>Source IP<a class=td-heading-self-link href=#source-ip aria-label="Heading self-link"></a></h3><p>This example will create a Load Balancer with Source IP based Consistent Hash policy.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: source-ip-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: source-ip-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: ConsistentHash
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    consistentHash:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: SourceIP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: source-ip-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /source
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source-ip-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source-ip-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>loadBalancer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConsistentHash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>consistentHash</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SourceIP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>source-ip-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/source</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The <code>hey</code> tool will be used to generate 100 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/source
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	0.0539 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0500 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0198 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0340 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	1856.5666
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	50600 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	506 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.020 [1] 	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.023 [5] 	|■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.026 [12]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.029 [16]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.032 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.035 [7] 	|■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.038 [8] 	|■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.041 [18]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.044 [15]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.047 [4] 	|■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.050 [3] 	|■■■■■■■
</span></span></span></code></pre></div><p>As a result, you can see all traffics are routed to only one upstream host, since the client that send requests
has the same source IP.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>backend --no-headers -o custom-columns<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:metadata.name&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#204a87>read</span> -r pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$pod</span><span style=color:#4e9a06>: received </span><span style=color:#204a87;font-weight:700>$(($(</span>kubectl logs <span style=color:#000>$pod</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>))</span><span style=color:#4e9a06> requests&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-grzkj: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-n4d8w: received 100 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-tb7zx: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-wbzpg: received 0 requests
</span></span></span></code></pre></div><p>You can try different client to send out these requests, the upstream host that receives traffics may vary.</p><h3 id=header>Header<a class=td-heading-self-link href=#header aria-label="Heading self-link"></a></h3><p>This example will create a Load Balancer with Header based Consistent Hash policy.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: header-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: header-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: ConsistentHash
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    consistentHash:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Header
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      header:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: FooBar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: header-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /header
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>header-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>header-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>loadBalancer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConsistentHash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>consistentHash</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FooBar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>header-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The <code>hey</code> tool will be used to generate 100 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;FooBar: 1.2.3.4&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/header
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	0.0579 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	0.0510 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0323 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	0.0431 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	1728.6064
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	53800 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	538 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.032 [1] 	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.034 [3] 	|■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.036 [1] 	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.038 [1] 	|■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.040 [7] 	|■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.042 [20]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.044 [20]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.045 [20]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.047 [16]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.049 [9] 	|■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.051 [2] 	|■■■■
</span></span></span></code></pre></div><p>As a result, you can see all traffics are routed to only one upstream host, since the header of all requests are the same.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>backend --no-headers -o custom-columns<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:metadata.name&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#204a87>read</span> -r pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$pod</span><span style=color:#4e9a06>: received </span><span style=color:#204a87;font-weight:700>$(($(</span>kubectl logs <span style=color:#000>$pod</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>))</span><span style=color:#4e9a06> requests&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-dvt9r: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-f8qdl: received 100 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-gnpm4: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-t2pgm: received 0 requests
</span></span></span></code></pre></div><p>You can try to add different header to these requests, and the upstream host that receives traffics may vary.
The following output happens when you use <code>hey</code> to send another 100 requests with header <code>FooBar: 5.6.7.8</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-dvt9r: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-f8qdl: received 100 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-gnpm4: received 100 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-t2pgm: received 0 requests
</span></span></span></code></pre></div><h3 id=cookie>Cookie<a class=td-heading-self-link href=#cookie aria-label="Heading self-link"></a></h3><p>This example will create a Load Balancer with Cookie based Consistent Hash policy.</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-06-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-06-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: cookie-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: cookie-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: ConsistentHash
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    consistentHash:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Cookie
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      cookie:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: FooBar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        ttl: 60s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        attributes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          SameSite: Strict
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: cookie-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /cookie
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cookie-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cookie-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>loadBalancer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConsistentHash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>consistentHash</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cookie</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>cookie</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FooBar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>60s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>attributes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>SameSite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Strict</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cookie-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/cookie</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>By sending 10 request with <code>curl</code> to the <code>${GATEWAY_HOST}/cookie</code>, you can see that all requests got routed to only
one upstream host, since they have same cookie setting.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..10<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> --cookie <span style=color:#4e9a06>&#34;FooBar=1.2.3.4&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/cookie <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>backend --no-headers -o custom-columns<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:metadata.name&#34;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#204a87>read</span> -r pod<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$pod</span><span style=color:#4e9a06>: received </span><span style=color:#204a87;font-weight:700>$(($(</span>kubectl logs <span style=color:#000>$pod</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>))</span><span style=color:#4e9a06> requests&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-5dxz9: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-gpvl2: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-pglgv: received 10 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-qxr74: received 0 requests
</span></span></span></code></pre></div><p>You can try to set different cookie to these requests, the upstream host that receives traffics may vary.
The following output happens when you use <code>curl</code> to send another 10 requests with cookie <code>FooBar: 5.6.7.8</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-dvt9r: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-f8qdl: received 0 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-gnpm4: received 10 requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>backend-69fcff487f-t2pgm: received 10 requests
</span></span></span></code></pre></div><p>If the cookie has not been set in one request, Envoy Gateway will auto-generate a cookie for this request
according to the <code>ttl</code> and <code>attributes</code> field.</p><p>In this example, the following cookie will be generated (see <code>set-cookie</code> header in response) if sending a request without cookie:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/cookie
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>&gt;</span> GET /cookie HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.74.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Fri, 19 Jul 2024 16:49:57 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 458
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; set-cookie: FooBar=&#34;88358b9442700c56&#34;; Max-Age=60; SameSite=Strict; HttpOnly
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/cookie&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;www.example.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.74.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Internal&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;true&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-For&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;10.244.0.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;1adeaaf7-d45c-48c8-9a4d-eadbccb2fd50&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-69fcff487f-5dxz9&#34;
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ef7eee201b6632a2e9d9fe9f40d5a924>2.2.22 - Local Rate Limit</h1><p>Rate limit is a feature that allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p><p>Here are some reasons why you may want to implement Rate limits</p><ul><li>To prevent malicious activity such as DDoS attacks.</li><li>To prevent applications and its resources (such as a database) from getting overloaded.</li><li>To create API limits based on user entitlements.</li></ul><p>Envoy Gateway supports two types of rate limiting: <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> and <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting>Local rate limiting</a>.</p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting>Local rate limiting</a> applies rate limits to the traffic flowing through a single instance of Envoy proxy. This means
that if the data plane has 2 replicas of Envoy running, and the rate limit is 10 requests/second, each replica will allow
10 requests/second. This is in contrast to <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global Rate Limiting</a> which applies rate limits to the traffic flowing through
all instances of Envoy proxy.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their rate limit intent.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note:</strong> Limit is applied per route. Even if a <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> targets a gateway, each route in that gateway
still has a separate rate limit bucket. For example, if a gateway has 2 routes, and the limit is 100r/s, then each route
has its own 100r/s rate limit bucket.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=rate-limit-specific-user>Rate Limit Specific User<a class=td-heading-self-link href=#rate-limit-specific-user aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code>x-user-id</code> header
with a value set to <code>one</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    local:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: one
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>one</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-ratelimit -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Let&rsquo;s query <code>ratelimit.example/get</code> 4 times. We should receive a <code>200</code> response from the example Gateway for the first 3 requests
and then receive a <code>429</code> status code for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code>x-user-id</code>
and value <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should be able to send requests with the <code>x-user-id</code> header and a different value and receive successful responses from the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:38 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:39 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h2 id=rate-limit-specific-user-unless-within-test-org>Rate Limit Specific User Unless within Test Org<a class=td-heading-self-link href=#rate-limit-specific-user-unless-within-test-org aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code>x-user-id</code> header
with a value set to <code>one</code>. But the user must not be limited if logging in within Test org, determined by custom header <code>x-org-id</code> set to <code>test</code>.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    local:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: one
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-org-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: test
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            invert: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>one</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-org-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>invert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-ratelimit -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Let&rsquo;s query <code>ratelimit.example/get</code> 4 times with <code>x-user-id</code> set to <code>one</code> and <code>x-org-id</code> set to <code>org1</code>. We should receive a <code>200</code> response from the example Gateway for the first 3 requests and the last request should be rate limited.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> --header <span style=color:#4e9a06>&#34;x-org-id: org1&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>Let&rsquo;s query <code>ratelimit.example/get</code> 4 times with <code>x-user-id</code> set to <code>one</code> and <code>x-org-id</code> set to <code>test</code>. We should receive a <code>200</code> response from the example Gateway for all the 4 requests, unlike previous example where the last request was rate limited.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> --header <span style=color:#4e9a06>&#34;x-org-id: test&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h2 id=rate-limit-all-requests>Rate Limit All Requests<a class=td-heading-self-link href=#rate-limit-all-requests aria-label="Heading self-link"></a></h2><p>This example shows you how to rate limit all requests matching the HTTPRoute rule at 3 requests/Hour by leaving the <code>clientSelectors</code> field unset.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    local:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rateLimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h3 id=httproute-2>HTTPRoute<a class=td-heading-self-link href=#httproute-2 aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-06-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-06-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>ratelimit.example </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p><strong>Note:</strong> Local rate limiting does not support <code>distinct</code> matching. If you want to rate limit based on distinct values,
you should use <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global Rate Limiting</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f8c2d0aa7e0ed0a05b09f208cdc895c5>2.2.23 - Multicluster Service Routing</h1><p>The Multicluster Service API ServiceImport object can be used as part of the GatewayAPI backendRef for configuring routes. For more information about multicluster service API follow <a href=https://multicluster.sigs.k8s.io/concepts/multicluster-services-api/>sig documentation</a>.</p><p>We will use <a href=https://github.com/submariner-io/submariner>Submariner project</a> for setting up the multicluster environment for exporting the service to be routed from peer clusters.</p><h2 id=setting-kind-clusters-and-installing-submariner>Setting KIND clusters and installing Submariner.<a class=td-heading-self-link href=#setting-kind-clusters-and-installing-submariner aria-label="Heading self-link"></a></h2><ul><li>We will be using KIND clusters to demonstrate this example.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/submariner-io/submariner-operator
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> submariner-operator
</span></span><span style=display:flex><span>make clusters
</span></span></code></pre></div><p>Note: remain in submariner-operator directory for the rest of the steps in this section</p><ul><li>Install subctl:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -Ls https://get.submariner.io  <span style=color:#000;font-weight:700>|</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v0.14.6 bash
</span></span></code></pre></div><ul><li>Set up multicluster service API and submariner for cross cluster traffic using ServiceImport</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>subctl deploy-broker --kubeconfig output/kubeconfigs/kind-config-cluster1 --globalnet
</span></span><span style=display:flex><span>subctl join --kubeconfig output/kubeconfigs/kind-config-cluster1 broker-info.subm --clusterid cluster1 --natt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>subctl join --kubeconfig output/kubeconfigs/kind-config-cluster2 broker-info.subm --clusterid cluster2 --natt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><p>Once the above steps are done and all the pods are up in both the clusters. We are ready for installing envoy gateway.</p><h2 id=install-envoygateway>Install EnvoyGateway<a class=td-heading-self-link href=#install-envoygateway aria-label="Heading self-link"></a></h2><p>Install the Gateway API CRDs and Envoy Gateway in cluster1:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system --create-namespace --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><h2 id=install-application>Install Application<a class=td-heading-self-link href=#install-application aria-label="Heading self-link"></a></h2><p>Install the backend application in cluster2 and export it through subctl command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/application.yaml --kubeconfig output/kubeconfigs/kind-config-cluster2
</span></span><span style=display:flex><span>subctl <span style=color:#204a87>export</span> service backend --namespace default --kubeconfig output/kubeconfigs/kind-config-cluster2
</span></span></code></pre></div><h2 id=create-gateway-api-objects>Create Gateway API Objects<a class=td-heading-self-link href=#create-gateway-api-objects aria-label="Heading self-link"></a></h2><p>Create the Gateway API objects GatewayClass, Gateway and HTTPRoute in cluster1 to set up the routing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/multicluster-service.yaml --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:80 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-03c6402a73dc2a6d8823ff917396636c>2.2.24 - Response Override</h1><p>Response Override allows you to override the response from the backend with a custom one. This can be useful for scenarios such as returning a custom 404 page when the requested resource is not found or a custom 500 error message when the backend is failing.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=testing-response-override>Testing Response Override<a class=td-heading-self-link href=#testing-response-override aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: response-override
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  responseOverride:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - match:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        statusCodes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: Value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: 404
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      response:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        contentType: text/plain
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Inline
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          inline: &#34;Oops! Your request is not found.&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - match:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        statusCodes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: Value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: 500
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: Range
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            range:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              start: 501
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              end: 511
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      response:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        contentType: application/json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: ValueRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          valueRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: response-override-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: response-override-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  response.body: &#39;{&#34;error&#34;: &#34;Internal Server Error&#34;}&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>response-override</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>responseOverride</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>statusCodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>404</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>response</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>contentType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>text/plain</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>inline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Oops! Your request is not found.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>statusCodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Range</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>range</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>501</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>end</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>511</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>response</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>contentType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>application/json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ValueRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>valueRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>response-override-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>response-override-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>response.body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{&#34;error&#34;: &#34;Internal Server Error&#34;}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/status/404
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 172.18.0.200 (172.18.0.200) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /status/404 HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.5.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>404</span> Not Found
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: text/plain
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 32
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Thu, 07 Nov 2024 09:22:29 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 172.18.0.200 left intact
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Oops! Your request is not found.
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/status/500
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 172.18.0.200 (172.18.0.200) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /status/500 HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.5.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>500</span> Internal Server Error
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 34
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Thu, 07 Nov 2024 09:23:02 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 172.18.0.200 left intact
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{&#34;error&#34;: &#34;Internal Server Error&#34;}
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cefc6262f45f99a1923e5c0330cde320>2.2.25 - Retry</h1><p>A retry setting specifies the maximum number of times an Envoy proxy attempts to connect to a service if the initial call fails. Retries can enhance service availability and application performance by making sure that calls don’t fail permanently because of transient problems such as a temporarily overloaded service or network. The interval between retries prevents the called service from being overwhelmed with requests.</p><p>Envoy Gateway supports the following retry settings:</p><ul><li><strong>NumRetries</strong>: is the number of retries to be attempted. Defaults to 2.</li><li><strong>RetryOn</strong>: specifies the retry trigger condition.</li><li><strong>PerRetryPolicy</strong>: is the retry policy to be applied per retry attempt.</li></ul><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired retry settings. This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note</strong>: There are distinct circuit breaker counters for each <code>BackendReference</code> in an <code>xRoute</code> rule. Even if a <code>BackendTrafficPolicy</code> targets a <code>Gateway</code>, each <code>BackendReference</code> in that gateway still has separate circuit breaker counter.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=test-and-customize-retry-settings>Test and customize retry settings<a class=td-heading-self-link href=#test-and-customize-retry-settings aria-label="Heading self-link"></a></h2><p>Before applying a <code>BackendTrafficPolicy</code> with retry setting to a route, let&rsquo;s test the default retry settings.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/status/500&#34;</span>
</span></span></code></pre></div><p>It will return <code>500</code> response immediately.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 172.18.255.200:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 172.18.255.200 (172.18.255.200) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /status/500 HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.4.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>500</span> Internal Server Error
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Fri, 01 Mar 2024 15:12:55 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 172.18.255.200 left intact
</span></span></span></code></pre></div><p>Let&rsquo;s create a <code>BackendTrafficPolicy</code> with a retry setting.</p><p>The request will be retried 5 times with a 100ms base interval and a 10s maximum interval.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: retry-for-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  retry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    numRetries: 5
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    perRetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backOff:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        baseInterval: 100ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        maxInterval: 10s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      timeout: 250ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    retryOn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      httpStatusCodes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - 500
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      triggers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - connect-failure
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - retriable-status-codes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>retry-for-route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>retry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>numRetries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>perRetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backOff</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>baseInterval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>100ms</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>maxInterval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>250ms</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>retryOn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>httpStatusCodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>triggers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>connect-failure</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>retriable-status-codes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Execute the test again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/status/500&#34;</span>
</span></span></code></pre></div><p>It will return <code>500</code> response after a few while.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 172.18.255.200:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 172.18.255.200 (172.18.255.200) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /status/500 HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.4.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>500</span> Internal Server Error
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Fri, 01 Mar 2024 15:15:53 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 172.18.255.200 left intact
</span></span></span></code></pre></div><p>Let&rsquo;s check the stats to see the retry behavior.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x stats envoy-proxy -n envoy-gateway-system -l gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg,gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;envoy_cluster_upstream_rq_retry{envoy_cluster_name=\&#34;httproute/default/backend/rule/0\&#34;}&#34;</span>
</span></span></code></pre></div><p>You will expect to see the stats.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>envoy_cluster_upstream_rq_retry{envoy_cluster_name=&#34;httproute/default/backend/rule/0&#34;} 5
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5c0f15ca30cbfb44997dd22c518bde34>2.2.26 - Routing outside Kubernetes</h1><p>Routing to endpoints outside the Kubernetes cluster where Envoy Gateway and its corresponding Envoy Proxy fleet is
running is a common use case. This can be achieved by:</p><ul><li>defining FQDN addresses in a <a href=https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/>EndpointSlice</a> (covered in this document)</li><li>defining a <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backend>Backend</a> resource, as described in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/backend/>Backend Task</a>.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Define a Service and EndpointSlice that represents <a href=https://httpbin.org>https://httpbin.org</a></p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: discovery.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EndpointSlice
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes.io/service-name: httpbin 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>addressType: FQDN
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>- name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>- addresses:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;httpbin.org&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>discovery.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EndpointSlice</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes.io/service-name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>addressType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FQDN</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>addresses</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;httpbin.org&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Update the <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a> to include a TLS Listener on port 443</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Passthrough
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Add a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a> that can route incoming traffic to the above backend that we created</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TLSRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLSRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>httpbin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Get the Gateway address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Send a request and view the response:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -I -HHost:httpbin.org --resolve <span style=color:#4e9a06>&#34;httpbin.org:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> https://httpbin.org/
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f4586a14dc18bf33770411352a03d927>2.2.27 - TCP Routing</h1><p><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> provides a way to route TCP requests. When combined with a Gateway listener, it can be used to forward
connections on the port specified by the listener to a set of backends specified by the TCPRoute. To learn more about
HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>In this example, we have one Gateway resource and two TCPRoute resources that distribute the traffic with the following
rules:</p><p>All TCP streams on port <code>8088</code> of the Gateway are forwarded to port 3001 of <code>foo</code> Kubernetes Service.
All TCP streams on port <code>8089</code> of the Gateway are forwarded to port 3002 of <code>bar</code> Kubernetes Service.
In this example two TCP listeners will be applied to the Gateway in order to route them to two separate backend
TCPRoutes, note that the protocol set for the listeners on the Gateway is TCP:</p><p>Install the GatewayClass and a <code>tcp-gateway</code> Gateway first.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 8088
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 8089
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8088</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8089</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Install two services <code>foo</code> and <code>bar</code>, which are bound to <code>backend-1</code> and <code>backend-2</code>.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3001
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3001</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3002</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SERVICE_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SERVICE_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Install two TCPRoutes <code>tcp-app-1</code> and <code>tcp-app-2</code> with different <code>sectionName</code>:</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-app-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3001
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-app-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-app-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3001</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-app-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3002</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>In the above example we separate the traffic for the two separate backend TCP Services by using the sectionName field in
the parentRefs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This corresponds directly with the name in the listeners in the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8088</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8089</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>In this way each TCPRoute &ldquo;attaches&rdquo; itself to a different port on the Gateway so that the <code>foo</code> service
is taking traffic for port <code>8088</code> from outside the cluster and <code>bar</code> service takes the port <code>8089</code> traffic.</p><p>Before testing, please get the tcp-gateway Gateway&rsquo;s address first:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/tcp-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>You can try to use nc to test the TCP connections of envoy gateway with different ports, and you can see them succeeded:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nc -zv <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> <span style=color:#0000cf;font-weight:700>8088</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nc -zv <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> <span style=color:#0000cf;font-weight:700>8089</span>
</span></span></code></pre></div><p>You can also try to send requests to envoy gateway and get responses as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:8088&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#0000cf;font-weight:700>03</span> Jan <span style=color:#0000cf;font-weight:700>2023</span> 10:18:36 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#0000cf;font-weight:700>267</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;xxx.xxx.xxx.xxx:8088&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.85.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-1-c6c5fb958-dl8vl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see that the traffic routing to <code>foo</code> service when sending request to <code>8088</code> port.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:8089&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#0000cf;font-weight:700>03</span> Jan <span style=color:#0000cf;font-weight:700>2023</span> 10:19:28 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#0000cf;font-weight:700>267</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;xxx.xxx.xxx.xxx:8089&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.85.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;bar&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-2-98fcff498-hcmgb&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>                                            
</span></span></code></pre></div><p>You can see that the traffic routing to <code>bar</code> service when sending request to <code>8089</code> port.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-94e2d1222db4bea8206f12ef22355350>2.2.28 - UDP Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a> resource allows users to configure UDP routing by matching UDP traffic and forwarding it to Kubernetes
backends. This task will use CoreDNS example to walk you through the steps required to configure UDPRoute on Envoy
Gateway.</p><p><strong>Note:</strong> UDPRoute allows Envoy Gateway to operate as a non-transparent proxy between a UDP client and server. The lack
of transparency means that the upstream server will see the source IP and port of the Gateway instead of the client.
For additional information, refer to Envoy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/udp_filters/udp_proxy>UDP proxy documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install CoreDNS in the Kubernetes cluster as the example backend. The installed CoreDNS is listening on
UDP port 53 for DNS lookups.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/udp-routing-example-backend.yaml
</span></span></code></pre></div><p>Wait for the CoreDNS deployment to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m deployment/coredns --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Update the Gateway from the Quickstart to include a UDP listener that listens on UDP port <code>5300</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: UDP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 5300
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: UDPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Create a UDPRoute resource to route UDP traffic received on Gateway port 5300 to the CoredDNS backend.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: UDPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 53
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UDPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>coredns</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>coredns</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>coredns</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>53</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the UDPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get udproute/coredns -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Use <code>dig</code> command to query the dns entry foo.bar.com through the Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dig @<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> -p <span style=color:#0000cf;font-weight:700>5300</span> foo.bar.com
</span></span></code></pre></div><p>You should see the result of the dns query as the below output, which means that the dns query has been successfully
routed to the backend CoreDNS.</p><p>Note: 49.51.177.138 is the resolved address of GATEWAY_HOST.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> &lt;&lt;&gt;&gt; DiG 9.18.1-1ubuntu1.1-Ubuntu &lt;&lt;&gt;&gt; @49.51.177.138 -p <span style=color:#0000cf;font-weight:700>5300</span> foo.bar.com
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> server found<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> global options: +cmd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> Got answer:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> -&gt;&gt;HEADER<span style=color:#4e9a06>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#0000cf;font-weight:700>58125</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> flags: qr aa rd<span style=color:#000;font-weight:700>;</span> QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> WARNING: recursion requested but not available
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> OPT PSEUDOSECTION:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> EDNS: version: 0, flags:<span style=color:#000;font-weight:700>;</span> udp: <span style=color:#0000cf;font-weight:700>1232</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> COOKIE: 24fb86eba96ebf62 <span style=color:#ce5c00;font-weight:700>(</span>echoed<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> QUESTION SECTION:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span>foo.bar.com.			IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> ADDITIONAL SECTION:
</span></span><span style=display:flex><span>foo.bar.com.		0	IN	A	10.244.0.19
</span></span><span style=display:flex><span>_udp.foo.bar.com.	0	IN	SRV	<span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>42376</span> .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> Query time: <span style=color:#0000cf;font-weight:700>1</span> msec
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> SERVER: 49.51.177.138#5300<span style=color:#ce5c00;font-weight:700>(</span>49.51.177.138<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>UDP<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> WHEN: Fri Jan <span style=color:#0000cf;font-weight:700>13</span> 10:20:34 UTC <span style=color:#0000cf;font-weight:700>2023</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> MSG SIZE  rcvd: <span style=color:#0000cf;font-weight:700>114</span>
</span></span></code></pre></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway.</p><p>Delete the CoreDNS example manifest and the UDPRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deploy/coredns
</span></span><span style=display:flex><span>kubectl delete service/coredns
</span></span><span style=display:flex><span>kubectl delete cm/coredns
</span></span><span style=display:flex><span>kubectl delete udproute/coredns
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-557726d6cac1218a5aa4d38c303a9b13>2.3 - Security</h1><div class=lead>This section includes Security tasks.</div></div><div class=td-content><h1 id=pg-6c75c7ec45bc972198169dc384cc1ae6>2.3.1 - Accelerating TLS Handshakes using Private Key Provider in Envoy</h1><p>TLS operations can be accelerated or the private key can be protected using specialized hardware. This can be leveraged in Envoy using <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#extensions-transport-sockets-tls-v3-privatekeyprovider>Envoy Private Key Provider</a> is added to Envoy.</p><p>Today, there are two private key providers implemented in Envoy as contrib extensions:</p><ul><li><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/private_key_providers/qat/v3alpha/qat.proto#extensions-private-key-providers-qat-v3alpha-qatprivatekeymethodconfig>QAT in Envoy 1.24 release</a></li><li><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/private_key_providers/cryptomb/v3alpha/cryptomb.proto>CryptoMB in Envoy 1.20 release</a></li></ul><p>Both of them are used to accelerate the TLS handshake through the hardware capabilities.</p><p>This task will walk you through the steps required to configure TLS Termination mode for TCP traffic while also using the Envoy Private Key Provider to accelerate the TLS handshake by leveraging QAT and the HW accelerator available on Intel SPR/EMR Xeon server platforms.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="qat (intel quickassist technology)" aria-controls=tabs-00-00 aria-selected=true>
QAT (Intel QuickAssist Technology)</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=cryptomb aria-controls=tabs-00-01 aria-selected=false>
CryptoMB</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><ul><li><p>Install Linux kernel 5.17 or similar</p></li><li><p>Ensure the node has QAT devices by checking the QAT physical function devices presented. <a href=https://intel.github.io/quickassist/qatlib/requirements.html#qat2-0-qatlib-supported-devices>Supported Devices</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>(</span>lspci -d 8086:4940 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4941 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4942 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4943 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4946 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4947<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000;font-weight:700>|</span> wc -l<span style=color:#4e9a06>`</span> supported devices found.
</span></span></code></pre></div></li><li><p>Enable IOMMU from BIOS</p></li><li><p>Enable IOMMU for Linux kernel</p><p>Figure out the QAT VF device id</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>lspci -d 8086:4941 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4943 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> lspci -d 8086:4947
</span></span></code></pre></div><p>Attach the QAT device to vfio-pci through kernel parameter by the device id gotten from previous command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /etc/default/grub:
</span></span><span style=display:flex><span><span style=color:#000>GRUB_CMDLINE_LINUX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;intel_iommu=on vfio-pci.ids=[QAT device id]&#34;</span>
</span></span><span style=display:flex><span>update-grub
</span></span><span style=display:flex><span>reboot
</span></span></code></pre></div><p>Once the system is rebooted, check if the IOMMU has been enabled via the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dmesg<span style=color:#000;font-weight:700>|</span> grep IOMMU
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>    1.528237<span style=color:#ce5c00;font-weight:700>]</span> DMAR: IOMMU enabled
</span></span></code></pre></div></li><li><p>Enable virtual function devices for QAT device</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>modprobe vfio_pci
</span></span><span style=display:flex><span>rmmod qat_4xxx
</span></span><span style=display:flex><span>modprobe qat_4xxx
</span></span><span style=display:flex><span><span style=color:#000>qat_device</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>lspci -D -d :<span style=color:#ce5c00;font-weight:700>[</span>QAT device id<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{print $1}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#000>$qat_device</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#204a87>echo</span> 16<span style=color:#000;font-weight:700>|</span>sudo tee /sys/bus/pci/devices/<span style=color:#000>$i</span>/sriov_numvfs<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>chmod a+rw /dev/vfio/*
</span></span></code></pre></div></li><li><p>Increase the container runtime memory lock limit (using the containerd as example here)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir /etc/systemd/system/containerd.service.d
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF &gt;&gt;/etc/systemd/system/containerd.service.d/memlock.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[Service]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>LimitMEMLOCK=134217728
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Restart the container runtime (for containerd, CRIO has similar concept)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart containerd
</span></span></code></pre></div></li><li><p>Install <a href=https://github.com/intel/intel-device-plugins-for-kubernetes>Intel® QAT Device Plugin for Kubernetes</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k <span style=color:#4e9a06>&#39;https://github.com/intel/intel-device-plugins-for-kubernetes/deployments/qat_plugin?ref=main&#39;</span>
</span></span></code></pre></div><p>Verification of the plugin deployment and detection of QAT hardware can be confirmed by examining the resource allocations on the nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get node -o yaml<span style=color:#000;font-weight:700>|</span> grep qat.intel.com
</span></span></code></pre></div></li></ul></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>It required the node with 3rd generation Intel Xeon Scalable processor server processors, or later.</p><ul><li><p>For kubernetes Cluster, if not all nodes that support Intel® AVX-512 in Kubernetes cluster, you need to add some labels to divide these two kinds of nodes manually or using <a href=https://github.com/kubernetes-sigs/node-feature-discovery>NFD</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k https://github.com/kubernetes-sigs/node-feature-discovery/deployment/overlays/default?ref<span style=color:#ce5c00;font-weight:700>=</span>v0.15.1
</span></span></code></pre></div></li><li><p>Checking the available nodes with required cpu instructions:</p><ul><li><p>Check the node labels if using <a href=https://github.com/kubernetes-sigs/node-feature-discovery>NFD</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes -l feature.node.kubernetes.io/cpu-cpuid.AVX512F,feature.node.kubernetes.io/cpu-cpuid.AVX512DQ,feature.node.kubernetes.io/cpu-cpuid.AVX512BW,feature.node.kubernetes.io/cpu-cpuid.AVX512VBMI2,feature.node.kubernetes.io/cpu-cpuid.AVX512IFMA
</span></span></code></pre></div></li><li><p>Check CPUIDS manually on the node if without using NFD:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /proc/cpuinfo <span style=color:#000;font-weight:700>|</span>grep avx512f<span style=color:#000;font-weight:700>|</span>grep avx512dq<span style=color:#000;font-weight:700>|</span>grep avx512bw<span style=color:#000;font-weight:700>|</span>grep avx512_vbmi2<span style=color:#000;font-weight:700>|</span>grep avx512ifma
</span></span></code></pre></div></li></ul></li></ul></div></div><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><ul><li><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway.</p></li><li><p>Enable the EnvoyPatchPolicy feature, which will allow us to directly configure the Private Key Provider Envoy Filter, since Envoy Gateway does not directly expose this functionality.</p></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      enableEnvoyPatchPolicy: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      enableEnvoyPatchPolicy: true</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><h2 id=create-gateway-for-tls-termination>Create gateway for TLS termination<a class=td-heading-self-link href=#create-gateway-for-tls-termination aria-label="Heading self-link"></a></h2><ul><li><p>Follow the instructions in <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/tls-termination/>TLS Termination for TCP</a> to setup a TCP gateway to terminate the TLS connection.</p></li><li><p>Update GatewayClass for using the envoyproxy image with contrib extensions and requests required resources.</p></li></ul><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=change-envoyproxy-configuration>Change EnvoyProxy configuration<a class=td-heading-self-link href=#change-envoyproxy-configuration aria-label="Heading self-link"></a></h2><p>Using the envoyproxy image with contrib extensions and add qat resources requesting, ensure the k8s scheduler find out a machine with required resource.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="qat (intel quickassist technology)" aria-controls=tabs-04-00 aria-selected=true>
QAT (Intel QuickAssist Technology)</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=cryptomb aria-controls=tabs-04-01 aria-selected=false>
CryptoMB</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  concurrency: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyService:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: NodePort
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          image: envoyproxy/envoy-contrib-dev:latest
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 1000m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 4096Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              qat.intel.com/cy: &#39;1&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 1000m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 4096Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              qat.intel.com/cy: &#39;1&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyService</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NodePort</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>container</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoyproxy/envoy-contrib-dev:latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1000m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>4096Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>qat.intel.com/cy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1000m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>4096Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>qat.intel.com/cy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Using the envoyproxy image with contrib extensions and add the node affinity to scheduling the Envoy Gateway pod on the machine with required CPU instructions.</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  concurrency: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyService:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: NodePort
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          image: envoyproxy/envoy-contrib-dev:latest
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 1000m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 4096Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 1000m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 4096Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          affinity:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            nodeAffinity:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              requiredDuringSchedulingIgnoredDuringExecution:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                nodeSelectorTerms:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                - matchExpressions:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - key: feature.node.kubernetes.io/cpu-cpuid.AVX512F
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    operator: Exists
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - key: feature.node.kubernetes.io/cpu-cpuid.AVX512DQ
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    operator: Exists
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - key: feature.node.kubernetes.io/cpu-cpuid.AVX512BW
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    operator: Exists
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - key: feature.node.kubernetes.io/cpu-cpuid.AVX512IFMA
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    operator: Exists
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - key: feature.node.kubernetes.io/cpu-cpuid.AVX512VBMI2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    operator: Exists
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyService</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NodePort</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>container</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoyproxy/envoy-contrib-dev:latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1000m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>4096Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1000m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>4096Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pod</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>affinity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>nodeAffinity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>requiredDuringSchedulingIgnoredDuringExecution</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>nodeSelectorTerms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span>- <span style=color:#204a87;font-weight:700>matchExpressions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>feature.node.kubernetes.io/cpu-cpuid.AVX512F</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>feature.node.kubernetes.io/cpu-cpuid.AVX512DQ</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>feature.node.kubernetes.io/cpu-cpuid.AVX512BW</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>feature.node.kubernetes.io/cpu-cpuid.AVX512IFMA</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>feature.node.kubernetes.io/cpu-cpuid.AVX512VBMI2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Or using <code>preferredDuringSchedulingIgnoredDuringExecution</code> for best effort scheduling, or not doing any node affinity, just doing the random scheduling. The CryptoMB private key provider supports software fallback if the required CPU instructions aren&rsquo;t here.</p></div></div><h2 id=benchmark-before-enabling-private-key-provider>Benchmark before enabling private key provider<a class=td-heading-self-link href=#benchmark-before-enabling-private-key-provider aria-label="Heading self-link"></a></h2><p>First follow the instructions in <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/tls-termination/>TLS Termination for TCP</a> to do the functionality test.</p><p>Ensure the cpu frequency governor set as <code>performance</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>NUM_CPUS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>`</span>lscpu <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;^CPU(s):&#34;</span><span style=color:#000;font-weight:700>|</span>awk <span style=color:#4e9a06>&#39;{print $2}&#39;</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#4e9a06>`</span>seq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>$NUM_CPUS</span><span style=color:#4e9a06>`</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> sudo cpufreq-set -c <span style=color:#000>$i</span> -g performance<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><p>Using the nodeport as the example, fetch the node port from envoy gateway service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>NODE_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl -n envoy-gateway-system get svc/<span style=color:#000>$ENVOY_SERVICE</span> -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.spec.ports[0].nodePort}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;127.0.0.1 www.example.com&#34;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><p>Benchmark the gateway with fortio.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>fortio load -c <span style=color:#0000cf;font-weight:700>10</span> -k -qps <span style=color:#0000cf;font-weight:700>0</span> -t 30s -keepalive<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> https://www.example.com:<span style=color:#4e9a06>${</span><span style=color:#000>NODE_PORT</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><h2 id=apply-envoypatchpolicy-to-enable-private-key-provider>Apply EnvoyPatchPolicy to enable private key provider<a class=td-heading-self-link href=#apply-envoypatchpolicy-to-enable-private-key-provider aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="qat (intel quickassist technology)" aria-controls=tabs-05-00 aria-selected=true>
QAT (Intel QuickAssist Technology)</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=cryptomb aria-controls=tabs-05-01 aria-selected=false>
CryptoMB</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyPatchPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: key-provider-patch-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/tls_certificate/private_key_provider&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          provider_name: qat
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          typed_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.private_key_providers.qat.v3alpha.QatPrivateKeyMethodConfig&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            private_key:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              inline_string: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                abcd
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            poll_delay: 0.001s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          fallback: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: copy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        from: &#34;/tls_certificate/private_key&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/tls_certificate/private_key_provider/typed_config/private_key&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key-provider-patch-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/example-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>add</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/tls_certificate/private_key_provider&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>provider_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>qat</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;@type&#34;: </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.extensions.private_key_providers.qat.v3alpha.QatPrivateKeyMethodConfig&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>private_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>inline_string</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                abcd</span><span style=color:#f8f8f8;text-decoration:underline>                
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>poll_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.</span><span style=color:#000>001s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>fallback</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/example-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/tls_certificate/private_key&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/tls_certificate/private_key_provider/typed_config/private_key&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyPatchPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: key-provider-patch-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/tls_certificate/private_key_provider&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          provider_name: cryptomb
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          typed_config:  
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.private_key_providers.cryptomb.v3alpha.CryptoMbPrivateKeyMethodConfig&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            private_key:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              inline_string: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                abcd
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            poll_delay: 0.001s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          fallback: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: copy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        from: &#34;/tls_certificate/private_key&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/tls_certificate/private_key_provider/typed_config/private_key&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key-provider-patch-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/example-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>add</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/tls_certificate/private_key_provider&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>provider_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cryptomb</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;@type&#34;: </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.extensions.private_key_providers.cryptomb.v3alpha.CryptoMbPrivateKeyMethodConfig&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>private_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>inline_string</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                abcd</span><span style=color:#f8f8f8;text-decoration:underline>                
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>poll_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.</span><span style=color:#000>001s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>fallback</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/example-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/tls_certificate/private_key&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/tls_certificate/private_key_provider/typed_config/private_key&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div></div></div><h2 id=benchmark-after-enabling-private-key-provider>Benchmark after enabling private key provider<a class=td-heading-self-link href=#benchmark-after-enabling-private-key-provider aria-label="Heading self-link"></a></h2><p>First follow the instructions in <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/tls-termination/>TLS Termination for TCP</a> to do the functionality test again.</p><p>Benchmark the gateway with fortio.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>fortio load -c <span style=color:#0000cf;font-weight:700>64</span> -k -qps <span style=color:#0000cf;font-weight:700>0</span> -t 30s -keepalive<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> https://www.example.com:<span style=color:#4e9a06>${</span><span style=color:#000>NODE_PORT</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><h2 id=benchmark-result>Benchmark Result<a class=td-heading-self-link href=#benchmark-result aria-label="Heading self-link"></a></h2><p>You will see a performance boost after private key provider enabled. For example, you will get results as below.</p><p>Without private key provider:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>All <span style=color:#204a87;font-weight:700>done</span> <span style=color:#0000cf;font-weight:700>43069</span> calls <span style=color:#ce5c00;font-weight:700>(</span>plus <span style=color:#0000cf;font-weight:700>10</span> warmup<span style=color:#ce5c00;font-weight:700>)</span> 6.966 ms avg, 1435.4 qps
</span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist="qat (intel quickassist technology)" aria-controls=tabs-06-00 aria-selected=true>
QAT (Intel QuickAssist Technology)</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=cryptomb aria-controls=tabs-06-01 aria-selected=false>
CryptoMB</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><p>With QAT private key provider, the QPS is over 3 times than without private key provider</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>All <span style=color:#204a87;font-weight:700>done</span> <span style=color:#0000cf;font-weight:700>134746</span> calls <span style=color:#ce5c00;font-weight:700>(</span>plus <span style=color:#0000cf;font-weight:700>128</span> warmup<span style=color:#ce5c00;font-weight:700>)</span> 28.505 ms avg, 4489.6 qps
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><p>With CryptoMB private key provider, the QPS is over 2 times than without private key provider.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>All <span style=color:#204a87;font-weight:700>done</span> <span style=color:#0000cf;font-weight:700>93983</span> calls <span style=color:#ce5c00;font-weight:700>(</span>plus <span style=color:#0000cf;font-weight:700>128</span> warmup<span style=color:#ce5c00;font-weight:700>)</span> 40.880 ms avg, 3130.5 qps
</span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-92fd54b74e99c0282aa8330875f18755>2.3.2 - Backend Mutual TLS: Gateway to Backend</h1><p>This task demonstrates how mTLS can be achieved between the Gateway and a backend.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><p>Envoy Gateway supports the Gateway-API defined <a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a> to establish TLS. For mTLS, the Gateway must authenticate by presenting a client certificate to the backend.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/backend-tls/>Backend TLS</a> to install Envoy Gateway and configure TLS to the backend server.</p><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Gateway for authentication against the backend.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout clientca.key -out clientca.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -new -newkey rsa:2048 -nodes -keyout client.key -out client.csr -subj <span style=color:#4e9a06>&#34;/CN=example-client/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA clientca.crt -CAkey clientca.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in client.csr -out client.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system create secret tls example-client-cert --key<span style=color:#ce5c00;font-weight:700>=</span>client.key --cert<span style=color:#ce5c00;font-weight:700>=</span>client.crt
</span></span></code></pre></div><p>Store the CA Cert in another Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap example-client-ca --from-file<span style=color:#ce5c00;font-weight:700>=</span>clientca.crt
</span></span></code></pre></div><h2 id=enforce-client-certificate-authentication-on-the-backend>Enforce Client Certificate Authentication on the backend<a class=td-heading-self-link href=#enforce-client-certificate-authentication-on-the-backend aria-label="Heading self-link"></a></h2><p>Patch the existing quickstart backend to enforce Client Certificate Authentication. The patch will mount the server certificate and key required for TLS, and the CA certificate into the backend as volumes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/containers/0/volumeMounts
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: client-certs-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      mountPath: /etc/client-certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: secret-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      mountPath: /etc/secret-volume      
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/volumes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: client-certs-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      configMap:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: example-client-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        items:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - key: clientca.crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path: crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: secret-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      secret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        secretName: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        items:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - key: tls.crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path: crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - key: tls.key
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path: key          
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/containers/0/env/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: TLS_CLIENT_CACERTS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      value: /etc/client-certs/crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><h2 id=configure-envoy-proxy-to-use-a-client-certificate>Configure Envoy Proxy to use a client certificate<a class=td-heading-self-link href=#configure-envoy-proxy-to-use-a-client-certificate aria-label="Heading self-link"></a></h2><p>In addition to enablement of backend TLS with the Gateway-API BackendTLSPolicy, Envoy Gateway supports customizing TLS parameters such as TLS Client Certificate.
To achieve this, the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> resource can be used to specify a TLS Client Certificate.</p><p>First, you need to add ParametersRef in GatewayClass, and refer to EnvoyProxy Config:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  backendTLS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientCertificateRef: 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: example-client-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>backendTLS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientCertificateRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-client-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=testing-mtls>Testing mTLS<a class=td-heading-self-link href=#testing-mtls aria-label="Heading self-link"></a></h2><p>Query the TLS-enabled backend through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:80:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>http://www.example.com:80/get
</span></span></code></pre></div><p>Inspect the output and see that the response contains the details of the TLS handshake between Envoy and the backend.
The response now contains a &ldquo;peerCertificates&rdquo; attribute that reflects the client certificate used by the Gateway to establish mTLS with the backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;tls&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;version&#34;</span>: <span style=color:#4e9a06>&#34;TLSv1.2&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;serverName&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;negotiatedProtocol&#34;</span>: <span style=color:#4e9a06>&#34;http/1.1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;cipherSuite&#34;</span>: <span style=color:#4e9a06>&#34;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;peerCertificates&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;-----BEGIN CERTIFICATE-----\n[...]-----END CERTIFICATE-----\n&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ef99cfc94f9074bcc4fa3dacc054242b>2.3.3 - Backend TLS: Gateway to Backend</h1><p>This task demonstrates how TLS can be achieved between the Gateway and a backend.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><p>Envoy Gateway supports the Gateway-API defined <a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the backend to terminate TLS connections from the Gateways.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout ca.key -out ca.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>.</p><p>First, create an openssl configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt; openssl.conf  <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[req]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>req_extensions = v3_req
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>prompt = no
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[v3_req]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>keyUsage = keyEncipherment, digitalSignature
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>extendedKeyUsage = serverAuth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>subjectAltName = @alt_names
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[alt_names]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>DNS.1 = www.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Then create a certificate using this openssl configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA ca.crt -CAkey ca.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt -extfile openssl.conf -extensions v3_req
</span></span></code></pre></div><p>Note that the certificate must contain a DNS SAN for the relevant domain.</p><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Store the CA Cert in another Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap example-ca --from-file<span style=color:#ce5c00;font-weight:700>=</span>ca.crt
</span></span></code></pre></div><h2 id=setup-tls-on-the-backend>Setup TLS on the backend<a class=td-heading-self-link href=#setup-tls-on-the-backend aria-label="Heading self-link"></a></h2><p>Patch the existing quickstart backend to enable TLS. The patch will mount the TLS certificate secret into the backend as volume.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/containers/0/volumeMounts
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: secret-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      mountPath: /etc/secret-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/volumes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: secret-volume
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      secret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        secretName: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        items:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - key: tls.crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path: crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - key: tls.key
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path: key
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/containers/0/env/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: TLS_SERVER_CERT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      value: /etc/secret-volume/crt
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/template/spec/containers/0/env/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: TLS_SERVER_PRIVKEY
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      value: /etc/secret-volume/key
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Create a service that exposes port 443 on the backend service.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tls-backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    targetPort: 8443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls-backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Create a <a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a> instructing Envoy Gateway to establish a TLS connection with the backend and validate the backend certificate is issued by a trusted CA and contains an appropriate DNS SAN.</p><p>Note: SectionName is an optional field that specifies the name of the port in the target backend. This example uses a Kubernetes Service as the backend target, so the sectionName is set to <code>https</code> to match the port name in the Service.
If the target is a <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backend>Backend</a> resource, the <code>sectionName</code> field should be set to the port number of the backend.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTLSPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-backend-tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: &#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: tls-backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  validation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    caCertificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      group: &#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    hostname: www.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTLSPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-backend-tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls-backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>validation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>caCertificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Patch the HTTPRoute&rsquo;s backend reference, so that it refers to the new TLS-enabled service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch HTTPRoute backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/rules/0/backendRefs/0/port
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/rules/0/backendRefs/0/name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value: tls-backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the HTTPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get HTTPRoute backend -o yaml
</span></span></code></pre></div><h2 id=testing-backend-tls>Testing backend TLS<a class=td-heading-self-link href=#testing-backend-tls aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-03-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-03-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:80:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>http://www.example.com:80/get
</span></span></code></pre></div><p>Inspect the output and see that the response contains the details of the TLS handshake between Envoy and the backend:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;tls&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;version&#34;</span>: <span style=color:#4e9a06>&#34;TLSv1.2&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;serverName&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;negotiatedProtocol&#34;</span>: <span style=color:#4e9a06>&#34;http/1.1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;cipherSuite&#34;</span>: <span style=color:#4e9a06>&#34;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 80:80 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the TLS-enabled backend through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:80:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>http://www.example.com:80/get
</span></span></code></pre></div><p>Inspect the output and see that the response contains the details of the TLS handshake between Envoy and the backend:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;tls&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;version&#34;</span>: <span style=color:#4e9a06>&#34;TLSv1.2&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;serverName&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;negotiatedProtocol&#34;</span>: <span style=color:#4e9a06>&#34;http/1.1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;cipherSuite&#34;</span>: <span style=color:#4e9a06>&#34;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div></div><h2 id=customize-backend-tls-parameters>Customize backend TLS Parameters<a class=td-heading-self-link href=#customize-backend-tls-parameters aria-label="Heading self-link"></a></h2><p>In addition to enablement of backend TLS with the Gateway-API BackendTLSPolicy, Envoy Gateway supports customizing TLS parameters.
To achieve this, the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> resource can be used to specify TLS parameters. We will customize the TLS version in this example.</p><p>First, you need to add ParametersRef in GatewayClass, and refer to EnvoyProxy Config:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>You can customize the EnvoyProxy Backend TLS Parameters via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  backendTLS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    minVersion: &#34;1.3&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>backendTLS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>MinVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1.3&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=testing-tls-parameters>Testing TLS Parameters<a class=td-heading-self-link href=#testing-tls-parameters aria-label="Heading self-link"></a></h2><p>Query the TLS-enabled backend through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:80:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>http://www.example.com:80/get
</span></span></code></pre></div><p>Inspect the output and see that the response contains the details of the TLS handshake between Envoy and the backend.
The TLS version is now TLS1.3, as configured in the EnvoyProxy resource. The TLS cipher is also changed, since TLS1.3 supports different ciphers from TLS1.2.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;tls&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;version&#34;</span>: <span style=color:#4e9a06>&#34;TLSv1.3&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;serverName&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;negotiatedProtocol&#34;</span>: <span style=color:#4e9a06>&#34;http/1.1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;cipherSuite&#34;</span>: <span style=color:#4e9a06>&#34;TLS_AES_128_GCM_SHA256&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8f0c5242518e692a7b89bc444cc01efc>2.3.4 - Basic Authentication</h1><p>This task provides instructions for configuring <a href=https://tools.ietf.org/html/rfc2617>HTTP Basic authentication</a>.
HTTP Basic authentication checks if an incoming request has a valid username and password before routing the request to
a backend service.</p><p>Envoy Gateway introduces a new CRD called <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> that allows the user to configure HTTP Basic
authentication.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Envoy Gateway uses <a href=https://httpd.apache.org/docs/current/programs/htpasswd.html>.htpasswd</a> format to store the username-password pairs for authentication.
The file must be stored in a kubernetes secret and referenced in the <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> configuration.
The secret is an Opaque secret, and the username-password pairs must be stored in the key &ldquo;.htpasswd&rdquo;.</p><h3 id=create-a-root-certificate>Create a root certificate<a class=td-heading-self-link href=#create-a-root-certificate aria-label="Heading self-link"></a></h3><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><h3 id=create-a-certificate-secret>Create a certificate secret<a class=td-heading-self-link href=#create-a-certificate-secret aria-label="Heading self-link"></a></h3><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><h3 id=create-certificate>Create certificate<a class=td-heading-self-link href=#create-certificate aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><h3 id=enable-https>Enable HTTPS<a class=td-heading-self-link href=#enable-https aria-label="Heading self-link"></a></h3><p>Update the Gateway from the Quickstart to include an HTTPS listener that listens on port <code>443</code> and references the
<code>example-cert</code> Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><h3 id=create-a-htpasswd-file>Create a .htpasswd file<a class=td-heading-self-link href=#create-a-htpasswd-file aria-label="Heading self-link"></a></h3><p>First, create a <a href=https://httpd.apache.org/docs/current/programs/htpasswd.html>.htpasswd</a> file with the username and password you want to use for authentication.</p><p>Note: Please always use HTTPS with Basic Authentication. This prevents credentials from being transmitted in plain text.</p><p>The input password won&rsquo;t be saved, instead, a hash will be generated and saved in the output file. When a request
tries to access protected resources, the password in the &ldquo;Authorization&rdquo; HTTP header will be hashed and compared with the
saved hash.</p><p>Note: only SHA hash algorithm is supported for now.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>htpasswd -cbs .htpasswd foo bar
</span></span></code></pre></div><p>You can also add more users to the file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>htpasswd -bs .htpasswd foo1 bar1
</span></span></code></pre></div><h3 id=create-a-basic-auth-secret>Create a basic-auth secret<a class=td-heading-self-link href=#create-a-basic-auth-secret aria-label="Heading self-link"></a></h3><p>Next, create a kubernetes secret with the generated .htpasswd file in the previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic basic-auth --from-file<span style=color:#ce5c00;font-weight:700>=</span>.htpasswd
</span></span></code></pre></div><h3 id=create-a-securitypolicy>Create a SecurityPolicy<a class=td-heading-self-link href=#create-a-securitypolicy aria-label="Heading self-link"></a></h3><p>The below example defines a SecurityPolicy that authenticates requests against the user list in the kubernetes
secret generated in the previous step.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: basic-auth-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  basicAuth:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    users:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: &#34;basic-auth&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>basic-auth-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>basicAuth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;basic-auth&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/basic-auth-example -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Send a request to the backend service without <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -kv -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;https://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span> 
</span></span></code></pre></div><p>You should see <code>401 Unauthorized</code> in the response, indicating that the request is not allowed without authentication.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>* Connected to 127.0.0.1 <span style=color:#ce5c00;font-weight:700>(</span>127.0.0.1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>443</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>* Server certificate:
</span></span><span style=display:flex><span>*  subject: <span style=color:#000>CN</span><span style=color:#ce5c00;font-weight:700>=</span>www.example.com<span style=color:#000;font-weight:700>;</span> <span style=color:#000>O</span><span style=color:#ce5c00;font-weight:700>=</span>example organization
</span></span><span style=display:flex><span>*  issuer: <span style=color:#000>O</span><span style=color:#ce5c00;font-weight:700>=</span>example Inc.<span style=color:#000;font-weight:700>;</span> <span style=color:#000>CN</span><span style=color:#ce5c00;font-weight:700>=</span>example.com
</span></span><span style=display:flex><span>&gt; GET / HTTP/2
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.6.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt; HTTP/2 <span style=color:#0000cf;font-weight:700>401</span>
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>58</span>
</span></span><span style=display:flex><span>&lt; content-type: text/plain
</span></span><span style=display:flex><span>&lt; date: Wed, <span style=color:#0000cf;font-weight:700>06</span> Mar <span style=color:#0000cf;font-weight:700>2024</span> 15:59:36 GMT
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 127.0.0.1 left intact</span>
</span></span><span style=display:flex><span>User authentication failed. Missing username and password.
</span></span></code></pre></div><p>Send a request to the backend service with <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -kv -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -u <span style=color:#4e9a06>&#39;foo:bar&#39;</span> <span style=color:#4e9a06>&#34;https://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span> 
</span></span></code></pre></div><p>The request should be allowed and you should see the response from the backend service.</p><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the SecurityPolicy and the secret</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete securitypolicy/basic-auth-example
</span></span><span style=display:flex><span>kubectl delete secret/basic-auth
</span></span><span style=display:flex><span>kubectl delete secret/example-cert
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d19c2b7be3babd02a42b7b6371d31db5>2.3.5 - CORS</h1><p>This task provides instructions for configuring <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS>Cross-Origin Resource Sharing (CORS)</a> on Envoy Gateway.
CORS defines a way for client web applications that are loaded in one domain to interact with resources in a different
domain.</p><p>Envoy Gateway introduces a new CRD called <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> that allows the user to configure CORS.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>When configuring CORS either an origin with a precise hostname can be configured or an hostname containing a wildcard prefix,
allowing all subdomains of the specified hostname.
In addition to that the entire origin (with or without specifying a scheme) can be a wildcard to allow all origins.</p><p>The below example defines a SecurityPolicy that allows CORS for all HTTP requests originating from <code>www.foo.com</code>.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: cors-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  cors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowOrigins:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;http://*.foo.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;http://*.foo.com:80&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowMethods:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - GET
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - POST
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;x-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;x-header-2&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    exposeHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;x-header-3&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;x-header-4&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cors-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>allowOrigins</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;http://*.foo.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;http://*.foo.com:80&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>allowMethods</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>GET</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>POST</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>allowHeaders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;x-header-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;x-header-2&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>exposeHeaders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;x-header-3&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;x-header-4&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/cors-example -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Verify that the CORS headers are present in the response of the OPTIONS request from <code>http://www.foo.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -H <span style=color:#4e9a06>&#34;Origin: http://www.foo.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Access-Control-Request-Method: GET&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X OPTIONS -v -s <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  http://<span style=color:#000>$GATEWAY_HOST</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  1&gt; /dev/null
</span></span></code></pre></div><p>You should see the below response, indicating that the request from <code>http://www.foo.com</code> is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&lt; access-control-allow-origin: http://www.foo.com
</span></span><span style=display:flex><span>&lt; access-control-allow-methods: GET, POST
</span></span><span style=display:flex><span>&lt; access-control-allow-headers: x-header-1, x-header-2
</span></span><span style=display:flex><span>&lt; access-control-max-age: <span style=color:#0000cf;font-weight:700>86400</span>
</span></span><span style=display:flex><span>&lt; access-control-expose-headers: x-header-3, x-header-4
</span></span></code></pre></div><p>If you try to send a request from <code>http://www.bar.com</code>, you should see the below response:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -H <span style=color:#4e9a06>&#34;Origin: http://www.bar.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Access-Control-Request-Method: GET&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X OPTIONS -v -s <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  http://<span style=color:#000>$GATEWAY_HOST</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  1&gt; /dev/null
</span></span></code></pre></div><p>You won&rsquo;t see any CORS headers in the response, indicating that the request from <code>http://www.bar.com</code> was not allowed.</p><p>If you try to send a request from <code>http://www.foo.com:8080</code>, you should also see similar response because the port number
<code>8080</code> is not included in the allowed origins.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#4e9a06>```</span>shell
</span></span><span style=display:flex><span>curl -H <span style=color:#4e9a06>&#34;Origin: http://www.foo.com:8080&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Access-Control-Request-Method: GET&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X OPTIONS -v -s <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  http://<span style=color:#000>$GATEWAY_HOST</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  1&gt; /dev/null
</span></span></code></pre></div><p>Note:</p><ul><li>CORS specification requires that the browsers to send a preflight request to the server to ask if it&rsquo;s allowed
to access the limited resource in another domains. The browsers are supposed to follow the response from the server to
determine whether to send the actual request or not. The CORS filter only response to the preflight requests according to
its configuration. It won&rsquo;t deny any requests. The browsers are responsible for enforcing the CORS policy.</li><li>The targeted HTTPRoute or the HTTPRoutes that the targeted Gateway routes to must allow the OPTIONS method for the CORS
filter to work. Otherwise, the OPTIONS request won&rsquo;t match the routes and the CORS filter won&rsquo;t be invoked.</li></ul><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the SecurityPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete securitypolicy/cors-example
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a25edaf594fbc4970e81aeef6618c57c>2.3.6 - External Authorization</h1><p>This task provides instructions for configuring external authentication.</p><p>External authorization calls an external HTTP or gRPC service to check whether an incoming HTTP request is authorized
or not. If the request is deemed unauthorized, then the request will be denied with a 403 (Forbidden) response. If the
request is authorized, then the request will be allowed to proceed to the backend service.</p><p>Envoy Gateway introduces a new CRD called <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> that allows the user to configure external authorization.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=http-external-authorization-service>HTTP External Authorization Service<a class=td-heading-self-link href=#http-external-authorization-service aria-label="Heading self-link"></a></h2><h3 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h3><p>Install a demo HTTP service that will be used as the external authorization service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/ext-auth-http-service.yaml
</span></span></code></pre></div><p>Create a new HTTPRoute resource to route traffic on the path <code>/myapp</code> to the backend service.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000   
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>   
</span></span></span></code></pre></div></div></div><p>Verify the HTTPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/myapp -o yaml
</span></span></code></pre></div><h3 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h3><p>Create a new SecurityPolicy resource to configure the external authorization. This SecurityPolicy targets the HTTPRoute
&ldquo;myApp&rdquo; created in the previous step. It calls the HTTP external authorization service &ldquo;http-ext-auth&rdquo; on port 9002 for
authorization. The <code>headersToBackend</code> field specifies the headers that will be sent to the backend service if the request
is successfully authorized.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ext-auth-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  extAuth:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    http:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: http-ext-auth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      headersToBackend: [&#34;x-current-user&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ext-auth-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extAuth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-ext-auth</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>headersToBackend</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;x-current-user&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/ext-auth-example -o yaml
</span></span></code></pre></div><h3 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h3><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Send a request to the backend service without <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/myapp&#34;</span>
</span></span></code></pre></div><p>You should see <code>403 Forbidden</code> in the response, indicating that the request is not allowed without authentication.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>* Connected to 172.18.255.200 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.200<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /myapp HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.68.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>403</span> Forbidden
</span></span><span style=display:flex><span>&lt; date: Mon, <span style=color:#0000cf;font-weight:700>11</span> Mar <span style=color:#0000cf;font-weight:700>2024</span> 03:41:15 GMT
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.200 left intact</span>
</span></span></code></pre></div><p>Send a request to the backend service with <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer token1&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/myapp&#34;</span>
</span></span></code></pre></div><p>The request should be allowed and you should see the response from the backend service.
Because the <code>x-current-user</code> header from the auth response has been sent to the backend service,
you should see the <code>x-current-user</code> header in the response.</p><pre tabindex=0><code>&#34;X-Current-User&#34;: [
   &#34;user1&#34;
  ],
</code></pre><h2 id=grpc-external-authorization-service>GRPC External Authorization Service<a class=td-heading-self-link href=#grpc-external-authorization-service aria-label="Heading self-link"></a></h2><h3 id=installation-1>Installation<a class=td-heading-self-link href=#installation-1 aria-label="Heading self-link"></a></h3><p>Install a demo gRPC service that will be used as the external authorization service. The demo gRPC service is enabled
with TLS and a BackendTLSConfig is created to configure the communication between the Envoy proxy and the gRPC service.</p><p>Note: TLS is optional for HTTP or gRPC external authorization services. However, enabling TLS is recommended for enhanced
security in production environments.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/ext-auth-grpc-service.yaml
</span></span></code></pre></div><p>The HTTPRoute created in the previous section is still valid and can be used with the gRPC auth service, but if you have
not created the HTTPRoute, you can create it now.</p><p>Create a new HTTPRoute resource to route traffic on the path <code>/myapp</code> to the backend service.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000   
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>   
</span></span></span></code></pre></div></div></div><p>Verify the HTTPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/myapp -o yaml
</span></span></code></pre></div><h3 id=configuration-1>Configuration<a class=td-heading-self-link href=#configuration-1 aria-label="Heading self-link"></a></h3><p>Update the SecurityPolicy that was created in the previous section to use the gRPC external authorization service.
It calls the gRPC external authorization service &ldquo;grpc-ext-auth&rdquo; on port 9002 for authorization.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ext-auth-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  extAuth:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    grpc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: grpc-ext-auth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ext-auth-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extAuth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>grpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-auth</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/ext-auth-example -o yaml
</span></span></code></pre></div><p>Because the gRPC external authorization service is enabled with TLS, a BackendTLSConfig needs to be created to configure
the communication between the Envoy proxy and the gRPC auth service.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTLSPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: grpc-ext-auth-btls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: &#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: grpc-ext-auth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: &#34;9002&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  validation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    caCertificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: grpc-ext-auth-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      group: &#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    hostname: grpc-ext-auth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTLSPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-auth-btls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-auth</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9002&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>validation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>caCertificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-auth-ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-auth</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the BackendTLSPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get backendtlspolicy/grpc-ext-auth-btls -o yaml
</span></span></code></pre></div><h3 id=testing-1>Testing<a class=td-heading-self-link href=#testing-1 aria-label="Heading self-link"></a></h3><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Send a request to the backend service without <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/myapp&#34;</span>
</span></span></code></pre></div><p>You should see <code>403 Forbidden</code> in the response, indicating that the request is not allowed without authentication.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>* Connected to 172.18.255.200 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.200<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /myapp HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.68.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>403</span> Forbidden
</span></span><span style=display:flex><span>&lt; date: Mon, <span style=color:#0000cf;font-weight:700>11</span> Mar <span style=color:#0000cf;font-weight:700>2024</span> 03:41:15 GMT
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.200 left intact</span>
</span></span></code></pre></div><p>Send a request to the backend service with <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer token1&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/myapp&#34;</span>
</span></span></code></pre></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the demo auth services, HTTPRoute, SecurityPolicy and BackendTLSPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/ext-auth-http-service.yaml
</span></span><span style=display:flex><span>kubectl delete -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/ext-auth-grpc-service.yaml
</span></span><span style=display:flex><span>kubectl delete httproute/myapp
</span></span><span style=display:flex><span>kubectl delete securitypolicy/ext-auth-example
</span></span><span style=display:flex><span>kubectl delete backendtlspolicy/grpc-ext-auth-btls
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cd1041ef46121984423cd102a9b22675>2.3.7 - IP Allowlist/Denylist</h1><p>This task provides instructions for configuring IP allowlist/denylist on Envoy Gateway. IP allowlist/denylist
checks if an incoming request is from an allowed IP address before routing the request to a backend service.</p><p>Envoy Gateway introduces a new CRD called <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> that allows the user to configure IP allowlist/denylist.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><h3 id=create-a-securitypolicy>Create a SecurityPolicy<a class=td-heading-self-link href=#create-a-securitypolicy aria-label="Heading self-link"></a></h3><p>The below SecurityPolicy restricts access to the backend service by allowing requests only from the IP addresses <code>10.0.1.0/24</code>.</p><p>In this example, the default action is set to <code>Deny</code>, which means that only requests from the specified IP addresses with <code>Allow</code>
action are allowed, and all other requests are denied. You can also change the default action to <code>Allow</code> to allow all requests
except those from the specified IP addresses with <code>Deny</code> action.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: authorization-client-ip
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  authorization:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    defaultAction: Deny
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - action: Allow
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      principal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        clientCIDRs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - 10.0.1.0/24
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorization-client-ip</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>authorization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>defaultAction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deny</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Allow</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>principal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>clientCIDRs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#0000cf;font-weight:700>10.0.1.0</span><span style=color:#000>/24</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/authorization-client-ip -o yaml
</span></span></code></pre></div><h3 id=original-source-ip>Original Source IP<a class=td-heading-self-link href=#original-source-ip aria-label="Heading self-link"></a></h3><p>It&rsquo;s important to note that the IP address used for allowlist/denylist is the original source IP address of the request.
You can use a <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> to configure how Envoy Gateway should determine the original source IP address.</p><p>For example, the below ClientTrafficPolicy configures Envoy Gateway to use the <code>X-Forwarded-For</code> header to determine the original source IP address.
The <code>numTrustedHops</code> field specifies the number of trusted hops in the <code>X-Forwarded-For</code> header. In this example, the <code>numTrustedHops</code> is set to <code>1</code>,
which means that the first rightmost IP address in the <code>X-Forwarded-For</code> header is used as the original source IP address.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-client-ip-detection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clientIPDetection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    xForwardedFor:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      numTrustedHops: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-client-ip-detection</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>clientIPDetection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>xForwardedFor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>numTrustedHops</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Send a request to the backend service without the <code>X-Forwarded-For</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>You should see <code>403 Forbidden</code> in the response, indicating that the request is not allowed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>* Connected to 172.18.255.200 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.200<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.8.0-DEV
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; 
</span></span><span style=display:flex><span>* Request completely sent off
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>403</span> Forbidden
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>19</span>
</span></span><span style=display:flex><span>&lt; content-type: text/plain
</span></span><span style=display:flex><span>&lt; date: Mon, <span style=color:#0000cf;font-weight:700>08</span> Jul <span style=color:#0000cf;font-weight:700>2024</span> 04:23:31 GMT
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.200 left intact</span>
</span></span><span style=display:flex><span>RBAC: access denied
</span></span></code></pre></div><p>Send a request to the backend service with the <code>X-Forwarded-For</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;X-Forwarded-For: 10.0.1.1&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>The request should be allowed and you should see the response from the backend service.</p><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the SecurityPolicy and the ClientTrafficPolicy</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete securitypolicy/authorization-client-ip
</span></span><span style=display:flex><span>kubectl delete clientTrafficPolicy/enable-client-ip-detection
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f6156b593933a8266c87c99e8d13b965>2.3.8 - JWT Authentication</h1><p>This task provides instructions for configuring <a href=https://tools.ietf.org/html/rfc7519>JSON Web Token (JWT)</a> authentication. JWT authentication checks
if an incoming request has a valid JWT before routing the request to a backend service. Currently, Envoy Gateway only
supports validating a JWT from an HTTP header, e.g. <code>Authorization: Bearer &lt;token></code>.</p><p>Envoy Gateway introduces a new CRD called <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> that allows the user to configure JWT authentication.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>For GRPC - follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/grpc-routing/>GRPC Routing</a> example.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Allow requests with a valid JWT by creating an <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> and attaching it to the example
HTTPRoute or GRPCRoute.</p><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/jwt/jwt.yaml
</span></span></code></pre></div><p>Two HTTPRoute has been created, one for <code>/foo</code> and another for <code>/bar</code>. A SecurityPolicy has been created and targeted
HTTPRoute foo to authenticate requests for <code>/foo</code>. The HTTPRoute bar is not targeted by the SecurityPolicy and will allow<br>unauthenticated requests to <code>/bar</code>.</p><p>Verify the HTTPRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/foo -o yaml
</span></span><span style=display:flex><span>kubectl get httproute/bar -o yaml
</span></span></code></pre></div><p>The SecurityPolicy is configured for JWT authentication and uses a single <a href=https://tools.ietf.org/html/rfc7517>JSON Web Key Set (JWKS)</a>
provider for authenticating the JWT.</p><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/jwt-example -o yaml
</span></span></code></pre></div><h3 id=grpcroute>GRPCRoute<a class=td-heading-self-link href=#grpcroute aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/jwt/grpc-jwt.yaml
</span></span></code></pre></div><p>A SecurityPolicy has been created and targeted GRPCRoute yages to authenticate all requests for <code>yages</code> service..</p><p>Verify the GRPCRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroute/yages -o yaml
</span></span></code></pre></div><p>The SecurityPolicy is configured for JWT authentication and uses a single <a href=https://tools.ietf.org/html/rfc7517>JSON Web Key Set (JWKS)</a>
provider for authenticating the JWT.</p><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/jwt-example -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><p>Verify that requests to <code>/foo</code> are denied without a JWT:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -o /dev/null -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -w <span style=color:#4e9a06>&#34;%{http_code}\n&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/foo
</span></span></code></pre></div><p>A <code>401</code> HTTP response code should be returned.</p><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><p><strong>Note:</strong> The above command decodes and returns the token&rsquo;s payload. You can replace <code>f2</code> with <code>f1</code> to view the token&rsquo;s
header.</p><p>Verify that a request to <code>/foo</code> with a valid JWT is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -o /dev/null -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> -w <span style=color:#4e9a06>&#34;%{http_code}\n&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/foo
</span></span></code></pre></div><p>A <code>200</code> HTTP response code should be returned.</p><p>Verify that requests to <code>/bar</code> are allowed <strong>without</strong> a JWT:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -o /dev/null -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -w <span style=color:#4e9a06>&#34;%{http_code}\n&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/bar
</span></span></code></pre></div><h3 id=grpcroute-1>GRPCRoute<a class=td-heading-self-link href=#grpcroute-1 aria-label="Heading self-link"></a></h3><p>Verify that requests to <code>yages</code>service are denied without a JWT:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Error invoking method <span style=color:#4e9a06>&#34;yages.Echo/Ping&#34;</span>: rpc error: <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> Unauthenticated <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> failed to query <span style=color:#204a87;font-weight:700>for</span> service descriptor <span style=color:#4e9a06>&#34;yages.Echo&#34;</span>: Jwt is missing
</span></span></code></pre></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><p><strong>Note:</strong> The above command decodes and returns the token&rsquo;s payload. You can replace <code>f2</code> with <code>f1</code> to view the token&rsquo;s
header.</p><p>Verify that a request to <code>yages</code> service with a valid JWT is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -H <span style=color:#4e9a06>&#34;authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;text&#34;</span>: <span style=color:#4e9a06>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the SecurityPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete securitypolicy/jwt-example
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bfcdc0cd514fecb25c8c98cac81a1cdb>2.3.9 - JWT Claim-Based Authorization</h1><p>This task provides instructions for configuring JWT claim-based authorization. JWT claim-based authorization checks if an incoming request has the required JWT claims before routing the request to a backend service.</p><p>Envoy Gateway introduces a new CRD called <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/security-policy/>SecurityPolicy</a> that allows the user to configure JWT claim-based authorization.</p><p>This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><h3 id=create-a-securitypolicy>Create a SecurityPolicy<a class=td-heading-self-link href=#create-a-securitypolicy aria-label="Heading self-link"></a></h3><p>Please note that the JWT claim-based authorization requires the JWT token to be present in the request. A JWT authentication must be configured in the same SecurityPolicy to validate the JWT token and extract the claims.</p><p>The below SecurityPolicy configuration allows requests with a valid JWT token that has the following claims:</p><ul><li><code>user.name</code> claim with the value <code>John Doe</code></li><li><code>user.roles</code> claim with the value <code>admin</code></li><li><code>scope</code> claim with the values <code>read</code>, <code>add</code>, and <code>modify</code></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: authorization-jwt-claim
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jwt:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    providers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      issuer: https://foo.bar.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      remoteJWKS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        uri: https://raw.githubusercontent.com/envoyproxy/gateway/refs/heads/main/examples/kubernetes/jwt/jwks.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  authorization:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    defaultAction: Deny
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: &#34;allow&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      action: Allow
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      principal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        jwt:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          provider: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          scopes: [&#34;read&#34;, &#34;add&#34;, &#34;modify&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          claims:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: user.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            values: [&#34;John Doe&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: user.roles
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            valueType: StringArray
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            values: [&#34;admin&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorization-jwt-claim</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwt</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://foo.bar.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>remoteJWKS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://raw.githubusercontent.com/envoyproxy/gateway/refs/heads/main/examples/kubernetes/jwt/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>authorization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>defaultAction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deny</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;allow&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Allow</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>principal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>jwt</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>scopes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;read&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;modify&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>claims</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>user.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;John Doe&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>user.roles</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>valueType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StringArray</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/authorization-jwt-claim -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Define a JWT token with the required claims.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>VALID_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImI1MjBiM2MyYzRiZDc1YTEwZTljZWJjOTU3NjkzM2RjIn0.eyJpc3MiOiJodHRwczovL2Zvby5iYXIuY29tIiwic3ViIjoiMTIzNDU2Nzg5MCIsInVzZXIiOnsibmFtZSI6IkpvaG4gRG9lIiwiZW1haWwiOiJqb2huLmRvZUBleGFtcGxlLmNvbSIsInJvbGVzIjpbImFkbWluIiwiZWRpdG9yIl19LCJwcmVtaXVtX3VzZXIiOnRydWUsImlhdCI6MTUxNjIzOTAyMiwic2NvcGUiOiJyZWFkIGFkZCBkZWxldGUgbW9kaWZ5In0.P36iAlmiRCC79OiB3vstF5Q_9OqUYAMGF3a3H492GlojbV6DcuOz8YIEYGsRSWc-BNJaBKlyvUKsKsGVPtYbbF8ajwZTs64wyO-zhd2R8riPkg_HsW7iwGswV12f5iVRpfQ4AG2owmdOToIaoch0aym89He1ZzEjcShr9olgqlAbbmhnk-namd1rP-xpzPnWhhIVI3mCz5hYYgDTMcM7qbokM5FzFttTRXAn5_Luor23U1062Ct_K53QArwxBvwJ-QYiqcBycHf-hh6sMx_941cUswrZucCpa-EwA3piATf9PKAyeeWHfHV9X-y8ipGOFg3mYMMVBuUZ1lBkJCik9f9kboRY6QzpOISARQj9PKMXfxZdIPNuGmA7msSNAXQgqkvbx04jMwb9U7eCEdGZztH4C8LhlRjgj0ZdD7eNbRjeH2F6zrWyMUpGWaWyq6rMuP98W2DWM5ZflK6qvT1c7FuFsWPvWLkgxQwTWQKrHdKwdbsu32Sj8VtUBJ0-ddEb&#34;</span>
</span></span></code></pre></div><p>Decode the JWT token to verify that it has the required claims.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>jq -R <span style=color:#4e9a06>&#39;split(&#34;.&#34;) | .[0],.[1] | @base64d | fromjson&#39;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;&lt;</span> <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>${</span><span style=color:#000>VALID_TOKEN</span><span style=color:#4e9a06>}</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>The decoded JWT token should look like the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;typ&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;JWT&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;alg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;RS256&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;kid&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;b520b3c2c4bd75a10e9cebc9576933dc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;iss&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;https://foo.bar.com&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;sub&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;1234567890&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;John Doe&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;email&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;john.doe@example.com&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>&#34;editor&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;premium_user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;iat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1516239022</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;scope&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;read add delete modify&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Send a request to the backend service with the valid JWT token:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#4e9a06>${</span><span style=color:#000>VALID_TOKEN</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>The request should be allowed and you should see the response from the backend service.</p><p>Define a JWT token without the required claims.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>INVALID_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImI1MjBiM2MyYzRiZDc1YTEwZTljZWJjOTU3NjkzM2RjIn0.eyJpc3MiOiJodHRwczovL2Zvby5iYXIuY29tIiwic3ViIjoiMTIzNDU2Nzg5MCIsInVzZXIiOnsibmFtZSI6IkFsaWNlIFNtaXRoIiwiZW1haWwiOiJhbGljZS5zbWl0aEBleGFtcGxlLmNvbSIsInJvbGVzIjpbImRldmVsb3BlciJdfSwicHJlbWl1bV91c2VyIjpmYWxzZSwiaWF0IjoxNTE2MjM5MDIyLCJzY29wZSI6InJlYWQgYWRkIGRlbGV0ZSJ9.Da547nNXzuQXm5E7LuLAiyFswXsW4RDhuitD_rpadtR7PTwzzOsJoqrVWJ_u1jJDaOTWIpLF4gwxDoY-Aoz_couzXzlAbECLs45ZFoc_UdffpfIbGKqTZx8VtwKuDLFsAeDDDqqx1flxFhvXHftJJdZYr1FgFz9u-absMmRU90DLmEZX3Hnyc8k8eBgeiu6vsWUD0-aNy8cWkFRbwRggkGmucFyUTG8Z1MY3iyH5E66W-ISoX8G9bzE9PTxVAAPDTvefD5iLJPSDJ8qV69OuMCJ8Dczq0L9Dd_w0sF-D1s9MTvexmGg4zBWluJ3r-pU9NHEdhqBypehp_yH8xF5Rt9AE7stZ4oPFZNyfrtkE-4IOnSEkMmzcC65g_rscn0ycerv4N5ZNpkr0x2IYYM4iGuo-ULv5Htnli3rffST45kx1XA8cdsrT1D0K3aPxdIxDIk8sTJf5-WVqRyo-bwxXXltwQLB9jCM_7QbTWQBYAJwUpi-0RW4jCl44-42gZnXf&#34;</span>
</span></span></code></pre></div><p>Decode the JWT token to verify that it does not have the required claims.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>jq -R <span style=color:#4e9a06>&#39;split(&#34;.&#34;) | .[0],.[1] | @base64d | fromjson&#39;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;&lt;</span> <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>${</span><span style=color:#000>INVALID_TOKEN</span><span style=color:#4e9a06>}</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>The decoded JWT token should look like the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;typ&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;JWT&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;alg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;RS256&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;kid&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;b520b3c2c4bd75a10e9cebc9576933dc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;iss&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;https://foo.bar.com&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;sub&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;1234567890&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Alice Smith&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;email&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;alice.smith@example.com&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>&#34;developer&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;premium_user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;iat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1516239022</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;scope&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;read add delete&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Send a request to the backend service with the invalid JWT token:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl  -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#4e9a06>${</span><span style=color:#000>INVALID_TOKEN</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>The request should be denied and you should see a <code>403 Forbidden</code> response.</p><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the SecurityPolicy and the ClientTrafficPolicy</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete securitypolicy/authorization-jwt-claim
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cd4a6c48858764adcec8ad515c66638b>2.3.10 - Mutual TLS: External Clients to the Gateway</h1><p>This task demonstrates how mutual TLS can be achieved between external clients and the Gateway.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt --certificate-authority<span style=color:#ce5c00;font-weight:700>=</span>example.com.crt
</span></span></code></pre></div><p>Store the CA Cert in another Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic example-ca-cert --from-file<span style=color:#ce5c00;font-weight:700>=</span>ca.crt<span style=color:#ce5c00;font-weight:700>=</span>example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for the client <code>client.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out client.example.com.csr -newkey rsa:2048 -nodes -keyout client.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=client.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in client.example.com.csr -out client.example.com.crt
</span></span></code></pre></div><p>Update the Gateway from the Quickstart to include an HTTPS listener that listens on port <code>443</code> and references the
<code>example-cert</code> Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><p>Create a <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> to enforce client validation using the CA Certificate as a trusted anchor.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-mtls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientValidation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      caCertificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: &#34;Secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: &#34;example-ca-cert&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enable-mtls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientValidation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caCertificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;example-ca-cert&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-02-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-02-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cert client.example.com.crt --key client.example.com.key <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com/get
</span></span></code></pre></div><p>Don&rsquo;t specify the client key and certificate in the above command, and ensure that the connection fails:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com/get
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cert client.example.com.crt --key client.example.com.key <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get
</span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3b80fcbcb0bf612daa582a6bd570dab9>2.3.11 - OIDC Authentication</h1><p>This task provides instructions for configuring <a href=https://openid.net/connect/>OpenID Connect (OIDC)</a> authentication.
OpenID Connect (OIDC) is an authentication standard built on top of OAuth 2.0.
It enables EG to rely on authentication that is performed by an OpenID Connect Provider (OP)
to verify the identity of a user.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#securitypolicy>SecurityPolicy</a> that allows the user to configure OIDC
authentication.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>EG OIDC authentication requires the redirect URL to be HTTPS. Follow the <a href=../secure-gateways>Secure Gateways</a> guide
to generate the TLS certificates and update the Gateway configuration to add an HTTPS listener.</p><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><p>Let&rsquo;s create an HTTPRoute that represents an application protected by OIDC.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames: [&#34;www.example.com&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the HTTPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/myapp -o yaml
</span></span></code></pre></div><h2 id=oidc-authentication-for-a-httproute>OIDC Authentication for a HTTPRoute<a class=td-heading-self-link href=#oidc-authentication-for-a-httproute aria-label="Heading self-link"></a></h2><p>OIDC can be configured at the Gateway level to authenticate all the HTTPRoutes that are associated with the Gateway with
the same OIDC configuration, or at the HTTPRoute level to authenticate each HTTPRoute with different OIDC configurations.</p><p>This section demonstrates how to configure OIDC authentication for a specific HTTPRoute.</p><h3 id=register-an-oidc-application>Register an OIDC application<a class=td-heading-self-link href=#register-an-oidc-application aria-label="Heading self-link"></a></h3><p>This task uses Google as the OIDC provider to demonstrate the configuration of OIDC. However, EG works with any OIDC
providers, including Auth0, Azure AD, Keycloak, Okta, OneLogin, Salesforce, UAA, etc.</p><p>Follow the steps in the <a href=https://developers.google.com/identity/protocols/oauth2/openid-connect>Google OIDC documentation</a> to register an OIDC application. Please make sure the
redirect URL is set to the one you configured in the SecurityPolicy that you will create in the step below. In this example,
the redirect URL is <code>https://www.example.com:8443/myapp/oauth2/callback</code>.</p><p>After registering the application, you should have the following information:</p><ul><li>Client ID: The client ID of the OIDC application.</li><li>Client Secret: The client secret of the OIDC application.</li></ul><h3 id=create-a-kubernetes-secret>Create a kubernetes secret<a class=td-heading-self-link href=#create-a-kubernetes-secret aria-label="Heading self-link"></a></h3><p>Next, create a kubernetes secret with the Client Secret created in the previous step. The secret is an Opaque secret,
and the Client Secret must be stored in the key &ldquo;client-secret&rdquo;.</p><p>Note: please replace the ${CLIENT_SECRET} with the actual Client Secret that you got from the previous step.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic my-app-client-secret --from-literal<span style=color:#ce5c00;font-weight:700>=</span>client-secret<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>CLIENT_SECRET</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><h3 id=create-a-securitypolicy>Create a SecurityPolicy<a class=td-heading-self-link href=#create-a-securitypolicy aria-label="Heading self-link"></a></h3><p><strong>Please notice that the <code>redirectURL</code> and <code>logoutPath</code> must match the target HTTPRoute.</strong> In this example, the target
HTTPRoute is configured to match the host <code>www.example.com</code> and the path <code>/myapp</code>, so the <code>redirectURL</code> must be prefixed
with <code>https://www.example.com:8443/myapp</code>, and <code>logoutPath</code> must be prefixed with<code>/myapp</code>, otherwise the OIDC authentication
will fail because the redirect and logout requests will not match the target HTTPRoute and therefore can&rsquo;t be processed
by the OAuth2 filter on that HTTPRoute.</p><p>Note: please replace the ${CLIENT_ID} in the below yaml snippet with the actual Client ID that you got from the OIDC provider.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: oidc-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  oidc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      issuer: &#34;https://accounts.google.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientID: &#34;${CLIENT_ID}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientSecret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: &#34;my-app-client-secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    redirectURL: &#34;https://www.example.com:8443/myapp/oauth2/callback&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    logoutPath: &#34;/myapp/logout&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oidc-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>oidc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://accounts.google.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;${CLIENT_ID}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;my-app-client-secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>redirectURL</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://www.example.com:8443/myapp/oauth2/callback&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logoutPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/myapp/logout&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/oidc-example -o yaml
</span></span></code></pre></div><h3 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h3><p>Port forward gateway port to localhost:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443
</span></span></code></pre></div><p>Put <a href=https://www.example.com>www.example.com</a> in the /etc/hosts file in your test machine, so we can use this host name to access the gateway from a browser:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>127.0.0.1 www.example.com
</span></span></code></pre></div><p>Open a browser and navigate to the <code>https://www.example.com:8443/myapp</code> address. You should be redirected to the Google
login page. After you successfully login, you should see the response from the backend service.</p><p>Clean the cookies in the browser and try to access <code>https://www.example.com:8443/foo</code> address. You should be able to see
this page since the path <code>/foo</code> is not protected by the OIDC policy.</p><h2 id=oidc-authentication-for-a-gateway>OIDC Authentication for a Gateway<a class=td-heading-self-link href=#oidc-authentication-for-a-gateway aria-label="Heading self-link"></a></h2><p>OIDC can be configured at the Gateway level to authenticate all the HTTPRoutes that are associated with the Gateway with
the same OIDC configuration, or at the HTTPRoute level to authenticate each HTTPRoute with different OIDC configurations.</p><p>This section demonstrates how to configure OIDC authentication for a Gateway.</p><h3 id=register-an-oidc-application-1>Register an OIDC application<a class=td-heading-self-link href=#register-an-oidc-application-1 aria-label="Heading self-link"></a></h3><p>If you haven&rsquo;t registered an OIDC application, follow the steps in the previous section to register an OIDC application.</p><h3 id=create-a-kubernetes-secret-1>Create a kubernetes secret<a class=td-heading-self-link href=#create-a-kubernetes-secret-1 aria-label="Heading self-link"></a></h3><p>If you haven&rsquo;t created a kubernetes secret, follow the steps in the previous section to create a kubernetes secret.</p><h3 id=create-an-httproute-with-a-different-subdomain>Create an HTTPRoute with a different subdomain<a class=td-heading-self-link href=#create-an-httproute-with-a-different-subdomain aria-label="Heading self-link"></a></h3><p>Let&rsquo;s create another HTTPRoute in the same Gateway, but with a different subdomain.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames: [&#34;foo.example.com&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;foo.example.com&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the HTTPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/foo -o yaml
</span></span></code></pre></div><h3 id=create-a-securitypolicy-1>Create a SecurityPolicy<a class=td-heading-self-link href=#create-a-securitypolicy-1 aria-label="Heading self-link"></a></h3><p>Create or update the SecurityPolicy to target the Gateway instead of the HTTPRoute. <strong>Please notice that the <code>redirectURL</code>
and <code>logoutPath</code> must match one of the HTTPRoutes associated with the Gateway.</strong> In this example, the target Gateway has
three HTTPRoutes associated with it, one with the host <code>www.example.com</code> and the path <code>/myapp</code>, one with the host
<code>www.example.com</code> and the path <code>/</code>, and one with the host <code>foo.example.com</code> and the path <code>/</code>. Any of these HTTPRoutes
can be used to match the <code>redirectURL</code> and <code>logoutPath</code>.</p><p>By default, the access token and ID token cookies are set to the host of the request, excluding subdomains. To allow the
token cookies to be shared across subdomains and prevent users from having to log in again when switching between subdomains,
the <code>cookieDomain</code> field needs to be set to the root domain. In this example, the root domain is <code>example.com</code>.</p><p>Note: if a <code>cookieDomain</code> is added to an existing SecurityPolicy, the cookies in the browser must be cleared before sending a new request to the Gateway, otherwise the cookies with the old subdomain will take precedence and be sent to the Gateway, causing the OIDC authentication to fail.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: oidc-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  oidc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      issuer: &#34;https://accounts.google.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientID: &#34;${CLIENT_ID}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientSecret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: &#34;my-app-client-secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    redirectURL: &#34;https://www.example.com:8443/myapp/oauth2/callback&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    logoutPath: &#34;/myapp/logout&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    cookieDomain: &#34;example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oidc-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>oidc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://accounts.google.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;${CLIENT_ID}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;my-app-client-secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>redirectURL</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://www.example.com:8443/myapp/oauth2/callback&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logoutPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/myapp/logout&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cookieDomain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get securitypolicy/oidc-example -o yaml
</span></span></code></pre></div><h3 id=update-the-listener-tls-certificate-to-support-multiple-subdomains>Update the Listener TLS certificate to support multiple subdomains<a class=td-heading-self-link href=#update-the-listener-tls-certificate-to-support-multiple-subdomains aria-label="Heading self-link"></a></h3><p>Create a multi-domain wildcard certificate for <code>*.example.com</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out wildcard.csr -newkey rsa:2048 -nodes -keyout wildcard.key -subj <span style=color:#4e9a06>&#34;/CN=*.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in wildcard.csr -out wildcard.crt
</span></span></code></pre></div><p>Replace the TLS certificate of the Gateway with the wildcard certificate.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret example-cert
</span></span><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>wildcard.key --cert<span style=color:#ce5c00;font-weight:700>=</span>wildcard.crt
</span></span></code></pre></div><h3 id=testing-1>Testing<a class=td-heading-self-link href=#testing-1 aria-label="Heading self-link"></a></h3><p>If you haven&rsquo;t done so, follow the steps in the previous section to port forward gateway port to localhost and put
<a href=https://www.example.com>www.example.com</a> in the /etc/hosts file in your test machine.</p><p>Also, put foo.example.com in the /etc/hosts file in your test machine.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>127.0.0.1 foo.example.com
</span></span></code></pre></div><p>Open a browser and navigate to the <code>https://www.example.com:8443/myapp</code> address. You should be redirected to the Google
login page. After you successfully login, you should see the response from the backend service.</p><p>You can also try to access <code>https://foo.example.com:8443</code> and <code>https://www.example.com:8443/bar</code> addresses. You should
be able to see the response from the backend service since these HTTPRoutes are also protected by the same OIDC config,
and the cookies are shared across subdomains.</p><h2 id=connect-to-an-oidc-provider-with-self-signed-certificate>Connect to an OIDC Provider with Self-Signed Certificate<a class=td-heading-self-link href=#connect-to-an-oidc-provider-with-self-signed-certificate aria-label="Heading self-link"></a></h2><p>In some scenarios, the OIDC provider may use a self-signed certificate. To connect to an OIDC provider with a self-signed certificate, you need to configure it using the <a href=../../../api/extension_types#backend>Backend</a> resource within the <a href=../../../api/extension_types#securitypolicy>SecurityPolicy</a>. Additionally, use the <a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a> to specify the CA certificate required to authenticate the OIDC provider.</p><p>The following example demonstrates how to configure the OIDC provider with a self-signed certificate.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: oidc-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  oidc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: backend-keycloak
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendSettings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        retry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          numRetries: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          perRetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            backOff:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              baseInterval: 1s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              maxInterval: 5s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          retryOn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            triggers: [&#34;5xx&#34;, &#34;gateway-error&#34;, &#34;reset&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      issuer: &#34;https://my.keycloak.com/realms/master&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      authorizationEndpoint: &#34;https://my.keycloak.com/realms/master/protocol/openid-connect/auth&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tokenEndpoint: &#34;https://my.keycloak.com/realms/master/protocol/openid-connect/token&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientID: &#34;${CLIENT_ID}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clientSecret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: &#34;my-app-client-secret&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    redirectURL: &#34;http://www.example.com/myapp/oauth2/callback&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    logoutPath: &#34;/myapp/logout&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-keycloak
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - fqdn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      hostname: &#39;my.keycloak.com&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTLSPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-btls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend-keycloak
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: &#34;443&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  validation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    caCertificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: backend-tls-certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    hostname: my.keycloak.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecurityPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oidc-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>oidc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-keycloak</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendSettings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>retry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>numRetries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>perRetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>backOff</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>baseInterval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>maxInterval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>5s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>retryOn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>triggers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;5xx&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;gateway-error&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;reset&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://my.keycloak.com/realms/master&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>authorizationEndpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://my.keycloak.com/realms/master/protocol/openid-connect/auth&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>tokenEndpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://my.keycloak.com/realms/master/protocol/openid-connect/token&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;${CLIENT_ID}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>clientSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;my-app-client-secret&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>redirectURL</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;http://www.example.com/myapp/oauth2/callback&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logoutPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/myapp/logout&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-keycloak</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>fqdn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;my.keycloak.com&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTLSPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy-btls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-keycloak</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;443&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>validation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>caCertificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend-tls-certificate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my.keycloak.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>For more information about <a href=../../../api/extension_types#backend>Backend</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a>, refer to the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/backend/>Backend Routing</a> and <a href=../backend-tls>Backend TLS: Gateway to Backend</a> tasks.</p><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the SecurityPolicy, the secret and the HTTPRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete securitypolicy/oidc-example
</span></span><span style=display:flex><span>kubectl delete secret/my-app-client-secret
</span></span><span style=display:flex><span>kubectl delete httproute/myapp
</span></span><span style=display:flex><span>kubectl delete httproute/foo
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-33f26d3ba9bd99b03e6a3c0ee1753a71>2.3.12 - Secure Gateways</h1><p>This task will help you get started using secure Gateways.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the Gateway from the Quickstart to include an HTTPS listener that listens on port <code>443</code> and references the
<code>example-cert</code> Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-01-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-01-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com/get
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get
</span></span></code></pre></div></div></div><h2 id=multiple-https-listeners>Multiple HTTPS Listeners<a class=td-heading-self-link href=#multiple-https-listeners aria-label="Heading self-link"></a></h2><p>Create a TLS cert/key for the additional HTTPS listener:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out foo.example.com.csr -newkey rsa:2048 -nodes -keyout foo.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=foo.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in foo.example.com.csr -out foo.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls foo-cert --key<span style=color:#ce5c00;font-weight:700>=</span>foo.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>foo.example.com.crt
</span></span></code></pre></div><p>Create another HTTPS listener on the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https-foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      hostname: foo.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: foo-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Update the HTTPRoute to route traffic for hostname <code>foo.example.com</code> to the example backend service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch httproute backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/hostnames/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value: foo.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><p>Follow the steps in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#testing>Testing section</a> to test connectivity to the backend app through both Gateway
listeners. Replace <code>www.example.com</code> with <code>foo.example.com</code> to test the new HTTPS listener.</p><h2 id=cross-namespace-certificate-references>Cross Namespace Certificate References<a class=td-heading-self-link href=#cross-namespace-certificate-references aria-label="Heading self-link"></a></h2><p>A Gateway can be configured to reference a certificate in a different namespace. This is allowed by a <a href=https://gateway-api.sigs.k8s.io/api-types/referencegrant/>ReferenceGrant</a>
created in the target namespace. Without the ReferenceGrant, a cross-namespace reference is invalid.</p><p>Before proceeding, ensure you can query the HTTPS backend service from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#testing>Testing section</a>.</p><p>To demonstrate cross namespace certificate references, create a ReferenceGrant that allows Gateways from the &ldquo;default&rdquo;
namespace to reference Secrets in the &ldquo;envoy-gateway-system&rdquo; namespace:</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ReferenceGrant
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  from:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  to:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReferenceGrant</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>to</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Delete the previously created Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret/example-cert
</span></span></code></pre></div><p>The Gateway HTTPS listener should now surface the <code>Ready: False</code> status condition and the example HTTPS backend should
no longer be reachable through the Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><p>Recreate the example Secret in the <code>envoy-gateway-system</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert -n envoy-gateway-system --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the Gateway HTTPS listener with <code>namespace: envoy-gateway-system</code>, for example:</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Terminate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>certificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The Gateway HTTPS listener status should now surface the <code>Ready: True</code> condition and you should once again be able to
query the HTTPS backend through the Gateway.</p><p>Lastly, test connectivity using the above <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#testing>Testing section</a>.</p><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the Secrets:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret/example-cert
</span></span><span style=display:flex><span>kubectl delete secret/foo-cert
</span></span></code></pre></div><h1 id=rsa--ecdsa-dual-stack-certificates>RSA + ECDSA Dual stack certificates<a class=td-heading-self-link href=#rsa--ecdsa-dual-stack-certificates aria-label="Heading self-link"></a></h1><p>This section gives a walkthrough to generate RSA and ECDSA derived certificates and keys for the Server, which can then be configured in the Gateway listener, to terminate TLS traffic.</p><h2 id=prerequisites-1>Prerequisites<a class=td-heading-self-link href=#prerequisites-1 aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Follow the steps in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#tls-certificates>TLS Certificates</a> section to generate self-signed RSA derived Server certificate and private key, and configure those in the Gateway listener configuration to terminate HTTPS traffic.</p><h2 id=pre-checks>Pre-checks<a class=td-heading-self-link href=#pre-checks aria-label="Heading self-link"></a></h2><p>While testing in <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#clusters-without-external-loadbalancer-support>Cluster without External LoadBalancer Support</a>, we can query the example app through Envoy proxy while enforcing an RSA cipher, as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-RSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span></code></pre></div><p>Since the Secret configured at this point is an RSA based Secret, if we enforce the usage of an ECDSA cipher, the call should fail as follows</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-ECDSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* Added www.example.com:8443:127.0.0.1 to DNS cache
</span></span><span style=display:flex><span>* Hostname www.example.com was found in DNS cache
</span></span><span style=display:flex><span>*   Trying 127.0.0.1:8443...
</span></span><span style=display:flex><span>* Connected to www.example.com <span style=color:#ce5c00;font-weight:700>(</span>127.0.0.1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>8443</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>* ALPN: offers h2
</span></span><span style=display:flex><span>* ALPN: offers http/1.1
</span></span><span style=display:flex><span>* Cipher selection: ECDHE-ECDSA-CHACHA20-POLY1305
</span></span><span style=display:flex><span>*  CAfile: example.com.crt
</span></span><span style=display:flex><span>*  CApath: none
</span></span><span style=display:flex><span>* <span style=color:#ce5c00;font-weight:700>(</span>304<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>OUT<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Client hello <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* error:1404B410:SSL routines:ST_CONNECT:sslv3 alert handshake failure
</span></span><span style=display:flex><span>* Closing connection <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>Moving forward in the doc, we will be configuring the existing Gateway listener to accept both kinds of ciphers.</p><h2 id=tls-certificates-1>TLS Certificates<a class=td-heading-self-link href=#tls-certificates-1 aria-label="Heading self-link"></a></h2><p>Reuse the CA certificate and key pair generated in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#tls-certificates>Secure Gateways</a> task and use this CA to sign both RSA and ECDSA Server certificates.
Note the CA certificate and key names are <code>example.com.crt</code> and <code>example.com.key</code> respectively.</p><p>Create an ECDSA certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl ecparam -noout -genkey -name prime256v1 -out www.example.com.ecdsa.key
</span></span><span style=display:flex><span>openssl req -new -SHA384 -key www.example.com.ecdsa.key -nodes -out www.example.com.ecdsa.csr -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -SHA384  -days <span style=color:#0000cf;font-weight:700>365</span> -in www.example.com.ecdsa.csr -CA example.com.crt -CAkey example.com.key -CAcreateserial -out www.example.com.ecdsa.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert-ecdsa --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.ecdsa.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.ecdsa.crt
</span></span></code></pre></div><p>Patch the Gateway with this additional ECDSA Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/1/tls/certificateRefs/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: example-cert-ecdsa
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing-1>Testing<a class=td-heading-self-link href=#testing-1 aria-label="Heading self-link"></a></h2><p>Again, while testing in Cluster without External LoadBalancer Support, we can query the example app through Envoy proxy while enforcing an RSA cipher, which should work as it did before:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-RSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS change cipher, Change cipher spec <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Finished <span style=color:#ce5c00;font-weight:700>(</span>20<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* SSL connection using TLSv1.2 / ECDHE-RSA-CHACHA20-POLY1305
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Additionally, querying the example app while enforcing an ECDSA cipher should also work now:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-ECDSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS change cipher, Change cipher spec <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Finished <span style=color:#ce5c00;font-weight:700>(</span>20<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* SSL connection using TLSv1.2 / ECDHE-ECDSA-CHACHA20-POLY1305
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h1 id=sni-based-certificate-selection>SNI based Certificate selection<a class=td-heading-self-link href=#sni-based-certificate-selection aria-label="Heading self-link"></a></h1><p>This sections gives a walkthrough to generate multiple certificates corresponding to different FQDNs. The same Gateway listener can then be configured to terminate TLS traffic for multiple FQDNs based on the SNI matching.</p><h2 id=prerequisites-2>Prerequisites<a class=td-heading-self-link href=#prerequisites-2 aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Follow the steps in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#tls-certificates>TLS Certificates</a> section to generate self-signed RSA derived Server certificate and private key, and configure those in the Gateway listener configuration to terminate HTTPS traffic.</p><h2 id=additional-configurations>Additional Configurations<a class=td-heading-self-link href=#additional-configurations aria-label="Heading self-link"></a></h2><p>Using the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#tls-certificates>TLS Certificates</a> section, we first generate additional Secret for another Host <code>www.sample.com</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=sample Inc./CN=sample.com&#39;</span> -keyout sample.com.key -out sample.com.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl req -out www.sample.com.csr -newkey rsa:2048 -nodes -keyout www.sample.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.sample.com/O=sample organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA sample.com.crt -CAkey sample.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.sample.com.csr -out www.sample.com.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create secret tls sample-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.sample.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.sample.com.crt
</span></span></code></pre></div><p>Note that all occurrences of <code>example.com</code> were just replaced with <code>sample.com</code></p><p>Next we update the <code>Gateway</code> configuration to accommodate the new Certificate which will be used to Terminate TLS traffic:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/1/tls/certificateRefs/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: sample-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Finally, we update the HTTPRoute to route traffic for hostname <code>www.sample.com</code> to the example backend service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch httproute backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/hostnames/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value: www.sample.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><h2 id=testing-2>Testing<a class=td-heading-self-link href=#testing-2 aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-04-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-04-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><p>Refer to the steps mentioned earlier under <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#testing>Testing in clusters with External LoadBalancer Support</a></p></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get -I
</span></span></code></pre></div><p>Similarly, query the sample app through the same Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.sample.com --resolve <span style=color:#4e9a06>&#34;www.sample.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert sample.com.crt https://www.sample.com:8443/get -I
</span></span></code></pre></div><p>Since the multiple certificates are configured on the same Gateway listener, Envoy was able to provide the client with appropriate certificate based on the SNI in the client request.</p></div></div><h2 id=customize-gateway-tls-parameters>Customize Gateway TLS Parameters<a class=td-heading-self-link href=#customize-gateway-tls-parameters aria-label="Heading self-link"></a></h2><p>In addition to enablement of TLS with Gateway-API, Envoy Gateway supports customizing TLS parameters.
To achieve this, the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicy>ClientTrafficPolicy</a> resource can be used to specify TLS parameters.
We will customize the minimum supported TLS version in this example to TLSv1.3.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enforce-tls-13
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    minVersion: &#34;1.3&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClientTrafficPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enforce-tls-13</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>minVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1.3&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=testing-tls-parameters>Testing TLS Parameters<a class=td-heading-self-link href=#testing-tls-parameters aria-label="Heading self-link"></a></h2><p>Attempt to connecting using an unsupported TLS version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.sample.com --resolve <span style=color:#4e9a06>&#34;www.sample.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert sample.com.crt --tlsv1.2 --tls-max 1.2 https://www.sample.com:8443/get -I
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* ALPN: curl offers h2,http/1.1
</span></span><span style=display:flex><span>* <span style=color:#ce5c00;font-weight:700>(</span>304<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>OUT<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Client hello <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* LibreSSL/3.3.6: error:1404B42E:SSL routines:ST_CONNECT:tlsv1 alert protocol version
</span></span><span style=display:flex><span>* Closing connection
</span></span><span style=display:flex><span>curl: <span style=color:#ce5c00;font-weight:700>(</span>35<span style=color:#ce5c00;font-weight:700>)</span> LibreSSL/3.3.6: error:1404B42E:SSL routines:ST_CONNECT:tlsv1 alert protocol version
</span></span></code></pre></div><p>The output shows that the connection fails due to an unsupported TLS protocol version used by the client. Now, connect
to the Gateway without specifying a client version, and note that the connection is established with TLSv1.3.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.sample.com --resolve <span style=color:#4e9a06>&#34;www.sample.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert sample.com.crt https://www.sample.com:8443/get -I
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* SSL connection using TLSv1.3 / AEAD-CHACHA20-POLY1305-SHA256 / <span style=color:#ce5c00;font-weight:700>[</span>blank<span style=color:#ce5c00;font-weight:700>]</span> / UNDEF
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-56db013a9f84ee7b68c608b1f725c45f>2.3.13 - Threat Model</h1><h1 id=envoy-gateway-threat-model-and-end-user-recommendations>Envoy Gateway Threat Model and End User Recommendations<a class=td-heading-self-link href=#envoy-gateway-threat-model-and-end-user-recommendations aria-label="Heading self-link"></a></h1><h2 id=about>About<a class=td-heading-self-link href=#about aria-label="Heading self-link"></a></h2><p>This work was performed by <a href=https://control-plane.io/>ControlPlane</a> and commissioned by the <a href=https://www.linuxfoundation.org/>Linux Foundation</a>. ControlPlane is a global cloud native and open source cybersecurity consultancy, trusted as the partner of choice in securing: multinational banks; major public clouds; international financial institutions; critical national infrastructure programs; multinational oil and gas companies, healthcare and insurance providers; and global media firms.</p><h2 id=threat-modelling-team>Threat Modelling Team<a class=td-heading-self-link href=#threat-modelling-team aria-label="Heading self-link"></a></h2><p>James Callaghan, Torin van den Bulk, Eduardo Olarte</p><h2 id=reviewers>Reviewers<a class=td-heading-self-link href=#reviewers aria-label="Heading self-link"></a></h2><p>Arko Dasgupta, Matt Turner, Zack Butcher, Marco De Benedictis</p><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>As we embrace the proliferation of microservice-based architectures in the cloud-native landscape, simplicity in setup and configuration becomes paramount as DevOps teams face the challenge of choosing between numerous similar technologies. One such choice which every team deploying to Kubernetes faces is what to use as an ingress controller. With a plethora of options available, and the existence of vendor-specific annotations leading to small inconsistencies between implementations, the <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> project was introduced by the SIG-NETWORK community, with the goal of eventually replacing the Ingress resource.</p><p>Envoy Gateway is configured by Gateway API resources, and serves as an intuitive and feature-rich wrapper over the widely acclaimed Envoy Proxy. With a convenient setup based on Kubernetes (K8s) manifests, Envoy Gateway streamlines the management of Envoy Proxy instances in an edge-proxy setting, reducing the operational overhead of managing low-level Envoy configurations. Envoy Gateway benefits cloud-native DevOps teams through its role-oriented configuration, providing granular control based on Role-Based Access Control (RBAC) principles. These features form the basis of our exploration into Envoy Gateway and the rich feature set it brings to the table.</p><p>In this threat model, we aim to provide an analysis of Envoy Gateway&rsquo;s design components and their capabilities (at version 1.0) through a threat-driven approach. It should be noted that this does not constitute a security audit of the Envoy Gateway project, but instead focuses on different possible deployment topologies for Envoy Gateway with the goal of deriving recommendations and best practice guidance for end users.</p><p>The Envoy Gateway project recommends a <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/deployment-mode/#multi-tenancy>multi-tenancy model</a> whereby each tenant deploys their own Envoy Gateway controller in a namespace which they own. We will also explore the implications and risks associated with multiple tenants using a shared controller.</p><h3 id=scope>Scope<a class=td-heading-self-link href=#scope aria-label="Heading self-link"></a></h3><p>The primary focus of this threat model is to identify and assess security risks associated with deploying and operating Envoy Gateway within a multi-tenant Kubernetes (K8s) cluster. This model aims to provide a comprehensive understanding of the system, its transmission points, and potential vulnerabilities to enumerated threats.</p><h3 id=in-scope>In Scope<a class=td-heading-self-link href=#in-scope aria-label="Heading self-link"></a></h3><p><strong>Envoy Gateway</strong>: As the primary focus of this threat model, all aspects of Envoy Gateway, including its configuration, deployment, and operation will be analysed. This includes how the gateway manages TLS certificates, authentication, service-to-service traffic routing, and more.</p><p><strong>Kubernetes Cluster</strong>: Configuration and operation of the underlying Kubernetes cluster, including how it manages network policies, access control, and resource isolation for different namespaces/tenants in relation to Envoy will be considered.</p><p><strong>Tenant Workloads</strong>: Tenant workloads (and the pods they run on) will be considered, focusing on how they interact with the Envoy Gateway and potential vulnerabilities that could be exploited.</p><h4 id=out-of-scope>Out of Scope<a class=td-heading-self-link href=#out-of-scope aria-label="Heading self-link"></a></h4><p>This threat model will not consider security risks associated with the underlying infrastructure (e.g., EC2 compute instances and S3 buckets) or non-Envoy related components within the Kubernetes Cluster. It will focus solely on the Envoy Gateway and its interaction with the Kubernetes cluster and tenant workloads.</p><p>Implementation of Envoy Gateway as an egress traffic controller is out of scope for this threat model and will not be considered in the report&rsquo;s findings.</p><h3 id=related-resources>Related Resources<a class=td-heading-self-link href=#related-resources aria-label="Heading self-link"></a></h3><p><a href=https://blog.envoyproxy.io/introducing-envoy-gateway-ad385cc59532>Introducing Envoy Gateway</a></p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/security/threat_model#threat-model>Envoy Proxy Threat Model</a></p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/best_practices/edge#best-practices-edge>Configuring Envoy as an Edge Proxy</a></p><p><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/deployment-mode/>Envoy Gateway Deployment Mode</a></p><p><a href=https://gateway-api.sigs.k8s.io/concepts/security-model/>Kubernetes Gateway API Security Model</a></p><h2 id=architecture-overview>Architecture Overview<a class=td-heading-self-link href=#architecture-overview aria-label="Heading self-link"></a></h2><h3 id=summary>Summary<a class=td-heading-self-link href=#summary aria-label="Heading self-link"></a></h3><p>To provide an in-depth look into both the system design and end-user deployment of Envoy Gateway, we will be focusing on the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/threat-model/#deployment-architecture-diagram>Deployment Architecture Diagram</a> below.</p><p>The Deployment Architecture Diagram provides a high-level model of an end-user deployment of Envoy Gateway. For simplicity, we will look at different deployment topologies on a single multi-tenant Kubernetes cluster. Envoy Gateway operates as an edge proxy within this environment, handling the traffic flow between external interfaces and services within the cluster. The example will use two Envoy Gateway controllers - one dedicated controller for a single tenant, and one shared controller for two other tenants. Each Envoy Gateway controller will accept a single GatewayClass resource.</p><h3 id=deployment-architecture-diagram>Deployment Architecture Diagram<a class=td-heading-self-link href=#deployment-architecture-diagram aria-label="Heading self-link"></a></h3><p>As Envoy Gateway implements the <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/>Kubernetes GatewayAPI</a>, this threat model will focus on the key objects in the Gateway API resource model:</p><ol><li><p><strong>GatewayClass:</strong> defines a set of gateways with a commonconfiguration and behaviour. It is a cluster scoped resource.</p></li><li><p><strong>Gateway:</strong> requests a point where traffic can be translated to Services within the cluster.</p></li><li><p><strong>Routes:</strong> describe how traffic coming via the Gateway maps to theServices.</p></li></ol><p>At the time of writing, Envoy Gateway only supports a Kubernetes provider. As such, we will consider a reference architecture where multiple teams are working on the same Kubernetes cluster within different namespaces (Tenant A, B, & C). We will assume that some teams have similar security and performance needs, and a decision has been made to use a shared Gateway. However, we will also consider the case that some teams require dedicated Gateways, perhaps for compliance reasons or requirements driven by an internal threat model.</p><p>We will consider the following organisational roles, as per the <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/>Gateway API security model</a>:</p><ol><li><p><strong>Infrastructure provider</strong>: The infrastructure provider (infra) is responsible for the overall environment that the cluster(s) are operating in. Examples include: the cloud provider (AWS, Azure, GCP, &mldr;) or the PaaS provider in a company.</p></li><li><p><strong>Cluster operator</strong>: The cluster operator (ops) is responsible for administration of entire clusters. They manage policies, network access, application permissions.</p></li><li><p><strong>Application developer</strong>: The application developer (dev) is responsible for defining their application configuration (e.g. timeouts, request matching/filter) and Service composition (e.g. path routing to backends).</p></li><li><p><strong>Application admin</strong>: The application admin has administrative access to some namespaces within a cluster, but not the cluster as a whole.</p></li></ol><p>Our threat model will be based on the high-level setup shown below, where Envoy is used in an edge-proxy scenario:</p><p><img alt=Architecture src=/img/architecture_threat_model.png></p><p>The following use cases will be considered, in line with the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Envoy Gateway tasks</a>:</p><ol><li>Routing and controlling traffic, including:
a. HTTP<br>b. TCP<br>c. UDP<br>d. gRPC<br>e.TLS passthrough</li><li>TLS termination</li><li>Request Authentication</li><li>Rate Limiting</li></ol><h2 id=key-assumptions>Key Assumptions<a class=td-heading-self-link href=#key-assumptions aria-label="Heading self-link"></a></h2><p>This section outlines the foundational premises that shape our analysis and recommendations for the deployment and management of Envoy Gateway within an organisation. The key assumptions are as follows:</p><p><strong>1. Kubernetes Provider</strong>: For the purposes of this analysis, we assume that a K8s provider will be used to host the cluster.</p><p><strong>2. Multi-tenant cluster</strong>: In order to produce a broad set of recommendations, it is assumed that within the single cluster, there is:</p><ul><li><p>A dedicated cluster operation (ops) team responsible for maintaining the core cluster infrastructure.</p></li><li><p>Multiple application teams who wish to define their own Gateway resources, which will route traffic to their respective applications.</p></li></ul><p><strong>3. Soft multi-tenancy model</strong>: It is assumed that co-tenants will have some level of trust between themselves, and will not act in an overtly hostile manner to each other.</p><p><strong>4. Ingress Control</strong>: It&rsquo;s assumed that Envoy Gateway is the only ingress controller in the K8s cluster as multiple controllers can lead to complex routing challenges and introduce out-of-scope security vulnerabilities.</p><p><strong>5. Container Security</strong>: This threat model focuses on evaluating the security of the Envoy Gateway and Envoy Proxy images. All other container images running in tenant clusters, not associated with the edge proxy deployment, are assumed to be secure and obtained from trusted registries such as Docker Hub or Google Container Registry (GCR).</p><p><strong>6. Cloud Provider Security</strong>: It is assumed that the K8s cluster is running on secure cloud infrastructure provided by a trusted Cloud Service Provider (CSP) such as AWS, GCP, or Azure Cloud.</p><h2 id=data>Data<a class=td-heading-self-link href=#data aria-label="Heading self-link"></a></h2><h3 id=data-dictionary>Data Dictionary<a class=td-heading-self-link href=#data-dictionary aria-label="Heading self-link"></a></h3><p>Ultimately, the data of interest in a threat model is the business data processed by the system in question. However, in the case of this threat model, we are looking at a generic deployment architecture involving Envoy Gateway in order to draw out a set of generalised threats which can be considered by teams looking to adopt an implementation of Gateway API. As such, we do not know the business impacts of a compromise of confidentiality, integrity or availability that would typically be captured in a data impact assessment. Instead, will we base our threat assessment on high-level groupings of data structures used in the configuration and operation of the general use cases considered (e.g. HTTP routing, TLS termination, request authentication etc.). We will then assign a confidentiality, integrity and availability impact based on a worst-case scenario of how each compromise could potentially affect business data processed by the generic deployment.</p><table><thead><tr><th>Data Name / Type</th><th>Notes</th><th>Confidentiality</th><th>Integrity</th><th>Availability</th></tr></thead><tbody><tr><td>Static Configuration Data</td><td>Static configuration data is used to configure Envoy Gateway at startup. This data structure allows for a Provider to be set, which Envoy Gateway calls to establish its runtime configuration, resolve services and persist data. Unauthorised modification of static configuration data could enable the Envoy Gateway admin interface to be configured, logging parameters to be modified, global rate limiting configuration to be misconfigured, or malicious extensions registered for the Envoy Gateway Control Plane. A compromise of confidentiality could potentially give an attacker some useful reconnaissance information. A compromise of the availability of this information at startup time would result in Envoy Gateway starting with default parameters.</td><td>Medium</td><td>High</td><td>Low</td></tr><tr><td>Dynamic Configuration Data</td><td>Dynamic configuration data represents the desired state of the Data Plane, and is defined through Envoy Gateway and Gateway API Kubernetes resources. Unauthorised modification of this data could lead to vulnerabilities in an organisation’s Data Plane infrastructure via misconfiguration of an EnvoyProxy custom resource. Misconfiguration of Gateway API objects such as HTTPRoutes or TLSRoutes could result in traffic being directed to incorrect backends. A compromise of confidentiality could potentially give an attacker some useful reconnaissance information. A compromise of the availability of this information could result in tenant application traffic not being routable until the configuration is recovered and reapplied.</td><td>Medium</td><td>High</td><td>Medium</td></tr><tr><td>TLS Private Keys</td><td>TLS Private Keys, typically in PEM format, are used to initiate secure connections and encrypt communications. In the context of this threat model, private keys will be associated with the server side of an inbound TLS connection being terminated at a secure gateway configured through Envoy Gateway. Unauthorised exposure could lead to security threats such as person-in-the-middle attacks, whereby the confidentiality or integrity of business data could be compromised. A compromise of integrity may lead to similar consequences if an attacker could insert their own key material. An availability compromise could lead to tenant services being unavailable until new key material is generated and an appropriate CSR submitted.</td><td>High</td><td>High</td><td>Medium</td></tr><tr><td>TLS Certificates</td><td>X.509 certificates represent the binding of a public key (associated with the private key described above) to an identity in a TLS handshake. If an attacker could compromise the integrity of a certificate, they may be able to bind the identity of a TLS termination point to a key pair under their control, enabling person-in-the middle attacks. An availability compromise could lead to tenant services being unavailable until new key material is generated and an appropriate CSR submitted.</td><td>Low</td><td>High</td><td>Medium</td></tr><tr><td>JWKs</td><td>JWK (JSON Web Key) containing a public key used to validate JWTs for the client authentication use case considered in this threat model. If an attacker could compromise the integrity of a JWK or JSON web key set (JWKS), they could potentially authenticate to a service maliciously. Unavailability of an endpoint exposing JWKs could lead to client requests which require authentication being denied.</td><td>Low</td><td>High</td><td>Medium</td></tr><tr><td>JWTs</td><td>JWTs, formatted as compact, URL-safe JSON data structures, are utilised for the client authentication use case considered in this threat model. Maintaining their confidentiality and integrity is vital to prevent unauthorised access and ensure correct user identification.</td><td>High</td><td>High</td><td>Low</td></tr><tr><td>OIDC credentials</td><td>In OIDC authentication scenarios, the application credentials are represented by a client ID and a client secret. A compromise of its confidentiality or integrity could allow malicious actors to impersonate the application, potentially being able to access resources on behalf of the application and request ID tokens on behalf of users. Unavailability of this data would produce a rejection of the requests coming from legitimate users.</td><td>High</td><td>High</td><td>Medium</td></tr><tr><td>Basic authentiation password hashes</td><td>In basic authentication scenarios, passwords are stored as Kubernetes secrets in <a href=https://httpd.apache.org/docs/current/programs/htpasswd.html>htpasswd</a> format, where each entry is formed by the username and the hashed password. A compromise of these credentials&rsquo; confidentiality and integrity could lead to unauthorised access to the application. Unavailability of these credentials will cause login failures from the application users.</td><td>High</td><td>High</td><td>Medium</td></tr></tbody></table><h3 id=cia-impact-assessment>CIA Impact Assessment<a class=td-heading-self-link href=#cia-impact-assessment aria-label="Heading self-link"></a></h3><table><thead><tr><th>Priority</th><th>Description</th></tr></thead><tbody><tr><td><strong>Confidentiality</strong></td><td></td></tr><tr><td>High</td><td>Compromise of sensitive client data</td></tr><tr><td>Medium</td><td>Information leaked which could be useful for attacker reconnaissance</td></tr><tr><td>Low</td><td>Non-sensitive information leakage</td></tr><tr><td><strong>Integrity</strong></td><td></td></tr><tr><td>High</td><td>Compromise of source code repositories and gateway deployments</td></tr><tr><td>Medium</td><td>Traffic routing fails due to misconfiguration / invalid configuration</td></tr><tr><td>Low</td><td>Non-critical operation is blocked due to misconfiguration / invalid configuration</td></tr><tr><td><strong>Availability</strong></td><td></td></tr><tr><td>High</td><td>Large scale DoS</td></tr><tr><td>Medium</td><td>Tenant application is blocked for a significant period</td></tr><tr><td>Low</td><td>Tenant application is blocked for a short period</td></tr></tbody></table><h3 id=data-flow-diagrams>Data Flow Diagrams<a class=td-heading-self-link href=#data-flow-diagrams aria-label="Heading self-link"></a></h3><p>The Data Flow Diagrams (DFDs) below describe the flow of data between the various processes, entities and data stores in a system, as well as the trust boundaries between different user roles and network interfaces. The DFDs are drawn at two different levels, starting at L0 (high-level system view) and increasing in granularity (to L1).</p><h3 id=dfd-l0>DFD L0<a class=td-heading-self-link href=#dfd-l0 aria-label="Heading self-link"></a></h3><p><img alt="DFD L0" src=/img/DFDL0.png></p><h3 id=dfd-l1>DFD L1<a class=td-heading-self-link href=#dfd-l1 aria-label="Heading self-link"></a></h3><p><img alt="DFD L1" src=/img/DFDL1.png></p><h2 id=key-threats-and-recommendations>Key Threats and Recommendations<a class=td-heading-self-link href=#key-threats-and-recommendations aria-label="Heading self-link"></a></h2><p>The scope of this threat model led to us categorising threats into priorities of High, Medium or Low; notably in a production implementation some of the threats&rsquo; prioritisation may be upgraded or downgraded depending on the business context and data classification.</p><h3 id=risk-vs-threat>Risk vs. Threat<a class=td-heading-self-link href=#risk-vs-threat aria-label="Heading self-link"></a></h3><p>For every finding, the risk and threat are stated. Risk defines the potential for negative outcome while threat defines the event that causes the negative outcome.</p><h3 id=threat-categorization>Threat Categorization<a class=td-heading-self-link href=#threat-categorization aria-label="Heading self-link"></a></h3><p>Throughout this threat model, we categorised threats into different areas based on their origin and the segment of the system that they impact. Here&rsquo;s an overview of each category:</p><p><strong>Container Security (CS)</strong>: These threats are general to containerised applications. Therefore, they are not associated with Envoy Gateway or the Gateway API and could occur in most containerised workloads. They can originate from misconfigurations or vulnerabilities in the orchestrator or the container.</p><p><strong>Gateway API (GW)</strong>: These are threats related to the Gateway API that could affect any of its implementations. Malicious actors could benefit from misconfigurations or excessive permissions on the Gateway API resources (e.g. xRoutes or Gateways) to compromise the confidentiality, integrity, or availability of the application.</p><p><strong>Envoy Gateway (EG)</strong>: These threats are associated with specific configurations or features from Envoy Gateway or Envoy Proxy. If not set properly, these features could be leveraged to gain unauthorised access to protected resources.</p><h3 id=threat-actors>Threat Actors<a class=td-heading-self-link href=#threat-actors aria-label="Heading self-link"></a></h3><p>In order to provide a realistic set of threats that is applicable to most organisations, we de-scoped the most advanced and hard to mitigate threat actors as described below:</p><h4 id=in-scope-threat-actors>In Scope Threat Actors<a class=td-heading-self-link href=#in-scope-threat-actors aria-label="Heading self-link"></a></h4><p>When considering internal threat actors, we chose to follow the <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/>security model</a> of the Kubernetes Gateway API.</p><h5 id=internal-attacker>Internal Attacker<a class=td-heading-self-link href=#internal-attacker aria-label="Heading self-link"></a></h5><ul><li><p>Cluster Operator: The cluster operator (ops) is responsible for administration of entire clusters. They manage policies, network access, application permissions.</p></li><li><p>Application Developer: The application developer (dev) is responsible for defining their application configuration (e.g. timeouts, request matching/filter) and Service composition (e.g. path routing to backends).</p></li><li><p>Application Administrator: The application admin has administrative access to some namespaces within a cluster, but not the cluster as a whole.</p></li></ul><h5 id=external-attacker>External Attacker<a class=td-heading-self-link href=#external-attacker aria-label="Heading self-link"></a></h5><ul><li><p>Vandal: Script kiddie, trespasser</p></li><li><p>Motivated Individual: Political activist, thief, terrorist</p></li><li><p>Organised Crime: Syndicates, state-affiliated groups</p></li></ul><h4 id=out-of-scope-threat-actors>Out of Scope Threat Actors<a class=td-heading-self-link href=#out-of-scope-threat-actors aria-label="Heading self-link"></a></h4><h5 id=external-actors>External Actors<a class=td-heading-self-link href=#external-actors aria-label="Heading self-link"></a></h5><ul><li><p>Infrastructure Provider: The infrastructure provider (infra) is responsible for the overall environment that the cluster(s) are operating in. Examples include: the cloud provider, or the PaaS provider in a company.</p></li><li><p>Cloud Service Insider: Employee, external contractor, temporary worker</p></li><li><p>Foreign Intelligence Services (FIS): Nation states</p></li></ul><h2 id=high-priority-findings>High Priority Findings<a class=td-heading-self-link href=#high-priority-findings aria-label="Heading self-link"></a></h2><h3 id=egtm-001-usage-of-self-signed-certificates>EGTM-001 Usage of self-signed certificates<a class=td-heading-self-link href=#egtm-001-usage-of-self-signed-certificates aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-001</td><td>EGTM-GW-001</td><td>Gateway API</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: Self-signed certificates (which do not comply with PKI best practices) could lead to unauthorised access to the private key associated with the certificate used for inbound TLS termination at Envoy Proxy, compromising the confidentiality and integrity of proxied traffic.</p><p><strong>Threat</strong>: Compromise of the private key associated with the certificate used for inbound TLS terminating at Envoy Proxy.</p><p><strong>Recommendation</strong>: The Envoy Gateway quickstart demonstrates how to set up a Secure Gateway using an example where a self-signed root certificate is created using openssl. As stated in the Envoy Gateway documentation, this is not a suitable configuration for Production usage. It is recommended that PKI best practices are followed, whereby certificates are signed by an Intermediary CA which sits underneath an organisational 'offline' Root CA.</p><p>PKI best practices should also apply to the management of client certificates when using mTLS. The Envoy Gateway <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/mutual-tls/>mTLS</a> task shows how to set up client certificates using self-signed certificates. In the same way as gateway certificates and, as mentioned in the documentation, this configuration should not be used in production environments.</p><h3 id=egtm-002-private-keys-are-stored-as-kubernetes-secrets>EGTM-002 Private keys are stored as Kubernetes secrets<a class=td-heading-self-link href=#egtm-002-private-keys-are-stored-as-kubernetes-secrets aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-002</td><td>EGTM-CS-001</td><td>Container Security</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor could compromise the Kubernetes secret containing the Envoy private key, allowing the attacker to decrypt Envoy Proxy traffic, compromising the confidentiality of proxied traffic.</p><p><strong>Threat</strong>: Kubernetes secret containing the Envoy private key is compromised and used to decrypt proxied traffic.</p><p><strong>Recommendation</strong>: Certificate management best practices mandate short-lived key material where practical, meaning that a mechanism for rotation of private keys and certificates is required, along with a way for certificates to be mounted into Envoy containers. If Kubernetes secrets are used, when a certificate expires, the associated secret must be updated, and Envoy containers must be redeployed. Instead of a manual configuration, it is recommended that <a href=https://github.com/cert-manager/cert-manager>cert-manager</a> is used.</p><h3 id=egtm-004-usage-of-clusterroles-with-wide-permissions>EGTM-004 Usage of ClusterRoles with wide permissions<a class=td-heading-self-link href=#egtm-004-usage-of-clusterroles-with-wide-permissions aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-004</td><td>EGTM-K8-002</td><td>Container Security</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor could abuse misconfigured RBAC to access the Envoy Gateway ClusterRole (envoy-gateway-role) and use it to expose all secrets across the cluster, thus compromising the confidentiality and integrity of tenant data.</p><p><strong>Threat</strong>: Compromised Envoy Gateway or misconfigured ClusterRoleBinding (envoy-gateway-rolebinding) to Envoy Gateway ClusterRole (envoy-gateway-role), provides access to resources and secrets in different namespaces.</p><p><strong>Recommendation</strong>: Users should be aware that Envoy Gateway uses a ClusterRole (envoy-gateway-role) when deployed via the Helm chart, to allow management of Envoy Proxies across different namespaces. This ClusterRole is powerful and includes the ability to read secrets in namespaces which may not be within the purview of Envoy Gateway.</p><p>Kubernetes best-practices involve restriction of ClusterRoleBindings, with the use of RoleBindings where possible to limit access per namespace by specifying the namespace in metadata. Namespace isolation reduces the impact of compromise from cluster-scoped roles. Ideally, fine-grained K8s roles should be created per the principle of least privilege to ensure they have the minimum access necessary for role functions.</p><p>The pull request #<a href=https://github.com/envoyproxy/gateway/pull/1656>1656</a> introduced the use of Roles and RoleBindings in <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#kuberneteswatchmode>namespaced mode</a>. This feature can be leveraged to reduce the amount of permissions required by the Envoy Gateway.</p><h3 id=egtm-007-misconfiguration-of-envoy-gateway-dynamic-config>EGTM-007 Misconfiguration of Envoy Gateway dynamic config<a class=td-heading-self-link href=#egtm-007-misconfiguration-of-envoy-gateway-dynamic-config aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-007</td><td>EGTM-EG-002</td><td>Envoy Gateway</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor could exploit misconfigured Kubernetes RBAC to create or modify Gateway API resources with no business need, potentially leading to the compromise of the confidentiality, integrity, and availability of resources and traffic within the cluster.</p><p><strong>Threat</strong>: Unauthorised creation or misconfiguration of Gateway API resources by a threat actor with cluster-scoped access.</p><p><strong>Recommendation</strong>: Configure the apiGroup and resource fields in RBAC policies to restrict access to <a href=https://gateway-api.sigs.k8s.io/>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a> resources. Enable namespace isolation by using the namespace field, preventing unauthorised access to gateways in other namespaces.</p><h3 id=egtm-009-co-tenant-misconfigures-resource-across-namespaces>EGTM-009 Co-tenant misconfigures resource across namespaces<a class=td-heading-self-link href=#egtm-009-co-tenant-misconfigures-resource-across-namespaces aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-009</td><td>EGTM-GW-002</td><td>Gateway API</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a co-tenant misconfigures Gateway or Route resources, compromising the confidentiality, integrity, and availability of routed traffic through Envoy Gateway.</p><p><strong>Threat</strong>: Malicious or accidental co-tenant misconfiguration of Gateways and Routes associated with other application teams.</p><p><strong>Recommendation</strong>: Dedicated Envoy Gateways should be provided to each tenant within their respective namespace. A one-to-one relationship should be established between GatewayClass and Gateway resources, meaning that each tenant namespace should have their own GatewayClass watched by a unique Envoy Gateway Controller as defined here in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/deployment-mode/>Deployment Mode</a> documentation.</p><p>Application Admins should have write permissions on the Gateway resource, but only in their specific namespaces, and Application Developers should only hold write permissions on Route resources. To enact this access control schema, follow the <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/#write-permissions-for-advanced-4-tier-model>Write Permissions for Advanced 4 Tier Model</a> described in the Kubernetes Gateway API security model. Examples of secured gateway-route topologies can be found <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#attaching-routes-to-gateways>here</a> within the Kubernetes Gateway API docs.</p><p>Optionally, consider a GitOps model, where only the GitOps operator has the permission to deploy or modify custom resources in production.</p><h3 id=egtm-014-malicious-image-admission>EGTM-014 Malicious image admission<a class=td-heading-self-link href=#egtm-014-malicious-image-admission aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-014</td><td>EGTM-CS-006</td><td>Container Security</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a supply chain attack on Envoy Gateway results in an arbitrary compromise of the confidentiality, integrity or availability of tenant data.</p><p><strong>Threat</strong>: Supply chain threat actor introduces malicious code into Envoy Gateway or Proxy.</p><p><strong>Recommendation</strong>: The Envoy Gateway project should continue to work towards conformance with supply-chain security best practices throughout the project lifecycle (for example, as set out in the <a href=https://github.com/cncf/tag-security/blob/main/supply-chain-security/supply-chain-security-paper/CNCF_SSCP_v1.pdf>CNCF Software Supply Chain Best Practices Whitepaper</a>). Adherence to <a href=https://slsa.dev/>Supply-chain Levels for Software Artefacts</a> (SLSA) standards is crucial for maintaining the security of the system. Employ version control systems to monitor the source and build platforms and assign responsibility to a specific stakeholder.</p><p>Integrate a supply chain security tool such as Sigstore, which provides native capabilities for signing and verifying container images and software artefacts. <a href=https://www.cisa.gov/sbom>Software Bill of Materials</a> (SBOM), <a href=https://www.ntia.gov/files/ntia/publications/vex_one-page_summary.pdf>Vulnerability Exploitability eXchange</a> (VEX), and signed artefacts should also be incorporated into the security protocol.</p><h3 id=egtm-020-out-of-date-or-misconfigured-envoy-proxy-image>EGTM-020 Out of date or misconfigured Envoy Proxy image<a class=td-heading-self-link href=#egtm-020-out-of-date-or-misconfigured-envoy-proxy-image aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-020</td><td>EGTM-CS-009</td><td>Container Security</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor exploits an Envoy Proxy vulnerability to remote code execution (RCE) due to out of date or misconfigured Envoy Proxy pod deployment, compromising the confidentiality and integrity of Envoy Proxy along with the availability of the proxy service.</p><p><strong>Threat</strong>: Deployment of an Envoy Proxy or Gateway image containing exploitable CVEs.</p><p><strong>Recommendation</strong>: Always use the latest version of the Envoy Proxy image. Regularly check for updates and patch the system as soon as updates become available. Implement a CI/CD pipeline that includes security checks for images and prevents deployment of insecure configurations. A suitable tool should be chosen to provide container vulnerability scanning to mitigate the risk of known vulnerabilities.</p><p>Utilise the <a href=https://kubernetes.io/docs/concepts/security/pod-security-admission/>Pod Security Admission</a> controller to enforce <a href=https://kubernetes.io/docs/concepts/security/pod-security-standards/>Pod Security Standards</a> and configure the <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>pod security context</a> to limit its capabilities per the principle of least privilege.</p><h3 id=egtm-022-credentials-are-stored-as-kubernetes-secrets>EGTM-022 Credentials are stored as Kubernetes Secrets<a class=td-heading-self-link href=#egtm-022-credentials-are-stored-as-kubernetes-secrets aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-022</td><td>EGTM-CS-010</td><td>Container Security</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that the OIDC client secret (for OIDC authentication) and user password hashes (for basic authentication) get leaked due to misconfigured RBAC permissions.</p><p><strong>Threat</strong>: Unauthorised access to the application due to credential leakage.</p><p><strong>Recommendation</strong>: Ensure that only authorised users and service accounts are able to access secrets. This is especially important in namespaces where SecurityPolicy objects are configured, since those namespaces are the ones to store secrets containing the client secret (in OIDC scenarios) and user password hashes (in basic authentication scenarios).</p><p>To do so, minimise the use of ClusterRoles and Roles allowing listing and getting secrets. Perform periodic audits of RBAC permissions.</p><h3 id=egtm-023-weak-authentication>EGTM-023 Weak Authentication<a class=td-heading-self-link href=#egtm-023-weak-authentication aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-023</td><td>EGTM-EG-007</td><td>Envoy Gateway</td><td>High</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk of unauthorised access due to the use of basic authentication, which does not enforce any password restriction in terms of complexity and length. In addition, password hashes are stored in SHA1 format, which is a deprecated hashing function.</p><p><strong>Threat</strong>: Unauthorised access to the application due to weak authentication mechanisms.</p><p><strong>Recommendation</strong>: It is recommended to make use of stronger authentication mechanisms (i.e. JWT authentication and OIDC authentication) instead of basic authentication. These authentication mechanisms have many advantages, such as the use of short-lived credentials and a central management of security policies through the identity provider.</p><h2 id=medium-priority-findings>Medium Priority Findings<a class=td-heading-self-link href=#medium-priority-findings aria-label="Heading self-link"></a></h2><h3 id=egtm-008-misconfiguration-of-envoy-gateway-static-config>EGTM-008 Misconfiguration of Envoy Gateway static config<a class=td-heading-self-link href=#egtm-008-misconfiguration-of-envoy-gateway-static-config aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-008</td><td>EGTM-EG-003</td><td>Envoy Gateway</td><td>Medium</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk of a threat actor misconfiguring static config and compromising the integrity of Envoy Gateway, ultimately leading to the compromised confidentiality, integrity, or availability of tenant data and cluster resources.</p><p><strong>Threat</strong>: Accidental or deliberate misconfiguration of static configuration leads to a misconfigured deployment of Envoy Gateway, for example logging parameters could be modified or global rate limiting configuration misconfigured.</p><p><strong>Recommendation</strong>: Implement a GitOps model, utilising Kubernetes' Role-Based Access Control (RBAC) and adhering to the principle of least privilege to minimise human intervention on the cluster. For instance, tools like <a href=https://fluxcd.io/>Flux</a> and <a href=https://argo-cd.readthedocs.io/en/stable/>ArgoCD</a> can be used for declarative GitOps deployments, ensuring all changes are tracked and reviewed. Additionally, configure your source control management (SCM) system to include mandatory pull request (PR) reviews, commit signing, and protected branches to ensure only authorised changes can be committed to the start-up configuration.</p><h3 id=egtm-010-weak-pod-security-contexts-and-policies>EGTM-010 Weak pod security contexts and policies<a class=td-heading-self-link href=#egtm-010-weak-pod-security-contexts-and-policies aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-010</td><td>EGTM-CS-005</td><td>Container Security</td><td>Medium</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor exploits a weak pod security context, compromising the CIA of a node and the resources / services which run on it.</p><p><strong>Threat</strong>: Threat Actor who has compromised a pod exploits weak security context to escape to a node, potentially leading to the compromise of Envoy Proxy or Gateway running on the same node.</p><p><strong>Recommendation</strong>: To mitigate this risk, apply <a href=https://kubernetes.io/docs/concepts/security/pod-security-standards/>Pod Security Standards</a> at a minimum of <a href=https://kubernetes.io/docs/concepts/security/pod-security-standards/#baseline>Baseline</a> level to all namespaces, especially those containing Envoy Gateway and Proxy Pods. Pod security standards are implemented through K8s <a href=https://kubernetes.io/docs/concepts/security/pod-security-admission/>Pod Security Admission</a> to provide <a href=https://kubernetes.io/docs/concepts/security/pod-security-admission/#pod-security-admission-labels-for-namespaces>admission control modes</a> (enforce, audit, and warn) for namespaces. Pod security standards can be enforced by namespace labels as shown <a href=https://kubernetes.io/docs/tasks/configure-pod-container/enforce-standards-namespace-labels/>here</a>, to enforce a baseline level of pod security to specific namespaces.</p><p>Further enhance the security by implementing a sandboxing solution such as <a href=https://gvisor.dev/>gVisor</a> for Envoy Gateway and Proxy Pods to isolate the application from the host kernel. This can be set within the runtimeClassName of the Pod specification.</p><h3 id=egtm-012-clusterroles-and-roles-with-permission-to-deploy-referencegrants>EGTM-012 ClusterRoles and Roles with permission to deploy ReferenceGrants<a class=td-heading-self-link href=#egtm-012-clusterroles-and-roles-with-permission-to-deploy-referencegrants aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-012</td><td>EGTM-GW-004</td><td>Gateway API</td><td>Medium</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor could abuse excessive RBAC privileges to create ReferenceGrant resources. These resources could then be used to create cross-namespace communication, leading to unauthorised access to the application. This could compromise the confidentiality and integrity of resources and configuration in the affected namespaces and potentially disrupt the availability of services that rely on these object references.</p><p><strong>Threat</strong>: A ReferenceGrant is created, which validates traffic to cross namespace trust boundaries without a valid business reason, such as a route in one tenant's namespace referencing a backend in another.</p><p><strong>Recommendation</strong>: Ensure that the ability to create ReferenceGrant resources is restricted to the minimum number of people. Pay special attention to ClusterRoles that allow that action.</p><h3 id=egtm-018-network-denial-of-service-dos>EGTM-018 Network Denial of Service (DoS)<a class=td-heading-self-link href=#egtm-018-network-denial-of-service-dos aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-018</td><td>EGTM-GW-006</td><td>Gateway API</td><td>Medium</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that malicious requests could lead to a Denial of Service (DoS) attack, thereby reducing API gateway availability due to misconfigurations in rate-limiting or load balancing controls, or a lack of route timeout enforcement.</p><p><strong>Threat</strong>: Reduced API gateway availability due to an attacker's maliciously crafted request (e.g., QoD) potentially inducing a Denial of Service (DoS) attack.</p><p><strong>Recommendation</strong>: To ensure high availability and mitigate potential security threats, follow the guidelines in the Envoy Gateway documentation for configuring <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/local-rate-limit/>local rate limit</a> filters, <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/global-rate-limit/>global rate limit</a> filters, and load balancing.</p><p>Further, adhere to best practices for configuring Envoy Proxy as an edge proxy documented <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/best_practices/edge#configuring-envoy-as-an-edge-proxy>here</a> within the EnvoyProxy docs. This involves configuring TCP and HTTP proxies with specific settings, including restricting access to the admin endpoint, setting the <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/operations/overload_manager/overload_manager#config-overload-manager>overload manager</a> and <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-field-config-listener-v3-listener-per-connection-buffer-limit-bytes>listener</a> / <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-per-connection-buffer-limit-bytes>cluster</a> buffer limits, enabling <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-use-remote-address>use_remote_address</a>, setting <a href=https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/timeouts#faq-configuration-timeouts>connection and stream timeouts</a>, limiting <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-http2protocoloptions-max-concurrent-streams>maximum concurrent streams</a>, setting <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-http2protocoloptions-initial-stream-window-size>initial stream window size limit</a>, and configuring action on <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-httpprotocoloptions-headers-with-underscores-action>headers_with_underscores</a>.</p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-normalize-path>Path normalisation</a> should be enabled to minimise path confusion vulnerabilities. These measures help protect against volumetric threats such as Denial of Service (DoS) attacks. Utilise custom resources to implement policy attachment, thereby exposing request limit configuration for route types.</p><h3 id=egtm-019-jwt-based-authentication-replay-attacks>EGTM-019 JWT-based authentication replay attacks<a class=td-heading-self-link href=#egtm-019-jwt-based-authentication-replay-attacks aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-019</td><td>EGTM-DP-004</td><td>Container Security</td><td>Medium</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that replay attacks using stolen or reused JSON Web Tokens (JWTs) can compromise transmission integrity, thereby undermining the confidentiality and integrity of the data plane.</p><p><strong>Threat</strong>: Transmission integrity is compromised due to replay attacks using stolen or reused JSON Web Tokens (JWTs).</p><p><strong>Recommendation</strong>: Comply with JWT best practices for enhanced security, paying special attention to the use of short-lived tokens, which reduce the window of opportunity for a replay attack. The <a href=https://datatracker.ietf.org/doc/html/rfc7519#page-9>exp</a> claim can be used to set token expiration times.</p><h3 id=egtm-024-excessive-privileges-via-extension-policies>EGTM-024 Excessive privileges via extension policies<a class=td-heading-self-link href=#egtm-024-excessive-privileges-via-extension-policies aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-024</td><td>EGTM-EG-008</td><td>Envoy Gateway</td><td>Medium</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk of developers getting more privileges than required due to the use of SecurityPolicy, ClientTrafficPolicy, EnvoyPatchPolicy and BackendTrafficPolicy. These resources can be attached to a Gateway resource. Therefore, a developer with permission to deploy them would be able to modify a Gateway configuration by targeting the gateway in the policy manifest. This conflicts with the <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/#write-permissions-for-advanced-4-tier-model>Advanced 4 Tier Model</a>, where developers do not have write permissions on Gateways.</p><p><strong>Threat</strong>: Excessive developer permissions lead to a misconfiguration and/or unauthorised access.</p><p><strong>Recommendation</strong>: Considering the Tenant C scenario (represented in the Architecture Diagram), if a developer can create SecurityPolicy, ClientTrafficPolicy, EnvoyPatchPolicy or BackendTrafficPolicy objects in namespace C, they would be able to modify a Gateway configuration by attaching the policy to the gateway. In such scenarios, it is recommended to either:</p><p>a. Create a separate namespace, where developers have no permissions, to host tenant C's gateway. Note that, due to design decisions, the SecurityPolicy/EnvoyPatchPolicy/ClientTrafficPolicy/BackendTrafficPolicy object can only target resources deployed in the same namespace. Therefore, having a separate namespace for the gateway would prevent developers from attaching the policy to the gateway.</p><p>b. Forbid the creation of these policies for developers in namespace C.</p><p>On the other hand, in scenarios similar to tenants A and B, where a shared gateway namespace is in place, this issue is more limited. Note that in this scenario, developers don't have access to the shared gateway namespace.</p><p>In addition, it is important to mention that EnvoyPatchPolicy resources can also be attached to GatewayClass resources. This means that, in order to comply with the Advanced 4 Tier model, individuals with the Application Administrator role should not have access to this resource either.</p><h2 id=low-priority-findings>Low Priority Findings<a class=td-heading-self-link href=#low-priority-findings aria-label="Heading self-link"></a></h2><h3 id=egtm-003-misconfiguration-leads-to-insecure-tls-settings>EGTM-003 Misconfiguration leads to insecure TLS settings<a class=td-heading-self-link href=#egtm-003-misconfiguration-leads-to-insecure-tls-settings aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-003</td><td>EGTM-EG-001</td><td>Envoy Gateway</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor could downgrade the security of proxied connections by configuring a weak set of cipher suites, compromising the confidentiality and integrity of proxied traffic.</p><p><strong>Threat</strong>: Exploit weak cipher suite configuration to downgrade security of proxied connections.</p><p><strong>Recommendation</strong>: Users operating in highly regulated environments may need to tightly control the TLS protocol and associated cipher suites, blocking non-conforming incoming connections to the gateway.</p><p>EnvoyProxy bootstrap config can be customised as per the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/customize-envoyproxy/>customise EnvoyProxy</a> documentation. In addition, from v.1.0.0, it is possible to configure common TLS properties for a Gateway or XRoute through the <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#clienttrafficpolicy>ClientTrafficPolicy</a> object.</p><h3 id=egtm-005-envoy-gateway-helm-chart-deployment-does-not-set-apparmor-and-seccomp-profiles>EGTM-005 Envoy Gateway Helm chart deployment does not set AppArmor and Seccomp profiles<a class=td-heading-self-link href=#egtm-005-envoy-gateway-helm-chart-deployment-does-not-set-apparmor-and-seccomp-profiles aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-005</td><td>EGTM-CP-002</td><td>Container Security</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: Threat actor who has obtained access to Envoy Gateway pod could exploit the lack of AppArmor and Seccomp profiles in the Envoy Gateway deployment to attempt a container breakout, given the presence of an exploitable vulnerability, potentially impacting the confidentiality and integrity node resources.</p><p><strong>Threat</strong>: Unauthorised syscalls and malicious code running in the Envoy Gateway pod.</p><p><strong>Recommendation</strong>: Implement <a href=https://kubernetes.io/docs/tutorials/security/apparmor/>AppArmor</a> policies by setting &lt;container_name>: &lt;profile_ref> within container.apparmor.security.beta.kubernetes.io (note, this config is set <em>per container</em>). Well-defined AppArmor policies may provide greater protection from unknown threats.</p><p>Enforce <a href=https://kubernetes.io/docs/tutorials/security/seccomp/>Seccomp</a> profiles by setting the seccompProfile under securityContext. Ideally, a <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#create-pod-with-a-seccomp-profile-that-only-allows-necessary-syscalls>fine-grained</a> profile should be used to restrict access to only necessary syscalls, however the --seccomp-default flag can be set to resort to <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#create-pod-that-uses-the-container-runtime-default-seccomp-profile>RuntimeDefault</a> which provides a container runtime specific. Example seccomp profiles can be found <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#download-profiles>here</a>.</p><p>To further enhance pod security, consider implementing <a href=https://en.wikipedia.org/wiki/Security-Enhanced_Linux>SELinux</a> via seLinuxOptions for additional syscall attack surface reduction. Setting readOnlyRootFilesystem == true enforces an immutable root filesystem, preventing the addition of malicious binaries to the PATH and increasing the attack cost. Together, these configuration items improve the pods <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>Security Context</a>.</p><h3 id=egtm-006-envoy-proxy-pods-deployed-with-a-shell-enabled>EGTM-006 Envoy Proxy pods deployed with a shell enabled<a class=td-heading-self-link href=#egtm-006-envoy-proxy-pods-deployed-with-a-shell-enabled aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-006</td><td>EGTM-CS-004</td><td>Container Security</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a threat actor exploits a vulnerability in Envoy Proxy to expose a reverse shell, enabling them to compromise the confidentiality, integrity and availability of tenant data via a secondary attack.</p><p><strong>Threat</strong>: If an external attacker managed to exploit a vulnerability in Envoy, the presence of a shell would be greatly helpful for the attacker in terms of potentially pivoting, escalating, or establishing some form of persistence.</p><p><strong>Recommendation</strong>: By default, Envoy uses a <a href=https://github.com/GoogleContainerTools/distroless>distroless</a> image since v.0.6.0, which does not ship a shell. Therefore, ensure EnvoyProxy image is up-to-date and patched with the latest stable version.</p><p>If using private EnvoyProxy images, use a lightweight EnvoyProxy image without a shell or debugging tool(s) which may be useful for an attacker.</p><p>An <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#audit-policy>AuditPolicy</a> (audit.k8s.io/v1beta1) can be configured to record API calls made within your cluster, allowing for identification of malicious traffic and enabling incident response. Requests are recorded based on stages which delineate between the lifecycle stage of the request made (e.g., RequestReceived, ResponseStarted, & ResponseComplete).</p><h3 id=egtm-011-route-bindings-on-custom-labels>EGTM-011 Route Bindings on custom labels<a class=td-heading-self-link href=#egtm-011-route-bindings-on-custom-labels aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-011</td><td>EGTM-GW-003</td><td>Gateway API</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that a gateway owner (or someone with the ability to set namespace labels) maliciously or accidentally binds routes across namespace boundaries, potentially compromising the confidentiality and integrity of traffic in a multitenant scenario.</p><p><strong>Threat</strong>: If a Route Binding within a Gateway Listener is configured based on a custom label, it could allow a malicious internal actor with the ability to label namespaces to change the set of namespaces supported by the Gateway.</p><p><strong>Recommendation</strong>: Consider the use of custom admission control to restrict what labels can be set on namespaces through tooling such as <a href=https://kyverno.io/policies/pod-security/>Kubewarden</a>, <a href=https://github.com/kubewarden>Kyverno</a>, and <a href=https://github.com/open-policy-agent/gatekeeper>OPA Gatekeeper</a>. Route binding should follow the Kubernetes Gateway API security model, as shown <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/#1-route-binding>here</a>, to connect gateways in different namespaces.</p><h3 id=egtm-013-gatewayclass-namespace-validation-is-not-configured>EGTM-013 GatewayClass namespace validation is not configured<a class=td-heading-self-link href=#egtm-013-gatewayclass-namespace-validation-is-not-configured aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-013</td><td>EGTM-GW-005</td><td>Gateway API</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that an unauthorised actor deploys an unauthorised GatewayClass due to GatewayClass namespace validation not being configured, leading to non-compliance with business and security requirements.</p><p><strong>Threat</strong>: Unauthorised deployment of Gateway resource via GatewayClass template which crosses namespace trust boundaries.</p><p><strong>Recommendation</strong>: Leverage GatewayClass namespace validation to limit the namespaces where GatewayClasses can be run through a tool such as <a href=https://github.com/open-policy-agent/gatekeeper>OPA Gatekeeper</a>. Reference pull request #<a href=https://github.com/open-policy-agent/gatekeeper-library/pull/24>24</a> within gatekeeper-library which outlines how to add GatewayClass namespace validation through a GatewayClassNamespaces API resource kind within the constraints.gatekeeper.sh/v1beta1 apiGroup.</p><h3 id=egtm-015-serviceaccount-token-authentication>EGTM-015 ServiceAccount token authentication<a class=td-heading-self-link href=#egtm-015-serviceaccount-token-authentication aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-015</td><td>EGTM-CS-007</td><td>Container Security</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that threat actors could exploit ServiceAccount tokens for illegitimate authentication, thereby leading to privilege escalation and the undermining of gateway API resources' integrity, confidentiality, and availability.</p><p><strong>Threat</strong>: The threat arises from threat actors impersonating the envoy-gateway ServiceAccount through the replay of ServiceAccount tokens, thereby achieving escalated privileges and gaining unauthorised access to Kubernetes resources.</p><p><strong>Recommendation</strong>: Limit the creation of ServiceAccounts to only when necessary, specifically refraining from using default service account tokens, especially for high-privilege service accounts. For legacy clusters running Kubernetes version 1.21 or earlier, note that ServiceAccount tokens are long-lived by default. To disable the automatic mounting of the service account token, set automountServiceAccountToken: false in the PodSpec.</p><h3 id=egtm-016-misconfiguration-leads-to-lack-of-envoy-proxy-access-activity-visibility>EGTM-016 Misconfiguration leads to lack of Envoy Proxy access activity visibility<a class=td-heading-self-link href=#egtm-016-misconfiguration-leads-to-lack-of-envoy-proxy-access-activity-visibility aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-016</td><td>EGTM-EG-004</td><td>Envoy Gateway</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that threat actors establish persistence and move laterally through the cluster unnoticed due to limited visibility into access and application-level activity.</p><p><strong>Threat</strong>: Threat actors establish persistence and move laterally through the cluster unnoticed.</p><p><strong>Recommendation</strong>: Configure <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/proxy-accesslog/>access logging</a> in the EnvoyProxy. Use <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogformattype>ProxyAccessLogFormatType</a> (Text or JSON) to specify the log format and ensure that the logs are sent to the desired sink types by setting the <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#proxyaccesslogsinktype>ProxyAccessLogSinkType</a>. Make use of <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#fileenvoyproxyaccesslog>FileEnvoyProxyAccessLog</a> or <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a> to configure File and OpenTelemetry sinks, respectively. If the settings aren't defined, the default format is sent to stdout.</p><p>Additionally, consider leveraging a central logging mechanism such as <a href=https://github.com/fluent/fluentd>Fluentd</a> to enhance visibility into access activity and enable effective incident response (IR).</p><h3 id=egtm-017-misconfiguration-leads-to-lack-of-envoy-gateway-activity-visibility>EGTM-017 Misconfiguration leads to lack of Envoy Gateway activity visibility<a class=td-heading-self-link href=#egtm-017-misconfiguration-leads-to-lack-of-envoy-gateway-activity-visibility aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-017</td><td>EGTM-EG-005</td><td>Envoy Gateway</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that an insider misconfigures an envoy gateway component and goes unnoticed due to a low-touch logging configuration (via default) which responsible stakeholders are not aptly aware of or have immediate access to.</p><p><strong>Threat</strong>: The threat emerges from an insider misconfiguring an Envoy Gateway component without detection.</p><p><strong>Recommendation</strong>: Configure the logging level of the Envoy Gateway using the 'level' field in <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#envoygatewaylogging>EnvoyGatewayLogging</a>. Ensure the appropriate logging levels are set for relevant components such as 'gateway-api', 'xds-translator', or 'global-ratelimit'. If left unspecified, the logging level defaults to "info", which may not provide sufficient detail for security monitoring.</p><p>Employ a centralised logging mechanism, like <a href=https://github.com/fluent/fluentd>Fluentd</a>, to enhance visibility into application-level activity and to enable efficient incident response.</p><h3 id=egtm-021-exposed-envoy-proxy-admin-interface>EGTM-021 Exposed Envoy Proxy admin interface<a class=td-heading-self-link href=#egtm-021-exposed-envoy-proxy-admin-interface aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-021</td><td>EGTM-EG-006</td><td>Envoy Gateway</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: There is a risk that the admin interface is exposed without valid business reason, increasing the attack surface.</p><p><strong>Threat</strong>: Exposed admin interfaces give internal attackers the option to affect production traffic in unauthorised ways, and the option to exploit any vulnerabilities which may be present in the admin interface (e.g. by orchestrating malicious GET requests to the admin interface through CSRF, compromising Envoy Proxy global configuration or shutting off the service entirely e.g. /quitquitquit).</p><p><strong>Recommendation</strong>: The Envoy Proxy admin interface is only exposed to localhost, meaning that it is secure by default. However, due to the risk of misconfiguration, this recommendation is included.</p><p>Due to the importance of the admin interface, it is recommended to ensure that Envoy Proxies have not been accidentally misconfigured to expose the admin interface to untrusted networks.</p><h3 id=egtm-025-envoy-proxy-pods-deployed-running-as-root-user-in-the-container>EGTM-025 Envoy Proxy pods deployed running as root user in the container<a class=td-heading-self-link href=#egtm-025-envoy-proxy-pods-deployed-running-as-root-user-in-the-container aria-label="Heading self-link"></a></h3><table><thead><tr><th><strong>ID</strong></th><th><strong>UID</strong></th><th><strong>Category</strong></th><th><strong>Priority</strong></th></tr></thead><tbody><tr><td>EGTM-025</td><td>EGTM-CS-011</td><td>Container Security</td><td>Low</td></tr></tbody></table><p><strong>Risk</strong>: The presence of a vulnerability, be it in the kernel or another system component, when coupled with containers running as root, could enable a threat actor to escape the container, thereby compromising the confidentiality, integrity, or availability of cluster resources</p><p><strong>Threat</strong>: The Envoy Proxy container&rsquo;s root-user configuration can be leveraged by an attacker to escalate privileges, execute a container breakout, and traverse across trust boundaries.</p><p><strong>Recommendation</strong>: By default, Envoy Gateway deployments do not use root users. Nonetheless, in case a custom image or deployment manifest is to be used, make sure Envoy Proxy pods run as a non-root user with a high UID within the container.</p><p>Set runAsUser and runAsGroup security context options to specific UIDs (e.g., runAsUser: 1000 & runAsGroup: 3000) to ensure the container operates with the stipulated non-root user and group ID. If using helm chart deployment, define the user and group ID in the values.yaml file or via the command line during helm install / upgrade.</p><h2 id=appendix>Appendix<a class=td-heading-self-link href=#appendix aria-label="Heading self-link"></a></h2><h3 id=in-scope-threat-actor-details>In Scope Threat Actor Details<a class=td-heading-self-link href=#in-scope-threat-actor-details aria-label="Heading self-link"></a></h3><table><thead><tr><th>Threat Actor</th><th>Capability</th><th>Personal Motivation</th><th>Envoy Gateway Attack Samples</th></tr></thead><tbody><tr><td>Application Developer</td><td>Leverage internal knowledge and personal access to the Envoy Gateway infrastructure to move laterally and transit trust boundaries</td><td>Disgruntled / personal grievances.<br><br>Financial incentives</td><td>Misconfigure XRoute resources to expose internal applications.<br><br>Misconfigure SecurityPolicy objects, reducing the security posture of an application.</td></tr><tr><td>Application Administrator</td><td>Abuse privileged status to disrupt operations and tenant cluster services through Envoy Gateway misconfig</td><td>Disgruntled / personal grievances.<br><br>Financial incentives</td><td>Create malicious routes to internal applications.<br><br>Introduce malicious Envoy Proxy images.<br><br>Expose the Envoy Proxy Admin interface.</td></tr><tr><td>Cluster Operator</td><td>Alter application-level deployments by misconfiguring resource dependencies & SCM to introduce vulnerabilities</td><td>Disgruntled / personal grievances.<br><br>Financial incentives.<br><br>Notoriety</td><td>Deploy malicious resources to expose internal applications.<br><br>Access authentication secrets.<br><br>Fall victim to phishing attacks and inadvertently share authentication credentials to cloud infrastructure or Kubernetes clusters.</td></tr><tr><td>Vandal: Script Kiddie, Trespasser</td><td>Uses publicly available tools and applications (Nmap,Metasploit, CVE PoCs)</td><td>Curiosity.<br><br>Personal fame through defacement / denial of service of prominent public facing web resources</td><td>Small scale DOS.<br><br>Launches prepackaged exploits, runs crypto mining tools.<br><br>Exploit public-facing application services such as the bastion host to gain an initial foothold in the environment</td></tr><tr><td>Motivated individual: Political activist, Thief, Terrorist</td><td>Write tools and exploits required for their means if sufficiently motivated.<br><br>Tend to use these in a targeted fashion against specific organisations. May combine publicly available exploits in a targeted fashion. Tamper with open source supply chains</td><td>Personal Gain (Political or Ideological)</td><td>Phishing, DDOS, exploit known vulnerabilities.<br><br>Compromise third-party components such as Helm charts and container images to inject malicious codes to propagate access throughout the environment.</td></tr><tr><td>Organised crime: syndicates, state-affiliated groups</td><td>Write tools and exploits required for their means.<br><br>Tend to use these in a non-targeted fashion, unless motivation is sufficiently high.<br><br>Devotes considerable resources, writes exploits, can bribe/coerce, can launch targeted attacks</td><td>Ransom.<br><br>Mass extraction of PII / credentials / PCI data.<br><br>Financial incentives</td><td>Social Engineering, phishing, ransomware, coordinated attacks.<br><br>Intercept and replay JWT tokens (via MiTM) between tenant user(s) and envoy gateway to modify app configs in-transit</td></tr></tbody></table><h3 id=identified-threats-by-priority>Identified Threats by Priority<a class=td-heading-self-link href=#identified-threats-by-priority aria-label="Heading self-link"></a></h3><table><thead><tr><th>ID</th><th>UID</th><th>Category</th><th>Risk</th><th>Threat</th><th>Priority</th><th>Recommendation</th></tr></thead><tbody><tr><td>EGTM-001</td><td>EGTM-GW-001</td><td>Gateway API</td><td>Self-signed certificates (which do not comply with PKI best practices) could lead to unauthorised access to the private key associated with the certificate used for inbound TLS termination at Envoy Proxy, compromising the confidentiality and integrity of proxied traffic.<br><br></td><td>Compromise of the private key associated with the certificate used for inbound TLS terminating at Envoy Proxy.<br><br></td><td>High</td><td>The Envoy Gateway quickstart demonstrates how to set up a Secure Gateway using an example where a self-signed root certificate is created using openssl. As stated in the Envoy Gateway documentation, this is not a suitable configuration for Production usage. It is recommended that PKI best practices are followed, whereby certificates are signed by an Intermediary CA which sits underneath an organisational 'offline' Root CA.<br><br>PKI best practices should also apply to the management of client certificates when using mTLS. The Envoy Gateway <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/mutual-tls/>mTLS</a> task shows how to set up client certificates using self-signed certificates. In the same way as gateway certificates and, as mentioned in the documentation, this configuration should not be used in production environments.</td></tr><tr><td>EGTM-002</td><td>EGTM-CS-001</td><td>Container Security</td><td>There is a risk that a threat actor could compromise the Kubernetes secret containing the Envoy private key, allowing the attacker to decrypt Envoy Proxy traffic, compromising the confidentiality of proxied traffic.<br><br></td><td>Kubernetes secret containing the Envoy private key is compromised and used to decrypt proxied traffic.<br><br></td><td>High</td><td>Certificate management best practices mandate short-lived key material where practical, meaning that a mechanism for rotation of private keys and certificates is required, along with a way for certificates to be mounted into Envoy containers. If Kubernetes secrets are used, when a certificate expires, the associated secret must be updated, and Envoy containers must be redeployed. Instead of a manual configuration, it is recommended that <a href=https://github.com/cert-manager/cert-manager>cert-manager</a> is used.</td></tr><tr><td>EGTM-004</td><td>EGTM-K8-002</td><td>Container Security</td><td>There is a risk that a threat actor could abuse misconfigured RBAC to access the Envoy Gateway ClusterRole (envoy-gateway-role) and use it to expose all secrets across the cluster, thus compromising the confidentiality and integrity of tenant data.<br><br></td><td>Compromised Envoy Gateway or misconfigured ClusterRoleBinding (envoy-gateway-rolebinding) to Envoy Gateway ClusterRole (envoy-gateway-role), provides access to resources and secrets in different namespaces.<br><br></td><td>High</td><td>Users should be aware that Envoy Gateway uses a ClusterRole (envoy-gateway-role) when deployed via the Helm chart, to allow management of Envoy Proxies across different namespaces. This ClusterRole is powerful and includes the ability to read secrets in namespaces which may not be within the purview of Envoy Gateway.<br><br>Kubernetes best-practices involve restriction of ClusterRoleBindings, with the use of RoleBindings where possible to limit access per namespace by specifying the namespace in metadata. Namespace isolation reduces the impact of compromise from cluster-scoped roles. Ideally, fine-grained K8s roles should be created per the principle of least privilege to ensure they have the minimum access necessary for role functions.<br><br>The pull request #<a href=https://github.com/envoyproxy/gateway/pull/1656>1656</a> introduced the use of Roles and RoleBindings in <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#kuberneteswatchmode>namespaced mode</a>. This feature can be leveraged to reduce the amount of permissions required by the Envoy Gateway.</td></tr><tr><td>EGTM-007</td><td>EGTM-EG-002</td><td>Envoy Gateway</td><td>There is a risk that a threat actor could exploit misconfigured Kubernetes RBAC to create or modify Gateway API resources with no business need, potentially leading to the compromise of the confidentiality, integrity, and availability of resources and traffic within the cluster.<br><br></td><td>Unauthorised creation or misconfiguration of Gateway API resources by a threat actor with cluster-scoped access.<br><br></td><td>High</td><td>Configure the apiGroup and resource fields in RBAC policies to restrict access to <a href=https://gateway-api.sigs.k8s.io/>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a> resources. Enable namespace isolation by using the namespace field, preventing unauthorised access to gateways in other namespaces.</td></tr><tr><td>EGTM-009</td><td>EGTM-GW-002</td><td>Gateway API</td><td>There is a risk that a co-tenant misconfigures Gateway or Route resources, compromising the confidentiality, integrity, and availability of routed traffic through Envoy Gateway.<br><br></td><td>Malicious or accidental co-tenant misconfiguration of Gateways and Routes associated with other application teams.<br><br></td><td>High</td><td>Dedicated Envoy Gateways should be provided to each tenant within their respective namespace. A one-to-one relationship should be established between GatewayClass and Gateway resources, meaning that each tenant namespace should have their own GatewayClass watched by a unique Envoy Gateway Controller as defined here in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/deployment-mode/>Deployment Mode</a> documentation.<br><br>Application Admins should have write permissions on the Gateway resource, but only in their specific namespaces, and Application Developers should only hold write permissions on Route resources. To enact this access control schema, follow the <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/#write-permissions-for-advanced-4-tier-model>Write Permissions for Advanced 4 Tier Model</a> described in the Kubernetes Gateway API security model. Examples of secured gateway-route topologies can be found <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#attaching-routes-to-gateways>here</a> within the Kubernetes Gateway API docs.<br><br>Optionally, consider a GitOps model, where only the GitOps operator has the permission to deploy or modify custom resources in production.</td></tr><tr><td>EGTM-014</td><td>EGTM-CS-006</td><td>Container Security</td><td>There is a risk that a supply chain attack on Envoy Gateway results in an arbitrary compromise of the confidentiality, integrity or availability of tenant data.<br><br></td><td>Supply chain threat actor introduces malicious code into Envoy Gateway or Proxy.<br><br></td><td>High</td><td>The Envoy Gateway project should continue to work towards conformance with supply-chain security best practices throughout the project lifecycle (for example, as set out in the <a href=https://github.com/cncf/tag-security/blob/main/supply-chain-security/supply-chain-security-paper/CNCF_SSCP_v1.pdf>CNCF Software Supply Chain Best Practices Whitepaper</a>. Adherence to <a href=https://slsa.dev/>Supply-chain Levels for Software Artefacts</a> (SLSA) standards is crucial for maintaining the security of the system. Employ version control systems to monitor the source and build platforms and assign responsibility to a specific stakeholder.<br><br>Integrate a supply chain security tool such as Sigstore, which provides native capabilities for signing and verifying container images and software artefacts. <a href=https://www.cisa.gov/sbom>Software Bill of Materials</a> (SBOM), <a href=https://www.ntia.gov/files/ntia/publications/vex_one-page_summary.pdf>Vulnerability Exploitability eXchange</a> (VEX), and signed artefacts should also be incorporated into the security protocol.</td></tr><tr><td>EGTM-020</td><td>EGTM-CS-009</td><td>Container Security</td><td>There is a risk that a threat actor exploits an Envoy Proxy vulnerability to remote code execution (RCE) due to out of date or misconfigured Envoy Proxy pod deployment, compromising the confidentiality and integrity of Envoy Proxy along with the availability of the proxy service.<br><br></td><td>Deployment of an Envoy Proxy or Gateway image containing exploitable CVEs.<br><br></td><td>High</td><td>Always use the latest version of the Envoy Proxy image. Regularly check for updates and patch the system as soon as updates become available. Implement a CI/CD pipeline that includes security checks for images and prevents deployment of insecure configurations. A tool such as Snyk can be used to provide container vulnerability scanning to mitigate the risk of known vulnerabilities.<br><br>Utilise the <a href=https://kubernetes.io/docs/concepts/security/pod-security-admission/>Pod Security Admission</a> controller to enforce <a href=https://kubernetes.io/docs/concepts/security/pod-security-standards/>Pod Security Standards</a> and configure the <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>pod security context</a> to limit its capabilities per the principle of least privilege.</td></tr><tr><td>EGTM-022</td><td>EGTM-CS-010</td><td>Container Security</td><td>There is a risk that the OIDC client secret (for OIDC authentication) and user password hashes (for basic authentication) get leaked due to misconfigured RBAC permissions.<br><br></td><td>Unauthorised access to the application due to credential leakage.<br><br></td><td>High</td><td>Ensure that only authorised users and service accounts are able to access secrets. This is especially important in namespaces where SecurityPolicy objects are configured, since those namespaces are the ones to store secrets containing the client secret (in OIDC scenarios) and user password hashes (in basic authentication scenarios).<br><br>To do so, minimise the use of ClusterRoles and Roles allowing listing and getting secrets. Perform periodic audits of RBAC permissions.</td></tr><tr><td>EGTM-023</td><td>EGTM-EG-007</td><td>Envoy Gateway</td><td>There is a risk of unauthorised access due to the use of basic authentication, which does not enforce any password restriction in terms of complexity and length. In addition, password hashes are stored in SHA1 format, which is a deprecated hashing function.<br><br></td><td>Unauthorised access to the application due to weak authentication mechanisms.<br><br></td><td>High</td><td>It is recommended to make use of stronger authentication mechanisms (i.e. JWT authentication and OIDC authentication) instead of basic authentication. These authentication mechanisms have many advantages, such as the use of short-lived credentials and a central management of security policies through the identity provider.</td></tr><tr><td>EGTM-008</td><td>EGTM-EG-003</td><td>Envoy Gateway</td><td>There is a risk of a threat actor misconfiguring static config and compromising the integrity of Envoy Gateway, ultimately leading to the compromised confidentiality, integrity, or availability of tenant data and cluster resources.<br><br></td><td>Accidental or deliberate misconfiguration of static configuration leads to a misconfigured deployment of Envoy Gateway, for example logging parameters could be modified or global rate limiting configuration misconfigured.<br><br></td><td>Medium</td><td>Implement a GitOps model, utilising Kubernetes' Role-Based Access Control (RBAC) and adhering to the principle of least privilege to minimise human intervention on the cluster. For instance, tools like <a href=https://argo-cd.readthedocs.io/en/stable/>ArgoCD</a> can be used for declarative GitOps deployments, ensuring all changes are tracked and reviewed. Additionally, configure your source control management (SCM) system to include mandatory pull request (PR) reviews, commit signing, and protected branches to ensure only authorised changes can be committed to the start-up configuration.</td></tr><tr><td>EGTM-010</td><td>EGTM-CS-005</td><td>Container Security</td><td>There is a risk that a threat actor exploits a weak pod security context, compromising the CIA of a node and the resources / services which run on it.<br><br></td><td>Threat Actor who has compromised a pod exploits weak security context to escape to a node, potentially leading to the compromise of Envoy Proxy or Gateway running on the same node.<br><br></td><td>Medium</td><td>To mitigate this risk, apply <a href=https://kubernetes.io/docs/concepts/security/pod-security-standards/>Pod Security Standards</a> at a minimum of <a href=https://kubernetes.io/docs/concepts/security/pod-security-standards/#baseline>Baseline</a> level to all namespaces, especially those containing Envoy Gateway and Proxy Pods. Pod security standards are implemented through K8s <a href=https://kubernetes.io/docs/concepts/security/pod-security-admission/>Pod Security Admission</a> to provide <a href=https://kubernetes.io/docs/concepts/security/pod-security-admission/#pod-security-admission-labels-for-namespaces>admission control modes</a> (enforce, audit, and warn) for namespaces. Pod security standards can be enforced by namespace labels as shown <a href=https://kubernetes.io/docs/tasks/configure-pod-container/enforce-standards-namespace-labels/>here</a>, to enforce a baseline level of pod security to specific namespaces.<br><br>Further enhance the security by implementing a sandboxing solution such as <a href=https://gvisor.dev/>gVisor</a> for Envoy Gateway and Proxy Pods to isolate the application from the host kernel. This can be set within the runtimeClassName of the Pod specification.</td></tr><tr><td>EGTM-012</td><td>EGTM-GW-004</td><td>Gateway API</td><td>There is a risk that a threat actor could abuse excessive RBAC privileges to create ReferenceGrant resources. These resources could then be used to create cross-namespace communication, leading to unauthorised access to the application. This could compromise the confidentiality and integrity of resources and configuration in the affected namespaces and potentially disrupt the availability of services that rely on these object references.<br><br></td><td>A ReferenceGrant is created, which validates traffic to cross namespace trust boundaries without a valid business reason, such as a route in one tenant's namespace referencing a backend in another.<br><br></td><td>Medium</td><td>Ensure that the ability to create ReferenceGrant resources is restricted to the minimum number of people. Pay special attention to ClusterRoles that allow that action.</td></tr><tr><td>EGTM-018</td><td>EGTM-GW-006</td><td>Gateway API</td><td>There is a risk that malicious requests could lead to a Denial of Service (DoS) attack, thereby reducing API gateway availability due to misconfigurations in rate-limiting or load balancing controls, or a lack of route timeout enforcement.<br><br></td><td>Reduced API gateway availability due to an attacker's maliciously crafted request (e.g., QoD) potentially inducing a Denial of Service (DoS) attack.<br><br></td><td>Medium</td><td>To ensure high availability and to mitigate potential security threats, adhere to the Envoy Gateway documentation for the configuration of a <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/global-rate-limit/>rate-limiting</a> filter and load balancing.<br><br>Further, adhere to best practices for configuring Envoy Proxy as an edge proxy documented <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/best_practices/edge#configuring-envoy-as-an-edge-proxy>here</a> within the EnvoyProxy docs. This involves configuring TCP and HTTP proxies with specific settings, including restricting access to the admin endpoint, setting the <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/operations/overload_manager/overload_manager#config-overload-manager>overload manager</a> and <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-field-config-listener-v3-listener-per-connection-buffer-limit-bytes>listener</a> / <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-per-connection-buffer-limit-bytes>cluster</a> buffer limits, enabling <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-use-remote-address>use_remote_address</a>, setting <a href=https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/timeouts#faq-configuration-timeouts>connection and stream timeouts</a>, limiting <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-http2protocoloptions-max-concurrent-streams>maximum concurrent streams</a>, setting <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-http2protocoloptions-initial-stream-window-size>initial stream window size limit</a>, and configuring action on <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-httpprotocoloptions-headers-with-underscores-action>headers_with_underscores</a>.<br><br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-normalize-path>Path normalisation</a> should be enabled to minimise path confusion vulnerabilities. These measures help protect against volumetric threats such as Denial of Service (DoS)nattacks. Utilise custom resources to implement policy attachment, thereby exposing request limit configuration for route types.</td></tr><tr><td>EGTM-019</td><td>EGTM-DP-004</td><td>Container Security</td><td>There is a risk that replay attacks using stolen or reused JSON Web Tokens (JWTs) can compromise transmission integrity, thereby undermining the confidentiality and integrity of the data plane.<br><br></td><td>Transmission integrity is compromised due to replay attacks using stolen or reused JSON Web Tokens (JWTs).<br><br></td><td>Medium</td><td>Comply with JWT best practices for enhanced security, paying special attention to the use of short-lived tokens, which reduce the window of opportunity for a replay attack. The <a href=https://datatracker.ietf.org/doc/html/rfc7519#page-9>exp</a> claim can be used to set token expiration times.</td></tr><tr><td>EGTM-024</td><td>EGTM-EG-008</td><td>Envoy Gateway</td><td>There is a risk of developers getting more privileges than required due to the use of SecurityPolicy, ClientTrafficPolicy, EnvoyPatchPolicy and BackendTrafficPolicy. These resources can be attached to a Gateway resource. Therefore, a developer with permission to deploy them would be able to modify a Gateway configuration by targeting the gateway in the policy manifest. This conflicts with the <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/#write-permissions-for-advanced-4-tier-model>Advanced 4 Tier Model</a>, where developers do not have write permissions on Gateways.<br><br></td><td>Excessive developer permissions lead to a misconfiguration and/or unauthorised access.<br><br></td><td>Medium</td><td>Considering the Tenant C scenario (represented in the Architecture Diagram), if a developer can create SecurityPolicy, ClientTrafficPolicy, EnvoyPatchPolicy or BackendTrafficPolicy objects in namespace C, they would be able to modify a Gateway configuration by attaching the policy to the gateway. In such scenarios, it is recommended to either:<br><br>a. Create a separate namespace, where developers have no permissions, > to host tenant C's gateway. Note that, due to design decisions, > the > SecurityPolicy/EnvoyPatchPolicy/ClientTrafficPolicy/BackendTrafficPolicy > object can only target resources deployed in the same namespace. > Therefore, having a separate namespace for the gateway would > prevent developers from attaching the policy to the gateway.<br><br>b. Forbid the creation of these policies for developers in namespace C.<br><br>On the other hand, in scenarios similar to tenants A and B, where a shared gateway namespace is in place, this issue is more limited. Note that in this scenario, developers don't have access to the shared gateway namespace.<br><br>In addition, it is important to mention that EnvoyPatchPolicy resources can also be attached to GatewayClass resources. This means that, in order to comply with the Advanced 4 Tier model, individuals with the Application Administrator role should not have access to this resource either.</td></tr><tr><td>EGTM-003</td><td>EGTM-EG-001</td><td>Envoy Gateway</td><td>There is a risk that a threat actor could downgrade the security of proxied connections by configuring a weak set of cipher suites, compromising the confidentiality and integrity of proxied traffic.<br><br></td><td>Exploit weak cipher suite configuration to downgrade security of proxied connections.<br><br></td><td>Low</td><td>Users operating in highly regulated environments may need to tightly control the TLS protocol and associated cipher suites, blocking non-conforming incoming connections to the gateway.<br><br>EnvoyProxy bootstrap config can be customised as per the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/customize-envoyproxy/>customise EnvoyProxy</a> documentation. In addition, from v.1.0.0, it is possible to configure common TLS properties for a Gateway or XRoute through the <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#clienttrafficpolicy>ClientTrafficPolicy</a> object.</td></tr><tr><td>EGTM-005</td><td>EGTM-CP-002</td><td>Container Security</td><td>Threat actor who has obtained access to Envoy Gateway pod could exploit the lack of AppArmor and Seccomp profiles in the Envoy Gateway deployment to attempt a container breakout, given the presence of an exploitable vulnerability, potentially impacting the confidentiality and integrity of namespace resources.<br><br></td><td>Unauthorised syscalls and malicious code running in the Envoy Gateway pod.<br><br></td><td>Low</td><td>Implement <a href=https://kubernetes.io/docs/tutorials/security/apparmor/>AppArmor</a> policies by setting &lt;container_name>: &lt;profile_ref> within container.apparmor.security.beta.kubernetes.io (note, this config is set <em>per container</em>). Well-defined AppArmor policies may provide greater protection from unknown threats.<br><br>Enforce <a href=https://kubernetes.io/docs/tutorials/security/seccomp/>Seccomp</a> profiles by setting the seccompProfile under securityContext. Ideally, a <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#create-pod-with-a-seccomp-profile-that-only-allows-necessary-syscalls>fine-grained</a> profile should be used to restrict access to only necessary syscalls, however the --seccomp-default flag can be set to resort to <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#create-pod-that-uses-the-container-runtime-default-seccomp-profile>RuntimeDefault</a> which provides a container runtime specific. Example seccomp profiles can be found <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#download-profiles>here</a>.<br><br>To further enhance pod security, consider implementing <a href=https://en.wikipedia.org/wiki/Security-Enhanced_Linux>SELinux</a> via seLinuxOptions for additional syscall attack surface reduction. Setting readOnlyRootFilesystem == true enforces an immutable root filesystem, preventing the addition of malicious binaries to the PATH and increasing the attack cost. Together, these configuration items improve the pods <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>Security Context</a>.</td></tr><tr><td>EGTM-006</td><td>EGTM-CS-004</td><td>Container Security</td><td>There is a risk that a threat actor exploits a vulnerability in Envoy Proxy to expose a reverse shell, enabling them to compromise the confidentiality, integrity and availability of tenant data via a secondary attack.<br><br></td><td>If an external attacker managed to exploit a vulnerability in Envoy, the presence of a shell would be greatly helpful for the attacker in terms of potentially pivoting, escalating, or establishing some form of persistence.<br><br></td><td>Low</td><td>By default, Envoy uses a <a href=https://github.com/GoogleContainerTools/distroless>distroless</a> image since v.0.6.0, which does not ship a shell. Therefore, ensure EnvoyProxy image is up-to-date and patched with the latest stable version.<br><br>If using private EnvoyProxy images, use a lightweight EnvoyProxy image without a shell or debugging tool(s) which may be useful for an attacker.<br><br>An <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#audit-policy>AuditPolicy</a> (audit.k8s.io/v1beta1) can be configured to record API calls made within your cluster, allowing for identification of malicious traffic and enabling incident response. Requests are recorded based on stages which delineate between the lifecycle stage of the request made (e.g., RequestReceived, ResponseStarted, & ResponseComplete).</td></tr><tr><td>EGTM-011</td><td>EGTM-GW-003</td><td>Gateway API</td><td>There is a risk that a gateway owner (or someone with the ability to set namespace labels) maliciously or accidentally binds routes across namespace boundaries, potentially compromising the confidentiality and integrity of traffic in a multitenant scenario.<br><br></td><td>If a Route Binding within a Gateway Listener is configured based on a custom label, it could allow a malicious internal actor with the ability to label namespaces to change the set of namespaces supported by the Gateway<br><br></td><td>Low</td><td>Consider the use of custom admission control to restrict what labels can be set on namespaces through tooling such as <a href=https://kyverno.io/policies/pod-security/>Kubewarden</a>, <a href=https://github.com/kubewarden>Kyverno</a>, and <a href=https://github.com/open-policy-agent/gatekeeper>OPA Gatekeeper</a>. Route binding should follow the Kubernetes Gateway API security model, as shown <a href=https://gateway-api.sigs.k8s.io/concepts/security-model/#1-route-binding>here</a>, to connect gateways in different namespaces.</td></tr><tr><td>EGTM-013</td><td>EGTM-GW-005</td><td>Gateway API</td><td>There is a risk that an unauthorised actor deploys an unauthorised GatewayClass due to GatewayClass namespace validation not being configured, leading to non-compliance with business and security requirements.<br><br></td><td>Unauthorised deployment of Gateway resource via GatewayClass template which crosses namespace trust boundaries.<br><br></td><td>Low</td><td>Leverage GatewayClass namespace validation to limit the namespaces where GatewayClasses can be run through a tool such as using <a href=https://github.com/open-policy-agent/gatekeeper>OPA Gatekeeper</a>. Reference pull request #<a href=https://github.com/open-policy-agent/gatekeeper-library/pull/24>24</a> within gatekeeper-library which outlines how to add GatewayClass namespace validation through a GatewayClassNamespaces API resource kind within the constraints.gatekeeper.sh/v1beta1 apiGroup.</td></tr><tr><td>EGTM-015</td><td>EGTM-CS-007</td><td>Container Security</td><td>There is a risk that threat actors could exploit ServiceAccount tokens for illegitimate authentication, thereby leading to privilege escalation and the undermining of gateway API resources' integrity, confidentiality, and availability.<br><br></td><td>The threat arises from threat actors impersonating the envoy-gateway ServiceAccount through the replay of ServiceAccount tokens, thereby achieving escalated privileges and gaining unauthorised access to Kubernetes resources.<br><br></td><td>Low</td><td>Limit the creation of ServiceAccounts to only when necessary, specifically refraining from using default service account tokens, especially for high-privilege service accounts. For legacy clusters running Kubernetes version 1.21 or earlier, note that ServiceAccount tokens are long-lived by default. To disable the automatic mounting of the service account token, set automountServiceAccountToken: false in the PodSpec.</td></tr><tr><td>EGTM-016</td><td>EGTM-EG-004</td><td>Envoy Gateway</td><td>There is a risk that threat actors establish persistence and move laterally through the cluster unnoticed due to limited visibility into access and application-level activity.<br><br></td><td>Threat actors establish persistence and move laterally through the cluster unnoticed.<br><br></td><td>Low</td><td>Configure <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/proxy-accesslog/>access logging</a> in the EnvoyProxy. Use <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogformattype>ProxyAccessLogFormatType</a> (Text or JSON) to specify the log format and ensure that the logs are sent to the desired sink types by setting the <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#proxyaccesslogsinktype>ProxyAccessLogSinkType</a>. Make use of <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#fileenvoyproxyaccesslog>FileEnvoyProxyAccessLog</a> or <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a> to configure File and OpenTelemetry sinks, respectively. If the settings aren't defined, the default format is sent to stdout.<br><br>Additionally, consider leveraging a central logging mechanism such as <a href=https://github.com/fluent/fluentd>Fluentd</a> to enhance visibility into access activity and enable effective incident response (IR).</td></tr><tr><td>EGTM-017</td><td>EGTM-EG-005</td><td>Envoy Gateway</td><td>There is a risk that an insider misconfigures an envoy gateway component and goes unnoticed due to a low-touch logging configuration (via default) which responsible stakeholders are not aptly aware of or have immediate access to.<br><br></td><td>The threat emerges from an insider misconfiguring an Envoy Gateway component without detection.<br><br></td><td>Low</td><td>Configure the logging level of the Envoy Gateway using the 'level' field in <a href=https://gateway.envoyproxy.io/latest/api/extension_types/#envoygatewaylogging>EnvoyGatewayLogging</a>. Ensure the appropriate logging levels are set for relevant components such as 'gateway-api', 'xds-translator', or 'global-ratelimit'. If left unspecified, the logging level defaults to "info", which may not provide sufficient detail for security monitoring.<br><br>Employ a centralised logging mechanism, like <a href=https://github.com/fluent/fluentd>Fluentd</a>, to enhance visibility into application-level activity and to enable efficient incident response.</td></tr><tr><td>EGTM-021</td><td>EGTM-EG-006</td><td>Envoy Gateway</td><td>There is a risk that the admin interface is exposed without valid business reason, increasing the attack surface.<br><br></td><td>Exposed admin interfaces give internal attackers the option to affect production traffic in unauthorised ways, and the option to exploit any vulnerabilities which may be present in the admin interface (e.g. by orchestrating malicious GET requests to the admin interface through CSRF, compromising Envoy Proxy global configuration or shutting off the service entirely (e.g., /quitquitquit).<br><br></td><td>Low</td><td>The Envoy Proxy admin interface is only exposed to localhost, meaning that it is secure by default. However, due to the risk of misconfiguration, this recommendation is included.<br><br>Due to the importance of the admin interface, it is recommended to ensure that Envoy Proxies have not been accidentally misconfigured to expose the admin interface to untrusted networks.</td></tr><tr><td>EGTM-025</td><td>EGTM-CS-011</td><td>Container Security</td><td>The presence of a vulnerability, be it in the kernel or another system component, when coupled with containers running as root, could enable a threat actor to escape the container, thereby compromising the confidentiality, integrity, or availability of cluster resources.</td><td>The Envoy Proxy container&rsquo;s root-user configuration can be leveraged by an attacker to escalate privileges, execute a container breakout, and traverse across trust boundaries.</td><td>Low</td><td>By default, Envoy Gateway deployments do not use root users. Nonetheless, in case a custom image or deployment manifest is to be used, make sure Envoy Proxy pods run as a non-root user with a high UID within the container. Set runAsUser and runAsGroup security context options to specific UIDs (e.g., runAsUser: 1000 & runAsGroup: 3000) to ensure the container operates with the stipulated non-root user and group ID. If using helm chart deployment, define the user and group ID in the values.yaml file or via the command line during helm install / upgrade.</td></tr></tbody></table><h2 id=attack-trees>Attack Trees<a class=td-heading-self-link href=#attack-trees aria-label="Heading self-link"></a></h2><p>Attack trees offer a methodical way of describing the security of systems, based on varying attack patterns. It&rsquo;s important to approach the review of attack trees from a top-down perspective. The top node, also known as the root node, symbolises the attacker&rsquo;s primary objective. This goal is then broken down into subsidiary aims, each reflecting a different strategy to attain the root objective. This deconstruction persists until reaching the lowest level objectives or &rsquo;leaf nodes&rsquo;, which depict attacks that can be directly launched.</p><p>It is essential to note that attack trees presented here are speculative paths for potential exploitation. The Envoy Gateway project is in a continuous development cycle, and as the project evolves, new vulnerabilities may be exposed, or additional controls could be introduced. Therefore, the threats illustrated in the attack trees should be perceived as point-in-time reflections of the project’s current state at the time of writing this threat model.</p><h3 id=node-id-schema>Node ID Schema<a class=td-heading-self-link href=#node-id-schema aria-label="Heading self-link"></a></h3><p>Each node in the attack tree is assigned a unique identifier following the AT#-## schema. This allows easy reference to specific nodes in the attack trees throughout the threat model. The first part of the ID (AT#) signifies the attack tree number, while the second part (##) represents the node number within that tree.</p><h3 id=logical-operators>Logical Operators<a class=td-heading-self-link href=#logical-operators aria-label="Heading self-link"></a></h3><p>Logical AND/OR operators are used to represent the relationship between parent and child nodes. An AND operator means that all child nodes must be achieved to satisfy the parent node. An OR operator between a parent node and its child nodes means that any of the child nodes can be achieved to satisfy the parent node.</p><h3 id=attack-tree-node-legend>Attack Tree Node Legend<a class=td-heading-self-link href=#attack-tree-node-legend aria-label="Heading self-link"></a></h3><p><img alt="AT Legend" src=/img/AT-legend.png></p><h3 id=at0>AT0<a class=td-heading-self-link href=#at0 aria-label="Heading self-link"></a></h3><p><img alt=AT0 src=/img/AT0.png></p><h3 id=at1>AT1<a class=td-heading-self-link href=#at1 aria-label="Heading self-link"></a></h3><p><img alt=AT1 src=/img/AT1.png></p><h3 id=at2>AT2<a class=td-heading-self-link href=#at2 aria-label="Heading self-link"></a></h3><p><img alt=AT2 src=/img/AT2.png></p><h3 id=at3>AT3<a class=td-heading-self-link href=#at3 aria-label="Heading self-link"></a></h3><p><img alt=AT3 src=/img/AT3.png></p><h3 id=at4>AT4<a class=td-heading-self-link href=#at4 aria-label="Heading self-link"></a></h3><p><img alt=AT4 src=/img/AT4.png></p><h3 id=at5>AT5<a class=td-heading-self-link href=#at5 aria-label="Heading self-link"></a></h3><p><img alt=AT5 src=/img/AT5.png></p><h3 id=at6>AT6<a class=td-heading-self-link href=#at6 aria-label="Heading self-link"></a></h3><p><img alt=AT6 src=/img/AT6.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-da56a3394272e61b500ffb55e8163aca>2.3.14 - TLS Passthrough</h1><p>This task will walk through the steps required to configure TLS Passthrough via Envoy Gateway. Unlike configuring
Secure Gateways, where the Gateway terminates the client TLS connection, TLS Passthrough allows the application itself
to terminate the TLS connection, while the Gateway routes the requests to the application based on SNI headers.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Service to terminate client TLS connections.
For the application, we&rsquo;ll deploy a sample echoserver app, with the certificates loaded in the application Pod.</p><p><strong>Note:</strong> These certificates will not be used by the Gateway, but will remain in the application scope.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>passthrough.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out passthrough.example.com.csr -newkey rsa:2048 -nodes -keyout passthrough.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=passthrough.example.com/O=some organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -sha256 -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in passthrough.example.com.csr -out passthrough.example.com.crt
</span></span></code></pre></div><p>Store the cert/keys in A Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls server-certs --key<span style=color:#ce5c00;font-weight:700>=</span>passthrough.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>passthrough.example.com.crt
</span></span></code></pre></div><h2 id=deployment>Deployment<a class=td-heading-self-link href=#deployment aria-label="Heading self-link"></a></h2><p>Deploy TLS Passthrough application Deployment, Service and TLSRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/tls-passthrough.yaml
</span></span></code></pre></div><p>Patch the Gateway from the Quickstart to include a TLS listener that listens on port <code>6443</code> and is configured for
TLS mode Passthrough:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      hostname: passthrough.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 6443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Passthrough
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#39;</span>
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-01-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-01-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><p>You can also test the same functionality by sending traffic to the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Curl the example app through the Gateway, e.g. Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:passthrough.example.com --resolve <span style=color:#4e9a06>&#34;passthrough.example.com:6443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://passthrough.example.com:6443/get
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 6043:6443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v --resolve <span style=color:#4e9a06>&#34;passthrough.example.com:6043:127.0.0.1&#34;</span> https://passthrough.example.com:6043 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert passthrough.example.com.crt
</span></span></code></pre></div></div></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret/server-certs
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b88ecf395aa21049a39c81de50ac8c8c>2.3.15 - TLS Termination for TCP</h1><p>This task will walk through the steps required to configure TLS Terminate mode for TCP traffic via Envoy Gateway.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Install the TLS Termination for TCP example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/tls-termination.yaml
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="with external loadbalancer support" aria-controls=tabs-01-00 aria-selected=true>
With External LoadBalancer Support</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="without loadbalancer support" aria-controls=tabs-01-01 aria-selected=false>
Without LoadBalancer Support</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com/get
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get
</span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e1fb1672c85ed0bb1882a3481be7cf46>2.3.16 - Using cert-manager For TLS Termination</h1><p>This task shows how to set up <a href=https://cert-manager.io/>cert-manager</a> to automatically create certificates and secrets for use by Envoy Gateway.
It will first show how to enable the self-sign issuer, which is useful to test that cert-manager and Envoy Gateway can talk to each other.
Then it shows how to use <a href=https://letsencrypt.org/docs/staging-environment/>Let&rsquo;s Encrypt&rsquo;s staging environment</a>.
Changing to the Let&rsquo;s Encrypt production environment is straight-forward after that.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>A Kubernetes cluster and a configured <code>kubectl</code>.</li><li>The <code>helm</code> command.</li><li>The <code>curl</code> command or similar for testing HTTPS requests.</li><li>For the ACME HTTP-01 challenge to work<ul><li>your Gateway must be reachable on the public Internet.</li><li>the domain name you use (we use <code>www.example.com</code>) must point to the Gateway&rsquo;s external IP(s).</li></ul></li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=deploying-cert-manager>Deploying cert-manager<a class=td-heading-self-link href=#deploying-cert-manager aria-label="Heading self-link"></a></h2><p><em>This is a summary of <a href=https://cert-manager.io/docs/installation/helm/>cert-manager Installation with Helm</a>.</em></p><p>Installing cert-manager is straight-forward, but currently (v1.12) requires setting a feature gate to enable the Gateway API support.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> helm repo add jetstack https://charts.jetstack.io
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> helm upgrade --install --create-namespace --namespace cert-manager --set <span style=color:#000>installCRDs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --set <span style=color:#000>featureGates</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ExperimentalGatewayAPISupport</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> cert-manager jetstack/cert-manager
</span></span></code></pre></div><p>You should now have <code>cert-manager</code> running with nothing to do:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl <span style=color:#204a87>wait</span> --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available deployment -n cert-manager --all
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>deployment.apps/cert-manager condition met
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>deployment.apps/cert-manager-cainjector condition met
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>deployment.apps/cert-manager-webhook condition met
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> kubectl get -n cert-manager deployment
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>cert-manager              1/1     1            1           42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>cert-manager-cainjector   1/1     1            1           42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>cert-manager-webhook      1/1     1            1           42m
</span></span></span></code></pre></div><h2 id=a-self-signing-issuer>A Self-Signing Issuer<a class=td-heading-self-link href=#a-self-signing-issuer aria-label="Heading self-link"></a></h2><p>cert-manager can have any number of <em>issuer</em> configurations.
The simplest issuer type is <a href=https://cert-manager.io/docs/configuration/selfsigned/>SelfSigned</a>.
It simply takes the certificate request and signs it with the private key it generates for the TLS Secret.</p><pre tabindex=0><code>Self-signed certificates don&#39;t provide any help in establishing trust between certificates.
However, they are great for initial testing, due to their simplicity.
</code></pre><p>To install self-signing, run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: selfsigned
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  selfSigned: {}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><h2 id=creating-a-tls-gateway-listener>Creating a TLS Gateway Listener<a class=td-heading-self-link href=#creating-a-tls-gateway-listener aria-label="Heading self-link"></a></h2><p>We now have to patch the example Gateway to reference cert-manager:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl patch gateway/eg --patch <span style=color:#a40000>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    cert-manager.io/cluster-issuer: selfsigned
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    cert-manager.io/common-name: &#34;Hello World!&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  - name: https
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    hostname: www.example.com
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    tls:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        name: eg-https
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&#39; --type=merge
</span></span></span></code></pre></div><p>You could instead create a new Gateway serving HTTPS, if you&rsquo;d prefer.
cert-manager doesn&rsquo;t care, but we&rsquo;ll keep it all together in this task.</p><p>Nowadays, X.509 certificates don&rsquo;t use the subject Common Name for hostname matching, so you can set it to whatever you want, or leave it empty.
The important parts here are</p><ul><li>the annotation referencing the &ldquo;selfsigned&rdquo; ClusterIssuer we created above,</li><li>the <code>hostname</code>, which is required (but see <a href=https://github.com/cert-manager/cert-manager/issues/6051>#6051</a> for computing it based on attached HTTPRoutes), and</li><li>the named Secret, which is what cert-manager will create for us.</li></ul><p>The annotations are documented in <a href=https://cert-manager.io/docs/usage/gateway/#supported-annotations>Supported Annotations</a>.</p><p>Patching the Gateway makes cert-manager create a self-signed certificate within a few seconds.
Eventually, the Gateway becomes <code>Programmed</code> again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl <span style=color:#204a87>wait</span> --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Programmed gateway/eg
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>gateway.gateway.networking.k8s.io/eg condition met
</span></span></span></code></pre></div><h3 id=testing-the-gateway>Testing The Gateway<a class=td-heading-self-link href=#testing-the-gateway aria-label="Heading self-link"></a></h3><p>See <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/#testing>Testing in Secure Gateways</a> for the general idea.</p><p>Since we have a self-signed certificate, <code>curl</code> will by default reject it, requiring the <code>-k</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -kv -HHost:www.example.com https://127.0.0.1/get
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Server certificate:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  subject: CN=Hello World!
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h3 id=how-cert-manager-and-envoy-gateway-interact>How cert-manager and Envoy Gateway Interact<a class=td-heading-self-link href=#how-cert-manager-and-envoy-gateway-interact aria-label="Heading self-link"></a></h3><p><em>This explains <a href=https://cert-manager.io/docs/concepts/>cert-manager Concepts</a> in an Envoy Gateway context.</em></p><p>In the interaction between the two, cert-manager does all the heavy lifting.
It subscribes to changes to Gateway resources (using the <a href=https://github.com/cert-manager/cert-manager/tree/master/pkg/controller/certificate-shim/gateways><code>gateway-shim</code> component</a>.)
For any Gateway it finds, it looks for any <a href=https://gateway-api.sigs.k8s.io/guides/tls/#listeners-and-tls>TLS listeners</a>, and the associated <code>tls.certificateRefs</code>.
Note that while Gateway API supports multiple refs here, Envoy Gateway only uses one.
cert-manager also looks at the <code>hostname</code> of the listener to figure out which hosts the certificate is expected to cover.
More than one listener can use the same certificate Secret, which means cert-manager needs to find all listeners using the same Secret before deciding what to do.
If the <code>certificatRef</code> points to a valid certificate, given the hostnames found in listeners, cert-manager has nothing to do.</p><p>If there is no valid certificate, or it is about to expire, cert-manager&rsquo;s <code>gateway-shim</code> creates a Certificate resource, or updates the existing one.
cert-manager then follows the <a href=https://cert-manager.io/docs/concepts/certificate/#certificate-lifecycle>Certificate Lifecycle</a>.
To know how to issue the certificate, an ClusterIssuer is configured, and referenced through annotations on the Gateway resource, which you did above.
Once a matching ClusterIssuer is found, that plugin does what needs to be done to acquire a signed certificate.</p><p>In the case of the ACME protocol (used by Let&rsquo;s Encrypt), cert-manager can also use an HTTP Gateway to solve the HTTP-01 challenge type.
This is the other side of cert-manager&rsquo;s Gateway API support:
the <a href=https://github.com/cert-manager/cert-manager/tree/master/pkg/issuer/acme/http/httproute.go>ACME issuer</a> creates a temporary <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a>, lets the ACME server(s) query it, and deletes it again.</p><p>cert-manager then updates the Secret that the Gateway&rsquo;s listener points to in <code>tls.certificateRefs</code>.
Envoy Gateway picks up that the Secret has changed, and reloads the corresponding Envoy Proxy Deployments with the new private key and certificate.</p><p>As you can imagine, cert-manager requires quite broad permissions to update Secrets in any namespace, so the security-minded reader may want to look at the RBAC resources the Helm chart creates.</p><h2 id=using-the-acme-issuer-with-lets-encrypt-and-http-01>Using the ACME Issuer With Let&rsquo;s Encrypt and HTTP-01<a class=td-heading-self-link href=#using-the-acme-issuer-with-lets-encrypt-and-http-01 aria-label="Heading self-link"></a></h2><p>We will start using the Let&rsquo;s Encrypt staging environment, to spare their production environment.
Our Gateway already contains an HTTP listener, so we will use that for the HTTP-01 challenges.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> <span style=color:#000>CERT_MANAGER_CONTACT_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>git config user.email<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Or whatever...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: letsencrypt-staging
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  acme:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    server: https://acme-staging-v02.api.letsencrypt.org/directory
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    email: &#34;$CERT_MANAGER_CONTACT_EMAIL&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    privateKeySecretRef:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      name: letsencrypt-staging-account-key
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    solvers:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    - http01:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        gatewayHTTPRoute:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          - kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            name: eg
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            namespace: default
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><p>The important parts are</p><ul><li>using <code>spec.acme</code> with a server URI and contact email address, and</li><li>referencing our plain HTTP gateway so the challenge HTTPRoute is attached to the right place.</li></ul><p>Check the account registration process using the Ready condition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl <span style=color:#204a87>wait</span> --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Ready clusterissuer/letsencrypt-staging
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl describe clusterissuer/letsencrypt-staging
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Status:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Acme:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Uri:                   https://acme-staging-v02.api.letsencrypt.org/acme/acct/123456789
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Conditions:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Message:               The ACME account was registered with the ACME server
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Reason:                ACMEAccountRegistered
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Status:                True
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Type:                  Ready
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Now we&rsquo;re ready to update the Gateway annotation to use this issuer instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl annotate --overwrite gateway/eg cert-manager.io/cluster-issuer<span style=color:#ce5c00;font-weight:700>=</span>letsencrypt-staging
</span></span></code></pre></div><p>The Gateway should be picked up by cert-manager, which will create a new certificate for you, and replace the Secret.</p><p>You should see a new CertificateRequest to track:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get certificaterequest
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME             APPROVED   DENIED   READY   ISSUER                REQUESTOR                                         AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-https-xxxxx   True                True    selfsigned            system:serviceaccount:cert-manager:cert-manager   42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-https-xxxxx   True                True    letsencrypt-staging   system:serviceaccount:cert-manager:cert-manager   42m
</span></span></span></code></pre></div><h3 id=testing-the-gateway-1>Testing The Gateway<a class=td-heading-self-link href=#testing-the-gateway-1 aria-label="Heading self-link"></a></h3><p>We still require the <code>-k</code> flag, since the Let&rsquo;s Encrypt staging environment CA is not widely trusted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -kv -HHost:www.example.com https://127.0.0.1/get
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Server certificate:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  subject: CN=Hello World!
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  issuer: C=US; O=(STAGING) Let&#39;s Encrypt; CN=(STAGING) Ersatz Edamame E1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=using-the-lets-encrypt-production-environment>Using The Let&rsquo;s Encrypt Production Environment<a class=td-heading-self-link href=#using-the-lets-encrypt-production-environment aria-label="Heading self-link"></a></h2><p>Changing to the production environment is just a matter of replacing the server URI:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> <span style=color:#000>CERT_MANAGER_CONTACT_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>git config user.email<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Or whatever...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: letsencrypt
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  acme:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    server: https://acme-v02.api.letsencrypt.org/directory  # Removed &#34;-staging&#34;.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    email: &#34;$CERT_MANAGER_CONTACT_EMAIL&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    privateKeySecretRef:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      name: letsencrypt-account-key                         # Removed &#34;-staging&#34;.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    solvers:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    - http01:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        gatewayHTTPRoute:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          - kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            name: eg
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            namespace: default
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><p>And now you can update the Gateway listener to point to <code>letsencrypt</code> instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl annotate --overwrite gateway/eg cert-manager.io/cluster-issuer<span style=color:#ce5c00;font-weight:700>=</span>letsencrypt
</span></span></code></pre></div><p>As before, track it by looking at CertificateRequests.</p><h3 id=testing-the-gateway-2>Testing The Gateway<a class=td-heading-self-link href=#testing-the-gateway-2 aria-label="Heading self-link"></a></h3><p>Once the certificate has been replaced, we should finally be able to get rid of the <code>-k</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v -HHost:www.example.com --resolve www.example.com:127.0.0.1 https://www.example.com/get
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Server certificate:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  subject: CN=Hello World!
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  issuer: C=US; O=Let&#39;s Encrypt; CN=R3
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=collecting-garbage>Collecting Garbage<a class=td-heading-self-link href=#collecting-garbage aria-label="Heading self-link"></a></h2><p>You probably want to set the <code>cert-manager.io/revision-history-limit</code> annotation on your Gateway to make cert-manager prune the CertificateRequest history.</p><p>cert-manager <a href=https://github.com/cert-manager/cert-manager/blob/c5e6bf39d688d202592318eaf91988466a7ee37b/pkg/controller/certificate-shim/sync.go#L171>deletes unused Certificate resources</a>, and they are updated in-place when possible, so there should be no need for cleaning up Certificate resources.
The deletion is based on whether a Gateway still holds a <code>tls.certificateRefs</code> that requires the Certificate.</p><p>If you remove a TLS listener from a Gateway, you may still have a Secret lingering.
cert-manager can clean it up using <a href=https://cert-manager.io/docs/usage/certificate/#cleaning-up-secrets-when-certificates-are-deleted>a flag</a>.</p><h2 id=issuer-namespaces>Issuer Namespaces<a class=td-heading-self-link href=#issuer-namespaces aria-label="Heading self-link"></a></h2><p>We have used ClusterIssuer resources in this tutorial.
They are not bound to any namespace, and will read annotations from Gateways in any namespace.
You could also use <a href=https://cert-manager.io/docs/concepts/issuer/>Issuer</a>, which is bound to a namespace.
This is useful e.g. if you want to use different ACME accounts for different namespaces.</p><p>If you change the issuer kind, you also need to change the annotation key from <code>cert-manager.io/clusterissuer</code> to <code>cert-manager.io/issuer</code>.</p><h2 id=using-externaldns>Using ExternalDNS<a class=td-heading-self-link href=#using-externaldns aria-label="Heading self-link"></a></h2><p>The <a href=https://kubernetes-sigs.github.io/external-dns/latest/>ExternalDNS</a> controller maintains DNS records based on Kubernetes resources.
Together with cert-manager, this can be used to fully automate hostname management.
It can use various source resources, among them Gateway Routes.
Just specify a Gateway Route resource, let ExternalDNS create the domain records, and then cert-manager the TLS certificate.</p><p><a href=https://kubernetes-sigs.github.io/external-dns/latest/tutorials/gateway-api/>The tutorial on Gateway API</a> uses kubectl.
They also have a <a href=https://github.com/kubernetes-sigs/external-dns/blob/master/charts/external-dns/README.md>Helm chart</a>, which is easier to customize.
The only thing relevant to Envoy Gateway is to set the sources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># values.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>sources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-grpcroute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-tcproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-tlsroute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-udproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=monitoring-progress--troubleshooting>Monitoring Progress / Troubleshooting<a class=td-heading-self-link href=#monitoring-progress--troubleshooting aria-label="Heading self-link"></a></h2><p>You can monitor progress in several ways:</p><p>The Issuer has a Ready condition (though this is rather <a href=https://github.com/cert-manager/cert-manager/blob/c5e6bf39d688d202592318eaf91988466a7ee37b/pkg/issuer/selfsigned/setup.go#L32>boring</a> for the <code>selfSigned</code> type):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get issuer --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAMESPACE   NAME         READY   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>default     selfsigned   True    42m
</span></span></span></code></pre></div><p>The Gateway will say when it has an invalid certificate:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl describe gateway/eg
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Conditions:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Message:               Secret default/eg-https does not exist.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Reason:                InvalidCertificateRef
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Status:                False
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Type:                  ResolvedRefs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Message:               Listener is invalid, see other Conditions for details.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Reason:                Invalid
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Status:                False
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Type:                  Programmed
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Events:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Type     Reason     Age    From                       Message
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ----     ------     ----   ----                       -------
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Warning  BadConfig  42m    cert-manager-gateway-shim  Skipped a listener block: spec.listeners[1].hostname: Required value: the hostname cannot be empty
</span></span></span></code></pre></div><p>The main question is if cert-manager has picked up on the Gateway.
I.e., has it created a Certificate for it?
The above <code>describe</code> contains an event from <code>cert-manager-gateway-shim</code> telling you of one such issue.
Be aware that if you have a non-TLS listener in the Gateway, like we did, there will be events saying it is not eligible, which is of course expected.</p><p>Another option is looking at Deployment logs.
The cert-manager logs are not very verbose by default, but setting the Helm value <code>global.logLevel</code> to 6 will enable all debug logs (the default is 2.)
This will make them verbose enough to say why a Gateway wasn&rsquo;t considered (e.g. missing <code>hostname</code>, or <code>tls.mode</code> is not <code>Terminate</code>.)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl logs -n cert-manager deployment/cert-manager
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Simply listing Certificate resources may be useful, even if it just gives a yes/no answer:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get certificate --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAMESPACE   NAME       READY   SECRET     AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>default     eg-https   True    eg-https   42m
</span></span></span></code></pre></div><p>If there is a Certificate, then the <code>gateway-shim</code> has recognized the Gateway.
But is there a CertificateRequest for it?
(BTW, don&rsquo;t confuse this with a CertificateSigningRequest, which is a Kubernetes core resource type representing the same thing.)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get certificaterequest --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAMESPACE   NAME             APPROVED   DENIED   READY   ISSUER       REQUESTOR                                         AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>default     eg-https-xxxxx   True                True    selfsigned   system:serviceaccount:cert-manager:cert-manager   42m
</span></span></span></code></pre></div><p>The ACME issuer also has <code>Order</code> and <code>Challenge</code> resources to watch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get order --all-namespaces -o wide
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                                                     STATE     ISSUER                REASON   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>order.acme.cert-manager.io/envoy-https-xxxxx-123456789   pending   letsencrypt-staging            42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> kubectl get challenge --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                                                                    STATE     DOMAIN            AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>challenge.acme.cert-manager.io/envoy-https-xxxxx-123456789-1234567890   pending   www.example.com   42m
</span></span></span></code></pre></div><p>Using <code>kubetctl get -o wide</code> or <code>kubectl describe</code> on the Challenge will explain its state more.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get order --all-namespaces -o wide
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                                                     STATE   ISSUER                REASON   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>order.acme.cert-manager.io/envoy-https-xxxxx-123456789   valid   letsencrypt-staging            42m
</span></span></span></code></pre></div><p>Finally, since cert-manager creates the Secret referenced by the Gateway listener as its last step, we can also look for that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get secret secret/eg-https
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME       TYPE                DATA   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-https   kubernetes.io/tls   3      42m
</span></span></span></code></pre></div><h2 id=clean-up>Clean Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><ul><li>Uninstall cert-manager: <code>helm uninstall --namespace cert-manager cert-manager</code></li><li>Delete the <code>cert-manager</code> namespace: <code>kubectl delete namespace/cert-manager</code></li><li>Delete the <code>https</code> listener from <code>gateway/eg</code>.</li><li>Delete <code>secret/eg-https</code>.</li></ul><h2 id=see-also>See Also<a class=td-heading-self-link href=#see-also aria-label="Heading self-link"></a></h2><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/secure-gateways/>Secure Gateways</a></li><li><a href=https://cert-manager.io/docs/usage/gateway/>Securing gateway.networking.k8s.io Gateway Resources</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-87c7327640420f735c79ec6ee7edab5a>2.4 - Extensibility</h1><div class=lead>This section includes Extensibility tasks.</div></div><div class=td-content><h1 id=pg-e14cd53e9c5ff38545c40940595efb06>2.4.1 - Build a Wasm image</h1><p>Envoy Gateway supports two types of Wasm extensions within the <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> API: HTTP Wasm Extensions and Image Wasm Extensions.
Packaging a Wasm extension as an OCI image is beneficial because it simplifies versioning and distribution for users.
Additionally, users can leverage existing image toolchain to build and manage Wasm images.</p><p>This document describes how to build OCI images which are consumable by Envoy Gateway.</p><h2 id=wasm-image-formats>Wasm Image Formats<a class=td-heading-self-link href=#wasm-image-formats aria-label="Heading self-link"></a></h2><p>There are two types of images that are supported by Envoy Gateway. One is in the Docker format, and another is the standard
OCI specification compliant format. Please note that both of them are supported by any OCI registries. You can choose
either format depending on your preference, and both types of images are consumable by Envoy Gateway <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> API.</p><h2 id=build-wasm-docker-image>Build Wasm Docker image<a class=td-heading-self-link href=#build-wasm-docker-image aria-label="Heading self-link"></a></h2><p>We assume that you have a valid Wasm binary named <code>plugin.wasm</code>. Then you can build a Wasm Docker image with the Docker CLI.</p><ol><li>First, we prepare the following Dockerfile:</li></ol><pre tabindex=0><code>$ cat Dockerfile
FROM scratch

COPY plugin.wasm ./
</code></pre><p><strong>Note: you must have exactly one <code>COPY</code> instruction in the Dockerfile in order to end up having only one layer in produced images.</strong></p><ol start=2><li>Then, build your image via <code>docker build</code> command</li></ol><pre tabindex=0><code>$ docker build . -t my-registry/mywasm:0.1.0
</code></pre><ol start=3><li>Finally, push the image to your registry via <code>docker push</code> command</li></ol><pre tabindex=0><code>$ docker push my-registry/mywasm:0.1.0
</code></pre><h2 id=build-wasm-oci-image>Build Wasm OCI image<a class=td-heading-self-link href=#build-wasm-oci-image aria-label="Heading self-link"></a></h2><p>We assume that you have a valid Wasm binary named <code>plugin.wasm</code>, and you have <a href=https://buildah.io/>buildah</a> installed on your machine.
Then you can build a Wasm OCI image with the <code>buildah</code> CLI.</p><ol><li>First, we create a working container from <code>scratch</code> base image with <code>buildah from</code> command.</li></ol><pre tabindex=0><code>$ buildah --name mywasm from scratch
mywasm
</code></pre><ol start=2><li>Then copy the Wasm binary into that base image by <code>buildah copy</code> command to create the layer.</li></ol><pre tabindex=0><code>$ buildah copy mywasm plugin.wasm ./
af82a227630327c24026d7c6d3057c3d5478b14426b74c547df011ca5f23d271
</code></pre><p><strong>Note: you must execute <code>buildah copy</code> exactly once in order to end up having only one layer in produced images</strong></p><ol start=4><li>Now, you can build an OCI image and push it to your registry via <code>buildah commit</code> command</li></ol><pre tabindex=0><code>$ buildah commit mywasm docker://my-remote-registry/mywasm:0.1.0
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-74beceb6b4d0483feb4800d938f272df>2.4.2 - Envoy Patch Policy</h1><p>This task explains the usage of the <a href=../../../api/extension_types#envoypatchpolicy>EnvoyPatchPolicy</a> API.
<strong>Note:</strong> This API is meant for users extremely familiar with Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/dynamic_configuration>xDS</a> semantics.
Also before considering this API for production use cases, please be aware that this API
is unstable and the outcome may change across versions. Use at your own risk.</p><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>The <a href=../../../api/extension_types#envoypatchpolicy>EnvoyPatchPolicy</a> API allows user to modify the output <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/dynamic_configuration>xDS</a>
configuration generated by Envoy Gateway intended for EnvoyProxy,
using <a href=https://datatracker.ietf.org/doc/html/rfc6902>JSON Patch</a> semantics.</p><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>This API was introduced to allow advanced users to be able to leverage Envoy Proxy functionality
not exposed by Envoy Gateway APIs today.</p><h2 id=quickstart>Quickstart<a class=td-heading-self-link href=#quickstart aria-label="Heading self-link"></a></h2><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=enable-envoypatchpolicy>Enable EnvoyPatchPolicy<a class=td-heading-self-link href=#enable-envoypatchpolicy aria-label="Heading self-link"></a></h3><ul><li><p>By default <a href=../../../api/extension_types#envoypatchpolicy>EnvoyPatchPolicy</a> is disabled. Lets enable it in the <a href=../../../api/extension_types#envoygateway>EnvoyGateway</a> startup configuration</p></li><li><p>The default installation of Envoy Gateway installs a default <a href=../../../api/extension_types#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In the next step, we will update this resource to enable EnvoyPatchPolicy.</p></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      enableEnvoyPatchPolicy: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      enableEnvoyPatchPolicy: true</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><h3 id=customize-response>Customize Response<a class=td-heading-self-link href=#customize-response aria-label="Heading self-link"></a></h3><ul><li><p>Use EnvoyProxy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/local_reply>Local Reply Modification</a> feature to return a custom response back to the client when
the status code is <code>404</code></p></li><li><p>Apply the configuration</p></li></ul><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyPatchPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-response-patch-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # The listener name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/eg/http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          mappers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - filter:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              status_code_filter:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                comparison:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  op: EQ
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    default_value: 404
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    runtime_key: key_b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            status_code: 406
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              inline_string: &#34;could not find what you are looking for&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-response-patch-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># The listener name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/eg/http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>add</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>mappers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>status_code_filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>comparison</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EQ</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>default_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>404</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>runtime_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key_b</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>status_code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>406</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>inline_string</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;could not find what you are looking for&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>When mergeGateways is enabled, there will be one Envoy deployment for all Gateways in the cluster.
Then the EnvoyPatchPolicy should target a specific GatewayClass.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyPatchPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-response-patch-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # The listener name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/eg/http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          mappers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - filter:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              status_code_filter:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                comparison:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  op: EQ
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    default_value: 404
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    runtime_key: key_b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            status_code: 406
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              inline_string: &#34;could not find what you are looking for&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-response-patch-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># The listener name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/eg/http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>add</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>mappers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>status_code_filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>comparison</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EQ</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>default_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>404</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>runtime_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key_b</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>status_code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>406</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>inline_string</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;could not find what you are looking for&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li>Edit the HTTPRoute resource from the Quickstart to only match on paths with value <code>/get</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch httproute backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/rules/0/matches/0/path/value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value: /get
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><ul><li>Test it out by specifying a path apart from <code>/get</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ curl --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/find
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8888</span>
</span></span><span style=display:flex><span>could not find what you are looking <span style=color:#204a87;font-weight:700>for</span>
</span></span></code></pre></div><h3 id=customize-virtualhost-by-name>Customize VirtualHost by name<a class=td-heading-self-link href=#customize-virtualhost-by-name aria-label="Heading self-link"></a></h3><ul><li>Use EnvoyProxy&rsquo;s <code>include_attempt_count_in_response</code> feature to include the attempt count as header in the downstream response.</li><li>Apply the configuration</li></ul><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyPatchPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: include-attempts
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.config.route.v3.RouteConfiguration&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # The RouteConfiguration name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/eg/http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # Every virtual_host that ends with &#39;www_example_com&#39; (using RegEx Filter)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        jsonPath: &#34;..virtual_hosts[?match(@.name, &#39;.*www_example_com&#39;)]&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # If the property does not exists, it can not be selected with jsonPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # Therefore the new property must be set in path
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;include_attempt_count_in_response&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include-attempts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;type.googleapis.com/envoy.config.route.v3.RouteConfiguration&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># The RouteConfiguration name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/eg/http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>add</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># Every virtual_host that ends with &#39;www_example_com&#39; (using RegEx Filter)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>jsonPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;..virtual_hosts[?match(@.name, &#39;.*www_example_com&#39;)]&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># If the property does not exists, it can not be selected with jsonPath</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># Therefore the new property must be set in path</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;include_attempt_count_in_response&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><ul><li>Test it out by looking at the response headers</li></ul><pre tabindex=0><code>$ curl -v --header &#34;Host: www.example.com&#34; http://localhost:8888/
...
&lt; x-envoy-attempt-count: 1
...
</code></pre><h2 id=debugging>Debugging<a class=td-heading-self-link href=#debugging aria-label="Heading self-link"></a></h2><h3 id=runtime>Runtime<a class=td-heading-self-link href=#runtime aria-label="Heading self-link"></a></h3><ul><li>The <code>Status</code> subresource should have information about the status of the resource. Make sure
<code>Accepted=True</code> and <code>Programmed=True</code> conditions are set to ensure that the policy has been
applied to Envoy Proxy.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      {&#34;apiVersion&#34;:&#34;gateway.envoyproxy.io/v1alpha1&#34;,&#34;kind&#34;:&#34;EnvoyPatchPolicy&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;custom-response-patch-policy&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;jsonPatches&#34;:[{&#34;name&#34;:&#34;default/eg/http&#34;,&#34;operation&#34;:{&#34;op&#34;:&#34;add&#34;,&#34;path&#34;:&#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;,&#34;value&#34;:{&#34;mappers&#34;:[{&#34;body&#34;:{&#34;inline_string&#34;:&#34;could not find what you are looking for&#34;},&#34;filter&#34;:{&#34;status_code_filter&#34;:{&#34;comparison&#34;:{&#34;op&#34;:&#34;EQ&#34;,&#34;value&#34;:{&#34;default_value&#34;:404}}}}}]}},&#34;type&#34;:&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;}],&#34;priority&#34;:0,&#34;targetRef&#34;:{&#34;group&#34;:&#34;gateway.networking.k8s.io&#34;,&#34;kind&#34;:&#34;Gateway&#34;,&#34;name&#34;:&#34;eg&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;type&#34;:&#34;JSONPatch&#34;}}</span><span style=color:#f8f8f8;text-decoration:underline>      
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-07-31T21:47:53Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>generation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-response-patch-policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;10265&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a35bda6e-a0cc-46d7-a63a-cee765174bc3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default/eg/http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>operation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>add</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/default_filter_chain/filters/0/typed_config/local_reply_config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>mappers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>inline_string</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>could not find what you are looking for</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>status_code_filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>comparison</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>op</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EQ</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>default_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>404</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.listener.v3.Listener</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-07-31T21:48:19Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyPatchPolicy has been accepted.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>observedGeneration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-07-31T21:48:19Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>successfully applied patches.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=offline>Offline<a class=td-heading-self-link href=#offline aria-label="Heading self-link"></a></h3><ul><li>You can use <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/egctl/#egctl-experimental-translate>egctl x translate</a> to validate the translated xds output.</li></ul><h2 id=caveats>Caveats<a class=td-heading-self-link href=#caveats aria-label="Heading self-link"></a></h2><p>This API will always be an unstable API and the same outcome cannot be guaranteed
across versions for these reasons</p><ul><li>The Envoy Proxy API might deprecate and remove API fields</li><li>Envoy Gateway might alter the xDS translation creating a different xDS output
such as changing the <code>name</code> field of resources.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fe1c0cb314cfa17d83c75a99474c4908>2.4.3 - Envoy Gateway Extension Server</h1><p>This task explains how to extend Envoy Gateway using an Extension Server. Envoy Gateway
can be configured to call an external server over gRPC with the xDS configuration <em>before</em>
it is sent to Envoy Proxy. The external server can modify the provided configuration
programmatically using any semantics supported by the <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/dynamic_configuration>xDS</a> API.</p><p>Using an extension server allows vendors to add xDS configuration that Envoy Gateway itself
doesn&rsquo;t support with a very high level of control over the generated xDS configuration.</p><p><strong>Note:</strong> Modifying the xDS configuration generated by Envoy Gateway may break functionality
configured by native Envoy Gateway means. Like other cases where the xDS configuration
is modified outside of Envoy Gateway&rsquo;s control, this is risky and should be tested thoroughly,
especially when using the same extension server across different Envoy Gateway versions.</p><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>One of the Envoy Gateway project goals is to &ldquo;provide a common foundation for vendors to
build value-added products without having to re-engineer fundamental interactions&rdquo;. The
Envoy Gateway Extension Server provides a mechanism where Envoy Gateway tracks all provider
resources and then calls a set of hooks that allow the generated xDS configuration to be
modified before it is sent to Envoy Proxy. See the <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/extending-envoy-gateway/>design documentation</a> for full details.</p><p>This task sets up an example extension server that adds the Envoy Proxy Basic Authentication
HTTP filter to all the listeners generated by Envoy Gateway. The example extension server
includes its own CRD which allows defining username/password pairs that will be accepted by
the Envoy Proxy.</p><p><strong>Note:</strong> Envoy Gateway supports adding Basic Authentication to routes using a <a href=/eg-pr-preview/5-test-docs-preview/latest/api/extension_types/#securitypolicy>SecurityPolicy</a>.
See <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/security/basic-auth/>this task</a> for the preferred way to configure Basic
Authentication.</p><h2 id=quickstart>Quickstart<a class=td-heading-self-link href=#quickstart aria-label="Heading self-link"></a></h2><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h3 id=build-and-run-the-example-extension-server>Build and run the example Extension Server<a class=td-heading-self-link href=#build-and-run-the-example-extension-server aria-label="Heading self-link"></a></h3><p>Build and deploy the example extension server in the <code>examples/extension-server</code> folder into the cluster
running Envoy Gateway.</p><ul><li><p>Build the extension server image</p><p><strong>Note:</strong> The provided <code>Makefile</code> builds an image with the name <code>extension-server:latest</code>. You may need to create
a different tag for it in order to allow Kubernetes to pull it correctly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make image
</span></span></code></pre></div></li><li><p>Publish the extension server image in your docker repository</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="local kind server" aria-controls=tabs-01-00 aria-selected=true>
local kind server</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="other kubernetes server" aria-controls=tabs-01-01 aria-selected=false>
other Kubernetes server</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kind load docker-image --name envoy-gateway extension-server:latest
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag extension-server:latest <span style=color:#000>$YOUR_DOCKER_REPO</span>
</span></span><span style=display:flex><span>docker push <span style=color:#000>$YOUR_DOCKER_REPO</span>
</span></span></code></pre></div></div></div></li><li><p>Deploy the extension server in your cluster</p><p>If you are using your own docker image repository, make sure to update the <code>values.yaml</code> with the correct
image name and tag.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install -n envoy-gateway-system extension-server ./examples/extension-server/charts/extension-server
</span></span></code></pre></div></li></ul><h3 id=configure-envoy-gateway>Configure Envoy Gateway<a class=td-heading-self-link href=#configure-envoy-gateway aria-label="Heading self-link"></a></h3><ul><li><p>Grant Envoy Gateway&rsquo;s <code>ServiceAccount</code> permission to access the extension server&rsquo;s CRD</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create clusterrole listener-context-example-viewer <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>           --verb<span style=color:#ce5c00;font-weight:700>=</span>get,list,watch  <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>           --resource<span style=color:#ce5c00;font-weight:700>=</span>ListenerContextExample
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create clusterrolebinding envoy-gateway-listener-context <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>           --clusterrole<span style=color:#ce5c00;font-weight:700>=</span>listener-context-example-viewer <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>           --serviceaccount<span style=color:#ce5c00;font-weight:700>=</span>envoy-gateway-system:envoy-gateway
</span></span></code></pre></div></li><li><p>Configure Envoy Gateway to use the Extension Server</p><p>Add the following fragment to Envoy Gateway&rsquo;s configmap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    extensionManager:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # Envoy Gateway will watch these resource kinds and use them as extension policies
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # which can be attached to Gateway resources.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      policyResources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - group: example.extensions.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: ListenerContextExample
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      hooks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # The type of hooks that should be invoked
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        xdsTranslator:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          post:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - HTTPListener
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      service:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # The service that is hosting the extension server
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        fqdn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: extension-server.envoy-gateway-system.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 5005
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>After updating Envoy Gateway&rsquo;s configmap, restart Envoy Gateway.</p></li></ul><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>The extension server adds the Basic Authentication HTTP filter to all listeners configured by
Envoy Gateway. Initially there are no valid user/password combinations available. Accessing the
example backend should fail with a 401 status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/example&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /example HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> 
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 401 Unauthorized
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; www-authenticate: Basic realm=&#34;http://www.example.com/example&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 58
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: text/plain
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Mon, 08 Jul 2024 10:53:11 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; 
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>User authentication failed. Missing username and password.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Add a new Username/Password combination using the example extension server&rsquo;s CRD:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt; EOF 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: example.extensions.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ListenerContextExample
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: listeneruser
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  username: user
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  password: p@ssw0rd
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Authenticating with this user/password combination will now work.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/example  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span>   --user <span style=color:#4e9a06>&#39;user:p@ssw0rd&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /example HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Authorization: Basic <span style=color:#000>dXNlcm5hbWU6cEBzc3cwcmQ</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> 
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Mon, 08 Jul 2024 10:56:17 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 559
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; 
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Authorization&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;Basic dXNlcm5hbWU6cEBzc3cwcmQ=&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Example-Ext&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;user&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-60820af16b2050bdafa3cc2e04280f7a>2.4.4 - External Processing</h1><p>This task provides instructions for configuring external processing.</p><p>External processing calls an external gRPC service to process HTTP requests and responses.
The external processing service can inspect and mutate requests and responses.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> that allows the user to configure external processing.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=grpc-external-processing-service>GRPC External Processing Service<a class=td-heading-self-link href=#grpc-external-processing-service aria-label="Heading self-link"></a></h2><h3 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h3><p>Install a demo GRPC service that will be used as the external processing service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/ext-proc-grpc-service.yaml
</span></span></code></pre></div><p>Create a new HTTPRoute resource to route traffic on the path <code>/myapp</code> to the backend service.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000   
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>   
</span></span></span></code></pre></div></div></div><p>Verify the HTTPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/myapp -o yaml
</span></span></code></pre></div><h3 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h3><p>Create a new EnvoyExtensionPolicy resource to configure the external processing service. This EnvoyExtensionPolicy targets the HTTPRoute
&ldquo;myApp&rdquo; created in the previous step. It calls the GRPC external processing service &ldquo;grpc-ext-proc&rdquo; on port 9002 for
processing.</p><p>By default, requests and responses are not sent to the external processor. The <code>processingMode</code> struct is used to define what should be sent to the external processor.
In this example, we configure the following processing modes:</p><ul><li>The empty <code>request</code> field configures envoy to send request headers to the external processor.</li><li>The <code>response</code> field includes configuration for body processing. As a result, response headers are sent to the external processor. Additionally, the response body is streamed to the external processor.</li></ul><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyExtensionPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ext-proc-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: myapp
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  extProc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: grpc-ext-proc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    processingMode:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      request: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      response: 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        body: Streamed 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyExtensionPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ext-proc-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extProc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-proc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>processingMode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>request</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>response</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>body</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Streamed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the Envoy Extension Policy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get envoyextensionpolicy/ext-proc-example -o yaml
</span></span></code></pre></div><p>Because the gRPC external processing service is enabled with TLS, a <a href=https://gateway-api.sigs.k8s.io/api-types/backendtlspolicy/>BackendTLSPolicy</a> needs to be created to configure
the communication between the Envoy proxy and the gRPC auth service.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTLSPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: grpc-ext-proc-btls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: &#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: grpc-ext-proc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: &#34;9002&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  validation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    caCertificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: grpc-ext-proc-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      group: &#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    hostname: grpc-ext-proc.envoygateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1alpha3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendTLSPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-proc-btls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-proc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;9002&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>validation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>caCertificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-proc-ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc-ext-proc.envoygateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the BackendTLSPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get backendtlspolicy/grpc-ext-proc-btls -o yaml
</span></span></code></pre></div><h3 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h3><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Send a request to the backend service without <code>Authentication</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/myapp&#34;</span>
</span></span></code></pre></div><p>You should see that the external processor added headers:</p><ul><li><code>x-request-ext-processed</code> - this header was added before the request was forwarded to the backend</li><li><code>x-response-ext-processed</code>- this header was added before the response was returned to the client</li></ul><pre tabindex=0><code>curl -v -H &#34;Host: www.example.com&#34;  http://localhost:10080/myapp
[...]
&lt; HTTP/1.1 200 OK
&lt; content-type: application/json
&lt; x-content-type-options: nosniff
&lt; date: Fri, 14 Jun 2024 19:30:40 GMT
&lt; content-length: 502
&lt; x-response-ext-processed: true
&lt;
{
 &#34;path&#34;: &#34;/myapp&#34;,
 &#34;host&#34;: &#34;www.example.com&#34;,
 &#34;method&#34;: &#34;GET&#34;,
 &#34;proto&#34;: &#34;HTTP/1.1&#34;,
 &#34;headers&#34;: {
[...] 
  &#34;X-Request-Ext-Processed&#34;: [
   &#34;true&#34;
  ],
[...]
 }
</code></pre><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the demo auth services, HTTPRoute, EnvoyExtensionPolicy and BackendTLSPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/ext-proc-grpc-service.yaml
</span></span><span style=display:flex><span>kubectl delete httproute/myapp
</span></span><span style=display:flex><span>kubectl delete envoyextensionpolicy/ext-proc-example
</span></span><span style=display:flex><span>kubectl delete backendtlspolicy/grpc-ext-proc-btls
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd38ea26519dd8dc23463c3617afd710>2.4.5 - Wasm Extensions</h1><p>This task provides instructions for extending Envoy Gateway with WebAssembly (Wasm) extensions.</p><p>Wasm extensions allow you to extend the functionality of Envoy Gateway by running custom code against HTTP requests and responses,
without modifying the Envoy Gateway binary. These extensions can be written in any language that compiles to Wasm, such as C++, Rust, AssemblyScript, or TinyGo.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> that allows the user to configure Wasm extensions.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway>Gateway</a> and <a href=https://gateway-api.sigs.k8s.io/api-types/httproute>HTTPRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Envoy Gateway supports two types of Wasm extensions:</p><ul><li>HTTP Wasm Extension: The Wasm extension is fetched from a remote URL.</li><li>Image Wasm Extension: The Wasm extension is packaged as an OCI image and fetched from an image registry.</li></ul><p>The following example demonstrates how to configure an <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> to attach a Wasm extension to an <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> .
This Wasm extension adds a custom header <code>x-wasm-custom: FOO</code> to the response.</p><h3 id=http-wasm-extension>HTTP Wasm Extension<a class=td-heading-self-link href=#http-wasm-extension aria-label="Heading self-link"></a></h3><p>This <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> configuration fetches the Wasm extension from an HTTP URL.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyExtensionPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: wasm-test
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  wasm:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: wasm-filter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rootID: my_root_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    code:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      http:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        url: https://raw.githubusercontent.com/envoyproxy/examples/main/wasm-cc/lib/envoy_filter_http_wasm_example.wasm
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        sha256: 79c9f85128bb0177b6511afa85d587224efded376ac0ef76df56595f1e6315c0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyExtensionPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>wasm-test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>wasm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>wasm-filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rootID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my_root_id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://raw.githubusercontent.com/envoyproxy/examples/main/wasm-cc/lib/envoy_filter_http_wasm_example.wasm</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>sha256</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>79c9f85128bb0177b6511afa85d587224efded376ac0ef76df56595f1e6315c0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the EnvoyExtensionPolicy status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get envoyextensionpolicy/http-wasm-source-test -o yaml
</span></span></code></pre></div><h3 id=image-wasm-extension>Image Wasm Extension<a class=td-heading-self-link href=#image-wasm-extension aria-label="Heading self-link"></a></h3><p>This <a href=../../../api/extension_types#envoyextensionpolicy>EnvoyExtensionPolicy</a> configuration fetches the Wasm extension from an OCI image.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyExtensionPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: wasm-test
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  wasm:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: wasm-filter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rootID: my_root_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    code:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Image
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      image:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        url: zhaohuabing/testwasm:v0.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyExtensionPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>wasm-test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>targetRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>wasm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>wasm-filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rootID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my_root_id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>code</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Image</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>zhaohuabing/testwasm:v0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify the EnvoyExtensionPolicy status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get envoyextensionpolicy/http-wasm-source-test -o yaml
</span></span></code></pre></div><h3 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h3><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><p>Send a request to the backend service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><p>You should see that the wasm extension has added this header to the response:</p><pre tabindex=0><code>x-wasm-custom: FOO
</code></pre><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the EnvoyExtensionPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete envoyextensionpolicy/wasm-test
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-061f956bbc8d624938772636d479e904>2.5 - Observability</h1><div class=lead>This section includes Observability tasks.</div></div><div class=td-content><h1 id=pg-704c3841c948479223509ac1feebb5db>2.5.1 - Gateway API Metrics</h1><p>Resource metrics for Gateway API objects are available using the <a href=https://github.com/Kuadrant/gateway-api-state-metrics>Gateway API State Metrics</a> project.
The project also provides example dashboard for visualising the metrics using Grafana, and example alerts using Prometheus & Alertmanager.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>Run the following commands to install the metrics stack, with the Gateway API State Metrics configuration, on your kubernetes cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply --server-side -f https://raw.githubusercontent.com/Kuadrant/gateway-api-state-metrics/main/config/examples/kube-prometheus/bundle_crd.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/Kuadrant/gateway-api-state-metrics/main/config/examples/kube-prometheus/bundle.yaml
</span></span></code></pre></div><h2 id=metrics-and-alerts>Metrics and Alerts<a class=td-heading-self-link href=#metrics-and-alerts aria-label="Heading self-link"></a></h2><p>To access the Prometheus UI, wait for the statefulset to be ready, then use the port-forward command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This first command may fail if the statefulset has not been created yet.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># In that case, try again until you get a message like &#39;Waiting for 2 pods to be ready...&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># or &#39;statefulset rolling update complete 2 pods...&#39;</span>
</span></span><span style=display:flex><span>kubectl -n monitoring rollout status --watch --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m statefulset/prometheus-k8s
</span></span><span style=display:flex><span>kubectl -n monitoring port-forward service/prometheus-k8s 9090:9090 &gt; /dev/null <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Navigate to <code>http://localhost:9090</code>.
Metrics can be queried from the &lsquo;Graph&rsquo; tab e.g. <code>gatewayapi_gateway_created</code>
See the <a href=https://github.com/Kuadrant/gateway-api-state-metrics/tree/main#metrics>Gateway API State Metrics README</a> for the full list of Gateway API metrics available.</p><p>Alerts can be seen in the &lsquo;Alerts&rsquo; tab.
Gateway API specific alerts will be grouped under the &lsquo;gateway-api.rules&rsquo; heading.</p><p><em><strong>Note:</strong></em> Alerts are defined in a PrometheusRules custom resource in the &lsquo;monitoring&rsquo; namespace. You can modify the alert rules by updating this resource.</p><h2 id=dashboards>Dashboards<a class=td-heading-self-link href=#dashboards aria-label="Heading self-link"></a></h2><p>To view the dashboards in Grafana, wait for the deployment to be ready, then use the port-forward command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n monitoring <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m deployment/grafana --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span><span style=display:flex><span>kubectl -n monitoring port-forward service/grafana 3000:3000 &gt; /dev/null <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Navigate to <code>http://localhost:3000</code> and sign in with admin/admin.
The Gateway API State dashboards will be available in the &lsquo;Default&rsquo; folder and tagged with &lsquo;gateway-api&rsquo;.
See the <a href=https://github.com/Kuadrant/gateway-api-state-metrics/tree/main#dashboards>Gateway API State Metrics README</a> for further information on available dashboards.</p><p><em><strong>Note:</strong></em> Dashboards are loaded from configmaps. You can modify the dashboards in the Grafana UI, however you will need to export them from the UI and update the json in the configmaps to persist changes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed9c87dc64e932cbe6528df1f570c86f>2.5.2 - Gateway Exported Metrics</h1><p>The Envoy Gateway provides a collection of self-monitoring metrics in <a href=https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format>Prometheus format</a>.</p><p>These metrics allow monitoring of the behavior of Envoy Gateway itself (as distinct from that of the EnvoyProxy it managed).</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>EnvoyProxy Metrics</h4>For EnvoyProxy Metrics, please refer to the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/observability/proxy-metric/>EnvoyProxy Metrics</a> to learn more.</div><h2 id=watching-components>Watching Components<a class=td-heading-self-link href=#watching-components aria-label="Heading self-link"></a></h2><p>The Resource Provider, xDS Translator and Infra Manager etc. are key components that made up of Envoy Gateway,
they all follow the design of <a href=/eg-pr-preview/5-test-docs-preview/contributions/design/watching/>Watching Components</a>.</p><p>Envoy Gateway collects the following metrics in Watching Components:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>watchable_depth</code></td><td>Current depth of watchable map.</td></tr><tr><td><code>watchable_subscribe_duration_seconds</code></td><td>How long in seconds a subscribed watchable queue is handled.</td></tr><tr><td><code>watchable_subscribe_total</code></td><td>Total number of subscribed watchable queue.</td></tr></tbody></table><p>Each metric includes the <code>runner</code> label to identify the corresponding components,
the relationship between label values and components is as follows:</p><table><thead><tr><th>Value</th><th>Components</th></tr></thead><tbody><tr><td><code>gateway-api</code></td><td>Gateway API Translator</td></tr><tr><td><code>infrastructure</code></td><td>Infrastructure Manager</td></tr><tr><td><code>xds-server</code></td><td>xDS Server</td></tr><tr><td><code>xds-translator</code></td><td>xDS Translator</td></tr><tr><td><code>global-ratelimit</code></td><td>Global RateLimit xDS Translator</td></tr></tbody></table><p>Metrics may include one or more additional labels, such as <code>message</code>, <code>status</code> and <code>reason</code> etc.</p><h2 id=status-updater>Status Updater<a class=td-heading-self-link href=#status-updater aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the status updates of various resources (like <code>GatewayClass</code>, <code>Gateway</code> and <code>HTTPRoute</code> etc.) through Status Updater.</p><p>Envoy Gateway collects the following metrics in Status Updater:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>status_update_total</code></td><td>Total number of status update by object kind.</td></tr><tr><td><code>status_update_duration_seconds</code></td><td>How long a status update takes to finish.</td></tr></tbody></table><p>Each metric includes <code>kind</code> label to identify the corresponding resources.</p><h2 id=xds-server>xDS Server<a class=td-heading-self-link href=#xds-server aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the cache and xDS connection status in xDS Server.</p><p>Envoy Gateway collects the following metrics in xDS Server:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>xds_snapshot_create_total</code></td><td>Total number of xds snapshot cache creates.</td></tr><tr><td><code>xds_snapshot_update_total</code></td><td>Total number of xds snapshot cache updates by node id.</td></tr><tr><td><code>xds_stream_duration_seconds</code></td><td>How long a xds stream takes to finish.</td></tr></tbody></table><ul><li>For xDS snapshot cache update and xDS stream connection status, each metric includes <code>nodeID</code> label to identify the connection peer.</li><li>For xDS stream connection status, each metric also includes <code>streamID</code> label to identify the connection stream, and <code>isDeltaStream</code> label to identify the delta connection stream.</li></ul><h2 id=infrastructure-manager>Infrastructure Manager<a class=td-heading-self-link href=#infrastructure-manager aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the <code>apply</code> (<code>create</code> or <code>update</code>) and <code>delete</code> operations in Infrastructure Manager.</p><p>Envoy Gateway collects the following metrics in Infrastructure Manager:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>resource_apply_total</code></td><td>Total number of applied resources.</td></tr><tr><td><code>resource_apply_duration_seconds</code></td><td>How long in seconds a resource be applied successfully.</td></tr><tr><td><code>resource_delete_total</code></td><td>Total number of deleted resources.</td></tr><tr><td><code>resource_delete_duration_seconds</code></td><td>How long in seconds a resource be deleted successfully.</td></tr></tbody></table><p>Each metric includes the <code>kind</code> label to identify the corresponding resources being applied or deleted by Infrastructure Manager.</p><p>Metrics may also include <code>name</code> and <code>namespace</code> label to identify the name and namespace of corresponding Infrastructure Manager.</p><h2 id=wasm>Wasm<a class=td-heading-self-link href=#wasm aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the status of Wasm remote fetch cache.</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>wasm_cache_entries</code></td><td>Number of Wasm remote fetch cache entries.</td></tr><tr><td><code>wasm_cache_lookup_total</code></td><td>Total number of Wasm remote fetch cache lookups.</td></tr><tr><td><code>wasm_remote_fetch_total</code></td><td>Total number of Wasm remote fetches and results.</td></tr></tbody></table><p>For metric <code>wasm_cache_lookup_total</code>, we are using <code>hit</code> label (boolean) to indicate whether the Wasm cache has been hit.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-113076d86d4a3ab51ad9552dd9a07d8b>2.5.3 - Gateway Observability</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config gateway control-plane observability, includes metrics.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.4 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>The default installation of Envoy Gateway installs a default <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In this section, we will update this resource to enable various ways to retrieve metrics
from Envoy Gateway.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Exported Metrics</h4>Refer to the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/observability/gateway-exported-metrics/>Gateway Exported Metrics List</a> to learn more about Envoy Gateway&rsquo;s Metrics.</div><h3 id=retrieve-prometheus-metrics-from-envoy-gateway>Retrieve Prometheus Metrics from Envoy Gateway<a class=td-heading-self-link href=#retrieve-prometheus-metrics-from-envoy-gateway aria-label="Heading self-link"></a></h3><p>By default, prometheus metric is enabled. You can directly retrieve metrics from Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>control-plane<span style=color:#ce5c00;font-weight:700>=</span>envoy-gateway,app.kubernetes.io/instance<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$ENVOY_POD_NAME</span> -n envoy-gateway-system 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics
</span></span></code></pre></div><p>The following is an example to disable prometheus metric for Envoy Gateway.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        prometheus:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          disable: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        prometheus:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          disable: true</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><h3 id=enable-open-telemetry-sink-in-envoy-gateway>Enable Open Telemetry sink in Envoy Gateway<a class=td-heading-self-link href=#enable-open-telemetry-sink-in-envoy-gateway aria-label="Heading self-link"></a></h3><p>The following is an example to send metric via Open Telemetry sink to OTEL gRPC Collector.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              protocol: grpc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        sinks:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              port: 4317
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              protocol: grpc</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><p>Verify OTel-Collector metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>OTEL_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n monitoring --selector<span style=color:#ce5c00;font-weight:700>=</span>app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>opentelemetry-collector -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$OTEL_POD_NAME</span> -n monitoring 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-db30e764627b7b51199826dfd3da7e39>2.5.4 - Proxy Access Logs</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config proxy access logs.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.4 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>By default, the Service type of <code>loki</code> is ClusterIP, you can change it to LoadBalancer type for further usage:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch service loki -n monitoring -p <span style=color:#4e9a06>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;LoadBalancer&#34;}}&#39;</span>
</span></span></code></pre></div><p>Expose endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>LOKI_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc loki -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=default-access-log>Default Access Log<a class=td-heading-self-link href=#default-access-log aria-label="Heading self-link"></a></h2><p>If custom format string is not specified, Envoy Gateway uses the following default format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;start_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%START_TIME%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(:METHOD)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-envoy-origin-path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;protocol&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%PROTOCOL%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;response_code&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESPONSE_CODE%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;response_flags&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESPONSE_FLAGS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;response_code_details&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESPONSE_CODE_DETAILS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;connection_termination_details&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%CONNECTION_TERMINATION_DETAILS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_transport_failure_reason&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_TRANSPORT_FAILURE_REASON%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;bytes_received&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%BYTES_RECEIVED%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;bytes_sent&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%BYTES_SENT%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;duration&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%DURATION%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-envoy-upstream-service-time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-forwarded-for&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(X-FORWARDED-FOR)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;user-agent&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(USER-AGENT)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-request-id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(X-REQUEST-ID)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;:authority&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(:AUTHORITY)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_host&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_HOST%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_cluster&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_CLUSTER%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_local_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_LOCAL_ADDRESS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;downstream_local_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%DOWNSTREAM_LOCAL_ADDRESS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;downstream_remote_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%DOWNSTREAM_REMOTE_ADDRESS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;requested_server_name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQUESTED_SERVER_NAME%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;route_name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%ROUTE_NAME%&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p>Note: Envoy Gateway disable envoy headers by default, you can enable it by setting <code>EnableEnvoyHeaders</code> to <code>true</code> in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicy>ClientTrafficPolicy</a> CRD.</p></blockquote><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={job=\&#34;fluentbit\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=disable-access-log>Disable Access Log<a class=td-heading-self-link href=#disable-access-log aria-label="Heading self-link"></a></h2><p>If you want to disable it, set the <code>telemetry.accesslog.disable</code> to <code>true</code> in the <code>EnvoyProxy</code> CRD.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: disable-accesslog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: disable-accesslog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      disable: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=opentelemetry-sink>OpenTelemetry Sink<a class=td-heading-self-link href=#opentelemetry-sink aria-label="Heading self-link"></a></h2><p>Envoy Gateway can send logs to OpenTelemetry Sink.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - format:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Text
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            text: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  k8s.cluster.name: &#34;cluster-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={exporter=\&#34;OTLP\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=ggrpc-access-log-serviceals-sink>gGRPC Access Log Service(ALS) Sink<a class=td-heading-self-link href=#ggrpc-access-log-serviceals-sink aria-label="Heading self-link"></a></h2><p>Envoy Gateway can send logs to a backend implemented <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/accesslog/v3/als.proto>gRPC access log service proto</a>.
There&rsquo;s an example service <a href=https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/envoy-als.yaml>here</a>, which simply count the log and export to prometheus endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/envoy-als.yaml -n monitoring
</span></span></code></pre></div><p>The following configuration sends logs to the gRPC access log service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: als
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: als
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: ALS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              als:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - name: envoy-als
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                type: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify logs from envoy-als:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc envoy-als -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>:19001/metrics&#34;</span> <span style=color:#000;font-weight:700>|</span> grep log_count
</span></span></code></pre></div><h2 id=cel-expressions>CEL Expressions<a class=td-heading-self-link href=#cel-expressions aria-label="Heading self-link"></a></h2><p>Envoy Gateway provides <a href=https://www.envoyproxy.io/docs/envoy/latest/xds/type/v3/cel.proto.html#common-expression-language-cel-proto>CEL expressions</a> to filter access log .</p><p>For example, you can use the expression <code>'x-envoy-logged' in request.headers</code> to filter logs that contain the <code>x-envoy-logged</code> header.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - format:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Text
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            text: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - &#34;&#39;x-envoy-logged&#39; in request.headers&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  k8s.cluster.name: &#34;cluster-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={exporter=\&#34;OTLP\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=additional-metadata>Additional Metadata<a class=td-heading-self-link href=#additional-metadata aria-label="Heading self-link"></a></h2><p>Envoy Gateway provides additional metadata about the K8s resources that were translated to certain envoy resources.
For example, details about the <code>HTTPRoute</code> and <code>GRPCRoute</code> (kind, group, name, namespace and annotations) are available
for access log formatter using the <code>METADATA</code> operator. To enrich logs, users can add log operator such as:
<code>%METADATA(ROUTE:envoy-gateway:resources)%</code> to their access log format.</p><h2 id=access-log-types>Access Log Types<a class=td-heading-self-link href=#access-log-types aria-label="Heading self-link"></a></h2><p>By default, Access Log settings would apply to:</p><ul><li>All Routes</li><li>If traffic is not matched by any Route known to Envoy, the Listener would emit the access log instead</li></ul><p>Users may wish to customize this behavior:</p><ul><li>Emit Access Logs by all Listeners for all traffic with specific settings</li><li>Do not emit Route-oriented access logs when a route is not matched.</li></ul><p>To achieve this, users can select if Access Log settings follow the default behavior or apply specifically to
Routes or Listeners by specifying the setting&rsquo;s type.</p><p><strong>Note</strong>: When users define their own Access Log settings (with or without a type), the default Envoy Gateway
file access log is no longer configured. It can be re-enabled explicitly by adding empty settings for the desired components.</p><p>In the following example:</p><ul><li>Route Access logs would use the default Envoy Gateway format and sink</li><li>Listener Access logs are customized to report transport-level failures and connection attributes</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: Route # re-enable default access log for route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: Listener # configure specific access log for listeners
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          format:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Text
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            text: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              [%START_TIME%] %DOWNSTREAM_REMOTE_ADDRESS% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DOWNSTREAM_TRANSPORT_FAILURE_REASON%
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  k8s.cluster.name: &#34;cluster-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9ee1b7728efc90d883186a9c14749b3a>2.5.5 - Proxy Metrics</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config proxy metrics.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.4 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>By default, Envoy Gateway expose metrics with prometheus endpoint.</p><p>Verify metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$ENVOY_POD_NAME</span> -n envoy-gateway-system 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/stats/prometheus  <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;default/backend/rule/0&#34;</span>
</span></span></code></pre></div><p>You can disable metrics by setting the <code>telemetry.metrics.prometheus.disable</code> to <code>true</code> in the <code>EnvoyProxy</code> CRD.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/metric/disable-prometheus.yaml
</span></span></code></pre></div><p>Envoy Gateway can send metrics to OpenTelemetry Sink.
Send metrics to OTel-Collector:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/metric/otel-sink.yaml
</span></span></code></pre></div><p>Verify OTel-Collector metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>OTEL_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n monitoring --selector<span style=color:#ce5c00;font-weight:700>=</span>app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>opentelemetry-collector -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$OTEL_POD_NAME</span> -n monitoring 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics  <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;default/backend/rule/0&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ae0a51978ef58d2b90521336806d11b6>2.5.6 - Proxy Tracing</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config proxy tracing.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.4 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>Expose Tempo endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TEMPO_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc tempo -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=traces>Traces<a class=td-heading-self-link href=#traces aria-label="Heading self-link"></a></h2><p>By default, Envoy Gateway doesn&rsquo;t send traces to any sink.
You can enable traces by setting the <code>telemetry.tracing</code> in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> CRD.
Currently, Envoy Gateway support OpenTelemetry, <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#zipkintracingprovider>Zipkin</a> and Datadog tracer.</p><h3 id=tracing-provider>Tracing Provider<a class=td-heading-self-link href=#tracing-provider aria-label="Heading self-link"></a></h3><p>The following configurations show how to apply proxy with different providers:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=opentelemetry aria-controls=tabs-01-00 aria-selected=true>
OpenTelemetry</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=zipkin aria-controls=tabs-01-01 aria-selected=false>
Zipkin</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=datadog aria-controls=tabs-01-02 aria-selected=false>
Datadog</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 100% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: otel-collector
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;otel&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify OpenTelemetry traces from tempo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/search?tags=component%3Dproxy+provider%3Dotel&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .traces
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: zipkin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: zipkin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 100% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: otel-collector
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9411
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Zipkin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        zipkin:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          enable128BitTraceId: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;zipkin&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify zipkin traces from tempo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/search?tags=component%3Dproxy+provider%3Dzipkin&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .traces
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: datadog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: datadog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 100% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: datadog-agent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8126
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Datadog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;datadog&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify Datadog traces in <a href=https://docs.datadoghq.com/tracing/>Datadog APM</a></p></div></div><p>Query trace by trace id:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/traces/&lt;trace_id&gt;&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</span></span></code></pre></div><h3 id=sampling-rate>Sampling Rate<a class=td-heading-self-link href=#sampling-rate aria-label="Heading self-link"></a></h3><p>Envoy Gateway use 100% sample rate, which means all requests will be traced.
This may cause performance issues when traffic is very high, you can adjust
the sample rate by setting the <code>telemetry.tracing.samplingRate</code> in the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> CRD.</p><p>The following configurations show how to apply proxy with 1% sample rates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 1% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: otel-collector
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;otel&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c6dcb48cfc3b362ce93e7442db76b5e6>2.5.7 - RateLimit Observability</h1><p>Envoy Gateway provides observability for the RateLimit instances.
This guide show you how to config RateLimit observability, includes traces.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.4 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/traffic/global-rate-limit/>Global Rate Limit</a> to install RateLimit.</p><h2 id=traces>Traces<a class=td-heading-self-link href=#traces aria-label="Heading self-link"></a></h2><p>By default, the Envoy Gateway does not configure RateLimit to send traces to the OpenTelemetry Sink.
You can configure the collector in the <code>rateLimit.telemetry.tracing</code> of the <code>EnvoyGateway</code>CRD.</p><p>RateLimit uses the OpenTelemetry Exporter to export traces to the collector.
You can configure a collector that supports the OTLP protocol, which includes but is not limited to: OpenTelemetry Collector, Jaeger, Zipkin, and so on.</p><p><em><strong>Note:</strong></em></p><ul><li>By default, the Envoy Gateway configures a <code>100%</code> sampling rate for RateLimit, which may lead to performance issues.</li></ul><p>Assuming the OpenTelemetry Collector is running in the <code>observability</code> namespace, and it has a service named <code>otel-svc</code>,
we only want to sample <code>50%</code> of the trace data. We would configure it as follows:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis-service.default.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sampleRate: 50
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            url: otel-svc.observability.svc.cluster.local:4318
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      backend:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        redis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          url: redis-service.default.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      telemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        tracing:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          sampleRate: 50
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            url: otel-svc.observability.svc.cluster.local:4318</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-29c806415369bc15142435761b777cbb>2.5.8 - Visualising metrics using Grafana</h1><p>Envoy Gateway provides support for exposing Envoy Gateway and Envoy Proxy metrics to a Prometheus instance.
This task shows you how to visualise the metrics exposed to Prometheus using Grafana.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.4 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/observability/gateway-observability/>Gateway Observability</a> and <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/observability/proxy-metric/>Proxy Metrics</a> to enable Prometheus metrics
for both Envoy Gateway (Control Plane) and Envoy Proxy (Data Plane).</p><p>Expose endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>GRAFANA_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc grafana -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=connecting-grafana-with-prometheus-datasource>Connecting Grafana with Prometheus datasource<a class=td-heading-self-link href=#connecting-grafana-with-prometheus-datasource aria-label="Heading self-link"></a></h2><p>To visualise metrics from Prometheus, we have to connect Grafana with Prometheus. If you installed Grafana follow the command
from prerequisites sections, the Prometheus datasource should be already configured.</p><p>You can also add the datasource manually by following the instructions from <a href=https://grafana.com/docs/grafana/latest/datasources/prometheus/configure-prometheus-data-source/>Grafana Docs</a>.</p><h2 id=accessing-grafana>Accessing Grafana<a class=td-heading-self-link href=#accessing-grafana aria-label="Heading self-link"></a></h2><p>You can access the Grafana instance by visiting <code>http://{GRAFANA_IP}</code>, derived in prerequisites.</p><p>To log in to Grafana, use the credentials <code>admin:admin</code>.</p><p>Envoy Gateway has examples of dashboard for you to get started, you can check them out under <code>Dashboards/envoy-gateway</code>.</p><p>If you&rsquo;d like import Grafana dashboards on your own, please refer to Grafana docs for <a href=https://grafana.com/docs/grafana/latest/dashboards/manage-dashboards/#import-a-dashboard>importing dashboards</a>.</p><h3 id=envoy-proxy-global>Envoy Proxy Global<a class=td-heading-self-link href=#envoy-proxy-global aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall downstream and upstream stats for each Envoy Proxy instance.</p><p><img alt="Envoy Proxy Global" src=/img/envoy-proxy-global-dashboard.png></p><h3 id=envoy-clusters>Envoy Clusters<a class=td-heading-self-link href=#envoy-clusters aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall stats for each cluster from Envoy Proxy fleet.</p><p><img alt="Envoy Clusters" src=/img/envoy-clusters-dashboard.png></p><h3 id=envoy-gateway-global>Envoy Gateway Global<a class=td-heading-self-link href=#envoy-gateway-global aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall stats exported by Envoy Gateway fleet.</p><p><img alt="Envoy Gateway Global: Watching Components" src=/img/envoy-gateway-global-watching-components.png></p><p><img alt="Envoy Gateway Global: Status Updater" src=/img/envoy-gateway-global-status-updater.png></p><p><img alt="Envoy Gateway Global: xDS Server" src=/img/envoy-gateway-global-xds-server.png></p><p><img alt="Envoy Gateway Global: Infrastructure Manager" src=/img/envoy-gateway-global-infra-manager.png></p><h3 id=resources-monitor>Resources Monitor<a class=td-heading-self-link href=#resources-monitor aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall resources stats for both Envoy Gateway and Envoy Proxy fleet.</p><p><img alt="Envoy Gateway Resources" src=/img/resources-monitor-dashboard.png></p><h2 id=update-dashboards>Update Dashboards<a class=td-heading-self-link href=#update-dashboards aria-label="Heading self-link"></a></h2><p>All dashboards of Envoy Gateway are maintained under <code>charts/gateway-addons-helm/dashboards</code>,
feel free to make <a href=/eg-pr-preview/5-test-docs-preview/contributions/contributing/>contributions</a>.</p><h3 id=grafonnet>Grafonnet<a class=td-heading-self-link href=#grafonnet aria-label="Heading self-link"></a></h3><p>Newer dashboards are generated with <a href=https://jsonnet.org/>Jsonnet</a> with the <a href=https://grafana.github.io/grafonnet/index.html>Grafonnet</a>.
This is the preferred method for any new dashboards.</p><p>You can run <code>make helm-generate.gateway-addons-helm</code> to generate new version of dashboards.
All the generated dashboards have a <code>.gen.json</code> suffix.</p><h3 id=legacy-dashboards>Legacy Dashboards<a class=td-heading-self-link href=#legacy-dashboards aria-label="Heading self-link"></a></h3><p>Many of our older dashboards are manually created in the UI and exported as JSON and checked in.</p><p>These example dashboards cannot be updated in-place by default, if you are trying to
make some changes to the older dashboards, you can save them directly as a JSON file
and then re-import.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-19dc792a3628d6e0951189a0c4254e6d>2.6 - Operations</h1><div class=lead>This section includes Operations tasks.</div></div><div class=td-content><h1 id=pg-b4a3f7bee70bc62081f2461463768a1d>2.6.1 - Customize EnvoyProxy</h1><p>Envoy Gateway provides an <a href=../../../api/extension_types#envoyproxy>EnvoyProxy</a> CRD that can be linked to the ParametersRef
in a Gateway and GatewayClass, allowing cluster admins to customize the managed EnvoyProxy Deployment and
Service. To learn more about GatewayClass and ParametersRef, please refer to <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>Before you start, you need to add <code>Infrastructure.ParametersRef</code> in Gateway, and refer to EnvoyProxy Config:
<strong>Note</strong>: <code>MergeGateways</code> cannot be set to <code>true</code> in your EnvoyProxy config if attaching to the Gateway.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  infrastructure:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>infrastructure</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>You can also attach the EnvoyProxy resource to the GatewayClass using the <code>parametersRef</code> field.
This configuration is discouraged if you plan on creating multiple Gateways linking to the same
GatewayClass and would like different infrastructure configurations for each of them.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=customize-envoyproxy-deployment-replicas>Customize EnvoyProxy Deployment Replicas<a class=td-heading-self-link href=#customize-envoyproxy-deployment-replicas aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Deployment Replicas via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After you apply the config, you should see the replicas of envoyproxy changes to 2.
And also you can dynamically change the value.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment -l gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -n envoy-gateway-system
</span></span></code></pre></div><h2 id=customize-envoyproxy-image>Customize EnvoyProxy Image<a class=td-heading-self-link href=#customize-envoyproxy-image aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Image via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          image: envoyproxy/envoy:v1.25-latest
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>container</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoyproxy/envoy:v1.25-latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the config, you can get the deployment image, and see it has changed.</p><h2 id=customize-envoyproxy-pod-annotations>Customize EnvoyProxy Pod Annotations<a class=td-heading-self-link href=#customize-envoyproxy-pod-annotations aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Pod Annotations via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            custom1: deploy-annotation1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            custom2: deploy-annotation2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pod</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>custom1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deploy-annotation1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>custom2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deploy-annotation2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the config, you can get the envoyproxy pods, and see new annotations has been added.</p><h2 id=customize-envoyproxy-deployment-resources>Customize EnvoyProxy Deployment Resources<a class=td-heading-self-link href=#customize-envoyproxy-deployment-resources aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Deployment Resources via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-06-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-06-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 150m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 640Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 500m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 1Gi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>container</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>150m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>640Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>500m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1Gi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=customize-envoyproxy-deployment-env>Customize EnvoyProxy Deployment Env<a class=td-heading-self-link href=#customize-envoyproxy-deployment-env aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Deployment Env via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-07-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-07-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: env_a
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: env_a_value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: env_b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: env_b_value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>container</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env_a</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env_a_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env_b</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env_b_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><blockquote><p>Envoy Gateway has provided two initial <code>env</code> <code>ENVOY_GATEWAY_NAMESPACE</code> and <code>ENVOY_POD_NAME</code> for envoyproxy container.</p></blockquote><p>After applying the config, you can get the envoyproxy deployment, and see resources has been changed.</p><h2 id=customize-envoyproxy-deployment-volumes-or-volumemounts>Customize EnvoyProxy Deployment Volumes or VolumeMounts<a class=td-heading-self-link href=#customize-envoyproxy-deployment-volumes-or-volumemounts aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Deployment Volumes or VolumeMounts via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-08-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-08-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          volumeMounts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - mountPath: /certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            readOnly: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          volumes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            secret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              secretName: envoy-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>container</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/certs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>certs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pod</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>certs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>secretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-cert</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the config, you can get the envoyproxy deployment, and see resources has been changed.</p><h2 id=customize-envoyproxy-service-annotations>Customize EnvoyProxy Service Annotations<a class=td-heading-self-link href=#customize-envoyproxy-service-annotations aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Service Annotations via EnvoyProxy Config like:</p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-09-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-09-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyService:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          custom1: svc-annotation1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          custom2: svc-annotation2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyService</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>custom1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>svc-annotation1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>custom2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>svc-annotation2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the config, you can get the envoyproxy service, and see annotations has been added.</p><h2 id=customize-envoyproxy-bootstrap-config>Customize EnvoyProxy Bootstrap Config<a class=td-heading-self-link href=#customize-envoyproxy-bootstrap-config aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy bootstrap config via EnvoyProxy Config.
There are three ways to customize it:</p><ul><li>Replace: the whole bootstrap config will be replaced by the config you provided.</li><li>Merge: the config you provided will be merged into the default bootstrap config.</li><li>JSONPatch: the list of JSON Patches you provided will be applied to the bootstrap config. JSON Patch is a standard format specified in <a href=https://datatracker.ietf.org/doc/html/rfc6902/>RFC 6902</a>.</li></ul><ul class="nav nav-tabs" id=tabs-10 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-10-00-tab data-bs-toggle=tab data-bs-target=#tabs-10-00 role=tab data-td-tp-persist="replace: apply from stdin" aria-controls=tabs-10-00 aria-selected=true>
Replace: apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-10-01-tab data-bs-toggle=tab data-bs-target=#tabs-10-01 role=tab data-td-tp-persist="replace: apply from file" aria-controls=tabs-10-01 aria-selected=false>
Replace: apply from file</button></li><li class=nav-item><button class=nav-link id=tabs-10-02-tab data-bs-toggle=tab data-bs-target=#tabs-10-02 role=tab data-td-tp-persist="jsonpatch: apply from stdin" aria-controls=tabs-10-02 aria-selected=false>
JSONPatch: apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-10-03-tab data-bs-toggle=tab data-bs-target=#tabs-10-03 role=tab data-td-tp-persist="jsonpatch: apply from file" aria-controls=tabs-10-03 aria-selected=false>
JSONPatch: apply from file</button></li></ul><div class=tab-content id=tabs-10-content><div class="tab-body tab-pane fade show active" id=tabs-10-00 role=tabpanel aria-labelled-by=tabs-10-00-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  bootstrap:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      admin:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        access_log:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: envoy.access_loggers.file
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          typed_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            path: /dev/null
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          socket_address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            address: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            port_value: 20000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      dynamic_resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        ads_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          api_type: DELTA_GRPC
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          transport_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          grpc_services:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - envoy_grpc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          set_node_on_first_message_only: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        lds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        cds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      static_resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        clusters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - connect_timeout: 10s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          load_assignment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - lb_endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              - endpoint:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    socket_address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      address: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      port_value: 18000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          typed_extension_protocol_options:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>               &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>               &#34;explicit_http_config&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                 &#34;http2_protocol_options&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: STRICT_DNS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          transport_socket:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: envoy.transport_sockets.tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            typed_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              common_tls_context:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                tls_params:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  tls_maximum_protocol_version: TLSv1_3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                tls_certificate_sds_secret_configs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                - name: xds_certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      path: &#34;/sds/xds-certificate.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                validation_context_sds_secret_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  name: xds_trusted_ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      path: &#34;/sds/xds-trusted-ca.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      layered_runtime:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        layers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          rtds_layer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            rtds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              ads: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-01 role=tabpanel aria-labelled-by=tabs-10-01-tab tabindex=10><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>bootstrap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Replace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      admin:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        access_log:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - name: envoy.access_loggers.file
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          typed_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            path: /dev/null
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          socket_address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            address: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            port_value: 20000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      dynamic_resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ads_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          api_type: DELTA_GRPC
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          transport_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          grpc_services:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          - envoy_grpc:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          set_node_on_first_message_only: true
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        lds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        cds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      static_resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        clusters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - connect_timeout: 10s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          load_assignment:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            endpoints:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            - lb_endpoints:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              - endpoint:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    socket_address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      address: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      port_value: 18000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          typed_extension_protocol_options:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>               &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>               &#34;explicit_http_config&#34;:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                 &#34;http2_protocol_options&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          type: STRICT_DNS
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          transport_socket:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            name: envoy.transport_sockets.tls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            typed_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              common_tls_context:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                tls_params:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  tls_maximum_protocol_version: TLSv1_3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                tls_certificate_sds_secret_configs:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                - name: xds_certificate
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      path: &#34;/sds/xds-certificate.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                validation_context_sds_secret_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  name: xds_trusted_ca
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      path: &#34;/sds/xds-trusted-ca.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      layered_runtime:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        layers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          rtds_layer:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            rtds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            name: runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>      
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-02 role=tabpanel aria-labelled-by=tabs-10-02-tab tabindex=10><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  bootstrap:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - {&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/static_resources/clusters/0/dns_lookup_family&#34;, &#34;value&#34;: &#34;V4_ONLY&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - {&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/admin/address/socket_address/port_value&#34;, &#34;value&#34;: 9901}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-03 role=tabpanel aria-labelled-by=tabs-10-03-tab tabindex=10><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>bootstrap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSONPatch</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>jsonPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- {<span style=color:#204a87;font-weight:700>&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/static_resources/clusters/0/dns_lookup_family&#34;, &#34;value&#34;: </span><span style=color:#4e9a06>&#34;V4_ONLY&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- {<span style=color:#204a87;font-weight:700>&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/admin/address/socket_address/port_value&#34;, &#34;value&#34;: </span><span style=color:#0000cf;font-weight:700>9901</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>You can use <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/egctl/#egctl-experimental-translate>egctl x translate</a>
to get the default xDS Bootstrap configuration used by Envoy Gateway.</p><p>After applying the config, the bootstrap config will be overridden by the new config you provided.
Any errors in the configuration will be surfaced as status within the <code>GatewayClass</code> resource.
You can also validate this configuration using <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/egctl/#egctl-experimental-translate>egctl x translate</a>.</p><h2 id=customize-envoyproxy-horizontal-pod-autoscaler>Customize EnvoyProxy Horizontal Pod Autoscaler<a class=td-heading-self-link href=#customize-envoyproxy-horizontal-pod-autoscaler aria-label="Heading self-link"></a></h2><p>You can enable <a href=https://github.com/envoyproxy/gateway/issues/703>Horizontal Pod Autoscaler</a> for EnvoyProxy Deployment. However, before enabling the HPA for EnvoyProxy, please ensure that the <a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a> component is installed in the cluster.</p><p>Once confirmed, you can apply it via EnvoyProxy Config as shown below:</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-11-00-tab data-bs-toggle=tab data-bs-target=#tabs-11-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-11-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-11-01-tab data-bs-toggle=tab data-bs-target=#tabs-11-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-11-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-11-content><div class="tab-body tab-pane fade show active" id=tabs-11-00 role=tabpanel aria-labelled-by=tabs-11-00-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyHpa:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        minReplicas: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        maxReplicas: 10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        metrics:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - resource:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              name: cpu
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              target:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                averageUtilization: 60
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                type: Utilization
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Resource
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-01 role=tabpanel aria-labelled-by=tabs-11-01-tab tabindex=11><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyHpa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>minReplicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>maxReplicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cpu</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>averageUtilization</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Utilization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the config, the EnvoyProxy HPA (Horizontal Pod Autoscaler) is generated. However, upon activating the EnvoyProxy&rsquo;s HPA, the Envoy Gateway will no longer reference the <code>replicas</code> field specified in the <code>envoyDeployment</code>, as outlined <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/customize-envoyproxy/#customize-envoyproxy-deployment-replicas>here</a>.</p><h2 id=customize-envoyproxy-command-line-options>Customize EnvoyProxy Command line options<a class=td-heading-self-link href=#customize-envoyproxy-command-line-options aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy Command line options via <code>spec.extraArgs</code> in EnvoyProxy Config.
For example, the following configuration will add <code>--disable-extensions</code> arg in order to disable <code>envoy.access_loggers/envoy.access_loggers.wasm</code> extension:</p><ul class="nav nav-tabs" id=tabs-12 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-12-00-tab data-bs-toggle=tab data-bs-target=#tabs-12-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-12-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-12-01-tab data-bs-toggle=tab data-bs-target=#tabs-12-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-12-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-12-content><div class="tab-body tab-pane fade show active" id=tabs-12-00 role=tabpanel aria-labelled-by=tabs-12-00-tab tabindex=12><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  extraArgs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - --disable-extensions envoy.access_loggers/envoy.access_loggers.wasm 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-12-01 role=tabpanel aria-labelled-by=tabs-12-01-tab tabindex=12><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extraArgs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- --<span style=color:#000>disable-extensions envoy.access_loggers/envoy.access_loggers.wasm </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=customize-envoyproxy-with-patches>Customize EnvoyProxy with Patches<a class=td-heading-self-link href=#customize-envoyproxy-with-patches aria-label="Heading self-link"></a></h2><p>You can customize the EnvoyProxy using patches.</p><h3 id=patching-deployment-for-envoyproxy>Patching Deployment for EnvoyProxy<a class=td-heading-self-link href=#patching-deployment-for-envoyproxy aria-label="Heading self-link"></a></h3><p>For example, the following configuration will add resource limits to the <code>envoy</code> and the <code>shutdown-manager</code> containers in the <code>envoyproxy</code> deployment:</p><ul class="nav nav-tabs" id=tabs-13 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-13-00-tab data-bs-toggle=tab data-bs-target=#tabs-13-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-13-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-13-01-tab data-bs-toggle=tab data-bs-target=#tabs-13-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-13-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-13-content><div class="tab-body tab-pane fade show active" id=tabs-13-00 role=tabpanel aria-labelled-by=tabs-13-00-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        patch:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: StrategicMerge
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - name: envoy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                        cpu: 500m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                        memory: 1024Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - name: shutdown-manager
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                        cpu: 200m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                        memory: 1024Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-01 role=tabpanel aria-labelled-by=tabs-13-01-tab tabindex=13><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyDeployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>patch</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StrategicMerge</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>500m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1024Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>shutdown-manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>200m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1024Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the configuration, you will see the change in both containers in the <code>envoyproxy</code> deployment.</p><h3 id=patching-service-for-envoyproxy>Patching Service for EnvoyProxy<a class=td-heading-self-link href=#patching-service-for-envoyproxy aria-label="Heading self-link"></a></h3><p>For example, the following configuration will add an annotation for the <code>envoyproxy</code> service:</p><ul class="nav nav-tabs" id=tabs-14 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-14-00-tab data-bs-toggle=tab data-bs-target=#tabs-14-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-14-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-14-01-tab data-bs-toggle=tab data-bs-target=#tabs-14-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-14-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-14-content><div class="tab-body tab-pane fade show active" id=tabs-14-00 role=tabpanel aria-labelled-by=tabs-14-00-tab tabindex=14><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyService:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        patch:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: StrategicMerge
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                custom-annotation: foobar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-14-01 role=tabpanel aria-labelled-by=tabs-14-01-tab tabindex=14><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>envoyService</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>patch</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StrategicMerge</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>custom-annotation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foobar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the configuration, you will see the <code>custom-annotation: foobar</code> has been added to the <code>envoyproxy</code> service.</p><h2 id=customize-filter-order>Customize Filter Order<a class=td-heading-self-link href=#customize-filter-order aria-label="Heading self-link"></a></h2><p>Under the hood, Envoy Gateway uses a series of <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/http_filters>Envoy HTTP filters</a>
to process HTTP requests and responses, and to apply various policies.</p><p>By default, Envoy Gateway applies the following filters in the order shown:</p><ul><li>envoy.filters.http.fault</li><li>envoy.filters.http.cors</li><li>envoy.filters.http.ext_authz</li><li>envoy.filters.http.basic_authn</li><li>envoy.filters.http.oauth2</li><li>envoy.filters.http.jwt_authn</li><li>envoy.filters.http.ext_proc</li><li>envoy.filters.http.wasm</li><li>envoy.filters.http.rbac</li><li>envoy.filters.http.local_ratelimit</li><li>envoy.filters.http.ratelimit</li><li>envoy.filters.http.router</li></ul><p>The default order in which these filters are applied is opinionated and may not suit all use cases.
To address this, Envoy Gateway allows you to adjust the execution order of these filters with the <code>filterOrder</code> field in the <a href=../../../api/extension_types#envoyproxy>EnvoyProxy</a> resource.</p><p><code>filterOrder</code> is a list of customized filter order configurations. Each configuration can specify a filter
name and a filter to place it before or after. These configurations are applied in the order they are listed.
If a filter occurs in multiple configurations, the final order is the result of applying all these configurations in order.
To avoid conflicts, it is recommended to only specify one configuration per filter.</p><p>For example, the following configuration moves the <code>envoy.filters.http.wasm</code> filter before the <code>envoy.filters.http.jwt_authn</code>
filter and the <code>envoy.filters.http.cors</code> filter after the <code>envoy.filters.http.basic_authn</code> filter:</p><ul class="nav nav-tabs" id=tabs-15 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-15-00-tab data-bs-toggle=tab data-bs-target=#tabs-15-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-15-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-15-01-tab data-bs-toggle=tab data-bs-target=#tabs-15-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-15-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-15-content><div class="tab-body tab-pane fade show active" id=tabs-15-00 role=tabpanel aria-labelled-by=tabs-15-00-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  filterOrder:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: envoy.filters.http.wasm
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      before: envoy.filters.http.jwt_authn
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: envoy.filters.http.cors
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      after: envoy.filters.http.basic_authn
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-01 role=tabpanel aria-labelled-by=tabs-15-01-tab tabindex=15><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>filterOrder</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.wasm</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>before</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.jwt_authn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.cors</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.basic_authn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><h2 id=customize-envoyproxy-ip-family>Customize EnvoyProxy IP Family<a class=td-heading-self-link href=#customize-envoyproxy-ip-family aria-label="Heading self-link"></a></h2><p>You can customize the IP family configuration for EnvoyProxy via the EnvoyProxy Config.
This allows the Envoy Proxy fleet to serve external clients over IPv4 as well as IPv6.</p><p>The below configuration sets the <code>ipFamily</code> to <code>DualStack</code> to allow ingressing IPv4 as well as IPv6 traffic.</p><p><strong>Note</strong>: Envoy Gateway relies on the <a href=https://kubernetes.io/docs/concepts/services-networking/dual-stack/#services>Service</a> spec of the BackendRef resource (linked to xRoutes) to decide which type of IP addresses to use to route to them.</p><ul class="nav nav-tabs" id=tabs-16 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-16-00-tab data-bs-toggle=tab data-bs-target=#tabs-16-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-16-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-16-01-tab data-bs-toggle=tab data-bs-target=#tabs-16-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-16-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-16-content><div class="tab-body tab-pane fade show active" id=tabs-16-00 role=tabpanel aria-labelled-by=tabs-16-00-tab tabindex=16><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ipFamily: DualStack
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-16-01 role=tabpanel aria-labelled-by=tabs-16-01-tab tabindex=16><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ipFamily: DualStack  # Supports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IPv4, IPv6, or DualStack</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>After applying the config, the EnvoyProxy deployment will be configured to use the specified IP family. When set to <code>DualStack</code>, both IPv4 and IPv6 networking will be enabled.</p><p><strong>Note</strong>: Your cluster must support the selected IP family configuration. For DualStack support, ensure your Kubernetes cluster is properly configured for dual-stack networking.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9d98915f1fd3b77c7409205e64e6124e>2.6.2 - Deployment Mode</h1><h2 id=deployment-modes>Deployment modes<a class=td-heading-self-link href=#deployment-modes aria-label="Heading self-link"></a></h2><h3 id=one-gatewayclass-per-envoy-gateway-controller>One GatewayClass per Envoy Gateway Controller<a class=td-heading-self-link href=#one-gatewayclass-per-envoy-gateway-controller aria-label="Heading self-link"></a></h3><ul><li>An Envoy Gateway is associated with a single <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a> resource under one controller.
This is the simplest deployment mode and is suitable for scenarios where each Gateway needs to have its own dedicated set of resources and configurations.</li></ul><h3 id=multiple-gatewayclasses-per-envoy-gateway-controller>Multiple GatewayClasses per Envoy Gateway Controller<a class=td-heading-self-link href=#multiple-gatewayclasses-per-envoy-gateway-controller aria-label="Heading self-link"></a></h3><ul><li>An Envoy Gateway is associated with multiple <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a> resources under one controller.</li><li>Support for accepting multiple GatewayClasses was added <a href=https://github.com/envoyproxy/gateway/issues/1231>here</a>.</li></ul><h3 id=separate-envoy-gateway-controllers>Separate Envoy Gateway Controllers<a class=td-heading-self-link href=#separate-envoy-gateway-controllers aria-label="Heading self-link"></a></h3><p>If you&rsquo;ve instantiated multiple GatewayClasses, you can also run separate Envoy Gateway controllers in different namespaces, linking a GatewayClass to each of them for multi-tenancy.
Please follow the example <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/deployment-mode/#multi-tenancy>Multi-tenancy</a>.</p><h3 id=merged-gateways-onto-a-single-envoyproxy-fleet>Merged Gateways onto a single EnvoyProxy fleet<a class=td-heading-self-link href=#merged-gateways-onto-a-single-envoyproxy-fleet aria-label="Heading self-link"></a></h3><p>By default, each Gateway has its own dedicated set of Envoy Proxy and its configurations.
However, for some deployments, it may be more convenient to merge listeners across multiple Gateways and deploy a single Envoy Proxy fleet.</p><p>This can help to efficiently utilize the infra resources in the cluster and manage them in a centralized manner, or have a single IP address for all of the listeners.
Setting the <code>mergeGateways</code> field in the EnvoyProxy resource linked to GatewayClass will result in merging all Gateway listeners under one GatewayClass resource.</p><ul><li>The tuple of port, protocol, and hostname must be unique across all Listeners.</li></ul><p>Please follow the example <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/deployment-mode/#merged-gateways-deployment>Merged gateways deployment</a>.</p><h3 id=supported-modes>Supported Modes<a class=td-heading-self-link href=#supported-modes aria-label="Heading self-link"></a></h3><h4 id=kubernetes>Kubernetes<a class=td-heading-self-link href=#kubernetes aria-label="Heading self-link"></a></h4><ul><li>The default deployment model is - Envoy Gateway <strong>watches</strong> for resources such a <code>Service</code> & <code>HTTPRoute</code> in <strong>all</strong> namespaces
and <strong>creates</strong> managed data plane resources such as EnvoyProxy <code>Deployment</code> in the <strong>namespace where Envoy Gateway is running</strong>.</li><li>Envoy Gateway also supports <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kuberneteswatchmode>Namespaced deployment mode</a>, you can watch resources in the specific namespaces by assigning
<code>EnvoyGateway.provider.kubernetes.watch.namespaces</code> or <code>EnvoyGateway.provider.kubernetes.watch.namespaceSelector</code> and <strong>creates</strong> managed data plane resources in the <strong>namespace where Envoy Gateway is running</strong>.</li><li>Support for alternate deployment modes is being tracked <a href=https://github.com/envoyproxy/gateway/issues/1117>here</a>.</li></ul><h3 id=multi-tenancy>Multi-tenancy<a class=td-heading-self-link href=#multi-tenancy aria-label="Heading self-link"></a></h3><h4 id=kubernetes-1>Kubernetes<a class=td-heading-self-link href=#kubernetes-1 aria-label="Heading self-link"></a></h4><ul><li><p>A <code>tenant</code> is a group within an organization (e.g. a team or department) who shares organizational resources. We recommend
each <code>tenant</code> deploy their own Envoy Gateway controller in their respective <code>namespace</code>. Below is an example of deploying Envoy Gateway
by the <code>marketing</code> and <code>product</code> teams in separate namespaces.</p></li><li><p>Lets deploy Envoy Gateway in the <code>marketing</code> namespace and also watch resources only in this namespace. We are also setting the controller name to a unique string here <code>gateway.envoyproxy.io/marketing-gatewayclass-controller</code>.</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set config.envoyGateway.gateway.controllerName<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/marketing-gatewayclass-controller <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set config.envoyGateway.provider.kubernetes.watch.type<span style=color:#ce5c00;font-weight:700>=</span>Namespaces <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set config.envoyGateway.provider.kubernetes.watch.namespaces<span style=color:#ce5c00;font-weight:700>={</span>marketing<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>eg-marketing oci://docker.io/envoyproxy/gateway-helm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--version v1.2.4 -n marketing --create-namespace
</span></span></code></pre></div><p>Lets create a <code>GatewayClass</code> linked to the marketing team&rsquo;s Envoy Gateway controller, and as well other resources linked to it, so the <code>backend</code> application operated by this team can be exposed to external clients.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/marketing-gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg-marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.marketing.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/marketing-gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>marketing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.marketing.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Lets port forward to the generated envoy proxy service in the <code>marketing</code> namespace and send a request to it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n marketing --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>marketing,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl -n marketing port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:8080 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.marketing.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:8888...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to localhost (127.0.0.1) port 8888 (#0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.marketing.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.86.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8888</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Mark bundle as not supporting multiuse
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Thu, 20 Apr 2023 19:19:42 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 521
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/get&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;www.marketing.example.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.86.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Internal&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;true&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-For&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;10.1.0.157&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;c637977c-458a-48ae-92b3-f8c429849322&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;marketing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-74888f465f-bcs8f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host localhost left intact
</span></span></span></code></pre></div><ul><li>Lets deploy Envoy Gateway in the <code>product</code> namespace and also watch resources only in this namespace.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set config.envoyGateway.gateway.controllerName<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/product-gatewayclass-controller <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set config.envoyGateway.provider.kubernetes.watch.type<span style=color:#ce5c00;font-weight:700>=</span>Namespaces <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--set config.envoyGateway.provider.kubernetes.watch.namespaces<span style=color:#ce5c00;font-weight:700>={</span>product<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>eg-product oci://docker.io/envoyproxy/gateway-helm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--version v1.2.4 -n product --create-namespace
</span></span></code></pre></div><p>Lets create a <code>GatewayClass</code> linked to the product team&rsquo;s Envoy Gateway controller, and as well other resources linked to it, so the <code>backend</code> application operated by this team can be exposed to external clients.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/product-gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg-product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.product.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/product-gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>POD_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NAMESPACE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>fieldRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>fieldPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metadata.namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>product</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.product.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Lets port forward to the generated envoy proxy service in the <code>product</code> namespace and send a request to it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n product --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>product,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl -n product port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8889:8080 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.product.example.com&#34;</span> http://localhost:8889/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 127.0.0.1:8889...
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#ce5c00;font-weight:700>(</span>127.0.0.1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>8889</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.product.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.86.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8889</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Thu, <span style=color:#0000cf;font-weight:700>20</span> Apr <span style=color:#0000cf;font-weight:700>2023</span> 19:20:17 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>517</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.product.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.86.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;10.1.0.156&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;39196453-2250-4331-b756-54003b2853c2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;product&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-74888f465f-64fjs&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host localhost left intact</span>
</span></span></code></pre></div><p>With the below command you can ensure that you are no able to access the marketing team&rsquo;s backend exposed using the <code>www.marketing.example.com</code> hostname
and the product team&rsquo;s data plane.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.marketing.example.com&#34;</span> http://localhost:8889/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:8889...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to localhost (127.0.0.1) port 8889 (#0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.marketing.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.86.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8889</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Mark bundle as not supporting multiuse
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 404 Not Found
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Thu, 20 Apr 2023 19:22:13 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host localhost left intact
</span></span></span></code></pre></div><h3 id=merged-gateways-deployment>Merged gateways deployment<a class=td-heading-self-link href=#merged-gateways-deployment aria-label="Heading self-link"></a></h3><p>In this example, we will deploy GatewayClass</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: gateway.networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: GatewayClass
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: merged-eg
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span><span style=display:flex><span>  parametersRef:
</span></span><span style=display:flex><span>    group: gateway.envoyproxy.io
</span></span><span style=display:flex><span>    kind: EnvoyProxy
</span></span><span style=display:flex><span>    name: custom-proxy-config
</span></span><span style=display:flex><span>    namespace: envoy-gateway-system
</span></span></code></pre></div><p>with a referenced <a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> resource configured to enable merged Gateways deployment mode.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span>kind: EnvoyProxy
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: custom-proxy-config
</span></span><span style=display:flex><span>  namespace: envoy-gateway-system
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  mergeGateways: <span style=color:#204a87>true</span>
</span></span></code></pre></div><h4 id=deploy-merged-gateways-example>Deploy merged-gateways example<a class=td-heading-self-link href=#deploy-merged-gateways-example aria-label="Heading self-link"></a></h4><p>Deploy resources on your cluster from the example.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/merged-gateways.yaml
</span></span></code></pre></div><p>Verify that Gateways are deployed and programmed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways -n default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAMESPACE   NAME          CLASS       ADDRESS          PROGRAMMED   AGE
</span></span><span style=display:flex><span>default     merged-eg-1   merged-eg   172.18.255.202   True         2m4s
</span></span><span style=display:flex><span>default     merged-eg-2   merged-eg   172.18.255.202   True         2m4s
</span></span><span style=display:flex><span>default     merged-eg-3   merged-eg   172.18.255.202   True         2m4s
</span></span></code></pre></div><p>Verify that HTTPRoutes are deployed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute -n default
</span></span><span style=display:flex><span>NAMESPACE   NAME              HOSTNAMES             AGE
</span></span><span style=display:flex><span>default     hostname1-route   <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.merged1.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   2m4s
</span></span><span style=display:flex><span>default     hostname2-route   <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.merged2.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   2m4s
</span></span><span style=display:flex><span>default     hostname3-route   <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.merged3.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   2m4s
</span></span></code></pre></div><p>If you take a look at the deployed Envoy Proxy service you would notice that all of the Gateway listeners ports are added to that service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service -n envoy-gateway-system
</span></span><span style=display:flex><span>NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>                                        AGE
</span></span><span style=display:flex><span>envoy-gateway                   ClusterIP      10.96.141.4     &lt;none&gt;           18000/TCP,18001/TCP                            6m43s
</span></span><span style=display:flex><span>envoy-gateway-metrics-service   ClusterIP      10.96.113.191   &lt;none&gt;           19001/TCP                                      6m43s
</span></span><span style=display:flex><span>envoy-merged-eg-668ac7ae        LoadBalancer   10.96.48.255    172.18.255.202   8081:30467/TCP,8082:31793/TCP,8080:31153/TCP   3m17s
</span></span></code></pre></div><p>There should be also one deployment (envoy-merged-eg-668ac7ae-775f9865d-55zhs) for every Gateway and its name should reference the name of the GatewayClass.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -n envoy-gateway-system
</span></span><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS       AGE
</span></span><span style=display:flex><span>envoy-gateway-5d998778f6-wr6m9             1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>              6m43s
</span></span><span style=display:flex><span>envoy-merged-eg-668ac7ae-775f9865d-55zhs   2/2     Running   <span style=color:#0000cf;font-weight:700>0</span>              3m17s
</span></span></code></pre></div><h4 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h4><p>Get the name of the merged gateways Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gatewayclass<span style=color:#ce5c00;font-weight:700>=</span>merged-eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Fetch external IP of the service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> -n envoy-gateway-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>In certain environments, the load balancer may be exposed using a hostname, instead of an IP address. If so, replace
<code>ip</code> in the above command with <code>hostname</code>.</p><p>Curl the route hostname-route2 through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: www.merged2.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>:8081/example2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/example2&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.merged2.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.4.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;deed2767-a483-4291-9429-0e256ab3a65f&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;merged-backend-64ddb65fd7-ttv5z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Curl the route hostname-route1 through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: www.merged1.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>:8080/example
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/example&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.merged1.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.4.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;20a53440-6327-4c3c-bc8b-8e79e7311043&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;merged-backend-64ddb65fd7-ttv5z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=verify-deployment-of-multiple-gatewayclass>Verify deployment of multiple GatewayClass<a class=td-heading-self-link href=#verify-deployment-of-multiple-gatewayclass aria-label="Heading self-link"></a></h4><p>Install the GatewayClass, Gateway, HTTPRoute and example app from <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/quickstart/>Quickstart</a> example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/v1.2.4/quickstart.yaml -n default
</span></span></code></pre></div><p>Lets create also and additional <code>Gateway</code> linked to the GatewayClass and <code>backend</code> application from Quickstart example.</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-05-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-05-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.quickstart.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.quickstart.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Verify that Gateways are deployed and programmed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways -n default
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME          CLASS       ADDRESS          PROGRAMMED   AGE
</span></span><span style=display:flex><span>eg            eg          172.18.255.203   True         114s
</span></span><span style=display:flex><span>eg-2          eg          172.18.255.204   True         89s
</span></span><span style=display:flex><span>merged-eg-1   merged-eg   172.18.255.202   True         8m33s
</span></span><span style=display:flex><span>merged-eg-2   merged-eg   172.18.255.202   True         8m33s
</span></span><span style=display:flex><span>merged-eg-3   merged-eg   172.18.255.202   True         8m33s
</span></span></code></pre></div><p>Verify that HTTPRoutes are deployed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute -n default
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAMESPACE   NAME              HOSTNAMES                        AGE
</span></span><span style=display:flex><span>default     backend           <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>              2m29s
</span></span><span style=display:flex><span>default     eg-2              <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.quickstart.example.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   87s
</span></span><span style=display:flex><span>default     hostname1-route   <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.merged1.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>              10m4s
</span></span><span style=display:flex><span>default     hostname2-route   <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.merged2.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>              10m4s
</span></span><span style=display:flex><span>default     hostname3-route   <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;www.merged3.com&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>              10m4s
</span></span></code></pre></div><p>Verify that services are now deployed separately.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service -n envoy-gateway-system
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>                                        AGE
</span></span><span style=display:flex><span>envoy-default-eg-2-7e515b2f     LoadBalancer   10.96.121.46    172.18.255.204   8080:32705/TCP                                 3m27s
</span></span><span style=display:flex><span>envoy-default-eg-e41e7b31       LoadBalancer   10.96.11.244    172.18.255.203   80:31930/TCP                                   2m26s
</span></span><span style=display:flex><span>envoy-gateway                   ClusterIP      10.96.141.4     &lt;none&gt;           18000/TCP,18001/TCP                            14m25s
</span></span><span style=display:flex><span>envoy-gateway-metrics-service   ClusterIP      10.96.113.191   &lt;none&gt;           19001/TCP                                      14m25s
</span></span><span style=display:flex><span>envoy-merged-eg-668ac7ae        LoadBalancer   10.96.243.32    172.18.255.202   8082:31622/TCP,8080:32262/TCP,8081:32305/TCP   10m59s
</span></span></code></pre></div><p>There should be two deployments for each of newly deployed Gateway and its name should reference the name of the namespace and the Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -n envoy-gateway-system
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                                          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>envoy-default-eg-2-7e515b2f-8c98fdf88-p6jhg   2/2     Running   <span style=color:#0000cf;font-weight:700>0</span>          3m27s
</span></span><span style=display:flex><span>envoy-default-eg-e41e7b31-6f998d85d7-jpvmj    2/2     Running   <span style=color:#0000cf;font-weight:700>0</span>          2m26s
</span></span><span style=display:flex><span>envoy-gateway-5d998778f6-wr6m9                1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          14m25s
</span></span><span style=display:flex><span>envoy-merged-eg-668ac7ae-5958f7b7f6-9h9v2     2/2     Running   <span style=color:#0000cf;font-weight:700>0</span>          10m59s
</span></span></code></pre></div><h4 id=testing-the-configuration-1>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration-1 aria-label="Heading self-link"></a></h4><p>Get the name of the merged gateways Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>DEFAULT_ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Fetch external IP of the service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>DEFAULT_GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc/<span style=color:#4e9a06>${</span><span style=color:#000>DEFAULT_ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> -n envoy-gateway-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Curl the route Quickstart backend route through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$DEFAULT_GATEWAY_HOST</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.4.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;70a40595-67a1-4776-955b-2dee361baed7&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-96f75bbf-6w67z&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Curl the route hostname-route3 through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: www.merged3.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>:8082/example3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/example3&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.merged3.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.4.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;47aeaef3-abb5-481a-ab92-c2ae3d0862d6&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;merged-backend-64ddb65fd7-k84gv&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-afcad90650762949b935f95348647119>2.6.3 - Standalone Deployment Mode</h1><div class="alert alert-warning" role=alert><h4 class=alert-heading>Notice</h4>Standalone mode is an experimental feature, please <strong>DO NOT</strong> use it in production.</div><p>Envoy Gateway also supports running in standalone mode. In this mode, Envoy Gateway
does not need to rely on Kubernetes and can be deployed directly on bare metal or virtual machines.</p><p>Currently, Envoy Gateway only support the file provider and the host infrastructure provider combinations.</p><ul><li>The file provider will configure the Envoy Gateway to get all gateway-api resources from file system.</li><li>The host infrastructure provider will configure the Envoy Gateway to deploy one Envoy Proxy as a host process.</li></ul><h2 id=quick-start>Quick Start<a class=td-heading-self-link href=#quick-start aria-label="Heading self-link"></a></h2><p>In this quick-start, we will run Envoy Gateway in standalone mode with the file provider
and the host infrastructure provider.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>Create a local directory just for testing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p /tmp/envoy-gateway-test
</span></span></code></pre></div><p>Download the Envoy Gateway binary from v1.2.x release.</p><h3 id=create-certificates>Create Certificates<a class=td-heading-self-link href=#create-certificates aria-label="Heading self-link"></a></h3><p>All runners in Envoy Gateway are using TLS connection, so create these TLS certificates locally to
ensure the Envoy Gateway works properly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>envoy-gateway certgen --local
</span></span></code></pre></div><h3 id=start-envoy-gateway>Start Envoy Gateway<a class=td-heading-self-link href=#start-envoy-gateway aria-label="Heading self-link"></a></h3><p>Start Envoy Gateway by the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>envoy-gateway server --config-path standalone.yaml
</span></span></code></pre></div><p>with <code>standalone.yaml</code> configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Custom</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>custom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>File</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>paths</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/tmp/envoy-gateway-test&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>infrastructure</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Host</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>level</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>info</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>extensionApis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enableBackend</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>As you can see, we have enabled the <a href=../../../api/extension_types#backend>Backend</a> API, this API will be used to represent our local endpoints.</p><h3 id=trigger-an-update>Trigger an Update<a class=td-heading-self-link href=#trigger-an-update aria-label="Heading self-link"></a></h3><p>Any changes under watched <code>paths</code> will be considered as an update by the file provider.</p><p>For instance, copying example file into <code>/tmp/envoy-gateway-test/</code> will trigger an update of gateway-api resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cp examples/standalone/quickstart.yaml /tmp/envoy-gateway-test/quickstart.yaml
</span></span></code></pre></div><p>From the Envoy Gateway log, you should be able to observe that the Envoy Proxy has been started, and its admin address has been returned.</p><h3 id=test-connection>Test Connection<a class=td-heading-self-link href=#test-connection aria-label="Heading self-link"></a></h3><p>Starts a simple local server as an endpoint:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>python3 -m http.server <span style=color:#0000cf;font-weight:700>3000</span>
</span></span></code></pre></div><p>Curl the example server through Envoy Proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://0.0.0.0:8888/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 0.0.0.0:8888...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 0.0.0.0 (127.0.0.1) port 8888 (#0)
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET / HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: SimpleHTTP/0.6 Python/3.10.12
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Sat, 26 Oct 2024 13:20:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: text/html; charset=utf-8
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 1870
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 0.0.0.0 left intact
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2f309c5f4449e3d9b0e3a261f853ad76>2.6.4 - Use egctl</h1><p><code>egctl</code> is a command line tool to provide additional functionality for Envoy Gateway users.</p><h2 id=egctl-experimental-translate>egctl experimental translate<a class=td-heading-self-link href=#egctl-experimental-translate aria-label="Heading self-link"></a></h2><p>This subcommand allows users to translate from an input configuration type to an output configuration type.</p><p>The <code>translate</code> subcommand can translate Kubernetes resources to:</p><ul><li><p>Gateway API resources
This is useful in order to see how validation would occur if these resources were applied to Kubernetes.</p><p>Use the <code>--to gateway-api</code> parameter to translate to Gateway API resources.</p></li><li><p>Envoy Gateway intermediate representation (IR)
This represents Envoy Gateway&rsquo;s translation of the Gateway API resources.</p><p>Use the <code>--to ir</code> parameter to translate to Envoy Gateway intermediate representation.</p></li><li><p>Envoy Proxy xDS
This is the xDS configuration provided to Envoy Proxy.</p><p>Use the <code>--to xds</code> parameter to translate to Envoy Proxy xDS.</p></li></ul><p>In the below example, we will translate the Kubernetes resources (including the Gateway API resources) into xDS
resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --to xds -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clusterIP: &#34;1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: ClusterIP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>configKey</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.BootstrapConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>bootstrap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.access_loggers.file</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>dynamicResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>cdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>setNodeOnFirstMessageOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ldsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>setNodeOnFirstMessageOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>layeredRuntime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>layers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>rtdsLayer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>rtdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>staticResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>clusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>connectTimeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>loadAssignment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>lbEndpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>transportSocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.transport_sockets.tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>commonTlsContext</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>tlsCertificateSdsSecretConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_certificate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>pathConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/sds/xds-certificate.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>tlsParams</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>tlsMaximumProtocolVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLSv1_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>validationContextSdsSecretConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_trusted_ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>pathConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/sds/xds-trusted-ca.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STRICT_DNS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>typedExtensionProtocolOptions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>explicitHttpConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>http2ProtocolOptions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.ClustersConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamicActiveClusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.cluster.v3.Cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>commonLbConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>localityWeightedLbConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>connectTimeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>dnsLookupFamily</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V4_ONLY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>loadAssignment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>lbEndpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1.1.1.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>loadBalancingWeight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>loadBalancingWeight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>locality</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>outlierDetection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STATIC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.ListenersConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamicListeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>activeState</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>listener</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.listener.v3.Listener</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>responseFlagFilter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>flags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#000>NR</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.access_loggers.file</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.0.0.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>defaultFilterChain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.network.http_connection_manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.access_loggers.file</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>httpFilters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.router</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>rds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>configSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>setNodeOnFirstMessageOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>routeConfigName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>statPrefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>upgradeConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>upgradeType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>websocket</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>useRemoteAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamicRouteConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>routeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.route.v3.RouteConfiguration</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>virtualHosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>domains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>routes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>route</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>resourceType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>all</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You can also use the <code>--type</code>/<code>-t</code> flag to retrieve specific output types. In the below example, we will translate the Kubernetes resources (including the Gateway API resources) into xDS <code>route</code> resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --to xds -t route -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clusterIP: &#34;1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: ClusterIP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>configKey</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dynamicRouteConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>routeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.route.v3.RouteConfiguration</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>virtualHosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>domains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>routes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>route</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>resourceType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=add-missing-resources>Add Missing Resources<a class=td-heading-self-link href=#add-missing-resources aria-label="Heading self-link"></a></h3><p>You can pass the <code>--add-missing-resources</code> flag to use dummy non Gateway API resources instead of specifying them explicitly.</p><p>For example, this will provide the similar result as the above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --add-missing-resources --from gateway-api --to gateway-api -t route -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>You can see the output contains a <a href=../../../api/extension_types#envoyproxy>EnvoyProxy</a> resource that
can be used as a starting point to modify the xDS bootstrap resource for the managed Envoy Proxy fleet.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>envoyProxy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-envoy-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>bootstrap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      admin:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        access_log:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - name: envoy.access_loggers.file
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          typed_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            path: /dev/null
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          socket_address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            address: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            port_value: 19000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      dynamic_resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ads_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          api_type: DELTA_GRPC
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          transport_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          grpc_services:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          - envoy_grpc:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          set_node_on_first_message_only: true
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        lds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        cds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      static_resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        clusters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - connect_timeout: 10s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          load_assignment:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            endpoints:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            - lb_endpoints:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              - endpoint:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    socket_address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      address: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      port_value: 18000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          typed_extension_protocol_options:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>               &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>               &#34;explicit_http_config&#34;:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                 &#34;http2_protocol_options&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          type: STRICT_DNS
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          transport_socket:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            name: envoy.transport_sockets.tls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            typed_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              common_tls_context:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                tls_params:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  tls_maximum_protocol_version: TLSv1_3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                tls_certificate_sds_secret_configs:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                - name: xds_certificate
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      path: &#34;/sds/xds-certificate.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                validation_context_sds_secret_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  name: xds_trusted_ca
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      path: &#34;/sds/xds-trusted-ca.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      layered_runtime:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        layers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          rtds_layer:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            rtds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            name: runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>      
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gatewayClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-envoy-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Valid GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateways</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>attachedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Sending translated listener configuration to the data plane</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Listener has been successfully translated</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>supportedKinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRPCRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>httpRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parents</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Route is accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resolved all the Object references for the Route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResolvedRefs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResolvedRefs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>parentRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Sometimes you might find that egctl doesn&rsquo;t provide an expected result. For example, the following example provides an empty route resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --type route --to xds -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>xds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway-system-eg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=validating-gateway-api-configuration>Validating Gateway API Configuration<a class=td-heading-self-link href=#validating-gateway-api-configuration aria-label="Heading self-link"></a></h3><p>You can add an additional target <code>gateway-api</code> to show the processed Gateway API resources. For example, translating the above resources with the new argument shows that the HTTPRoute is rejected because there is no ready listener for it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --type route --to gateway-api,xds -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>gatewayClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Valid GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateways</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>attachedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Listener must have TLS set when protocol is TLS.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Invalid</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;False&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>supportedKinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLSRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>httpRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parents</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>There are no ready listeners for this parent ref</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NoReadyListeners</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;False&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service envoy-gateway-system/backend not found</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendNotFound</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;False&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResolvedRefs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>parentRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>xds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway-system-eg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=egctl-experimental-status>egctl experimental status<a class=td-heading-self-link href=#egctl-experimental-status aria-label="Heading self-link"></a></h2><p>This subcommand allows users to show the summary of the status of specific or all resource types, in order to quickly find
out the status of any resources.</p><p>By default, <code>egctl x status</code> display all the conditions for one resource type. You can either add <code>--quiet</code> to only
display the latest condition, or add <code>--verbose</code> to display more details about current status.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>The resource types that this subcommand currently supports:</p><ul><li><code>xRoute</code>, <code>HTTPRoute</code>, <code>GRPCRoute</code>, <code>TLSRoute</code>, <code>TCPRoute</code>, <code>UDPRoute</code></li><li><code>xPolicy</code>, <code>BackendTLSPolicy</code>, <code>BackendTrafficPolicy</code>, <code>ClientTrafficPolicy</code>, <code>EnvoyPatchPolicy</code>, <code>SecurityPolicy</code></li><li><code>all</code>, <code>GatewayClass</code>, <code>Gateway</code></li></ul></div><p>Some examples of this command after installing <a href=../deployment-mode#multi-tenancy>Multi-tenancy</a> example manifest:</p><ul><li>Show the summary of GatewayClass.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>~ egctl x status gatewayclass
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAME           TYPE       STATUS    REASON
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-marketing   Accepted   True      Accepted
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-product     Accepted   True      Accepted
</span></span></span></code></pre></div><ul><li>Show the summary of all resource types under all namespaces, the resource type with empty status will be ignored.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>~ egctl x status all -A
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAME                        TYPE       STATUS    REASON
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>gatewayclass/eg-marketing   Accepted   True      Accepted
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>gatewayclass/eg-product     Accepted   True      Accepted
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAMESPACE   NAME         TYPE         STATUS    REASON
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>marketing   gateway/eg   Programmed   True      Programmed
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>                         Accepted     True      Accepted
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>product     gateway/eg   Programmed   True      Programmed
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>                         Accepted     True      Accepted
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAMESPACE   NAME                PARENT       TYPE           STATUS    REASON
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>marketing   httproute/backend   gateway/eg   ResolvedRefs   True      ResolvedRefs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>                                             Accepted       True      Accepted
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>product     httproute/backend   gateway/eg   ResolvedRefs   True      ResolvedRefs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>                                             Accepted       True      Accepted
</span></span></span></code></pre></div><ul><li>Show the summary of all the Gateways with details under all namespaces.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>~ egctl x status gateway --verbose --all-namespaces
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAMESPACE   NAME      TYPE         STATUS    REASON       MESSAGE                                                                    OBSERVED GENERATION   LAST TRANSITION TIME
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>marketing   eg        Programmed   True      Programmed   Address assigned to the Gateway, 1/1 envoy Deployment replicas available   1                     2024-02-02 18:17:14 +0800 CST
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>                      Accepted     True      Accepted     The Gateway has been scheduled by Envoy Gateway                            1                     2024-02-01 17:50:39 +0800 CST
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>product     eg        Programmed   True      Programmed   Address assigned to the Gateway, 1/1 envoy Deployment replicas available   1                     2024-02-02 18:17:14 +0800 CST
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>                      Accepted     True      Accepted     The Gateway has been scheduled by Envoy Gateway                            1                     2024-02-01 17:52:42 +0800 CST
</span></span></span></code></pre></div><ul><li>Show the summary of the latest Gateways condition under <code>product</code> namespace.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>~ egctl x status gateway --quiet -n product
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAME      TYPE         STATUS    REASON
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg        Programmed   True      Programmed
</span></span></span></code></pre></div><ul><li>Show the summary of latest HTTPRoutes condition under all namespaces.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>~ egctl x status httproute --quiet --all-namespaces
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>NAMESPACE   NAME      PARENT       TYPE           STATUS    REASON
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>marketing   backend   gateway/eg   ResolvedRefs   True      ResolvedRefs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>product     backend   gateway/eg   ResolvedRefs   True      ResolvedRefs
</span></span></span></code></pre></div><h2 id=egctl-experimental-dashboard>egctl experimental dashboard<a class=td-heading-self-link href=#egctl-experimental-dashboard aria-label="Heading self-link"></a></h2><p>This subcommand streamlines the process for users to access the Envoy admin dashboard. By executing the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x dashboard envoy-proxy -n envoy-gateway-system envoy-engw-eg-a9c23fbb-558f94486c-82wh4
</span></span></code></pre></div><p>You will see the following output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x dashboard envoy-proxy -n envoy-gateway-system envoy-engw-eg-a9c23fbb-558f94486c-82wh4
</span></span><span style=display:flex><span>http://localhost:19000
</span></span></code></pre></div><p>the Envoy admin dashboard will automatically open in your default web browser. This eliminates the need to manually locate and expose the admin port.</p><h2 id=egctl-experimental-install>egctl experimental install<a class=td-heading-self-link href=#egctl-experimental-install aria-label="Heading self-link"></a></h2><p>This subcommand can be used to install envoy-gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x install
</span></span></code></pre></div><p>By default, this will install both the envoy-gateway workload resource and the required gateway-api and envoy-gatewayCRDs.</p><p>We can specify to install only workload resources via <code>--skip-crds</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x install --skip-crds
</span></span></code></pre></div><p>We can specify to install only CRDs resources via <code>--only-crds</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x install --only-crds
</span></span></code></pre></div><p>We can specify <code>--name</code> and <code>--namespace</code> to install envoy-gateway in different places to support multi-tenant mode.</p><blockquote><p>Note: If CRDs are already installed, then we need to specify <code>--skip-crds</code> to avoid repeated installation of CRDs resources.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x install --name shop-backend --namespace shop
</span></span></code></pre></div><h2 id=egctl-experimental-uninstall>egctl experimental uninstall<a class=td-heading-self-link href=#egctl-experimental-uninstall aria-label="Heading self-link"></a></h2><p>This subcommand can be used to uninstall envoy-gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x uninstall
</span></span></code></pre></div><p>By default, this will only uninstall the envoy-gateway workload resource, if we want to also uninstall CRDs, we need to specify <code>--with-crds</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>egctl x uninstall --with-crds
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e5b30fe922af4d9819aeddf7a8114f18>3 - Installation</h1><div class=lead>This section includes installation related contents of Envoy Gateway.</div></div><div class=td-content><h1 id=pg-33a8f17a33acfbbbe86011ec5e007097>3.1 - Install with Helm</h1><p><a href=https://helm.sh>Helm</a> is a package manager for Kubernetes that automates the release and management of software on Kubernetes.</p><p>Envoy Gateway can be installed via a Helm chart with a few simple steps, depending on if you are deploying for the first time, upgrading Envoy Gateway from an existing installation, or migrating from Envoy Gateway.</p><h2 id=before-you-begin>Before you begin<a class=td-heading-self-link href=#before-you-begin aria-label="Heading self-link"></a></h2><div class="alert alert-warning" role=alert><h4 class=alert-heading>Compatibility Matrix</h4>Refer to the <a href=/eg-pr-preview/5-test-docs-preview/news/releases/matrix/>Version Compatibility Matrix</a> to learn more.</div><p>The Envoy Gateway Helm chart is hosted by DockerHub.</p><p>It is published at <code>oci://docker.io/envoyproxy/gateway-helm</code>.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>We use <code>v0.0.0-latest</code> as the latest development version.</p><p>You can visit <a href=https://hub.docker.com/r/envoyproxy/gateway-helm/tags>Envoy Gateway Helm Chart</a> for more releases.</p></div><h2 id=install-with-helm>Install with Helm<a class=td-heading-self-link href=#install-with-helm aria-label="Heading self-link"></a></h2><p>Envoy Gateway is typically deployed to Kubernetes from the command line. If you don&rsquo;t have Kubernetes, you should use <code>kind</code> to create one.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Developer Guide</h4>Refer to the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to learn more.</div><p>Install the Gateway API CRDs and Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Install the GatewayClass, Gateway, HTTPRoute and example app:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/v1.2.4/quickstart.yaml -n default
</span></span></code></pre></div><p><strong>Note</strong>: <a href=https://github.com/envoyproxy/gateway/releases/download/v1.2.4/quickstart.yaml><code>quickstart.yaml</code></a> defines that Envoy Gateway will listen for
traffic on port 80 on its globally-routable IP address, to make it easy to use
browsers to test Envoy Gateway. When Envoy Gateway sees that its Listener is
using a privileged port (&lt;1024), it will map this internally to an
unprivileged port, so that Envoy Gateway doesn&rsquo;t need additional privileges.
It&rsquo;s important to be aware of this mapping, since you may need to take it into
consideration when debugging.</p><h2 id=upgrading-from-a-previous-version>Upgrading from a previous version<a class=td-heading-self-link href=#upgrading-from-a-previous-version aria-label="Heading self-link"></a></h2><p><a href=https://helm.sh/docs/chart_best_practices/custom_resource_definitions/#some-caveats-and-explanations>Helm</a> does not update CRDs
that live in the <code>/crds</code> folder in the Helm Chart. So you will manually need to update the CRDs.
Follow the steps outlined in <a href=/eg-pr-preview/5-test-docs-preview/v1.2/install/install-yaml/#upgrading-from-v1.1>this</a> section if you&rsquo;re upgrading from a previous version.</p><h2 id=helm-chart-customizations>Helm chart customizations<a class=td-heading-self-link href=#helm-chart-customizations aria-label="Heading self-link"></a></h2><p>Some of the quick ways of using the helm install command for envoy gateway installation are below.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Helm Chart Values</h4>If you want to know all the available fields inside the values.yaml file, please see the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/install/gateway-helm-api/>Helm Chart Values</a>.</div><h3 id=increase-the-replicas>Increase the replicas<a class=td-heading-self-link href=#increase-the-replicas aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system --create-namespace --set deployment.replicas<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span></code></pre></div><h3 id=change-the-kubernetesclusterdomain-name>Change the kubernetesClusterDomain name<a class=td-heading-self-link href=#change-the-kubernetesclusterdomain-name aria-label="Heading self-link"></a></h3><p>If you have installed your cluster with different domain name you can use below command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system --create-namespace --set <span style=color:#000>kubernetesClusterDomain</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;domain name&gt;
</span></span></code></pre></div><p><strong>Note</strong>: Above are some of the ways we can directly use for customization of our installation. But if you are looking for more complex changes <a href=https://helm.sh/docs/chart_template_guide/values_files/>values.yaml</a> comes to rescue.</p><h3 id=using-valuesyaml-file-for-complex-installation>Using values.yaml file for complex installation<a class=td-heading-self-link href=#using-valuesyaml-file-for-complex-installation aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoyGateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>700m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>128Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>64Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18005</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18006</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18001</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoyGateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>level</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>debug</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Here we have made three changes to our values.yaml file. Increase the resources limit for cpu to <code>700m</code>, changed the port for grpc to <code>18005</code> and for ratelimit to <code>18006</code> and also updated the logging level to <code>debug</code>.</p><p>You can use the below command to install the envoy gateway using values.yaml file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system --create-namespace -f values.yaml
</span></span></code></pre></div><h2 id=open-ports>Open Ports<a class=td-heading-self-link href=#open-ports aria-label="Heading self-link"></a></h2><p>These are the ports used by Envoy Gateway and the managed Envoy Proxy.</p><h3 id=envoy-gateway>Envoy Gateway<a class=td-heading-self-link href=#envoy-gateway aria-label="Heading self-link"></a></h3><table><thead><tr><th style=text-align:center>Envoy Gateway</th><th style=text-align:center>Address</th><th style=text-align:center>Port</th><th style=text-align:center>Configurable</th></tr></thead><tbody><tr><td style=text-align:center>Xds EnvoyProxy Server</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>18000</td><td style=text-align:center>No</td></tr><tr><td style=text-align:center>Xds RateLimit Server</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>18001</td><td style=text-align:center>No</td></tr><tr><td style=text-align:center>Admin Server</td><td style=text-align:center>127.0.0.1</td><td style=text-align:center>19000</td><td style=text-align:center>Yes</td></tr><tr><td style=text-align:center>Metrics Server</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>19001</td><td style=text-align:center>No</td></tr><tr><td style=text-align:center>Health Check</td><td style=text-align:center>127.0.0.1</td><td style=text-align:center>8081</td><td style=text-align:center>No</td></tr></tbody></table><h3 id=envoyproxy>EnvoyProxy<a class=td-heading-self-link href=#envoyproxy aria-label="Heading self-link"></a></h3><table><thead><tr><th style=text-align:center>Envoy Proxy</th><th style=text-align:center>Address</th><th style=text-align:center>Port</th></tr></thead><tbody><tr><td style=text-align:center>Admin Server</td><td style=text-align:center>127.0.0.1</td><td style=text-align:center>19000</td></tr><tr><td style=text-align:center>Heath Check</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>19001</td></tr></tbody></table><div class="alert alert-warning" role=alert><h4 class=alert-heading>Next Steps</h4>Envoy Gateway should now be successfully installed and running. To experience more abilities of Envoy Gateway, refer to <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/>Tasks</a>.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-71f8f322d1cf1387f45bc1f1eb600ff9>3.2 - Install with Kubernetes YAML</h1><p>This task walks you through installing Envoy Gateway in your Kubernetes cluster.</p><p>The manual install process does not allow for as much control over configuration
as the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/install/install-helm/>Helm install method</a>, so if you need more control over your Envoy Gateway
installation, it is recommended that you use helm.</p><h2 id=before-you-begin>Before you begin<a class=td-heading-self-link href=#before-you-begin aria-label="Heading self-link"></a></h2><p>Envoy Gateway is designed to run in Kubernetes for production. The most essential requirements are:</p><ul><li>Kubernetes 1.28 or later</li><li>The <code>kubectl</code> command-line tool</li></ul><div class="alert alert-warning" role=alert><h4 class=alert-heading>Compatibility Matrix</h4>Refer to the <a href=/eg-pr-preview/5-test-docs-preview/news/releases/matrix/>Version Compatibility Matrix</a> to learn more.</div><h2 id=install-with-yaml>Install with YAML<a class=td-heading-self-link href=#install-with-yaml aria-label="Heading self-link"></a></h2><p>Envoy Gateway is typically deployed to Kubernetes from the command line. If you don&rsquo;t have Kubernetes, you should use <code>kind</code> to create one.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Developer Guide</h4>Refer to the <a href=/eg-pr-preview/5-test-docs-preview/contributions/develop/>Developer Guide</a> to learn more.</div><ol><li><p>In your terminal, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply --server-side -f https://github.com/envoyproxy/gateway/releases/download/v1.2.4/install.yaml
</span></span></code></pre></div></li><li><p>Next Steps</p><p>Envoy Gateway should now be successfully installed and running, but in order to experience more abilities of Envoy Gateway, you can refer to <a href=/eg-pr-preview/5-test-docs-preview/latest/tasks/>Tasks</a>.</p></li></ol><h2 id=upgrading-from-v11>Upgrading from v1.1<a class=td-heading-self-link href=#upgrading-from-v11 aria-label="Heading self-link"></a></h2><p>Some manual migration steps are required to upgrade Envoy Gateway to v1.2.</p><ol><li><p>Update your <code>GRPCRoute</code> and <code>ReferenceGrant</code> resources if the storage version being used is <code>v1alpha2</code>.
Follow the steps in Gateway-API <a href=https://gateway-api.sigs.k8s.io/guides/#v12-upgrade-notes>v1.2 Upgrade Notes</a></p></li><li><p>Update Gateway-API and Envoy Gateway CRDs:</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm pull oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 --untar
</span></span><span style=display:flex><span>kubectl apply --force-conflicts --server-side -f ./gateway-helm/crds/gatewayapi-crds.yaml
</span></span><span style=display:flex><span>kubectl apply --force-conflicts --server-side -f ./gateway-helm/crds/generated
</span></span></code></pre></div><ol start=3><li>Install Envoy Gateway v1.2.4:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm upgrade eg oci://docker.io/envoyproxy/gateway-helm --version v1.2.4 -n envoy-gateway-system
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b4e9976bf99ec9b3a4100438bd9cb738>3.3 - Install egctl</h1><div class="alert alert-primary" role=alert><h4 class=alert-heading>What is egctl?</h4><code>egctl</code> is a command line tool to provide additional functionality for Envoy Gateway users.</div><p>This task shows how to install the egctl CLI. egctl can be installed either from source, or from pre-built binary releases.</p><h3 id=from-the-envoy-gateway-project>From The Envoy Gateway Project<a class=td-heading-self-link href=#from-the-envoy-gateway-project aria-label="Heading self-link"></a></h3><p>The Envoy Gateway project provides two ways to fetch and install egctl. These are the official methods to get egctl releases. Installation through those methods can be found below the official methods.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="from the binary releases" aria-controls=tabs-01-00 aria-selected=true>
From the Binary Releases</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="from script" aria-controls=tabs-01-01 aria-selected=false>
From Script</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist="from homebrew" aria-controls=tabs-01-02 aria-selected=false>
From Homebrew</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><p>Every <a href=https://github.com/envoyproxy/gateway/releases>release</a> of egctl provides binary releases for a variety of OSes. These binary versions can be manually downloaded and installed.</p><ol><li>Download your <a href=https://github.com/envoyproxy/gateway/releases>desired version</a></li><li>Unpack it (tar -zxvf egctl_latest_linux_amd64.tar.gz)</li><li>Find the egctl binary in the unpacked directory, and move it to its desired destination (mv bin/linux/amd64/egctl /usr/local/bin/egctl)</li></ol><p>From there, you should be able to run: <code>egctl help</code>.</p></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p><code>egctl</code> now has an installer script that will automatically grab the latest release version of egctl and install it locally.</p><p>You can fetch that script, and then execute it locally. It&rsquo;s well documented so that you can read through it and understand what it is doing before you run it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -fsSL -o get-egctl.sh https://gateway.envoyproxy.io/get-egctl.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod +x get-egctl.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># get help info of the </span>
</span></span><span style=display:flex><span>bash get-egctl.sh --help
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># install the latest development version of egctl</span>
</span></span><span style=display:flex><span>bash <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>latest get-egctl.sh
</span></span></code></pre></div><p>Yes, you can just use the below command if you want to live on the edge.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -fsSL https://gateway.envoyproxy.io/get-egctl.sh <span style=color:#000;font-weight:700>|</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>latest bash 
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><p>You can also install egctl using homebrew:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install egctl
</span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><h4 class=alert-heading>Next Steps</h4>You can refer to the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/tasks/operations/egctl/>Use egctl task</a> for more details about egctl.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-47cdb8cfca1889b42b1ed5b03bf816eb>3.4 - Control Plane Authentication using custom certs</h1><p>Envoy Gateway establishes a secure TLS connection for control plane communication between Envoy Gateway pods and the Envoy Proxy fleet. The TLS Certificates used here are self signed and generated using a job that runs before envoy gateway is created, and these certs and mounted on to the envoy gateway and envoy proxy pods.</p><p>This task will walk you through configuring custom certs for control plane auth.</p><h2 id=before-you-begin>Before you begin<a class=td-heading-self-link href=#before-you-begin aria-label="Heading self-link"></a></h2><p>We use Cert-Manager to manage the certificates. You can install it by following the <a href=https://cert-manager.io/docs/installation/kubernetes/>official guide</a>.</p><h2 id=configure-custom-certs-for-control-plane>Configure custom certs for control plane<a class=td-heading-self-link href=#configure-custom-certs-for-control-plane aria-label="Heading self-link"></a></h2><ol><li><p>First you need to set up the CA issuer, in this task, we use the <code>selfsigned-issuer</code> as an example.</p><p><em>You should not use the self-signed issuer in production, you should use a real CA issuer.</em></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app.kubernetes.io/name: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: selfsigned-issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selfSigned: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  isCA: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  commonName: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  secretName: envoy-gateway-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  privateKey:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    algorithm: RSA
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    size: 2048
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  issuerRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: selfsigned-issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: cert-manager.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app.kubernetes.io/name: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ca:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    secretName: envoy-gateway-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></li><li><p>Create a cert for envoy gateway controller, the cert will be stored in secret <code>envoy-gatewy</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat<span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app.kubernetes.io/name: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  commonName: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  dnsNames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;envoy-gateway&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;envoy-gateway.envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;envoy-gateway.envoy-gateway-system.svc&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;envoy-gateway.envoy-gateway-system.svc.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  issuerRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg-issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  usages:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;digital signature&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;data encipherment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;key encipherment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;content commitment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  secretName: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></li><li><p>Create a cert for envoy proxy, the cert will be stored in secret <code>envoy</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat<span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app.kubernetes.io/name: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  commonName: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  dnsNames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;*.envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  issuerRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg-issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  usages:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;digital signature&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;data encipherment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;key encipherment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;content commitment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  secretName: envoy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></li><li><p>Create a cert for rate limit, the cert will be stored in secret <code>envoy-rate-limit</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat<span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app.kubernetes.io/name: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-rate-limit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  commonName: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  dnsNames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;*.envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  issuerRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg-issuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  usages:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;digital signature&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;data encipherment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;key encipherment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;content commitment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  secretName: envoy-rate-limit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></li><li><p>Now you can follow the helm chart <a href=../install-helm>installation guide</a> to install envoy gateway with custom certs.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-e16617c26da42e3d88bd31274052d863>3.5 - Gateway Addons Helm Chart</h1><p><img alt="Version: v0.0.0-latest" src="https://img.shields.io/badge/Version-v0.0.0--latest-informational?style=flat-square"> <img alt="Type: application" src="https://img.shields.io/badge/Type-application-informational?style=flat-square"> <img alt="AppVersion: latest" src="https://img.shields.io/badge/AppVersion-latest-informational?style=flat-square"></p><p>An Add-ons Helm chart for Envoy Gateway</p><p><strong>Homepage:</strong> <a href=https://gateway.envoyproxy.io/>https://gateway.envoyproxy.io/</a></p><h2 id=maintainers>Maintainers<a class=td-heading-self-link href=#maintainers aria-label="Heading self-link"></a></h2><table><thead><tr><th>Name</th><th>Email</th><th>Url</th></tr></thead><tbody><tr><td>envoy-gateway-steering-committee</td><td></td><td><a href=https://github.com/envoyproxy/gateway/blob/main/GOVERNANCE.md>https://github.com/envoyproxy/gateway/blob/main/GOVERNANCE.md</a></td></tr><tr><td>envoy-gateway-maintainers</td><td></td><td><a href=https://github.com/envoyproxy/gateway/blob/main/CODEOWNERS>https://github.com/envoyproxy/gateway/blob/main/CODEOWNERS</a></td></tr></tbody></table><h2 id=source-code>Source Code<a class=td-heading-self-link href=#source-code aria-label="Heading self-link"></a></h2><ul><li><a href=https://github.com/envoyproxy/gateway>https://github.com/envoyproxy/gateway</a></li></ul><h2 id=requirements>Requirements<a class=td-heading-self-link href=#requirements aria-label="Heading self-link"></a></h2><table><thead><tr><th>Repository</th><th>Name</th><th>Version</th></tr></thead><tbody><tr><td><a href=https://fluent.github.io/helm-charts>https://fluent.github.io/helm-charts</a></td><td>fluent-bit</td><td>0.30.4</td></tr><tr><td><a href=https://grafana.github.io/helm-charts>https://grafana.github.io/helm-charts</a></td><td>alloy</td><td>0.9.2</td></tr><tr><td><a href=https://grafana.github.io/helm-charts>https://grafana.github.io/helm-charts</a></td><td>grafana</td><td>8.0.0</td></tr><tr><td><a href=https://grafana.github.io/helm-charts>https://grafana.github.io/helm-charts</a></td><td>loki</td><td>4.8.0</td></tr><tr><td><a href=https://grafana.github.io/helm-charts>https://grafana.github.io/helm-charts</a></td><td>tempo</td><td>1.3.1</td></tr><tr><td><a href=https://open-telemetry.github.io/opentelemetry-helm-charts>https://open-telemetry.github.io/opentelemetry-helm-charts</a></td><td>opentelemetry-collector</td><td>0.108.0</td></tr><tr><td><a href=https://prometheus-community.github.io/helm-charts>https://prometheus-community.github.io/helm-charts</a></td><td>prometheus</td><td>25.21.0</td></tr></tbody></table><h2 id=values>Values<a class=td-heading-self-link href=#values aria-label="Heading self-link"></a></h2><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>alloy.alloy.configMap.content</td><td>string</td><td><code>"// Write your Alloy config here:\nlogging {\n level = \"info\"\n format = \"logfmt\"\n}\nloki.write \"alloy\" {\n endpoint {\n url = \"http://loki.monitoring.svc:3100/loki/api/v1/push\"\n }\n}\n// discovery.kubernetes allows you to find scrape targets from Kubernetes resources.\n// It watches cluster state and ensures targets are continually synced with what is currently running in your cluster.\ndiscovery.kubernetes \"pod\" {\n role = \"pod\"\n}\n\n// discovery.relabel rewrites the label set of the input targets by applying one or more relabeling rules.\n// If no rules are defined, then the input targets are exported as-is.\ndiscovery.relabel \"pod_logs\" {\n targets = discovery.kubernetes.pod.targets\n\n // Label creation - \"namespace\" field from \"__meta_kubernetes_namespace\"\n rule {\n source_labels = [\"__meta_kubernetes_namespace\"]\n action = \"replace\"\n target_label = \"namespace\"\n }\n\n // Label creation - \"pod\" field from \"__meta_kubernetes_pod_name\"\n rule {\n source_labels = [\"__meta_kubernetes_pod_name\"]\n action = \"replace\"\n target_label = \"pod\"\n }\n\n // Label creation - \"container\" field from \"__meta_kubernetes_pod_container_name\"\n rule {\n source_labels = [\"__meta_kubernetes_pod_container_name\"]\n action = \"replace\"\n target_label = \"container\"\n }\n\n // Label creation - \"app\" field from \"__meta_kubernetes_pod_label_app_kubernetes_io_name\"\n rule {\n source_labels = [\"__meta_kubernetes_pod_label_app_kubernetes_io_name\"]\n action = \"replace\"\n target_label = \"app\"\n }\n\n // Label creation - \"job\" field from \"__meta_kubernetes_namespace\" and \"__meta_kubernetes_pod_container_name\"\n // Concatenate values __meta_kubernetes_namespace/__meta_kubernetes_pod_container_name\n rule {\n source_labels = [\"__meta_kubernetes_namespace\", \"__meta_kubernetes_pod_container_name\"]\n action = \"replace\"\n target_label = \"job\"\n separator = \"/\"\n replacement = \"$1\"\n }\n\n // Label creation - \"container\" field from \"__meta_kubernetes_pod_uid\" and \"__meta_kubernetes_pod_container_name\"\n // Concatenate values __meta_kubernetes_pod_uid/__meta_kubernetes_pod_container_name.log\n rule {\n source_labels = [\"__meta_kubernetes_pod_uid\", \"__meta_kubernetes_pod_container_name\"]\n action = \"replace\"\n target_label = \"__path__\"\n separator = \"/\"\n replacement = \"/var/log/pods/*$1/*.log\"\n }\n\n // Label creation - \"container_runtime\" field from \"__meta_kubernetes_pod_container_id\"\n rule {\n source_labels = [\"__meta_kubernetes_pod_container_id\"]\n action = \"replace\"\n target_label = \"container_runtime\"\n regex = \"^(\\\\S+):\\\\/\\\\/.+$\"\n replacement = \"$1\"\n }\n}\n\n// loki.source.kubernetes tails logs from Kubernetes containers using the Kubernetes API.\nloki.source.kubernetes \"pod_logs\" {\n targets = discovery.relabel.pod_logs.output\n forward_to = [loki.process.pod_logs.receiver]\n}\n// loki.process receives log entries from other Loki components, applies one or more processing stages,\n// and forwards the results to the list of receivers in the component’s arguments.\nloki.process \"pod_logs\" {\n stage.static_labels {\n values = {\n cluster = \"envoy-gateway\",\n }\n }\n\n forward_to = [loki.write.alloy.receiver]\n}"</code></td><td></td></tr><tr><td>alloy.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>alloy.fullnameOverride</td><td>string</td><td><code>"alloy"</code></td><td></td></tr><tr><td>fluent-bit.config.filters</td><td>string</td><td><code>"[FILTER]\n Name kubernetes\n Match kube.*\n Merge_Log On\n Keep_Log Off\n K8S-Logging.Parser On\n K8S-Logging.Exclude On\n\n[FILTER]\n Name grep\n Match kube.*\n Regex $kubernetes['container_name'] ^envoy$\n\n[FILTER]\n Name parser\n Match kube.*\n Key_Name log\n Parser envoy\n Reserve_Data True\n"</code></td><td></td></tr><tr><td>fluent-bit.config.inputs</td><td>string</td><td><code>"[INPUT]\n Name tail\n Path /var/log/containers/*.log\n multiline.parser docker, cri\n Tag kube.*\n Mem_Buf_Limit 5MB\n Skip_Long_Lines On\n"</code></td><td></td></tr><tr><td>fluent-bit.config.outputs</td><td>string</td><td><code>"[OUTPUT]\n Name loki\n Match kube.*\n Host loki.monitoring.svc.cluster.local\n Port 3100\n Labels job=fluentbit, app=$kubernetes['labels']['app'], k8s_namespace_name=$kubernetes['namespace_name'], k8s_pod_name=$kubernetes['pod_name'], k8s_container_name=$kubernetes['container_name']\n"</code></td><td></td></tr><tr><td>fluent-bit.config.service</td><td>string</td><td><code>"[SERVICE]\n Daemon Off\n Flush {{ .Values.flush }}\n Log_Level {{ .Values.logLevel }}\n Parsers_File parsers.conf\n Parsers_File custom_parsers.conf\n HTTP_Server On\n HTTP_Listen 0.0.0.0\n HTTP_Port {{ .Values.metricsPort }}\n Health_Check On\n"</code></td><td></td></tr><tr><td>fluent-bit.enabled</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>fluent-bit.fullnameOverride</td><td>string</td><td><code>"fluent-bit"</code></td><td></td></tr><tr><td>fluent-bit.image.repository</td><td>string</td><td><code>"fluent/fluent-bit"</code></td><td></td></tr><tr><td>fluent-bit.podAnnotations.&ldquo;fluentbit.io/exclude&rdquo;</td><td>string</td><td><code>"true"</code></td><td></td></tr><tr><td>fluent-bit.podAnnotations.&ldquo;prometheus.io/path&rdquo;</td><td>string</td><td><code>"/api/v1/metrics/prometheus"</code></td><td></td></tr><tr><td>fluent-bit.podAnnotations.&ldquo;prometheus.io/port&rdquo;</td><td>string</td><td><code>"2020"</code></td><td></td></tr><tr><td>fluent-bit.podAnnotations.&ldquo;prometheus.io/scrape&rdquo;</td><td>string</td><td><code>"true"</code></td><td></td></tr><tr><td>fluent-bit.testFramework.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>grafana.adminPassword</td><td>string</td><td><code>"admin"</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.apiVersion</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].disableDeletion</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].editable</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].folder</td><td>string</td><td><code>"envoy-gateway"</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].name</td><td>string</td><td><code>"envoy-gateway"</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].options.path</td><td>string</td><td><code>"/var/lib/grafana/dashboards/envoy-gateway"</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].orgId</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>grafana.dashboardProviders.&ldquo;dashboardproviders.yaml&rdquo;.providers[0].type</td><td>string</td><td><code>"file"</code></td><td></td></tr><tr><td>grafana.dashboardsConfigMaps.envoy-gateway</td><td>string</td><td><code>"grafana-dashboards"</code></td><td></td></tr><tr><td>grafana.datasources.&ldquo;datasources.yaml&rdquo;.apiVersion</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>grafana.datasources.&ldquo;datasources.yaml&rdquo;.datasources[0].name</td><td>string</td><td><code>"Prometheus"</code></td><td></td></tr><tr><td>grafana.datasources.&ldquo;datasources.yaml&rdquo;.datasources[0].type</td><td>string</td><td><code>"prometheus"</code></td><td></td></tr><tr><td>grafana.datasources.&ldquo;datasources.yaml&rdquo;.datasources[0].url</td><td>string</td><td><code>"http://prometheus"</code></td><td></td></tr><tr><td>grafana.enabled</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>grafana.fullnameOverride</td><td>string</td><td><code>"grafana"</code></td><td></td></tr><tr><td>grafana.service.type</td><td>string</td><td><code>"LoadBalancer"</code></td><td></td></tr><tr><td>grafana.testFramework.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.backend.replicas</td><td>int</td><td><code>0</code></td><td></td></tr><tr><td>loki.deploymentMode</td><td>string</td><td><code>"SingleBinary"</code></td><td></td></tr><tr><td>loki.enabled</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>loki.fullnameOverride</td><td>string</td><td><code>"loki"</code></td><td></td></tr><tr><td>loki.gateway.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.loki.auth_enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.loki.commonConfig.replication_factor</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>loki.loki.compactorAddress</td><td>string</td><td><code>"loki"</code></td><td></td></tr><tr><td>loki.loki.memberlist</td><td>string</td><td><code>"loki-memberlist"</code></td><td></td></tr><tr><td>loki.loki.rulerConfig.storage.type</td><td>string</td><td><code>"local"</code></td><td></td></tr><tr><td>loki.loki.storage.type</td><td>string</td><td><code>"filesystem"</code></td><td></td></tr><tr><td>loki.monitoring.lokiCanary.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.monitoring.selfMonitoring.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.monitoring.selfMonitoring.grafanaAgent.installOperator</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.read.replicas</td><td>int</td><td><code>0</code></td><td></td></tr><tr><td>loki.singleBinary.replicas</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>loki.test.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>loki.write.replicas</td><td>int</td><td><code>0</code></td><td></td></tr><tr><td>opentelemetry-collector.config.exporters.debug.verbosity</td><td>string</td><td><code>"detailed"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.exporters.loki.endpoint</td><td>string</td><td><code>"http://loki.monitoring.svc:3100/loki/api/v1/push"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.exporters.otlp.endpoint</td><td>string</td><td><code>"tempo.monitoring.svc:4317"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.exporters.otlp.tls.insecure</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>opentelemetry-collector.config.exporters.prometheus.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:19001"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.extensions.health_check.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:13133"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.processors.attributes.actions[0].action</td><td>string</td><td><code>"insert"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.processors.attributes.actions[0].key</td><td>string</td><td><code>"loki.attribute.labels"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.processors.attributes.actions[0].value</td><td>string</td><td><code>"k8s.pod.name, k8s.namespace.name"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.datadog.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:8126"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.jaeger.protocols.grpc.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:14250"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.jaeger.protocols.thrift_compact.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:6831"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.jaeger.protocols.thrift_http.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:14268"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.otlp.protocols.grpc.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:4317"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.otlp.protocols.http.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:4318"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.prometheus.config.scrape_configs[0].job_name</td><td>string</td><td><code>"opentelemetry-collector"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.prometheus.config.scrape_configs[0].scrape_interval</td><td>string</td><td><code>"10s"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.prometheus.config.scrape_configs[0].static_configs[0].targets[0]</td><td>string</td><td><code>"[${env:MY_POD_IP}]:8888"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.receivers.zipkin.endpoint</td><td>string</td><td><code>"[${env:MY_POD_IP}]:9411"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.extensions[0]</td><td>string</td><td><code>"health_check"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.logs.exporters[0]</td><td>string</td><td><code>"loki"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.logs.processors[0]</td><td>string</td><td><code>"attributes"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.logs.receivers[0]</td><td>string</td><td><code>"otlp"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.metrics.exporters[0]</td><td>string</td><td><code>"prometheus"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.metrics.receivers[0]</td><td>string</td><td><code>"datadog"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.metrics.receivers[1]</td><td>string</td><td><code>"otlp"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.traces.exporters[0]</td><td>string</td><td><code>"otlp"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.traces.receivers[0]</td><td>string</td><td><code>"datadog"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.traces.receivers[1]</td><td>string</td><td><code>"otlp"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.pipelines.traces.receivers[2]</td><td>string</td><td><code>"zipkin"</code></td><td></td></tr><tr><td>opentelemetry-collector.config.service.telemetry.metrics.address</td><td>string</td><td><code>"[${env:MY_POD_IP}]:8888"</code></td><td></td></tr><tr><td>opentelemetry-collector.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>opentelemetry-collector.fullnameOverride</td><td>string</td><td><code>"otel-collector"</code></td><td></td></tr><tr><td>opentelemetry-collector.image.repository</td><td>string</td><td><code>"otel/opentelemetry-collector-contrib"</code></td><td></td></tr><tr><td>opentelemetry-collector.mode</td><td>string</td><td><code>"deployment"</code></td><td></td></tr><tr><td>prometheus.alertmanager.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>prometheus.enabled</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>prometheus.kube-state-metrics.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>prometheus.prometheus-node-exporter.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>prometheus.prometheus-pushgateway.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>prometheus.server.fullnameOverride</td><td>string</td><td><code>"prometheus"</code></td><td></td></tr><tr><td>prometheus.server.global.scrape_interval</td><td>string</td><td><code>"15s"</code></td><td></td></tr><tr><td>prometheus.server.image.repository</td><td>string</td><td><code>"prom/prometheus"</code></td><td></td></tr><tr><td>prometheus.server.persistentVolume.enabled</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>prometheus.server.readinessProbeInitialDelay</td><td>int</td><td><code>0</code></td><td></td></tr><tr><td>prometheus.server.securityContext</td><td>object</td><td><code>{}</code></td><td></td></tr><tr><td>prometheus.server.service.type</td><td>string</td><td><code>"LoadBalancer"</code></td><td></td></tr><tr><td>tempo.enabled</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>tempo.fullnameOverride</td><td>string</td><td><code>"tempo"</code></td><td></td></tr><tr><td>tempo.service.type</td><td>string</td><td><code>"LoadBalancer"</code></td><td></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-5c6ac3b4609685fd4926b3763a0b0787>3.6 - Gateway Helm Chart</h1><p><img alt="Version: v0.0.0-latest" src="https://img.shields.io/badge/Version-v0.0.0--latest-informational?style=flat-square"> <img alt="Type: application" src="https://img.shields.io/badge/Type-application-informational?style=flat-square"> <img alt="AppVersion: latest" src="https://img.shields.io/badge/AppVersion-latest-informational?style=flat-square"></p><p>The Helm chart for Envoy Gateway</p><p><strong>Homepage:</strong> <a href=https://gateway.envoyproxy.io/>https://gateway.envoyproxy.io/</a></p><h2 id=maintainers>Maintainers<a class=td-heading-self-link href=#maintainers aria-label="Heading self-link"></a></h2><table><thead><tr><th>Name</th><th>Email</th><th>Url</th></tr></thead><tbody><tr><td>envoy-gateway-steering-committee</td><td></td><td><a href=https://github.com/envoyproxy/gateway/blob/main/GOVERNANCE.md>https://github.com/envoyproxy/gateway/blob/main/GOVERNANCE.md</a></td></tr><tr><td>envoy-gateway-maintainers</td><td></td><td><a href=https://github.com/envoyproxy/gateway/blob/main/CODEOWNERS>https://github.com/envoyproxy/gateway/blob/main/CODEOWNERS</a></td></tr></tbody></table><h2 id=source-code>Source Code<a class=td-heading-self-link href=#source-code aria-label="Heading self-link"></a></h2><ul><li><a href=https://github.com/envoyproxy/gateway>https://github.com/envoyproxy/gateway</a></li></ul><h2 id=values>Values<a class=td-heading-self-link href=#values aria-label="Heading self-link"></a></h2><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>certgen</td><td>object</td><td><code>{"job":{"affinity":{},"annotations":{},"nodeSelector":{},"resources":{},"securityContext":{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"privileged":false,"readOnlyRootFilesystem":true,"runAsGroup":65534,"runAsNonRoot":true,"runAsUser":65534,"seccompProfile":{"type":"RuntimeDefault"}},"tolerations":[],"ttlSecondsAfterFinished":30},"rbac":{"annotations":{},"labels":{}}}</code></td><td>Certgen is used to generate the certificates required by EnvoyGateway. If you want to construct a custom certificate, you can generate a custom certificate through Cert-Manager before installing EnvoyGateway. Certgen will not overwrite the custom certificate. Please do not manually modify <code>values.yaml</code> to disable certgen, it may cause EnvoyGateway OIDC,OAuth2,etc. to not work as expected.</td></tr><tr><td>config.envoyGateway.gateway.controllerName</td><td>string</td><td><code>"gateway.envoyproxy.io/gatewayclass-controller"</code></td><td></td></tr><tr><td>config.envoyGateway.logging.level.default</td><td>string</td><td><code>"info"</code></td><td></td></tr><tr><td>config.envoyGateway.provider.type</td><td>string</td><td><code>"Kubernetes"</code></td><td></td></tr><tr><td>createNamespace</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>deployment.envoyGateway.image.repository</td><td>string</td><td><code>""</code></td><td></td></tr><tr><td>deployment.envoyGateway.image.tag</td><td>string</td><td><code>""</code></td><td></td></tr><tr><td>deployment.envoyGateway.imagePullPolicy</td><td>string</td><td><code>""</code></td><td></td></tr><tr><td>deployment.envoyGateway.imagePullSecrets</td><td>list</td><td><code>[]</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.limits.memory</td><td>string</td><td><code>"1024Mi"</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.requests.cpu</td><td>string</td><td><code>"100m"</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.requests.memory</td><td>string</td><td><code>"256Mi"</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.allowPrivilegeEscalation</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.capabilities.drop[0]</td><td>string</td><td><code>"ALL"</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.privileged</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.runAsGroup</td><td>int</td><td><code>65532</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.runAsNonRoot</td><td>bool</td><td><code>true</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.runAsUser</td><td>int</td><td><code>65532</code></td><td></td></tr><tr><td>deployment.envoyGateway.securityContext.seccompProfile.type</td><td>string</td><td><code>"RuntimeDefault"</code></td><td></td></tr><tr><td>deployment.pod.affinity</td><td>object</td><td><code>{}</code></td><td></td></tr><tr><td>deployment.pod.annotations.&ldquo;prometheus.io/port&rdquo;</td><td>string</td><td><code>"19001"</code></td><td></td></tr><tr><td>deployment.pod.annotations.&ldquo;prometheus.io/scrape&rdquo;</td><td>string</td><td><code>"true"</code></td><td></td></tr><tr><td>deployment.pod.labels</td><td>object</td><td><code>{}</code></td><td></td></tr><tr><td>deployment.pod.nodeSelector</td><td>object</td><td><code>{}</code></td><td></td></tr><tr><td>deployment.pod.tolerations</td><td>list</td><td><code>[]</code></td><td></td></tr><tr><td>deployment.pod.topologySpreadConstraints</td><td>list</td><td><code>[]</code></td><td></td></tr><tr><td>deployment.ports[0].name</td><td>string</td><td><code>"grpc"</code></td><td></td></tr><tr><td>deployment.ports[0].port</td><td>int</td><td><code>18000</code></td><td></td></tr><tr><td>deployment.ports[0].targetPort</td><td>int</td><td><code>18000</code></td><td></td></tr><tr><td>deployment.ports[1].name</td><td>string</td><td><code>"ratelimit"</code></td><td></td></tr><tr><td>deployment.ports[1].port</td><td>int</td><td><code>18001</code></td><td></td></tr><tr><td>deployment.ports[1].targetPort</td><td>int</td><td><code>18001</code></td><td></td></tr><tr><td>deployment.ports[2].name</td><td>string</td><td><code>"wasm"</code></td><td></td></tr><tr><td>deployment.ports[2].port</td><td>int</td><td><code>18002</code></td><td></td></tr><tr><td>deployment.ports[2].targetPort</td><td>int</td><td><code>18002</code></td><td></td></tr><tr><td>deployment.ports[3].name</td><td>string</td><td><code>"metrics"</code></td><td></td></tr><tr><td>deployment.ports[3].port</td><td>int</td><td><code>19001</code></td><td></td></tr><tr><td>deployment.ports[3].targetPort</td><td>int</td><td><code>19001</code></td><td></td></tr><tr><td>deployment.priorityClassName</td><td>string</td><td><code>nil</code></td><td></td></tr><tr><td>deployment.replicas</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>global.images.envoyGateway.image</td><td>string</td><td><code>nil</code></td><td></td></tr><tr><td>global.images.envoyGateway.pullPolicy</td><td>string</td><td><code>nil</code></td><td></td></tr><tr><td>global.images.envoyGateway.pullSecrets</td><td>list</td><td><code>[]</code></td><td></td></tr><tr><td>global.images.ratelimit.image</td><td>string</td><td><code>"docker.io/envoyproxy/ratelimit:master"</code></td><td></td></tr><tr><td>global.images.ratelimit.pullPolicy</td><td>string</td><td><code>"IfNotPresent"</code></td><td></td></tr><tr><td>global.images.ratelimit.pullSecrets</td><td>list</td><td><code>[]</code></td><td></td></tr><tr><td>kubernetesClusterDomain</td><td>string</td><td><code>"cluster.local"</code></td><td></td></tr><tr><td>podDisruptionBudget.minAvailable</td><td>int</td><td><code>0</code></td><td></td></tr><tr><td>service.annotations</td><td>object</td><td><code>{}</code></td><td></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-003eafaf9ca04a2c7e2916618060684a>3.7 - Migrating from Ingress Resources</h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Migrating from Ingress to Envoy Gateway involves converting existing Ingress resources into resources compatible with Envoy Gateway. The <code>ingress2gateway</code> tool simplifies this migration by transforming Ingress resources into Gateway API resources that Envoy Gateway can use. This guide will walk you through the prerequisites, installation of the <code>ingress2gateway</code> tool, and provide an example migration process.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Before you start the migration, ensure you have the following:</p><ol><li><strong>Envoy Gateway Installed</strong>: You need Envoy Gateway set up in your Kubernetes cluster. Follow the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/install/>Envoy Gateway installation guide</a> for details.</li><li><strong>Kubernetes Cluster Access</strong>: Ensure you have access to your Kubernetes cluster and necessary permissions to manage resources.</li><li><strong>Installation of <code>ingress2gateway</code> Tool</strong>: You need to install the <code>ingress2gateway</code> tool in your Kubernetes cluster and configure it accordingly. Follow the <a href=https://github.com/kubernetes-sigs/ingress2gateway/blob/main/README.md#installation>ingress2gateway tool installation guide</a> for details.</li></ol><h2 id=example-migration>Example Migration<a class=td-heading-self-link href=#example-migration aria-label="Heading self-link"></a></h2><p>Here’s a step-by-step example of migrating from Ingress to Envoy Gateway using <code>ingress2gateway</code>:</p><h3 id=1-install-and-configure-envoy-gateway>1. Install and Configure Envoy Gateway<a class=td-heading-self-link href=#1-install-and-configure-envoy-gateway aria-label="Heading self-link"></a></h3><p>Ensure that Envoy Gateway is installed and running in your cluster. Follow the <a href=/eg-pr-preview/5-test-docs-preview/v1.2/install/>official Envoy Gateway installation guide</a> for setup instructions.</p><h3 id=2-create-a-gatewayclass>2. Create a GatewayClass<a class=td-heading-self-link href=#2-create-a-gatewayclass aria-label="Heading self-link"></a></h3><p>To ensure the generated HTTPRoutes are programmed correctly in the Envoy Gateway data plane, create a GatewayClass that links to the Envoy Gateway controller.</p><p>Create a <code>GatewayClass</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-class</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Apply this resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f gatewayclass.yaml
</span></span></code></pre></div><h3 id=3-install-ingress2gateway>3. Install Ingress2gateway<a class=td-heading-self-link href=#3-install-ingress2gateway aria-label="Heading self-link"></a></h3><p>Ensure you have the Ingress2gateway package installed. If not, follow the package’s installation instructions.</p><h3 id=4-run-ingress2gateway>4. Run Ingress2gateway<a class=td-heading-self-link href=#4-run-ingress2gateway aria-label="Heading self-link"></a></h3><p>Use Ingress2gateway to read your existing Ingress resources and translate them into Gateway API resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./ingress2gateway print
</span></span></code></pre></div><p>This command will:</p><ol><li>Read your Kube config file to extract the cluster credentials and the current active namespace.</li><li>Search for Ingress and provider-specific resources in that namespace.</li><li>Convert them to Gateway API resources (Gateways and HTTPRoutes).</li></ol><h4 id=example-ingress-configuration>Example Ingress Configuration<a class=td-heading-self-link href=#example-ingress-configuration aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ingress</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-ingress</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/rewrite-target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>paths</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pathType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Prefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backend</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo-service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>number</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=5-save-the-output>5. Save the Output<a class=td-heading-self-link href=#5-save-the-output aria-label="Heading self-link"></a></h3><p>The command will output the equivalent Gateway API resources in YAML/JSON format to stdout. Save this output to a file for further use.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./ingress2gateway print &gt; gateway-resources.yaml
</span></span></code></pre></div><h3 id=6-apply-the-translated-resources>6. Apply the Translated Resources<a class=td-heading-self-link href=#6-apply-the-translated-resources aria-label="Heading self-link"></a></h3><p>Apply the translated Gateway API resources to your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f gateway-resources.yaml
</span></span></code></pre></div><h3 id=7-create-a-gateway-resource>7. Create a Gateway Resource<a class=td-heading-self-link href=#7-create-a-gateway-resource aria-label="Heading self-link"></a></h3><p>Create a <code>Gateway</code> resource specifying the <code>GatewayClass</code> created earlier and including the necessary listeners.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-class</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Apply this resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f gateway.yaml
</span></span></code></pre></div><h3 id=8-validate-the-migration>8. Validate the Migration<a class=td-heading-self-link href=#8-validate-the-migration aria-label="Heading self-link"></a></h3><p>Ensure the HTTPRoutes and Gateways are correctly set up and that traffic is being routed as expected. Validate the new configuration by checking the status of the Gateway and HTTPRoute resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get gateways
</span></span><span style=display:flex><span>kubectl get httproutes
</span></span></code></pre></div><h3 id=9-monitor-and-troubleshoot>9. Monitor and Troubleshoot<a class=td-heading-self-link href=#9-monitor-and-troubleshoot aria-label="Heading self-link"></a></h3><p>Monitor the Envoy Gateway logs and metrics to ensure everything is functioning correctly. Troubleshoot any issues by reviewing the Gateway and HTTPRoute statuses and Envoy Gateway controller logs.</p><h2 id=summary>Summary<a class=td-heading-self-link href=#summary aria-label="Heading self-link"></a></h2><p>By following this guide, users can effectively migrate their existing Ingress resources to Envoy Gateway using the Ingress2gateway package. Creating a GatewayClass and linking it to the Envoy Gateway controller ensures that the translated resources are properly programmed in the data plane, providing a seamless transition to the Envoy Gateway environment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e816e595aac1a27dc48b7c13d7b3f2cd>4 - API</h1><div class=lead>This section includes APIs of Envoy Gateway.</div></div><div class=td-content><h1 id=pg-ff9bd458db8f40d8bddd9f100b655f05>4.1 - API Reference</h1><h2 id=packages>Packages<a class=td-heading-self-link href=#packages aria-label="Heading self-link"></a></h2><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#gatewayenvoyproxyiov1alpha1>gateway.envoyproxy.io/v1alpha1</a></li></ul><h2 id=gatewayenvoyproxyiov1alpha1>gateway.envoyproxy.io/v1alpha1<a class=td-heading-self-link href=#gatewayenvoyproxyiov1alpha1 aria-label="Heading self-link"></a></h2><p>Package v1alpha1 contains API schema definitions for the gateway.envoyproxy.io
API group.</p><h3 id=resource-types>Resource Types<a class=td-heading-self-link href=#resource-types aria-label="Heading self-link"></a></h3><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backend>Backend</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicy>BackendTrafficPolicy</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicy>ClientTrafficPolicy</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicy>EnvoyExtensionPolicy</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchpolicy>EnvoyPatchPolicy</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httproutefilter>HTTPRouteFilter</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicy>SecurityPolicy</a></li></ul><h4 id=alpnprotocol>ALPNProtocol<a class=td-heading-self-link href=#alpnprotocol aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ALPNProtocol specifies the protocol to be negotiated using ALPN</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtlsconfig>BackendTLSConfig</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttlssettings>ClientTLSSettings</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlssettings>TLSSettings</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>http/1.0</code></td><td>HTTPProtocolVersion1_0 specifies that HTTP/1.0 should be negotiable with ALPN<br></td></tr><tr><td><code>http/1.1</code></td><td>HTTPProtocolVersion1_1 specifies that HTTP/1.1 should be negotiable with ALPN<br></td></tr><tr><td><code>h2</code></td><td>HTTPProtocolVersion2 specifies that HTTP/2 should be negotiable with ALPN<br></td></tr></tbody></table><h4 id=alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog<a class=td-heading-self-link href=#alsenvoyproxyaccesslog aria-label="Heading self-link"></a></h4><p>ALSEnvoyProxyAccessLog defines the gRPC Access Log Service (ALS) sink.
The service must implement the Envoy gRPC Access Log Service streaming API:
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/accesslog/v3/als.proto>https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/accesslog/v3/als.proto</a>
Access log format information is passed in the form of gRPC metadata when the
stream is established. Specifically, the following metadata is passed:</p><ul><li><code>x-accesslog-text</code> - The access log format string when a Text format is used.</li><li><code>x-accesslog-attr</code> - JSON encoded key/value pairs when a JSON format is used.</li></ul><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>logName</code></td><td><em>string</em></td><td>false</td><td>LogName defines the friendly name of the access log to be returned in<br>StreamAccessLogsMessage.Identifier. This allows the access log server<br>to differentiate between different access logs coming from the same Envoy.</td></tr><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslogtype>ALSEnvoyProxyAccessLogType</a></em></td><td>true</td><td>Type defines the type of accesslog. Supported types are &ldquo;HTTP&rdquo; and &ldquo;TCP&rdquo;.</td></tr><tr><td><code>http</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyhttpaccesslogconfig>ALSEnvoyProxyHTTPAccessLogConfig</a></em></td><td>false</td><td>HTTP defines additional configuration specific to HTTP access logs.</td></tr></tbody></table><h4 id=alsenvoyproxyaccesslogtype>ALSEnvoyProxyAccessLogType<a class=td-heading-self-link href=#alsenvoyproxyaccesslogtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>HTTP</code></td><td>ALSEnvoyProxyAccessLogTypeHTTP defines the HTTP access log type and will populate StreamAccessLogsMessage.http_logs.<br></td></tr><tr><td><code>TCP</code></td><td>ALSEnvoyProxyAccessLogTypeTCP defines the TCP access log type and will populate StreamAccessLogsMessage.tcp_logs.<br></td></tr></tbody></table><h4 id=alsenvoyproxyhttpaccesslogconfig>ALSEnvoyProxyHTTPAccessLogConfig<a class=td-heading-self-link href=#alsenvoyproxyhttpaccesslogconfig aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>requestHeaders</code></td><td><em>string array</em></td><td>false</td><td>RequestHeaders defines request headers to include in log entries sent to the access log service.</td></tr><tr><td><code>responseHeaders</code></td><td><em>string array</em></td><td>false</td><td>ResponseHeaders defines response headers to include in log entries sent to the access log service.</td></tr><tr><td><code>responseTrailers</code></td><td><em>string array</em></td><td>false</td><td>ResponseTrailers defines response trailers to include in log entries sent to the access log service.</td></tr></tbody></table><h4 id=activehealthcheck>ActiveHealthCheck<a class=td-heading-self-link href=#activehealthcheck aria-label="Heading self-link"></a></h4><p>ActiveHealthCheck defines the active health check configuration.
EG supports various types of active health checking including HTTP, TCP.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#healthcheck>HealthCheck</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>timeout</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>Timeout defines the time to wait for a health check response.</td></tr><tr><td><code>interval</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>Interval defines the time between active health checks.</td></tr><tr><td><code>unhealthyThreshold</code></td><td><em>integer</em></td><td>false</td><td>UnhealthyThreshold defines the number of unhealthy health checks required before a backend host is marked unhealthy.</td></tr><tr><td><code>healthyThreshold</code></td><td><em>integer</em></td><td>false</td><td>HealthyThreshold defines the number of healthy health checks required before a backend host is marked healthy.</td></tr><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheckertype>ActiveHealthCheckerType</a></em></td><td>true</td><td>Type defines the type of health checker.</td></tr><tr><td><code>http</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpactivehealthchecker>HTTPActiveHealthChecker</a></em></td><td>false</td><td>HTTP defines the configuration of http health checker.<br>It&rsquo;s required while the health checker type is HTTP.</td></tr><tr><td><code>tcp</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcpactivehealthchecker>TCPActiveHealthChecker</a></em></td><td>false</td><td>TCP defines the configuration of tcp health checker.<br>It&rsquo;s required while the health checker type is TCP.</td></tr><tr><td><code>grpc</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#grpcactivehealthchecker>GRPCActiveHealthChecker</a></em></td><td>false</td><td>GRPC defines the configuration of the GRPC health checker.<br>It&rsquo;s optional, and can only be used if the specified type is GRPC.</td></tr></tbody></table><h4 id=activehealthcheckpayload>ActiveHealthCheckPayload<a class=td-heading-self-link href=#activehealthcheckpayload aria-label="Heading self-link"></a></h4><p>ActiveHealthCheckPayload defines the encoding of the payload bytes in the payload.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpactivehealthchecker>HTTPActiveHealthChecker</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcpactivehealthchecker>TCPActiveHealthChecker</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheckpayloadtype>ActiveHealthCheckPayloadType</a></em></td><td>true</td><td>Type defines the type of the payload.</td></tr><tr><td><code>text</code></td><td><em>string</em></td><td>false</td><td>Text payload in plain text.</td></tr><tr><td><code>binary</code></td><td><em>integer array</em></td><td>false</td><td>Binary payload base64 encoded.</td></tr></tbody></table><h4 id=activehealthcheckpayloadtype>ActiveHealthCheckPayloadType<a class=td-heading-self-link href=#activehealthcheckpayloadtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ActiveHealthCheckPayloadType is the type of the payload.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheckpayload>ActiveHealthCheckPayload</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Text</code></td><td>ActiveHealthCheckPayloadTypeText defines the Text type payload.<br></td></tr><tr><td><code>Binary</code></td><td>ActiveHealthCheckPayloadTypeBinary defines the Binary type payload.<br></td></tr></tbody></table><h4 id=activehealthcheckertype>ActiveHealthCheckerType<a class=td-heading-self-link href=#activehealthcheckertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ActiveHealthCheckerType is the type of health checker.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheck>ActiveHealthCheck</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>HTTP</code></td><td>ActiveHealthCheckerTypeHTTP defines the HTTP type of health checking.<br></td></tr><tr><td><code>TCP</code></td><td>ActiveHealthCheckerTypeTCP defines the TCP type of health checking.<br></td></tr><tr><td><code>GRPC</code></td><td>ActiveHealthCheckerTypeGRPC defines the GRPC type of health checking.<br></td></tr></tbody></table><h4 id=appprotocoltype>AppProtocolType<a class=td-heading-self-link href=#appprotocoltype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>AppProtocolType defines various backend applications protocols supported by Envoy Gateway</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendspec>BackendSpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>gateway.envoyproxy.io/h2c</code></td><td>AppProtocolTypeH2C defines the HTTP/2 application protocol.<br></td></tr><tr><td><code>gateway.envoyproxy.io/ws</code></td><td>AppProtocolTypeWS defines the WebSocket over HTTP protocol.<br></td></tr><tr><td><code>gateway.envoyproxy.io/wss</code></td><td>AppProtocolTypeWSS defines the WebSocket over HTTPS protocol.<br></td></tr></tbody></table><h4 id=authorization>Authorization<a class=td-heading-self-link href=#authorization aria-label="Heading self-link"></a></h4><p>Authorization defines the authorization configuration.</p><p>Note: if neither <code>Rules</code> nor <code>DefaultAction</code> is specified, the default action is to deny all requests.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>rules</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorizationrule>AuthorizationRule</a> array</em></td><td>false</td><td>Rules defines a list of authorization rules.<br>These rules are evaluated in order, the first matching rule will be applied,<br>and the rest will be skipped.<br><br>For example, if there are two rules: the first rule allows the request<br>and the second rule denies it, when a request matches both rules, it will be allowed.</td></tr><tr><td><code>defaultAction</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorizationaction>AuthorizationAction</a></em></td><td>false</td><td>DefaultAction defines the default action to be taken if no rules match.<br>If not specified, the default action is Deny.</td></tr></tbody></table><h4 id=authorizationaction>AuthorizationAction<a class=td-heading-self-link href=#authorizationaction aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>AuthorizationAction defines the action to be taken if a rule matches.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorization>Authorization</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorizationrule>AuthorizationRule</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Allow</code></td><td>AuthorizationActionAllow is the action to allow the request.<br></td></tr><tr><td><code>Deny</code></td><td>AuthorizationActionDeny is the action to deny the request.<br></td></tr></tbody></table><h4 id=authorizationrule>AuthorizationRule<a class=td-heading-self-link href=#authorizationrule aria-label="Heading self-link"></a></h4><p>AuthorizationRule defines a single authorization rule.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorization>Authorization</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>false</td><td>Name is a user-friendly name for the rule.<br>If not specified, Envoy Gateway will generate a unique name for the rule.</td></tr><tr><td><code>action</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorizationaction>AuthorizationAction</a></em></td><td>true</td><td>Action defines the action to be taken if the rule matches.</td></tr><tr><td><code>principal</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#principal>Principal</a></em></td><td>true</td><td>Principal specifies the client identity of a request.<br>If there are multiple principal types, all principals must match for the rule to match.<br>For example, if there are two principals: one for client IP and one for JWT claim,<br>the rule will match only if both the client IP and the JWT claim match.</td></tr></tbody></table><h4 id=backoffpolicy>BackOffPolicy<a class=td-heading-self-link href=#backoffpolicy aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#perretrypolicy>PerRetryPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>baseInterval</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>true</td><td>BaseInterval is the base interval between retries.</td></tr><tr><td><code>maxInterval</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>MaxInterval is the maximum interval between retries. This parameter is optional, but must be greater than or equal to the base_interval if set.<br>The default is 10 times the base_interval</td></tr></tbody></table><h4 id=backend>Backend<a class=td-heading-self-link href=#backend aria-label="Heading self-link"></a></h4><p>Backend allows the user to configure the endpoints of a backend and
the behavior of the connection from Envoy Proxy to the backend.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>Backend</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendspec>BackendSpec</a></em></td><td>true</td><td>Spec defines the desired state of Backend.</td></tr><tr><td><code>status</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendstatus>BackendStatus</a></em></td><td>true</td><td>Status defines the current status of Backend.</td></tr></tbody></table><h4 id=backendcluster>BackendCluster<a class=td-heading-self-link href=#backendcluster aria-label="Heading self-link"></a></h4><p>BackendCluster contains all the configuration required for configuring access
to a backend. This can include multiple endpoints, and settings that apply for
managing the connection to all these endpoints.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extproc>ExtProc</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#grpcextauthservice>GRPCExtAuthService</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpextauthservice>HTTPExtAuthService</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidcprovider>OIDCProvider</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyopentelemetrysink>ProxyOpenTelemetrySink</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovider>TracingProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr></tbody></table><h4 id=backendconnection>BackendConnection<a class=td-heading-self-link href=#backendconnection aria-label="Heading self-link"></a></h4><p>BackendConnection allows users to configure connection-level settings of backend</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>bufferLimit</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#quantity-resource-api>Quantity</a></em></td><td>false</td><td>BufferLimit Soft limit on size of the cluster’s connections read and write buffers.<br>BufferLimit applies to connection streaming (maybe non-streaming) channel between processes, it&rsquo;s in user space.<br>If unspecified, an implementation defined default is applied (32768 bytes).<br>For example, 20Mi, 1Gi, 256Ki etc.<br>Note: that when the suffix is not provided, the value is interpreted as bytes.</td></tr></tbody></table><h4 id=backendendpoint>BackendEndpoint<a class=td-heading-self-link href=#backendendpoint aria-label="Heading self-link"></a></h4><p>BackendEndpoint describes a backend endpoint, which can be either a fully-qualified domain name, IP address or unix domain socket
corresponding to Envoy&rsquo;s Address: <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-address>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-address</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendspec>BackendSpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionservice>ExtensionService</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>fqdn</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#fqdnendpoint>FQDNEndpoint</a></em></td><td>false</td><td>FQDN defines a FQDN endpoint</td></tr><tr><td><code>ip</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ipendpoint>IPEndpoint</a></em></td><td>false</td><td>IP defines an IP endpoint. Supports both IPv4 and IPv6 addresses.</td></tr><tr><td><code>unix</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#unixsocket>UnixSocket</a></em></td><td>false</td><td>Unix defines the unix domain socket endpoint</td></tr></tbody></table><h4 id=backendref>BackendRef<a class=td-heading-self-link href=#backendref aria-label="Heading self-link"></a></h4><p>BackendRef defines how an ObjectReference that is specific to BackendRef.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendcluster>BackendCluster</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extproc>ExtProc</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#grpcextauthservice>GRPCExtAuthService</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpextauthservice>HTTPExtAuthService</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidcprovider>OIDCProvider</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyopentelemetrysink>ProxyOpenTelemetrySink</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovider>TracingProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>group</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#group>Group</a></em></td><td>false</td><td>Group is the group of the referent. For example, &ldquo;gateway.networking.k8s.io&rdquo;.<br>When unspecified or empty string, core API group is inferred.</td></tr><tr><td><code>kind</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kind>Kind</a></em></td><td>false</td><td>Kind is the Kubernetes resource kind of the referent. For example<br>&ldquo;Service&rdquo;.<br><br>Defaults to &ldquo;Service&rdquo; when not specified.<br><br>ExternalName services can refer to CNAME DNS records that may live<br>outside of the cluster and as such are difficult to reason about in<br>terms of conformance. They also may not be safe to forward to (see<br>CVE-2021-25740 for more information). Implementations SHOULD NOT<br>support ExternalName Services.<br><br>Support: Core (Services with a type other than ExternalName)<br><br>Support: Implementation-specific (Services with type ExternalName)</td></tr><tr><td><code>name</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#objectname>ObjectName</a></em></td><td>true</td><td>Name is the name of the referent.</td></tr><tr><td><code>namespace</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#namespace>Namespace</a></em></td><td>false</td><td>Namespace is the namespace of the backend. When unspecified, the local<br>namespace is inferred.<br><br>Note that when a namespace different than the local namespace is specified,<br>a ReferenceGrant object is required in the referent namespace to allow that<br>namespace&rsquo;s owner to accept the reference. See the ReferenceGrant<br>documentation for details.<br><br>Support: Core</td></tr><tr><td><code>port</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#portnumber>PortNumber</a></em></td><td>false</td><td>Port specifies the destination port number to use for this resource.<br>Port is required when the referent is a Kubernetes Service. In this<br>case, the port number is the service port number, not the target port.<br>For other resources, destination port might be derived from the referent<br>resource or this field.</td></tr><tr><td><code>fallback</code></td><td><em>boolean</em></td><td>false</td><td>Fallback indicates whether the backend is designated as a fallback.<br>Multiple fallback backends can be configured.<br>It is highly recommended to configure active or passive health checks to ensure that failover can be detected<br>when the active backends become unhealthy and to automatically readjust once the primary backends are healthy again.<br>The overprovisioning factor is set to 1.4, meaning the fallback backends will only start receiving traffic when<br>the health of the active backends falls below 72%.</td></tr></tbody></table><h4 id=backendspec>BackendSpec<a class=td-heading-self-link href=#backendspec aria-label="Heading self-link"></a></h4><p>BackendSpec describes the desired state of BackendSpec.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backend>Backend</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>endpoints</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendendpoint>BackendEndpoint</a> array</em></td><td>true</td><td>Endpoints defines the endpoints to be used when connecting to the backend.</td></tr><tr><td><code>appProtocols</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#appprotocoltype>AppProtocolType</a> array</em></td><td>false</td><td>AppProtocols defines the application protocols to be supported when connecting to the backend.</td></tr><tr><td><code>fallback</code></td><td><em>boolean</em></td><td>false</td><td>Fallback indicates whether the backend is designated as a fallback.<br>It is highly recommended to configure active or passive health checks to ensure that failover can be detected<br>when the active backends become unhealthy and to automatically readjust once the primary backends are healthy again.<br>The overprovisioning factor is set to 1.4, meaning the fallback backends will only start receiving traffic when<br>the health of the active backends falls below 72%.</td></tr></tbody></table><h4 id=backendstatus>BackendStatus<a class=td-heading-self-link href=#backendstatus aria-label="Heading self-link"></a></h4><p>BackendStatus defines the state of Backend</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backend>Backend</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>conditions</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#condition-v1-meta>Condition</a> array</em></td><td>false</td><td>Conditions describe the current conditions of the Backend.</td></tr></tbody></table><h4 id=backendtlsconfig>BackendTLSConfig<a class=td-heading-self-link href=#backendtlsconfig aria-label="Heading self-link"></a></h4><p>BackendTLSConfig describes the BackendTLS configuration for Envoy Proxy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>clientCertificateRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a></em></td><td>false</td><td>ClientCertificateRef defines the reference to a Kubernetes Secret that contains<br>the client certificate and private key for Envoy to use when connecting to<br>backend services and external services, such as ExtAuth, ALS, OpenTelemetry, etc.<br>This secret should be located within the same namespace as the Envoy proxy resource that references it.</td></tr><tr><td><code>minVersion</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlsversion>TLSVersion</a></em></td><td>false</td><td>Min specifies the minimal TLS protocol version to allow.<br>The default is TLS 1.2 if this is not specified.</td></tr><tr><td><code>maxVersion</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlsversion>TLSVersion</a></em></td><td>false</td><td>Max specifies the maximal TLS protocol version to allow<br>The default is TLS 1.3 if this is not specified.</td></tr><tr><td><code>ciphers</code></td><td><em>string array</em></td><td>false</td><td>Ciphers specifies the set of cipher suites supported when<br>negotiating TLS 1.0 - 1.2. This setting has no effect for TLS 1.3.<br>In non-FIPS Envoy Proxy builds the default cipher list is:<br>- [ECDHE-ECDSA-AES128-GCM-SHA256|ECDHE-ECDSA-CHACHA20-POLY1305]<br>- [ECDHE-RSA-AES128-GCM-SHA256|ECDHE-RSA-CHACHA20-POLY1305]<br>- ECDHE-ECDSA-AES256-GCM-SHA384<br>- ECDHE-RSA-AES256-GCM-SHA384<br>In builds using BoringSSL FIPS the default cipher list is:<br>- ECDHE-ECDSA-AES128-GCM-SHA256<br>- ECDHE-RSA-AES128-GCM-SHA256<br>- ECDHE-ECDSA-AES256-GCM-SHA384<br>- ECDHE-RSA-AES256-GCM-SHA384</td></tr><tr><td><code>ecdhCurves</code></td><td><em>string array</em></td><td>false</td><td>ECDHCurves specifies the set of supported ECDH curves.<br>In non-FIPS Envoy Proxy builds the default curves are:<br>- X25519<br>- P-256<br>In builds using BoringSSL FIPS the default curve is:<br>- P-256</td></tr><tr><td><code>signatureAlgorithms</code></td><td><em>string array</em></td><td>false</td><td>SignatureAlgorithms specifies which signature algorithms the listener should<br>support.</td></tr><tr><td><code>alpnProtocols</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alpnprotocol>ALPNProtocol</a> array</em></td><td>false</td><td>ALPNProtocols supplies the list of ALPN protocols that should be<br>exposed by the listener. By default h2 and http/1.1 are enabled.<br>Supported values are:<br>- http/1.0<br>- http/1.1<br>- h2</td></tr></tbody></table><h4 id=backendtrafficpolicy>BackendTrafficPolicy<a class=td-heading-self-link href=#backendtrafficpolicy aria-label="Heading self-link"></a></h4><p>BackendTrafficPolicy allows the user to configure the behavior of the connection
between the Envoy Proxy listener and the backend service.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>BackendTrafficPolicy</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></em></td><td>true</td><td>spec defines the desired state of BackendTrafficPolicy.</td></tr><tr><td><code>status</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.PolicyStatus>PolicyStatus</a></em></td><td>true</td><td>status defines the current status of BackendTrafficPolicy.</td></tr></tbody></table><h4 id=backendtrafficpolicyspec>BackendTrafficPolicySpec<a class=td-heading-self-link href=#backendtrafficpolicyspec aria-label="Heading self-link"></a></h4><p>BackendTrafficPolicySpec defines the desired state of BackendTrafficPolicy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicy>BackendTrafficPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>targetRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a></em></td><td>true</td><td>TargetRef is the name of the resource this policy is being attached to.<br>This policy and the TargetRef MUST be in the same namespace for this<br>Policy to have effect<br><br>Deprecated: use targetRefs/targetSelectors instead</td></tr><tr><td><code>targetRefs</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a> array</em></td><td>true</td><td>TargetRefs are the names of the Gateway resources this policy<br>is being attached to.</td></tr><tr><td><code>targetSelectors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#targetselector>TargetSelector</a> array</em></td><td>true</td><td>TargetSelectors allow targeting resources for this policy based on labels</td></tr><tr><td><code>loadBalancer</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loadbalancer>LoadBalancer</a></em></td><td>false</td><td>LoadBalancer policy to apply when routing traffic from the gateway to<br>the backend endpoints. Defaults to <code>LeastRequest</code>.</td></tr><tr><td><code>retry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retry>Retry</a></em></td><td>false</td><td>Retry provides more advanced usage, allowing users to customize the number of retries, retry fallback strategy, and retry triggering conditions.<br>If not set, retry will be disabled.</td></tr><tr><td><code>proxyProtocol</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyprotocol>ProxyProtocol</a></em></td><td>false</td><td>ProxyProtocol enables the Proxy Protocol when communicating with the backend.</td></tr><tr><td><code>tcpKeepalive</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcpkeepalive>TCPKeepalive</a></em></td><td>false</td><td>TcpKeepalive settings associated with the upstream client connection.<br>Disabled by default.</td></tr><tr><td><code>healthCheck</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#healthcheck>HealthCheck</a></em></td><td>false</td><td>HealthCheck allows gateway to perform active health checking on backends.</td></tr><tr><td><code>circuitBreaker</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#circuitbreaker>CircuitBreaker</a></em></td><td>false</td><td>Circuit Breaker settings for the upstream connections and requests.<br>If not set, circuit breakers will be enabled with the default thresholds</td></tr><tr><td><code>timeout</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#timeout>Timeout</a></em></td><td>false</td><td>Timeout settings for the backend connections.</td></tr><tr><td><code>connection</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendconnection>BackendConnection</a></em></td><td>false</td><td>Connection includes backend connection settings.</td></tr><tr><td><code>dns</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#dns>DNS</a></em></td><td>false</td><td>DNS includes dns resolution settings.</td></tr><tr><td><code>http2</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http2settings>HTTP2Settings</a></em></td><td>false</td><td>HTTP2 provides HTTP/2 configuration for backend connections.</td></tr><tr><td><code>rateLimit</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitspec>RateLimitSpec</a></em></td><td>false</td><td>RateLimit allows the user to limit the number of incoming requests<br>to a predefined value based on attributes within the traffic flow.</td></tr><tr><td><code>faultInjection</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#faultinjection>FaultInjection</a></em></td><td>false</td><td>FaultInjection defines the fault injection policy to be applied. This configuration can be used to<br>inject delays and abort requests to mimic failure scenarios such as service failures and overloads</td></tr><tr><td><code>useClientProtocol</code></td><td><em>boolean</em></td><td>false</td><td>UseClientProtocol configures Envoy to prefer sending requests to backends using<br>the same HTTP protocol that the incoming request used. Defaults to false, which means<br>that Envoy will use the protocol indicated by the attached BackendRef.</td></tr><tr><td><code>responseOverride</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#responseoverride>ResponseOverride</a> array</em></td><td>false</td><td>ResponseOverride defines the configuration to override specific responses with a custom one.<br>If multiple configurations are specified, the first one to match wins.</td></tr></tbody></table><h4 id=basicauth>BasicAuth<a class=td-heading-self-link href=#basicauth aria-label="Heading self-link"></a></h4><p>BasicAuth defines the configuration for the HTTP Basic Authentication.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>users</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a></em></td><td>true</td><td>The Kubernetes secret which contains the username-password pairs in<br>htpasswd format, used to verify user credentials in the &ldquo;Authorization&rdquo;<br>header.<br><br>This is an Opaque secret. The username-password pairs should be stored in<br>the key &ldquo;.htpasswd&rdquo;. As the key name indicates, the value needs to be the<br>htpasswd format, for example: &ldquo;user1:{SHA}hashed_user1_password&rdquo;.<br>Right now, only SHA hash algorithm is supported.<br>Reference to <a href=https://httpd.apache.org/docs/2.4/programs/htpasswd.html>https://httpd.apache.org/docs/2.4/programs/htpasswd.html</a><br>for more details.<br><br>Note: The secret must be in the same namespace as the SecurityPolicy.</td></tr></tbody></table><h4 id=bootstraptype>BootstrapType<a class=td-heading-self-link href=#bootstraptype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>BootstrapType defines the types of bootstrap supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxybootstrap>ProxyBootstrap</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Merge</code></td><td>Merge merges the provided bootstrap with the default one. The provided bootstrap can add or override a value<br>within a map, or add a new value to a list.<br>Please note that the provided bootstrap can&rsquo;t override a value within a list.<br></td></tr><tr><td><code>Replace</code></td><td>Replace replaces the default bootstrap with the provided one.<br></td></tr><tr><td><code>JSONPatch</code></td><td>JSONPatch applies the provided JSONPatches to the default bootstrap.<br></td></tr></tbody></table><h4 id=cidr>CIDR<a class=td-heading-self-link href=#cidr aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>CIDR defines a CIDR Address range.
A CIDR can be an IPv4 address range such as &ldquo;192.168.1.0/24&rdquo; or an IPv6 address range such as &ldquo;2001:0db8:11a3:09d7::/64&rdquo;.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#principal>Principal</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xforwardedforsettings>XForwardedForSettings</a></li></ul><h4 id=cors>CORS<a class=td-heading-self-link href=#cors aria-label="Heading self-link"></a></h4><p>CORS defines the configuration for Cross-Origin Resource Sharing (CORS).</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>allowOrigins</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#origin>Origin</a> array</em></td><td>false</td><td>AllowOrigins defines the origins that are allowed to make requests.<br>It specifies the allowed origins in the Access-Control-Allow-Origin CORS response header.<br>The value &ldquo;*&rdquo; allows any origin to make requests.</td></tr><tr><td><code>allowMethods</code></td><td><em>string array</em></td><td>false</td><td>AllowMethods defines the methods that are allowed to make requests.<br>It specifies the allowed methods in the Access-Control-Allow-Methods CORS response header..<br>The value &ldquo;*&rdquo; allows any method to be used.</td></tr><tr><td><code>allowHeaders</code></td><td><em>string array</em></td><td>false</td><td>AllowHeaders defines the headers that are allowed to be sent with requests.<br>It specifies the allowed headers in the Access-Control-Allow-Headers CORS response header..<br>The value &ldquo;*&rdquo; allows any header to be sent.</td></tr><tr><td><code>exposeHeaders</code></td><td><em>string array</em></td><td>false</td><td>ExposeHeaders defines which response headers should be made accessible to<br>scripts running in the browser.<br>It specifies the headers in the Access-Control-Expose-Headers CORS response header..<br>The value &ldquo;*&rdquo; allows any header to be exposed.</td></tr><tr><td><code>maxAge</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>MaxAge defines how long the results of a preflight request can be cached.<br>It specifies the value in the Access-Control-Max-Age CORS response header..</td></tr><tr><td><code>allowCredentials</code></td><td><em>boolean</em></td><td>false</td><td>AllowCredentials indicates whether a request can include user credentials<br>like cookies, authentication headers, or TLS client certificates.<br>It specifies the value in the Access-Control-Allow-Credentials CORS response header.</td></tr></tbody></table><h4 id=circuitbreaker>CircuitBreaker<a class=td-heading-self-link href=#circuitbreaker aria-label="Heading self-link"></a></h4><p>CircuitBreaker defines the Circuit Breaker configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>maxConnections</code></td><td><em>integer</em></td><td>false</td><td>The maximum number of connections that Envoy will establish to the referenced backend defined within a xRoute rule.</td></tr><tr><td><code>maxPendingRequests</code></td><td><em>integer</em></td><td>false</td><td>The maximum number of pending requests that Envoy will queue to the referenced backend defined within a xRoute rule.</td></tr><tr><td><code>maxParallelRequests</code></td><td><em>integer</em></td><td>false</td><td>The maximum number of parallel requests that Envoy will make to the referenced backend defined within a xRoute rule.</td></tr><tr><td><code>maxParallelRetries</code></td><td><em>integer</em></td><td>false</td><td>The maximum number of parallel retries that Envoy will make to the referenced backend defined within a xRoute rule.</td></tr><tr><td><code>maxRequestsPerConnection</code></td><td><em>integer</em></td><td>false</td><td>The maximum number of requests that Envoy will make over a single connection to the referenced backend defined within a xRoute rule.<br>Default: unlimited.</td></tr></tbody></table><h4 id=claimtoheader>ClaimToHeader<a class=td-heading-self-link href=#claimtoheader aria-label="Heading self-link"></a></h4><p>ClaimToHeader defines a configuration to convert JWT claims into HTTP headers</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprovider>JWTProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>header</code></td><td><em>string</em></td><td>true</td><td>Header defines the name of the HTTP request header that the JWT Claim will be saved into.</td></tr><tr><td><code>claim</code></td><td><em>string</em></td><td>true</td><td>Claim is the JWT Claim that should be saved into the header : it can be a nested claim of type<br>(eg. &ldquo;claim.nested.key&rdquo;, &ldquo;sub&rdquo;). The nested claim name must use dot &ldquo;."<br>to separate the JSON name path.</td></tr></tbody></table><h4 id=clientconnection>ClientConnection<a class=td-heading-self-link href=#clientconnection aria-label="Heading self-link"></a></h4><p>ClientConnection allows users to configure connection-level settings of client</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>connectionLimit</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#connectionlimit>ConnectionLimit</a></em></td><td>false</td><td>ConnectionLimit defines limits related to connections</td></tr><tr><td><code>bufferLimit</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#quantity-resource-api>Quantity</a></em></td><td>false</td><td>BufferLimit provides configuration for the maximum buffer size in bytes for each incoming connection.<br>BufferLimit applies to connection streaming (maybe non-streaming) channel between processes, it&rsquo;s in user space.<br>For example, 20Mi, 1Gi, 256Ki etc.<br>Note that when the suffix is not provided, the value is interpreted as bytes.<br>Default: 32768 bytes.</td></tr></tbody></table><h4 id=clientipdetectionsettings>ClientIPDetectionSettings<a class=td-heading-self-link href=#clientipdetectionsettings aria-label="Heading self-link"></a></h4><p>ClientIPDetectionSettings provides configuration for determining the original client IP address for requests.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>xForwardedFor</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xforwardedforsettings>XForwardedForSettings</a></em></td><td>false</td><td>XForwardedForSettings provides configuration for using X-Forwarded-For headers for determining the client IP address.</td></tr><tr><td><code>customHeader</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customheaderextensionsettings>CustomHeaderExtensionSettings</a></em></td><td>false</td><td>CustomHeader provides configuration for determining the client IP address for a request based on<br>a trusted custom HTTP header. This uses the custom_header original IP detection extension.<br>Refer to <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/http/original_ip_detection/custom_header/v3/custom_header.proto>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/http/original_ip_detection/custom_header/v3/custom_header.proto</a><br>for more details.</td></tr></tbody></table><h4 id=clienttlssettings>ClientTLSSettings<a class=td-heading-self-link href=#clienttlssettings aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>clientValidation</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clientvalidationcontext>ClientValidationContext</a></em></td><td>false</td><td>ClientValidation specifies the configuration to validate the client<br>initiating the TLS connection to the Gateway listener.</td></tr><tr><td><code>minVersion</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlsversion>TLSVersion</a></em></td><td>false</td><td>Min specifies the minimal TLS protocol version to allow.<br>The default is TLS 1.2 if this is not specified.</td></tr><tr><td><code>maxVersion</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlsversion>TLSVersion</a></em></td><td>false</td><td>Max specifies the maximal TLS protocol version to allow<br>The default is TLS 1.3 if this is not specified.</td></tr><tr><td><code>ciphers</code></td><td><em>string array</em></td><td>false</td><td>Ciphers specifies the set of cipher suites supported when<br>negotiating TLS 1.0 - 1.2. This setting has no effect for TLS 1.3.<br>In non-FIPS Envoy Proxy builds the default cipher list is:<br>- [ECDHE-ECDSA-AES128-GCM-SHA256|ECDHE-ECDSA-CHACHA20-POLY1305]<br>- [ECDHE-RSA-AES128-GCM-SHA256|ECDHE-RSA-CHACHA20-POLY1305]<br>- ECDHE-ECDSA-AES256-GCM-SHA384<br>- ECDHE-RSA-AES256-GCM-SHA384<br>In builds using BoringSSL FIPS the default cipher list is:<br>- ECDHE-ECDSA-AES128-GCM-SHA256<br>- ECDHE-RSA-AES128-GCM-SHA256<br>- ECDHE-ECDSA-AES256-GCM-SHA384<br>- ECDHE-RSA-AES256-GCM-SHA384</td></tr><tr><td><code>ecdhCurves</code></td><td><em>string array</em></td><td>false</td><td>ECDHCurves specifies the set of supported ECDH curves.<br>In non-FIPS Envoy Proxy builds the default curves are:<br>- X25519<br>- P-256<br>In builds using BoringSSL FIPS the default curve is:<br>- P-256</td></tr><tr><td><code>signatureAlgorithms</code></td><td><em>string array</em></td><td>false</td><td>SignatureAlgorithms specifies which signature algorithms the listener should<br>support.</td></tr><tr><td><code>alpnProtocols</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alpnprotocol>ALPNProtocol</a> array</em></td><td>false</td><td>ALPNProtocols supplies the list of ALPN protocols that should be<br>exposed by the listener. By default h2 and http/1.1 are enabled.<br>Supported values are:<br>- http/1.0<br>- http/1.1<br>- h2</td></tr><tr><td><code>session</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#session>Session</a></em></td><td>false</td><td>Session defines settings related to TLS session management.</td></tr></tbody></table><h4 id=clienttimeout>ClientTimeout<a class=td-heading-self-link href=#clienttimeout aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>tcp</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcpclienttimeout>TCPClientTimeout</a></em></td><td>false</td><td>Timeout settings for TCP.</td></tr><tr><td><code>http</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpclienttimeout>HTTPClientTimeout</a></em></td><td>false</td><td>Timeout settings for HTTP.</td></tr></tbody></table><h4 id=clienttrafficpolicy>ClientTrafficPolicy<a class=td-heading-self-link href=#clienttrafficpolicy aria-label="Heading self-link"></a></h4><p>ClientTrafficPolicy allows the user to configure the behavior of the connection
between the downstream client and Envoy Proxy listener.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>ClientTrafficPolicy</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></em></td><td>true</td><td>Spec defines the desired state of ClientTrafficPolicy.</td></tr><tr><td><code>status</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.PolicyStatus>PolicyStatus</a></em></td><td>true</td><td>Status defines the current status of ClientTrafficPolicy.</td></tr></tbody></table><h4 id=clienttrafficpolicyspec>ClientTrafficPolicySpec<a class=td-heading-self-link href=#clienttrafficpolicyspec aria-label="Heading self-link"></a></h4><p>ClientTrafficPolicySpec defines the desired state of ClientTrafficPolicy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicy>ClientTrafficPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>targetRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a></em></td><td>true</td><td>TargetRef is the name of the resource this policy is being attached to.<br>This policy and the TargetRef MUST be in the same namespace for this<br>Policy to have effect<br><br>Deprecated: use targetRefs/targetSelectors instead</td></tr><tr><td><code>targetRefs</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a> array</em></td><td>true</td><td>TargetRefs are the names of the Gateway resources this policy<br>is being attached to.</td></tr><tr><td><code>targetSelectors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#targetselector>TargetSelector</a> array</em></td><td>true</td><td>TargetSelectors allow targeting resources for this policy based on labels</td></tr><tr><td><code>tcpKeepalive</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcpkeepalive>TCPKeepalive</a></em></td><td>false</td><td>TcpKeepalive settings associated with the downstream client connection.<br>If defined, sets SO_KEEPALIVE on the listener socket to enable TCP Keepalives.<br>Disabled by default.</td></tr><tr><td><code>enableProxyProtocol</code></td><td><em>boolean</em></td><td>false</td><td>EnableProxyProtocol interprets the ProxyProtocol header and adds the<br>Client Address into the X-Forwarded-For header.<br>Note Proxy Protocol must be present when this field is set, else the connection<br>is closed.</td></tr><tr><td><code>clientIPDetection</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clientipdetectionsettings>ClientIPDetectionSettings</a></em></td><td>false</td><td>ClientIPDetectionSettings provides configuration for determining the original client IP address for requests.</td></tr><tr><td><code>tls</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttlssettings>ClientTLSSettings</a></em></td><td>false</td><td>TLS settings configure TLS termination settings with the downstream client.</td></tr><tr><td><code>path</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#pathsettings>PathSettings</a></em></td><td>false</td><td>Path enables managing how the incoming path set by clients can be normalized.</td></tr><tr><td><code>headers</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#headersettings>HeaderSettings</a></em></td><td>false</td><td>HeaderSettings provides configuration for header management.</td></tr><tr><td><code>timeout</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttimeout>ClientTimeout</a></em></td><td>false</td><td>Timeout settings for the client connections.</td></tr><tr><td><code>connection</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clientconnection>ClientConnection</a></em></td><td>false</td><td>Connection includes client connection settings.</td></tr><tr><td><code>http1</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http1settings>HTTP1Settings</a></em></td><td>false</td><td>HTTP1 provides HTTP/1 configuration on the listener.</td></tr><tr><td><code>http2</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http2settings>HTTP2Settings</a></em></td><td>false</td><td>HTTP2 provides HTTP/2 configuration on the listener.</td></tr><tr><td><code>http3</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http3settings>HTTP3Settings</a></em></td><td>false</td><td>HTTP3 provides HTTP/3 configuration on the listener.</td></tr><tr><td><code>healthCheck</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#healthchecksettings>HealthCheckSettings</a></em></td><td>false</td><td>HealthCheck provides configuration for determining whether the HTTP/HTTPS listener is healthy.</td></tr></tbody></table><h4 id=clientvalidationcontext>ClientValidationContext<a class=td-heading-self-link href=#clientvalidationcontext aria-label="Heading self-link"></a></h4><p>ClientValidationContext holds configuration that can be used to validate the client initiating the TLS connection
to the Gateway.
By default, no client specific configuration is validated.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttlssettings>ClientTLSSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>optional</code></td><td><em>boolean</em></td><td>false</td><td>Optional set to true accepts connections even when a client doesn&rsquo;t present a certificate.<br>Defaults to false, which rejects connections without a valid client certificate.</td></tr><tr><td><code>caCertificateRefs</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a> array</em></td><td>false</td><td>CACertificateRefs contains one or more references to<br>Kubernetes objects that contain TLS certificates of<br>the Certificate Authorities that can be used<br>as a trust anchor to validate the certificates presented by the client.<br><br>A single reference to a Kubernetes ConfigMap or a Kubernetes Secret,<br>with the CA certificate in a key named <code>ca.crt</code> is currently supported.<br><br>References to a resource in different namespace are invalid UNLESS there<br>is a ReferenceGrant in the target namespace that allows the certificate<br>to be attached.</td></tr></tbody></table><h4 id=clustersettings>ClusterSettings<a class=td-heading-self-link href=#clustersettings aria-label="Heading self-link"></a></h4><p>ClusterSettings provides the various knobs that can be set to control how traffic to a given
backend will be configured.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendcluster>BackendCluster</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extproc>ExtProc</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#grpcextauthservice>GRPCExtAuthService</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpextauthservice>HTTPExtAuthService</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidcprovider>OIDCProvider</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyopentelemetrysink>ProxyOpenTelemetrySink</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovider>TracingProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>loadBalancer</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loadbalancer>LoadBalancer</a></em></td><td>false</td><td>LoadBalancer policy to apply when routing traffic from the gateway to<br>the backend endpoints. Defaults to <code>LeastRequest</code>.</td></tr><tr><td><code>retry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retry>Retry</a></em></td><td>false</td><td>Retry provides more advanced usage, allowing users to customize the number of retries, retry fallback strategy, and retry triggering conditions.<br>If not set, retry will be disabled.</td></tr><tr><td><code>proxyProtocol</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyprotocol>ProxyProtocol</a></em></td><td>false</td><td>ProxyProtocol enables the Proxy Protocol when communicating with the backend.</td></tr><tr><td><code>tcpKeepalive</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcpkeepalive>TCPKeepalive</a></em></td><td>false</td><td>TcpKeepalive settings associated with the upstream client connection.<br>Disabled by default.</td></tr><tr><td><code>healthCheck</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#healthcheck>HealthCheck</a></em></td><td>false</td><td>HealthCheck allows gateway to perform active health checking on backends.</td></tr><tr><td><code>circuitBreaker</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#circuitbreaker>CircuitBreaker</a></em></td><td>false</td><td>Circuit Breaker settings for the upstream connections and requests.<br>If not set, circuit breakers will be enabled with the default thresholds</td></tr><tr><td><code>timeout</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#timeout>Timeout</a></em></td><td>false</td><td>Timeout settings for the backend connections.</td></tr><tr><td><code>connection</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendconnection>BackendConnection</a></em></td><td>false</td><td>Connection includes backend connection settings.</td></tr><tr><td><code>dns</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#dns>DNS</a></em></td><td>false</td><td>DNS includes dns resolution settings.</td></tr><tr><td><code>http2</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http2settings>HTTP2Settings</a></em></td><td>false</td><td>HTTP2 provides HTTP/2 configuration for backend connections.</td></tr></tbody></table><h4 id=compression>Compression<a class=td-heading-self-link href=#compression aria-label="Heading self-link"></a></h4><p>Compression defines the config of enabling compression.
This can help reduce the bandwidth at the expense of higher CPU.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyprometheusprovider>ProxyPrometheusProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#compressortype>CompressorType</a></em></td><td>true</td><td>CompressorType defines the compressor type to use for compression.</td></tr><tr><td><code>gzip</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#gzipcompressor>GzipCompressor</a></em></td><td>false</td><td>The configuration for GZIP compressor.</td></tr></tbody></table><h4 id=compressortype>CompressorType<a class=td-heading-self-link href=#compressortype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>CompressorType defines the types of compressor library supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#compression>Compression</a></li></ul><h4 id=connectionlimit>ConnectionLimit<a class=td-heading-self-link href=#connectionlimit aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clientconnection>ClientConnection</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>value</code></td><td><em>integer</em></td><td>true</td><td>Value of the maximum concurrent connections limit.<br>When the limit is reached, incoming connections will be closed after the CloseDelay duration.</td></tr><tr><td><code>closeDelay</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>CloseDelay defines the delay to use before closing connections that are rejected<br>once the limit value is reached.<br>Default: none.</td></tr></tbody></table><h4 id=consistenthash>ConsistentHash<a class=td-heading-self-link href=#consistenthash aria-label="Heading self-link"></a></h4><p>ConsistentHash defines the configuration related to the consistent hash
load balancer policy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loadbalancer>LoadBalancer</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#consistenthashtype>ConsistentHashType</a></em></td><td>true</td><td>ConsistentHashType defines the type of input to hash on. Valid Type values are<br>&ldquo;SourceIP&rdquo;,<br>&ldquo;Header&rdquo;,<br>&ldquo;Cookie&rdquo;.</td></tr><tr><td><code>header</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#header>Header</a></em></td><td>false</td><td>Header configures the header hash policy when the consistent hash type is set to Header.</td></tr><tr><td><code>cookie</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#cookie>Cookie</a></em></td><td>false</td><td>Cookie configures the cookie hash policy when the consistent hash type is set to Cookie.</td></tr><tr><td><code>tableSize</code></td><td><em>integer</em></td><td>false</td><td>The table size for consistent hashing, must be prime number limited to 5000011.</td></tr></tbody></table><h4 id=consistenthashtype>ConsistentHashType<a class=td-heading-self-link href=#consistenthashtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ConsistentHashType defines the type of input to hash on.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#consistenthash>ConsistentHash</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>SourceIP</code></td><td>SourceIPConsistentHashType hashes based on the source IP address.<br></td></tr><tr><td><code>Header</code></td><td>HeaderConsistentHashType hashes based on a request header.<br></td></tr><tr><td><code>Cookie</code></td><td>CookieConsistentHashType hashes based on a cookie.<br></td></tr></tbody></table><h4 id=cookie>Cookie<a class=td-heading-self-link href=#cookie aria-label="Heading self-link"></a></h4><p>Cookie defines the cookie hashing configuration for consistent hash based
load balancing.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#consistenthash>ConsistentHash</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name of the cookie to hash.<br>If this cookie does not exist in the request, Envoy will generate a cookie and set<br>the TTL on the response back to the client based on Layer 4<br>attributes of the backend endpoint, to ensure that these future requests<br>go to the same backend endpoint. Make sure to set the TTL field for this case.</td></tr><tr><td><code>ttl</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>TTL of the generated cookie if the cookie is not present. This value sets the<br>Max-Age attribute value.</td></tr><tr><td><code>attributes</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>Additional Attributes to set for the generated cookie.</td></tr></tbody></table><h4 id=customheaderextensionsettings>CustomHeaderExtensionSettings<a class=td-heading-self-link href=#customheaderextensionsettings aria-label="Heading self-link"></a></h4><p>CustomHeaderExtensionSettings provides configuration for determining the client IP address for a request based on
a trusted custom HTTP header. This uses the the custom_header original IP detection extension.
Refer to <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/http/original_ip_detection/custom_header/v3/custom_header.proto>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/http/original_ip_detection/custom_header/v3/custom_header.proto</a>
for more details.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clientipdetectionsettings>ClientIPDetectionSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name of the header containing the original downstream remote address, if present.</td></tr><tr><td><code>failClosed</code></td><td><em>boolean</em></td><td>false</td><td>FailClosed is a switch used to control the flow of traffic when client IP detection<br>fails. If set to true, the listener will respond with 403 Forbidden when the client<br>IP address cannot be determined.</td></tr></tbody></table><h4 id=customresponse>CustomResponse<a class=td-heading-self-link href=#customresponse aria-label="Heading self-link"></a></h4><p>CustomResponse defines the configuration for returning a custom response.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#responseoverride>ResponseOverride</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>contentType</code></td><td><em>string</em></td><td>false</td><td>Content Type of the response. This will be set in the Content-Type header.</td></tr><tr><td><code>body</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponsebody>CustomResponseBody</a></em></td><td>true</td><td>Body of the Custom Response</td></tr></tbody></table><h4 id=customresponsebody>CustomResponseBody<a class=td-heading-self-link href=#customresponsebody aria-label="Heading self-link"></a></h4><p>CustomResponseBody</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponse>CustomResponse</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpdirectresponsefilter>HTTPDirectResponseFilter</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#responsevaluetype>ResponseValueType</a></em></td><td>true</td><td>Type is the type of method to use to read the body value.<br>Valid values are Inline and ValueRef, default is Inline.</td></tr><tr><td><code>inline</code></td><td><em>string</em></td><td>false</td><td>Inline contains the value as an inline string.</td></tr><tr><td><code>valueRef</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#localobjectreference>LocalObjectReference</a></em></td><td>false</td><td>ValueRef contains the contents of the body<br>specified as a local object reference.<br>Only a reference to ConfigMap is supported.<br><br>The value of key <code>response.body</code> in the ConfigMap will be used as the response body.<br>If the key is not found, the first value in the ConfigMap will be used.</td></tr></tbody></table><h4 id=customresponsematch>CustomResponseMatch<a class=td-heading-self-link href=#customresponsematch aria-label="Heading self-link"></a></h4><p>CustomResponseMatch defines the configuration for matching a user response to return a custom one.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#responseoverride>ResponseOverride</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>statusCodes</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statuscodematch>StatusCodeMatch</a> array</em></td><td>true</td><td>Status code to match on. The match evaluates to true if any of the matches are successful.</td></tr></tbody></table><h4 id=customtag>CustomTag<a class=td-heading-self-link href=#customtag aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytracing>ProxyTracing</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customtagtype>CustomTagType</a></em></td><td>true</td><td>Type defines the type of custom tag.</td></tr><tr><td><code>literal</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#literalcustomtag>LiteralCustomTag</a></em></td><td>true</td><td>Literal adds hard-coded value to each span.<br>It&rsquo;s required when the type is &ldquo;Literal&rdquo;.</td></tr><tr><td><code>environment</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#environmentcustomtag>EnvironmentCustomTag</a></em></td><td>true</td><td>Environment adds value from environment variable to each span.<br>It&rsquo;s required when the type is &ldquo;Environment&rdquo;.</td></tr><tr><td><code>requestHeader</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#requestheadercustomtag>RequestHeaderCustomTag</a></em></td><td>true</td><td>RequestHeader adds value from request header to each span.<br>It&rsquo;s required when the type is &ldquo;RequestHeader&rdquo;.</td></tr></tbody></table><h4 id=customtagtype>CustomTagType<a class=td-heading-self-link href=#customtagtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customtag>CustomTag</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Literal</code></td><td>CustomTagTypeLiteral adds hard-coded value to each span.<br></td></tr><tr><td><code>Environment</code></td><td>CustomTagTypeEnvironment adds value from environment variable to each span.<br></td></tr><tr><td><code>RequestHeader</code></td><td>CustomTagTypeRequestHeader adds value from request header to each span.<br></td></tr></tbody></table><h4 id=dns>DNS<a class=td-heading-self-link href=#dns aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>dnsRefreshRate</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>true</td><td>DNSRefreshRate specifies the rate at which DNS records should be refreshed.<br>Defaults to 30 seconds.</td></tr><tr><td><code>respectDnsTtl</code></td><td><em>boolean</em></td><td>true</td><td>RespectDNSTTL indicates whether the DNS Time-To-Live (TTL) should be respected.<br>If the value is set to true, the DNS refresh rate will be set to the resource record’s TTL.<br>Defaults to true.</td></tr></tbody></table><h4 id=environmentcustomtag>EnvironmentCustomTag<a class=td-heading-self-link href=#environmentcustomtag aria-label="Heading self-link"></a></h4><p>EnvironmentCustomTag adds value from environment variable to each span.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customtag>CustomTag</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name defines the name of the environment variable which to extract the value from.</td></tr><tr><td><code>defaultValue</code></td><td><em>string</em></td><td>false</td><td>DefaultValue defines the default value to use if the environment variable is not set.</td></tr></tbody></table><h4 id=envoyextensionpolicy>EnvoyExtensionPolicy<a class=td-heading-self-link href=#envoyextensionpolicy aria-label="Heading self-link"></a></h4><p>EnvoyExtensionPolicy allows the user to configure various envoy extensibility options for the Gateway.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>EnvoyExtensionPolicy</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicyspec>EnvoyExtensionPolicySpec</a></em></td><td>true</td><td>Spec defines the desired state of EnvoyExtensionPolicy.</td></tr><tr><td><code>status</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.PolicyStatus>PolicyStatus</a></em></td><td>true</td><td>Status defines the current status of EnvoyExtensionPolicy.</td></tr></tbody></table><h4 id=envoyextensionpolicyspec>EnvoyExtensionPolicySpec<a class=td-heading-self-link href=#envoyextensionpolicyspec aria-label="Heading self-link"></a></h4><p>EnvoyExtensionPolicySpec defines the desired state of EnvoyExtensionPolicy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicy>EnvoyExtensionPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>targetRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a></em></td><td>true</td><td>TargetRef is the name of the resource this policy is being attached to.<br>This policy and the TargetRef MUST be in the same namespace for this<br>Policy to have effect<br><br>Deprecated: use targetRefs/targetSelectors instead</td></tr><tr><td><code>targetRefs</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a> array</em></td><td>true</td><td>TargetRefs are the names of the Gateway resources this policy<br>is being attached to.</td></tr><tr><td><code>targetSelectors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#targetselector>TargetSelector</a> array</em></td><td>true</td><td>TargetSelectors allow targeting resources for this policy based on labels</td></tr><tr><td><code>wasm</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasm>Wasm</a> array</em></td><td>false</td><td>Wasm is a list of Wasm extensions to be loaded by the Gateway.<br>Order matters, as the extensions will be loaded in the order they are<br>defined in this list.</td></tr><tr><td><code>extProc</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extproc>ExtProc</a> array</em></td><td>false</td><td>ExtProc is an ordered list of external processing filters<br>that should added to the envoy filter chain</td></tr></tbody></table><h4 id=envoyfilter>EnvoyFilter<a class=td-heading-self-link href=#envoyfilter aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>EnvoyFilter defines the type of Envoy HTTP filter.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#filterposition>FilterPosition</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>envoy.filters.http.health_check</code></td><td>EnvoyFilterHealthCheck defines the Envoy HTTP health check filter.<br></td></tr><tr><td><code>envoy.filters.http.fault</code></td><td>EnvoyFilterFault defines the Envoy HTTP fault filter.<br></td></tr><tr><td><code>envoy.filters.http.cors</code></td><td>EnvoyFilterCORS defines the Envoy HTTP CORS filter.<br></td></tr><tr><td><code>envoy.filters.http.ext_authz</code></td><td>EnvoyFilterExtAuthz defines the Envoy HTTP external authorization filter.<br></td></tr><tr><td><code>envoy.filters.http.basic_auth</code></td><td>EnvoyFilterBasicAuth defines the Envoy HTTP basic authentication filter.<br></td></tr><tr><td><code>envoy.filters.http.oauth2</code></td><td>EnvoyFilterOAuth2 defines the Envoy HTTP OAuth2 filter.<br></td></tr><tr><td><code>envoy.filters.http.jwt_authn</code></td><td>EnvoyFilterJWTAuthn defines the Envoy HTTP JWT authentication filter.<br></td></tr><tr><td><code>envoy.filters.http.stateful_session</code></td><td>EnvoyFilterSessionPersistence defines the Envoy HTTP session persistence filter.<br></td></tr><tr><td><code>envoy.filters.http.ext_proc</code></td><td>EnvoyFilterExtProc defines the Envoy HTTP external process filter.<br></td></tr><tr><td><code>envoy.filters.http.wasm</code></td><td>EnvoyFilterWasm defines the Envoy HTTP WebAssembly filter.<br></td></tr><tr><td><code>envoy.filters.http.rbac</code></td><td>EnvoyFilterRBAC defines the Envoy RBAC filter.<br></td></tr><tr><td><code>envoy.filters.http.local_ratelimit</code></td><td>EnvoyFilterLocalRateLimit defines the Envoy HTTP local rate limit filter.<br></td></tr><tr><td><code>envoy.filters.http.ratelimit</code></td><td>EnvoyFilterRateLimit defines the Envoy HTTP rate limit filter.<br></td></tr><tr><td><code>envoy.filters.http.custom_response</code></td><td>EnvoyFilterCustomResponse defines the Envoy HTTP custom response filter.<br></td></tr><tr><td><code>envoy.filters.http.router</code></td><td>EnvoyFilterRouter defines the Envoy HTTP router filter.<br></td></tr></tbody></table><h4 id=envoygateway>EnvoyGateway<a class=td-heading-self-link href=#envoygateway aria-label="Heading self-link"></a></h4><p>EnvoyGateway is the schema for the envoygateways API.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>EnvoyGateway</code></td></tr><tr><td><code>gateway</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#gateway>Gateway</a></em></td><td>false</td><td>Gateway defines desired Gateway API specific configuration. If unset,<br>default configuration parameters will apply.</td></tr><tr><td><code>provider</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayprovider>EnvoyGatewayProvider</a></em></td><td>false</td><td>Provider defines the desired provider and provider-specific configuration.<br>If unspecified, the Kubernetes provider is used with default configuration<br>parameters.</td></tr><tr><td><code>logging</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaylogging>EnvoyGatewayLogging</a></em></td><td>false</td><td>Logging defines logging parameters for Envoy Gateway.</td></tr><tr><td><code>admin</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayadmin>EnvoyGatewayAdmin</a></em></td><td>false</td><td>Admin defines the desired admin related abilities.<br>If unspecified, the Admin is used with default configuration<br>parameters.</td></tr><tr><td><code>telemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaytelemetry>EnvoyGatewayTelemetry</a></em></td><td>false</td><td>Telemetry defines the desired control plane telemetry related abilities.<br>If unspecified, the telemetry is used with default configuration.</td></tr><tr><td><code>rateLimit</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimit>RateLimit</a></em></td><td>false</td><td>RateLimit defines the configuration associated with the Rate Limit service<br>deployed by Envoy Gateway required to implement the Global Rate limiting<br>functionality. The specific rate limit service used here is the reference<br>implementation in Envoy. For more details visit <a href=https://github.com/envoyproxy/ratelimit>https://github.com/envoyproxy/ratelimit</a>.<br>This configuration is unneeded for &ldquo;Local&rdquo; rate limiting.</td></tr><tr><td><code>extensionManager</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionmanager>ExtensionManager</a></em></td><td>false</td><td>ExtensionManager defines an extension manager to register for the Envoy Gateway Control Plane.</td></tr><tr><td><code>extensionApis</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionapisettings>ExtensionAPISettings</a></em></td><td>false</td><td>ExtensionAPIs defines the settings related to specific Gateway API Extensions<br>implemented by Envoy Gateway</td></tr></tbody></table><h4 id=envoygatewayadmin>EnvoyGatewayAdmin<a class=td-heading-self-link href=#envoygatewayadmin aria-label="Heading self-link"></a></h4><p>EnvoyGatewayAdmin defines the Envoy Gateway Admin configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>address</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayadminaddress>EnvoyGatewayAdminAddress</a></em></td><td>false</td><td>Address defines the address of Envoy Gateway Admin Server.</td></tr><tr><td><code>enableDumpConfig</code></td><td><em>boolean</em></td><td>false</td><td>EnableDumpConfig defines if enable dump config in Envoy Gateway logs.</td></tr><tr><td><code>enablePprof</code></td><td><em>boolean</em></td><td>false</td><td>EnablePprof defines if enable pprof in Envoy Gateway Admin Server.</td></tr></tbody></table><h4 id=envoygatewayadminaddress>EnvoyGatewayAdminAddress<a class=td-heading-self-link href=#envoygatewayadminaddress aria-label="Heading self-link"></a></h4><p>EnvoyGatewayAdminAddress defines the Envoy Gateway Admin Address configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayadmin>EnvoyGatewayAdmin</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>port</code></td><td><em>integer</em></td><td>false</td><td>Port defines the port the admin server is exposed on.</td></tr><tr><td><code>host</code></td><td><em>string</em></td><td>false</td><td>Host defines the admin server hostname.</td></tr></tbody></table><h4 id=envoygatewaycustomprovider>EnvoyGatewayCustomProvider<a class=td-heading-self-link href=#envoygatewaycustomprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayCustomProvider defines configuration for the Custom provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayprovider>EnvoyGatewayProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>resource</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayresourceprovider>EnvoyGatewayResourceProvider</a></em></td><td>true</td><td>Resource defines the desired resource provider.<br>This provider is used to specify the provider to be used<br>to retrieve the resource configurations such as Gateway API<br>resources</td></tr><tr><td><code>infrastructure</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</a></em></td><td>false</td><td>Infrastructure defines the desired infrastructure provider.<br>This provider is used to specify the provider to be used<br>to provide an environment to deploy the out resources like<br>the Envoy Proxy data plane.<br><br>Infrastructure is optional, if provider is not specified,<br>No infrastructure provider is available.</td></tr></tbody></table><h4 id=envoygatewayfileresourceprovider>EnvoyGatewayFileResourceProvider<a class=td-heading-self-link href=#envoygatewayfileresourceprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayFileResourceProvider defines configuration for the File Resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayresourceprovider>EnvoyGatewayResourceProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>paths</code></td><td><em>string array</em></td><td>true</td><td>Paths are the paths to a directory or file containing the resource configuration.<br>Recursive subdirectories are not currently supported.</td></tr></tbody></table><h4 id=envoygatewayhostinfrastructureprovider>EnvoyGatewayHostInfrastructureProvider<a class=td-heading-self-link href=#envoygatewayhostinfrastructureprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayHostInfrastructureProvider defines configuration for the Host Infrastructure provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</a></li></ul><h4 id=envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider<a class=td-heading-self-link href=#envoygatewayinfrastructureprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayInfrastructureProvider defines configuration for the Custom Infrastructure provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaycustomprovider>EnvoyGatewayCustomProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#infrastructureprovidertype>InfrastructureProviderType</a></em></td><td>true</td><td>Type is the type of infrastructure providers to use. Supported types are &ldquo;Host&rdquo;.</td></tr><tr><td><code>host</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayhostinfrastructureprovider>EnvoyGatewayHostInfrastructureProvider</a></em></td><td>false</td><td>Host defines the configuration of the Host provider. Host provides runtime<br>deployment of the data plane as a child process on the host environment.</td></tr></tbody></table><h4 id=envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider<a class=td-heading-self-link href=#envoygatewaykubernetesprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayKubernetesProvider defines configuration for the Kubernetes provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayprovider>EnvoyGatewayProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>rateLimitDeployment</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></em></td><td>false</td><td>RateLimitDeployment defines the desired state of the Envoy ratelimit deployment resource.<br>If unspecified, default settings for the managed Envoy ratelimit deployment resource<br>are applied.</td></tr><tr><td><code>watch</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kuberneteswatchmode>KubernetesWatchMode</a></em></td><td>false</td><td>Watch holds configuration of which input resources should be watched and reconciled.</td></tr><tr><td><code>deploy</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdeploymode>KubernetesDeployMode</a></em></td><td>false</td><td>Deploy holds configuration of how output managed resources such as the Envoy Proxy data plane<br>should be deployed</td></tr><tr><td><code>overwriteControlPlaneCerts</code></td><td><em>boolean</em></td><td>false</td><td>OverwriteControlPlaneCerts updates the secrets containing the control plane certs, when set.</td></tr><tr><td><code>leaderElection</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#leaderelection>LeaderElection</a></em></td><td>false</td><td>LeaderElection specifies the configuration for leader election.<br>If it&rsquo;s not set up, leader election will be active by default, using Kubernetes&rsquo; standard settings.</td></tr><tr><td><code>shutdownManager</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#shutdownmanager>ShutdownManager</a></em></td><td>false</td><td>ShutdownManager defines the configuration for the shutdown manager.</td></tr></tbody></table><h4 id=envoygatewaylogcomponent>EnvoyGatewayLogComponent<a class=td-heading-self-link href=#envoygatewaylogcomponent aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>EnvoyGatewayLogComponent defines a component that supports a configured logging level.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaylogging>EnvoyGatewayLogging</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>default</code></td><td>LogComponentGatewayDefault defines the &ldquo;default&rdquo;-wide logging component. When specified,<br>all other logging components are ignored.<br></td></tr><tr><td><code>provider</code></td><td>LogComponentProviderRunner defines the &ldquo;provider&rdquo; runner component.<br></td></tr><tr><td><code>gateway-api</code></td><td>LogComponentGatewayAPIRunner defines the &ldquo;gateway-api&rdquo; runner component.<br></td></tr><tr><td><code>xds-translator</code></td><td>LogComponentXdsTranslatorRunner defines the &ldquo;xds-translator&rdquo; runner component.<br></td></tr><tr><td><code>xds-server</code></td><td>LogComponentXdsServerRunner defines the &ldquo;xds-server&rdquo; runner component.<br></td></tr><tr><td><code>infrastructure</code></td><td>LogComponentInfrastructureRunner defines the &ldquo;infrastructure&rdquo; runner component.<br></td></tr><tr><td><code>global-ratelimit</code></td><td>LogComponentGlobalRateLimitRunner defines the &ldquo;global-ratelimit&rdquo; runner component.<br></td></tr></tbody></table><h4 id=envoygatewaylogging>EnvoyGatewayLogging<a class=td-heading-self-link href=#envoygatewaylogging aria-label="Heading self-link"></a></h4><p>EnvoyGatewayLogging defines logging for Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>level</code></td><td><em>object (keys:<a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaylogcomponent>EnvoyGatewayLogComponent</a>, values:<a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loglevel>LogLevel</a>)</em></td><td>true</td><td>Level is the logging level. If unspecified, defaults to &ldquo;info&rdquo;.<br>EnvoyGatewayLogComponent options: default/provider/gateway-api/xds-translator/xds-server/infrastructure/global-ratelimit.<br>LogLevel options: debug/info/error/warn.</td></tr></tbody></table><h4 id=envoygatewaymetricsink>EnvoyGatewayMetricSink<a class=td-heading-self-link href=#envoygatewaymetricsink aria-label="Heading self-link"></a></h4><p>EnvoyGatewayMetricSink defines control plane
metric sinks where metrics are sent to.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaymetrics>EnvoyGatewayMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#metricsinktype>MetricSinkType</a></em></td><td>true</td><td>Type defines the metric sink type.<br>EG control plane currently supports OpenTelemetry.</td></tr><tr><td><code>openTelemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayopentelemetrysink>EnvoyGatewayOpenTelemetrySink</a></em></td><td>true</td><td>OpenTelemetry defines the configuration for OpenTelemetry sink.<br>It&rsquo;s required if the sink type is OpenTelemetry.</td></tr></tbody></table><h4 id=envoygatewaymetrics>EnvoyGatewayMetrics<a class=td-heading-self-link href=#envoygatewaymetrics aria-label="Heading self-link"></a></h4><p>EnvoyGatewayMetrics defines control plane push/pull metrics configurations.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaytelemetry>EnvoyGatewayTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>sinks</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaymetricsink>EnvoyGatewayMetricSink</a> array</em></td><td>true</td><td>Sinks defines the metric sinks where metrics are sent to.</td></tr><tr><td><code>prometheus</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayprometheusprovider>EnvoyGatewayPrometheusProvider</a></em></td><td>true</td><td>Prometheus defines the configuration for prometheus endpoint.</td></tr></tbody></table><h4 id=envoygatewayopentelemetrysink>EnvoyGatewayOpenTelemetrySink<a class=td-heading-self-link href=#envoygatewayopentelemetrysink aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaymetricsink>EnvoyGatewayMetricSink</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>host</code></td><td><em>string</em></td><td>true</td><td>Host define the sink service hostname.</td></tr><tr><td><code>protocol</code></td><td><em>string</em></td><td>true</td><td>Protocol define the sink service protocol.</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>false</td><td>Port defines the port the sink service is exposed on.</td></tr><tr><td><code>exportInterval</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>true</td><td>ExportInterval configures the intervening time between exports for a<br>Sink. This option overrides any value set for the<br>OTEL_METRIC_EXPORT_INTERVAL environment variable.<br>If ExportInterval is less than or equal to zero, 60 seconds<br>is used as the default.</td></tr><tr><td><code>exportTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>true</td><td>ExportTimeout configures the time a Sink waits for an export to<br>complete before canceling it. This option overrides any value set for the<br>OTEL_METRIC_EXPORT_TIMEOUT environment variable.<br>If ExportTimeout is less than or equal to zero, 30 seconds<br>is used as the default.</td></tr></tbody></table><h4 id=envoygatewayprometheusprovider>EnvoyGatewayPrometheusProvider<a class=td-heading-self-link href=#envoygatewayprometheusprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayPrometheusProvider will expose prometheus endpoint in pull mode.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaymetrics>EnvoyGatewayMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>disable</code></td><td><em>boolean</em></td><td>true</td><td>Disable defines if disables the prometheus metrics in pull mode.</td></tr></tbody></table><h4 id=envoygatewayprovider>EnvoyGatewayProvider<a class=td-heading-self-link href=#envoygatewayprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayProvider defines the desired configuration of a provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#providertype>ProviderType</a></em></td><td>true</td><td>Type is the type of provider to use. Supported types are &ldquo;Kubernetes&rdquo;, &ldquo;Custom&rdquo;.</td></tr><tr><td><code>kubernetes</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></em></td><td>false</td><td>Kubernetes defines the configuration of the Kubernetes provider. Kubernetes<br>provides runtime configuration via the Kubernetes API.</td></tr><tr><td><code>custom</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaycustomprovider>EnvoyGatewayCustomProvider</a></em></td><td>false</td><td>Custom defines the configuration for the Custom provider. This provider<br>allows you to define a specific resource provider and an infrastructure<br>provider.</td></tr></tbody></table><h4 id=envoygatewayresourceprovider>EnvoyGatewayResourceProvider<a class=td-heading-self-link href=#envoygatewayresourceprovider aria-label="Heading self-link"></a></h4><p>EnvoyGatewayResourceProvider defines configuration for the Custom Resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaycustomprovider>EnvoyGatewayCustomProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#resourceprovidertype>ResourceProviderType</a></em></td><td>true</td><td>Type is the type of resource provider to use. Supported types are &ldquo;File&rdquo;.</td></tr><tr><td><code>file</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayfileresourceprovider>EnvoyGatewayFileResourceProvider</a></em></td><td>false</td><td>File defines the configuration of the File provider. File provides runtime<br>configuration defined by one or more files.</td></tr></tbody></table><h4 id=envoygatewayspec>EnvoyGatewaySpec<a class=td-heading-self-link href=#envoygatewayspec aria-label="Heading self-link"></a></h4><p>EnvoyGatewaySpec defines the desired state of Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>gateway</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#gateway>Gateway</a></em></td><td>false</td><td>Gateway defines desired Gateway API specific configuration. If unset,<br>default configuration parameters will apply.</td></tr><tr><td><code>provider</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayprovider>EnvoyGatewayProvider</a></em></td><td>false</td><td>Provider defines the desired provider and provider-specific configuration.<br>If unspecified, the Kubernetes provider is used with default configuration<br>parameters.</td></tr><tr><td><code>logging</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaylogging>EnvoyGatewayLogging</a></em></td><td>false</td><td>Logging defines logging parameters for Envoy Gateway.</td></tr><tr><td><code>admin</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayadmin>EnvoyGatewayAdmin</a></em></td><td>false</td><td>Admin defines the desired admin related abilities.<br>If unspecified, the Admin is used with default configuration<br>parameters.</td></tr><tr><td><code>telemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaytelemetry>EnvoyGatewayTelemetry</a></em></td><td>false</td><td>Telemetry defines the desired control plane telemetry related abilities.<br>If unspecified, the telemetry is used with default configuration.</td></tr><tr><td><code>rateLimit</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimit>RateLimit</a></em></td><td>false</td><td>RateLimit defines the configuration associated with the Rate Limit service<br>deployed by Envoy Gateway required to implement the Global Rate limiting<br>functionality. The specific rate limit service used here is the reference<br>implementation in Envoy. For more details visit <a href=https://github.com/envoyproxy/ratelimit>https://github.com/envoyproxy/ratelimit</a>.<br>This configuration is unneeded for &ldquo;Local&rdquo; rate limiting.</td></tr><tr><td><code>extensionManager</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionmanager>ExtensionManager</a></em></td><td>false</td><td>ExtensionManager defines an extension manager to register for the Envoy Gateway Control Plane.</td></tr><tr><td><code>extensionApis</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionapisettings>ExtensionAPISettings</a></em></td><td>false</td><td>ExtensionAPIs defines the settings related to specific Gateway API Extensions<br>implemented by Envoy Gateway</td></tr></tbody></table><h4 id=envoygatewaytelemetry>EnvoyGatewayTelemetry<a class=td-heading-self-link href=#envoygatewaytelemetry aria-label="Heading self-link"></a></h4><p>EnvoyGatewayTelemetry defines telemetry configurations for envoy gateway control plane.
Control plane will focus on metrics observability telemetry and tracing telemetry later.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>metrics</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaymetrics>EnvoyGatewayMetrics</a></em></td><td>true</td><td>Metrics defines metrics configuration for envoy gateway.</td></tr></tbody></table><h4 id=envoyjsonpatchconfig>EnvoyJSONPatchConfig<a class=td-heading-self-link href=#envoyjsonpatchconfig aria-label="Heading self-link"></a></h4><p>EnvoyJSONPatchConfig defines the configuration for patching a Envoy xDS Resource
using JSONPatch semantic</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchpolicyspec>EnvoyPatchPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyresourcetype>EnvoyResourceType</a></em></td><td>true</td><td>Type is the typed URL of the Envoy xDS Resource</td></tr><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name is the name of the resource</td></tr><tr><td><code>operation</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jsonpatchoperation>JSONPatchOperation</a></em></td><td>true</td><td>Patch defines the JSON Patch Operation</td></tr></tbody></table><h4 id=envoypatchpolicy>EnvoyPatchPolicy<a class=td-heading-self-link href=#envoypatchpolicy aria-label="Heading self-link"></a></h4><p>EnvoyPatchPolicy allows the user to modify the generated Envoy xDS
resources by Envoy Gateway using this patch API</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>EnvoyPatchPolicy</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchpolicyspec>EnvoyPatchPolicySpec</a></em></td><td>true</td><td>Spec defines the desired state of EnvoyPatchPolicy.</td></tr><tr><td><code>status</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.PolicyStatus>PolicyStatus</a></em></td><td>true</td><td>Status defines the current status of EnvoyPatchPolicy.</td></tr></tbody></table><h4 id=envoypatchpolicyspec>EnvoyPatchPolicySpec<a class=td-heading-self-link href=#envoypatchpolicyspec aria-label="Heading self-link"></a></h4><p>EnvoyPatchPolicySpec defines the desired state of EnvoyPatchPolicy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchpolicy>EnvoyPatchPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchtype>EnvoyPatchType</a></em></td><td>true</td><td>Type decides the type of patch.<br>Valid EnvoyPatchType values are &ldquo;JSONPatch&rdquo;.</td></tr><tr><td><code>jsonPatches</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyjsonpatchconfig>EnvoyJSONPatchConfig</a> array</em></td><td>false</td><td>JSONPatch defines the JSONPatch configuration.</td></tr><tr><td><code>targetRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReference>LocalPolicyTargetReference</a></em></td><td>true</td><td>TargetRef is the name of the Gateway API resource this policy<br>is being attached to.<br>By default, attaching to Gateway is supported and<br>when mergeGateways is enabled it should attach to GatewayClass.<br>This Policy and the TargetRef MUST be in the same namespace<br>for this Policy to have effect and be applied to the Gateway<br>TargetRef</td></tr><tr><td><code>priority</code></td><td><em>integer</em></td><td>true</td><td>Priority of the EnvoyPatchPolicy.<br>If multiple EnvoyPatchPolicies are applied to the same<br>TargetRef, they will be applied in the ascending order of<br>the priority i.e. int32.min has the highest priority and<br>int32.max has the lowest priority.<br>Defaults to 0.</td></tr></tbody></table><h4 id=envoypatchtype>EnvoyPatchType<a class=td-heading-self-link href=#envoypatchtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>EnvoyPatchType specifies the types of Envoy patching mechanisms.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoypatchpolicyspec>EnvoyPatchPolicySpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>JSONPatch</code></td><td>JSONPatchEnvoyPatchType allows the user to patch the generated xDS resources using JSONPatch semantics.<br>For more details on the semantics, please refer to <a href=https://datatracker.ietf.org/doc/html/rfc6902>https://datatracker.ietf.org/doc/html/rfc6902</a><br></td></tr></tbody></table><h4 id=envoyproxy>EnvoyProxy<a class=td-heading-self-link href=#envoyproxy aria-label="Heading self-link"></a></h4><p>EnvoyProxy is the schema for the envoyproxies API.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>EnvoyProxy</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></em></td><td>true</td><td>EnvoyProxySpec defines the desired state of EnvoyProxy.</td></tr><tr><td><code>status</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxystatus>EnvoyProxyStatus</a></em></td><td>true</td><td>EnvoyProxyStatus defines the actual state of EnvoyProxy.</td></tr></tbody></table><h4 id=envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider<a class=td-heading-self-link href=#envoyproxykubernetesprovider aria-label="Heading self-link"></a></h4><p>EnvoyProxyKubernetesProvider defines configuration for the Kubernetes resource
provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyprovider>EnvoyProxyProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>envoyDeployment</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></em></td><td>false</td><td>EnvoyDeployment defines the desired state of the Envoy deployment resource.<br>If unspecified, default settings for the managed Envoy deployment resource<br>are applied.</td></tr><tr><td><code>envoyDaemonSet</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdaemonsetspec>KubernetesDaemonSetSpec</a></em></td><td>false</td><td>EnvoyDaemonSet defines the desired state of the Envoy daemonset resource.<br>Disabled by default, a deployment resource is used instead to provision the Envoy Proxy fleet</td></tr><tr><td><code>envoyService</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesservicespec>KubernetesServiceSpec</a></em></td><td>false</td><td>EnvoyService defines the desired state of the Envoy service resource.<br>If unspecified, default settings for the managed Envoy service resource<br>are applied.</td></tr><tr><td><code>envoyHpa</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kuberneteshorizontalpodautoscalerspec>KubernetesHorizontalPodAutoscalerSpec</a></em></td><td>false</td><td>EnvoyHpa defines the Horizontal Pod Autoscaler settings for Envoy Proxy Deployment.<br>Once the HPA is being set, Replicas field from EnvoyDeployment will be ignored.</td></tr><tr><td><code>useListenerPortAsContainerPort</code></td><td><em>boolean</em></td><td>false</td><td>UseListenerPortAsContainerPort disables the port shifting feature in the Envoy Proxy.<br>When set to false (default value), if the service port is a privileged port (1-1023), add a constant to the value converting it into an ephemeral port.<br>This allows the container to bind to the port without needing a CAP_NET_BIND_SERVICE capability.</td></tr><tr><td><code>envoyPDB</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespoddisruptionbudgetspec>KubernetesPodDisruptionBudgetSpec</a></em></td><td>false</td><td>EnvoyPDB allows to control the pod disruption budget of an Envoy Proxy.</td></tr></tbody></table><h4 id=envoyproxyprovider>EnvoyProxyProvider<a class=td-heading-self-link href=#envoyproxyprovider aria-label="Heading self-link"></a></h4><p>EnvoyProxyProvider defines the desired state of a resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#providertype>ProviderType</a></em></td><td>true</td><td>Type is the type of resource provider to use. A resource provider provides<br>infrastructure resources for running the data plane, e.g. Envoy proxy, and<br>optional auxiliary control planes. Supported types are &ldquo;Kubernetes&rdquo;.</td></tr><tr><td><code>kubernetes</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></em></td><td>false</td><td>Kubernetes defines the desired state of the Kubernetes resource provider.<br>Kubernetes provides infrastructure resources for running the data plane,<br>e.g. Envoy proxy. If unspecified and type is &ldquo;Kubernetes&rdquo;, default settings<br>for managed Kubernetes resources are applied.</td></tr></tbody></table><h4 id=envoyproxyspec>EnvoyProxySpec<a class=td-heading-self-link href=#envoyproxyspec aria-label="Heading self-link"></a></h4><p>EnvoyProxySpec defines the desired state of EnvoyProxy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>provider</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyprovider>EnvoyProxyProvider</a></em></td><td>false</td><td>Provider defines the desired resource provider and provider-specific configuration.<br>If unspecified, the &ldquo;Kubernetes&rdquo; resource provider is used with default configuration<br>parameters.</td></tr><tr><td><code>logging</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxylogging>ProxyLogging</a></em></td><td>true</td><td>Logging defines logging parameters for managed proxies.</td></tr><tr><td><code>telemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytelemetry>ProxyTelemetry</a></em></td><td>false</td><td>Telemetry defines telemetry parameters for managed proxies.</td></tr><tr><td><code>bootstrap</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxybootstrap>ProxyBootstrap</a></em></td><td>false</td><td>Bootstrap defines the Envoy Bootstrap as a YAML string.<br>Visit <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/bootstrap/v3/bootstrap.proto#envoy-v3-api-msg-config-bootstrap-v3-bootstrap>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/bootstrap/v3/bootstrap.proto#envoy-v3-api-msg-config-bootstrap-v3-bootstrap</a><br>to learn more about the syntax.<br>If set, this is the Bootstrap configuration used for the managed Envoy Proxy fleet instead of the default Bootstrap configuration<br>set by Envoy Gateway.<br>Some fields within the Bootstrap that are required to communicate with the xDS Server (Envoy Gateway) and receive xDS resources<br>from it are not configurable and will result in the <code>EnvoyProxy</code> resource being rejected.<br>Backward compatibility across minor versions is not guaranteed.<br>We strongly recommend using <code>egctl x translate</code> to generate a <code>EnvoyProxy</code> resource with the <code>Bootstrap</code> field set to the default<br>Bootstrap configuration used. You can edit this configuration, and rerun <code>egctl x translate</code> to ensure there are no validation errors.</td></tr><tr><td><code>concurrency</code></td><td><em>integer</em></td><td>false</td><td>Concurrency defines the number of worker threads to run. If unset, it defaults to<br>the number of cpuset threads on the platform.</td></tr><tr><td><code>routingType</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#routingtype>RoutingType</a></em></td><td>false</td><td>RoutingType can be set to &ldquo;Service&rdquo; to use the Service Cluster IP for routing to the backend,<br>or it can be set to &ldquo;Endpoint&rdquo; to use Endpoint routing. The default is &ldquo;Endpoint&rdquo;.</td></tr><tr><td><code>extraArgs</code></td><td><em>string array</em></td><td>false</td><td>ExtraArgs defines additional command line options that are provided to Envoy.<br>More info: <a href=https://www.envoyproxy.io/docs/envoy/latest/operations/cli#command-line-options>https://www.envoyproxy.io/docs/envoy/latest/operations/cli#command-line-options</a><br>Note: some command line options are used internally(e.g. &ndash;log-level) so they cannot be provided here.</td></tr><tr><td><code>mergeGateways</code></td><td><em>boolean</em></td><td>false</td><td>MergeGateways defines if Gateway resources should be merged onto the same Envoy Proxy Infrastructure.<br>Setting this field to true would merge all Gateway Listeners under the parent Gateway Class.<br>This means that the port, protocol and hostname tuple must be unique for every listener.<br>If a duplicate listener is detected, the newer listener (based on timestamp) will be rejected and its status will be updated with a &ldquo;Accepted=False&rdquo; condition.</td></tr><tr><td><code>shutdown</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#shutdownconfig>ShutdownConfig</a></em></td><td>false</td><td>Shutdown defines configuration for graceful envoy shutdown process.</td></tr><tr><td><code>filterOrder</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#filterposition>FilterPosition</a> array</em></td><td>false</td><td>FilterOrder defines the order of filters in the Envoy proxy&rsquo;s HTTP filter chain.<br>The FilterPosition in the list will be applied in the order they are defined.<br>If unspecified, the default filter order is applied.<br>Default filter order is:<br><br>- envoy.filters.http.health_check<br><br>- envoy.filters.http.fault<br><br>- envoy.filters.http.cors<br><br>- envoy.filters.http.ext_authz<br><br>- envoy.filters.http.basic_auth<br><br>- envoy.filters.http.oauth2<br><br>- envoy.filters.http.jwt_authn<br><br>- envoy.filters.http.stateful_session<br><br>- envoy.filters.http.ext_proc<br><br>- envoy.filters.http.wasm<br><br>- envoy.filters.http.rbac<br><br>- envoy.filters.http.local_ratelimit<br><br>- envoy.filters.http.ratelimit<br><br>- envoy.filters.http.custom_response<br><br>- envoy.filters.http.router<br><br>Note: &ldquo;envoy.filters.http.router&rdquo; cannot be reordered, it&rsquo;s always the last filter in the chain.</td></tr><tr><td><code>backendTLS</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtlsconfig>BackendTLSConfig</a></em></td><td>false</td><td>BackendTLS is the TLS configuration for the Envoy proxy to use when connecting to backends.<br>These settings are applied on backends for which TLS policies are specified.</td></tr><tr><td><code>ipFamily</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ipfamily>IPFamily</a></em></td><td>false</td><td>IPFamily specifies the IP family for the EnvoyProxy fleet.<br>This setting only affects the Gateway listener port and does not impact<br>other aspects of the Envoy proxy configuration.<br>If not specified, the system will operate as follows:<br>- It defaults to IPv4 only.<br>- IPv6 and dual-stack environments are not supported in this default configuration.<br>Note: To enable IPv6 or dual-stack functionality, explicit configuration is required.</td></tr></tbody></table><h4 id=envoyproxystatus>EnvoyProxyStatus<a class=td-heading-self-link href=#envoyproxystatus aria-label="Heading self-link"></a></h4><p>EnvoyProxyStatus defines the observed state of EnvoyProxy. This type is not implemented
until <a href=https://github.com/envoyproxy/gateway/issues/1007>https://github.com/envoyproxy/gateway/issues/1007</a> is fixed.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a></li></ul><h4 id=envoyresourcetype>EnvoyResourceType<a class=td-heading-self-link href=#envoyresourcetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>EnvoyResourceType specifies the type URL of the Envoy resource.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyjsonpatchconfig>EnvoyJSONPatchConfig</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>type.googleapis.com/envoy.config.listener.v3.Listener</code></td><td>ListenerEnvoyResourceType defines the Type URL of the Listener resource<br></td></tr><tr><td><code>type.googleapis.com/envoy.config.route.v3.RouteConfiguration</code></td><td>RouteConfigurationEnvoyResourceType defines the Type URL of the RouteConfiguration resource<br></td></tr><tr><td><code>type.googleapis.com/envoy.config.cluster.v3.Cluster</code></td><td>ClusterEnvoyResourceType defines the Type URL of the Cluster resource<br></td></tr><tr><td><code>type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment</code></td><td>ClusterLoadAssignmentEnvoyResourceType defines the Type URL of the ClusterLoadAssignment resource<br></td></tr></tbody></table><h4 id=extauth>ExtAuth<a class=td-heading-self-link href=#extauth aria-label="Heading self-link"></a></h4><p>ExtAuth defines the configuration for External Authorization.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>grpc</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#grpcextauthservice>GRPCExtAuthService</a></em></td><td>true</td><td>GRPC defines the gRPC External Authorization service.<br>Either GRPCService or HTTPService must be specified,<br>and only one of them can be provided.</td></tr><tr><td><code>http</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpextauthservice>HTTPExtAuthService</a></em></td><td>true</td><td>HTTP defines the HTTP External Authorization service.<br>Either GRPCService or HTTPService must be specified,<br>and only one of them can be provided.</td></tr><tr><td><code>headersToExtAuth</code></td><td><em>string array</em></td><td>false</td><td>HeadersToExtAuth defines the client request headers that will be included<br>in the request to the external authorization service.<br>Note: If not specified, the default behavior for gRPC and HTTP external<br>authorization services is different due to backward compatibility reasons.<br>All headers will be included in the check request to a gRPC authorization server.<br>Only the following headers will be included in the check request to an HTTP<br>authorization server: Host, Method, Path, Content-Length, and Authorization.<br>And these headers will always be included to the check request to an HTTP<br>authorization server by default, no matter whether they are specified<br>in HeadersToExtAuth or not.</td></tr><tr><td><code>failOpen</code></td><td><em>boolean</em></td><td>false</td><td>FailOpen is a switch used to control the behavior when a response from the External Authorization service cannot be obtained.<br>If FailOpen is set to true, the system allows the traffic to pass through.<br>Otherwise, if it is set to false or not set (defaulting to false),<br>the system blocks the traffic and returns a HTTP 5xx error, reflecting a fail-closed approach.<br>This setting determines whether to prioritize accessibility over strict security in case of authorization service failure.</td></tr><tr><td><code>recomputeRoute</code></td><td><em>boolean</em></td><td>false</td><td>RecomputeRoute clears the route cache and recalculates the routing decision.<br>This field must be enabled if the headers added or modified by the ExtAuth are used for<br>route matching decisions. If the recomputation selects a new route, features targeting<br>the new matched route will be applied.</td></tr></tbody></table><h4 id=extproc>ExtProc<a class=td-heading-self-link href=#extproc aria-label="Heading self-link"></a></h4><p>ExtProc defines the configuration for External Processing filter.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicyspec>EnvoyExtensionPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>messageTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>MessageTimeout is the timeout for a response to be returned from the external processor<br>Default: 200ms</td></tr><tr><td><code>failOpen</code></td><td><em>boolean</em></td><td>false</td><td>FailOpen defines if requests or responses that cannot be processed due to connectivity to the<br>external processor are terminated or passed-through.<br>Default: false</td></tr><tr><td><code>processingMode</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extprocprocessingmode>ExtProcProcessingMode</a></em></td><td>false</td><td>ProcessingMode defines how request and response body is processed<br>Default: header and body are not sent to the external processor</td></tr></tbody></table><h4 id=extprocbodyprocessingmode>ExtProcBodyProcessingMode<a class=td-heading-self-link href=#extprocbodyprocessingmode aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#processingmodeoptions>ProcessingModeOptions</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Streamed</code></td><td>StreamedExtProcBodyProcessingMode will stream the body to the server in pieces as they arrive at the proxy.<br></td></tr><tr><td><code>Buffered</code></td><td>BufferedExtProcBodyProcessingMode will buffer the message body in memory and send the entire body at once. If the body exceeds the configured buffer limit, then the downstream system will receive an error.<br></td></tr><tr><td><code>BufferedPartial</code></td><td>BufferedPartialExtBodyHeaderProcessingMode will buffer the message body in memory and send the entire body in one chunk. If the body exceeds the configured buffer limit, then the body contents up to the buffer limit will be sent.<br></td></tr></tbody></table><h4 id=extprocprocessingmode>ExtProcProcessingMode<a class=td-heading-self-link href=#extprocprocessingmode aria-label="Heading self-link"></a></h4><p>ExtProcProcessingMode defines if and how headers and bodies are sent to the service.
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_proc/v3/processing_mode.proto#envoy-v3-api-msg-extensions-filters-http-ext-proc-v3-processingmode>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_proc/v3/processing_mode.proto#envoy-v3-api-msg-extensions-filters-http-ext-proc-v3-processingmode</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extproc>ExtProc</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>request</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#processingmodeoptions>ProcessingModeOptions</a></em></td><td>false</td><td>Defines processing mode for requests. If present, request headers are sent. Request body is processed according<br>to the specified mode.</td></tr><tr><td><code>response</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#processingmodeoptions>ProcessingModeOptions</a></em></td><td>false</td><td>Defines processing mode for responses. If present, response headers are sent. Response body is processed according<br>to the specified mode.</td></tr></tbody></table><h4 id=extensionapisettings>ExtensionAPISettings<a class=td-heading-self-link href=#extensionapisettings aria-label="Heading self-link"></a></h4><p>ExtensionAPISettings defines the settings specific to Gateway API Extensions.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>enableEnvoyPatchPolicy</code></td><td><em>boolean</em></td><td>true</td><td>EnableEnvoyPatchPolicy enables Envoy Gateway to<br>reconcile and implement the EnvoyPatchPolicy resources.</td></tr><tr><td><code>enableBackend</code></td><td><em>boolean</em></td><td>true</td><td>EnableBackend enables Envoy Gateway to<br>reconcile and implement the Backend resources.</td></tr></tbody></table><h4 id=extensionhooks>ExtensionHooks<a class=td-heading-self-link href=#extensionhooks aria-label="Heading self-link"></a></h4><p>ExtensionHooks defines extension hooks across all supported runners</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionmanager>ExtensionManager</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>xdsTranslator</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xdstranslatorhooks>XDSTranslatorHooks</a></em></td><td>true</td><td>XDSTranslator defines all the supported extension hooks for the xds-translator runner</td></tr></tbody></table><h4 id=extensionmanager>ExtensionManager<a class=td-heading-self-link href=#extensionmanager aria-label="Heading self-link"></a></h4><p>ExtensionManager defines the configuration for registering an extension manager to
the Envoy Gateway control plane.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>resources</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#groupversionkind>GroupVersionKind</a> array</em></td><td>false</td><td>Resources defines the set of K8s resources the extension will handle as route<br>filter resources</td></tr><tr><td><code>policyResources</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#groupversionkind>GroupVersionKind</a> array</em></td><td>false</td><td>PolicyResources defines the set of K8S resources the extension server will handle<br>as directly attached GatewayAPI policies</td></tr><tr><td><code>hooks</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionhooks>ExtensionHooks</a></em></td><td>true</td><td>Hooks defines the set of hooks the extension supports</td></tr><tr><td><code>service</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionservice>ExtensionService</a></em></td><td>true</td><td>Service defines the configuration of the extension service that the Envoy<br>Gateway Control Plane will call through extension hooks.</td></tr></tbody></table><h4 id=extensionservice>ExtensionService<a class=td-heading-self-link href=#extensionservice aria-label="Heading self-link"></a></h4><p>ExtensionService defines the configuration for connecting to a registered extension service.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionmanager>ExtensionManager</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>fqdn</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#fqdnendpoint>FQDNEndpoint</a></em></td><td>false</td><td>FQDN defines a FQDN endpoint</td></tr><tr><td><code>ip</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ipendpoint>IPEndpoint</a></em></td><td>false</td><td>IP defines an IP endpoint. Supports both IPv4 and IPv6 addresses.</td></tr><tr><td><code>unix</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#unixsocket>UnixSocket</a></em></td><td>false</td><td>Unix defines the unix domain socket endpoint</td></tr><tr><td><code>host</code></td><td><em>string</em></td><td>false</td><td>Host define the extension service hostname.<br>Deprecated: use the appropriate transport attribute instead (FQDN,IP,Unix)</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>false</td><td>Port defines the port the extension service is exposed on.<br>Deprecated: use the appropriate transport attribute instead (FQDN,IP,Unix)</td></tr><tr><td><code>tls</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensiontls>ExtensionTLS</a></em></td><td>false</td><td>TLS defines TLS configuration for communication between Envoy Gateway and<br>the extension service.</td></tr></tbody></table><h4 id=extensiontls>ExtensionTLS<a class=td-heading-self-link href=#extensiontls aria-label="Heading self-link"></a></h4><p>ExtensionTLS defines the TLS configuration when connecting to an extension service</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionservice>ExtensionService</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>certificateRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a></em></td><td>true</td><td>CertificateRef contains a references to objects (Kubernetes objects or otherwise) that<br>contains a TLS certificate and private keys. These certificates are used to<br>establish a TLS handshake to the extension server.<br><br>CertificateRef can only reference a Kubernetes Secret at this time.</td></tr></tbody></table><h4 id=fqdnendpoint>FQDNEndpoint<a class=td-heading-self-link href=#fqdnendpoint aria-label="Heading self-link"></a></h4><p>FQDNEndpoint describes TCP/UDP socket address, corresponding to Envoy&rsquo;s Socket Address
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-socketaddress>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-socketaddress</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendendpoint>BackendEndpoint</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionservice>ExtensionService</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>hostname</code></td><td><em>string</em></td><td>true</td><td>Hostname defines the FQDN hostname of the backend endpoint.</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>true</td><td>Port defines the port of the backend endpoint.</td></tr></tbody></table><h4 id=faultinjection>FaultInjection<a class=td-heading-self-link href=#faultinjection aria-label="Heading self-link"></a></h4><p>FaultInjection defines the fault injection policy to be applied. This configuration can be used to
inject delays and abort requests to mimic failure scenarios such as service failures and overloads</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>delay</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#faultinjectiondelay>FaultInjectionDelay</a></em></td><td>false</td><td>If specified, a delay will be injected into the request.</td></tr><tr><td><code>abort</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#faultinjectionabort>FaultInjectionAbort</a></em></td><td>false</td><td>If specified, the request will be aborted if it meets the configuration criteria.</td></tr></tbody></table><h4 id=faultinjectionabort>FaultInjectionAbort<a class=td-heading-self-link href=#faultinjectionabort aria-label="Heading self-link"></a></h4><p>FaultInjectionAbort defines the abort fault injection configuration</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#faultinjection>FaultInjection</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>httpStatus</code></td><td><em>integer</em></td><td>false</td><td>StatusCode specifies the HTTP status code to be returned</td></tr><tr><td><code>grpcStatus</code></td><td><em>integer</em></td><td>false</td><td>GrpcStatus specifies the GRPC status code to be returned</td></tr><tr><td><code>percentage</code></td><td><em>float</em></td><td>false</td><td>Percentage specifies the percentage of requests to be aborted. Default 100%, if set 0, no requests will be aborted. Accuracy to 0.0001%.</td></tr></tbody></table><h4 id=faultinjectiondelay>FaultInjectionDelay<a class=td-heading-self-link href=#faultinjectiondelay aria-label="Heading self-link"></a></h4><p>FaultInjectionDelay defines the delay fault injection configuration</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#faultinjection>FaultInjection</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>fixedDelay</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>true</td><td>FixedDelay specifies the fixed delay duration</td></tr><tr><td><code>percentage</code></td><td><em>float</em></td><td>false</td><td>Percentage specifies the percentage of requests to be delayed. Default 100%, if set 0, no requests will be delayed. Accuracy to 0.0001%.</td></tr></tbody></table><h4 id=fileenvoyproxyaccesslog>FileEnvoyProxyAccessLog<a class=td-heading-self-link href=#fileenvoyproxyaccesslog aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>path</code></td><td><em>string</em></td><td>true</td><td>Path defines the file path used to expose envoy access log(e.g. /dev/stdout).</td></tr></tbody></table><h4 id=filterposition>FilterPosition<a class=td-heading-self-link href=#filterposition aria-label="Heading self-link"></a></h4><p>FilterPosition defines the position of an Envoy HTTP filter in the filter chain.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyfilter>EnvoyFilter</a></em></td><td>true</td><td>Name of the filter.</td></tr><tr><td><code>before</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyfilter>EnvoyFilter</a></em></td><td>true</td><td>Before defines the filter that should come before the filter.<br>Only one of Before or After must be set.</td></tr><tr><td><code>after</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyfilter>EnvoyFilter</a></em></td><td>true</td><td>After defines the filter that should come after the filter.<br>Only one of Before or After must be set.</td></tr></tbody></table><h4 id=grpcactivehealthchecker>GRPCActiveHealthChecker<a class=td-heading-self-link href=#grpcactivehealthchecker aria-label="Heading self-link"></a></h4><p>GRPCActiveHealthChecker defines the settings of the GRPC health check.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheck>ActiveHealthCheck</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>service</code></td><td><em>string</em></td><td>false</td><td>Service to send in the health check request.<br>If this is not specified, then the health check request applies to the entire<br>server and not to a specific service.</td></tr></tbody></table><h4 id=grpcextauthservice>GRPCExtAuthService<a class=td-heading-self-link href=#grpcextauthservice aria-label="Heading self-link"></a></h4><p>GRPCExtAuthService defines the gRPC External Authorization service
The authorization request message is defined in
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/auth/v3/external_auth.proto>https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/auth/v3/external_auth.proto</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extauth>ExtAuth</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr></tbody></table><h4 id=gateway>Gateway<a class=td-heading-self-link href=#gateway aria-label="Heading self-link"></a></h4><p>Gateway defines the desired Gateway API configuration of Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>controllerName</code></td><td><em>string</em></td><td>false</td><td>ControllerName defines the name of the Gateway API controller. If unspecified,<br>defaults to &ldquo;gateway.envoyproxy.io/gatewayclass-controller&rdquo;. See the following<br>for additional details:<br><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GatewayClass>https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GatewayClass</a></td></tr></tbody></table><h4 id=globalratelimit>GlobalRateLimit<a class=td-heading-self-link href=#globalratelimit aria-label="Heading self-link"></a></h4><p>GlobalRateLimit defines global rate limit configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitspec>RateLimitSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>rules</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitrule>RateLimitRule</a> array</em></td><td>true</td><td>Rules are a list of RateLimit selectors and limits. Each rule and its<br>associated limit is applied in a mutually exclusive way. If a request<br>matches multiple rules, each of their associated limits get applied, so a<br>single request might increase the rate limit counters for multiple rules<br>if selected. The rate limit service will return a logical OR of the individual<br>rate limit decisions of all matching rules. For example, if a request<br>matches two rules, one rate limited and one not, the final decision will be<br>to rate limit the request.</td></tr></tbody></table><h4 id=groupversionkind>GroupVersionKind<a class=td-heading-self-link href=#groupversionkind aria-label="Heading self-link"></a></h4><p>GroupVersionKind unambiguously identifies a Kind.
It can be converted to k8s.io/apimachinery/pkg/runtime/schema.GroupVersionKind</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionmanager>ExtensionManager</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>group</code></td><td><em>string</em></td><td>true</td><td></td></tr><tr><td><code>version</code></td><td><em>string</em></td><td>true</td><td></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td>true</td><td></td></tr></tbody></table><h4 id=gzipcompressor>GzipCompressor<a class=td-heading-self-link href=#gzipcompressor aria-label="Heading self-link"></a></h4><p>GzipCompressor defines the config for the Gzip compressor.
The default values can be found here:
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/compression/gzip/compressor/v3/gzip.proto#extension-envoy-compression-gzip-compressor>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/compression/gzip/compressor/v3/gzip.proto#extension-envoy-compression-gzip-compressor</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#compression>Compression</a></li></ul><h4 id=http10settings>HTTP10Settings<a class=td-heading-self-link href=#http10settings aria-label="Heading self-link"></a></h4><p>HTTP10Settings provides HTTP/1.0 configuration on the listener.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http1settings>HTTP1Settings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>useDefaultHost</code></td><td><em>boolean</em></td><td>false</td><td>UseDefaultHost defines if the HTTP/1.0 request is missing the Host header,<br>then the hostname associated with the listener should be injected into the<br>request.<br>If this is not set and an HTTP/1.0 request arrives without a host, then<br>it will be rejected.</td></tr></tbody></table><h4 id=http1settings>HTTP1Settings<a class=td-heading-self-link href=#http1settings aria-label="Heading self-link"></a></h4><p>HTTP1Settings provides HTTP/1 configuration on the listener.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>enableTrailers</code></td><td><em>boolean</em></td><td>false</td><td>EnableTrailers defines if HTTP/1 trailers should be proxied by Envoy.</td></tr><tr><td><code>preserveHeaderCase</code></td><td><em>boolean</em></td><td>false</td><td>PreserveHeaderCase defines if Envoy should preserve the letter case of headers.<br>By default, Envoy will lowercase all the headers.</td></tr><tr><td><code>http10</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http10settings>HTTP10Settings</a></em></td><td>false</td><td>HTTP10 turns on support for HTTP/1.0 and HTTP/0.9 requests.</td></tr></tbody></table><h4 id=http2settings>HTTP2Settings<a class=td-heading-self-link href=#http2settings aria-label="Heading self-link"></a></h4><p>HTTP2Settings provides HTTP/2 configuration for listeners and backends.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>initialStreamWindowSize</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#quantity-resource-api>Quantity</a></em></td><td>false</td><td>InitialStreamWindowSize sets the initial window size for HTTP/2 streams.<br>If not set, the default value is 64 KiB(64*1024).</td></tr><tr><td><code>initialConnectionWindowSize</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#quantity-resource-api>Quantity</a></em></td><td>false</td><td>InitialConnectionWindowSize sets the initial window size for HTTP/2 connections.<br>If not set, the default value is 1 MiB.</td></tr><tr><td><code>maxConcurrentStreams</code></td><td><em>integer</em></td><td>false</td><td>MaxConcurrentStreams sets the maximum number of concurrent streams allowed per connection.<br>If not set, the default value is 100.</td></tr><tr><td><code>onInvalidMessage</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#invalidmessageaction>InvalidMessageAction</a></em></td><td>false</td><td>OnInvalidMessage determines if Envoy will terminate the connection or just the offending stream in the event of HTTP messaging error<br>It&rsquo;s recommended for L2 Envoy deployments to set this value to TerminateStream.<br><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/best_practices/level_two>https://www.envoyproxy.io/docs/envoy/latest/configuration/best_practices/level_two</a><br>Default: TerminateConnection</td></tr></tbody></table><h4 id=http3settings>HTTP3Settings<a class=td-heading-self-link href=#http3settings aria-label="Heading self-link"></a></h4><p>HTTP3Settings provides HTTP/3 configuration on the listener.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><h4 id=httpactivehealthchecker>HTTPActiveHealthChecker<a class=td-heading-self-link href=#httpactivehealthchecker aria-label="Heading self-link"></a></h4><p>HTTPActiveHealthChecker defines the settings of http health check.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheck>ActiveHealthCheck</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>path</code></td><td><em>string</em></td><td>true</td><td>Path defines the HTTP path that will be requested during health checking.</td></tr><tr><td><code>method</code></td><td><em>string</em></td><td>false</td><td>Method defines the HTTP method used for health checking.<br>Defaults to GET</td></tr><tr><td><code>expectedStatuses</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpstatus>HTTPStatus</a> array</em></td><td>false</td><td>ExpectedStatuses defines a list of HTTP response statuses considered healthy.<br>Defaults to 200 only</td></tr><tr><td><code>expectedResponse</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheckpayload>ActiveHealthCheckPayload</a></em></td><td>false</td><td>ExpectedResponse defines a list of HTTP expected responses to match.</td></tr></tbody></table><h4 id=httpclienttimeout>HTTPClientTimeout<a class=td-heading-self-link href=#httpclienttimeout aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttimeout>ClientTimeout</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>requestReceivedTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>RequestReceivedTimeout is the duration envoy waits for the complete request reception. This timer starts upon request<br>initiation and stops when either the last byte of the request is sent upstream or when the response begins.</td></tr><tr><td><code>idleTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>IdleTimeout for an HTTP connection. Idle time is defined as a period in which there are no active requests in the connection.<br>Default: 1 hour.</td></tr></tbody></table><h4 id=httpdirectresponsefilter>HTTPDirectResponseFilter<a class=td-heading-self-link href=#httpdirectresponsefilter aria-label="Heading self-link"></a></h4><p>HTTPDirectResponseFilter defines the configuration to return a fixed response.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httproutefilterspec>HTTPRouteFilterSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>contentType</code></td><td><em>string</em></td><td>false</td><td>Content Type of the response. This will be set in the Content-Type header.</td></tr><tr><td><code>body</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponsebody>CustomResponseBody</a></em></td><td>false</td><td>Body of the Response</td></tr><tr><td><code>statusCode</code></td><td><em>integer</em></td><td>false</td><td>Status Code of the HTTP response<br>If unset, defaults to 200.</td></tr></tbody></table><h4 id=httpextauthservice>HTTPExtAuthService<a class=td-heading-self-link href=#httpextauthservice aria-label="Heading self-link"></a></h4><p>HTTPExtAuthService defines the HTTP External Authorization service</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extauth>ExtAuth</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>path</code></td><td><em>string</em></td><td>true</td><td>Path is the path of the HTTP External Authorization service.<br>If path is specified, the authorization request will be sent to that path,<br>or else the authorization request will be sent to the root path.</td></tr><tr><td><code>headersToBackend</code></td><td><em>string array</em></td><td>false</td><td>HeadersToBackend are the authorization response headers that will be added<br>to the original client request before sending it to the backend server.<br>Note that coexisting headers will be overridden.<br>If not specified, no authorization response headers will be added to the<br>original client request.</td></tr></tbody></table><h4 id=httphostnamemodifier>HTTPHostnameModifier<a class=td-heading-self-link href=#httphostnamemodifier aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpurlrewritefilter>HTTPURLRewriteFilter</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httphostnamemodifiertype>HTTPHostnameModifierType</a></em></td><td>true</td><td></td></tr><tr><td><code>header</code></td><td><em>string</em></td><td>false</td><td>Header is the name of the header whose value would be used to rewrite the Host header</td></tr></tbody></table><h4 id=httphostnamemodifiertype>HTTPHostnameModifierType<a class=td-heading-self-link href=#httphostnamemodifiertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>HTTPPathModifierType defines the type of Hostname rewrite.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httphostnamemodifier>HTTPHostnameModifier</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Header</code></td><td>HeaderHTTPHostnameModifier indicates that the Host header value would be replaced with the value of the header specified in header.<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-routeaction-host-rewrite-header>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-routeaction-host-rewrite-header</a><br></td></tr><tr><td><code>Backend</code></td><td>BackendHTTPHostnameModifier indicates that the Host header value would be replaced by the DNS name of the backend if it exists.<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-routeaction-auto-host-rewrite>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-routeaction-auto-host-rewrite</a><br></td></tr></tbody></table><h4 id=httppathmodifier>HTTPPathModifier<a class=td-heading-self-link href=#httppathmodifier aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpurlrewritefilter>HTTPURLRewriteFilter</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httppathmodifiertype>HTTPPathModifierType</a></em></td><td>true</td><td></td></tr><tr><td><code>replaceRegexMatch</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#replaceregexmatch>ReplaceRegexMatch</a></em></td><td>false</td><td>ReplaceRegexMatch defines a path regex rewrite. The path portions matched by the regex pattern are replaced by the defined substitution.<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-routeaction-regex-rewrite>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-routeaction-regex-rewrite</a><br>Some examples:<br>(1) replaceRegexMatch:<br>pattern: ^/service/([^/]+)(/.<em>)$<br>substitution: \2/instance/\1<br>Would transform /service/foo/v1/api into /v1/api/instance/foo.<br>(2) replaceRegexMatch:<br>pattern: one<br>substitution: two<br>Would transform /xxx/one/yyy/one/zzz into /xxx/two/yyy/two/zzz.<br>(3) replaceRegexMatch:<br>pattern: ^(.</em>?)one(.*)$<br>substitution: \1two\2<br>Would transform /xxx/one/yyy/one/zzz into /xxx/two/yyy/one/zzz.<br>(3) replaceRegexMatch:<br>pattern: (?i)/xxx/<br>substitution: /yyy/<br>Would transform path /aaa/XxX/bbb into /aaa/yyy/bbb (case-insensitive).</td></tr></tbody></table><h4 id=httppathmodifiertype>HTTPPathModifierType<a class=td-heading-self-link href=#httppathmodifiertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>HTTPPathModifierType defines the type of path redirect or rewrite.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httppathmodifier>HTTPPathModifier</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>ReplaceRegexMatch</code></td><td>RegexHTTPPathModifier This type of modifier indicates that the portions of the path that match the specified<br>regex would be substituted with the specified substitution value<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/type/matcher/v3/regex.proto#type-matcher-v3-regexmatchandsubstitute>https://www.envoyproxy.io/docs/envoy/latest/api-v3/type/matcher/v3/regex.proto#type-matcher-v3-regexmatchandsubstitute</a><br></td></tr></tbody></table><h4 id=httproutefilter>HTTPRouteFilter<a class=td-heading-self-link href=#httproutefilter aria-label="Heading self-link"></a></h4><p>HTTPRouteFilter is a custom Envoy Gateway HTTPRouteFilter which provides extended
traffic processing options such as path regex rewrite, direct response and more.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>HTTPRouteFilter</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httproutefilterspec>HTTPRouteFilterSpec</a></em></td><td>true</td><td>Spec defines the desired state of HTTPRouteFilter.</td></tr></tbody></table><h4 id=httproutefilterspec>HTTPRouteFilterSpec<a class=td-heading-self-link href=#httproutefilterspec aria-label="Heading self-link"></a></h4><p>HTTPRouteFilterSpec defines the desired state of HTTPRouteFilter.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httproutefilter>HTTPRouteFilter</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>urlRewrite</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpurlrewritefilter>HTTPURLRewriteFilter</a></em></td><td>false</td><td></td></tr><tr><td><code>directResponse</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpdirectresponsefilter>HTTPDirectResponseFilter</a></em></td><td>false</td><td></td></tr></tbody></table><h4 id=httpstatus>HTTPStatus<a class=td-heading-self-link href=#httpstatus aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>integer</em></p><p>HTTPStatus defines the http status code.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpactivehealthchecker>HTTPActiveHealthChecker</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retryon>RetryOn</a></li></ul><h4 id=httptimeout>HTTPTimeout<a class=td-heading-self-link href=#httptimeout aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#timeout>Timeout</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>connectionIdleTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>The idle timeout for an HTTP connection. Idle time is defined as a period in which there are no active requests in the connection.<br>Default: 1 hour.</td></tr><tr><td><code>maxConnectionDuration</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>The maximum duration of an HTTP connection.<br>Default: unlimited.</td></tr><tr><td><code>requestTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>RequestTimeout is the time until which entire response is received from the upstream.</td></tr></tbody></table><h4 id=httpurlrewritefilter>HTTPURLRewriteFilter<a class=td-heading-self-link href=#httpurlrewritefilter aria-label="Heading self-link"></a></h4><p>HTTPURLRewriteFilter define rewrites of HTTP URL components such as path and host</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httproutefilterspec>HTTPRouteFilterSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>hostname</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httphostnamemodifier>HTTPHostnameModifier</a></em></td><td>false</td><td>Hostname is the value to be used to replace the Host header value during<br>forwarding.</td></tr><tr><td><code>path</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httppathmodifier>HTTPPathModifier</a></em></td><td>false</td><td>Path defines a path rewrite.</td></tr></tbody></table><h4 id=httpwasmcodesource>HTTPWasmCodeSource<a class=td-heading-self-link href=#httpwasmcodesource aria-label="Heading self-link"></a></h4><p>HTTPWasmCodeSource defines the HTTP URL containing the Wasm code.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasmcodesource>WasmCodeSource</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code></td><td><em>string</em></td><td>true</td><td>URL is the URL containing the Wasm code.</td></tr><tr><td><code>sha256</code></td><td><em>string</em></td><td>false</td><td>SHA256 checksum that will be used to verify the Wasm code.<br><br>If not specified, Envoy Gateway will not verify the downloaded Wasm code.<br>kubebuilder:validation:Pattern=<code>^[a-f0-9]\{64\}$</code></td></tr></tbody></table><h4 id=header>Header<a class=td-heading-self-link href=#header aria-label="Heading self-link"></a></h4><p>Header defines the header hashing configuration for consistent hash based
load balancing.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#consistenthash>ConsistentHash</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name of the header to hash.</td></tr></tbody></table><h4 id=headermatch>HeaderMatch<a class=td-heading-self-link href=#headermatch aria-label="Heading self-link"></a></h4><p>HeaderMatch defines the match attributes within the HTTP Headers of the request.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitselectcondition>RateLimitSelectCondition</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#headermatchtype>HeaderMatchType</a></em></td><td>false</td><td>Type specifies how to match against the value of the header.</td></tr><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name of the HTTP header.</td></tr><tr><td><code>value</code></td><td><em>string</em></td><td>false</td><td>Value within the HTTP header. Due to the<br>case-insensitivity of header names, &ldquo;foo&rdquo; and &ldquo;Foo&rdquo; are considered equivalent.<br>Do not set this field when Type=&ldquo;Distinct&rdquo;, implying matching on any/all unique<br>values within the header.</td></tr><tr><td><code>invert</code></td><td><em>boolean</em></td><td>false</td><td>Invert specifies whether the value match result will be inverted.<br>Do not set this field when Type=&ldquo;Distinct&rdquo;, implying matching on any/all unique<br>values within the header.</td></tr></tbody></table><h4 id=headermatchtype>HeaderMatchType<a class=td-heading-self-link href=#headermatchtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>HeaderMatchType specifies the semantics of how HTTP header values should be compared.
Valid HeaderMatchType values are &ldquo;Exact&rdquo;, &ldquo;RegularExpression&rdquo;, and &ldquo;Distinct&rdquo;.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#headermatch>HeaderMatch</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Exact</code></td><td>HeaderMatchExact matches the exact value of the Value field against the value of<br>the specified HTTP Header.<br></td></tr><tr><td><code>RegularExpression</code></td><td>HeaderMatchRegularExpression matches a regular expression against the value of the<br>specified HTTP Header. The regex string must adhere to the syntax documented in<br><a href=https://github.com/google/re2/wiki/Syntax>https://github.com/google/re2/wiki/Syntax</a>.<br></td></tr><tr><td><code>Distinct</code></td><td>HeaderMatchDistinct matches any and all possible unique values encountered in the<br>specified HTTP Header. Note that each unique value will receive its own rate limit<br>bucket.<br>Note: This is only supported for Global Rate Limits.<br></td></tr></tbody></table><h4 id=headersettings>HeaderSettings<a class=td-heading-self-link href=#headersettings aria-label="Heading self-link"></a></h4><p>HeaderSettings provides configuration options for headers on the listener.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>enableEnvoyHeaders</code></td><td><em>boolean</em></td><td>false</td><td>EnableEnvoyHeaders configures Envoy Proxy to add the &ldquo;X-Envoy-&rdquo; headers to requests<br>and responses.</td></tr><tr><td><code>disableRateLimitHeaders</code></td><td><em>boolean</em></td><td>false</td><td>DisableRateLimitHeaders configures Envoy Proxy to omit the &ldquo;X-RateLimit-&rdquo; response headers<br>when rate limiting is enabled.</td></tr><tr><td><code>xForwardedClientCert</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xforwardedclientcert>XForwardedClientCert</a></em></td><td>false</td><td>XForwardedClientCert configures how Envoy Proxy handle the x-forwarded-client-cert (XFCC) HTTP header.<br><br>x-forwarded-client-cert (XFCC) is an HTTP header used to forward the certificate<br>information of part or all of the clients or proxies that a request has flowed through,<br>on its way from the client to the server.<br><br>Envoy proxy may choose to sanitize/append/forward the XFCC header before proxying the request.<br><br>If not set, the default behavior is sanitizing the XFCC header.</td></tr><tr><td><code>withUnderscoresAction</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#withunderscoresaction>WithUnderscoresAction</a></em></td><td>false</td><td>WithUnderscoresAction configures the action to take when an HTTP header with underscores<br>is encountered. The default action is to reject the request.</td></tr><tr><td><code>preserveXRequestID</code></td><td><em>boolean</em></td><td>false</td><td>PreserveXRequestID configures Envoy to keep the X-Request-ID header if passed for a request that is edge<br>(Edge request is the request from external clients to front Envoy) and not reset it, which is the current Envoy behaviour.<br>It defaults to false.</td></tr><tr><td><code>earlyRequestHeaders</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpheaderfilter>HTTPHeaderFilter</a></em></td><td>false</td><td>EarlyRequestHeaders defines settings for early request header modification, before envoy performs<br>routing, tracing and built-in header manipulation.</td></tr></tbody></table><h4 id=healthcheck>HealthCheck<a class=td-heading-self-link href=#healthcheck aria-label="Heading self-link"></a></h4><p>HealthCheck configuration to decide which endpoints
are healthy and can be used for routing.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>active</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheck>ActiveHealthCheck</a></em></td><td>false</td><td>Active health check configuration</td></tr><tr><td><code>passive</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#passivehealthcheck>PassiveHealthCheck</a></em></td><td>false</td><td>Passive passive check configuration</td></tr></tbody></table><h4 id=healthchecksettings>HealthCheckSettings<a class=td-heading-self-link href=#healthchecksettings aria-label="Heading self-link"></a></h4><p>HealthCheckSettings provides HealthCheck configuration on the HTTP/HTTPS listener.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>path</code></td><td><em>string</em></td><td>true</td><td>Path specifies the HTTP path to match on for health check requests.</td></tr></tbody></table><h4 id=ipendpoint>IPEndpoint<a class=td-heading-self-link href=#ipendpoint aria-label="Heading self-link"></a></h4><p>IPEndpoint describes TCP/UDP socket address, corresponding to Envoy&rsquo;s Socket Address
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-socketaddress>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-socketaddress</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendendpoint>BackendEndpoint</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionservice>ExtensionService</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>address</code></td><td><em>string</em></td><td>true</td><td>Address defines the IP address of the backend endpoint.<br>Supports both IPv4 and IPv6 addresses.</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>true</td><td>Port defines the port of the backend endpoint.</td></tr></tbody></table><h4 id=ipfamily>IPFamily<a class=td-heading-self-link href=#ipfamily aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>IPFamily defines the IP family to use for the Envoy proxy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>IPv4</code></td><td>IPv4 defines the IPv4 family.<br></td></tr><tr><td><code>IPv6</code></td><td>IPv6 defines the IPv6 family.<br></td></tr><tr><td><code>DualStack</code></td><td>DualStack defines the dual-stack family.<br>When set to DualStack, Envoy proxy will listen on both IPv4 and IPv6 addresses<br>for incoming client traffic, enabling support for both IP protocol versions.<br></td></tr></tbody></table><h4 id=imagepullpolicy>ImagePullPolicy<a class=td-heading-self-link href=#imagepullpolicy aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ImagePullPolicy defines the policy to use when pulling an OIC image.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasmcodesource>WasmCodeSource</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>IfNotPresent</code></td><td>ImagePullPolicyIfNotPresent will only pull the image if it does not already exist in the EG cache.<br></td></tr><tr><td><code>Always</code></td><td>ImagePullPolicyAlways will pull the image when the EnvoyExtension resource version changes.<br>Note: EG does not update the Wasm module every time an Envoy proxy requests the Wasm module.<br></td></tr></tbody></table><h4 id=imagewasmcodesource>ImageWasmCodeSource<a class=td-heading-self-link href=#imagewasmcodesource aria-label="Heading self-link"></a></h4><p>ImageWasmCodeSource defines the OCI image containing the Wasm code.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasmcodesource>WasmCodeSource</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code></td><td><em>string</em></td><td>true</td><td>URL is the URL of the OCI image.<br>URL can be in the format of <code>registry/image:tag</code> or <code>registry/image@sha256:digest</code>.</td></tr><tr><td><code>sha256</code></td><td><em>string</em></td><td>false</td><td>SHA256 checksum that will be used to verify the OCI image.<br><br>It must match the digest of the OCI image.<br><br>If not specified, Envoy Gateway will not verify the downloaded OCI image.<br>kubebuilder:validation:Pattern=<code>^[a-f0-9]\{64\}$</code></td></tr><tr><td><code>pullSecretRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a></em></td><td>false</td><td>PullSecretRef is a reference to the secret containing the credentials to pull the image.<br>Only support Kubernetes Secret resource from the same namespace.</td></tr></tbody></table><h4 id=infrastructureprovidertype>InfrastructureProviderType<a class=td-heading-self-link href=#infrastructureprovidertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>InfrastructureProviderType defines the types of custom infrastructure providers supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Host</code></td><td>InfrastructureProviderTypeHost defines the &ldquo;Host&rdquo; provider.<br></td></tr></tbody></table><h4 id=invalidmessageaction>InvalidMessageAction<a class=td-heading-self-link href=#invalidmessageaction aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#http2settings>HTTP2Settings</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>TerminateConnection</code></td><td></td></tr><tr><td><code>TerminateStream</code></td><td></td></tr></tbody></table><h4 id=jsonpatchoperation>JSONPatchOperation<a class=td-heading-self-link href=#jsonpatchoperation aria-label="Heading self-link"></a></h4><p>JSONPatchOperation defines the JSON Patch Operation as defined in
<a href=https://datatracker.ietf.org/doc/html/rfc6902>https://datatracker.ietf.org/doc/html/rfc6902</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyjsonpatchconfig>EnvoyJSONPatchConfig</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxybootstrap>ProxyBootstrap</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>op</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jsonpatchoperationtype>JSONPatchOperationType</a></em></td><td>true</td><td>Op is the type of operation to perform</td></tr><tr><td><code>path</code></td><td><em>string</em></td><td>false</td><td>Path is a JSONPointer expression. Refer to <a href=https://datatracker.ietf.org/doc/html/rfc6901>https://datatracker.ietf.org/doc/html/rfc6901</a> for more details.<br>It specifies the location of the target document/field where the operation will be performed</td></tr><tr><td><code>jsonPath</code></td><td><em>string</em></td><td>false</td><td>JSONPath is a JSONPath expression. Refer to <a href=https://datatracker.ietf.org/doc/rfc9535/>https://datatracker.ietf.org/doc/rfc9535/</a> for more details.<br>It produces one or more JSONPointer expressions based on the given JSON document.<br>If no JSONPointer is found, it will result in an error.<br>If the &lsquo;Path&rsquo; property is also set, it will be appended to the resulting JSONPointer expressions from the JSONPath evaluation.<br>This is useful when creating a property that does not yet exist in the JSON document.<br>The final JSONPointer expressions specifies the locations in the target document/field where the operation will be applied.</td></tr><tr><td><code>from</code></td><td><em>string</em></td><td>false</td><td>From is the source location of the value to be copied or moved. Only valid<br>for move or copy operations<br>Refer to <a href=https://datatracker.ietf.org/doc/html/rfc6901>https://datatracker.ietf.org/doc/html/rfc6901</a> for more details.</td></tr><tr><td><code>value</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#json-v1-apiextensions-k8s-io>JSON</a></em></td><td>false</td><td>Value is the new value of the path location. The value is only used by<br>the <code>add</code> and <code>replace</code> operations.</td></tr></tbody></table><h4 id=jsonpatchoperationtype>JSONPatchOperationType<a class=td-heading-self-link href=#jsonpatchoperationtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>JSONPatchOperationType specifies the JSON Patch operations that can be performed.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jsonpatchoperation>JSONPatchOperation</a></li></ul><h4 id=jwt>JWT<a class=td-heading-self-link href=#jwt aria-label="Heading self-link"></a></h4><p>JWT defines the configuration for JSON Web Token (JWT) authentication.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>optional</code></td><td><em>boolean</em></td><td>true</td><td>Optional determines whether a missing JWT is acceptable, defaulting to false if not specified.<br>Note: Even if optional is set to true, JWT authentication will still fail if an invalid JWT is presented.</td></tr><tr><td><code>providers</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprovider>JWTProvider</a> array</em></td><td>true</td><td>Providers defines the JSON Web Token (JWT) authentication provider type.<br>When multiple JWT providers are specified, the JWT is considered valid if<br>any of the providers successfully validate the JWT. For additional details,<br>see <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/jwt_authn_filter.html>https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/jwt_authn_filter.html</a>.</td></tr></tbody></table><h4 id=jwtclaim>JWTClaim<a class=td-heading-self-link href=#jwtclaim aria-label="Heading self-link"></a></h4><p>JWTClaim specifies a claim in a JWT token.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprincipal>JWTPrincipal</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name is the name of the claim.<br>If it is a nested claim, use a dot (.) separated string as the name to<br>represent the full path to the claim.<br>For example, if the claim is in the &ldquo;department&rdquo; field in the &ldquo;organization&rdquo; field,<br>the name should be &ldquo;organization.department&rdquo;.</td></tr><tr><td><code>valueType</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtclaimvaluetype>JWTClaimValueType</a></em></td><td>false</td><td>ValueType is the type of the claim value.<br>Only String and StringArray types are supported for now.</td></tr><tr><td><code>values</code></td><td><em>string array</em></td><td>true</td><td>Values are the values that the claim must match.<br>If the claim is a string type, the specified value must match exactly.<br>If the claim is a string array type, the specified value must match one of the values in the array.<br>If multiple values are specified, one of the values must match for the rule to match.</td></tr></tbody></table><h4 id=jwtclaimvaluetype>JWTClaimValueType<a class=td-heading-self-link href=#jwtclaimvaluetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtclaim>JWTClaim</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>String</code></td><td></td></tr><tr><td><code>StringArray</code></td><td></td></tr></tbody></table><h4 id=jwtextractor>JWTExtractor<a class=td-heading-self-link href=#jwtextractor aria-label="Heading self-link"></a></h4><p>JWTExtractor defines a custom JWT token extraction from HTTP request.
If specified, Envoy will extract the JWT token from the listed extractors (headers, cookies, or params) and validate each of them.
If any value extracted is found to be an invalid JWT, a 401 error will be returned.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprovider>JWTProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>headers</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtheaderextractor>JWTHeaderExtractor</a> array</em></td><td>false</td><td>Headers represents a list of HTTP request headers to extract the JWT token from.</td></tr><tr><td><code>cookies</code></td><td><em>string array</em></td><td>false</td><td>Cookies represents a list of cookie names to extract the JWT token from.</td></tr><tr><td><code>params</code></td><td><em>string array</em></td><td>false</td><td>Params represents a list of query parameters to extract the JWT token from.</td></tr></tbody></table><h4 id=jwtheaderextractor>JWTHeaderExtractor<a class=td-heading-self-link href=#jwtheaderextractor aria-label="Heading self-link"></a></h4><p>JWTHeaderExtractor defines an HTTP header location to extract JWT token</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtextractor>JWTExtractor</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name is the HTTP header name to retrieve the token</td></tr><tr><td><code>valuePrefix</code></td><td><em>string</em></td><td>false</td><td>ValuePrefix is the prefix that should be stripped before extracting the token.<br>The format would be used by Envoy like &ldquo;{ValuePrefix}<token>&rdquo;.<br>For example, &ldquo;Authorization: Bearer <token>&rdquo;, then the ValuePrefix=&ldquo;Bearer " with a space at the end.</td></tr></tbody></table><h4 id=jwtprincipal>JWTPrincipal<a class=td-heading-self-link href=#jwtprincipal aria-label="Heading self-link"></a></h4><p>JWTPrincipal specifies the client identity of a request based on the JWT claims and scopes.
At least one of the claims or scopes must be specified.
Claims and scopes are And-ed together if both are specified.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#principal>Principal</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>provider</code></td><td><em>string</em></td><td>true</td><td>Provider is the name of the JWT provider that used to verify the JWT token.<br>In order to use JWT claims for authorization, you must configure the JWT<br>authentication with the same provider in the same <code>SecurityPolicy</code>.</td></tr><tr><td><code>claims</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtclaim>JWTClaim</a> array</em></td><td>false</td><td>Claims are the claims in a JWT token.<br><br>If multiple claims are specified, all claims must match for the rule to match.<br>For example, if there are two claims: one for the audience and one for the issuer,<br>the rule will match only if both the audience and the issuer match.</td></tr><tr><td><code>scopes</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtscope>JWTScope</a> array</em></td><td>false</td><td>Scopes are a special type of claim in a JWT token that represents the permissions of the client.<br><br>The value of the scopes field should be a space delimited string that is expected in the scope parameter,<br>as defined in RFC 6749: <a href=https://datatracker.ietf.org/doc/html/rfc6749#page-23>https://datatracker.ietf.org/doc/html/rfc6749#page-23</a>.<br><br>If multiple scopes are specified, all scopes must match for the rule to match.</td></tr></tbody></table><h4 id=jwtprovider>JWTProvider<a class=td-heading-self-link href=#jwtprovider aria-label="Heading self-link"></a></h4><p>JWTProvider defines how a JSON Web Token (JWT) can be verified.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwt>JWT</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name defines a unique name for the JWT provider. A name can have a variety of forms,<br>including RFC1123 subdomains, RFC 1123 labels, or RFC 1035 labels.</td></tr><tr><td><code>issuer</code></td><td><em>string</em></td><td>false</td><td>Issuer is the principal that issued the JWT and takes the form of a URL or email address.<br>For additional details, see <a href=https://tools.ietf.org/html/rfc7519#section-4.1.1>https://tools.ietf.org/html/rfc7519#section-4.1.1</a> for<br>URL format and <a href=https://rfc-editor.org/rfc/rfc5322.html>https://rfc-editor.org/rfc/rfc5322.html</a> for email format. If not provided,<br>the JWT issuer is not checked.</td></tr><tr><td><code>audiences</code></td><td><em>string array</em></td><td>false</td><td>Audiences is a list of JWT audiences allowed access. For additional details, see<br><a href=https://tools.ietf.org/html/rfc7519#section-4.1.3>https://tools.ietf.org/html/rfc7519#section-4.1.3</a>. If not provided, JWT audiences<br>are not checked.</td></tr><tr><td><code>remoteJWKS</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#remotejwks>RemoteJWKS</a></em></td><td>true</td><td>RemoteJWKS defines how to fetch and cache JSON Web Key Sets (JWKS) from a remote<br>HTTP/HTTPS endpoint.</td></tr><tr><td><code>claimToHeaders</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#claimtoheader>ClaimToHeader</a> array</em></td><td>false</td><td>ClaimToHeaders is a list of JWT claims that must be extracted into HTTP request headers<br>For examples, following config:<br>The claim must be of type; string, int, double, bool. Array type claims are not supported</td></tr><tr><td><code>recomputeRoute</code></td><td><em>boolean</em></td><td>false</td><td>RecomputeRoute clears the route cache and recalculates the routing decision.<br>This field must be enabled if the headers generated from the claim are used for<br>route matching decisions. If the recomputation selects a new route, features targeting<br>the new matched route will be applied.</td></tr><tr><td><code>extractFrom</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtextractor>JWTExtractor</a></em></td><td>false</td><td>ExtractFrom defines different ways to extract the JWT token from HTTP request.<br>If empty, it defaults to extract JWT token from the Authorization HTTP request header using Bearer schema<br>or access_token from query parameters.</td></tr></tbody></table><h4 id=jwtscope>JWTScope<a class=td-heading-self-link href=#jwtscope aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprincipal>JWTPrincipal</a></li></ul><h4 id=kubernetescontainerspec>KubernetesContainerSpec<a class=td-heading-self-link href=#kubernetescontainerspec aria-label="Heading self-link"></a></h4><p>KubernetesContainerSpec defines the desired state of the Kubernetes container resource.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdaemonsetspec>KubernetesDaemonSetSpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>env</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#envvar-v1-core>EnvVar</a> array</em></td><td>false</td><td>List of environment variables to set in the container.</td></tr><tr><td><code>resources</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#resourcerequirements-v1-core>ResourceRequirements</a></em></td><td>false</td><td>Resources required by this container.<br>More info: <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/>https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></td></tr><tr><td><code>securityContext</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#securitycontext-v1-core>SecurityContext</a></em></td><td>false</td><td>SecurityContext defines the security options the container should be run with.<br>If set, the fields of SecurityContext override the equivalent fields of PodSecurityContext.<br>More info: <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></td></tr><tr><td><code>image</code></td><td><em>string</em></td><td>false</td><td>Image specifies the EnvoyProxy container image to be used, instead of the default image.</td></tr><tr><td><code>volumeMounts</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#volumemount-v1-core>VolumeMount</a> array</em></td><td>false</td><td>VolumeMounts are volumes to mount into the container&rsquo;s filesystem.<br>Cannot be updated.</td></tr></tbody></table><h4 id=kubernetesdaemonsetspec>KubernetesDaemonSetSpec<a class=td-heading-self-link href=#kubernetesdaemonsetspec aria-label="Heading self-link"></a></h4><p>KubernetesDaemonSetSpec defines the desired state of the Kubernetes daemonset resource.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>patch</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespatchspec>KubernetesPatchSpec</a></em></td><td>false</td><td>Patch defines how to perform the patch operation to daemonset</td></tr><tr><td><code>strategy</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#daemonsetupdatestrategy-v1-apps>DaemonSetUpdateStrategy</a></em></td><td>false</td><td>The daemonset strategy to use to replace existing pods with new ones.</td></tr><tr><td><code>pod</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespodspec>KubernetesPodSpec</a></em></td><td>false</td><td>Pod defines the desired specification of pod.</td></tr><tr><td><code>container</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetescontainerspec>KubernetesContainerSpec</a></em></td><td>false</td><td>Container defines the desired specification of main container.</td></tr><tr><td><code>name</code></td><td><em>string</em></td><td>false</td><td>Name of the daemonSet.<br>When unset, this defaults to an autogenerated name.</td></tr></tbody></table><h4 id=kubernetesdeploymode>KubernetesDeployMode<a class=td-heading-self-link href=#kubernetesdeploymode aria-label="Heading self-link"></a></h4><p>KubernetesDeployMode holds configuration for how to deploy managed resources such as the Envoy Proxy
data plane fleet.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li></ul><h4 id=kubernetesdeploymentspec>KubernetesDeploymentSpec<a class=td-heading-self-link href=#kubernetesdeploymentspec aria-label="Heading self-link"></a></h4><p>KubernetesDeploymentSpec defines the desired state of the Kubernetes deployment resource.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>patch</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespatchspec>KubernetesPatchSpec</a></em></td><td>false</td><td>Patch defines how to perform the patch operation to deployment</td></tr><tr><td><code>replicas</code></td><td><em>integer</em></td><td>false</td><td>Replicas is the number of desired pods. Defaults to 1.</td></tr><tr><td><code>strategy</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#deploymentstrategy-v1-apps>DeploymentStrategy</a></em></td><td>false</td><td>The deployment strategy to use to replace existing pods with new ones.</td></tr><tr><td><code>pod</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespodspec>KubernetesPodSpec</a></em></td><td>false</td><td>Pod defines the desired specification of pod.</td></tr><tr><td><code>container</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetescontainerspec>KubernetesContainerSpec</a></em></td><td>false</td><td>Container defines the desired specification of main container.</td></tr><tr><td><code>initContainers</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#container-v1-core>Container</a> array</em></td><td>false</td><td>List of initialization containers belonging to the pod.<br>More info: <a href=https://kubernetes.io/docs/concepts/workloads/pods/init-containers/>https://kubernetes.io/docs/concepts/workloads/pods/init-containers/</a></td></tr><tr><td><code>name</code></td><td><em>string</em></td><td>false</td><td>Name of the deployment.<br>When unset, this defaults to an autogenerated name.</td></tr></tbody></table><h4 id=kuberneteshorizontalpodautoscalerspec>KubernetesHorizontalPodAutoscalerSpec<a class=td-heading-self-link href=#kuberneteshorizontalpodautoscalerspec aria-label="Heading self-link"></a></h4><p>KubernetesHorizontalPodAutoscalerSpec defines Kubernetes Horizontal Pod Autoscaler settings of Envoy Proxy Deployment.
When HPA is enabled, it is recommended that the value in <code>KubernetesDeploymentSpec.replicas</code> be removed, otherwise
Envoy Gateway will revert back to this value every time reconciliation occurs.
See k8s.io.autoscaling.v2.HorizontalPodAutoScalerSpec.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>minReplicas</code></td><td><em>integer</em></td><td>false</td><td>minReplicas is the lower limit for the number of replicas to which the autoscaler<br>can scale down. It defaults to 1 replica.</td></tr><tr><td><code>maxReplicas</code></td><td><em>integer</em></td><td>true</td><td>maxReplicas is the upper limit for the number of replicas to which the autoscaler can scale up.<br>It cannot be less that minReplicas.</td></tr><tr><td><code>metrics</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#metricspec-v2-autoscaling>MetricSpec</a> array</em></td><td>false</td><td>metrics contains the specifications for which to use to calculate the<br>desired replica count (the maximum replica count across all metrics will<br>be used).<br>If left empty, it defaults to being based on CPU utilization with average on 80% usage.</td></tr><tr><td><code>behavior</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#horizontalpodautoscalerbehavior-v2-autoscaling>HorizontalPodAutoscalerBehavior</a></em></td><td>false</td><td>behavior configures the scaling behavior of the target<br>in both Up and Down directions (scaleUp and scaleDown fields respectively).<br>If not set, the default HPAScalingRules for scale up and scale down are used.<br>See k8s.io.autoscaling.v2.HorizontalPodAutoScalerBehavior.</td></tr></tbody></table><h4 id=kubernetespatchspec>KubernetesPatchSpec<a class=td-heading-self-link href=#kubernetespatchspec aria-label="Heading self-link"></a></h4><p>KubernetesPatchSpec defines how to perform the patch operation.
Note that <code>value</code> can be an in-line YAML document, as can be seen in e.g. (the example of patching the Envoy proxy Deployment)[https://gateway.envoyproxy.io/docs/tasks/operations/customize-envoyproxy/#patching-deployment-for-envoyproxy].
Note also that, currently, strings containing literal JSON are <em>rejected</em>.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdaemonsetspec>KubernetesDaemonSetSpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesservicespec>KubernetesServiceSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#mergetype>MergeType</a></em></td><td>false</td><td>Type is the type of merge operation to perform<br><br>By default, StrategicMerge is used as the patch type.</td></tr><tr><td><code>value</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#json-v1-apiextensions-k8s-io>JSON</a></em></td><td>true</td><td>Object contains the raw configuration for merged object</td></tr></tbody></table><h4 id=kubernetespoddisruptionbudgetspec>KubernetesPodDisruptionBudgetSpec<a class=td-heading-self-link href=#kubernetespoddisruptionbudgetspec aria-label="Heading self-link"></a></h4><p>KubernetesPodDisruptionBudgetSpec defines Kubernetes PodDisruptionBudget settings of Envoy Proxy Deployment.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>minAvailable</code></td><td><em>integer</em></td><td>false</td><td>MinAvailable specifies the minimum number of pods that must be available at all times during voluntary disruptions,<br>such as node drains or updates. This setting ensures that your envoy proxy maintains a certain level of availability<br>and resilience during maintenance operations.</td></tr></tbody></table><h4 id=kubernetespodspec>KubernetesPodSpec<a class=td-heading-self-link href=#kubernetespodspec aria-label="Heading self-link"></a></h4><p>KubernetesPodSpec defines the desired state of the Kubernetes pod resource.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdaemonsetspec>KubernetesDaemonSetSpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>annotations</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>Annotations are the annotations that should be appended to the pods.<br>By default, no pod annotations are appended.</td></tr><tr><td><code>labels</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>Labels are the additional labels that should be tagged to the pods.<br>By default, no additional pod labels are tagged.</td></tr><tr><td><code>securityContext</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#podsecuritycontext-v1-core>PodSecurityContext</a></em></td><td>false</td><td>SecurityContext holds pod-level security attributes and common container settings.<br>Optional: Defaults to empty. See type description for default values of each field.</td></tr><tr><td><code>affinity</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#affinity-v1-core>Affinity</a></em></td><td>false</td><td>If specified, the pod&rsquo;s scheduling constraints.</td></tr><tr><td><code>tolerations</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#toleration-v1-core>Toleration</a> array</em></td><td>false</td><td>If specified, the pod&rsquo;s tolerations.</td></tr><tr><td><code>volumes</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#volume-v1-core>Volume</a> array</em></td><td>false</td><td>Volumes that can be mounted by containers belonging to the pod.<br>More info: <a href=https://kubernetes.io/docs/concepts/storage/volumes>https://kubernetes.io/docs/concepts/storage/volumes</a></td></tr><tr><td><code>imagePullSecrets</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#localobjectreference-v1-core>LocalObjectReference</a> array</em></td><td>false</td><td>ImagePullSecrets is an optional list of references to secrets<br>in the same namespace to use for pulling any of the images used by this PodSpec.<br>If specified, these secrets will be passed to individual puller implementations for them to use.<br>More info: <a href=https://kubernetes.io/docs/concepts/containers/images#specifying-imagepullsecrets-on-a-pod>https://kubernetes.io/docs/concepts/containers/images#specifying-imagepullsecrets-on-a-pod</a></td></tr><tr><td><code>nodeSelector</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>NodeSelector is a selector which must be true for the pod to fit on a node.<br>Selector which must match a node&rsquo;s labels for the pod to be scheduled on that node.<br>More info: <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/>https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</a></td></tr><tr><td><code>topologySpreadConstraints</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#topologyspreadconstraint-v1-core>TopologySpreadConstraint</a> array</em></td><td>false</td><td>TopologySpreadConstraints describes how a group of pods ought to spread across topology<br>domains. Scheduler will schedule pods in a way which abides by the constraints.<br>All topologySpreadConstraints are ANDed.</td></tr></tbody></table><h4 id=kubernetesservicespec>KubernetesServiceSpec<a class=td-heading-self-link href=#kubernetesservicespec aria-label="Heading self-link"></a></h4><p>KubernetesServiceSpec defines the desired state of the Kubernetes service resource.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>annotations</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>Annotations that should be appended to the service.<br>By default, no annotations are appended.</td></tr><tr><td><code>labels</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>Labels that should be appended to the service.<br>By default, no labels are appended.</td></tr><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#servicetype>ServiceType</a></em></td><td>false</td><td>Type determines how the Service is exposed. Defaults to LoadBalancer.<br>Valid options are ClusterIP, LoadBalancer and NodePort.<br>&ldquo;LoadBalancer&rdquo; means a service will be exposed via an external load balancer (if the cloud provider supports it).<br>&ldquo;ClusterIP&rdquo; means a service will only be accessible inside the cluster, via the cluster IP.<br>&ldquo;NodePort&rdquo; means a service will be exposed on a static Port on all Nodes of the cluster.</td></tr><tr><td><code>loadBalancerClass</code></td><td><em>string</em></td><td>false</td><td>LoadBalancerClass, when specified, allows for choosing the LoadBalancer provider<br>implementation if more than one are available or is otherwise expected to be specified</td></tr><tr><td><code>allocateLoadBalancerNodePorts</code></td><td><em>boolean</em></td><td>false</td><td>AllocateLoadBalancerNodePorts defines if NodePorts will be automatically allocated for<br>services with type LoadBalancer. Default is &ldquo;true&rdquo;. It may be set to &ldquo;false&rdquo; if the cluster<br>load-balancer does not rely on NodePorts. If the caller requests specific NodePorts (by specifying a<br>value), those requests will be respected, regardless of this field. This field may only be set for<br>services with type LoadBalancer and will be cleared if the type is changed to any other type.</td></tr><tr><td><code>loadBalancerSourceRanges</code></td><td><em>string array</em></td><td>false</td><td>LoadBalancerSourceRanges defines a list of allowed IP addresses which will be configured as<br>firewall rules on the platform providers load balancer. This is not guaranteed to be working as<br>it happens outside of kubernetes and has to be supported and handled by the platform provider.<br>This field may only be set for services with type LoadBalancer and will be cleared if the type<br>is changed to any other type.</td></tr><tr><td><code>loadBalancerIP</code></td><td><em>string</em></td><td>false</td><td>LoadBalancerIP defines the IP Address of the underlying load balancer service. This field<br>may be ignored if the load balancer provider does not support this feature.<br>This field has been deprecated in Kubernetes, but it is still used for setting the IP Address in some cloud<br>providers such as GCP.</td></tr><tr><td><code>externalTrafficPolicy</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#serviceexternaltrafficpolicy>ServiceExternalTrafficPolicy</a></em></td><td>false</td><td>ExternalTrafficPolicy determines the externalTrafficPolicy for the Envoy Service. Valid options<br>are Local and Cluster. Default is &ldquo;Local&rdquo;. &ldquo;Local&rdquo; means traffic will only go to pods on the node<br>receiving the traffic. &ldquo;Cluster&rdquo; means connections are loadbalanced to all pods in the cluster.</td></tr><tr><td><code>patch</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespatchspec>KubernetesPatchSpec</a></em></td><td>false</td><td>Patch defines how to perform the patch operation to the service</td></tr><tr><td><code>name</code></td><td><em>string</em></td><td>false</td><td>Name of the service.<br>When unset, this defaults to an autogenerated name.</td></tr></tbody></table><h4 id=kuberneteswatchmode>KubernetesWatchMode<a class=td-heading-self-link href=#kuberneteswatchmode aria-label="Heading self-link"></a></h4><p>KubernetesWatchMode holds the configuration for which input resources to watch and reconcile.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kuberneteswatchmodetype>KubernetesWatchModeType</a></em></td><td>true</td><td>Type indicates what watch mode to use. KubernetesWatchModeTypeNamespaces and<br>KubernetesWatchModeTypeNamespaceSelector are currently supported<br>By default, when this field is unset or empty, Envoy Gateway will watch for input namespaced resources<br>from all namespaces.</td></tr><tr><td><code>namespaces</code></td><td><em>string array</em></td><td>true</td><td>Namespaces holds the list of namespaces that Envoy Gateway will watch for namespaced scoped<br>resources such as Gateway, HTTPRoute and Service.<br>Note that Envoy Gateway will continue to reconcile relevant cluster scoped resources such as<br>GatewayClass that it is linked to. Precisely one of Namespaces and NamespaceSelector must be set.</td></tr><tr><td><code>namespaceSelector</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#labelselector-v1-meta>LabelSelector</a></em></td><td>true</td><td>NamespaceSelector holds the label selector used to dynamically select namespaces.<br>Envoy Gateway will watch for namespaces matching the specified label selector.<br>Precisely one of Namespaces and NamespaceSelector must be set.</td></tr></tbody></table><h4 id=kuberneteswatchmodetype>KubernetesWatchModeType<a class=td-heading-self-link href=#kuberneteswatchmodetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>KubernetesWatchModeType defines the type of KubernetesWatchMode</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kuberneteswatchmode>KubernetesWatchMode</a></li></ul><h4 id=leaderelection>LeaderElection<a class=td-heading-self-link href=#leaderelection aria-label="Heading self-link"></a></h4><p>LeaderElection defines the desired leader election settings.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>leaseDuration</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>true</td><td>LeaseDuration defines the time non-leader contenders will wait before attempting to claim leadership.<br>It&rsquo;s based on the timestamp of the last acknowledged signal. The default setting is 15 seconds.</td></tr><tr><td><code>renewDeadline</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>true</td><td>RenewDeadline represents the time frame within which the current leader will attempt to renew its leadership<br>status before relinquishing its position. The default setting is 10 seconds.</td></tr><tr><td><code>retryPeriod</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>true</td><td>RetryPeriod denotes the interval at which LeaderElector clients should perform action retries.<br>The default setting is 2 seconds.</td></tr><tr><td><code>disable</code></td><td><em>boolean</em></td><td>true</td><td>Disable provides the option to turn off leader election, which is enabled by default.</td></tr></tbody></table><h4 id=literalcustomtag>LiteralCustomTag<a class=td-heading-self-link href=#literalcustomtag aria-label="Heading self-link"></a></h4><p>LiteralCustomTag adds hard-coded value to each span.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customtag>CustomTag</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>value</code></td><td><em>string</em></td><td>true</td><td>Value defines the hard-coded value to add to each span.</td></tr></tbody></table><h4 id=loadbalancer>LoadBalancer<a class=td-heading-self-link href=#loadbalancer aria-label="Heading self-link"></a></h4><p>LoadBalancer defines the load balancer policy to be applied.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loadbalancertype>LoadBalancerType</a></em></td><td>true</td><td>Type decides the type of Load Balancer policy.<br>Valid LoadBalancerType values are<br>&ldquo;ConsistentHash&rdquo;,<br>&ldquo;LeastRequest&rdquo;,<br>&ldquo;Random&rdquo;,<br>&ldquo;RoundRobin&rdquo;.</td></tr><tr><td><code>consistentHash</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#consistenthash>ConsistentHash</a></em></td><td>false</td><td>ConsistentHash defines the configuration when the load balancer type is<br>set to ConsistentHash</td></tr><tr><td><code>slowStart</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#slowstart>SlowStart</a></em></td><td>false</td><td>SlowStart defines the configuration related to the slow start load balancer policy.<br>If set, during slow start window, traffic sent to the newly added hosts will gradually increase.<br>Currently this is only supported for RoundRobin and LeastRequest load balancers</td></tr></tbody></table><h4 id=loadbalancertype>LoadBalancerType<a class=td-heading-self-link href=#loadbalancertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>LoadBalancerType specifies the types of LoadBalancer.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loadbalancer>LoadBalancer</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>ConsistentHash</code></td><td>ConsistentHashLoadBalancerType load balancer policy.<br></td></tr><tr><td><code>LeastRequest</code></td><td>LeastRequestLoadBalancerType load balancer policy.<br></td></tr><tr><td><code>Random</code></td><td>RandomLoadBalancerType load balancer policy.<br></td></tr><tr><td><code>RoundRobin</code></td><td>RoundRobinLoadBalancerType load balancer policy.<br></td></tr></tbody></table><h4 id=localratelimit>LocalRateLimit<a class=td-heading-self-link href=#localratelimit aria-label="Heading self-link"></a></h4><p>LocalRateLimit defines local rate limit configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitspec>RateLimitSpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>rules</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitrule>RateLimitRule</a> array</em></td><td>false</td><td>Rules are a list of RateLimit selectors and limits. If a request matches<br>multiple rules, the strictest limit is applied. For example, if a request<br>matches two rules, one with 10rps and one with 20rps, the final limit will<br>be based on the rule with 10rps.</td></tr></tbody></table><h4 id=loglevel>LogLevel<a class=td-heading-self-link href=#loglevel aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>LogLevel defines a log level for Envoy Gateway and EnvoyProxy system logs.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaylogging>EnvoyGatewayLogging</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxylogging>ProxyLogging</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>debug</code></td><td>LogLevelDebug defines the &ldquo;debug&rdquo; logging level.<br></td></tr><tr><td><code>info</code></td><td>LogLevelInfo defines the &ldquo;Info&rdquo; logging level.<br></td></tr><tr><td><code>warn</code></td><td>LogLevelWarn defines the &ldquo;Warn&rdquo; logging level.<br></td></tr><tr><td><code>error</code></td><td>LogLevelError defines the &ldquo;Error&rdquo; logging level.<br></td></tr></tbody></table><h4 id=mergetype>MergeType<a class=td-heading-self-link href=#mergetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>MergeType defines the type of merge operation</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetespatchspec>KubernetesPatchSpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>StrategicMerge</code></td><td>StrategicMerge indicates a strategic merge patch type<br></td></tr><tr><td><code>JSONMerge</code></td><td>JSONMerge indicates a JSON merge patch type<br></td></tr></tbody></table><h4 id=metricsinktype>MetricSinkType<a class=td-heading-self-link href=#metricsinktype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaymetricsink>EnvoyGatewayMetricSink</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetricsink>ProxyMetricSink</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>OpenTelemetry</code></td><td></td></tr></tbody></table><h4 id=oidc>OIDC<a class=td-heading-self-link href=#oidc aria-label="Heading self-link"></a></h4><p>OIDC defines the configuration for the OpenID Connect (OIDC) authentication.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>provider</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidcprovider>OIDCProvider</a></em></td><td>true</td><td>The OIDC Provider configuration.</td></tr><tr><td><code>clientID</code></td><td><em>string</em></td><td>true</td><td>The client ID to be used in the OIDC<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.</td></tr><tr><td><code>clientSecret</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a></em></td><td>true</td><td>The Kubernetes secret which contains the OIDC client secret to be used in the<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.<br><br>This is an Opaque secret. The client secret should be stored in the key<br>&ldquo;client-secret&rdquo;.</td></tr><tr><td><code>cookieNames</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidccookienames>OIDCCookieNames</a></em></td><td>false</td><td>The optional cookie name overrides to be used for Bearer and IdToken cookies in the<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.<br>If not specified, uses a randomly generated suffix</td></tr><tr><td><code>cookieDomain</code></td><td><em>string</em></td><td>false</td><td>The optional domain to set the access and ID token cookies on.<br>If not set, the cookies will default to the host of the request, not including the subdomains.<br>If set, the cookies will be set on the specified domain and all subdomains.<br>This means that requests to any subdomain will not require reauthentication after users log in to the parent domain.</td></tr><tr><td><code>scopes</code></td><td><em>string array</em></td><td>false</td><td>The OIDC scopes to be used in the<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.<br>The &ldquo;openid&rdquo; scope is always added to the list of scopes if not already<br>specified.</td></tr><tr><td><code>resources</code></td><td><em>string array</em></td><td>false</td><td>The OIDC resources to be used in the<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.</td></tr><tr><td><code>redirectURL</code></td><td><em>string</em></td><td>true</td><td>The redirect URL to be used in the OIDC<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.<br>If not specified, uses the default redirect URI &ldquo;%REQ(x-forwarded-proto)%://%REQ(:authority)%/oauth2/callback&rdquo;</td></tr><tr><td><code>logoutPath</code></td><td><em>string</em></td><td>true</td><td>The path to log a user out, clearing their credential cookies.<br><br>If not specified, uses a default logout path &ldquo;/logout&rdquo;</td></tr><tr><td><code>forwardAccessToken</code></td><td><em>boolean</em></td><td>false</td><td>ForwardAccessToken indicates whether the Envoy should forward the access token<br>via the Authorization header Bearer scheme to the upstream.<br>If not specified, defaults to false.</td></tr><tr><td><code>defaultTokenTTL</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>DefaultTokenTTL is the default lifetime of the id token and access token.<br>Please note that Envoy will always use the expiry time from the response<br>of the authorization server if it is provided. This field is only used when<br>the expiry time is not provided by the authorization.<br><br>If not specified, defaults to 0. In this case, the &ldquo;expires_in&rdquo; field in<br>the authorization response must be set by the authorization server, or the<br>OAuth flow will fail.</td></tr><tr><td><code>refreshToken</code></td><td><em>boolean</em></td><td>false</td><td>RefreshToken indicates whether the Envoy should automatically refresh the<br>id token and access token when they expire.<br>When set to true, the Envoy will use the refresh token to get a new id token<br>and access token when they expire.<br><br>If not specified, defaults to false.</td></tr><tr><td><code>defaultRefreshTokenTTL</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>DefaultRefreshTokenTTL is the default lifetime of the refresh token.<br>This field is only used when the exp (expiration time) claim is omitted in<br>the refresh token or the refresh token is not JWT.<br><br>If not specified, defaults to 604800s (one week).<br>Note: this field is only applicable when the &ldquo;refreshToken&rdquo; field is set to true.</td></tr></tbody></table><h4 id=oidccookienames>OIDCCookieNames<a class=td-heading-self-link href=#oidccookienames aria-label="Heading self-link"></a></h4><p>OIDCCookieNames defines the names of cookies to use in the Envoy OIDC filter.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidc>OIDC</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>accessToken</code></td><td><em>string</em></td><td>false</td><td>The name of the cookie used to store the AccessToken in the<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.<br>If not specified, defaults to &ldquo;AccessToken-(randomly generated uid)&rdquo;</td></tr><tr><td><code>idToken</code></td><td><em>string</em></td><td>false</td><td>The name of the cookie used to store the IdToken in the<br><a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest>Authentication Request</a>.<br>If not specified, defaults to &ldquo;IdToken-(randomly generated uid)&rdquo;</td></tr></tbody></table><h4 id=oidcprovider>OIDCProvider<a class=td-heading-self-link href=#oidcprovider aria-label="Heading self-link"></a></h4><p>OIDCProvider defines the OIDC Provider configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidc>OIDC</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>issuer</code></td><td><em>string</em></td><td>true</td><td>The OIDC Provider&rsquo;s <a href=https://openid.net/specs/openid-connect-discovery-1_0.html#IssuerDiscovery>issuer identifier</a>.<br>Issuer MUST be a URI RFC 3986 [RFC3986] with a scheme component that MUST<br>be https, a host component, and optionally, port and path components and<br>no query or fragment components.</td></tr><tr><td><code>authorizationEndpoint</code></td><td><em>string</em></td><td>false</td><td>The OIDC Provider&rsquo;s <a href=https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint>authorization endpoint</a>.<br>If not provided, EG will try to discover it from the provider&rsquo;s <a href=https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationResponse>Well-Known Configuration Endpoint</a>.</td></tr><tr><td><code>tokenEndpoint</code></td><td><em>string</em></td><td>false</td><td>The OIDC Provider&rsquo;s <a href=https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint>token endpoint</a>.<br>If not provided, EG will try to discover it from the provider&rsquo;s <a href=https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationResponse>Well-Known Configuration Endpoint</a>.</td></tr></tbody></table><h4 id=opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog<a class=td-heading-self-link href=#opentelemetryenvoyproxyaccesslog aria-label="Heading self-link"></a></h4><p>OpenTelemetryEnvoyProxyAccessLog defines the OpenTelemetry access log sink.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>host</code></td><td><em>string</em></td><td>false</td><td>Host define the extension service hostname.<br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>false</td><td>Port defines the port the extension service is exposed on.<br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>resources</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>Resources is a set of labels that describe the source of a log entry, including envoy node info.<br>It&rsquo;s recommended to follow <a href=https://opentelemetry.io/docs/reference/specification/resource/semantic_conventions/>semantic conventions</a>.</td></tr></tbody></table><h4 id=origin>Origin<a class=td-heading-self-link href=#origin aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>Origin is defined by the scheme (protocol), hostname (domain), and port of
the URL used to access it. The hostname can be &ldquo;precise&rdquo; which is just the
domain name or &ldquo;wildcard&rdquo; which is a domain name prefixed with a single
wildcard label such as &ldquo;*.example.com&rdquo;.
In addition to that a single wildcard (with or without scheme) can be
configured to match any origin.</p><p>For example, the following are valid origins:</p><ul><li><a href=https://foo.example.com>https://foo.example.com</a></li><li>https://*.example.com</li><li><a href=http://foo.example.com:8080>http://foo.example.com:8080</a></li><li>http://*.example.com:8080</li><li>https://*</li></ul><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#cors>CORS</a></li></ul><h4 id=passivehealthcheck>PassiveHealthCheck<a class=td-heading-self-link href=#passivehealthcheck aria-label="Heading self-link"></a></h4><p>PassiveHealthCheck defines the configuration for passive health checks in the context of Envoy&rsquo;s Outlier Detection,
see <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/outlier>https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/outlier</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#healthcheck>HealthCheck</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>splitExternalLocalOriginErrors</code></td><td><em>boolean</em></td><td>false</td><td>SplitExternalLocalOriginErrors enables splitting of errors between external and local origin.</td></tr><tr><td><code>interval</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>Interval defines the time between passive health checks.</td></tr><tr><td><code>consecutiveLocalOriginFailures</code></td><td><em>integer</em></td><td>false</td><td>ConsecutiveLocalOriginFailures sets the number of consecutive local origin failures triggering ejection.<br>Parameter takes effect only when split_external_local_origin_errors is set to true.</td></tr><tr><td><code>consecutiveGatewayErrors</code></td><td><em>integer</em></td><td>false</td><td>ConsecutiveGatewayErrors sets the number of consecutive gateway errors triggering ejection.</td></tr><tr><td><code>consecutive5XxErrors</code></td><td><em>integer</em></td><td>false</td><td>Consecutive5xxErrors sets the number of consecutive 5xx errors triggering ejection.</td></tr><tr><td><code>baseEjectionTime</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>BaseEjectionTime defines the base duration for which a host will be ejected on consecutive failures.</td></tr><tr><td><code>maxEjectionPercent</code></td><td><em>integer</em></td><td>false</td><td>MaxEjectionPercent sets the maximum percentage of hosts in a cluster that can be ejected.</td></tr></tbody></table><h4 id=pathescapedslashaction>PathEscapedSlashAction<a class=td-heading-self-link href=#pathescapedslashaction aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>PathEscapedSlashAction determines the action for requests that contain %2F, %2f, %5C, or %5c
sequences in the URI path.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#pathsettings>PathSettings</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>KeepUnchanged</code></td><td>KeepUnchangedAction keeps escaped slashes as they arrive without changes<br></td></tr><tr><td><code>RejectRequest</code></td><td>RejectRequestAction rejects client requests containing escaped slashes<br>with a 400 status. gRPC requests will be rejected with the INTERNAL (13)<br>error code.<br>The &ldquo;httpN.downstream_rq_failed_path_normalization&rdquo; counter is incremented<br>for each rejected request.<br></td></tr><tr><td><code>UnescapeAndRedirect</code></td><td>UnescapeAndRedirect unescapes %2F and %5C sequences and redirects to the new path<br>if these sequences were present.<br>Redirect occurs after path normalization and merge slashes transformations if<br>they were configured. gRPC requests will be rejected with the INTERNAL (13)<br>error code.<br>This option minimizes possibility of path confusion exploits by forcing request<br>with unescaped slashes to traverse all parties: downstream client, intermediate<br>proxies, Envoy and upstream server.<br>The “httpN.downstream_rq_redirected_with_normalized_path” counter is incremented<br>for each redirected request.<br></td></tr><tr><td><code>UnescapeAndForward</code></td><td>UnescapeAndForward unescapes %2F and %5C sequences and forwards the request.<br>Note: this option should not be enabled if intermediaries perform path based access<br>control as it may lead to path confusion vulnerabilities.<br></td></tr></tbody></table><h4 id=pathsettings>PathSettings<a class=td-heading-self-link href=#pathsettings aria-label="Heading self-link"></a></h4><p>PathSettings provides settings that managing how the incoming path set by clients is handled.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>escapedSlashesAction</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#pathescapedslashaction>PathEscapedSlashAction</a></em></td><td>false</td><td>EscapedSlashesAction determines how %2f, %2F, %5c, or %5C sequences in the path URI<br>should be handled.<br>The default is UnescapeAndRedirect.</td></tr><tr><td><code>disableMergeSlashes</code></td><td><em>boolean</em></td><td>false</td><td>DisableMergeSlashes allows disabling the default configuration of merging adjacent<br>slashes in the path.<br>Note that slash merging is not part of the HTTP spec and is provided for convenience.</td></tr></tbody></table><h4 id=perretrypolicy>PerRetryPolicy<a class=td-heading-self-link href=#perretrypolicy aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retry>Retry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>timeout</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>Timeout is the timeout per retry attempt.</td></tr><tr><td><code>backOff</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backoffpolicy>BackOffPolicy</a></em></td><td>false</td><td>Backoff is the backoff policy to be applied per retry attempt. gateway uses a fully jittered exponential<br>back-off algorithm for retries. For additional details,<br>see <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#config-http-filters-router-x-envoy-max-retries>https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#config-http-filters-router-x-envoy-max-retries</a></td></tr></tbody></table><h4 id=policytargetreferences>PolicyTargetReferences<a class=td-heading-self-link href=#policytargetreferences aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicyspec>EnvoyExtensionPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>targetRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a></em></td><td>true</td><td>TargetRef is the name of the resource this policy is being attached to.<br>This policy and the TargetRef MUST be in the same namespace for this<br>Policy to have effect<br><br>Deprecated: use targetRefs/targetSelectors instead</td></tr><tr><td><code>targetRefs</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a> array</em></td><td>true</td><td>TargetRefs are the names of the Gateway resources this policy<br>is being attached to.</td></tr><tr><td><code>targetSelectors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#targetselector>TargetSelector</a> array</em></td><td>true</td><td>TargetSelectors allow targeting resources for this policy based on labels</td></tr></tbody></table><h4 id=principal>Principal<a class=td-heading-self-link href=#principal aria-label="Heading self-link"></a></h4><p>If there are multiple principal types, all principals must match for the rule to match.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorizationrule>AuthorizationRule</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>clientCIDRs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#cidr>CIDR</a> array</em></td><td>false</td><td>ClientCIDRs are the IP CIDR ranges of the client.<br>Valid examples are &ldquo;192.168.1.0/24&rdquo; or &ldquo;2001:db8::/64&rdquo;<br><br>If multiple CIDR ranges are specified, one of the CIDR ranges must match<br>the client IP for the rule to match.<br><br>The client IP is inferred from the X-Forwarded-For header, a custom header,<br>or the proxy protocol.<br>You can use the <code>ClientIPDetection</code> or the <code>EnableProxyProtocol</code> field in<br>the <code>ClientTrafficPolicy</code> to configure how the client IP is detected.</td></tr><tr><td><code>jwt</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprincipal>JWTPrincipal</a></em></td><td>false</td><td>JWT authorize the request based on the JWT claims and scopes.<br>Note: in order to use JWT claims for authorization, you must configure the<br>JWT authentication in the same <code>SecurityPolicy</code>.</td></tr></tbody></table><h4 id=processingmodeoptions>ProcessingModeOptions<a class=td-heading-self-link href=#processingmodeoptions aria-label="Heading self-link"></a></h4><p>ProcessingModeOptions defines if headers or body should be processed by the external service</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extprocprocessingmode>ExtProcProcessingMode</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>body</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extprocbodyprocessingmode>ExtProcBodyProcessingMode</a></em></td><td>false</td><td>Defines body processing mode</td></tr></tbody></table><h4 id=providertype>ProviderType<a class=td-heading-self-link href=#providertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ProviderType defines the types of providers supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayprovider>EnvoyGatewayProvider</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyprovider>EnvoyProxyProvider</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Kubernetes</code></td><td>ProviderTypeKubernetes defines the &ldquo;Kubernetes&rdquo; provider.<br></td></tr><tr><td><code>Custom</code></td><td>ProviderTypeCustom defines the &ldquo;Custom&rdquo; provider.<br></td></tr></tbody></table><h4 id=proxyaccesslog>ProxyAccessLog<a class=td-heading-self-link href=#proxyaccesslog aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytelemetry>ProxyTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>disable</code></td><td><em>boolean</em></td><td>true</td><td>Disable disables access logging for managed proxies if set to true.</td></tr><tr><td><code>settings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsetting>ProxyAccessLogSetting</a> array</em></td><td>false</td><td>Settings defines accesslog settings for managed proxies.<br>If unspecified, will send default format to stdout.</td></tr></tbody></table><h4 id=proxyaccesslogformat>ProxyAccessLogFormat<a class=td-heading-self-link href=#proxyaccesslogformat aria-label="Heading self-link"></a></h4><p>ProxyAccessLogFormat defines the format of accesslog.
By default accesslogs are written to standard output.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsetting>ProxyAccessLogSetting</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogformattype>ProxyAccessLogFormatType</a></em></td><td>true</td><td>Type defines the type of accesslog format.</td></tr><tr><td><code>text</code></td><td><em>string</em></td><td>false</td><td>Text defines the text accesslog format, following Envoy accesslog formatting,<br>It&rsquo;s required when the format type is &ldquo;Text&rdquo;.<br>Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators>command operators</a> may be used in the format.<br>The <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-strings>format string documentation</a> provides more information.</td></tr><tr><td><code>json</code></td><td><em>object (keys:string, values:string)</em></td><td>false</td><td>JSON is additional attributes that describe the specific event occurrence.<br>Structured format for the envoy access logs. Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators>command operators</a><br>can be used as values for fields within the Struct.<br>It&rsquo;s required when the format type is &ldquo;JSON&rdquo;.</td></tr></tbody></table><h4 id=proxyaccesslogformattype>ProxyAccessLogFormatType<a class=td-heading-self-link href=#proxyaccesslogformattype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogformat>ProxyAccessLogFormat</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Text</code></td><td>ProxyAccessLogFormatTypeText defines the text accesslog format.<br></td></tr><tr><td><code>JSON</code></td><td>ProxyAccessLogFormatTypeJSON defines the JSON accesslog format.<br></td></tr></tbody></table><h4 id=proxyaccesslogsetting>ProxyAccessLogSetting<a class=td-heading-self-link href=#proxyaccesslogsetting aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslog>ProxyAccessLog</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>format</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogformat>ProxyAccessLogFormat</a></em></td><td>false</td><td>Format defines the format of accesslog.<br>This will be ignored if sink type is ALS.</td></tr><tr><td><code>matches</code></td><td><em>string array</em></td><td>true</td><td>Matches defines the match conditions for accesslog in CEL expression.<br>An accesslog will be emitted only when one or more match conditions are evaluated to true.<br>Invalid <a href=https://www.envoyproxy.io/docs/envoy/latest/xds/type/v3/cel.proto.html#common-expression-language-cel-proto>CEL</a> expressions will be ignored.</td></tr><tr><td><code>sinks</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsink>ProxyAccessLogSink</a> array</em></td><td>true</td><td>Sinks defines the sinks of accesslog.</td></tr><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogtype>ProxyAccessLogType</a></em></td><td>false</td><td>Type defines the component emitting the accesslog, such as Listener and Route.<br>If type not defined, the setting would apply to:<br>(1) All Routes.<br>(2) Listeners if and only if Envoy does not find a matching route for a request.<br>If type is defined, the accesslog settings would apply to the relevant component (as-is).</td></tr></tbody></table><h4 id=proxyaccesslogsink>ProxyAccessLogSink<a class=td-heading-self-link href=#proxyaccesslogsink aria-label="Heading self-link"></a></h4><p>ProxyAccessLogSink defines the sink of accesslog.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsetting>ProxyAccessLogSetting</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsinktype>ProxyAccessLogSinkType</a></em></td><td>true</td><td>Type defines the type of accesslog sink.</td></tr><tr><td><code>als</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alsenvoyproxyaccesslog>ALSEnvoyProxyAccessLog</a></em></td><td>false</td><td>ALS defines the gRPC Access Log Service (ALS) sink.</td></tr><tr><td><code>file</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#fileenvoyproxyaccesslog>FileEnvoyProxyAccessLog</a></em></td><td>false</td><td>File defines the file accesslog sink.</td></tr><tr><td><code>openTelemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a></em></td><td>false</td><td>OpenTelemetry defines the OpenTelemetry accesslog sink.</td></tr></tbody></table><h4 id=proxyaccesslogsinktype>ProxyAccessLogSinkType<a class=td-heading-self-link href=#proxyaccesslogsinktype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>ALS</code></td><td>ProxyAccessLogSinkTypeALS defines the gRPC Access Log Service (ALS) sink.<br>The service must implement the Envoy gRPC Access Log Service streaming API:<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/accesslog/v3/als.proto>https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/accesslog/v3/als.proto</a><br></td></tr><tr><td><code>File</code></td><td>ProxyAccessLogSinkTypeFile defines the file accesslog sink.<br></td></tr><tr><td><code>OpenTelemetry</code></td><td>ProxyAccessLogSinkTypeOpenTelemetry defines the OpenTelemetry accesslog sink.<br>When the provider is Kubernetes, EnvoyGateway always sends <code>k8s.namespace.name</code><br>and <code>k8s.pod.name</code> as additional attributes.<br></td></tr></tbody></table><h4 id=proxyaccesslogtype>ProxyAccessLogType<a class=td-heading-self-link href=#proxyaccesslogtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslogsetting>ProxyAccessLogSetting</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Listener</code></td><td>ProxyAccessLogTypeListener defines the accesslog for Listeners.<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-field-config-listener-v3-listener-access-log>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-field-config-listener-v3-listener-access-log</a><br></td></tr><tr><td><code>Route</code></td><td>ProxyAccessLogTypeRoute defines the accesslog for HTTP, GRPC, UDP and TCP Routes.<br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/udp/udp_proxy/v3/udp_proxy.proto#envoy-v3-api-field-extensions-filters-udp-udp-proxy-v3-udpproxyconfig-access-log>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/udp/udp_proxy/v3/udp_proxy.proto#envoy-v3-api-field-extensions-filters-udp-udp-proxy-v3-udpproxyconfig-access-log</a><br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/tcp_proxy/v3/tcp_proxy.proto#envoy-v3-api-field-extensions-filters-network-tcp-proxy-v3-tcpproxy-access-log>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/tcp_proxy/v3/tcp_proxy.proto#envoy-v3-api-field-extensions-filters-network-tcp-proxy-v3-tcpproxy-access-log</a><br><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-access-log>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-access-log</a><br></td></tr></tbody></table><h4 id=proxybootstrap>ProxyBootstrap<a class=td-heading-self-link href=#proxybootstrap aria-label="Heading self-link"></a></h4><p>ProxyBootstrap defines Envoy Bootstrap configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#bootstraptype>BootstrapType</a></em></td><td>false</td><td>Type is the type of the bootstrap configuration, it should be either Replace, Merge, or JSONPatch.<br>If unspecified, it defaults to Replace.</td></tr><tr><td><code>value</code></td><td><em>string</em></td><td>false</td><td>Value is a YAML string of the bootstrap.</td></tr><tr><td><code>jsonPatches</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jsonpatchoperation>JSONPatchOperation</a> array</em></td><td>true</td><td>JSONPatches is an array of JSONPatches to be applied to the default bootstrap. Patches are<br>applied in the order in which they are defined.</td></tr></tbody></table><h4 id=proxylogcomponent>ProxyLogComponent<a class=td-heading-self-link href=#proxylogcomponent aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ProxyLogComponent defines a component that supports a configured logging level.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxylogging>ProxyLogging</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>default</code></td><td>LogComponentDefault defines the default logging component.<br>See more details: <a href=https://www.envoyproxy.io/docs/envoy/latest/operations/cli#cmdoption-l>https://www.envoyproxy.io/docs/envoy/latest/operations/cli#cmdoption-l</a><br></td></tr><tr><td><code>upstream</code></td><td>LogComponentUpstream defines the &ldquo;upstream&rdquo; logging component.<br></td></tr><tr><td><code>http</code></td><td>LogComponentHTTP defines the &ldquo;http&rdquo; logging component.<br></td></tr><tr><td><code>connection</code></td><td>LogComponentConnection defines the &ldquo;connection&rdquo; logging component.<br></td></tr><tr><td><code>admin</code></td><td>LogComponentAdmin defines the &ldquo;admin&rdquo; logging component.<br></td></tr><tr><td><code>client</code></td><td>LogComponentClient defines the &ldquo;client&rdquo; logging component.<br></td></tr><tr><td><code>filter</code></td><td>LogComponentFilter defines the &ldquo;filter&rdquo; logging component.<br></td></tr><tr><td><code>main</code></td><td>LogComponentMain defines the &ldquo;main&rdquo; logging component.<br></td></tr><tr><td><code>router</code></td><td>LogComponentRouter defines the &ldquo;router&rdquo; logging component.<br></td></tr><tr><td><code>runtime</code></td><td>LogComponentRuntime defines the &ldquo;runtime&rdquo; logging component.<br></td></tr></tbody></table><h4 id=proxylogging>ProxyLogging<a class=td-heading-self-link href=#proxylogging aria-label="Heading self-link"></a></h4><p>ProxyLogging defines logging parameters for managed proxies.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>level</code></td><td><em>object (keys:<a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxylogcomponent>ProxyLogComponent</a>, values:<a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loglevel>LogLevel</a>)</em></td><td>true</td><td>Level is a map of logging level per component, where the component is the key<br>and the log level is the value. If unspecified, defaults to &ldquo;default: warn&rdquo;.</td></tr></tbody></table><h4 id=proxymetricsink>ProxyMetricSink<a class=td-heading-self-link href=#proxymetricsink aria-label="Heading self-link"></a></h4><p>ProxyMetricSink defines the sink of metrics.
Default metrics sink is OpenTelemetry.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetrics>ProxyMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#metricsinktype>MetricSinkType</a></em></td><td>true</td><td>Type defines the metric sink type.<br>EG currently only supports OpenTelemetry.</td></tr><tr><td><code>openTelemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyopentelemetrysink>ProxyOpenTelemetrySink</a></em></td><td>false</td><td>OpenTelemetry defines the configuration for OpenTelemetry sink.<br>It&rsquo;s required if the sink type is OpenTelemetry.</td></tr></tbody></table><h4 id=proxymetrics>ProxyMetrics<a class=td-heading-self-link href=#proxymetrics aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytelemetry>ProxyTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>prometheus</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyprometheusprovider>ProxyPrometheusProvider</a></em></td><td>true</td><td>Prometheus defines the configuration for Admin endpoint <code>/stats/prometheus</code>.</td></tr><tr><td><code>sinks</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetricsink>ProxyMetricSink</a> array</em></td><td>true</td><td>Sinks defines the metric sinks where metrics are sent to.</td></tr><tr><td><code>matches</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#stringmatch>StringMatch</a> array</em></td><td>true</td><td>Matches defines configuration for selecting specific metrics instead of generating all metrics stats<br>that are enabled by default. This helps reduce CPU and memory overhead in Envoy, but eliminating some stats<br>may after critical functionality. Here are the stats that we strongly recommend not disabling:<br><code>cluster_manager.warming_clusters</code>, <code>cluster.&lt;cluster_name>.membership_total</code>,<code>cluster.&lt;cluster_name>.membership_healthy</code>,<br><code>cluster.&lt;cluster_name>.membership_degraded</code>，reference <a href=https://github.com/envoyproxy/envoy/issues/9856>https://github.com/envoyproxy/envoy/issues/9856</a>,<br><a href=https://github.com/envoyproxy/envoy/issues/14610>https://github.com/envoyproxy/envoy/issues/14610</a></td></tr><tr><td><code>enableVirtualHostStats</code></td><td><em>boolean</em></td><td>false</td><td>EnableVirtualHostStats enables envoy stat metrics for virtual hosts.</td></tr><tr><td><code>enablePerEndpointStats</code></td><td><em>boolean</em></td><td>false</td><td>EnablePerEndpointStats enables per endpoint envoy stats metrics.<br>Please use with caution.</td></tr><tr><td><code>enableRequestResponseSizesStats</code></td><td><em>boolean</em></td><td>false</td><td>EnableRequestResponseSizesStats enables publishing of histograms tracking header and body sizes of requests and responses.</td></tr></tbody></table><h4 id=proxyopentelemetrysink>ProxyOpenTelemetrySink<a class=td-heading-self-link href=#proxyopentelemetrysink aria-label="Heading self-link"></a></h4><p>ProxyOpenTelemetrySink defines the configuration for OpenTelemetry sink.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetricsink>ProxyMetricSink</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>host</code></td><td><em>string</em></td><td>false</td><td>Host define the service hostname.<br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>false</td><td>Port defines the port the service is exposed on.<br>Deprecated: Use BackendRefs instead.</td></tr></tbody></table><h4 id=proxyprometheusprovider>ProxyPrometheusProvider<a class=td-heading-self-link href=#proxyprometheusprovider aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetrics>ProxyMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>disable</code></td><td><em>boolean</em></td><td>true</td><td>Disable the Prometheus endpoint.</td></tr><tr><td><code>compression</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#compression>Compression</a></em></td><td>false</td><td>Configure the compression on Prometheus endpoint. Compression is useful in situations when bandwidth is scarce and large payloads can be effectively compressed at the expense of higher CPU load.</td></tr></tbody></table><h4 id=proxyprotocol>ProxyProtocol<a class=td-heading-self-link href=#proxyprotocol aria-label="Heading self-link"></a></h4><p>ProxyProtocol defines the configuration related to the proxy protocol
when communicating with the backend.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>version</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyprotocolversion>ProxyProtocolVersion</a></em></td><td>true</td><td>Version of ProxyProtol<br>Valid ProxyProtocolVersion values are<br>&ldquo;V1&rdquo;<br>&ldquo;V2&rdquo;</td></tr></tbody></table><h4 id=proxyprotocolversion>ProxyProtocolVersion<a class=td-heading-self-link href=#proxyprotocolversion aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ProxyProtocolVersion defines the version of the Proxy Protocol to use.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyprotocol>ProxyProtocol</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>V1</code></td><td>ProxyProtocolVersionV1 is the PROXY protocol version 1 (human readable format).<br></td></tr><tr><td><code>V2</code></td><td>ProxyProtocolVersionV2 is the PROXY protocol version 2 (binary format).<br></td></tr></tbody></table><h4 id=proxytelemetry>ProxyTelemetry<a class=td-heading-self-link href=#proxytelemetry aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>accessLog</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxyaccesslog>ProxyAccessLog</a></em></td><td>false</td><td>AccessLogs defines accesslog parameters for managed proxies.<br>If unspecified, will send default format to stdout.</td></tr><tr><td><code>tracing</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytracing>ProxyTracing</a></em></td><td>false</td><td>Tracing defines tracing configuration for managed proxies.<br>If unspecified, will not send tracing data.</td></tr><tr><td><code>metrics</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetrics>ProxyMetrics</a></em></td><td>true</td><td>Metrics defines metrics configuration for managed proxies.</td></tr></tbody></table><h4 id=proxytracing>ProxyTracing<a class=td-heading-self-link href=#proxytracing aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytelemetry>ProxyTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>samplingRate</code></td><td><em>integer</em></td><td>false</td><td>SamplingRate controls the rate at which traffic will be<br>selected for tracing if no prior sampling decision has been made.<br>Defaults to 100, valid values [0-100]. 100 indicates 100% sampling.</td></tr><tr><td><code>customTags</code></td><td><em>object (keys:string, values:<a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customtag>CustomTag</a>)</em></td><td>true</td><td>CustomTags defines the custom tags to add to each span.<br>If provider is kubernetes, pod name and namespace are added by default.</td></tr><tr><td><code>provider</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovider>TracingProvider</a></em></td><td>true</td><td>Provider defines the tracing provider.</td></tr></tbody></table><h4 id=ratelimit>RateLimit<a class=td-heading-self-link href=#ratelimit aria-label="Heading self-link"></a></h4><p>RateLimit defines the configuration associated with the Rate Limit Service
used for Global Rate Limiting.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backend</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitdatabasebackend>RateLimitDatabaseBackend</a></em></td><td>true</td><td>Backend holds the configuration associated with the<br>database backend used by the rate limit service to store<br>state associated with global ratelimiting.</td></tr><tr><td><code>timeout</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>Timeout specifies the timeout period for the proxy to access the ratelimit server<br>If not set, timeout is 20ms.</td></tr><tr><td><code>failClosed</code></td><td><em>boolean</em></td><td>true</td><td>FailClosed is a switch used to control the flow of traffic<br>when the response from the ratelimit server cannot be obtained.<br>If FailClosed is false, let the traffic pass,<br>otherwise, don&rsquo;t let the traffic pass and return 500.<br>If not set, FailClosed is False.</td></tr><tr><td><code>telemetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittelemetry>RateLimitTelemetry</a></em></td><td>false</td><td>Telemetry defines telemetry configuration for RateLimit.</td></tr></tbody></table><h4 id=ratelimitdatabasebackend>RateLimitDatabaseBackend<a class=td-heading-self-link href=#ratelimitdatabasebackend aria-label="Heading self-link"></a></h4><p>RateLimitDatabaseBackend defines the configuration associated with
the database backend used by the rate limit service.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimit>RateLimit</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitdatabasebackendtype>RateLimitDatabaseBackendType</a></em></td><td>true</td><td>Type is the type of database backend to use. Supported types are:<br>* Redis: Connects to a Redis database.</td></tr><tr><td><code>redis</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitredissettings>RateLimitRedisSettings</a></em></td><td>false</td><td>Redis defines the settings needed to connect to a Redis database.</td></tr></tbody></table><h4 id=ratelimitdatabasebackendtype>RateLimitDatabaseBackendType<a class=td-heading-self-link href=#ratelimitdatabasebackendtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>RateLimitDatabaseBackendType specifies the types of database backend
to be used by the rate limit service.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitdatabasebackend>RateLimitDatabaseBackend</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Redis</code></td><td>RedisBackendType uses a redis database for the rate limit service.<br></td></tr></tbody></table><h4 id=ratelimitmetrics>RateLimitMetrics<a class=td-heading-self-link href=#ratelimitmetrics aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittelemetry>RateLimitTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>prometheus</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitmetricsprometheusprovider>RateLimitMetricsPrometheusProvider</a></em></td><td>true</td><td>Prometheus defines the configuration for prometheus endpoint.</td></tr></tbody></table><h4 id=ratelimitmetricsprometheusprovider>RateLimitMetricsPrometheusProvider<a class=td-heading-self-link href=#ratelimitmetricsprometheusprovider aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitmetrics>RateLimitMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>disable</code></td><td><em>boolean</em></td><td>true</td><td>Disable the Prometheus endpoint.</td></tr></tbody></table><h4 id=ratelimitredissettings>RateLimitRedisSettings<a class=td-heading-self-link href=#ratelimitredissettings aria-label="Heading self-link"></a></h4><p>RateLimitRedisSettings defines the configuration for connecting to redis database.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitdatabasebackend>RateLimitDatabaseBackend</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code></td><td><em>string</em></td><td>true</td><td>URL of the Redis Database.</td></tr><tr><td><code>tls</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#redistlssettings>RedisTLSSettings</a></em></td><td>false</td><td>TLS defines TLS configuration for connecting to redis database.</td></tr></tbody></table><h4 id=ratelimitrule>RateLimitRule<a class=td-heading-self-link href=#ratelimitrule aria-label="Heading self-link"></a></h4><p>RateLimitRule defines the semantics for matching attributes
from the incoming requests, and setting limits for them.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#globalratelimit>GlobalRateLimit</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#localratelimit>LocalRateLimit</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>clientSelectors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitselectcondition>RateLimitSelectCondition</a> array</em></td><td>false</td><td>ClientSelectors holds the list of select conditions to select<br>specific clients using attributes from the traffic flow.<br>All individual select conditions must hold True for this rule<br>and its limit to be applied.<br><br>If no client selectors are specified, the rule applies to all traffic of<br>the targeted Route.<br><br>If the policy targets a Gateway, the rule applies to each Route of the Gateway.<br>Please note that each Route has its own rate limit counters. For example,<br>if a Gateway has two Routes, and the policy has a rule with limit 10rps,<br>each Route will have its own 10rps limit.</td></tr><tr><td><code>limit</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitvalue>RateLimitValue</a></em></td><td>true</td><td>Limit holds the rate limit values.<br>This limit is applied for traffic flows when the selectors<br>compute to True, causing the request to be counted towards the limit.<br>The limit is enforced and the request is ratelimited, i.e. a response with<br>429 HTTP status code is sent back to the client when<br>the selected requests have reached the limit.</td></tr></tbody></table><h4 id=ratelimitselectcondition>RateLimitSelectCondition<a class=td-heading-self-link href=#ratelimitselectcondition aria-label="Heading self-link"></a></h4><p>RateLimitSelectCondition specifies the attributes within the traffic flow that can
be used to select a subset of clients to be ratelimited.
All the individual conditions must hold True for the overall condition to hold True.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitrule>RateLimitRule</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>headers</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#headermatch>HeaderMatch</a> array</em></td><td>false</td><td>Headers is a list of request headers to match. Multiple header values are ANDed together,<br>meaning, a request MUST match all the specified headers.<br>At least one of headers or sourceCIDR condition must be specified.</td></tr><tr><td><code>sourceCIDR</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#sourcematch>SourceMatch</a></em></td><td>false</td><td>SourceCIDR is the client IP Address range to match on.<br>At least one of headers or sourceCIDR condition must be specified.</td></tr></tbody></table><h4 id=ratelimitspec>RateLimitSpec<a class=td-heading-self-link href=#ratelimitspec aria-label="Heading self-link"></a></h4><p>RateLimitSpec defines the desired state of RateLimitSpec.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittype>RateLimitType</a></em></td><td>true</td><td>Type decides the scope for the RateLimits.<br>Valid RateLimitType values are &ldquo;Global&rdquo; or &ldquo;Local&rdquo;.</td></tr><tr><td><code>global</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#globalratelimit>GlobalRateLimit</a></em></td><td>false</td><td>Global defines global rate limit configuration.</td></tr><tr><td><code>local</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#localratelimit>LocalRateLimit</a></em></td><td>false</td><td>Local defines local rate limit configuration.</td></tr></tbody></table><h4 id=ratelimittelemetry>RateLimitTelemetry<a class=td-heading-self-link href=#ratelimittelemetry aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimit>RateLimit</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>metrics</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitmetrics>RateLimitMetrics</a></em></td><td>true</td><td>Metrics defines metrics configuration for RateLimit.</td></tr><tr><td><code>tracing</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittracing>RateLimitTracing</a></em></td><td>true</td><td>Tracing defines traces configuration for RateLimit.</td></tr></tbody></table><h4 id=ratelimittracing>RateLimitTracing<a class=td-heading-self-link href=#ratelimittracing aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittelemetry>RateLimitTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>samplingRate</code></td><td><em>integer</em></td><td>false</td><td>SamplingRate controls the rate at which traffic will be<br>selected for tracing if no prior sampling decision has been made.<br>Defaults to 100, valid values [0-100]. 100 indicates 100% sampling.</td></tr><tr><td><code>provider</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittracingprovider>RateLimitTracingProvider</a></em></td><td>true</td><td>Provider defines the rateLimit tracing provider.<br>Only OpenTelemetry is supported currently.</td></tr></tbody></table><h4 id=ratelimittracingprovider>RateLimitTracingProvider<a class=td-heading-self-link href=#ratelimittracingprovider aria-label="Heading self-link"></a></h4><p>RateLimitTracingProvider defines the tracing provider configuration of RateLimit</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittracing>RateLimitTracing</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittracingprovidertype>RateLimitTracingProviderType</a></em></td><td>true</td><td>Type defines the tracing provider type.<br>Since to RateLimit Exporter currently using OpenTelemetry, only OpenTelemetry is supported</td></tr><tr><td><code>url</code></td><td><em>string</em></td><td>true</td><td>URL is the endpoint of the trace collector that supports the OTLP protocol</td></tr></tbody></table><h4 id=ratelimittracingprovidertype>RateLimitTracingProviderType<a class=td-heading-self-link href=#ratelimittracingprovidertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimittracingprovider>RateLimitTracingProvider</a></li></ul><h4 id=ratelimittype>RateLimitType<a class=td-heading-self-link href=#ratelimittype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>RateLimitType specifies the types of RateLimiting.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitspec>RateLimitSpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Global</code></td><td>GlobalRateLimitType allows the rate limits to be applied across all Envoy<br>proxy instances.<br></td></tr><tr><td><code>Local</code></td><td>LocalRateLimitType allows the rate limits to be applied on a per Envoy<br>proxy instance basis.<br></td></tr></tbody></table><h4 id=ratelimitunit>RateLimitUnit<a class=td-heading-self-link href=#ratelimitunit aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>RateLimitUnit specifies the intervals for setting rate limits.
Valid RateLimitUnit values are &ldquo;Second&rdquo;, &ldquo;Minute&rdquo;, &ldquo;Hour&rdquo;, and &ldquo;Day&rdquo;.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitvalue>RateLimitValue</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Second</code></td><td>RateLimitUnitSecond specifies the rate limit interval to be 1 second.<br></td></tr><tr><td><code>Minute</code></td><td>RateLimitUnitMinute specifies the rate limit interval to be 1 minute.<br></td></tr><tr><td><code>Hour</code></td><td>RateLimitUnitHour specifies the rate limit interval to be 1 hour.<br></td></tr><tr><td><code>Day</code></td><td>RateLimitUnitDay specifies the rate limit interval to be 1 day.<br></td></tr></tbody></table><h4 id=ratelimitvalue>RateLimitValue<a class=td-heading-self-link href=#ratelimitvalue aria-label="Heading self-link"></a></h4><p>RateLimitValue defines the limits for rate limiting.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitrule>RateLimitRule</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>requests</code></td><td><em>integer</em></td><td>true</td><td></td></tr><tr><td><code>unit</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitunit>RateLimitUnit</a></em></td><td>true</td><td></td></tr></tbody></table><h4 id=redistlssettings>RedisTLSSettings<a class=td-heading-self-link href=#redistlssettings aria-label="Heading self-link"></a></h4><p>RedisTLSSettings defines the TLS configuration for connecting to redis database.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitredissettings>RateLimitRedisSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>certificateRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a></em></td><td>false</td><td>CertificateRef defines the client certificate reference for TLS connections.<br>Currently only a Kubernetes Secret of type TLS is supported.</td></tr></tbody></table><h4 id=remotejwks>RemoteJWKS<a class=td-heading-self-link href=#remotejwks aria-label="Heading self-link"></a></h4><p>RemoteJWKS defines how to fetch and cache JSON Web Key Sets (JWKS) from a remote
HTTP/HTTPS endpoint.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwtprovider>JWTProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>uri</code></td><td><em>string</em></td><td>true</td><td>URI is the HTTPS URI to fetch the JWKS. Envoy&rsquo;s system trust bundle is used to<br>validate the server certificate.</td></tr></tbody></table><h4 id=replaceregexmatch>ReplaceRegexMatch<a class=td-heading-self-link href=#replaceregexmatch aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httppathmodifier>HTTPPathModifier</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>pattern</code></td><td><em>string</em></td><td>true</td><td>Pattern matches a regular expression against the value of the HTTP Path.The regex string must<br>adhere to the syntax documented in <a href=https://github.com/google/re2/wiki/Syntax>https://github.com/google/re2/wiki/Syntax</a>.</td></tr><tr><td><code>substitution</code></td><td><em>string</em></td><td>true</td><td>Substitution is an expression that replaces the matched portion.The expression may include numbered<br>capture groups that adhere to syntax documented in <a href=https://github.com/google/re2/wiki/Syntax>https://github.com/google/re2/wiki/Syntax</a>.</td></tr></tbody></table><h4 id=requestheadercustomtag>RequestHeaderCustomTag<a class=td-heading-self-link href=#requestheadercustomtag aria-label="Heading self-link"></a></h4><p>RequestHeaderCustomTag adds value from request header to each span.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customtag>CustomTag</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>true</td><td>Name defines the name of the request header which to extract the value from.</td></tr><tr><td><code>defaultValue</code></td><td><em>string</em></td><td>false</td><td>DefaultValue defines the default value to use if the request header is not set.</td></tr></tbody></table><h4 id=resourceprovidertype>ResourceProviderType<a class=td-heading-self-link href=#resourceprovidertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ResourceProviderType defines the types of custom resource providers supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewayresourceprovider>EnvoyGatewayResourceProvider</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>File</code></td><td>ResourceProviderTypeFile defines the &ldquo;File&rdquo; provider.<br></td></tr></tbody></table><h4 id=responseoverride>ResponseOverride<a class=td-heading-self-link href=#responseoverride aria-label="Heading self-link"></a></h4><p>ResponseOverride defines the configuration to override specific responses with a custom one.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>match</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponsematch>CustomResponseMatch</a></em></td><td>true</td><td>Match configuration.</td></tr><tr><td><code>response</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponse>CustomResponse</a></em></td><td>true</td><td>Response configuration.</td></tr></tbody></table><h4 id=responsevaluetype>ResponseValueType<a class=td-heading-self-link href=#responsevaluetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ResponseValueType defines the types of values for the response body supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponsebody>CustomResponseBody</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Inline</code></td><td>ResponseValueTypeInline defines the &ldquo;Inline&rdquo; response body type.<br></td></tr><tr><td><code>ValueRef</code></td><td>ResponseValueTypeValueRef defines the &ldquo;ValueRef&rdquo; response body type.<br></td></tr></tbody></table><h4 id=retry>Retry<a class=td-heading-self-link href=#retry aria-label="Heading self-link"></a></h4><p>Retry defines the retry strategy to be applied.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>numRetries</code></td><td><em>integer</em></td><td>false</td><td>NumRetries is the number of retries to be attempted. Defaults to 2.</td></tr><tr><td><code>retryOn</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retryon>RetryOn</a></em></td><td>false</td><td>RetryOn specifies the retry trigger condition.<br><br>If not specified, the default is to retry on connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes(503).</td></tr><tr><td><code>perRetry</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#perretrypolicy>PerRetryPolicy</a></em></td><td>false</td><td>PerRetry is the retry policy to be applied per retry attempt.</td></tr></tbody></table><h4 id=retryon>RetryOn<a class=td-heading-self-link href=#retryon aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retry>Retry</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>triggers</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#triggerenum>TriggerEnum</a> array</em></td><td>false</td><td>Triggers specifies the retry trigger condition(Http/Grpc).</td></tr><tr><td><code>httpStatusCodes</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpstatus>HTTPStatus</a> array</em></td><td>false</td><td>HttpStatusCodes specifies the http status codes to be retried.<br>The retriable-status-codes trigger must also be configured for these status codes to trigger a retry.</td></tr></tbody></table><h4 id=routingtype>RoutingType<a class=td-heading-self-link href=#routingtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>RoutingType defines the type of routing of this Envoy proxy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Service</code></td><td>ServiceRoutingType is the RoutingType for Service Cluster IP routing.<br></td></tr><tr><td><code>Endpoint</code></td><td>EndpointRoutingType is the RoutingType for Endpoint routing.<br></td></tr></tbody></table><h4 id=securitypolicy>SecurityPolicy<a class=td-heading-self-link href=#securitypolicy aria-label="Heading self-link"></a></h4><p>SecurityPolicy allows the user to configure various security settings for a
Gateway.</p><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></td><td><em>string</em></td><td></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code></td><td><em>string</em></td><td></td><td><code>SecurityPolicy</code></td></tr><tr><td><code>metadata</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>true</td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></em></td><td>true</td><td>Spec defines the desired state of SecurityPolicy.</td></tr><tr><td><code>status</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.PolicyStatus>PolicyStatus</a></em></td><td>true</td><td>Status defines the current status of SecurityPolicy.</td></tr></tbody></table><h4 id=securitypolicyspec>SecurityPolicySpec<a class=td-heading-self-link href=#securitypolicyspec aria-label="Heading self-link"></a></h4><p>SecurityPolicySpec defines the desired state of SecurityPolicy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicy>SecurityPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>targetRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a></em></td><td>true</td><td>TargetRef is the name of the resource this policy is being attached to.<br>This policy and the TargetRef MUST be in the same namespace for this<br>Policy to have effect<br><br>Deprecated: use targetRefs/targetSelectors instead</td></tr><tr><td><code>targetRefs</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.LocalPolicyTargetReferenceWithSectionName>LocalPolicyTargetReferenceWithSectionName</a> array</em></td><td>true</td><td>TargetRefs are the names of the Gateway resources this policy<br>is being attached to.</td></tr><tr><td><code>targetSelectors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#targetselector>TargetSelector</a> array</em></td><td>true</td><td>TargetSelectors allow targeting resources for this policy based on labels</td></tr><tr><td><code>cors</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#cors>CORS</a></em></td><td>false</td><td>CORS defines the configuration for Cross-Origin Resource Sharing (CORS).</td></tr><tr><td><code>basicAuth</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#basicauth>BasicAuth</a></em></td><td>false</td><td>BasicAuth defines the configuration for the HTTP Basic Authentication.</td></tr><tr><td><code>jwt</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#jwt>JWT</a></em></td><td>false</td><td>JWT defines the configuration for JSON Web Token (JWT) authentication.</td></tr><tr><td><code>oidc</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#oidc>OIDC</a></em></td><td>false</td><td>OIDC defines the configuration for the OpenID Connect (OIDC) authentication.</td></tr><tr><td><code>extAuth</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extauth>ExtAuth</a></em></td><td>false</td><td>ExtAuth defines the configuration for External Authorization.</td></tr><tr><td><code>authorization</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#authorization>Authorization</a></em></td><td>false</td><td>Authorization defines the authorization configuration.</td></tr></tbody></table><h4 id=serviceexternaltrafficpolicy>ServiceExternalTrafficPolicy<a class=td-heading-self-link href=#serviceexternaltrafficpolicy aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ServiceExternalTrafficPolicy describes how nodes distribute service traffic they
receive on one of the Service&rsquo;s &ldquo;externally-facing&rdquo; addresses (NodePorts, ExternalIPs,
and LoadBalancer IPs.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesservicespec>KubernetesServiceSpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Cluster</code></td><td>ServiceExternalTrafficPolicyCluster routes traffic to all endpoints.<br></td></tr><tr><td><code>Local</code></td><td>ServiceExternalTrafficPolicyLocal preserves the source IP of the traffic by<br>routing only to endpoints on the same node as the traffic was received on<br>(dropping the traffic if there are no local endpoints).<br></td></tr></tbody></table><h4 id=servicetype>ServiceType<a class=td-heading-self-link href=#servicetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>ServiceType string describes ingress methods for a service</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kubernetesservicespec>KubernetesServiceSpec</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>ClusterIP</code></td><td>ServiceTypeClusterIP means a service will only be accessible inside the<br>cluster, via the cluster IP.<br></td></tr><tr><td><code>LoadBalancer</code></td><td>ServiceTypeLoadBalancer means a service will be exposed via an<br>external load balancer (if the cloud provider supports it).<br></td></tr><tr><td><code>NodePort</code></td><td>ServiceTypeNodePort means a service will be exposed on each Kubernetes Node<br>at a static Port, common across all Nodes.<br></td></tr></tbody></table><h4 id=session>Session<a class=td-heading-self-link href=#session aria-label="Heading self-link"></a></h4><p>Session defines settings related to TLS session management.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttlssettings>ClientTLSSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>resumption</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#sessionresumption>SessionResumption</a></em></td><td>false</td><td>Resumption determines the proxy&rsquo;s supported TLS session resumption option.<br>By default, Envoy Gateway does not enable session resumption. Use sessionResumption to<br>enable stateful and stateless session resumption. Users should consider security impacts<br>of different resumption methods. Performance gains from resumption are diminished when<br>Envoy proxy is deployed with more than one replica.</td></tr></tbody></table><h4 id=sessionresumption>SessionResumption<a class=td-heading-self-link href=#sessionresumption aria-label="Heading self-link"></a></h4><p>SessionResumption defines supported tls session resumption methods and their associated configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#session>Session</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>stateless</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statelesstlssessionresumption>StatelessTLSSessionResumption</a></em></td><td>false</td><td>Stateless defines setting for stateless (session-ticket based) session resumption</td></tr><tr><td><code>stateful</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statefultlssessionresumption>StatefulTLSSessionResumption</a></em></td><td>false</td><td>Stateful defines setting for stateful (session-id based) session resumption</td></tr></tbody></table><h4 id=shutdownconfig>ShutdownConfig<a class=td-heading-self-link href=#shutdownconfig aria-label="Heading self-link"></a></h4><p>ShutdownConfig defines configuration for graceful envoy shutdown process.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>drainTimeout</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>DrainTimeout defines the graceful drain timeout. This should be less than the pod&rsquo;s terminationGracePeriodSeconds.<br>If unspecified, defaults to 60 seconds.</td></tr><tr><td><code>minDrainDuration</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>false</td><td>MinDrainDuration defines the minimum drain duration allowing time for endpoint deprogramming to complete.<br>If unspecified, defaults to 10 seconds.</td></tr></tbody></table><h4 id=shutdownmanager>ShutdownManager<a class=td-heading-self-link href=#shutdownmanager aria-label="Heading self-link"></a></h4><p>ShutdownManager defines the configuration for the shutdown manager.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>image</code></td><td><em>string</em></td><td>true</td><td>Image specifies the ShutdownManager container image to be used, instead of the default image.</td></tr></tbody></table><h4 id=slowstart>SlowStart<a class=td-heading-self-link href=#slowstart aria-label="Heading self-link"></a></h4><p>SlowStart defines the configuration related to the slow start load balancer policy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#loadbalancer>LoadBalancer</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>window</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#duration-v1-meta>Duration</a></em></td><td>true</td><td>Window defines the duration of the warm up period for newly added host.<br>During slow start window, traffic sent to the newly added hosts will gradually increase.<br>Currently only supports linear growth of traffic. For additional details,<br>see <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#config-cluster-v3-cluster-slowstartconfig>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#config-cluster-v3-cluster-slowstartconfig</a></td></tr></tbody></table><h4 id=sourcematch>SourceMatch<a class=td-heading-self-link href=#sourcematch aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#ratelimitselectcondition>RateLimitSelectCondition</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#sourcematchtype>SourceMatchType</a></em></td><td>false</td><td></td></tr><tr><td><code>value</code></td><td><em>string</em></td><td>true</td><td>Value is the IP CIDR that represents the range of Source IP Addresses of the client.<br>These could also be the intermediate addresses through which the request has flown through and is part of the <code>X-Forwarded-For</code> header.<br>For example, <code>192.168.0.1/32</code>, <code>192.168.0.0/24</code>, <code>001:db8::/64</code>.</td></tr></tbody></table><h4 id=sourcematchtype>SourceMatchType<a class=td-heading-self-link href=#sourcematchtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#sourcematch>SourceMatch</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Exact</code></td><td>SourceMatchExact All IP Addresses within the specified Source IP CIDR are treated as a single client selector<br>and share the same rate limit bucket.<br></td></tr><tr><td><code>Distinct</code></td><td>SourceMatchDistinct Each IP Address within the specified Source IP CIDR is treated as a distinct client selector<br>and uses a separate rate limit bucket/counter.<br>Note: This is only supported for Global Rate Limits.<br></td></tr></tbody></table><h4 id=statefultlssessionresumption>StatefulTLSSessionResumption<a class=td-heading-self-link href=#statefultlssessionresumption aria-label="Heading self-link"></a></h4><p>StatefulTLSSessionResumption defines the stateful (session-id based) type of TLS session resumption.
Note: When Envoy Proxy is deployed with more than one replica, session caches are not synchronized
between instances, possibly leading to resumption failures.
Envoy does not re-validate client certificates upon session resumption.
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#config-route-v3-routematch-tlscontextmatchoptions>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#config-route-v3-routematch-tlscontextmatchoptions</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#sessionresumption>SessionResumption</a></li></ul><h4 id=statelesstlssessionresumption>StatelessTLSSessionResumption<a class=td-heading-self-link href=#statelesstlssessionresumption aria-label="Heading self-link"></a></h4><p>StatelessTLSSessionResumption defines the stateless (session-ticket based) type of TLS session resumption.
Note: When Envoy Proxy is deployed with more than one replica, session ticket encryption keys are not
synchronized between instances, possibly leading to resumption failures.
In-memory session ticket encryption keys are rotated every 48 hours.
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#extensions-transport-sockets-tls-v3-tlssessionticketkeys>https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#extensions-transport-sockets-tls-v3-tlssessionticketkeys</a>
<a href=https://commondatastorage.googleapis.com/chromium-boringssl-docs/ssl.h.html#Session-tickets>https://commondatastorage.googleapis.com/chromium-boringssl-docs/ssl.h.html#Session-tickets</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#sessionresumption>SessionResumption</a></li></ul><h4 id=statuscodematch>StatusCodeMatch<a class=td-heading-self-link href=#statuscodematch aria-label="Heading self-link"></a></h4><p>StatusCodeMatch defines the configuration for matching a status code.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#customresponsematch>CustomResponseMatch</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statuscodevaluetype>StatusCodeValueType</a></em></td><td>true</td><td>Type is the type of value.<br>Valid values are Value and Range, default is Value.</td></tr><tr><td><code>value</code></td><td><em>integer</em></td><td>false</td><td>Value contains the value of the status code.</td></tr><tr><td><code>range</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statuscoderange>StatusCodeRange</a></em></td><td>false</td><td>Range contains the range of status codes.</td></tr></tbody></table><h4 id=statuscoderange>StatusCodeRange<a class=td-heading-self-link href=#statuscoderange aria-label="Heading self-link"></a></h4><p>StatusCodeRange defines the configuration for define a range of status codes.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statuscodematch>StatusCodeMatch</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>start</code></td><td><em>integer</em></td><td>true</td><td>Start of the range, including the start value.</td></tr><tr><td><code>end</code></td><td><em>integer</em></td><td>true</td><td>End of the range, including the end value.</td></tr></tbody></table><h4 id=statuscodevaluetype>StatusCodeValueType<a class=td-heading-self-link href=#statuscodevaluetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>StatusCodeValueType defines the types of values for the status code match supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#statuscodematch>StatusCodeMatch</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Value</code></td><td>StatusCodeValueTypeValue defines the &ldquo;Value&rdquo; status code match type.<br></td></tr><tr><td><code>Range</code></td><td>StatusCodeValueTypeRange defines the &ldquo;Range&rdquo; status code match type.<br></td></tr></tbody></table><h4 id=stringmatch>StringMatch<a class=td-heading-self-link href=#stringmatch aria-label="Heading self-link"></a></h4><p>StringMatch defines how to match any strings.
This is a general purpose match condition that can be used by other EG APIs
that need to match against a string.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxymetrics>ProxyMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#stringmatchtype>StringMatchType</a></em></td><td>false</td><td>Type specifies how to match against a string.</td></tr><tr><td><code>value</code></td><td><em>string</em></td><td>true</td><td>Value specifies the string value that the match must have.</td></tr></tbody></table><h4 id=stringmatchtype>StringMatchType<a class=td-heading-self-link href=#stringmatchtype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>StringMatchType specifies the semantics of how a string value should be compared.
Valid MatchType values are &ldquo;Exact&rdquo;, &ldquo;Prefix&rdquo;, &ldquo;Suffix&rdquo;, &ldquo;RegularExpression&rdquo;.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#stringmatch>StringMatch</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Exact</code></td><td>StringMatchExact :the input string must match exactly the match value.<br></td></tr><tr><td><code>Prefix</code></td><td>StringMatchPrefix :the input string must start with the match value.<br></td></tr><tr><td><code>Suffix</code></td><td>StringMatchSuffix :the input string must end with the match value.<br></td></tr><tr><td><code>RegularExpression</code></td><td>StringMatchRegularExpression :The input string must match the regular expression<br>specified in the match value.<br>The regex string must adhere to the syntax documented in<br><a href=https://github.com/google/re2/wiki/Syntax>https://github.com/google/re2/wiki/Syntax</a>.<br></td></tr></tbody></table><h4 id=tcpactivehealthchecker>TCPActiveHealthChecker<a class=td-heading-self-link href=#tcpactivehealthchecker aria-label="Heading self-link"></a></h4><p>TCPActiveHealthChecker defines the settings of tcp health check.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheck>ActiveHealthCheck</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>send</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheckpayload>ActiveHealthCheckPayload</a></em></td><td>false</td><td>Send defines the request payload.</td></tr><tr><td><code>receive</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#activehealthcheckpayload>ActiveHealthCheckPayload</a></em></td><td>false</td><td>Receive defines the expected response payload.</td></tr></tbody></table><h4 id=tcpclienttimeout>TCPClientTimeout<a class=td-heading-self-link href=#tcpclienttimeout aria-label="Heading self-link"></a></h4><p>TCPClientTimeout only provides timeout configuration on the listener whose protocol is TCP or TLS.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttimeout>ClientTimeout</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>idleTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>IdleTimeout for a TCP connection. Idle time is defined as a period in which there are no<br>bytes sent or received on either the upstream or downstream connection.<br>Default: 1 hour.</td></tr></tbody></table><h4 id=tcpkeepalive>TCPKeepalive<a class=td-heading-self-link href=#tcpkeepalive aria-label="Heading self-link"></a></h4><p>TCPKeepalive define the TCP Keepalive configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>probes</code></td><td><em>integer</em></td><td>false</td><td>The total number of unacknowledged probes to send before deciding<br>the connection is dead.<br>Defaults to 9.</td></tr><tr><td><code>idleTime</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>The duration a connection needs to be idle before keep-alive<br>probes start being sent.<br>The duration format is<br>Defaults to <code>7200s</code>.</td></tr><tr><td><code>interval</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>The duration between keep-alive probes.<br>Defaults to <code>75s</code>.</td></tr></tbody></table><h4 id=tcptimeout>TCPTimeout<a class=td-heading-self-link href=#tcptimeout aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#timeout>Timeout</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>connectTimeout</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Duration>Duration</a></em></td><td>false</td><td>The timeout for network connection establishment, including TCP and TLS handshakes.<br>Default: 10 seconds.</td></tr></tbody></table><h4 id=tlssettings>TLSSettings<a class=td-heading-self-link href=#tlssettings aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtlsconfig>BackendTLSConfig</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttlssettings>ClientTLSSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>minVersion</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlsversion>TLSVersion</a></em></td><td>false</td><td>Min specifies the minimal TLS protocol version to allow.<br>The default is TLS 1.2 if this is not specified.</td></tr><tr><td><code>maxVersion</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlsversion>TLSVersion</a></em></td><td>false</td><td>Max specifies the maximal TLS protocol version to allow<br>The default is TLS 1.3 if this is not specified.</td></tr><tr><td><code>ciphers</code></td><td><em>string array</em></td><td>false</td><td>Ciphers specifies the set of cipher suites supported when<br>negotiating TLS 1.0 - 1.2. This setting has no effect for TLS 1.3.<br>In non-FIPS Envoy Proxy builds the default cipher list is:<br>- [ECDHE-ECDSA-AES128-GCM-SHA256|ECDHE-ECDSA-CHACHA20-POLY1305]<br>- [ECDHE-RSA-AES128-GCM-SHA256|ECDHE-RSA-CHACHA20-POLY1305]<br>- ECDHE-ECDSA-AES256-GCM-SHA384<br>- ECDHE-RSA-AES256-GCM-SHA384<br>In builds using BoringSSL FIPS the default cipher list is:<br>- ECDHE-ECDSA-AES128-GCM-SHA256<br>- ECDHE-RSA-AES128-GCM-SHA256<br>- ECDHE-ECDSA-AES256-GCM-SHA384<br>- ECDHE-RSA-AES256-GCM-SHA384</td></tr><tr><td><code>ecdhCurves</code></td><td><em>string array</em></td><td>false</td><td>ECDHCurves specifies the set of supported ECDH curves.<br>In non-FIPS Envoy Proxy builds the default curves are:<br>- X25519<br>- P-256<br>In builds using BoringSSL FIPS the default curve is:<br>- P-256</td></tr><tr><td><code>signatureAlgorithms</code></td><td><em>string array</em></td><td>false</td><td>SignatureAlgorithms specifies which signature algorithms the listener should<br>support.</td></tr><tr><td><code>alpnProtocols</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#alpnprotocol>ALPNProtocol</a> array</em></td><td>false</td><td>ALPNProtocols supplies the list of ALPN protocols that should be<br>exposed by the listener. By default h2 and http/1.1 are enabled.<br>Supported values are:<br>- http/1.0<br>- http/1.1<br>- h2</td></tr></tbody></table><h4 id=tlsversion>TLSVersion<a class=td-heading-self-link href=#tlsversion aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>TLSVersion specifies the TLS version</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtlsconfig>BackendTLSConfig</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttlssettings>ClientTLSSettings</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tlssettings>TLSSettings</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Auto</code></td><td>TLSAuto allows Envoy to choose the optimal TLS Version<br></td></tr><tr><td><code>1.0</code></td><td>TLS1.0 specifies TLS version 1.0<br></td></tr><tr><td><code>1.1</code></td><td>TLS1.1 specifies TLS version 1.1<br></td></tr><tr><td><code>1.2</code></td><td>TLSv1.2 specifies TLS version 1.2<br></td></tr><tr><td><code>1.3</code></td><td>TLSv1.3 specifies TLS version 1.3<br></td></tr></tbody></table><h4 id=targetselector>TargetSelector<a class=td-heading-self-link href=#targetselector aria-label="Heading self-link"></a></h4><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clienttrafficpolicyspec>ClientTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicyspec>EnvoyExtensionPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#policytargetreferences>PolicyTargetReferences</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#securitypolicyspec>SecurityPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>group</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#group>Group</a></em></td><td>true</td><td>Group is the group that this selector targets. Defaults to gateway.networking.k8s.io</td></tr><tr><td><code>kind</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#kind>Kind</a></em></td><td>true</td><td>Kind is the resource kind that this selector targets.</td></tr><tr><td><code>matchLabels</code></td><td><em>object (keys:string, values:string)</em></td><td>true</td><td>MatchLabels are the set of label selectors for identifying the targeted resource</td></tr></tbody></table><h4 id=timeout>Timeout<a class=td-heading-self-link href=#timeout aria-label="Heading self-link"></a></h4><p>Timeout defines configuration for timeouts related to connections.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendtrafficpolicyspec>BackendTrafficPolicySpec</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>tcp</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tcptimeout>TCPTimeout</a></em></td><td>false</td><td>Timeout settings for TCP.</td></tr><tr><td><code>http</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httptimeout>HTTPTimeout</a></em></td><td>false</td><td>Timeout settings for HTTP.</td></tr></tbody></table><h4 id=tracingprovider>TracingProvider<a class=td-heading-self-link href=#tracingprovider aria-label="Heading self-link"></a></h4><p>TracingProvider defines the tracing provider configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#proxytracing>ProxyTracing</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>backendRef</code></td><td><em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.BackendObjectReference>BackendObjectReference</a></em></td><td>false</td><td>BackendRef references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.<br><br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>backendRefs</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendref>BackendRef</a> array</em></td><td>false</td><td>BackendRefs references a Kubernetes object that represents the<br>backend server to which the authorization request will be sent.</td></tr><tr><td><code>backendSettings</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clustersettings>ClusterSettings</a></em></td><td>false</td><td>BackendSettings holds configuration for managing the connection<br>to the backend.</td></tr><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovidertype>TracingProviderType</a></em></td><td>true</td><td>Type defines the tracing provider type.</td></tr><tr><td><code>host</code></td><td><em>string</em></td><td>false</td><td>Host define the provider service hostname.<br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>port</code></td><td><em>integer</em></td><td>false</td><td>Port defines the port the provider service is exposed on.<br>Deprecated: Use BackendRefs instead.</td></tr><tr><td><code>zipkin</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#zipkintracingprovider>ZipkinTracingProvider</a></em></td><td>false</td><td>Zipkin defines the Zipkin tracing provider configuration</td></tr></tbody></table><h4 id=tracingprovidertype>TracingProviderType<a class=td-heading-self-link href=#tracingprovidertype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovider>TracingProvider</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>OpenTelemetry</code></td><td></td></tr><tr><td><code>OpenTelemetry</code></td><td></td></tr><tr><td><code>Zipkin</code></td><td></td></tr><tr><td><code>Datadog</code></td><td></td></tr></tbody></table><h4 id=triggerenum>TriggerEnum<a class=td-heading-self-link href=#triggerenum aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>TriggerEnum specifies the conditions that trigger retries.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#retryon>RetryOn</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>5xx</code></td><td>The upstream server responds with any 5xx response code, or does not respond at all (disconnect/reset/read timeout).<br>Includes connect-failure and refused-stream.<br></td></tr><tr><td><code>gateway-error</code></td><td>The response is a gateway error (502,503 or 504).<br></td></tr><tr><td><code>reset</code></td><td>The upstream server does not respond at all (disconnect/reset/read timeout.)<br></td></tr><tr><td><code>connect-failure</code></td><td>Connection failure to the upstream server (connect timeout, etc.). (Included in <em>5xx</em>)<br></td></tr><tr><td><code>retriable-4xx</code></td><td>The upstream server responds with a retriable 4xx response code.<br>Currently, the only response code in this category is 409.<br></td></tr><tr><td><code>refused-stream</code></td><td>The upstream server resets the stream with a REFUSED_STREAM error code.<br></td></tr><tr><td><code>retriable-status-codes</code></td><td>The upstream server responds with any response code matching one defined in the RetriableStatusCodes.<br></td></tr><tr><td><code>cancelled</code></td><td>The gRPC status code in the response headers is “cancelled”.<br></td></tr><tr><td><code>deadline-exceeded</code></td><td>The gRPC status code in the response headers is “deadline-exceeded”.<br></td></tr><tr><td><code>internal</code></td><td>The gRPC status code in the response headers is “internal”.<br></td></tr><tr><td><code>resource-exhausted</code></td><td>The gRPC status code in the response headers is “resource-exhausted”.<br></td></tr><tr><td><code>unavailable</code></td><td>The gRPC status code in the response headers is “unavailable”.<br></td></tr></tbody></table><h4 id=unixsocket>UnixSocket<a class=td-heading-self-link href=#unixsocket aria-label="Heading self-link"></a></h4><p>UnixSocket describes TCP/UDP unix domain socket address, corresponding to Envoy&rsquo;s Pipe
<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-pipe>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto#config-core-v3-pipe</a></p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#backendendpoint>BackendEndpoint</a></li><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionservice>ExtensionService</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>path</code></td><td><em>string</em></td><td>true</td><td>Path defines the unix domain socket path of the backend endpoint.</td></tr></tbody></table><h4 id=wasm>Wasm<a class=td-heading-self-link href=#wasm aria-label="Heading self-link"></a></h4><p>Wasm defines a Wasm extension.</p><p>Note: at the moment, Envoy Gateway does not support configuring Wasm runtime.
v8 is used as the VM runtime for the Wasm extensions.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#envoyextensionpolicyspec>EnvoyExtensionPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td><em>string</em></td><td>false</td><td>Name is a unique name for this Wasm extension. It is used to identify the<br>Wasm extension if multiple extensions are handled by the same vm_id and root_id.<br>It&rsquo;s also used for logging/debugging.<br>If not specified, EG will generate a unique name for the Wasm extension.</td></tr><tr><td><code>rootID</code></td><td><em>string</em></td><td>true</td><td>RootID is a unique ID for a set of extensions in a VM which will share a<br>RootContext and Contexts if applicable (e.g., an Wasm HttpFilter and an Wasm AccessLog).<br>If left blank, all extensions with a blank root_id with the same vm_id will share Context(s).<br><br>Note: RootID must match the root_id parameter used to register the Context in the Wasm code.</td></tr><tr><td><code>code</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasmcodesource>WasmCodeSource</a></em></td><td>true</td><td>Code is the Wasm code for the extension.</td></tr><tr><td><code>config</code></td><td><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#json-v1-apiextensions-k8s-io>JSON</a></em></td><td>false</td><td>Config is the configuration for the Wasm extension.<br>This configuration will be passed as a JSON string to the Wasm extension.</td></tr><tr><td><code>failOpen</code></td><td><em>boolean</em></td><td>false</td><td>FailOpen is a switch used to control the behavior when a fatal error occurs<br>during the initialization or the execution of the Wasm extension.<br>If FailOpen is set to true, the system bypasses the Wasm extension and<br>allows the traffic to pass through. Otherwise, if it is set to false or<br>not set (defaulting to false), the system blocks the traffic and returns<br>an HTTP 5xx error.</td></tr></tbody></table><h4 id=wasmcodesource>WasmCodeSource<a class=td-heading-self-link href=#wasmcodesource aria-label="Heading self-link"></a></h4><p>WasmCodeSource defines the source of the Wasm code.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasm>Wasm</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasmcodesourcetype>WasmCodeSourceType</a></em></td><td>true</td><td>Type is the type of the source of the Wasm code.<br>Valid WasmCodeSourceType values are &ldquo;HTTP&rdquo; or &ldquo;Image&rdquo;.</td></tr><tr><td><code>http</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#httpwasmcodesource>HTTPWasmCodeSource</a></em></td><td>false</td><td>HTTP is the HTTP URL containing the Wasm code.<br><br>Note that the HTTP server must be accessible from the Envoy proxy.</td></tr><tr><td><code>image</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#imagewasmcodesource>ImageWasmCodeSource</a></em></td><td>false</td><td>Image is the OCI image containing the Wasm code.<br><br>Note that the image must be accessible from the Envoy Gateway.</td></tr><tr><td><code>pullPolicy</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#imagepullpolicy>ImagePullPolicy</a></em></td><td>false</td><td>PullPolicy is the policy to use when pulling the Wasm module by either the HTTP or Image source.<br>This field is only applicable when the SHA256 field is not set.<br><br>If not specified, the default policy is IfNotPresent except for OCI images whose tag is latest.<br><br>Note: EG does not update the Wasm module every time an Envoy proxy requests<br>the Wasm module even if the pull policy is set to Always.<br>It only updates the Wasm module when the EnvoyExtension resource version changes.</td></tr></tbody></table><h4 id=wasmcodesourcetype>WasmCodeSourceType<a class=td-heading-self-link href=#wasmcodesourcetype aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>WasmCodeSourceType specifies the types of sources for the Wasm code.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#wasmcodesource>WasmCodeSource</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>HTTP</code></td><td>HTTPWasmCodeSourceType allows the user to specify the Wasm code in an HTTP URL.<br></td></tr><tr><td><code>Image</code></td><td>ImageWasmCodeSourceType allows the user to specify the Wasm code in an OCI image.<br></td></tr></tbody></table><h4 id=withunderscoresaction>WithUnderscoresAction<a class=td-heading-self-link href=#withunderscoresaction aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>WithUnderscoresAction configures the action to take when an HTTP header with underscores
is encountered.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#headersettings>HeaderSettings</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Allow</code></td><td>WithUnderscoresActionAllow allows headers with underscores to be passed through.<br></td></tr><tr><td><code>RejectRequest</code></td><td>WithUnderscoresActionRejectRequest rejects the client request. HTTP/1 requests are rejected with<br>the 400 status. HTTP/2 requests end with the stream reset.<br></td></tr><tr><td><code>DropHeader</code></td><td>WithUnderscoresActionDropHeader drops the client header with name containing underscores. The header<br>is dropped before the filter chain is invoked and as such filters will not see<br>dropped headers.<br></td></tr></tbody></table><h4 id=xdstranslatorhook>XDSTranslatorHook<a class=td-heading-self-link href=#xdstranslatorhook aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>XDSTranslatorHook defines the types of hooks that an Envoy Gateway extension may support
for the xds-translator</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xdstranslatorhooks>XDSTranslatorHooks</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>VirtualHost</code></td><td></td></tr><tr><td><code>Route</code></td><td></td></tr><tr><td><code>HTTPListener</code></td><td></td></tr><tr><td><code>Translation</code></td><td></td></tr></tbody></table><h4 id=xdstranslatorhooks>XDSTranslatorHooks<a class=td-heading-self-link href=#xdstranslatorhooks aria-label="Heading self-link"></a></h4><p>XDSTranslatorHooks contains all the pre and post hooks for the xds-translator runner.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#extensionhooks>ExtensionHooks</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>pre</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xdstranslatorhook>XDSTranslatorHook</a> array</em></td><td>true</td><td></td></tr><tr><td><code>post</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xdstranslatorhook>XDSTranslatorHook</a> array</em></td><td>true</td><td></td></tr></tbody></table><h4 id=xfcccertdata>XFCCCertData<a class=td-heading-self-link href=#xfcccertdata aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>XFCCCertData specifies the fields in the client certificate to be forwarded in the XFCC header.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xforwardedclientcert>XForwardedClientCert</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Subject</code></td><td>XFCCCertDataSubject is the Subject field of the current client certificate.<br></td></tr><tr><td><code>Cert</code></td><td>XFCCCertDataCert is the entire client certificate in URL encoded PEM format.<br></td></tr><tr><td><code>Chain</code></td><td>XFCCCertDataChain is the entire client certificate chain (including the leaf certificate) in URL encoded PEM format.<br></td></tr><tr><td><code>DNS</code></td><td>XFCCCertDataDNS is the DNS type Subject Alternative Name field of the current client certificate.<br></td></tr><tr><td><code>URI</code></td><td>XFCCCertDataURI is the URI type Subject Alternative Name field of the current client certificate.<br></td></tr></tbody></table><h4 id=xfccforwardmode>XFCCForwardMode<a class=td-heading-self-link href=#xfccforwardmode aria-label="Heading self-link"></a></h4><p><em>Underlying type:</em> <em>string</em></p><p>XFCCForwardMode defines how XFCC header is handled by Envoy Proxy.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xforwardedclientcert>XForwardedClientCert</a></li></ul><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Sanitize</code></td><td>XFCCForwardModeSanitize removes the XFCC header from the request. This is the default mode.<br></td></tr><tr><td><code>ForwardOnly</code></td><td>XFCCForwardModeForwardOnly forwards the XFCC header in the request if the client connection is mTLS.<br></td></tr><tr><td><code>AppendForward</code></td><td>XFCCForwardModeAppendForward appends the client certificate information to the request’s XFCC header and forward it if the client connection is mTLS.<br></td></tr><tr><td><code>SanitizeSet</code></td><td>XFCCForwardModeSanitizeSet resets the XFCC header with the client certificate information and forward it if the client connection is mTLS.<br>The existing certificate information in the XFCC header is removed.<br></td></tr><tr><td><code>AlwaysForwardOnly</code></td><td>XFCCForwardModeAlwaysForwardOnly always forwards the XFCC header in the request, regardless of whether the client connection is mTLS.<br></td></tr></tbody></table><h4 id=xforwardedclientcert>XForwardedClientCert<a class=td-heading-self-link href=#xforwardedclientcert aria-label="Heading self-link"></a></h4><p>XForwardedClientCert configures how Envoy Proxy handle the x-forwarded-client-cert (XFCC) HTTP header.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#headersettings>HeaderSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mode</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xfccforwardmode>XFCCForwardMode</a></em></td><td>false</td><td>Mode defines how XFCC header is handled by Envoy Proxy.<br>If not set, the default mode is <code>Sanitize</code>.</td></tr><tr><td><code>certDetailsToAdd</code></td><td><em><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#xfcccertdata>XFCCCertData</a> array</em></td><td>false</td><td>CertDetailsToAdd specifies the fields in the client certificate to be forwarded in the XFCC header.<br><br>Hash(the SHA 256 digest of the current client certificate) and By(the Subject Alternative Name)<br>are always included if the client certificate is forwarded.<br><br>This field is only applicable when the mode is set to <code>AppendForward</code> or<br><code>SanitizeSet</code> and the client connection is mTLS.</td></tr></tbody></table><h4 id=xforwardedforsettings>XForwardedForSettings<a class=td-heading-self-link href=#xforwardedforsettings aria-label="Heading self-link"></a></h4><p>XForwardedForSettings provides configuration for using X-Forwarded-For headers for determining the client IP address.
Refer to <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for>https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for</a>
for more details.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#clientipdetectionsettings>ClientIPDetectionSettings</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>numTrustedHops</code></td><td><em>integer</em></td><td>false</td><td>NumTrustedHops controls the number of additional ingress proxy hops from the right side of XFF HTTP<br>headers to trust when determining the origin client&rsquo;s IP address.<br>Only one of NumTrustedHops and TrustedCIDRs must be set.</td></tr></tbody></table><h4 id=zipkintracingprovider>ZipkinTracingProvider<a class=td-heading-self-link href=#zipkintracingprovider aria-label="Heading self-link"></a></h4><p>ZipkinTracingProvider defines the Zipkin tracing provider configuration.</p><p><em>Appears in:</em></p><ul><li><a href=/eg-pr-preview/5-test-docs-preview/v1.2/api/extension_types/#tracingprovider>TracingProvider</a></li></ul><table><thead><tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>enable128BitTraceId</code></td><td><em>boolean</em></td><td>false</td><td>Enable128BitTraceID determines whether a 128bit trace id will be used<br>when creating a new trace instance. If set to false, a 64bit trace<br>id will be used.</td></tr><tr><td><code>disableSharedSpanContext</code></td><td><em>boolean</em></td><td>false</td><td>DisableSharedSpanContext determines whether the default Envoy behaviour of<br>client and server spans sharing the same span context should be disabled.</td></tr></tbody></table></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=mailto:envoy-users@googlegroups.com aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Twitter aria-label=Twitter><a target=_blank rel=noopener href=https://twitter.com/EnvoyProxy aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/envoyproxy/gateway aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://envoyproxy.slack.com/archives/C03E6NHLESV aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2025
<span class=td-footer__authors>The Envoy Gateway Authors</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><p class="td-footer__about mt-2"><a href=/eg-pr-preview/5-test-docs-preview/about/>About Envoy Gateway</a></p></div></div></div></footer></div><script src=/eg-pr-preview/5-test-docs-preview/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/eg-pr-preview/5-test-docs-preview/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/eg-pr-preview/5-test-docs-preview/js/tabpane-persist.js></script></body></html>