<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zirain.github.io/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/><link rel=alternate type=application/rss+xml href=https://zirain.github.io/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/eg-pr-preview/6-test-preview/favicons/favicon.ico><link rel=apple-touch-icon href=/eg-pr-preview/6-test-preview/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-192x192.png sizes=192x192><title>Traffic | Envoy Gateway</title>
<meta name=description content="This section includes Traffic Management tasks."><meta property="og:url" content="https://zirain.github.io/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/"><meta property="og:site_name" content="Envoy Gateway"><meta property="og:title" content="Traffic"><meta property="og:description" content="This section includes Traffic Management tasks."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Traffic"><meta itemprop=description content="This section includes Traffic Management tasks."><meta itemprop=dateModified content="2025-01-14T19:35:21+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Traffic"><meta name=twitter:description content="This section includes Traffic Management tasks."><link rel=preload href=/eg-pr-preview/6-test-preview/scss/main.min.13dd8d11b772c2d11eac755eb5d2d8924f18f01762c20defa026366a1f00937d.css as=style><link href=/eg-pr-preview/6-test-preview/scss/main.min.13dd8d11b772c2d11eac755eb5d2d8924f18f01762c20defa026366a1f00937d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-DXJEH1ZRXX"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DXJEH1ZRXX")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/eg-pr-preview/6-test-preview/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 1200 400"><defs><style>.cls-1{fill:#d04c9b}.cls-2{fill:#4a2365}.cls-3{fill:#b96aab}.cls-4{isolation:isolate}.cls-5{fill:#a53995}</style></defs><g><g id="Layer_1"><g><polygon id="polygon20" class="cls-5" points="191.2 242.29 190.55 213 159.76 193.83 160.4 223.12 191.2 242.29"/><path id="path22" class="cls-5" d="M234.92 315.52l-.65-28.65-26.92-16.8c-.43-.21-.86-.64-1.08-.86l.65 28.86 28 17.45h0z"/><path id="path24" class="cls-5" d="M138.65 354.07l-70.42-43.72-1.73-73.23 34.46-14.86-.65-29.29-55.14 23.69c-4.3 1.94-6.89 5.81-6.67 10.33l2.15 87.87c0 4.53 2.8 9.06 7.11 11.64l84.43 52.33c3.88 2.37 8.61 3.02 12.71 1.94.43-.21.86-.21 1.29-.43l51.9-22.39-28.21-17.45-31.23 13.57h0z"/><path id="path26" class="cls-3" d="M366.29 192.11c-.21-5.17-3.23-10.55-8.39-13.57l-102.52-63.53-3.23 1.29.64 30.8 81.19 50.4 1.94 82.27 31.01 19.17 1.72-.64-2.37-106.18h0z"/><path id="path28" class="cls-3" d="M243.53 336.62l-95.41-59.01-2.37-99.07 43.51-18.74-.86-34.24-67.41 29.07c-4.95 2.16-7.97 6.68-7.75 12.06l2.8 116.3c0 5.38 3.23 10.56 8.4 13.57l111.78 69.35c4.52 2.79 10.12 3.66 14.86 2.15.43-.22.86-.43 1.29-.43l65.9-28.44-32.73-20.25-42 17.67h0z"/><path id="path30" class="cls-1" d="M511.67 110.69 368.45 21.96c-5.38-3.23-11.62-4.1-17-2.37-.44.21-1.08.43-1.51.64L210.16 80.54c-5.6 2.37-9.04 7.54-8.83 13.78l3.44 149.04c.22 6.03 3.88 12.06 9.7 15.51l143.22 88.73c5.17 3.23 11.63 4.09 17.01 2.38.43-.22 1.08-.44 1.51-.65l139.78-60.3c5.59-2.37 9.05-7.75 8.84-13.79l-3.45-149.04c-.21-6.03-3.88-11.85-9.69-15.51M366.08 314.22 241.6 237.11l-3.02-129.44 121.47-52.33 124.49 77.1 3.02 129.45-121.47 52.33h0z"/></g><path id="path10" class="cls-2" d="M607.46 182.14c0 4.62 1.08 9.04 3.23 12.83 2.16 3.78 4.95 7.15 8.18 9.88 3.44 2.74 7.33 4.84 11.84 6.32 4.52 1.47 9.26 2.31 14 2.31 6.46.0 12.27-1.48 17.01-4.41 4.73-2.96 9.26-6.96 13.35-11.79L691 209.07c-11.63 14.71-27.99 22.08-48.88 22.08-8.61.0-16.58-1.47-23.69-4.41-7.11-2.96-13.13-6.95-17.88-12-4.95-5.05-8.61-11.15-11.19-17.88-2.58-6.94-3.88-14.31-3.88-22.51s1.51-15.57 4.31-22.51 6.89-12.83 11.84-17.88 10.98-9.04 18.09-12c6.9-2.94 14.65-4.42 22.83-4.42 9.69.0 18.09 1.69 24.77 5.06 6.67 3.36 12.27 7.77 16.58 13.03 4.31 5.48 7.54 11.37 9.48 18.31 1.94 6.73 3.01 13.67 3.01 20.62v7.37h-88.93v.21h0zM673.78 165.95c-.22-4.63-.86-8.64-2.15-12.42-1.29-3.79-3.23-7.15-6.03-9.89-2.59-2.74-6.02-5.05-9.91-6.53-3.88-1.69-8.61-2.31-13.78-2.31s-9.9 1.05-13.99 2.94c-4.31 1.88-7.97 4.42-10.77 7.36-3.01 2.94-5.17 6.31-6.89 10.1s-2.37 7.37-2.37 10.95h65.89v-.21h0z"/><path id="path12" class="cls-2" d="M714.26 120.71h20.89v16.61h.43c2.58-5.68 7.32-10.52 13.78-13.88 6.46-3.58 14-5.26 22.61-5.26 5.39.0 10.34.84 15.29 2.31 4.95 1.68 9.26 4.01 12.71 7.36 3.66 3.37 6.46 7.57 8.83 12.84 2.16 5.26 3.23 11.36 3.23 18.51v69.44h-20.89v-63.76c0-5.05-.65-9.25-2.15-12.83-1.3-3.58-3.23-6.53-5.6-8.64-2.37-2.1-4.95-3.79-7.97-4.83-3.01-1.06-6.24-1.48-9.47-1.48-4.3.0-8.4.63-12.06 2.1-3.66 1.48-6.89 3.58-9.68 6.53-2.8 2.94-4.96 6.73-6.47 11.35-1.5 4.63-2.37 9.89-2.37 16.21v55.55h-20.88V120.69h-.22v.02z"/><polygon id="polygon14" class="cls-2" points="843.03 120.71 875.98 203.4 907.63 120.71 930.03 120.71 886.74 228.64 863.71 228.64 818.7 120.71 843.03 120.71"/><path id="path16" class="cls-2" d="M931.53 174.77c0-7.78 1.51-15.15 4.53-22.09 3.01-6.73 7.1-12.83 12.49-17.88 5.38-5.06 11.41-9.26 18.73-12.2 7.12-2.95 14.86-4.42 23.04-4.42s15.93 1.47 23.04 4.42c7.1 2.94 13.36 6.93 18.73 12.2 5.17 5.25 9.48 11.15 12.5 17.88 3.01 6.73 4.53 14.1 4.53 22.09s-1.52 15.36-4.53 22.1c-3.02 6.94-7.11 12.83-12.5 17.88-5.37 5.05-11.4 9.04-18.73 12-7.11 2.94-14.85 4.41-23.04 4.41s-15.93-1.47-23.04-4.41c-7.1-2.96-13.35-6.95-18.73-12-5.39-5.05-9.48-11.15-12.49-17.88-3.01-6.94-4.53-14.31-4.53-22.1M953.71 174.77c0 5.47.86 10.52 2.59 15.15 1.71 4.62 4.09 8.62 7.31 11.79 3.02 3.37 6.9 5.89 11.42 7.78 4.52 1.89 9.48 2.94 15.08 2.94s10.55-.84 15.07-2.94c4.51-1.89 8.4-4.41 11.42-7.78 3-3.16 5.59-7.16 7.31-11.79 1.73-4.63 2.59-9.68 2.59-15.15s-.86-10.52-2.59-15.15c-1.71-4.63-4.09-8.63-7.31-11.78-3.02-3.15-6.9-5.89-11.42-7.78-4.52-1.89-9.48-2.94-15.07-2.94s-10.56 1.05-15.08 2.94c-4.52 1.9-8.39 4.42-11.42 7.78-3 3.37-5.59 7.15-7.31 11.78-1.73 4.63-2.59 9.68-2.59 15.15"/><path id="path18" class="cls-2" d="M1050.39 120.71h24.12l32.74 84.15h.42l31.44-84.15h22.4l-52.32 131.07c-1.94 4.63-3.88 9.05-5.82 12.84s-4.31 7.15-7.11 9.88c-2.79 2.73-6.25 4.84-10.12 6.31-3.88 1.48-8.82 2.31-14.43 2.31-3.02.0-6.24-.21-9.48-.62-3.22-.41-6.25-1.26-9.25-2.31l2.58-18.74c4.09 1.69 8.4 2.53 12.49 2.53 3.24.0 6.03-.42 8.18-1.26 2.16-.84 4.09-2.1 5.81-3.58 1.73-1.69 3.03-3.36 4.09-5.46 1.08-2.12 2.15-4.63 3.23-7.37l6.88-17.04-45.86-108.56h0z"/><g class="cls-4"><path class="cls-5" d="M636.86 328.23c0 8.4-2.15 14.77-6.44 19.14-4.3 4.36-10.51 6.54-18.65 6.54-4.53.0-8.61-.66-12.25-1.97s-7.1-3.58-10.38-6.79l5.51-6.3c2.43 2.62 5 4.61 7.72 5.95s5.85 2.02 9.4 2.02 6.25-.51 8.51-1.52c2.26-1.02 4.05-2.4 5.36-4.13 1.31-1.74 2.23-3.72 2.75-5.95.52-2.23.79-4.56.79-6.99v-5.9h-.2c-1.84 2.95-4.23 5.12-7.18 6.49-2.95 1.38-5.97 2.07-9.05 2.07-3.61.0-6.92-.59-9.94-1.77-3.02-1.18-5.61-2.82-7.77-4.92s-3.84-4.59-5.02-7.48c-1.18-2.89-1.77-6.03-1.77-9.45.0-3.74.59-7.12 1.77-10.13 1.18-3.02 2.84-5.56 4.97-7.62 2.13-2.07 4.71-3.66 7.72-4.77 3.02-1.11 6.36-1.67 10.04-1.67 1.57.0 3.15.18 4.72.54s3.1.92 4.58 1.67 2.8 1.71 3.98 2.85c1.18 1.15 2.17 2.48 2.95 3.98h.2v-7.87h7.67v43.98zm-40.34-20.95c0 2.36.43 4.54 1.28 6.54s2.02 3.74 3.49 5.21c1.48 1.48 3.2 2.64 5.17 3.49 1.97.85 4.07 1.28 6.3 1.28 2.62.0 4.95-.46 6.99-1.38 2.03-.92 3.75-2.15 5.17-3.69 1.41-1.54 2.48-3.31 3.2-5.31s1.08-4.12 1.08-6.35c0-2.49-.39-4.77-1.18-6.84s-1.9-3.85-3.34-5.36-3.18-2.67-5.21-3.49c-2.03-.82-4.26-1.23-6.69-1.23s-4.64.44-6.64 1.33c-2 .88-3.71 2.1-5.12 3.64-1.41 1.54-2.51 3.35-3.3 5.41-.79 2.07-1.18 4.31-1.18 6.74z"/><path class="cls-5" d="M650.44 290.16c2.36-2.43 5.17-4.21 8.41-5.36 3.25-1.15 6.54-1.72 9.89-1.72 6.82.0 11.74 1.61 14.76 4.82s4.53 8.1 4.53 14.66v19.78c0 1.31.06 2.67.2 4.08.13 1.41.3 2.71.49 3.89h-7.38c-.26-1.05-.41-2.21-.44-3.49-.03-1.28-.05-2.41-.05-3.39h-.2c-1.51 2.36-3.53 4.3-6.05 5.81-2.53 1.51-5.56 2.26-9.1 2.26-2.36.0-4.58-.29-6.64-.89-2.07-.59-3.87-1.46-5.41-2.61-1.54-1.15-2.77-2.57-3.69-4.28-.92-1.71-1.38-3.67-1.38-5.9.0-3.8.98-6.79 2.95-8.95 1.97-2.16 4.41-3.77 7.33-4.82 2.92-1.05 6.07-1.7 9.45-1.97 3.38-.26 6.48-.39 9.3-.39h2.95v-1.38c0-3.35-1-5.87-3-7.58s-4.81-2.56-8.41-2.56c-2.49.0-4.94.41-7.33 1.23-2.4.82-4.51 2.08-6.35 3.79l-4.82-5.02zM672.67 308.16c-4.92.0-8.82.69-11.71 2.07s-4.33 3.64-4.33 6.79c0 2.89.97 4.94 2.9 6.15s4.34 1.82 7.23 1.82c2.23.0 4.18-.38 5.85-1.13 1.67-.75 3.07-1.75 4.18-3 1.12-1.25 1.97-2.71 2.56-4.38.59-1.67.92-3.46.98-5.36v-2.95h-7.67z"/><path class="cls-5" d="M727.28 290.75H713.7v23.02c0 1.51.03 2.9.1 4.18.06 1.28.33 2.39.79 3.34.46.95 1.15 1.71 2.07 2.26.92.56 2.23.84 3.94.84 1.11.0 2.26-.13 3.44-.39 1.18-.26 2.3-.66 3.35-1.18l.29 6.99c-1.31.59-2.77 1.02-4.38 1.28s-3.13.39-4.58.39c-2.75.0-4.95-.36-6.59-1.08-1.64-.72-2.92-1.74-3.84-3.05-.92-1.31-1.52-2.93-1.82-4.87-.29-1.93-.44-4.08-.44-6.44v-25.29h-10.04v-6.49h10.04v-13.09h7.67v13.09h13.58v6.49z"/><path class="cls-5" d="M777.85 321.94c-2.75 3.54-5.77 6.02-9.05 7.43s-7.08 2.12-11.41 2.12c-3.61.0-6.85-.64-9.74-1.92-2.89-1.28-5.33-3-7.33-5.17s-3.54-4.72-4.62-7.67-1.62-6.1-1.62-9.45c0-3.54.59-6.8 1.77-9.79 1.18-2.98 2.82-5.54 4.92-7.67 2.1-2.13 4.59-3.79 7.48-4.97s6.03-1.77 9.45-1.77c3.21.0 6.17.54 8.86 1.62s5 2.66 6.94 4.72c1.93 2.07 3.43 4.59 4.48 7.58 1.05 2.99 1.57 6.38 1.57 10.18v2.46h-37.19c.13 1.97.61 3.85 1.43 5.66.82 1.81 1.88 3.38 3.2 4.72 1.31 1.35 2.85 2.41 4.62 3.2 1.77.79 3.71 1.18 5.8 1.18 3.35.0 6.17-.59 8.46-1.77 2.29-1.18 4.36-2.92 6.2-5.21l5.8 4.53zM771.26 303.14c-.13-3.94-1.41-7.08-3.84-9.45-2.43-2.36-5.77-3.54-10.04-3.54s-7.71 1.18-10.33 3.54-4.2 5.51-4.72 9.45h28.93z"/><path class="cls-5" d="M840.82 330.3h-7.58l-13.09-35.42h-.2l-11.61 35.42h-7.87l-14.96-46.05h8.46l10.53 35.42h.2l11.91-35.42h8.07l12.1 35.42h.2l10.43-35.42h8.26l-14.86 46.05z"/><path class="cls-5" d="M863.74 290.16c2.36-2.43 5.17-4.21 8.41-5.36 3.25-1.15 6.54-1.72 9.89-1.72 6.82.0 11.74 1.61 14.76 4.82s4.53 8.1 4.53 14.66v19.78c0 1.31.06 2.67.2 4.08.13 1.41.29 2.71.49 3.89h-7.38c-.26-1.05-.41-2.21-.44-3.49-.04-1.28-.05-2.41-.05-3.39h-.2c-1.51 2.36-3.53 4.3-6.05 5.81-2.53 1.51-5.56 2.26-9.1 2.26-2.36.0-4.58-.29-6.64-.89-2.07-.59-3.87-1.46-5.41-2.61-1.54-1.15-2.77-2.57-3.69-4.28-.92-1.71-1.38-3.67-1.38-5.9.0-3.8.98-6.79 2.95-8.95 1.97-2.16 4.41-3.77 7.33-4.82 2.92-1.05 6.07-1.7 9.45-1.97 3.38-.26 6.48-.39 9.3-.39h2.95v-1.38c0-3.35-1-5.87-3-7.58s-4.8-2.56-8.41-2.56c-2.49.0-4.94.41-7.33 1.23-2.4.82-4.51 2.08-6.35 3.79l-4.82-5.02zm22.24 18c-4.92.0-8.82.69-11.71 2.07s-4.33 3.64-4.33 6.79c0 2.89.97 4.94 2.9 6.15s4.34 1.82 7.23 1.82c2.23.0 4.18-.38 5.85-1.13 1.67-.75 3.07-1.75 4.18-3 1.12-1.25 1.97-2.71 2.56-4.38.59-1.67.92-3.46.98-5.36v-2.95h-7.68z"/><path class="cls-5" d="M932.32 340.83c-.79 1.97-1.59 3.75-2.41 5.36-.82 1.61-1.8 2.98-2.95 4.13-1.15 1.15-2.53 2.03-4.13 2.66-1.61.62-3.56.93-5.85.93-1.12.0-2.28-.07-3.49-.2s-2.35-.46-3.39-.98l.98-6.69c.79.33 1.61.54 2.46.64.85.1 1.84.15 2.95.15 2.49.0 4.33-.69 5.51-2.07s2.2-3.21 3.05-5.51l3.15-8.66-19.09-46.34h8.95l14.27 36.11h.2l13.68-36.11h8.36l-22.24 56.57z"/></g></g></g></svg></span><span class=navbar-brand__name>Envoy Gateway</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/docs><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/news><span>News</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/contributions><span>Contributions</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//latest>latest</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//docs>v1.2</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v1.1>v1.1</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v1.0>v1.0</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.6>v0.6</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.5>v0.5</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.4>v0.4</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.3>v0.3</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.2>v0.2</a></li></ul></div></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/eg-pr-preview/6-test-preview/zh/>中文</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/eg-pr-preview/6-test-preview/offline-search-index.2cce2587fabc03ed99234d30898cf310.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/>Return to the regular view of this page</a>.</p></div><h1 class=title>Traffic</h1><div class=lead>This section includes Traffic Management tasks.</div><ul><li>1: <a href=#pg-8ca74c5bbce77b3e4903b49a2bc61fdf>Circuit Breakers</a></li><li>2: <a href=#pg-2af1e2e9be968e1f4c032f918d66fcb6>Client Traffic Policy</a></li><li>3: <a href=#pg-1b95d99c51b33a4385d3d5009d063aef>Fault Injection</a></li><li>4: <a href=#pg-f70ca00ca1814db15a2233b8f0687296>Gateway Address</a></li><li>5: <a href=#pg-c00f0bf10ea6c03176ad89ff91358088>Gateway API Support</a></li><li>6: <a href=#pg-5daf7ac9badf4eaa56db0ee94422f92e>Global Rate Limit</a></li><li>7: <a href=#pg-fb7c69b87dff95dcc034ad5b635f0b5c>GRPC Routing</a></li><li>8: <a href=#pg-fc715e759001a8715b4f63bc378acf8f>HTTP Redirects</a></li><li>9: <a href=#pg-d9c06919ac04c9749373e2a4666cb56f>HTTP Request Headers</a></li><li>10: <a href=#pg-6fc9216363fce897f9295dbe7a8bc03a>HTTP Response Headers</a></li><li>11: <a href=#pg-16bbd92cde58954850070a55347ae53b>HTTP Routing</a></li><li>12: <a href=#pg-9ef62cc770476eae905d426191ca1f1e>HTTP Timeouts</a></li><li>13: <a href=#pg-9c8ae25d4ff16fdca687884e6b96ebac>HTTP URL Rewrite</a></li><li>14: <a href=#pg-f549ebd4ea04245410497376dd8b0085>HTTP3</a></li><li>15: <a href=#pg-2a58875123d803c741ef478c99758a6f>HTTPRoute Request Mirroring</a></li><li>16: <a href=#pg-12f44b044eacecf5c3da7a150836c8cd>HTTPRoute Traffic Splitting</a></li><li>17: <a href=#pg-cc09b3a499eecf47e84cd8631cb2a115>Local Rate Limit</a></li><li>18: <a href=#pg-ba1ec4ec38519695fc7b12cca73d68fc>Multicluster Service Routing</a></li><li>19: <a href=#pg-0cb6850ac9ce2a7f41a62fa1e9626bef>Retry</a></li><li>20: <a href=#pg-1493ff48f742d233da4aba78a90af506>Routing outside Kubernetes</a></li><li>21: <a href=#pg-a9a83c91d0725135fa45d88eded85a47>TCP Routing</a></li><li>22: <a href=#pg-4d78a844d0a1fc300cdb34903c1bfd56>UDP Routing</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-8ca74c5bbce77b3e4903b49a2bc61fdf>1 - Circuit Breakers</h1><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/circuit_breaking>Envoy circuit breakers</a> can be used to fail quickly and apply back-pressure in response to upstream service degradation.</p><p>Envoy Gateway supports the following circuit breaker thresholds:</p><ul><li><strong>Concurrent Connections</strong>: limit the connections that Envoy can establish to the upstream service. When this threshold is met, new connections will not be established, and some requests will be queued until an existing connection becomes available.</li><li><strong>Concurrent Requests</strong>: limit on concurrent requests in-flight from Envoy to the upstream service. When this threshold is met, requests will be queued.</li><li><strong>Pending Requests</strong>: limit the pending request queue size. When this threshold is met, overflowing requests will be terminated with a <code>503</code> status code.</li></ul><p>Envoy&rsquo;s circuit breakers are distributed: counters are not synchronized across different Envoy processes. The default Envoy and Envoy Gateway circuit breaker threshold values (1024) may be too strict for high-throughput systems.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired circuit breaker thresholds.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note</strong>: There are distinct circuit breaker counters for each <code>BackendReference</code> in an <code>xRoute</code> rule. Even if a <code>BackendTrafficPolicy</code> targets a <code>Gateway</code>, each <code>BackendReference</code> in that gateway still has separate circuit breaker counter.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><ul><li>Follow the installation step from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and sample resources.</li></ul><h3 id=install-the-hey-load-testing-tool>Install the hey load testing tool<a class=td-heading-self-link href=#install-the-hey-load-testing-tool aria-label="Heading self-link"></a></h3><ul><li>The <code>hey</code> CLI will be used to generate load and measure response times. Follow the installation instruction from the <a href=https://github.com/rakyll/hey>Hey project</a> docs.</li></ul><h2 id=test-and-customize-circuit-breaker-settings>Test and customize circuit breaker settings<a class=td-heading-self-link href=#test-and-customize-circuit-breaker-settings aria-label="Heading self-link"></a></h2><p>This example will simulate a degraded backend that responds within 10 seconds by adding the <code>?delay=10s</code> query parameter to API calls. The hey tool will be used to generate 100 concurrent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>10s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	10.3426 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	10.3420 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	10.0664 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	10.2145 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	9.6687
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	36600 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	366 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.066 [1]	|■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.094 [4]	|■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.122 [9]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.149 [10]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.177 [10]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.204 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.232 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.259 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.287 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.314 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.342 [11]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span></code></pre></div><p>The default circuit breaker threshold (1024) is not met. As a result, requests do not overflow: all requests are proxied upstream and both Envoy and clients wait for 10s.</p><p>In order to fail fast, apply a <code>BackendTrafficPolicy</code> that limits concurrent requests to 10 and pending requests to 0.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: circuitbreaker-for-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  circuitBreaker:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    maxPendingRequests: 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    maxParallelRequests: 10
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Execute the load simulation again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>100</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>10s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	10.1230 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	10.1224 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	0.0529 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	1.0677 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	9.8785
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	10940 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	109 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  0.053 [1]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  1.060 [89]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.067 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  3.074 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  4.081 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  5.088 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  6.095 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  7.102 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  8.109 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  9.115 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  10.122 [10]	|■■■■
</span></span></span></code></pre></div><p>With the new circuit breaker settings, and due to the slowness of the backend, only the first 10 concurrent requests were proxied, while the other 90 overflowed.</p><ul><li>Overflowing Requests failed fast, reducing proxy resource consumption.</li><li>Upstream traffic was limited, alleviating the pressure on the degraded service.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2af1e2e9be968e1f4c032f918d66fcb6>2 - Client Traffic Policy</h1><p>This guide explains the usage of the <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> API.</p><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>The <a href=../../../api/extension_types#clienttrafficpolicy>ClientTrafficPolicy</a> API allows system administrators to configure
the behavior for how the Envoy Proxy server behaves with downstream clients.</p><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>This API was added as a new policy attachment resource that can be applied to Gateway resources and it is meant to hold settings for configuring behavior of the connection between the downstream client and Envoy Proxy listener. It is the counterpart to the <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> API resource.</p><h2 id=quickstart>Quickstart<a class=td-heading-self-link href=#quickstart aria-label="Heading self-link"></a></h2><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>Follow the steps from the <a href=../../quickstart>Quickstart</a> guide to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</li></ul><h3 id=support-tcp-keepalive-for-downstream-client>Support TCP keepalive for downstream client<a class=td-heading-self-link href=#support-tcp-keepalive-for-downstream-client aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-tcp-keepalive-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tcpKeepalive:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    idleTime: 20m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    interval: 60s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    probes: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify that ClientTrafficPolicy is Accepted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get clienttrafficpolicies.gateway.envoyproxy.io -n default
</span></span></code></pre></div><p>You should see the policy marked as accepted like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          STATUS     AGE
</span></span><span style=display:flex><span>enable-tcp-keepalive-policy   Accepted   5s
</span></span></code></pre></div><p>Curl the example app through Envoy proxy once again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose  --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get --next --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><p>You should see the output like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 172.18.255.202:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.202 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.202<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Fri, <span style=color:#0000cf;font-weight:700>01</span> Dec <span style=color:#0000cf;font-weight:700>2023</span> 10:17:04 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>507</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.1.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;4d0d33e8-d611-41f0-9da0-6458eec20fa5&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-2zwvn&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>* Found bundle <span style=color:#204a87;font-weight:700>for</span> host: 0x7fb9f5204ea0 <span style=color:#ce5c00;font-weight:700>[</span>serially<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>* Can not multiplex, even <span style=color:#204a87;font-weight:700>if</span> we wanted to
</span></span><span style=display:flex><span>* Re-using existing connection <span style=color:#8f5902;font-style:italic>#0 with host 172.18.255.202</span>
</span></span><span style=display:flex><span>&gt; GET /headers HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Fri, <span style=color:#0000cf;font-weight:700>01</span> Dec <span style=color:#0000cf;font-weight:700>2023</span> 10:17:04 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>511</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/headers&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.1.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;172.18.0.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;9a8874c0-c117-481c-9b04-933571732ca5&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-2zwvn&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see keepalive connection marked by the output in:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span>* Re-using existing connection <span style=color:#8f5902;font-style:italic>#0 with host 172.18.255.202</span>
</span></span></code></pre></div><h3 id=enable-proxy-protocol-for-downstream-client>Enable Proxy Protocol for downstream client<a class=td-heading-self-link href=#enable-proxy-protocol-for-downstream-client aria-label="Heading self-link"></a></h3><p>This example configures Proxy Protocol for downstream clients.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-proxy-protocol-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  enableProxyProtocol: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify that ClientTrafficPolicy is Accepted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get clienttrafficpolicies.gateway.envoyproxy.io -n default
</span></span></code></pre></div><p>You should see the policy marked as accepted like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          STATUS     AGE
</span></span><span style=display:flex><span>enable-proxy-protocol-policy   Accepted   5s
</span></span></code></pre></div><p>Try the endpoint without using PROXY protocol with curl:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 172.18.255.202:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.202 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.202<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>* Recv failure: Connection reset by peer
</span></span><span style=display:flex><span>* Closing connection <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>curl: <span style=color:#ce5c00;font-weight:700>(</span>56<span style=color:#ce5c00;font-weight:700>)</span> Recv failure: Connection reset by peer
</span></span></code></pre></div><p>Curl the example app through Envoy proxy once again, now sending HAProxy PROXY protocol header at the beginning of the connection with &ndash;haproxy-protocol flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --haproxy-protocol --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><p>You should now expect 200 response status and also see that source IP was preserved in the X-Forwarded-For header.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 172.18.255.202:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.202 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.202<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.1.2
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Mon, <span style=color:#0000cf;font-weight:700>04</span> Dec <span style=color:#0000cf;font-weight:700>2023</span> 21:11:43 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>510</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.1.2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;192.168.255.6&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;290e4b61-44b7-4e5c-a39c-0ec76784e897&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-2zwvn&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host 172.18.255.202 left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=configure-client-ip-detection>Configure Client IP Detection<a class=td-heading-self-link href=#configure-client-ip-detection aria-label="Heading self-link"></a></h3><p>This example configures the number of additional ingress proxy hops from the right side of XFF HTTP headers to trust when determining the origin client&rsquo;s IP address and determines whether or not <code>x-forwarded-proto</code> headers will be trusted. Refer to <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for>https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for</a> for details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-client-ip-detection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clientIPDetection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    xForwardedFor:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      numTrustedHops: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify that ClientTrafficPolicy is Accepted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get clienttrafficpolicies.gateway.envoyproxy.io -n default
</span></span></code></pre></div><p>You should see the policy marked as accepted like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          STATUS     AGE
</span></span><span style=display:flex><span>http-client-ip-detection   Accepted   5s
</span></span></code></pre></div><p>Open port-forward to the admin interface port:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward deploy/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_DEPLOYMENT</span><span style=color:#4e9a06>}</span> -n envoy-gateway-system 19000:19000
</span></span></code></pre></div><p>Curl the admin interface port to fetch the configured value for <code>xff_num_trusted_hops</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#39;http://localhost:19000/config_dump?resource=dynamic_listeners&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.configs[0].active_state.listener.default_filter_chain.filters[0].typed_config 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      | with_entries(select(.key | match(&#34;xff|remote_address|original_ip&#34;)))&#39;</span>
</span></span></code></pre></div><p>You should expect to see the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;use_remote_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;xff_num_trusted_hops&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://<span style=color:#000>$GATEWAY_HOST</span>/get <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;X-Forwarded-Proto: https&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;X-Forwarded-For: 1.1.1.1,2.2.2.2&#34;</span>
</span></span></code></pre></div><p>You should expect 200 response status, see that <code>X-Forwarded-Proto</code> was preserved and <code>X-Envoy-External-Address</code> was set to the leftmost address in the <code>X-Forwarded-For</code> header:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying <span style=color:#ce5c00;font-weight:700>[</span>::1<span style=color:#ce5c00;font-weight:700>]</span>:8888...
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#ce5c00;font-weight:700>(</span>::1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>8888</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.4.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; X-Forwarded-Proto: https
</span></span><span style=display:flex><span>&gt; X-Forwarded-For: 1.1.1.1,2.2.2.2
</span></span><span style=display:flex><span>&gt; 
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8888</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Tue, <span style=color:#0000cf;font-weight:700>30</span> Jan <span style=color:#0000cf;font-weight:700>2024</span> 15:19:22 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>535</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/8.4.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-External-Address&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;1.1.1.1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;1.1.1.1,2.2.2.2,10.244.0.9&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;https&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;53ccfad7-1899-40fa-9322-ddb833aa1ac3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-58d58f745-8psnc&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host localhost left intact</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=enable-http-request-received-timeout>Enable HTTP Request Received Timeout<a class=td-heading-self-link href=#enable-http-request-received-timeout aria-label="Heading self-link"></a></h3><p>This feature allows you to limit the time taken by the Envoy Proxy fleet to receive the entire request from the client, which is useful in preventing certain clients from consuming too much memory in Envoy
This example configures the HTTP request timeout for the client, please check out the details <a href=https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/timeouts#stream-timeouts>here</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: client-timeout
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  timeout:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    http:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestReceivedTimeout: 2s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://<span style=color:#000>$GATEWAY_HOST</span>/get <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Content-Length: 10000&#34;</span>
</span></span></code></pre></div><p>You should expect <code>428</code> response status after 2s:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://<span style=color:#000>$GATEWAY_HOST</span>/get <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#34;Content-Length: 10000&#34;</span>
</span></span><span style=display:flex><span>*   Trying 172.18.255.200:80...
</span></span><span style=display:flex><span>* Connected to 172.18.255.200 <span style=color:#ce5c00;font-weight:700>(</span>172.18.255.200<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>80</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/8.4.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; Content-Length: <span style=color:#0000cf;font-weight:700>10000</span>
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>408</span> Request Timeout
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>15</span>
</span></span><span style=display:flex><span>&lt; content-type: text/plain
</span></span><span style=display:flex><span>&lt; date: Tue, <span style=color:#0000cf;font-weight:700>27</span> Feb <span style=color:#0000cf;font-weight:700>2024</span> 07:38:27 GMT
</span></span><span style=display:flex><span>&lt; connection: close
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>* Closing connection
</span></span><span style=display:flex><span>request timeout
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1b95d99c51b33a4385d3d5009d063aef>3 - Fault Injection</h1><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/fault_filter.html>Envoy fault injection</a> can be used to inject delays and abort requests to mimic failure scenarios such as service failures and overloads.</p><p>Envoy Gateway supports the following fault scenarios:</p><ul><li><strong>delay fault</strong>: inject a custom fixed delay into the request with a certain probability to simulate delay failures.</li><li><strong>abort fault</strong>: inject a custom response code into the response with a certain probability to simulate abort failures.</li></ul><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired fault scenarios.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> guide to install Envoy Gateway and the example manifest.
For GRPC - follow the steps from the <a href=../grpc-routing>GRPC Routing</a> example.
Before proceeding, you should be able to query the example backend using HTTP or GRPC.</p><h3 id=install-the-hey-load-testing-tool>Install the hey load testing tool<a class=td-heading-self-link href=#install-the-hey-load-testing-tool aria-label="Heading self-link"></a></h3><ul><li>The <code>hey</code> CLI will be used to generate load and measure response times. Follow the installation instruction from the <a href=https://github.com/rakyll/hey>Hey project</a> docs.</li></ul><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Allow requests with a valid faultInjection by creating an <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> and attaching it to the example HTTPRoute or GRPCRoute.</p><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: fault-injection-50-percent-abort
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  faultInjection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    abort:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      httpStatus: 501
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      percentage: 50
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: fault-injection-delay
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  faultInjection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    delay:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      fixedDelay: 2s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Two HTTPRoute has been created, one for <code>/foo</code> and another for <code>/bar</code>. <code>fault-injection-abort</code> BackendTrafficPolicy has been created and targeted HTTPRoute foo to abort requests for <code>/foo</code>. <code>fault-injection-delay</code> BackendTrafficPolicy has been created and targeted HTTPRoute foo to delay <code>2s</code> requests for <code>/bar</code>.</p><p>Verify the HTTPRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/foo -o yaml
</span></span><span style=display:flex><span>kubectl get httproute/bar -o yaml
</span></span></code></pre></div><p>Verify the BackendTrafficPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get backendtrafficpolicy/fault-injection-50-percent-abort -o yaml
</span></span><span style=display:flex><span>kubectl get backendtrafficpolicy/fault-injection-delay -o yaml
</span></span></code></pre></div><h3 id=grpcroute>GRPCRoute<a class=td-heading-self-link href=#grpcroute aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: fault-injection-abort
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  faultInjection:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    abort:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      grpcStatus: 14
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>A BackendTrafficPolicy has been created and targeted GRPCRoute yages to abort requests for <code>yages</code> service..</p><p>Verify the GRPCRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroute/yages -o yaml
</span></span></code></pre></div><p>Verify the SecurityPolicy configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get backendtrafficpolicy/fault-injection-abort -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=../../quickstart>Quickstart</a> guide is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><p>Verify that requests to <code>foo</code> route are aborted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>1000</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Status code distribution:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [200]	501 responses
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  [501]	499 responses
</span></span></span></code></pre></div><p>Verify that requests to <code>bar</code> route are delayed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hey -n <span style=color:#0000cf;font-weight:700>1000</span> -c <span style=color:#0000cf;font-weight:700>100</span> -host <span style=color:#4e9a06>&#34;www.example.com&#34;</span>  http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/bar
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Summary:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Total:	20.1493 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Slowest:	2.1020 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Fastest:	1.9940 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Average:	2.0123 secs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Requests/sec:	49.6295
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>  Total data:	557000 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Size/request:	557 bytes
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Response time histogram:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  1.994 [1]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.005 [475]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.016 [419]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.026 [5]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.037 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.048 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.059 [30]	|■■■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.070 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.080 [0]	|
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.091 [11]	|■
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  2.102 [59]	|■■■■■
</span></span></span></code></pre></div><h3 id=grpcroute-1>GRPCRoute<a class=td-heading-self-link href=#grpcroute-1 aria-label="Heading self-link"></a></h3><p>Verify that requests to <code>yages</code>service are aborted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Error invoking method <span style=color:#4e9a06>&#34;yages.Echo/Ping&#34;</span>: rpc error: <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> Unavailable <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> failed to query <span style=color:#204a87;font-weight:700>for</span> service descriptor <span style=color:#4e9a06>&#34;yages.Echo&#34;</span>: fault filter abort
</span></span></code></pre></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> guide to uninstall Envoy Gateway and the example manifest.</p><p>Delete the BackendTrafficPolicy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete BackendTrafficPolicy/fault-injection-abort
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f70ca00ca1814db15a2233b8f0687296>4 - Gateway Address</h1><p>The Gateway API provides an optional <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GatewayAddress>Addresses</a> field through which Envoy Gateway can set addresses for Envoy Proxy Service.
Depending on the Service Type, the addresses of gateway can be used as:</p><ul><li><a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/gateway-address/#external-ips>External IPs</a></li><li><a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/gateway-address/#cluster-ip>Cluster IP</a></li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.</p><h2 id=external-ips>External IPs<a class=td-heading-self-link href=#external-ips aria-label="Heading self-link"></a></h2><p>Using the addresses in <code>Gateway.Spec.Addresses</code> as the <a href=https://kubernetes.io/docs/concepts/services-networking/service/#external-ips>External IPs</a> of Envoy Proxy Service,
this will <strong>require</strong> the address to be of type <code>IPAddress</code> and the <a href=../../../api/extension_types#servicetype>ServiceType</a> to be of <code>LoadBalancer</code> or <code>NodePort</code>.</p><p>The Envoy Gateway deploys Envoy Proxy Service as <code>LoadBalancer</code> by default,
so you can set the address of the Gateway directly (the address settings here are for reference only):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>- op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  path: /spec/addresses
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   - type: IPAddress
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>     value: 1.2.3.4
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>NAME   CLASS   ADDRESS   PROGRAMMED   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg     eg      1.2.3.4   True         14m
</span></span></span></code></pre></div><p>Verify the Envoy Proxy Service status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service -n envoy-gateway-system
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>envoy-default-eg-64656661       LoadBalancer   10.96.236.219   1.2.3.4       80:31017/TCP   15m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>envoy-gateway                   ClusterIP      10.96.192.76    &lt;none&gt;        18000/TCP      15m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>envoy-gateway-metrics-service   ClusterIP      10.96.124.73    &lt;none&gt;        8443/TCP       15m
</span></span></span></code></pre></div><p><strong>Note:</strong> If the <code>Gateway.Spec.Addresses</code> is explicitly set, it will be the only addresses that populates the Gateway status.</p><h2 id=cluster-ip>Cluster IP<a class=td-heading-self-link href=#cluster-ip aria-label="Heading self-link"></a></h2><p>Using the addresses in <code>Gateway.Spec.Addresses</code> as the <a href=https://kubernetes.io/docs/concepts/services-networking/service/#type-clusterip>Cluster IP</a> of Envoy Proxy Service,
this will <strong>require</strong> the address to be of type <code>IPAddress</code> and the <a href=../../../api/extension_types#servicetype>ServiceType</a> to be of <code>ClusterIP</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c00f0bf10ea6c03176ad89ff91358088>5 - Gateway API Support</h1><p>As mentioned in the <a href=/eg-pr-preview/6-test-preview/contributions/design/system-design/>system design</a> document, Envoy Gateway&rsquo;s managed data plane is configured dynamically through
Kubernetes resources, primarily <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> objects. Envoy Gateway supports configuration using the following Gateway API resources.</p><h2 id=gatewayclass>GatewayClass<a class=td-heading-self-link href=#gatewayclass aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.GatewayClass>GatewayClass</a> represents a &ldquo;class&rdquo; of gateways, i.e. which Gateways should be managed by Envoy Gateway.
Envoy Gateway supports managing <strong>a single</strong> GatewayClass resource that matches its configured <code>controllerName</code> and
follows Gateway API guidelines for <a href="https://gateway-api.sigs.k8s.io/concepts/guidelines/?h=conflict#conflicts">resolving conflicts</a> when multiple GatewayClasses exist with a matching
<code>controllerName</code>.</p><p><strong>Note:</strong> If specifying GatewayClass <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.ParametersReference>parameters reference</a>, it must refer to an <a href=../../../api/extension_types#envoyproxy>EnvoyProxy</a> resource.</p><h2 id=gateway>Gateway<a class=td-heading-self-link href=#gateway aria-label="Heading self-link"></a></h2><p>When a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Gateway>Gateway</a> resource is created that references the managed GatewayClass, Envoy Gateway will create and manage a
new Envoy Proxy deployment. Gateway API resources that reference this Gateway will configure this managed Envoy Proxy
deployment.</p><h2 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRoute>HTTPRoute</a> configures routing of HTTP traffic through one or more Gateways. The following HTTPRoute filters are
supported by Envoy Gateway:</p><ul><li><code>requestHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>RequestHeaderModifiers</a>
can be used to modify or add request headers before the request is proxied to its destination.</li><li><code>responseHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>ResponseHeaderModifiers</a>
can be used to modify or add response headers before the response is sent back to the client.</li><li><code>requestMirror</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>RequestMirrors</a>
configure destinations where the requests should also be mirrored to. Responses to mirrored requests will be ignored.</li><li><code>requestRedirect</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>RequestRedirects</a>
configure policied for how requests that match the HTTPRoute should be modified and then redirected.</li><li><code>urlRewrite</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>UrlRewrites</a>
allow for modification of the request&rsquo;s hostname and path before it is proxied to its destination.</li><li><code>extensionRef</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilterType>ExtensionRefs</a> are used by Envoy Gateway to implement extended filters. Currently, Envoy Gateway
supports rate limiting and request authentication filters. For more information about these filters, refer to the
<a href=/eg-pr-preview/6-test-preview/contributions/design/rate-limit/>rate limiting</a> and <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/security/jwt-authentication/>request authentication</a> documentation.</li></ul><p><strong>Notes:</strong></p><ul><li>The only <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>BackendRef</a> kind supported by Envoy Gateway is a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>. Routing traffic to other destinations such
as arbitrary URLs is not possible.</li><li>The <code>filters</code> field within <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPBackendRef>HTTPBackendRef</a> is not supported.</li></ul><h2 id=tcproute>TCPRoute<a class=td-heading-self-link href=#tcproute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> configures routing of raw TCP traffic through one or more Gateways. Traffic can be forwarded to the
desired BackendRefs based on a TCP port number.</p><p><strong>Note:</strong> A TCPRoute only supports proxying in non-transparent mode, i.e. the backend will see the source IP and port of
the Envoy Proxy instance instead of the client.</p><h2 id=udproute>UDPRoute<a class=td-heading-self-link href=#udproute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a> configures routing of raw UDP traffic through one or more Gateways. Traffic can be forwarded to the
desired BackendRefs based on a UDP port number.</p><p><strong>Note:</strong> Similar to TCPRoutes, UDPRoutes only support proxying in non-transparent mode i.e. the backend will see the
source IP and port of the Envoy Proxy instance instead of the client.</p><h2 id=grpcroute>GRPCRoute<a class=td-heading-self-link href=#grpcroute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRoute>GRPCRoute</a> configures routing of <a href=https://grpc.io/>gRPC</a> requests through one or more Gateways. They offer request matching by
hostname, gRPC service, gRPC method, or HTTP/2 Header. Envoy Gateway supports the following filters on GRPCRoutes to
provide additional traffic processing:</p><ul><li><code>requestHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>RequestHeaderModifiers</a>
can be used to modify or add request headers before the request is proxied to its destination.</li><li><code>responseHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>ResponseHeaderModifiers</a>
can be used to modify or add response headers before the response is sent back to the client.</li><li><code>requestMirror</code>: <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>RequestMirrors</a>
configure destinations where the requests should also be mirrored to. Responses to mirrored requests will be ignored.</li></ul><p><strong>Notes:</strong></p><ul><li>The only <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>BackendRef</a> kind supported by Envoy Gateway is a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>. Routing traffic to other
destinations such as arbitrary URLs is not currently possible.</li><li>The <code>filters</code> field within <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPBackendRef>HTTPBackendRef</a> is not supported.</li></ul><h2 id=tlsroute>TLSRoute<a class=td-heading-self-link href=#tlsroute aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a> configures routing of TCP traffic through one or more Gateways. However, unlike TCPRoutes, TLSRoutes
can match against TLS-specific metadata.</p><h2 id=referencegrant>ReferenceGrant<a class=td-heading-self-link href=#referencegrant aria-label="Heading self-link"></a></h2><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.ReferenceGrant>ReferenceGrant</a> is used to allow a resource to reference another resource in a different namespace. Normally an
HTTPRoute created in namespace <code>foo</code> is not allowed to reference a Service in namespace <code>bar</code>. A ReferenceGrant permits
these types of cross-namespace references. Envoy Gateway supports the following ReferenceGrant use-cases:</p><ul><li>Allowing an HTTPRoute, GRPCRoute, TLSRoute, UDPRoute, or TCPRoute to reference a Service in a different namespace.</li><li>Allowing an HTTPRoute&rsquo;s <code>requestMirror</code> filter to include a BackendRef that references a Service in a different
namespace.</li><li>Allowing a Gateway&rsquo;s <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.SecretObjectReference>SecretObjectReference</a> to reference a secret in a different namespace.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5daf7ac9badf4eaa56db0ee94422f92e>6 - Global Rate Limit</h1><p>Rate limit is a feature that allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p><p>Here are some reasons why you may want to implement Rate limits</p><ul><li>To prevent malicious activity such as DDoS attacks.</li><li>To prevent applications and its resources (such as a database) from getting overloaded.</li><li>To create API limits based on user entitlements.</li></ul><p>Envoy Gateway supports two types of rate limiting: <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> and <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting>Local rate limiting</a>.</p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> applies a shared rate limit to the traffic flowing through all the instances of Envoy proxies where it is configured.
i.e. if the data plane has 2 replicas of Envoy running, and the rate limit is 10 requests/second, this limit is shared and will be hit
if 5 requests pass through the first replica and 5 requests pass through the second replica within the same second.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their rate limit intent. This instantiated resource
can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note:</strong> Limit is applied per route. Even if a <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> targets a gateway, each route in that gateway
still has a separate rate limit bucket. For example, if a gateway has 2 routes, and the limit is 100r/s, then each route
has its own 100r/s rate limit bucket.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><ul><li>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the HTTPRoute example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</li></ul><h3 id=install-redis>Install Redis<a class=td-heading-self-link href=#install-redis aria-label="Heading self-link"></a></h3><ul><li>The global rate limit feature is based on <a href=https://github.com/envoyproxy/ratelimit>Envoy Ratelimit</a> which requires a Redis instance as its caching layer.
Lets install a Redis deployment in the <code>redis-system</code> namespce.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis-system 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: redis-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - image: redis:6.0.6
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cpu: 1500m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cpu: 200m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            memory: 256Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: redis-system 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    targetPort: 6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=enable-global-rate-limit-in-envoy-gateway>Enable Global Rate limit in Envoy Gateway<a class=td-heading-self-link href=#enable-global-rate-limit-in-envoy-gateway aria-label="Heading self-link"></a></h3><ul><li>The default installation of Envoy Gateway installs a default <a href=/eg-pr-preview/6-test-preview/v1.0/api/extension_types/#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In the next step, we will update this resource to enable rate limit in Envoy Gateway
as well as configure the URL for the Redis instance used for Global rate limiting.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><ul><li>After updating the <code>ConfigMap</code>, you will need to restart the <code>envoy-gateway</code> deployment so the configuration kicks in</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div><h2 id=rate-limit-specific-user>Rate Limit Specific User<a class=td-heading-self-link href=#rate-limit-specific-user aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code>x-user-id</code> header
with a value set to <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: one
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-ratelimit -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Let&rsquo;s query <code>ratelimit.example/get</code> 4 times. We should receive a <code>200</code> response from the example Gateway for the first 3 requests
and then receive a <code>429</code> status code for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code>x-user-id</code>
and value <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should be able to send requests with the <code>x-user-id</code> header and a different value and receive successful responses from the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:38 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:39 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h2 id=rate-limit-distinct-users>Rate Limit Distinct Users<a class=td-heading-self-link href=#rate-limit-distinct-users aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the
value in the <code>x-user-id</code> header. Here, user <code>one</code> (recognised from the traffic flow using the header <code>x-user-id</code> and value <code>one</code>) will be rate limited at 3 requests/hour
and so will user <code>two</code> (recognised from the traffic flow using the header <code>x-user-id</code> and value <code>two</code>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: Distinct
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Lets run the same command again with the header <code>x-user-id</code> and value <code>one</code> set in the request. We should the first 3 requests succeeding and
the 4th request being rate limited.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should see the same behavior when the value for header <code>x-user-id</code> is set to <code>two</code> and 4 requests are sent.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h2 id=rate-limit-all-requests>Rate Limit All Requests<a class=td-heading-self-link href=#rate-limit-all-requests aria-label="Heading self-link"></a></h2><p>This example shows you how to rate limit all requests matching the HTTPRoute rule at 3 requests/Hour by leaving the <code>clientSelectors</code> field unset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute-2>HTTPRoute<a class=td-heading-self-link href=#httproute-2 aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h2 id=rate-limit-client-ip-addresses>Rate Limit Client IP Addresses<a class=td-heading-self-link href=#rate-limit-client-ip-addresses aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on their
IP address (also reflected in the <code>X-Forwarded-For</code> header).</p><p>Note: EG supports two kinds of rate limit for the IP address: Exact and Distinct.</p><ul><li>Exact means that all IP addresses within the specified Source IP CIDR share the same rate limit bucket.</li><li>Distinct means that each IP address within the specified Source IP CIDR has its own rate limit bucket.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - sourceCIDR: 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: 0.0.0.0/0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Distinct
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:45 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:46 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h2 id=rate-limit-jwt-claims>Rate Limit Jwt Claims<a class=td-heading-self-link href=#rate-limit-jwt-claims aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the value of the Jwt claims carried.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jwt:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    providers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      remoteJWKS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        uri: https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/jwks.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      claimToHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - claim: name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header: x-claim-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-claim-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: John Doe
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/with-different-claim.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN1</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><h3 id=rate-limit-by-carrying-token>Rate limit by carrying <code>TOKEN</code><a class=td-heading-self-link href=#rate-limit-by-carrying-token aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:25 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:26 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:27 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:28 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h3 id=no-rate-limit-by-carrying-token1>No Rate Limit by carrying <code>TOKEN1</code><a class=td-heading-self-link href=#no-rate-limit-by-carrying-token1 aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN1</span><span style=color:#4e9a06>&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:35 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h3 id=optional-editing-kubernetes-resources-settings-for-the-rate-limit-service>(Optional) Editing Kubernetes Resources settings for the Rate Limit Service<a class=td-heading-self-link href=#optional-editing-kubernetes-resources-settings-for-the-rate-limit-service aria-label="Heading self-link"></a></h3><ul><li><p>The default installation of Envoy Gateway installs a default <a href=/eg-pr-preview/6-test-preview/v1.0/api/extension_types/#envoygateway>EnvoyGateway</a> configuration and provides the initial rate
limit kubernetes resources settings. such as <code>replicas</code> is 1, requests resources cpu is <code>100m</code>, memory is <code>512Mi</code>. the others
like container <code>image</code>, <code>securityContext</code>, <code>env</code> and pod <code>annotations</code> and <code>securityContext</code> can be modified by modifying the <code>ConfigMap</code>.</p></li><li><p><code>tls.certificateRef</code> set the client certificate for redis server TLS connections.</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        rateLimitDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            image: envoyproxy/ratelimit:master
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: CACHE_KEY_PREFIX
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: &#34;eg:rl:&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                cpu: 100m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsUser: 2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              allowPrivilegeEscalation: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              key1: val1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              key2: val2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsUser: 1000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsGroup: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              fsGroup: 2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              fsGroupChangePolicy: &#34;OnRootMismatch&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            certificateRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              name: ratelimit-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><ul><li>After updating the <code>ConfigMap</code>, you will need to restart the <code>envoy-gateway</code> deployment so the configuration kicks in</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-fb7c69b87dff95dcc034ad5b635f0b5c>7 - GRPC Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource allows users to configure gRPC routing by matching HTTP/2 traffic and forwarding it to backend gRPC servers.
To learn more about gRPC routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/quickstart/>Quickstart</a> guide to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install the gRPC routing example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/grpc-routing.yaml
</span></span></code></pre></div><p>The manifest installs a <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, a Deployment, a Service, and a GRPCRoute resource.
The GatewayClass is a cluster-scoped resource that represents a class of Gateways that can be instantiated.</p><p><strong>Note:</strong> Envoy Gateway is configured by default to manage a GatewayClass with
<code>controllerName: gateway.envoyproxy.io/gatewayclass-controller</code>.</p><h2 id=verification>Verification<a class=td-heading-self-link href=#verification aria-label="Heading self-link"></a></h2><p>Check the status of the GatewayClass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gc --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Accepted=True&rdquo;, indicating Envoy Gateway is managing the GatewayClass.</p><p>A Gateway represents configuration of infrastructure. When a Gateway is created, <a href=https://www.envoyproxy.io/>Envoy proxy</a> infrastructure is
provisioned or configured by Envoy Gateway. The <code>gatewayClassName</code> defines the name of a GatewayClass used by this
Gateway. Check the status of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Ready=True&rdquo;, indicating the Envoy proxy infrastructure has been provisioned. The status also
provides the address of the Gateway. This address is used later in the guide to test connectivity to proxied backend
services.</p><p>Check the status of the GRPCRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>The status for the GRPCRoute should surface &ldquo;Accepted=True&rdquo; and a <code>parentRef</code> that references the example Gateway.
The <code>example-route</code> matches any traffic for &ldquo;grpc-example.com&rdquo; and forwards it to the &ldquo;yages&rdquo; Service.</p><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><p>Before testing GRPC routing to the <code>yages</code> backend, get the Gateway&rsquo;s address.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;text&#34;</span>: <span style=color:#4e9a06>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Envoy Gateway also supports <a href=https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md#protocol-differences-vs-grpc-over-http2>gRPC-Web</a> requests for this configuration. The below <code>curl</code> command can be used to send a grpc-Web request with over HTTP/2. You should receive the same response seen in the previous command.</p><p>The data in the body <code>AAAAAAA=</code> is a base64 encoded representation of an empty message (data length 0) that the Ping RPC accepts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --http2-prior-knowledge -s <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80/yages.Echo/Ping -H <span style=color:#4e9a06>&#39;Host: grpc-example.com&#39;</span>   -H <span style=color:#4e9a06>&#39;Content-Type: application/grpc-web-text&#39;</span>   -H <span style=color:#4e9a06>&#39;Accept: application/grpc-web-text&#39;</span> -XPOST -d<span style=color:#4e9a06>&#39;AAAAAAA=&#39;</span> <span style=color:#000;font-weight:700>|</span> base64 -d
</span></span></code></pre></div><h2 id=grpcroute-match>GRPCRoute Match<a class=td-heading-self-link href=#grpcroute-match aria-label="Heading self-link"></a></h2><p>The <code>matches</code> field can be used to restrict the route to a specific set of requests based on GRPC&rsquo;s service and/or method names.
It supports two match types: <code>Exact</code> and <code>RegularExpression</code>.</p><h3 id=exact>Exact<a class=td-heading-self-link href=#exact aria-label="Heading self-link"></a></h3><p><code>Exact</code> match is the default match type.</p><p>The following example shows how to match a request based on the service and method names for <code>grpc.reflection.v1alpha.ServerReflection/ServerReflectionInfo</code>,
as well as a match for all services with a method name <code>Ping</code> which matches <code>yages.Echo/Ping</code> in our deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: Ping
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the GRPCRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><h3 id=regularexpression>RegularExpression<a class=td-heading-self-link href=#regularexpression aria-label="Heading self-link"></a></h3><p>The following example shows how to match a request based on the service and method names
with match type <code>RegularExpression</code>. It matches all the services and methods with pattern
<code>/.*.Echo/Pin.+</code>, which matches <code>yages.Echo/Ping</code> in our deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: &#34;Pin.+&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: &#34;.*.Echo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RegularExpression
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the GRPCRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-fc715e759001a8715b4f63bc378acf8f>8 - HTTP Redirects</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can issue redirects to clients or rewrite paths sent upstream using filters. Note that
HTTPRoute rules cannot use both filter types at once. Currently, Envoy Gateway only supports <strong>core</strong>
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>HTTPRoute filters</a> which consist of <code>RequestRedirect</code> and <code>RequestHeaderModifier</code> at the time of this writing. To
learn more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTPS.</p><h2 id=redirects>Redirects<a class=td-heading-self-link href=#redirects aria-label="Heading self-link"></a></h2><p>Redirects return HTTP 3XX responses to a client, instructing it to retrieve a different resource. A
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1.HTTPRequestRedirectFilter><code>RequestRedirect</code> filter</a> instructs Gateways to emit a redirect response to requests that match the rule.
For example, to issue a permanent redirect (301) from HTTP to HTTPS, configure <code>requestRedirect.statusCode=301</code> and
<code>requestRedirect.scheme="https"</code>:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-to-https-filter-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - redirect.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          scheme: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          statusCode: 301
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: www.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-to-https-filter-redirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>redirect.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestRedirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requestRedirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>statusCode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>301</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p><strong>Note:</strong> <code>301</code> (default) and <code>302</code> are the only supported statusCodes.</p><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-to-https-filter-redirect -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>redirect.example/get</code> should result in a <code>301</code> response from the example Gateway and redirecting to the
configured redirect hostname.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: redirect.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 301 Moved Permanently
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; location: https://www.example.com/get
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>If you followed the steps in the <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/security/secure-gateways/>Secure Gateways</a> task, you should be able to curl the redirect
location.</p><h2 id=http----https>HTTP &ndash;> HTTPS<a class=td-heading-self-link href=#http----https aria-label="Heading self-link"></a></h2><p>Listeners expose the TLS setting on a per domain or subdomain basis. TLS settings of a listener are applied to all domains that satisfy the hostname criteria.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/CN=example.com&#39;</span> -keyout CA.key -out CA.crt
</span></span><span style=display:flex><span>openssl req -out example.com.csr -newkey rsa:2048 -nodes -keyout tls.key -subj <span style=color:#4e9a06>&#34;/CN=example.com&#34;</span>
</span></span></code></pre></div><p>Generate a self-signed wildcard certificate for <code>example.com</code> with <code>*.example.com</code> extension</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | openssl x509 -req -days 365 -CA CA.crt -CAkey CA.key -set_serial 0 \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>-subj &#34;/CN=example.com&#34; \
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>-in example.com.csr -out tls.crt -extensions v3_req  -extfile -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[v3_req]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>keyUsage = keyEncipherment, dataEncipherment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>extendedKeyUsage = serverAuth
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>subjectAltName = @alt_names
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[alt_names]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>DNS.1   = example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>DNS.2   = *.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Create the kubernetes tls secret</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-com --key<span style=color:#ce5c00;font-weight:700>=</span>tls.key --cert<span style=color:#ce5c00;font-weight:700>=</span>tls.crt
</span></span></code></pre></div><p>Define a https listener on the existing gateway</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # hostname: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # hostname: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: example-com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># hostname: &#34;*.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># hostname: &#34;*.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Terminate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>certificateRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Check for any TLS certificate issues on the gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n default describe gateway eg
</span></span></code></pre></div><p>Create two HTTPRoutes and attach them to the HTTP and HTTPS listeners using the <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.CommonRouteSpec>sectionName</a> field.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tls-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # - &#34;*.example.com&#34; # catch all hostnames
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            scheme: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resources to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls-redirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># - &#34;*.example.com&#34; # catch all hostnames</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestRedirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requestRedirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>Curl the example app through http listener:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><p>Curl the example app through https listener:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#39;Host:www.example.com&#39;</span> --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#000>$GATEWAY_HOST</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert CA.crt https://www.example.com:443/get
</span></span></code></pre></div><h2 id=path-redirects>Path Redirects<a class=td-heading-self-link href=#path-redirects aria-label="Heading self-link"></a></h2><p>Path redirects use an HTTP Path Modifier to replace either entire paths or path prefixes. For example, the HTTPRoute
below will issue a 302 redirect to all <code>path.redirect.example</code> requests whose path begins with <code>/get</code> to <code>/status/200</code>.</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-03-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-03-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-path-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.redirect.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: /get
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplaceFullPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replaceFullPath: /status/200
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          statusCode: 302
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http-filter-path-redirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>path.redirect.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/get</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestRedirect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requestRedirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReplaceFullPath</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>replaceFullPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/status/200</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>statusCode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>302</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-path-redirect -o yaml
</span></span></code></pre></div><p>Querying <code>path.redirect.example</code> should result in a <code>302</code> response from the example Gateway and a redirect location
containing the configured redirect path.</p><p>Query the <code>path.redirect.example</code> host:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: path.redirect.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span></code></pre></div><p>You should receive a <code>302</code> with a redirect location of <code>http://path.redirect.example/status/200</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d9c06919ac04c9749373e2a4666cb56f>9 - HTTP Request Headers</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can modify the headers of a request before forwarding it to the upstream service. HTTPRoute
rules cannot use both filter types at once. Currently, Envoy Gateway only supports <strong>core</strong> <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter>HTTPRoute filters</a> which
consist of <code>RequestRedirect</code> and <code>RequestHeaderModifier</code> at the time of this writing. To learn more about HTTP routing,
refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPHeaderFilter><code>RequestHeaderModifier</code> filter</a> instructs Gateways to modify the headers in requests that match the rule
before forwarding the request upstream. Note that the <code>RequestHeaderModifier</code> filter will only modify headers before the
request is sent from Envoy to the upstream service and will not affect response headers returned to the downstream
client.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=adding-request-headers>Adding Request Headers<a class=td-heading-self-link href=#adding-request-headers aria-label="Heading self-link"></a></h2><p>The <code>RequestHeaderModifier</code> filter can add new headers to a request before it is sent to the upstream. If the request
does not have the header configured by the filter, then that header will be added to the request. If the request already
has the header configured by the filter, then the value of the header in the filter will be appended to the value of the
header in the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code> with the value:
<code>something,foo</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;add-header: something&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Add-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;something&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=setting-request-headers>Setting Request Headers<a class=td-heading-self-link href=#setting-request-headers aria-label="Heading self-link"></a></h2><p>Setting headers is similar to adding headers. If the request does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/http-request-headers/#adding-request-headers>adding request headers</a> which will append the value of the header if
the request already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code> with the original value
<code>something</code> replaced by <code>foo</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;set-header: something&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=removing-request-headers>Removing Request Headers<a class=td-heading-self-link href=#removing-request-headers aria-label="Heading self-link"></a></h2><p>Headers can be removed from a request by simply supplying a list of header names.</p><p>Setting headers is similar to adding headers. If the request does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/http-request-headers/#adding-request-headers>adding request headers</a> which will append the value of the header if
the request already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;remove-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code>, but the header
<code>remove-header</code> that was sent by curl was removed before the upstream received the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;add-header: something&#34;</span> --header <span style=color:#4e9a06>&#34;remove-header: foo&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Add-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;something&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=combining-filters>Combining Filters<a class=td-heading-self-link href=#combining-filters aria-label="Heading self-link"></a></h2><p>Headers can be added/set/removed in a single filter on the same HTTPRoute and they will all perform as expected</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;bar&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6fc9216363fce897f9295dbe7a8bc03a>10 - HTTP Response Headers</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can modify the headers of a response before responding it to the downstream service. To learn
more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><p>A <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPHeaderFilter><code>ResponseHeaderModifier</code> filter</a> instructs Gateways to modify the headers in responses that match the
rule before responding to the downstream. Note that the <code>ResponseHeaderModifier</code> filter will only modify headers before
the response is returned from Envoy to the downstream client and will not affect request headers forwarding to the
upstream service.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=adding-response-headers>Adding Response Headers<a class=td-heading-self-link href=#adding-response-headers aria-label="Heading self-link"></a></h2><p>The <code>ResponseHeaderModifier</code> filter can add new headers to a response before it is sent to the upstream. If the response
does not have the header configured by the filter, then that header will be added to the response. If the response
already has the header configured by the filter, then the value of the header in the filter will be appended to the
value of the header in the response.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the downstream client received the header <code>add-header</code> with the value: <code>foo</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: X-Foo: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: X-Foo: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-foo: value1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; add-header: foo
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;X-Foo: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=setting-response-headers>Setting Response Headers<a class=td-heading-self-link href=#setting-response-headers aria-label="Heading self-link"></a></h2><p>Setting headers is similar to adding headers. If the response does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/http-response-headers/#adding-response-headers>adding response headers</a> which will append the value of the header
if the response already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the downstream client received the header <code>set-header</code> with the original value <code>value1</code>
replaced by <code>foo</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: set-header: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: set-header: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; set-header: foo
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;set-header&#34;: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=removing-response-headers>Removing Response Headers<a class=td-heading-self-link href=#removing-response-headers aria-label="Heading self-link"></a></h2><p>Headers can be removed from a response by simply supplying a list of header names.</p><p>Setting headers is similar to adding headers. If the response does not have the header configured by the filter, then it
will be added, but unlike <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/traffic/http-response-headers/#adding-response-headers>adding response headers</a> which will append the value of the header
if the response already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;remove-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the header <code>remove-header</code> that was sent by curl was removed before the upstream
received the response.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: remove-header: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: remove-header: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;remove-header&#34;: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=combining-filters>Combining Filters<a class=td-heading-self-link href=#combining-filters aria-label="Heading self-link"></a></h2><p>Headers can be added/set/removed in a single filter on the same HTTPRoute and they will all perform as expected</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;bar&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-16bbd92cde58954850070a55347ae53b>11 - HTTP Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows users to configure HTTP routing by matching HTTP traffic and forwarding it to
Kubernetes backends. Currently, the only supported backend supported by Envoy Gateway is a Service resource. This guide
shows how to route traffic based on host, header, and path fields and forward the traffic to different Kubernetes
Services. To learn more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> guide to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install the HTTP routing example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/http-routing.yaml
</span></span></code></pre></div><p>The manifest installs a <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, four Deployments, four Services, and three HTTPRoute resources.
The GatewayClass is a cluster-scoped resource that represents a class of Gateways that can be instantiated.</p><p><strong>Note:</strong> Envoy Gateway is configured by default to manage a GatewayClass with
<code>controllerName: gateway.envoyproxy.io/gatewayclass-controller</code>.</p><h2 id=verification>Verification<a class=td-heading-self-link href=#verification aria-label="Heading self-link"></a></h2><p>Check the status of the GatewayClass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gc --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Accepted=True&rdquo;, indicating Envoy Gateway is managing the GatewayClass.</p><p>A Gateway represents configuration of infrastructure. When a Gateway is created, <a href=https://www.envoyproxy.io/>Envoy proxy</a> infrastructure is
provisioned or configured by Envoy Gateway. The <code>gatewayClassName</code> defines the name of a GatewayClass used by this
Gateway. Check the status of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Ready=True&rdquo;, indicating the Envoy proxy infrastructure has been provisioned. The status also
provides the address of the Gateway. This address is used later in the guide to test connectivity to proxied backend
services.</p><p>The three HTTPRoute resources create routing rules on the Gateway. In order to receive traffic from a Gateway,
an HTTPRoute must be configured with <code>parentRefs</code> which reference the parent Gateway(s) that it should be attached to.
An HTTPRoute can match against a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteSpec>single set of hostnames</a>. These hostnames are matched before any other matching
within the HTTPRoute takes place. Since <code>example.com</code>, <code>foo.example.com</code>, and <code>bar.example.com</code> are separate hosts with
different routing requirements, each is deployed as its own HTTPRoute - <code>example-route, ``foo-route</code>, and <code>bar-route</code>.</p><p>Check the status of the HTTPRoutes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing -o yaml
</span></span></code></pre></div><p>The status for each HTTPRoute should surface &ldquo;Accepted=True&rdquo; and a <code>parentRef</code> that references the example Gateway.
The <code>example-route</code> matches any traffic for &ldquo;example.com&rdquo; and forwards it to the &ldquo;example-svc&rdquo; Service.</p><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><p>Before testing HTTP routing to the <code>example-svc</code> backend, get the Gateway&rsquo;s address.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Test HTTP routing to the <code>example-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "example-backend-*"</code> indicating the traffic
was routed to the example backend service. If you change the hostname to a hostname not represented in any of the
HTTPRoutes, e.g. &ldquo;<a href=https://www.example.com>www.example.com</a>&rdquo;, the HTTP traffic will not be routed and a <code>404</code> should be returned.</p><p>The <code>foo-route</code> matches any traffic for <code>foo.example.com</code> and applies its routing rules to forward the traffic to the
&ldquo;foo-svc&rdquo; Service. Since there is only one path prefix match for <code>/login</code>, only <code>foo.example.com/login/*</code> traffic will
be forwarded. Test HTTP routing to the <code>foo-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/login&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "foo-backend-*"</code> indicating the traffic
was routed to the foo backend service. Traffic to any other paths that do not begin with <code>/login</code> will not be matched by
this HTTPRoute. Test this by removing <code>/login</code> from the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>The HTTP traffic will not be routed and a <code>404</code> should be returned.</p><p>Similarly, the <code>bar-route</code> HTTPRoute matches traffic for <code>bar.example.com</code>. All traffic for this hostname will be
evaluated against the routing rules. The most specific match will take precedence which means that any traffic with the
<code>env:canary</code> header will be forwarded to <code>bar-svc-canary</code> and if the header is missing or not <code>canary</code> then it&rsquo;ll be
forwarded to <code>bar-svc</code>. Test HTTP routing to the <code>bar-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "bar-backend-*"</code> indicating the traffic
was routed to the foo backend service.</p><p>Test HTTP routing to the <code>bar-canary-svc</code> backend by adding the <code>env: canary</code> header to the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> --header <span style=color:#4e9a06>&#34;env: canary&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "bar-canary-backend-*"</code> indicating the
traffic was routed to the foo backend service.</p><h3 id=jwt-claims-based-routing>JWT Claims Based Routing<a class=td-heading-self-link href=#jwt-claims-based-routing aria-label="Heading self-link"></a></h3><p>Users can route to a specific backend by matching on JWT claims.
This can be achieved, by defining a SecurityPolicy with a jwt configuration that does the following</p><ul><li>Converts jwt claims to headers, which can be used for header based routing</li><li>Sets the recomputeRoute field to <code>true</code>. This is required so that the incoming request matches on a fallback/catch all route where the JWT can be authenticated, the claims from the JWT can be converted to headers, and then the route match can be recomputed to match based on the updated headers.</li></ul><p>For this feature to work please make sure</p><ul><li>you have a fallback route rule defined, the backend for this route rule can be invalid.</li><li>The SecurityPolicy is applied to both the fallback route as well as the route with the claim header matches, to avoid spoofing.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: SecurityPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: jwt-claim-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jwt:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    providers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        recomputeRoute: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        claimToHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - claim: sub
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            header: x-sub
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - claim: admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            header: x-admin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - claim: name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            header: x-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remoteJWKS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          uri: https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/jwks.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-claim-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: foo-svc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: x-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: John Doe
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: bar-svc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: x-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: Tom
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # catch all
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: infra-backend-invalid
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><p>Test routing to the <code>foo-svc</code> backend by specifying a JWT Token with a claim <code>name: John Doe</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -H <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/login&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .pod
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;foo-backend-6df8cc6b9f-fmwcg&#34;</span>
</span></span></code></pre></div><p>Get another JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/jwt/with-different-claim.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode
</span></span></code></pre></div><p>Test HTTP routing to the <code>bar-svc</code> backend by specifying a JWT Token with a claim <code>name: Tom</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -H <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .pod
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;bar-backend-6688b8944c-s8htr&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9ef62cc770476eae905d426191ca1f1e>12 - HTTP Timeouts</h1><p>The default request timeout is set to 15 seconds in Envoy Proxy.
The <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteTimeouts>HTTPRouteTimeouts</a> resource allows users to configure request timeouts for an <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteRule>HTTPRouteRule</a>.
This task shows you how to configure timeouts.</p><p>The <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteTimeouts>HTTPRouteTimeouts</a> supports two kinds of timeouts:</p><ul><li><strong>request</strong>: Request specifies the maximum duration for a gateway to respond to an HTTP request.</li><li><strong>backendRequest</strong>: BackendRequest specifies a timeout for an individual request from the gateway to a backend.</li></ul><p><strong>Note:</strong> The Request duration must be >= BackendRequest duration</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=verification>Verification<a class=td-heading-self-link href=#verification aria-label="Heading self-link"></a></h2><p>backend has the ability to delay responses; we use it as the backend to control response time.</p><h3 id=request-timeout>request timeout<a class=td-heading-self-link href=#request-timeout aria-label="Heading self-link"></a></h3><p>We configure the backend to delay responses by 3 seconds, then we set the request timeout to 4 seconds. Envoy Gateway will successfully respond to the request.</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-00-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-00-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - timeout.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    timeouts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      request: &#34;4s&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>timeout.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>timeouts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>request</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: timeout.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>3s  -I
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 04 Mar 2024 02:34:21 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 480
</span></span></span></code></pre></div><p>Then we set the request timeout to 2 seconds. In this case, Envoy Gateway will respond with a timeout.</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - timeout.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    timeouts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      request: &#34;2s&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>timeout.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>timeouts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>request</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#4e9a06>&#34;Host: timeout.example.com&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/?delay<span style=color:#ce5c00;font-weight:700>=</span>3s  -v
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 127.0.0.1:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 127.0.0.1 (127.0.0.1) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /?delay<span style=color:#ce5c00;font-weight:700>=</span>3s HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: timeout.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.6.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>504</span> Gateway Timeout
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 24
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: text/plain
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Mon, 04 Mar 2024 02:35:03 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 127.0.0.1 left intact
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>upstream request timeout
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9c8ae25d4ff16fdca687884e6b96ebac>13 - HTTP URL Rewrite</h1><p><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPURLRewriteFilter>HTTPURLRewriteFilter</a> defines a filter that modifies a request during forwarding. At most one of these filters may be
used on a Route rule. This MUST NOT be used on the same Route rule as a HTTPRequestRedirect filter.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=rewrite-url-prefix-path>Rewrite URL Prefix Path<a class=td-heading-self-link href=#rewrite-url-prefix-path aria-label="Heading self-link"></a></h2><p>You can configure to rewrite the prefix in the url like below. In this example, any curls to
<code>http://${GATEWAY_HOST}/get/xxx</code> will be rewritten to <code>http://${GATEWAY_HOST}/replace/xxx</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplacePrefixMatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replacePrefixMatch: /replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get/origin/path</code> should rewrite to
<code>http://${GATEWAY_HOST}/replace/origin/path</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get/origin/path&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get/origin/path HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:03:28 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 503
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/replace/origin/path&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Original-Path&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;/get/origin/path&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;fd84b842-9937-4fb5-83c7-61470d854b90&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Envoy-Original-Path</code> is <code>/get/origin/path</code>, but the actual path is <code>/replace/origin/path</code>.</p><h2 id=rewrite-url-full-path>Rewrite URL Full Path<a class=td-heading-self-link href=#rewrite-url-full-path aria-label="Heading self-link"></a></h2><p>You can configure to rewrite the fullpath in the url like below. In this example, any request sent to
<code>http://${GATEWAY_HOST}/get/origin/path/xxxx</code> will be rewritten to
<code>http://${GATEWAY_HOST}/force/replace/fullpath</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get/origin/path&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplaceFullPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replaceFullPath: /force/replace/fullpath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get/origin/path/extra</code> should rewrite the request to
<code>http://${GATEWAY_HOST}/force/replace/fullpath</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get/origin/path/extra&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get/origin/path/extra HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:09:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/force/replace/fullpath&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Original-Path&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;/get/origin/path/extra&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;8ab774d6-9ffa-4faa-abbb-f45b0db00895&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Envoy-Original-Path</code> is <code>/get/origin/path/extra</code>, but the actual path is
<code>/force/replace/fullpath</code>.</p><h2 id=rewrite-host-name>Rewrite Host Name<a class=td-heading-self-link href=#rewrite-host-name aria-label="Heading self-link"></a></h2><p>You can configure to rewrite the hostname like below. In this example, any requests sent to
<code>http://${GATEWAY_HOST}/get</code> with <code>--header "Host: path.rewrite.example"</code> will rewrite host into <code>envoygateway.io</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: &#34;envoygateway.io&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get</code> with <code>--header "Host: path.rewrite.example"</code> will rewrite host into
<code>envoygateway.io</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:15:15 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 481
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/get&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;envoygateway.io&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Host&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;path.rewrite.example&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;39aa447c-97b9-45a3-a675-9fb266ab1af0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Forwarded-Host</code> is <code>path.rewrite.example</code>, but the actual host is <code>envoygateway.io</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f549ebd4ea04245410497376dd8b0085>14 - HTTP3</h1><p>This task will help you get started using HTTP3 using EG.
This task uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.0/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=tls-certificates>TLS Certificates<a class=td-heading-self-link href=#tls-certificates aria-label="Heading self-link"></a></h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the Gateway from the Quickstart to include an HTTPS listener that listens on port <code>443</code> and references the
<code>example-cert</code> Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Apply the following ClientTrafficPolicy to enable HTTP3</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClientTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: enable-http3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  http3: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><h3 id=clusters-without-external-loadbalancer-support>Clusters without External LoadBalancer Support<a class=td-heading-self-link href=#clusters-without-external-loadbalancer-support aria-label="Heading self-link"></a></h3><p>It is not possible at the moment to port-forward UDP protocol in kubernetes service
check out <a href=https://github.com/kubernetes/kubernetes/issues/47862>https://github.com/kubernetes/kubernetes/issues/47862</a>.
Hence we need external loadbalancer to test this feature out.</p><h3 id=clusters-with-external-loadbalancer-support>Clusters with External LoadBalancer Support<a class=td-heading-self-link href=#clusters-with-external-loadbalancer-support aria-label="Heading self-link"></a></h3><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><p>Below example uses a custom docker image with custom curl binary with built-in http3.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --net<span style=color:#ce5c00;font-weight:700>=</span>host --rm ghcr.io/macbre/curl-http3 curl -kv --http3 -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> https://www.example.com/get
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2a58875123d803c741ef478c99758a6f>15 - HTTPRoute Request Mirroring</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows one or more <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>backendRefs</a> to be provided. Requests will be routed to these upstreams. It is possible to divide the traffic between these backends using <a href=../http-traffic-splitting/>Traffic Splitting</a>, but it is also possible to mirror requests to another Service instead. Request mirroring is accomplished using Gateway API&rsquo;s <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRequestMirrorFilter>HTTPRequestMirrorFilter</a> on the <code>HTTPRoute</code>.</p><p>When requests are made to a <code>HTTPRoute</code> that uses a <code>HTTPRequestMirrorFilter</code>, the response will never come from the <code>backendRef</code> defined in the filter. Responses from the mirror <code>backendRef</code> are always ignored.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=mirroring-the-traffic>Mirroring the Traffic<a class=td-heading-self-link href=#mirroring-the-traffic aria-label="Heading self-link"></a></h2><p>Next, create a new <code>Deployment</code> and <code>Service</code> to mirror requests to. The following example will use
a second instance of the application deployed in the quickstart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Then create an <code>HTTPRoute</code> that uses a <code>HTTPRequestMirrorFilter</code> to send requests to the original
service from the quickstart, and mirror request to the service that was just deployed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-mirror -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-79665566f5-s589f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Check the logs of the pods and you will see that the original deployment and the new deployment each got a request:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl logs deploy/backend <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> kubectl logs deploy/backend-2
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Starting server, listening on port <span style=color:#0000cf;font-weight:700>3000</span> <span style=color:#ce5c00;font-weight:700>(</span>http<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Echoing back request made to /get to client <span style=color:#ce5c00;font-weight:700>(</span>10.42.0.10:41566<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Starting server, listening on port <span style=color:#0000cf;font-weight:700>3000</span> <span style=color:#ce5c00;font-weight:700>(</span>http<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Echoing back request made to /get to client <span style=color:#ce5c00;font-weight:700>(</span>10.42.0.10:45096<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=multiple-backendrefs>Multiple BackendRefs<a class=td-heading-self-link href=#multiple-backendrefs aria-label="Heading self-link"></a></h2><p>When an <code>HTTPRoute</code> has multiple <code>backendRefs</code> and an <code>HTTPRequestMirrorFilter</code>, traffic splitting will still behave the same as it normally would for the main <code>backendRefs</code> while the <code>backendRef</code> of the <code>HTTPRequestMirrorFilter</code> will continue receiving mirrored copies of the incoming requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=multiple-httprequestmirrorfilters>Multiple HTTPRequestMirrorFilters<a class=td-heading-self-link href=#multiple-httprequestmirrorfilters aria-label="Heading self-link"></a></h2><p>Multiple <code>HTTPRequestMirrorFilters</code> are not supported on the same <code>HTTPRoute</code> <code>rule</code>. When attempting to do so, the admission webhook will reject the configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Error from server: error when creating &#34;STDIN&#34;: admission webhook &#34;validate.gateway.networking.k8s.io&#34; denied the request: spec.rules[0].filters: Invalid value: &#34;RequestMirror&#34;: cannot be used multiple times in the same rule
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-12f44b044eacecf5c3da7a150836c8cd>16 - HTTPRoute Traffic Splitting</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows one or more <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>backendRefs</a> to be provided. Requests will be routed to these upstreams
if they match the rules of the HTTPRoute. If an invalid backendRef is configured, then HTTP responses will be returned
with status code <code>500</code> for all requests that would have been sent to that backend.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=single-backendref>Single backendRef<a class=td-heading-self-link href=#single-backendref aria-label="Heading self-link"></a></h2><p>When a single backendRef is configured in a HTTPRoute, it will receive 100% of the traffic.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-79665566f5-s589f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=multiple-backendrefs>Multiple backendRefs<a class=td-heading-self-link href=#multiple-backendrefs aria-label="Heading self-link"></a></h2><p>If multiple backendRefs are configured, then traffic will be split between the backendRefs equally unless a weight is
configured.</p><p>First, create a second instance of the example app from the quickstart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Then create an HTTPRoute that uses both the app from the quickstart and the second instance that was just created</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in <code>200</code> responses from the example Gateway and the output from the
example app that indicates which pod handled the request should switch between the first pod and the second one from the
new deployment on subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-75bcd4c969-lsxpz&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=weighted-backendrefs>Weighted backendRefs<a class=td-heading-self-link href=#weighted-backendrefs aria-label="Heading self-link"></a></h2><p>If multiple backendRefs are configured and an un-even traffic split between the backends is desired, then the <code>weight</code>
field can be used to control the weight of requests to each backend. If weight is not configured for a backendRef it is
assumed to be <code>1</code>.</p><p>The <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.BackendRef>weight field in a backendRef</a> controls the distribution of the traffic split. The proportion of
requests to a single backendRef is calculated by dividing its <code>weight</code> by the sum of all backendRef weights in the
HTTPRoute. The weight is not a percentage and the sum of all weights does not need to add up to 100.</p><p>The HTTPRoute below will configure the gateway to send 80% of the traffic to the backend service, and 20% to the
backend-2 service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 8
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=invalid-backendrefs>Invalid backendRefs<a class=td-heading-self-link href=#invalid-backendrefs aria-label="Heading self-link"></a></h2><p>backendRefs can be considered invalid for the following reasons:</p><ul><li>The <code>group</code> field is configured to something other than <code>""</code>. Currently, only the core API group (specified by
omitting the group field or setting it to an empty string) is supported</li><li>The <code>kind</code> field is configured to anything other than <code>Service</code>. Envoy Gateway currently only supports Kubernetes
Service backendRefs</li><li>The backendRef configures a service with a <code>namespace</code> not permitted by any existing ReferenceGrants</li><li>The <code>port</code> field is not configured or is configured to a port that does not exist on the Service</li><li>The named Service configured by the backendRef cannot be found</li></ul><p>Modifying the above example to make the backend-2 backendRef invalid by using a port that does not exist on the Service
will result in 80% of the traffic being sent to the backend service, and 20% of the traffic receiving an HTTP response
with status code <code>500</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 8
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in <code>200</code> responses 80% of the time, and <code>500</code> responses 20% of the time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 500 Internal Server Error
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cc09b3a499eecf47e84cd8631cb2a115>17 - Local Rate Limit</h1><p>Rate limit is a feature that allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p><p>Here are some reasons why you may want to implement Rate limits</p><ul><li>To prevent malicious activity such as DDoS attacks.</li><li>To prevent applications and its resources (such as a database) from getting overloaded.</li><li>To create API limits based on user entitlements.</li></ul><p>Envoy Gateway supports two types of rate limiting: <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> and <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting>Local rate limiting</a>.</p><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting>Local rate limiting</a> applies rate limits to the traffic flowing through a single instance of Envoy proxy. This means
that if the data plane has 2 replicas of Envoy running, and the rate limit is 10 requests/second, each replica will allow
10 requests/second. This is in contrast to <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global Rate Limiting</a> which applies rate limits to the traffic flowing through
all instances of Envoy proxy.</p><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their rate limit intent.
This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note:</strong> Limit is applied per route. Even if a <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> targets a gateway, each route in that gateway
still has a separate rate limit bucket. For example, if a gateway has 2 routes, and the limit is 100r/s, then each route
has its own 100r/s rate limit bucket.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><h3 id=install-envoy-gateway>Install Envoy Gateway<a class=td-heading-self-link href=#install-envoy-gateway aria-label="Heading self-link"></a></h3><ul><li>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the HTTPRoute example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</li></ul><h2 id=rate-limit-specific-user>Rate Limit Specific User<a class=td-heading-self-link href=#rate-limit-specific-user aria-label="Heading self-link"></a></h2><p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code>x-user-id</code> header
with a value set to <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    local:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: one
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute>HTTPRoute<a class=td-heading-self-link href=#httproute aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-ratelimit -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Let&rsquo;s query <code>ratelimit.example/get</code> 4 times. We should receive a <code>200</code> response from the example Gateway for the first 3 requests
and then receive a <code>429</code> status code for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code>x-user-id</code>
and value <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should be able to send requests with the <code>x-user-id</code> header and a different value and receive successful responses from the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:38 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:39 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h2 id=rate-limit-all-requests>Rate Limit All Requests<a class=td-heading-self-link href=#rate-limit-all-requests aria-label="Heading self-link"></a></h2><p>This example shows you how to rate limit all requests matching the HTTPRoute rule at 3 requests/Hour by leaving the <code>clientSelectors</code> field unset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: policy-httproute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    local:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute<a class=td-heading-self-link href=#httproute-1 aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p><strong>Note:</strong> Local rate limiting does not support <code>distinct</code> matching. If you want to rate limit based on distinct values,
you should use <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global Rate Limiting</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ba1ec4ec38519695fc7b12cca73d68fc>18 - Multicluster Service Routing</h1><p>The Multicluster Service API ServiceImport object can be used as part of the GatewayAPI backendRef for configuring routes. For more information about multicluster service API follow <a href=https://multicluster.sigs.k8s.io/concepts/multicluster-services-api/>sig documentation</a>.</p><p>We will use <a href=https://github.com/submariner-io/submariner>Submariner project</a> for setting up the multicluster environment for exporting the service to be routed from peer clusters.</p><h2 id=setting-kind-clusters-and-installing-submariner>Setting KIND clusters and installing Submariner.<a class=td-heading-self-link href=#setting-kind-clusters-and-installing-submariner aria-label="Heading self-link"></a></h2><ul><li>We will be using KIND clusters to demonstrate this example.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/submariner-io/submariner-operator
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> submariner-operator
</span></span><span style=display:flex><span>make clusters
</span></span></code></pre></div><p>Note: remain in submariner-operator directory for the rest of the steps in this section</p><ul><li>Install subctl:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -Ls https://get.submariner.io  <span style=color:#000;font-weight:700>|</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v0.14.6 bash
</span></span></code></pre></div><ul><li>Set up multicluster service API and submariner for cross cluster traffic using ServiceImport</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>subctl deploy-broker --kubeconfig output/kubeconfigs/kind-config-cluster1 --globalnet
</span></span><span style=display:flex><span>subctl join --kubeconfig output/kubeconfigs/kind-config-cluster1 broker-info.subm --clusterid cluster1 --natt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>subctl join --kubeconfig output/kubeconfigs/kind-config-cluster2 broker-info.subm --clusterid cluster2 --natt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><p>Once the above steps are done and all the pods are up in both the clusters. We are ready for installing envoy gateway.</p><h2 id=install-envoygateway>Install EnvoyGateway<a class=td-heading-self-link href=#install-envoygateway aria-label="Heading self-link"></a></h2><p>Install the Gateway API CRDs and Envoy Gateway in cluster1:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.0.2 -n envoy-gateway-system --create-namespace --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><h2 id=install-application>Install Application<a class=td-heading-self-link href=#install-application aria-label="Heading self-link"></a></h2><p>Install the backend application in cluster2 and export it through subctl command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/application.yaml --kubeconfig output/kubeconfigs/kind-config-cluster2
</span></span><span style=display:flex><span>subctl <span style=color:#204a87>export</span> service backend --namespace default --kubeconfig output/kubeconfigs/kind-config-cluster2
</span></span></code></pre></div><h2 id=create-gateway-api-objects>Create Gateway API Objects<a class=td-heading-self-link href=#create-gateway-api-objects aria-label="Heading self-link"></a></h2><p>Create the Gateway API objects GatewayClass, Gateway and HTTPRoute in cluster1 to set up the routing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/multicluster-service.yaml --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><h2 id=testing-the-configuration>Testing the Configuration<a class=td-heading-self-link href=#testing-the-configuration aria-label="Heading self-link"></a></h2><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:80 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0cb6850ac9ce2a7f41a62fa1e9626bef>19 - Retry</h1><p>A retry setting specifies the maximum number of times an Envoy proxy attempts to connect to a service if the initial call fails. Retries can enhance service availability and application performance by making sure that calls don’t fail permanently because of transient problems such as a temporarily overloaded service or network. The interval between retries prevents the called service from being overwhelmed with requests.</p><p>Envoy Gateway supports the following retry settings:</p><ul><li><strong>NumRetries</strong>: is the number of retries to be attempted. Defaults to 2.</li><li><strong>RetryOn</strong>: specifies the retry trigger condition.</li><li><strong>PerRetryPolicy</strong>: is the retry policy to be applied per retry attempt.</li></ul><p>Envoy Gateway introduces a new CRD called <a href=../../../api/extension_types#backendtrafficpolicy>BackendTrafficPolicy</a> that allows the user to describe their desired retry settings. This instantiated resource can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource.</p><p><strong>Note</strong>: There are distinct circuit breaker counters for each <code>BackendReference</code> in an <code>xRoute</code> rule. Even if a <code>BackendTrafficPolicy</code> targets a <code>Gateway</code>, each <code>BackendReference</code> in that gateway still has separate circuit breaker counter.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the installation step from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and sample resources.</p><h2 id=test-and-customize-retry-settings>Test and customize retry settings<a class=td-heading-self-link href=#test-and-customize-retry-settings aria-label="Heading self-link"></a></h2><p>Before applying a <code>BackendTrafficPolicy</code> with retry setting to a route, let&rsquo;s test the default retry settings.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/status/500&#34;</span>
</span></span></code></pre></div><p>It will return <code>500</code> response immediately.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 172.18.255.200:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 172.18.255.200 (172.18.255.200) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /status/500 HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.4.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>500</span> Internal Server Error
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Fri, 01 Mar 2024 15:12:55 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 172.18.255.200 left intact
</span></span></span></code></pre></div><p>Let&rsquo;s create a <code>BackendTrafficPolicy</code> with a retry setting.</p><p>The request will be retried 5 times with a 100ms base interval and a 10s maximum interval.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: BackendTrafficPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: retry-for-route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  retry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    numRetries: 5
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    perRetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backOff:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        baseInterval: 100ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        maxInterval: 10s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      timeout: 250ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    retryOn:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      httpStatusCodes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - 500
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      triggers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - connect-failure
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - retriable-status-codes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Execute the test again.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/status/500&#34;</span>
</span></span></code></pre></div><p>It will return <code>500</code> response after a few while.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>*   Trying 172.18.255.200:80...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connected to 172.18.255.200 (172.18.255.200) port 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /status/500 HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: www.example.com
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/8.4.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>500</span> Internal Server Error
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Fri, 01 Mar 2024 15:15:53 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Connection #0 to host 172.18.255.200 left intact
</span></span></span></code></pre></div><p>Let&rsquo;s check the stats to see the retry behavior.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x stats envoy-proxy -n envoy-gateway-system -l gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg,gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;envoy_cluster_upstream_rq_retry{envoy_cluster_name=\&#34;httproute/default/backend/rule/0\&#34;}&#34;</span>
</span></span></code></pre></div><p>You will expect to see the stats.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>envoy_cluster_upstream_rq_retry{envoy_cluster_name=&#34;httproute/default/backend/rule/0&#34;} 5
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1493ff48f742d233da4aba78a90af506>20 - Routing outside Kubernetes</h1><p>Routing to endpoints outside the Kubernetes cluster where Envoy Gateway and its corresponding Envoy Proxy fleet is
running is a common use case. This can be achieved by defining FQDN addresses in a <a href=https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/>EndpointSlice</a>.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Define a Service and EndpointSlice that represents <a href=https://httpbin.org>https://httpbin.org</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: discovery.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EndpointSlice
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes.io/service-name: httpbin 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>addressType: FQDN
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>- name: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>- addresses:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;httpbin.org&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Update the <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a> to include a TLS Listener on port 443</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        mode: Passthrough
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Add a <a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a> that can route incoming traffic to the above backend that we created</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TLSRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: httpbin 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Get the Gateway address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Send a request and view the response:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -I -HHost:httpbin.org --resolve <span style=color:#4e9a06>&#34;httpbin.org:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> https://httpbin.org/
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a9a83c91d0725135fa45d88eded85a47>21 - TCP Routing</h1><p><a href=https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> provides a way to route TCP requests. When combined with a Gateway listener, it can be used to forward
connections on the port specified by the listener to a set of backends specified by the TCPRoute. To learn more about
HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> guide to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>In this example, we have one Gateway resource and two TCPRoute resources that distribute the traffic with the following
rules:</p><p>All TCP streams on port <code>8088</code> of the Gateway are forwarded to port 3001 of <code>foo</code> Kubernetes Service.
All TCP streams on port <code>8089</code> of the Gateway are forwarded to port 3002 of <code>bar</code> Kubernetes Service.
In this example two TCP listeners will be applied to the Gateway in order to route them to two separate backend
TCPRoutes, note that the protocol set for the listeners on the Gateway is TCP:</p><p>Install the GatewayClass and a <code>tcp-gateway</code> Gateway first.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 8088
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 8089
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Install two services <code>foo</code> and <code>bar</code>, which are binded to <code>backend-1</code> and <code>backend-2</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3001
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-gateway-api/echo-basic:v20231214-v1.0.0-140-gf544a46e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Install two TCPRoutes <code>tcp-app-1</code> and <code>tcp-app-2</code> with different <code>sectionName</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-app-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3001
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-app-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>In the above example we separate the traffic for the two separate backend TCP Services by using the sectionName field in
the parentRefs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This corresponds directly with the name in the listeners in the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8088</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8089</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>In this way each TCPRoute &ldquo;attaches&rdquo; itself to a different port on the Gateway so that the <code>foo</code> service
is taking traffic for port <code>8088</code> from outside the cluster and <code>bar</code> service takes the port <code>8089</code> traffic.</p><p>Before testing, please get the tcp-gateway Gateway&rsquo;s address first:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/tcp-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>You can try to use nc to test the TCP connections of envoy gateway with different ports, and you can see them succeeded:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nc -zv <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> <span style=color:#0000cf;font-weight:700>8088</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nc -zv <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> <span style=color:#0000cf;font-weight:700>8089</span>
</span></span></code></pre></div><p>You can also try to send requests to envoy gateway and get responses as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:8088&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#0000cf;font-weight:700>03</span> Jan <span style=color:#0000cf;font-weight:700>2023</span> 10:18:36 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#0000cf;font-weight:700>267</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;xxx.xxx.xxx.xxx:8088&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.85.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-1-c6c5fb958-dl8vl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see that the traffic routing to <code>foo</code> service when sending request to <code>8088</code> port.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:8089&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#0000cf;font-weight:700>03</span> Jan <span style=color:#0000cf;font-weight:700>2023</span> 10:19:28 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#0000cf;font-weight:700>267</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;xxx.xxx.xxx.xxx:8089&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.85.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;bar&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-2-98fcff498-hcmgb&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>                                            
</span></span></code></pre></div><p>You can see that the traffic routing to <code>bar</code> service when sending request to <code>8089</code> port.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d78a844d0a1fc300cdb34903c1bfd56>22 - UDP Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a> resource allows users to configure UDP routing by matching UDP traffic and forwarding it to Kubernetes
backends. This task will use CoreDNS example to walk you through the steps required to configure UDPRoute on Envoy
Gateway.</p><p><strong>Note:</strong> UDPRoute allows Envoy Gateway to operate as a non-transparent proxy between a UDP client and server. The lack
of transparency means that the upstream server will see the source IP and port of the Gateway instead of the client.
For additional information, refer to Envoy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/udp_filters/udp_proxy>UDP proxy documentation</a>.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=installation>Installation<a class=td-heading-self-link href=#installation aria-label="Heading self-link"></a></h2><p>Install CoreDNS in the Kubernetes cluster as the example backend. The installed CoreDNS is listening on
UDP port 53 for DNS lookups.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/udp-routing-example-backend.yaml
</span></span></code></pre></div><p>Wait for the CoreDNS deployment to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m deployment/coredns --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Update the Gateway from the Quickstart to include a UDP listener that listens on UDP port <code>5300</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    path: /spec/listeners/-
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: UDP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 5300
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - kind: UDPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Create a UDPRoute resource to route UDP traffic received on Gateway port 5300 to the CoredDNS backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: UDPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 53
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the UDPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get udproute/coredns -o yaml
</span></span></code></pre></div><h2 id=testing>Testing<a class=td-heading-self-link href=#testing aria-label="Heading self-link"></a></h2><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Use <code>dig</code> command to query the dns entry foo.bar.com through the Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dig @<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> -p <span style=color:#0000cf;font-weight:700>5300</span> foo.bar.com
</span></span></code></pre></div><p>You should see the result of the dns query as the below output, which means that the dns query has been successfully
routed to the backend CoreDNS.</p><p>Note: 49.51.177.138 is the resolved address of GATEWAY_HOST.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> &lt;&lt;&gt;&gt; DiG 9.18.1-1ubuntu1.1-Ubuntu &lt;&lt;&gt;&gt; @49.51.177.138 -p <span style=color:#0000cf;font-weight:700>5300</span> foo.bar.com
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> server found<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> global options: +cmd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> Got answer:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> -&gt;&gt;HEADER<span style=color:#4e9a06>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#0000cf;font-weight:700>58125</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> flags: qr aa rd<span style=color:#000;font-weight:700>;</span> QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> WARNING: recursion requested but not available
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> OPT PSEUDOSECTION:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> EDNS: version: 0, flags:<span style=color:#000;font-weight:700>;</span> udp: <span style=color:#0000cf;font-weight:700>1232</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> COOKIE: 24fb86eba96ebf62 <span style=color:#ce5c00;font-weight:700>(</span>echoed<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> QUESTION SECTION:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span>foo.bar.com.			IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> ADDITIONAL SECTION:
</span></span><span style=display:flex><span>foo.bar.com.		0	IN	A	10.244.0.19
</span></span><span style=display:flex><span>_udp.foo.bar.com.	0	IN	SRV	<span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>42376</span> .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> Query time: <span style=color:#0000cf;font-weight:700>1</span> msec
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> SERVER: 49.51.177.138#5300<span style=color:#ce5c00;font-weight:700>(</span>49.51.177.138<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>UDP<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> WHEN: Fri Jan <span style=color:#0000cf;font-weight:700>13</span> 10:20:34 UTC <span style=color:#0000cf;font-weight:700>2023</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> MSG SIZE  rcvd: <span style=color:#0000cf;font-weight:700>114</span>
</span></span></code></pre></div><h2 id=clean-up>Clean-Up<a class=td-heading-self-link href=#clean-up aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=../../quickstart>Quickstart</a> to uninstall Envoy Gateway.</p><p>Delete the CoreDNS example manifest and the UDPRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deploy/coredns
</span></span><span style=display:flex><span>kubectl delete service/coredns
</span></span><span style=display:flex><span>kubectl delete cm/coredns
</span></span><span style=display:flex><span>kubectl delete udproute/coredns
</span></span></code></pre></div><h2 id=next-steps>Next Steps<a class=td-heading-self-link href=#next-steps aria-label="Heading self-link"></a></h2><p>Checkout the <a href=/eg-pr-preview/6-test-preview/contributions/develop/>Developer Guide</a> to get involved in the project.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=mailto:envoy-users@googlegroups.com aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Twitter aria-label=Twitter><a target=_blank rel=noopener href=https://twitter.com/EnvoyProxy aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/envoyproxy/gateway aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://envoyproxy.slack.com/archives/C03E6NHLESV aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2025
<span class=td-footer__authors>The Envoy Gateway Authors</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><p class="td-footer__about mt-2"><a href=/eg-pr-preview/6-test-preview/about/>About Envoy Gateway</a></p></div></div></div></footer></div><script src=/eg-pr-preview/6-test-preview/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/eg-pr-preview/6-test-preview/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/eg-pr-preview/6-test-preview/js/tabpane-persist.js></script></body></html>