<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zirain.github.io/eg-pr-preview/6-test-preview/v1.2/tasks/observability/><link rel=alternate type=application/rss+xml href=https://zirain.github.io/eg-pr-preview/6-test-preview/v1.2/tasks/observability/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/eg-pr-preview/6-test-preview/favicons/favicon.ico><link rel=apple-touch-icon href=/eg-pr-preview/6-test-preview/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/eg-pr-preview/6-test-preview/favicons/android-192x192.png sizes=192x192><title>Observability | Envoy Gateway</title>
<meta name=description content="This section includes Observability tasks."><meta property="og:url" content="https://zirain.github.io/eg-pr-preview/6-test-preview/v1.2/tasks/observability/"><meta property="og:site_name" content="Envoy Gateway"><meta property="og:title" content="Observability"><meta property="og:description" content="This section includes Observability tasks."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Observability"><meta itemprop=description content="This section includes Observability tasks."><meta itemprop=dateModified content="2025-01-14T19:35:21+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Observability"><meta name=twitter:description content="This section includes Observability tasks."><link rel=preload href=/eg-pr-preview/6-test-preview/scss/main.min.13dd8d11b772c2d11eac755eb5d2d8924f18f01762c20defa026366a1f00937d.css as=style><link href=/eg-pr-preview/6-test-preview/scss/main.min.13dd8d11b772c2d11eac755eb5d2d8924f18f01762c20defa026366a1f00937d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-DXJEH1ZRXX"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DXJEH1ZRXX")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/eg-pr-preview/6-test-preview/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 1200 400"><defs><style>.cls-1{fill:#d04c9b}.cls-2{fill:#4a2365}.cls-3{fill:#b96aab}.cls-4{isolation:isolate}.cls-5{fill:#a53995}</style></defs><g><g id="Layer_1"><g><polygon id="polygon20" class="cls-5" points="191.2 242.29 190.55 213 159.76 193.83 160.4 223.12 191.2 242.29"/><path id="path22" class="cls-5" d="M234.92 315.52l-.65-28.65-26.92-16.8c-.43-.21-.86-.64-1.08-.86l.65 28.86 28 17.45h0z"/><path id="path24" class="cls-5" d="M138.65 354.07l-70.42-43.72-1.73-73.23 34.46-14.86-.65-29.29-55.14 23.69c-4.3 1.94-6.89 5.81-6.67 10.33l2.15 87.87c0 4.53 2.8 9.06 7.11 11.64l84.43 52.33c3.88 2.37 8.61 3.02 12.71 1.94.43-.21.86-.21 1.29-.43l51.9-22.39-28.21-17.45-31.23 13.57h0z"/><path id="path26" class="cls-3" d="M366.29 192.11c-.21-5.17-3.23-10.55-8.39-13.57l-102.52-63.53-3.23 1.29.64 30.8 81.19 50.4 1.94 82.27 31.01 19.17 1.72-.64-2.37-106.18h0z"/><path id="path28" class="cls-3" d="M243.53 336.62l-95.41-59.01-2.37-99.07 43.51-18.74-.86-34.24-67.41 29.07c-4.95 2.16-7.97 6.68-7.75 12.06l2.8 116.3c0 5.38 3.23 10.56 8.4 13.57l111.78 69.35c4.52 2.79 10.12 3.66 14.86 2.15.43-.22.86-.43 1.29-.43l65.9-28.44-32.73-20.25-42 17.67h0z"/><path id="path30" class="cls-1" d="M511.67 110.69 368.45 21.96c-5.38-3.23-11.62-4.1-17-2.37-.44.21-1.08.43-1.51.64L210.16 80.54c-5.6 2.37-9.04 7.54-8.83 13.78l3.44 149.04c.22 6.03 3.88 12.06 9.7 15.51l143.22 88.73c5.17 3.23 11.63 4.09 17.01 2.38.43-.22 1.08-.44 1.51-.65l139.78-60.3c5.59-2.37 9.05-7.75 8.84-13.79l-3.45-149.04c-.21-6.03-3.88-11.85-9.69-15.51M366.08 314.22 241.6 237.11l-3.02-129.44 121.47-52.33 124.49 77.1 3.02 129.45-121.47 52.33h0z"/></g><path id="path10" class="cls-2" d="M607.46 182.14c0 4.62 1.08 9.04 3.23 12.83 2.16 3.78 4.95 7.15 8.18 9.88 3.44 2.74 7.33 4.84 11.84 6.32 4.52 1.47 9.26 2.31 14 2.31 6.46.0 12.27-1.48 17.01-4.41 4.73-2.96 9.26-6.96 13.35-11.79L691 209.07c-11.63 14.71-27.99 22.08-48.88 22.08-8.61.0-16.58-1.47-23.69-4.41-7.11-2.96-13.13-6.95-17.88-12-4.95-5.05-8.61-11.15-11.19-17.88-2.58-6.94-3.88-14.31-3.88-22.51s1.51-15.57 4.31-22.51 6.89-12.83 11.84-17.88 10.98-9.04 18.09-12c6.9-2.94 14.65-4.42 22.83-4.42 9.69.0 18.09 1.69 24.77 5.06 6.67 3.36 12.27 7.77 16.58 13.03 4.31 5.48 7.54 11.37 9.48 18.31 1.94 6.73 3.01 13.67 3.01 20.62v7.37h-88.93v.21h0zM673.78 165.95c-.22-4.63-.86-8.64-2.15-12.42-1.29-3.79-3.23-7.15-6.03-9.89-2.59-2.74-6.02-5.05-9.91-6.53-3.88-1.69-8.61-2.31-13.78-2.31s-9.9 1.05-13.99 2.94c-4.31 1.88-7.97 4.42-10.77 7.36-3.01 2.94-5.17 6.31-6.89 10.1s-2.37 7.37-2.37 10.95h65.89v-.21h0z"/><path id="path12" class="cls-2" d="M714.26 120.71h20.89v16.61h.43c2.58-5.68 7.32-10.52 13.78-13.88 6.46-3.58 14-5.26 22.61-5.26 5.39.0 10.34.84 15.29 2.31 4.95 1.68 9.26 4.01 12.71 7.36 3.66 3.37 6.46 7.57 8.83 12.84 2.16 5.26 3.23 11.36 3.23 18.51v69.44h-20.89v-63.76c0-5.05-.65-9.25-2.15-12.83-1.3-3.58-3.23-6.53-5.6-8.64-2.37-2.1-4.95-3.79-7.97-4.83-3.01-1.06-6.24-1.48-9.47-1.48-4.3.0-8.4.63-12.06 2.1-3.66 1.48-6.89 3.58-9.68 6.53-2.8 2.94-4.96 6.73-6.47 11.35-1.5 4.63-2.37 9.89-2.37 16.21v55.55h-20.88V120.69h-.22v.02z"/><polygon id="polygon14" class="cls-2" points="843.03 120.71 875.98 203.4 907.63 120.71 930.03 120.71 886.74 228.64 863.71 228.64 818.7 120.71 843.03 120.71"/><path id="path16" class="cls-2" d="M931.53 174.77c0-7.78 1.51-15.15 4.53-22.09 3.01-6.73 7.1-12.83 12.49-17.88 5.38-5.06 11.41-9.26 18.73-12.2 7.12-2.95 14.86-4.42 23.04-4.42s15.93 1.47 23.04 4.42c7.1 2.94 13.36 6.93 18.73 12.2 5.17 5.25 9.48 11.15 12.5 17.88 3.01 6.73 4.53 14.1 4.53 22.09s-1.52 15.36-4.53 22.1c-3.02 6.94-7.11 12.83-12.5 17.88-5.37 5.05-11.4 9.04-18.73 12-7.11 2.94-14.85 4.41-23.04 4.41s-15.93-1.47-23.04-4.41c-7.1-2.96-13.35-6.95-18.73-12-5.39-5.05-9.48-11.15-12.49-17.88-3.01-6.94-4.53-14.31-4.53-22.1M953.71 174.77c0 5.47.86 10.52 2.59 15.15 1.71 4.62 4.09 8.62 7.31 11.79 3.02 3.37 6.9 5.89 11.42 7.78 4.52 1.89 9.48 2.94 15.08 2.94s10.55-.84 15.07-2.94c4.51-1.89 8.4-4.41 11.42-7.78 3-3.16 5.59-7.16 7.31-11.79 1.73-4.63 2.59-9.68 2.59-15.15s-.86-10.52-2.59-15.15c-1.71-4.63-4.09-8.63-7.31-11.78-3.02-3.15-6.9-5.89-11.42-7.78-4.52-1.89-9.48-2.94-15.07-2.94s-10.56 1.05-15.08 2.94c-4.52 1.9-8.39 4.42-11.42 7.78-3 3.37-5.59 7.15-7.31 11.78-1.73 4.63-2.59 9.68-2.59 15.15"/><path id="path18" class="cls-2" d="M1050.39 120.71h24.12l32.74 84.15h.42l31.44-84.15h22.4l-52.32 131.07c-1.94 4.63-3.88 9.05-5.82 12.84s-4.31 7.15-7.11 9.88c-2.79 2.73-6.25 4.84-10.12 6.31-3.88 1.48-8.82 2.31-14.43 2.31-3.02.0-6.24-.21-9.48-.62-3.22-.41-6.25-1.26-9.25-2.31l2.58-18.74c4.09 1.69 8.4 2.53 12.49 2.53 3.24.0 6.03-.42 8.18-1.26 2.16-.84 4.09-2.1 5.81-3.58 1.73-1.69 3.03-3.36 4.09-5.46 1.08-2.12 2.15-4.63 3.23-7.37l6.88-17.04-45.86-108.56h0z"/><g class="cls-4"><path class="cls-5" d="M636.86 328.23c0 8.4-2.15 14.77-6.44 19.14-4.3 4.36-10.51 6.54-18.65 6.54-4.53.0-8.61-.66-12.25-1.97s-7.1-3.58-10.38-6.79l5.51-6.3c2.43 2.62 5 4.61 7.72 5.95s5.85 2.02 9.4 2.02 6.25-.51 8.51-1.52c2.26-1.02 4.05-2.4 5.36-4.13 1.31-1.74 2.23-3.72 2.75-5.95.52-2.23.79-4.56.79-6.99v-5.9h-.2c-1.84 2.95-4.23 5.12-7.18 6.49-2.95 1.38-5.97 2.07-9.05 2.07-3.61.0-6.92-.59-9.94-1.77-3.02-1.18-5.61-2.82-7.77-4.92s-3.84-4.59-5.02-7.48c-1.18-2.89-1.77-6.03-1.77-9.45.0-3.74.59-7.12 1.77-10.13 1.18-3.02 2.84-5.56 4.97-7.62 2.13-2.07 4.71-3.66 7.72-4.77 3.02-1.11 6.36-1.67 10.04-1.67 1.57.0 3.15.18 4.72.54s3.1.92 4.58 1.67 2.8 1.71 3.98 2.85c1.18 1.15 2.17 2.48 2.95 3.98h.2v-7.87h7.67v43.98zm-40.34-20.95c0 2.36.43 4.54 1.28 6.54s2.02 3.74 3.49 5.21c1.48 1.48 3.2 2.64 5.17 3.49 1.97.85 4.07 1.28 6.3 1.28 2.62.0 4.95-.46 6.99-1.38 2.03-.92 3.75-2.15 5.17-3.69 1.41-1.54 2.48-3.31 3.2-5.31s1.08-4.12 1.08-6.35c0-2.49-.39-4.77-1.18-6.84s-1.9-3.85-3.34-5.36-3.18-2.67-5.21-3.49c-2.03-.82-4.26-1.23-6.69-1.23s-4.64.44-6.64 1.33c-2 .88-3.71 2.1-5.12 3.64-1.41 1.54-2.51 3.35-3.3 5.41-.79 2.07-1.18 4.31-1.18 6.74z"/><path class="cls-5" d="M650.44 290.16c2.36-2.43 5.17-4.21 8.41-5.36 3.25-1.15 6.54-1.72 9.89-1.72 6.82.0 11.74 1.61 14.76 4.82s4.53 8.1 4.53 14.66v19.78c0 1.31.06 2.67.2 4.08.13 1.41.3 2.71.49 3.89h-7.38c-.26-1.05-.41-2.21-.44-3.49-.03-1.28-.05-2.41-.05-3.39h-.2c-1.51 2.36-3.53 4.3-6.05 5.81-2.53 1.51-5.56 2.26-9.1 2.26-2.36.0-4.58-.29-6.64-.89-2.07-.59-3.87-1.46-5.41-2.61-1.54-1.15-2.77-2.57-3.69-4.28-.92-1.71-1.38-3.67-1.38-5.9.0-3.8.98-6.79 2.95-8.95 1.97-2.16 4.41-3.77 7.33-4.82 2.92-1.05 6.07-1.7 9.45-1.97 3.38-.26 6.48-.39 9.3-.39h2.95v-1.38c0-3.35-1-5.87-3-7.58s-4.81-2.56-8.41-2.56c-2.49.0-4.94.41-7.33 1.23-2.4.82-4.51 2.08-6.35 3.79l-4.82-5.02zM672.67 308.16c-4.92.0-8.82.69-11.71 2.07s-4.33 3.64-4.33 6.79c0 2.89.97 4.94 2.9 6.15s4.34 1.82 7.23 1.82c2.23.0 4.18-.38 5.85-1.13 1.67-.75 3.07-1.75 4.18-3 1.12-1.25 1.97-2.71 2.56-4.38.59-1.67.92-3.46.98-5.36v-2.95h-7.67z"/><path class="cls-5" d="M727.28 290.75H713.7v23.02c0 1.51.03 2.9.1 4.18.06 1.28.33 2.39.79 3.34.46.95 1.15 1.71 2.07 2.26.92.56 2.23.84 3.94.84 1.11.0 2.26-.13 3.44-.39 1.18-.26 2.3-.66 3.35-1.18l.29 6.99c-1.31.59-2.77 1.02-4.38 1.28s-3.13.39-4.58.39c-2.75.0-4.95-.36-6.59-1.08-1.64-.72-2.92-1.74-3.84-3.05-.92-1.31-1.52-2.93-1.82-4.87-.29-1.93-.44-4.08-.44-6.44v-25.29h-10.04v-6.49h10.04v-13.09h7.67v13.09h13.58v6.49z"/><path class="cls-5" d="M777.85 321.94c-2.75 3.54-5.77 6.02-9.05 7.43s-7.08 2.12-11.41 2.12c-3.61.0-6.85-.64-9.74-1.92-2.89-1.28-5.33-3-7.33-5.17s-3.54-4.72-4.62-7.67-1.62-6.1-1.62-9.45c0-3.54.59-6.8 1.77-9.79 1.18-2.98 2.82-5.54 4.92-7.67 2.1-2.13 4.59-3.79 7.48-4.97s6.03-1.77 9.45-1.77c3.21.0 6.17.54 8.86 1.62s5 2.66 6.94 4.72c1.93 2.07 3.43 4.59 4.48 7.58 1.05 2.99 1.57 6.38 1.57 10.18v2.46h-37.19c.13 1.97.61 3.85 1.43 5.66.82 1.81 1.88 3.38 3.2 4.72 1.31 1.35 2.85 2.41 4.62 3.2 1.77.79 3.71 1.18 5.8 1.18 3.35.0 6.17-.59 8.46-1.77 2.29-1.18 4.36-2.92 6.2-5.21l5.8 4.53zM771.26 303.14c-.13-3.94-1.41-7.08-3.84-9.45-2.43-2.36-5.77-3.54-10.04-3.54s-7.71 1.18-10.33 3.54-4.2 5.51-4.72 9.45h28.93z"/><path class="cls-5" d="M840.82 330.3h-7.58l-13.09-35.42h-.2l-11.61 35.42h-7.87l-14.96-46.05h8.46l10.53 35.42h.2l11.91-35.42h8.07l12.1 35.42h.2l10.43-35.42h8.26l-14.86 46.05z"/><path class="cls-5" d="M863.74 290.16c2.36-2.43 5.17-4.21 8.41-5.36 3.25-1.15 6.54-1.72 9.89-1.72 6.82.0 11.74 1.61 14.76 4.82s4.53 8.1 4.53 14.66v19.78c0 1.31.06 2.67.2 4.08.13 1.41.29 2.71.49 3.89h-7.38c-.26-1.05-.41-2.21-.44-3.49-.04-1.28-.05-2.41-.05-3.39h-.2c-1.51 2.36-3.53 4.3-6.05 5.81-2.53 1.51-5.56 2.26-9.1 2.26-2.36.0-4.58-.29-6.64-.89-2.07-.59-3.87-1.46-5.41-2.61-1.54-1.15-2.77-2.57-3.69-4.28-.92-1.71-1.38-3.67-1.38-5.9.0-3.8.98-6.79 2.95-8.95 1.97-2.16 4.41-3.77 7.33-4.82 2.92-1.05 6.07-1.7 9.45-1.97 3.38-.26 6.48-.39 9.3-.39h2.95v-1.38c0-3.35-1-5.87-3-7.58s-4.8-2.56-8.41-2.56c-2.49.0-4.94.41-7.33 1.23-2.4.82-4.51 2.08-6.35 3.79l-4.82-5.02zm22.24 18c-4.92.0-8.82.69-11.71 2.07s-4.33 3.64-4.33 6.79c0 2.89.97 4.94 2.9 6.15s4.34 1.82 7.23 1.82c2.23.0 4.18-.38 5.85-1.13 1.67-.75 3.07-1.75 4.18-3 1.12-1.25 1.97-2.71 2.56-4.38.59-1.67.92-3.46.98-5.36v-2.95h-7.68z"/><path class="cls-5" d="M932.32 340.83c-.79 1.97-1.59 3.75-2.41 5.36-.82 1.61-1.8 2.98-2.95 4.13-1.15 1.15-2.53 2.03-4.13 2.66-1.61.62-3.56.93-5.85.93-1.12.0-2.28-.07-3.49-.2s-2.35-.46-3.39-.98l.98-6.69c.79.33 1.61.54 2.46.64.85.1 1.84.15 2.95.15 2.49.0 4.33-.69 5.51-2.07s2.2-3.21 3.05-5.51l3.15-8.66-19.09-46.34h8.95l14.27 36.11h.2l13.68-36.11h8.36l-22.24 56.57z"/></g></g></g></svg></span><span class=navbar-brand__name>Envoy Gateway</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/docs><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/news><span>News</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/eg-pr-preview/6-test-preview/contributions><span>Contributions</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//latest>latest</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//docs>v1.2</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v1.1>v1.1</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v1.0>v1.0</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.6>v0.6</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.5>v0.5</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.4>v0.4</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.3>v0.3</a></li><li><a class=dropdown-item href=https://zirain.github.io/eg-pr-preview/6-test-preview//v0.2>v0.2</a></li></ul></div></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/eg-pr-preview/6-test-preview/zh/>中文</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/eg-pr-preview/6-test-preview/offline-search-index.2cce2587fabc03ed99234d30898cf310.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/eg-pr-preview/6-test-preview/v1.2/tasks/observability/>Return to the regular view of this page</a>.</p></div><h1 class=title>Observability</h1><div class=lead>This section includes Observability tasks.</div><ul><li>1: <a href=#pg-704c3841c948479223509ac1feebb5db>Gateway API Metrics</a></li><li>2: <a href=#pg-ed9c87dc64e932cbe6528df1f570c86f>Gateway Exported Metrics</a></li><li>3: <a href=#pg-113076d86d4a3ab51ad9552dd9a07d8b>Gateway Observability</a></li><li>4: <a href=#pg-db30e764627b7b51199826dfd3da7e39>Proxy Access Logs</a></li><li>5: <a href=#pg-9ee1b7728efc90d883186a9c14749b3a>Proxy Metrics</a></li><li>6: <a href=#pg-ae0a51978ef58d2b90521336806d11b6>Proxy Tracing</a></li><li>7: <a href=#pg-c6dcb48cfc3b362ce93e7442db76b5e6>RateLimit Observability</a></li><li>8: <a href=#pg-29c806415369bc15142435761b777cbb>Visualising metrics using Grafana</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-704c3841c948479223509ac1feebb5db>1 - Gateway API Metrics</h1><p>Resource metrics for Gateway API objects are available using the <a href=https://github.com/Kuadrant/gateway-api-state-metrics>Gateway API State Metrics</a> project.
The project also provides example dashboard for visualising the metrics using Grafana, and example alerts using Prometheus & Alertmanager.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> task to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Verify the Gateway status:</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=kubectl aria-controls=tabs-00-00 aria-selected=true>
kubectl</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist="egctl (experimental)" aria-controls=tabs-00-01 aria-selected=false>
egctl (experimental)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>egctl x status gateway -v
</span></span></code></pre></div></div></div><p>Run the following commands to install the metrics stack, with the Gateway API State Metrics configuration, on your kubernetes cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply --server-side -f https://raw.githubusercontent.com/Kuadrant/gateway-api-state-metrics/main/config/examples/kube-prometheus/bundle_crd.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/Kuadrant/gateway-api-state-metrics/main/config/examples/kube-prometheus/bundle.yaml
</span></span></code></pre></div><h2 id=metrics-and-alerts>Metrics and Alerts<a class=td-heading-self-link href=#metrics-and-alerts aria-label="Heading self-link"></a></h2><p>To access the Prometheus UI, wait for the statefulset to be ready, then use the port-forward command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This first command may fail if the statefulset has not been created yet.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># In that case, try again until you get a message like &#39;Waiting for 2 pods to be ready...&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># or &#39;statefulset rolling update complete 2 pods...&#39;</span>
</span></span><span style=display:flex><span>kubectl -n monitoring rollout status --watch --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m statefulset/prometheus-k8s
</span></span><span style=display:flex><span>kubectl -n monitoring port-forward service/prometheus-k8s 9090:9090 &gt; /dev/null <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Navigate to <code>http://localhost:9090</code>.
Metrics can be queried from the &lsquo;Graph&rsquo; tab e.g. <code>gatewayapi_gateway_created</code>
See the <a href=https://github.com/Kuadrant/gateway-api-state-metrics/tree/main#metrics>Gateway API State Metrics README</a> for the full list of Gateway API metrics available.</p><p>Alerts can be seen in the &lsquo;Alerts&rsquo; tab.
Gateway API specific alerts will be grouped under the &lsquo;gateway-api.rules&rsquo; heading.</p><p><em><strong>Note:</strong></em> Alerts are defined in a PrometheusRules custom resource in the &lsquo;monitoring&rsquo; namespace. You can modify the alert rules by updating this resource.</p><h2 id=dashboards>Dashboards<a class=td-heading-self-link href=#dashboards aria-label="Heading self-link"></a></h2><p>To view the dashboards in Grafana, wait for the deployment to be ready, then use the port-forward command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n monitoring <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m deployment/grafana --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span><span style=display:flex><span>kubectl -n monitoring port-forward service/grafana 3000:3000 &gt; /dev/null <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Navigate to <code>http://localhost:3000</code> and sign in with admin/admin.
The Gateway API State dashboards will be available in the &lsquo;Default&rsquo; folder and tagged with &lsquo;gateway-api&rsquo;.
See the <a href=https://github.com/Kuadrant/gateway-api-state-metrics/tree/main#dashboards>Gateway API State Metrics README</a> for further information on available dashboards.</p><p><em><strong>Note:</strong></em> Dashboards are loaded from configmaps. You can modify the dashboards in the Grafana UI, however you will need to export them from the UI and update the json in the configmaps to persist changes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed9c87dc64e932cbe6528df1f570c86f>2 - Gateway Exported Metrics</h1><p>The Envoy Gateway provides a collection of self-monitoring metrics in <a href=https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format>Prometheus format</a>.</p><p>These metrics allow monitoring of the behavior of Envoy Gateway itself (as distinct from that of the EnvoyProxy it managed).</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>EnvoyProxy Metrics</h4>For EnvoyProxy Metrics, please refer to the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/observability/proxy-metric/>EnvoyProxy Metrics</a> to learn more.</div><h2 id=watching-components>Watching Components<a class=td-heading-self-link href=#watching-components aria-label="Heading self-link"></a></h2><p>The Resource Provider, xDS Translator and Infra Manager etc. are key components that made up of Envoy Gateway,
they all follow the design of <a href=/eg-pr-preview/6-test-preview/contributions/design/watching/>Watching Components</a>.</p><p>Envoy Gateway collects the following metrics in Watching Components:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>watchable_depth</code></td><td>Current depth of watchable map.</td></tr><tr><td><code>watchable_subscribe_duration_seconds</code></td><td>How long in seconds a subscribed watchable queue is handled.</td></tr><tr><td><code>watchable_subscribe_total</code></td><td>Total number of subscribed watchable queue.</td></tr></tbody></table><p>Each metric includes the <code>runner</code> label to identify the corresponding components,
the relationship between label values and components is as follows:</p><table><thead><tr><th>Value</th><th>Components</th></tr></thead><tbody><tr><td><code>gateway-api</code></td><td>Gateway API Translator</td></tr><tr><td><code>infrastructure</code></td><td>Infrastructure Manager</td></tr><tr><td><code>xds-server</code></td><td>xDS Server</td></tr><tr><td><code>xds-translator</code></td><td>xDS Translator</td></tr><tr><td><code>global-ratelimit</code></td><td>Global RateLimit xDS Translator</td></tr></tbody></table><p>Metrics may include one or more additional labels, such as <code>message</code>, <code>status</code> and <code>reason</code> etc.</p><h2 id=status-updater>Status Updater<a class=td-heading-self-link href=#status-updater aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the status updates of various resources (like <code>GatewayClass</code>, <code>Gateway</code> and <code>HTTPRoute</code> etc.) through Status Updater.</p><p>Envoy Gateway collects the following metrics in Status Updater:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>status_update_total</code></td><td>Total number of status update by object kind.</td></tr><tr><td><code>status_update_duration_seconds</code></td><td>How long a status update takes to finish.</td></tr></tbody></table><p>Each metric includes <code>kind</code> label to identify the corresponding resources.</p><h2 id=xds-server>xDS Server<a class=td-heading-self-link href=#xds-server aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the cache and xDS connection status in xDS Server.</p><p>Envoy Gateway collects the following metrics in xDS Server:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>xds_snapshot_create_total</code></td><td>Total number of xds snapshot cache creates.</td></tr><tr><td><code>xds_snapshot_update_total</code></td><td>Total number of xds snapshot cache updates by node id.</td></tr><tr><td><code>xds_stream_duration_seconds</code></td><td>How long a xds stream takes to finish.</td></tr></tbody></table><ul><li>For xDS snapshot cache update and xDS stream connection status, each metric includes <code>nodeID</code> label to identify the connection peer.</li><li>For xDS stream connection status, each metric also includes <code>streamID</code> label to identify the connection stream, and <code>isDeltaStream</code> label to identify the delta connection stream.</li></ul><h2 id=infrastructure-manager>Infrastructure Manager<a class=td-heading-self-link href=#infrastructure-manager aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the <code>apply</code> (<code>create</code> or <code>update</code>) and <code>delete</code> operations in Infrastructure Manager.</p><p>Envoy Gateway collects the following metrics in Infrastructure Manager:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>resource_apply_total</code></td><td>Total number of applied resources.</td></tr><tr><td><code>resource_apply_duration_seconds</code></td><td>How long in seconds a resource be applied successfully.</td></tr><tr><td><code>resource_delete_total</code></td><td>Total number of deleted resources.</td></tr><tr><td><code>resource_delete_duration_seconds</code></td><td>How long in seconds a resource be deleted successfully.</td></tr></tbody></table><p>Each metric includes the <code>kind</code> label to identify the corresponding resources being applied or deleted by Infrastructure Manager.</p><p>Metrics may also include <code>name</code> and <code>namespace</code> label to identify the name and namespace of corresponding Infrastructure Manager.</p><h2 id=wasm>Wasm<a class=td-heading-self-link href=#wasm aria-label="Heading self-link"></a></h2><p>Envoy Gateway monitors the status of Wasm remote fetch cache.</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>wasm_cache_entries</code></td><td>Number of Wasm remote fetch cache entries.</td></tr><tr><td><code>wasm_cache_lookup_total</code></td><td>Total number of Wasm remote fetch cache lookups.</td></tr><tr><td><code>wasm_remote_fetch_total</code></td><td>Total number of Wasm remote fetches and results.</td></tr></tbody></table><p>For metric <code>wasm_cache_lookup_total</code>, we are using <code>hit</code> label (boolean) to indicate whether the Wasm cache has been hit.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-113076d86d4a3ab51ad9552dd9a07d8b>3 - Gateway Observability</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config gateway control-plane observability, includes metrics.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.5 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>The default installation of Envoy Gateway installs a default <a href=/eg-pr-preview/6-test-preview/v1.2/api/extension_types/#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In this section, we will update this resource to enable various ways to retrieve metrics
from Envoy Gateway.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Exported Metrics</h4>Refer to the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/observability/gateway-exported-metrics/>Gateway Exported Metrics List</a> to learn more about Envoy Gateway&rsquo;s Metrics.</div><h3 id=retrieve-prometheus-metrics-from-envoy-gateway>Retrieve Prometheus Metrics from Envoy Gateway<a class=td-heading-self-link href=#retrieve-prometheus-metrics-from-envoy-gateway aria-label="Heading self-link"></a></h3><p>By default, prometheus metric is enabled. You can directly retrieve metrics from Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>control-plane<span style=color:#ce5c00;font-weight:700>=</span>envoy-gateway,app.kubernetes.io/instance<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$ENVOY_POD_NAME</span> -n envoy-gateway-system 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics
</span></span></code></pre></div><p>The following is an example to disable prometheus metric for Envoy Gateway.</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-02-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-02-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        prometheus:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          disable: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        prometheus:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          disable: true</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><h3 id=enable-open-telemetry-sink-in-envoy-gateway>Enable Open Telemetry sink in Envoy Gateway<a class=td-heading-self-link href=#enable-open-telemetry-sink-in-envoy-gateway aria-label="Heading self-link"></a></h3><p>The following is an example to send metric via Open Telemetry sink to OTEL gRPC Collector.</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-04-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-04-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              protocol: grpc
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    telemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      metrics:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        sinks:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              port: 4317
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              protocol: grpc</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote><p>Verify OTel-Collector metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>OTEL_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n monitoring --selector<span style=color:#ce5c00;font-weight:700>=</span>app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>opentelemetry-collector -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$OTEL_POD_NAME</span> -n monitoring 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-db30e764627b7b51199826dfd3da7e39>4 - Proxy Access Logs</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config proxy access logs.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.5 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>By default, the Service type of <code>loki</code> is ClusterIP, you can change it to LoadBalancer type for further usage:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch service loki -n monitoring -p <span style=color:#4e9a06>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;LoadBalancer&#34;}}&#39;</span>
</span></span></code></pre></div><p>Expose endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>LOKI_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc loki -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=default-access-log>Default Access Log<a class=td-heading-self-link href=#default-access-log aria-label="Heading self-link"></a></h2><p>If custom format string is not specified, Envoy Gateway uses the following default format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;start_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%START_TIME%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(:METHOD)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-envoy-origin-path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;protocol&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%PROTOCOL%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;response_code&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESPONSE_CODE%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;response_flags&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESPONSE_FLAGS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;response_code_details&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESPONSE_CODE_DETAILS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;connection_termination_details&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%CONNECTION_TERMINATION_DETAILS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_transport_failure_reason&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_TRANSPORT_FAILURE_REASON%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;bytes_received&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%BYTES_RECEIVED%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;bytes_sent&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%BYTES_SENT%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;duration&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%DURATION%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-envoy-upstream-service-time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-forwarded-for&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(X-FORWARDED-FOR)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;user-agent&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(USER-AGENT)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;x-request-id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(X-REQUEST-ID)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;:authority&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQ(:AUTHORITY)%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_host&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_HOST%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_cluster&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_CLUSTER%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;upstream_local_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%UPSTREAM_LOCAL_ADDRESS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;downstream_local_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%DOWNSTREAM_LOCAL_ADDRESS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;downstream_remote_address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%DOWNSTREAM_REMOTE_ADDRESS%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;requested_server_name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%REQUESTED_SERVER_NAME%&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;route_name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;%ROUTE_NAME%&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p>Note: Envoy Gateway disable envoy headers by default, you can enable it by setting <code>EnableEnvoyHeaders</code> to <code>true</code> in the <a href=/eg-pr-preview/6-test-preview/v1.2/api/extension_types/#backendtrafficpolicy>ClientTrafficPolicy</a> CRD.</p></blockquote><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={job=\&#34;fluentbit\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=disable-access-log>Disable Access Log<a class=td-heading-self-link href=#disable-access-log aria-label="Heading self-link"></a></h2><p>If you want to disable it, set the <code>telemetry.accesslog.disable</code> to <code>true</code> in the <code>EnvoyProxy</code> CRD.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: disable-accesslog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: disable-accesslog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      disable: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=opentelemetry-sink>OpenTelemetry Sink<a class=td-heading-self-link href=#opentelemetry-sink aria-label="Heading self-link"></a></h2><p>Envoy Gateway can send logs to OpenTelemetry Sink.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - format:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Text
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            text: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  k8s.cluster.name: &#34;cluster-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={exporter=\&#34;OTLP\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=ggrpc-access-log-serviceals-sink>gGRPC Access Log Service(ALS) Sink<a class=td-heading-self-link href=#ggrpc-access-log-serviceals-sink aria-label="Heading self-link"></a></h2><p>Envoy Gateway can send logs to a backend implemented <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/accesslog/v3/als.proto>gRPC access log service proto</a>.
There&rsquo;s an example service <a href=https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/envoy-als.yaml>here</a>, which simply count the log and export to prometheus endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/envoy-als.yaml -n monitoring
</span></span></code></pre></div><p>The following configuration sends logs to the gRPC access log service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: als
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: als
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: ALS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              als:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  - name: envoy-als
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                type: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify logs from envoy-als:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc envoy-als -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>:19001/metrics&#34;</span> <span style=color:#000;font-weight:700>|</span> grep log_count
</span></span></code></pre></div><h2 id=cel-expressions>CEL Expressions<a class=td-heading-self-link href=#cel-expressions aria-label="Heading self-link"></a></h2><p>Envoy Gateway provides <a href=https://www.envoyproxy.io/docs/envoy/latest/xds/type/v3/cel.proto.html#common-expression-language-cel-proto>CEL expressions</a> to filter access log .</p><p>For example, you can use the expression <code>'x-envoy-logged' in request.headers</code> to filter logs that contain the <code>x-envoy-logged</code> header.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - format:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Text
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            text: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - &#34;&#39;x-envoy-logged&#39; in request.headers&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  k8s.cluster.name: &#34;cluster-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={exporter=\&#34;OTLP\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=additional-metadata>Additional Metadata<a class=td-heading-self-link href=#additional-metadata aria-label="Heading self-link"></a></h2><p>Envoy Gateway provides additional metadata about the K8s resources that were translated to certain envoy resources.
For example, details about the <code>HTTPRoute</code> and <code>GRPCRoute</code> (kind, group, name, namespace and annotations) are available
for access log formatter using the <code>METADATA</code> operator. To enrich logs, users can add log operator such as:
<code>%METADATA(ROUTE:envoy-gateway:resources)%</code> to their access log format.</p><h2 id=access-log-types>Access Log Types<a class=td-heading-self-link href=#access-log-types aria-label="Heading self-link"></a></h2><p>By default, Access Log settings would apply to:</p><ul><li>All Routes</li><li>If traffic is not matched by any Route known to Envoy, the Listener would emit the access log instead</li></ul><p>Users may wish to customize this behavior:</p><ul><li>Emit Access Logs by all Listeners for all traffic with specific settings</li><li>Do not emit Route-oriented access logs when a route is not matched.</li></ul><p>To achieve this, users can select if Access Log settings follow the default behavior or apply specifically to
Routes or Listeners by specifying the setting&rsquo;s type.</p><p><strong>Note</strong>: When users define their own Access Log settings (with or without a type), the default Envoy Gateway
file access log is no longer configured. It can be re-enabled explicitly by adding empty settings for the desired components.</p><p>In the following example:</p><ul><li>Route Access logs would use the default Envoy Gateway format and sink</li><li>Listener Access logs are customized to report transport-level failures and connection attributes</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel-access-logging
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    accessLog:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      settings:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: Route # re-enable default access log for route
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: Listener # configure specific access log for listeners
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          format:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: Text
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            text: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              [%START_TIME%] %DOWNSTREAM_REMOTE_ADDRESS% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DOWNSTREAM_TRANSPORT_FAILURE_REASON%
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sinks:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              openTelemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                host: otel-collector.monitoring.svc.cluster.local
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  k8s.cluster.name: &#34;cluster-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9ee1b7728efc90d883186a9c14749b3a>5 - Proxy Metrics</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config proxy metrics.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.5 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>By default, Envoy Gateway expose metrics with prometheus endpoint.</p><p>Verify metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$ENVOY_POD_NAME</span> -n envoy-gateway-system 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/stats/prometheus  <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;default/backend/rule/0&#34;</span>
</span></span></code></pre></div><p>You can disable metrics by setting the <code>telemetry.metrics.prometheus.disable</code> to <code>true</code> in the <code>EnvoyProxy</code> CRD.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/metric/disable-prometheus.yaml
</span></span></code></pre></div><p>Envoy Gateway can send metrics to OpenTelemetry Sink.
Send metrics to OTel-Collector:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/metric/otel-sink.yaml
</span></span></code></pre></div><p>Verify OTel-Collector metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>OTEL_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n monitoring --selector<span style=color:#ce5c00;font-weight:700>=</span>app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>opentelemetry-collector -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$OTEL_POD_NAME</span> -n monitoring 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics  <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;default/backend/rule/0&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ae0a51978ef58d2b90521336806d11b6>6 - Proxy Tracing</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This task show you how to config proxy tracing.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.5 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>Expose Tempo endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TEMPO_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc tempo -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=traces>Traces<a class=td-heading-self-link href=#traces aria-label="Heading self-link"></a></h2><p>By default, Envoy Gateway doesn&rsquo;t send traces to any sink.
You can enable traces by setting the <code>telemetry.tracing</code> in the <a href=/eg-pr-preview/6-test-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> CRD.
Currently, Envoy Gateway support OpenTelemetry, <a href=/eg-pr-preview/6-test-preview/v1.2/api/extension_types/#zipkintracingprovider>Zipkin</a> and Datadog tracer.</p><h3 id=tracing-provider>Tracing Provider<a class=td-heading-self-link href=#tracing-provider aria-label="Heading self-link"></a></h3><p>The following configurations show how to apply proxy with different providers:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=opentelemetry aria-controls=tabs-01-00 aria-selected=true>
OpenTelemetry</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=zipkin aria-controls=tabs-01-01 aria-selected=false>
Zipkin</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=datadog aria-controls=tabs-01-02 aria-selected=false>
Datadog</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 100% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: otel-collector
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;otel&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify OpenTelemetry traces from tempo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/search?tags=component%3Dproxy+provider%3Dotel&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .traces
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: zipkin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: zipkin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 100% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: otel-collector
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9411
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Zipkin
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        zipkin:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          enable128BitTraceId: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;zipkin&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify zipkin traces from tempo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/search?tags=component%3Dproxy+provider%3Dzipkin&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .traces
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: datadog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: datadog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 100% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: datadog-agent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 8126
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Datadog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;datadog&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify Datadog traces in <a href=https://docs.datadoghq.com/tracing/>Datadog APM</a></p></div></div><p>Query trace by trace id:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/traces/&lt;trace_id&gt;&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</span></span></code></pre></div><h3 id=sampling-rate>Sampling Rate<a class=td-heading-self-link href=#sampling-rate aria-label="Heading self-link"></a></h3><p>Envoy Gateway use 100% sample rate, which means all requests will be traced.
This may cause performance issues when traffic is very high, you can adjust
the sample rate by setting the <code>telemetry.tracing.samplingRate</code> in the <a href=/eg-pr-preview/6-test-preview/v1.2/api/extension_types/#envoyproxy>EnvoyProxy</a> CRD.</p><p>The following configurations show how to apply proxy with 1% sample rates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: otel
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # sample 1% of requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      samplingRate: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: otel-collector
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          namespace: monitoring
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 4317
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      customTags:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a literal as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Literal
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          literal:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: &#34;otel&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.pod.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;k8s.namespace.name&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: Environment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          environment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: ENVOY_GATEWAY_NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;envoy-gateway-system&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # This is an example of using a header value as a tag value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        header1:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requestHeader:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: X-Header-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            defaultValue: &#34;-&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c6dcb48cfc3b362ce93e7442db76b5e6>7 - RateLimit Observability</h1><p>Envoy Gateway provides observability for the RateLimit instances.
This guide show you how to config RateLimit observability, includes traces.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.5 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/traffic/global-rate-limit/>Global Rate Limit</a> to install RateLimit.</p><h2 id=traces>Traces<a class=td-heading-self-link href=#traces aria-label="Heading self-link"></a></h2><p>By default, the Envoy Gateway does not configure RateLimit to send traces to the OpenTelemetry Sink.
You can configure the collector in the <code>rateLimit.telemetry.tracing</code> of the <code>EnvoyGateway</code>CRD.</p><p>RateLimit uses the OpenTelemetry Exporter to export traces to the collector.
You can configure a collector that supports the OTLP protocol, which includes but is not limited to: OpenTelemetry Collector, Jaeger, Zipkin, and so on.</p><p><em><strong>Note:</strong></em></p><ul><li>By default, the Envoy Gateway configures a <code>100%</code> sampling rate for RateLimit, which may lead to performance issues.</li></ul><p>Assuming the OpenTelemetry Collector is running in the <code>observability</code> namespace, and it has a service named <code>otel-svc</code>,
we only want to sample <code>50%</code> of the trace data. We would configure it as follows:</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist="apply from stdin" aria-controls=tabs-01-00 aria-selected=true>
Apply from stdin</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist="apply from file" aria-controls=tabs-01-01 aria-selected=false>
Apply from file</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis-service.default.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      telemetry:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        tracing:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          sampleRate: 50
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            url: otel-svc.observability.svc.cluster.local:4318
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><p>Save and apply the following resource to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      backend:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        redis:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          url: redis-service.default.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      telemetry:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        tracing:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          sampleRate: 50
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          provider:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            url: otel-svc.observability.svc.cluster.local:4318</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div></div></div><blockquote><p>After updating the <code>ConfigMap</code>, you will need to wait the configuration kicks in.<br>You can <strong>force</strong> the configuration to be reloaded by restarting the <code>envoy-gateway</code> deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-29c806415369bc15142435761b777cbb>8 - Visualising metrics using Grafana</h1><p>Envoy Gateway provides support for exposing Envoy Gateway and Envoy Proxy metrics to a Prometheus instance.
This task shows you how to visualise the metrics exposed to Prometheus using Grafana.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/quickstart/>Quickstart</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Envoy Gateway provides an add-ons Helm Chart, which includes all the needing components for observability.
By default, the <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> is disabled.</p><p>Install the add-ons Helm Chart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg-addons oci://docker.io/envoyproxy/gateway-addons-helm --version v1.2.5 --set opentelemetry-collector.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -n monitoring --create-namespace
</span></span></code></pre></div><p>Follow the steps from the <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/observability/gateway-observability/>Gateway Observability</a> and <a href=/eg-pr-preview/6-test-preview/v1.2/tasks/observability/proxy-metric/>Proxy Metrics</a> to enable Prometheus metrics
for both Envoy Gateway (Control Plane) and Envoy Proxy (Data Plane).</p><p>Expose endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>GRAFANA_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc grafana -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=connecting-grafana-with-prometheus-datasource>Connecting Grafana with Prometheus datasource<a class=td-heading-self-link href=#connecting-grafana-with-prometheus-datasource aria-label="Heading self-link"></a></h2><p>To visualise metrics from Prometheus, we have to connect Grafana with Prometheus. If you installed Grafana follow the command
from prerequisites sections, the Prometheus datasource should be already configured.</p><p>You can also add the datasource manually by following the instructions from <a href=https://grafana.com/docs/grafana/latest/datasources/prometheus/configure-prometheus-data-source/>Grafana Docs</a>.</p><h2 id=accessing-grafana>Accessing Grafana<a class=td-heading-self-link href=#accessing-grafana aria-label="Heading self-link"></a></h2><p>You can access the Grafana instance by visiting <code>http://{GRAFANA_IP}</code>, derived in prerequisites.</p><p>To log in to Grafana, use the credentials <code>admin:admin</code>.</p><p>Envoy Gateway has examples of dashboard for you to get started, you can check them out under <code>Dashboards/envoy-gateway</code>.</p><p>If you&rsquo;d like import Grafana dashboards on your own, please refer to Grafana docs for <a href=https://grafana.com/docs/grafana/latest/dashboards/manage-dashboards/#import-a-dashboard>importing dashboards</a>.</p><h3 id=envoy-proxy-global>Envoy Proxy Global<a class=td-heading-self-link href=#envoy-proxy-global aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall downstream and upstream stats for each Envoy Proxy instance.</p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/envoy-proxy-global-dashboard.png alt="Envoy Proxy Global"></p><h3 id=envoy-clusters>Envoy Clusters<a class=td-heading-self-link href=#envoy-clusters aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall stats for each cluster from Envoy Proxy fleet.</p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/envoy-clusters-dashboard.png alt="Envoy Clusters"></p><h3 id=envoy-gateway-global>Envoy Gateway Global<a class=td-heading-self-link href=#envoy-gateway-global aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall stats exported by Envoy Gateway fleet.</p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/envoy-gateway-global-watching-components.png alt="Envoy Gateway Global: Watching Components"></p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/envoy-gateway-global-status-updater.png alt="Envoy Gateway Global: Status Updater"></p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/envoy-gateway-global-xds-server.png alt="Envoy Gateway Global: xDS Server"></p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/envoy-gateway-global-infra-manager.png alt="Envoy Gateway Global: Infrastructure Manager"></p><h3 id=resources-monitor>Resources Monitor<a class=td-heading-self-link href=#resources-monitor aria-label="Heading self-link"></a></h3><p>This dashboard example shows the overall resources stats for both Envoy Gateway and Envoy Proxy fleet.</p><p><img src=https://zirain.github.io/eg-pr-preview/6-test-preview//img/resources-monitor-dashboard.png alt="Envoy Gateway Resources"></p><h2 id=update-dashboards>Update Dashboards<a class=td-heading-self-link href=#update-dashboards aria-label="Heading self-link"></a></h2><p>All dashboards of Envoy Gateway are maintained under <code>charts/gateway-addons-helm/dashboards</code>,
feel free to make <a href=/eg-pr-preview/6-test-preview/contributions/contributing/>contributions</a>.</p><h3 id=grafonnet>Grafonnet<a class=td-heading-self-link href=#grafonnet aria-label="Heading self-link"></a></h3><p>Newer dashboards are generated with <a href=https://jsonnet.org/>Jsonnet</a> with the <a href=https://grafana.github.io/grafonnet/index.html>Grafonnet</a>.
This is the preferred method for any new dashboards.</p><p>You can run <code>make helm-generate.gateway-addons-helm</code> to generate new version of dashboards.
All the generated dashboards have a <code>.gen.json</code> suffix.</p><h3 id=legacy-dashboards>Legacy Dashboards<a class=td-heading-self-link href=#legacy-dashboards aria-label="Heading self-link"></a></h3><p>Many of our older dashboards are manually created in the UI and exported as JSON and checked in.</p><p>These example dashboards cannot be updated in-place by default, if you are trying to
make some changes to the older dashboards, you can save them directly as a JSON file
and then re-import.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=mailto:envoy-users@googlegroups.com aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Twitter aria-label=Twitter><a target=_blank rel=noopener href=https://twitter.com/EnvoyProxy aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/envoyproxy/gateway aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://envoyproxy.slack.com/archives/C03E6NHLESV aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2025
<span class=td-footer__authors>The Envoy Gateway Authors</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><p class="td-footer__about mt-2"><a href=/eg-pr-preview/6-test-preview/about/>About Envoy Gateway</a></p></div></div></div></footer></div><script src=/eg-pr-preview/6-test-preview/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/eg-pr-preview/6-test-preview/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/eg-pr-preview/6-test-preview/js/tabpane-persist.js></script></body></html>